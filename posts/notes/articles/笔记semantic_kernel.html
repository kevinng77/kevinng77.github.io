<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.67" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="http://antarina.tech/posts/notes/articles/%E7%AC%94%E8%AE%B0semantic_kernel.html"><meta property="og:site_name" content="记忆笔书"><meta property="og:title" content="Semantic Kernel | 上手与分析"><meta property="og:description" content="Semantic Kernel 本文对 Semantic Kernel 中的 Kernel，Plugin，KernelFunction，Semantic Memory，Planner，Services，reliability 等进行概念介绍。 1. Kernel image-20240411094303977"><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2024-07-05T03:34:03.000Z"><meta property="article:author" content="Kevin 吴嘉文"><meta property="article:tag" content="NLP"><meta property="article:tag" content="AIGC"><meta property="article:tag" content="LLM"><meta property="article:tag" content="Agent"><meta property="article:published_time" content="2024-05-01T00:00:00.000Z"><meta property="article:modified_time" content="2024-07-05T03:34:03.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"Semantic Kernel | 上手与分析","image":[""],"datePublished":"2024-05-01T00:00:00.000Z","dateModified":"2024-07-05T03:34:03.000Z","author":[{"@type":"Person","name":"Kevin 吴嘉文"}]}</script><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin=""><link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;500;700&display=swap" rel="stylesheet"><link rel="icon" href="/logo.svg"><title>Semantic Kernel | 上手与分析 | 记忆笔书</title><meta name="description" content="Semantic Kernel 本文对 Semantic Kernel 中的 Kernel，Plugin，KernelFunction，Semantic Memory，Planner，Services，reliability 等进行概念介绍。 1. Kernel image-20240411094303977">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d1e1f;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/assets/style-a733c29d.css" as="style"><link rel="stylesheet" href="/assets/style-a733c29d.css">
    <link rel="modulepreload" href="/assets/app-90f47110.js"><link rel="modulepreload" href="/assets/笔记semantic_kernel.html-f9373792.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper-c27b6911.js"><link rel="modulepreload" href="/assets/笔记semantic_kernel.html-1556cdb5.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">跳至主要內容</a><!--]--><!--[--><div class="theme-container no-sidebar has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><!--[--><a class="vp-link vp-brand vp-brand" href="/"><!----><!----><span class="vp-site-name">记忆笔书</span></a><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-center"><!--[--><!----><!--]--><!--[--><nav class="vp-nav-links"><div class="nav-item hide-in-mobile"><a aria-label="主页" class="vp-link nav-link nav-link" href="/"><span class="font-icon icon iconfont icon-home" style=""></span>主页<!----></a></div><div class="nav-item hide-in-mobile"><a aria-label="归档" class="vp-link nav-link nav-link" href="/timeline/"><span class="font-icon icon iconfont icon-categoryselected" style=""></span>归档<!----></a></div></nav><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-end"><!--[--><!----><!--]--><!--[--><!----><div class="nav-item vp-repo"><a class="vp-repo-link" href="https://github.com/kevinng77" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><!----><!--[--><button type="button" class="search-pro-button" role="search" aria-label="搜索"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="search-pro-placeholder">搜索</div><div class="search-pro-key-hints"><kbd class="search-pro-key">Ctrl</kbd><kbd class="search-pro-key">K</kbd></div></button><!--]--><!--]--><!--[--><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!--[--><!----><!--]--><ul class="vp-sidebar-links"></ul><!--[--><!----><!--]--></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->Semantic Kernel | 上手与分析</h1><div class="page-info"><span class="page-author-info" aria-label="作者🖊" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><span class="page-author-item">Kevin 吴嘉文</span></span><span property="author" content="Kevin 吴嘉文"></span></span><!----><span class="page-date-info" aria-label="写作日期📅" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2024-05-01T00:00:00.000Z"></span><!----><span class="page-reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 15 分钟</span><meta property="timeRequired" content="PT15M"></span><span class="page-category-info" aria-label="分类🌈" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><!--[--><span class="page-category-item category7 clickable" role="navigation">知识笔记</span><!--]--><meta property="articleSection" content="知识笔记"></span><span class="page-tag-info" aria-label="标签🏷" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><!--[--><span class="page-tag-item tag8 clickable" role="navigation">NLP</span><span class="page-tag-item tag4 clickable" role="navigation">AIGC</span><span class="page-tag-item tag6 clickable" role="navigation">LLM</span><span class="page-tag-item tag6 clickable" role="navigation">Agent</span><!--]--><meta property="keywords" content="NLP,AIGC,LLM,Agent"></span></div><hr></div><div class="toc-place-holder"><aside id="toc"><!--[--><!----><!--]--><div class="toc-header">此页内容<!----></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/#_1-kernel">1. Kernel</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/#_2-plugin">2. Plugin</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#代码解析">代码解析</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/#_3-kernelfunction">3. KernelFunction</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/#_4-semantic-memory">4. Semantic Memory</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/#_5-services">5. Services</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/#_6-planner">6.  Planner</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#_6-1-basic-planner">6.1 Basic Planner</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#_6-2-sequentialplanner">6.2 SequentialPlanner</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#_6-3-action-planner">6.3 Action Planner</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#_6-4-stepwise-planner">6.4 Stepwise Planner</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/#_7-其他">7. 其他</a></li><!----><!--]--></ul><div class="toc-marker" style="top:-1.7rem;"></div></div><!--[--><!----><!--]--></aside></div><!----><div class="theme-hope-content"><h1 id="semantic-kernel" tabindex="-1"><a class="header-anchor" href="#semantic-kernel" aria-hidden="true">#</a> Semantic Kernel</h1><p>本文对 Semantic Kernel 中的 Kernel，Plugin，KernelFunction，Semantic Memory，Planner，Services，reliability 等进行概念介绍。</p><h2 id="_1-kernel" tabindex="-1"><a class="header-anchor" href="#_1-kernel" aria-hidden="true">#</a> 1. Kernel</h2><figure><img src="/assets/img/semantic_kernel/image-20240411094303977.png" alt="image-20240411094303977" tabindex="0" loading="lazy"><figcaption>image-20240411094303977</figcaption></figure><p>Kernel 是一个执行单元，用来执行以下内容</p><ul><li>选择最佳的人工智能服务来运行提示。</li><li>使用提供的 prompt 模板构建提示。（必要时候调用额外的工具和函数）</li><li>将 prompt 发送给人工智能服务。</li><li>接收并解析响应。</li><li>最后将响应返回到您的应用程序之前。</li></ul><p>具体发送什么 prompt，如何调用外部工具，都需要再 <code>KernelFunction</code> 中实现。</p><p>kernel 的核心函数是<code>invoke</code>，用的话就是用 <code>kernel.invoke(functions, args)</code>，大致逻辑如下：</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#24292E;">results </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> []</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">for</span><span style="color:#24292E;"> func </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> functions:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">while</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">True</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;"># 首先获得一些参数</span></span>
<span class="line"><span style="color:#24292E;">		function_invoking_args </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.on_function_invoking(func.metadata, arguments) </span></span>
<span class="line"><span style="color:#24292E;">        </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;"># 查看 args 中 skip, cancle, update args 等参数是否为 True</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;"># 是的话采取对应措施</span></span>
<span class="line"><span style="color:#24292E;">        </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;"># 调用 kernel function	</span></span>
<span class="line"><span style="color:#24292E;">        function_result </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">await</span><span style="color:#24292E;"> func.invoke(</span><span style="color:#005CC5;">self</span><span style="color:#24292E;">, arguments)</span></span>
<span class="line"><span style="color:#24292E;">        </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;"># 参数后处理</span></span>
<span class="line"><span style="color:#24292E;">        function_invoked_args </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.on_function_invoked(func.metadata, arguments, function_result, exception)</span></span>
<span class="line"><span style="color:#24292E;">        results.append(function_invoked_args.function_result)</span></span>
<span class="line"><span style="color:#24292E;">        </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;"># 查看 args 中 skip, cancle, update args 等参数是否为 True</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#6A737D;"># 是的话采取对应措施</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;"># 查看 is_repeat_requested 参数是否为 True</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> function_invoked_args.is_repeat_requested:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">continue</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">break</span></span>
<span class="line"><span style="color:#D73A49;">return</span><span style="color:#24292E;"> result</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_2-plugin" tabindex="-1"><a class="header-anchor" href="#_2-plugin" aria-hidden="true">#</a> 2. Plugin</h2><blockquote><p>Plugin 由一个或者多个 KernelFunction 组。Semantic Kernel 的 Plugin 设计是参考 <a href="https://platform.openai.com/docs/actions/introduction" target="_blank" rel="noopener noreferrer">OpenAi Plugin （Action）<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>实现的。因此 Semantic Kernel 的 Plugin 也是可以在如 ChatGPT，M365 Copilot 等平台上使用的，<a href="https://learn.microsoft.com/zh-cn/semantic-kernel/agents/plugins/openai-plugins" target="_blank" rel="noopener noreferrer">参考指南<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>。</p></blockquote><p>上文提到，Kernel 具体发送什么 prompt，如何调用外部工具，都需要再 <code>KernelFunction</code> 中实现。在 Semantic Kernel 中， <code>Plugin</code> 这个类中可以搭载多个 <code>KernelFunction</code>。</p><p>比如我们希望 GPT 能够支持数学服务，那么我们可以建立一个 <code>MathPlugin</code>，里面装载 <code>线性代数 Function</code>, <code>微积分 MathFunction</code>, <code>建模工具 Function</code> 等等。</p><h3 id="代码解析" tabindex="-1"><a class="header-anchor" href="#代码解析" aria-hidden="true">#</a> 代码解析</h3><p>KernelPlugin 类中储存有如下信息：</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">KernelPlugin</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">KernelBaseModel</span><span style="color:#24292E;">):</span></span>
<span class="line"><span style="color:#24292E;">    name: Annotated[</span><span style="color:#005CC5;">str</span><span style="color:#24292E;">, StringConstraints(</span><span style="color:#E36209;">pattern</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">PLUGIN_NAME_REGEX</span><span style="color:#24292E;">, </span><span style="color:#E36209;">min_length</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)]</span></span>
<span class="line"><span style="color:#24292E;">    description: Optional[</span><span style="color:#005CC5;">str</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> Field(</span><span style="color:#E36209;">default</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">None</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    functions: Optional[Dict[</span><span style="color:#005CC5;">str</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;KernelFunction&quot;</span><span style="color:#24292E;">]] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> Field(</span><span style="color:#E36209;">default_factory</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">dict</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>初始化后，可以通过字典的方法获取 Plugin 下面储存的 function （<code>KernelFunction</code>）</p><p>即： <code>func = KernelPlugin[&#39;function_name&#39;]</code>。</p><h2 id="_3-kernelfunction" tabindex="-1"><a class="header-anchor" href="#_3-kernelfunction" aria-hidden="true">#</a> 3. KernelFunction</h2><div class="hint-container info"><p class="hint-container-title">相关信息</p><p>KernelFunction 包括 2 大类型，<code>KernelFunctionFromPrompt</code> 和 <code>KernelFunctionFromMethod</code> 。</p><ul><li><code>KernelFunctionFromPrompt</code> 中会整理目前任务的参数，生成 prompt，调用 <code>Service</code> 来向大模型发送 <code>Completion</code> 请求。</li><li><code>KernelFunctionFromMethod</code> 中会整理 method 运行需要的参数，而后调用该 method 来获取结果。</li></ul><p>以上两种 Function 都可以通过 <code>kernel.invoke()</code> 来调用，具体参考下文。</p></div><h4 id="_3-1-kernel-function-from-prompt" tabindex="-1"><a class="header-anchor" href="#_3-1-kernel-function-from-prompt" aria-hidden="true">#</a> 3.1 Kernel Function from Prompt</h4><h5 id="基础使用" tabindex="-1"><a class="header-anchor" href="#基础使用" aria-hidden="true">#</a> <strong>基础使用</strong></h5><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># https://learn.microsoft.com/zh-cn/semantic-kernel/prompts/your-first-prompt?tabs=python</span></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> asyncio</span></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> semantic_kernel </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> sk</span></span>
<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> semantic_kernel.connectors.ai.open_ai </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> OpenAIChatCompletion, AzureChatCompletion</span></span>
<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> semantic_kernel.prompt_template.input_variable </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> InputVariable</span></span>
<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> semantic_kernel.prompt_template.prompt_template_config </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> PromptTemplateConfig</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">kernel </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> sk.Kernel()</span></span>
<span class="line"><span style="color:#6A737D;"># 指明需要用的 AI 服务</span></span>
<span class="line"><span style="color:#24292E;">kernel.add_service(</span></span>
<span class="line"><span style="color:#24292E;">  AzureChatCompletion(</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#E36209;">service_id</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;default&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#E36209;">deployment_name</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">deployment,</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#E36209;">endpoint</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">endpoint,</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#E36209;">api_key</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">api_key,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#E36209;">api_version</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;2024-02-15-preview&quot;</span></span>
<span class="line"><span style="color:#24292E;">  )</span></span>
<span class="line"><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">prompt </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;What is the intent of this request? </span><span style="color:#005CC5;">{{</span><span style="color:#032F62;">$request</span><span style="color:#005CC5;">}}</span><span style="color:#032F62;">&quot;</span></span>
<span class="line"><span style="color:#24292E;">req_settings </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> kernel.get_service(</span><span style="color:#032F62;">&quot;default&quot;</span><span style="color:#24292E;">).get_prompt_execution_settings_class()(</span><span style="color:#E36209;">service_id</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">service_id)</span></span>
<span class="line"><span style="color:#24292E;">chat_prompt_template_config </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> PromptTemplateConfig(</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#E36209;">template</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">prompt,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#E36209;">description</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;Chat with the assistant&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#E36209;">execution_settings</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">{service_id: req_settings},</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#E36209;">input_variables</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">[</span></span>
<span class="line"><span style="color:#24292E;">        InputVariable(</span><span style="color:#E36209;">name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;request&quot;</span><span style="color:#24292E;">, </span><span style="color:#E36209;">description</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;The user input&quot;</span><span style="color:#24292E;">, </span><span style="color:#E36209;">is_required</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">True</span><span style="color:#24292E;">),</span></span>
<span class="line"><span style="color:#24292E;">    ],</span></span>
<span class="line"><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#6A737D;"># 通过 prompt template，构造 KernelFunctionFromPrompt</span></span>
<span class="line"><span style="color:#24292E;">prompt_function </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> kernel.create_function_from_prompt(</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#E36209;">function_name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;sample_zero&quot;</span><span style="color:#24292E;">, </span><span style="color:#E36209;">plugin_name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;sample_plugin&quot;</span><span style="color:#24292E;">, </span><span style="color:#E36209;">prompt</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">prompt</span></span>
<span class="line"><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">async</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">():</span></span>
<span class="line"><span style="color:#24292E;">    request </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;Hello&quot;</span></span>
<span class="line"><span style="color:#24292E;">    result </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">await</span><span style="color:#24292E;"> kernel.invoke(prompt_function, </span><span style="color:#E36209;">request</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">request)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(result)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">__name__</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;__main__&quot;</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    asyncio.run(main())</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="invoke-源码逻辑分析" tabindex="-1"><a class="header-anchor" href="#invoke-源码逻辑分析" aria-hidden="true">#</a> invoke 源码逻辑分析</h5><p><code>KernelFunctionFromPrompt</code> 中的 <code>_invoke_internal</code> 为主要入口函数。当使用 <code>kernel.invoke( KernelFunctionFromPrompt)</code> 时，主要会调用 <code>_invoke_internal</code> 。该 function 调用大致的逻辑为：</p><p><strong>Step 1：首先整理 arguments，对 prompt template 填充默认值</strong></p><p>提前在 function 对应的配置文件 <code>config.json</code> （或 <code>prompt_template_config</code>）中定义 prompt template，如：</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#032F62;">&quot;What is the intent of this request? {{$request}}&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>以及对应填充参数的内容：</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#24292E;">  </span><span style="color:#032F62;">&quot;input_variables&quot;</span><span style="color:#24292E;">: [</span></span>
<span class="line"><span style="color:#24292E;">    {</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#032F62;">&quot;name&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;request&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#032F62;">&quot;description&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;Your description here&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#032F62;">&quot;default&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;Hello&quot;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">  ]</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>_invoke_internal</code> 会对配置信息进行处理，如果 <code>arguments</code> 中缺少了 prompt template 需要的填充参数时，会使用 <code>default</code> 值进行填充。</p><p><strong>Step 2：选择需要执行的 GPT Service</strong></p><p>每一个 KernelFunction 都可以指定用什么 AI 模型来进行推理服务，比如我们可以定义 OpenAI GPT-4 为 <code>default</code> 模型，那么当希望某个 KernelFunction 使用 OpenAI GPT-4 进行推理式，只要设置对应的 <code>service_id=&quot;default&quot;</code> 即可。</p><p>在对应的 <code>config.json</code> 中需要定义好 <code>&quot;execution_settings&quot;</code>，包括调用 GPT-4 服务时候使用的参数（如 <code>max_tokens</code> 等)，如下:</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#24292E;">  </span><span style="color:#032F62;">&quot;execution_settings&quot;</span><span style="color:#24292E;">: {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;default&quot;</span><span style="color:#24292E;">: { </span><span style="color:#D73A49;">//</span><span style="color:#24292E;">此处的 default 为 service </span><span style="color:#005CC5;">ID</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#032F62;">&quot;max_tokens&quot;</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1000</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#032F62;">&quot;temperature&quot;</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">0.9</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#032F62;">&quot;top_p&quot;</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">0.0</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#032F62;">&quot;presence_penalty&quot;</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">0.0</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#032F62;">&quot;frequency_penalty&quot;</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">0.0</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">  },</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果 function 对应的 service_id 没找到的话，那么 kernel 会自动选用一个 Service 来进行大模型推理。</p><p><strong>Step 3：生成 prompt</strong></p><p>prompt 支持 jinja template，实际的填充 prompt template，而后调用 chat 服务的位置在 <code>functions.kernel_function_from_prompt.KernelFunctionFromPrompt</code> 中</p><p><strong>Step 4：大模型推理</strong></p><p>将历史聊天内容以及当前 prompt 整合后，进行大模型推理，得到模型回复。Semantic kernel python 版本用的也是 openai 的 python 包来调用 Openai 的服务，因此理论上支持所有的 openai compatible api。</p><p><strong>Step 5：生成 Result 并返回</strong></p><p>返回的结果格式是 <code>FunctionResult</code></p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#032F62;">&quot;function&quot;</span><span style="color:#24292E;">: KernelFunctionMetadata,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;value&quot;</span><span style="color:#24292E;">: [</span></span>
<span class="line"><span style="color:#24292E;">        {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#032F62;">&quot;role&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#032F62;">&quot;content&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#032F62;">&quot;encoding&quot;</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">...</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    ],</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;metadata&quot;</span><span style="color:#24292E;">: {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#032F62;">&quot;arguments&quot;</span><span style="color:#24292E;">: arguments,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#032F62;">&quot;metadata&quot;</span><span style="color:#24292E;">: [],</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container info"><p class="hint-container-title">相关信息</p><p>但由于 <code>FunctionResult</code> 及其中的 attr 大部分被重写了 <code>__str__</code> 方法，因此在后续进行字符串转变操作过程中，只会输出 <code>content</code> 的内容，及调用 GPT 的文字回复内容。</p></div><h4 id="_3-2-kernelfunctionfrommethod" tabindex="-1"><a class="header-anchor" href="#_3-2-kernelfunctionfrommethod" aria-hidden="true">#</a> 3.2 KernelFunctionFromMethod</h4><h5 id="基础使用-1" tabindex="-1"><a class="header-anchor" href="#基础使用-1" aria-hidden="true">#</a> <strong>基础使用</strong></h5><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> semantic_kernel </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> sk</span></span>
<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> semantic_kernel.functions.kernel_function_decorator </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> kernel_function</span></span>
<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> semantic_kernel.kernel_pydantic </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> KernelBaseModel</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">MyPlugin</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">KernelBaseModel</span><span style="color:#24292E;">):</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">@kernel_function</span><span style="color:#24292E;">(</span><span style="color:#E36209;">description</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;say hello&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">hello</span><span style="color:#24292E;">(self) -&gt; </span><span style="color:#005CC5;">str</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;Hello&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">kernel </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> sk.Kernel()</span></span>
<span class="line"><span style="color:#24292E;">test </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> kernel.import_plugin_from_object(MyPlugin(), </span><span style="color:#032F62;">&quot;MyPlugin&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">async</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">():</span></span>
<span class="line"><span style="color:#24292E;">    result </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">await</span><span style="color:#24292E;"> kernel.invoke(test[</span><span style="color:#032F62;">&#39;hello&#39;</span><span style="color:#24292E;">])</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(result)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="invoke-源码逻辑分析-1" tabindex="-1"><a class="header-anchor" href="#invoke-源码逻辑分析-1" aria-hidden="true">#</a> invoke 源码逻辑分析</h5><p><strong>Step 1：首先整理 arguments，提取 method 需要的参数</strong></p><p><strong>Step 2：调用 method，整理返回结果</strong></p><p>因为函数调用可能返回 generator，或 Awaitable，或 asyncgen 对象，因此需要对返回对象进行处理，确保返回的是最终结果。</p><p><strong>Step 3：生成 Result</strong></p><h4 id="_3-3-semantic-kernel-prompt-template-的特点" tabindex="-1"><a class="header-anchor" href="#_3-3-semantic-kernel-prompt-template-的特点" aria-hidden="true">#</a> 3.3 Semantic Kernel Prompt Template 的特点</h4><ol><li><p><a href="https://learn.microsoft.com/zh-cn/semantic-kernel/prompts/calling-nested-functions" target="_blank" rel="noopener noreferrer">prompt 中可以自动调用其他的 plugin<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></li><li><p><a href="https://learn.microsoft.com/zh-cn/semantic-kernel/prompts/saving-prompts-as-files?tabs=python" target="_blank" rel="noopener noreferrer">prmopt 可以通过 file 的方式来导入<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></li></ol><p>示例：在 prmopt template 中，使用 KernelFunctionFromMethod：</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"></span>
<span class="line"><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">MyPlugin</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">KernelBaseModel</span><span style="color:#24292E;">):</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">@kernel_function</span><span style="color:#24292E;">(</span><span style="color:#E36209;">description</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;say hello&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">get</span><span style="color:#24292E;">(self) -&gt; </span><span style="color:#005CC5;">str</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        result </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;numpy&quot;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> random.random() </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0.5</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            result </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;pandas&quot;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;result is &quot;</span><span style="color:#24292E;">, result)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> result</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">kernel.import_plugin_from_object(MyPlugin(), </span><span style="color:#E36209;">plugin_name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;GetLanguage&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 转换这个 template 时，会自动调用 GetLanguage.get 函数</span></span>
<span class="line"><span style="color:#24292E;">prompt </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;Please generate </span><span style="color:#005CC5;">{{</span><span style="color:#032F62;">$number</span><span style="color:#005CC5;">}}</span><span style="color:#032F62;"> sample </span><span style="color:#005CC5;">{{</span><span style="color:#032F62;">GetLanguage.get</span><span style="color:#005CC5;">}}</span><span style="color:#032F62;"> code&quot;</span></span>
<span class="line"><span style="color:#24292E;">req_settings </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> kernel.get_service(</span><span style="color:#032F62;">&quot;default&quot;</span><span style="color:#24292E;">).get_prompt_execution_settings_class()(</span><span style="color:#E36209;">service_id</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">service_id)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">chat_prompt_template_config </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> PromptTemplateConfig(</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#E36209;">template</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">prompt,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#E36209;">description</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;Chat with the assistant&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#E36209;">execution_settings</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">{service_id: req_settings},</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#E36209;">input_variables</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">[</span></span>
<span class="line"><span style="color:#24292E;">        InputVariable(</span><span style="color:#E36209;">name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;number&quot;</span><span style="color:#24292E;">, </span><span style="color:#E36209;">description</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;The user input&quot;</span><span style="color:#24292E;">, </span><span style="color:#E36209;">is_required</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">True</span><span style="color:#24292E;">),</span></span>
<span class="line"><span style="color:#24292E;">    ],</span></span>
<span class="line"><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">prompt_function </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> kernel.create_function_from_prompt(</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#E36209;">function_name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;sample_zero&quot;</span><span style="color:#24292E;">, </span><span style="color:#E36209;">plugin_name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;sample_plugin&quot;</span><span style="color:#24292E;">, </span><span style="color:#E36209;">prompt</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">prompt</span></span>
<span class="line"><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">async</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">():</span></span>
<span class="line"><span style="color:#24292E;">    result </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">await</span><span style="color:#24292E;"> kernel.invoke(prompt_function, </span><span style="color:#E36209;">number</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(result) </span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>转换以上 template 时，会自动调用 GetLanguage.get 函数。同时支持对 function 的输入和输出结果进行数据格式验证，比如：</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6F42C1;">@kernel_function</span><span style="color:#24292E;">(</span><span style="color:#E36209;">name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;Add&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">add</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">   self,</span></span>
<span class="line"><span style="color:#24292E;">   number1: Annotated[</span><span style="color:#005CC5;">float</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;the first number to add&quot;</span><span style="color:#24292E;">],</span></span>
<span class="line"><span style="color:#24292E;">   number2: Annotated[</span><span style="color:#005CC5;">float</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;the second number to add&quot;</span><span style="color:#24292E;">],</span></span>
<span class="line"><span style="color:#24292E;">) -&gt; Annotated[</span><span style="color:#005CC5;">float</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;the output is a float&quot;</span><span style="color:#24292E;">]:</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">float</span><span style="color:#24292E;">(number1) </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">float</span><span style="color:#24292E;">(number2)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在使用 Annotated 之后，函数结果在填充到 prompt 中时，会自动进行类型转换。</p><p>如果 kernel function 设置了<code>name</code> ，在 prompt 中也可以直接使用 <code>prompt = &quot;{{Add &#39;1&#39; &#39;2&#39;}}&quot;</code> 来调用函数名进行传参。</p><h2 id="_4-semantic-memory" tabindex="-1"><a class="header-anchor" href="#_4-semantic-memory" aria-hidden="true">#</a> 4. Semantic Memory</h2><p>如果用 SK 做一个传统的 chat 服务的话，可以用以下简单的方式实现：</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#D73A49;">async</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">chat</span><span style="color:#24292E;">(input_text: </span><span style="color:#005CC5;">str</span><span style="color:#24292E;">) -&gt; </span><span style="color:#005CC5;">None</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">f</span><span style="color:#032F62;">&quot;User: </span><span style="color:#005CC5;">{</span><span style="color:#24292E;">input_text</span><span style="color:#005CC5;">}</span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    chat_history.add_user_message(input_text)</span></span>
<span class="line"><span style="color:#24292E;">	</span></span>
<span class="line"><span style="color:#24292E;">    answer </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">await</span><span style="color:#24292E;"> kernel.invoke(chat_function, KernelArguments(</span><span style="color:#E36209;">user_input</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">input_text, </span><span style="color:#E36209;">history</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">chat_history))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">f</span><span style="color:#032F62;">&quot;ChatBot: </span><span style="color:#005CC5;">{</span><span style="color:#24292E;">answer</span><span style="color:#005CC5;">}</span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    chat_history.add_assistant_message(</span><span style="color:#005CC5;">str</span><span style="color:#24292E;">(answer))</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其中 <code>chat function </code> 中写好 system prompt 和其他 prompt 参数。</p><p>但当历史对话内容非常多的时候，往往会出现长度超出上下文的情况。Semantic Kernel 中有 semantic Memory 一类，可以通过 embedding 相似度来讲相关的历史对话内容，加入到最终的 prompt 当中。</p><p>具体实现方法可以参考 <code>core_plugins/test_memory_plugin.py</code>。总结来说可以分为以下几点：</p><ol><li>构造一个 plugin ，里面包含了各种 method function 用于检索 vector store 的相关接口。</li><li>构造另一个 prompt function，将 method function 检索的相关信息整理拼接到最终的 prompt 里。</li><li>调用 prompt function，即可实现 Semantci Memory。</li></ol><h2 id="_5-services" tabindex="-1"><a class="header-anchor" href="#_5-services" aria-hidden="true">#</a> 5. Services</h2><blockquote><p>用于定义使用的 AI 模型，可以从 huggingface，GPT 等地方选取。</p></blockquote><p>Services 的源代码集中在 SK 仓库的 <code>services</code> 中。</p><p>SK 支持我们在同一个 kernel 中调用不同的模型，比如 <code>gpt-35-turbo</code>，<code>Llama</code>，<code>GPT-4-TURBO</code> 等。需要用 <code>kernel.add_service</code> 添加对应的类。</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#24292E;">kernel.add_service(</span></span>
<span class="line"><span style="color:#24292E;">  AzureChatCompletion(</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#E36209;">service_id</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">service_id,</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#E36209;">deployment_name</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">deployment,</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#E36209;">endpoint</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">endpoint,</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#E36209;">api_key</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">api_key,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#E36209;">api_version</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;2024-02-15-preview&quot;</span></span>
<span class="line"><span style="color:#24292E;">  )</span></span>
<span class="line"><span style="color:#24292E;">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>service 用于定义大模型服务，如 huggingface， openai 等。Function 会调用 service 中的 <code>complete_chat</code> 函数进行推理，获得回复。具体位置在 <code>connectors.ai.openai.services.open_ai_chat_completion_base.OpenAIChatCompletionBase</code> 中。</p><h2 id="_6-planner" tabindex="-1"><a class="header-anchor" href="#_6-planner" aria-hidden="true">#</a> 6. Planner</h2><h3 id="_6-1-basic-planner" tabindex="-1"><a class="header-anchor" href="#_6-1-basic-planner" aria-hidden="true">#</a> 6.1 Basic Planner</h3><p>basic planner 可以看做一个 <code>KernelFunctionFromPrompt</code>，我们需要：</p><ol><li>一段你的任务描述，比如“帮我写一份行业报告”。</li><li>做以上任务需要用到的 function。比如你可能需要定义一些，可以从网上搜索到行业报告的函数。</li><li>运行 planner，planner 会将 function 信息整合后，放到以下 prompt template 当中，生成 plan。</li></ol><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#032F62;">&quot;&quot;&quot; </span></span>
<span class="line"><span style="color:#032F62;">You are a planner for the Semantic Kernel.</span></span>
<span class="line"><span style="color:#032F62;">Your job is to create a properly formatted JSON plan step by step, to satisfy the goal given.</span></span>
<span class="line"><span style="color:#032F62;">Create a list of subtasks based off the [GOAL] provided.</span></span>
<span class="line"><span style="color:#032F62;">Each subtask must be from within the [AVAILABLE FUNCTIONS] list. Do not use any functions that are not in the list.</span></span>
<span class="line"><span style="color:#032F62;">Base your decisions on which functions to use from the description and the name of the function.</span></span>
<span class="line"><span style="color:#032F62;">Sometimes, a function may take arguments. Provide them if necessary.</span></span>
<span class="line"><span style="color:#032F62;">The plan should be as short as possible.</span></span>
<span class="line"><span style="color:#032F62;">For example:</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">[AVAILABLE FUNCTIONS]</span></span>
<span class="line"><span style="color:#032F62;">EmailConnector.LookupContactEmail</span></span>
<span class="line"><span style="color:#032F62;">description: looks up the a contact and retrieves their email address</span></span>
<span class="line"><span style="color:#032F62;">args:</span></span>
<span class="line"><span style="color:#032F62;">- name: the name to look up</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">WriterPlugin.EmailTo</span></span>
<span class="line"><span style="color:#032F62;">description: email the input text to a recipient</span></span>
<span class="line"><span style="color:#032F62;">args:</span></span>
<span class="line"><span style="color:#032F62;">- input: the text to email</span></span>
<span class="line"><span style="color:#032F62;">- recipient: the recipient&#39;s email address. Multiple addresses may be included if separated by &#39;;&#39;.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">WriterPlugin.Translate</span></span>
<span class="line"><span style="color:#032F62;">description: translate the input to another language</span></span>
<span class="line"><span style="color:#032F62;">args:</span></span>
<span class="line"><span style="color:#032F62;">- input: the text to translate</span></span>
<span class="line"><span style="color:#032F62;">- language: the language to translate to</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">WriterPlugin.Summarize</span></span>
<span class="line"><span style="color:#032F62;">description: summarize input text</span></span>
<span class="line"><span style="color:#032F62;">args:</span></span>
<span class="line"><span style="color:#032F62;">- input: the text to summarize</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">FunPlugin.Joke</span></span>
<span class="line"><span style="color:#032F62;">description: Generate a funny joke</span></span>
<span class="line"><span style="color:#032F62;">args:</span></span>
<span class="line"><span style="color:#032F62;">- input: the input to generate a joke about</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">[GOAL]</span></span>
<span class="line"><span style="color:#032F62;">&quot;Tell a joke about cars. Translate it to Spanish&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">[OUTPUT]</span></span>
<span class="line"><span style="color:#032F62;">    {</span></span>
<span class="line"><span style="color:#032F62;">        &quot;input&quot;: &quot;cars&quot;,</span></span>
<span class="line"><span style="color:#032F62;">        &quot;subtasks&quot;: [</span></span>
<span class="line"><span style="color:#032F62;">            {&quot;function&quot;: &quot;FunPlugin.Joke&quot;},</span></span>
<span class="line"><span style="color:#032F62;">            {&quot;function&quot;: &quot;WriterPlugin.Translate&quot;, &quot;args&quot;: {&quot;language&quot;: &quot;Spanish&quot;}}</span></span>
<span class="line"><span style="color:#032F62;">        ]</span></span>
<span class="line"><span style="color:#032F62;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">[AVAILABLE FUNCTIONS]</span></span>
<span class="line"><span style="color:#032F62;">{{$available_functions}}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">[GOAL]</span></span>
<span class="line"><span style="color:#032F62;">{{$goal}}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">[OUTPUT]</span></span>
<span class="line"><span style="color:#032F62;">&quot;&quot;&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>几个细节：</p><ul><li>被整合到 prompt 中的 funciton 信息有：function 名称；functino 所属 plugin 名称；function description；function 参数。（可以看做是 把 function 的 docstring 加入到了 prompt 中）</li><li>plan 解析：尽管在 prompt 中告诉 GPT 只返回一个 json，但是在解析过程中，semantic kernel 还是先用正则表达式来抽取出关键信息，而后在使用 json.load 加载。</li><li>该 planner 还是很考验 GPT 性能的，如果 function 名称匹配不上，那么 basic planner 就会报错。</li></ul><h3 id="_6-2-sequentialplanner" tabindex="-1"><a class="header-anchor" href="#_6-2-sequentialplanner" aria-hidden="true">#</a> 6.2 SequentialPlanner</h3><p>SequentialPlanner 与 basicPlanner 有点类似，以下是他的 prompt template</p><div class="language-txt line-numbers-mode" data-ext="txt"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#24292e;">Create an XML plan step by step, to satisfy the goal given, with the available functions.</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">[AVAILABLE FUNCTIONS]</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">{{$available_functions}}</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">[END AVAILABLE FUNCTIONS]</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">To create a plan, follow these steps:</span></span>
<span class="line"><span style="color:#24292e;">0. The plan should be as short as possible.</span></span>
<span class="line"><span style="color:#24292e;">1. From a &lt;goal&gt; create a &lt;plan&gt; as a series of &lt;functions&gt;.</span></span>
<span class="line"><span style="color:#24292e;">2. A plan has &#39;INPUT&#39; available in context variables by default.</span></span>
<span class="line"><span style="color:#24292e;">3. Before using any function in a plan, check that it is present in the [AVAILABLE FUNCTIONS] list. If it is not, do not use it.</span></span>
<span class="line"><span style="color:#24292e;">4. Only use functions that are required for the given goal.</span></span>
<span class="line"><span style="color:#24292e;">5. Append an &quot;END&quot; XML comment at the end of the plan after the final closing &lt;/plan&gt; tag.</span></span>
<span class="line"><span style="color:#24292e;">6. Always output valid XML that can be parsed by an XML parser.</span></span>
<span class="line"><span style="color:#24292e;">7. If a plan cannot be created with the [AVAILABLE FUNCTIONS], return &lt;plan /&gt;.</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">All plans take the form of:</span></span>
<span class="line"><span style="color:#24292e;">&lt;plan&gt;</span></span>
<span class="line"><span style="color:#24292e;">    &lt;!-- ... reason for taking step ... --&gt;</span></span>
<span class="line"><span style="color:#24292e;">    &lt;function.{FullyQualifiedFunctionName} ... /&gt;</span></span>
<span class="line"><span style="color:#24292e;">    &lt;!-- ... reason for taking step ... --&gt;</span></span>
<span class="line"><span style="color:#24292e;">    &lt;function.{FullyQualifiedFunctionName} ... /&gt;</span></span>
<span class="line"><span style="color:#24292e;">    &lt;!-- ... reason for taking step ... --&gt;</span></span>
<span class="line"><span style="color:#24292e;">    &lt;function.{FullyQualifiedFunctionName} ... /&gt;</span></span>
<span class="line"><span style="color:#24292e;">    (... etc ...)</span></span>
<span class="line"><span style="color:#24292e;">&lt;/plan&gt;</span></span>
<span class="line"><span style="color:#24292e;">&lt;!-- END --&gt;</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">To call a function, follow these steps:</span></span>
<span class="line"><span style="color:#24292e;">1. A function has one or more named parameters and a single &#39;output&#39; which are all strings. Parameter values should be xml escaped.</span></span>
<span class="line"><span style="color:#24292e;">2. To save an &#39;output&#39; from a &lt;function&gt;, to pass into a future &lt;function&gt;, use &lt;function.{FullyQualifiedFunctionName} ... setContextVariable=&quot;&lt;UNIQUE_VARIABLE_KEY&gt;&quot;/&gt;</span></span>
<span class="line"><span style="color:#24292e;">3. To save an &#39;output&#39; from a &lt;function&gt;, to return as part of a plan result, use &lt;function.{FullyQualifiedFunctionName} ... appendToResult=&quot;RESULT__&lt;UNIQUE_RESULT_KEY&gt;&quot;/&gt;</span></span>
<span class="line"><span style="color:#24292e;">4. Use a &#39;$&#39; to reference a context variable in a parameter, e.g. when `INPUT=&#39;world&#39;` the parameter &#39;Hello $INPUT&#39; will evaluate to `Hello world`.</span></span>
<span class="line"><span style="color:#24292e;">5. Functions do not have access to the context variables of other functions. Do not attempt to use context variables as arrays or objects. Instead, use available functions to extract specific elements or properties from context variables.</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">DO NOT DO THIS, THE PARAMETER VALUE IS NOT XML ESCAPED:</span></span>
<span class="line"><span style="color:#24292e;">&lt;function.Plugin-Name4 input=&quot;$SOME_PREVIOUS_OUTPUT&quot; parameter_name=&quot;some value with a &lt;!-- &#39;comment&#39; in it--&gt;&quot;/&gt;</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">DO NOT DO THIS, THE PARAMETER VALUE IS ATTEMPTING TO USE A CONTEXT VARIABLE AS AN ARRAY/OBJECT:</span></span>
<span class="line"><span style="color:#24292e;">&lt;function.Plugin-CallFunction input=&quot;$OTHER_OUTPUT[1]&quot;/&gt;</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">DO NOT DO THIS, THE FUNCTION NAME IS NOT A FULLY QUALIFIED FUNCTION NAME:</span></span>
<span class="line"><span style="color:#24292e;">&lt;function.CallFunction input=&quot;world&quot;/&gt;</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">Here is a valid example of how to call a function &quot;_plugin-Function_Name&quot; with a single input and save its output:</span></span>
<span class="line"><span style="color:#24292e;">&lt;function._plugin-Function_Name input=&quot;this is my input&quot; setContextVariable=&quot;SOME_KEY&quot;/&gt;</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">Here is a valid example of how to call a function &quot;Plugin-FunctionName2&quot; with a single input and return its output as part of the plan result:</span></span>
<span class="line"><span style="color:#24292e;">&lt;function.Plugin-FunctionName2 input=&quot;Hello $INPUT&quot; appendToResult=&quot;RESULT__FINAL_ANSWER&quot;/&gt;</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">Here is a valid example of how to call a function &quot;Name3&quot; with multiple inputs:</span></span>
<span class="line"><span style="color:#24292e;">&lt;function.Plugin-Name3 input=&quot;$SOME_PREVIOUS_OUTPUT&quot; parameter_name=&quot;some value with a &amp;lt;!-- &amp;apos;comment&amp;apos; in it--&amp;gt;&quot;/&gt;</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">Begin!</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">&lt;goal&gt;{{$input}}&lt;/goal&gt;</span></span>
<span class="line"><span style="color:#24292e;"></span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>一些细节：</p><ul><li>Function 部分 plan 抽取：先用 <code>defusedxml</code> 进行 XML 抽取，失败的话，用 re 先进行预处理，而后再次用 <code>defusedxml</code> 进行 XML 抽取</li><li>相比于 basic planner，sequence planner 提供了 <code>allow_missing_functions</code> 参数。当 function 名称解析错误时，依然能够返回 plan。但能不能执行就不一定了</li></ul><h3 id="_6-3-action-planner" tabindex="-1"><a class="header-anchor" href="#_6-3-action-planner" aria-hidden="true">#</a> 6.3 Action Planner</h3><p>大致流程为：</p><ol><li>使用以下 prompt template 生成 plan。</li></ol><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#24292E;">A planner takes a </span><span style="color:#005CC5;">list</span><span style="color:#24292E;"> of functions, a goal, </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> chooses which function to use.</span></span>
<span class="line"><span style="color:#24292E;">For each function the </span><span style="color:#005CC5;">list</span><span style="color:#24292E;"> includes details about the </span><span style="color:#005CC5;">input</span><span style="color:#24292E;"> parameters.</span></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#005CC5;">START</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">OF</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">EXAMPLES</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">{{ActionPlanner_Excluded.GoodExamples}}</span></span>
<span class="line"><span style="color:#24292E;">{{ActionPlanner_Excluded.EdgeCaseExamples}}</span></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#005CC5;">END</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">OF</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">EXAMPLES</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#005CC5;">REAL</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">SCENARIO</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">STARTS</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">HERE</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#D73A49;">-</span><span style="color:#24292E;"> List of functions:</span></span>
<span class="line"><span style="color:#24292E;">{{ActionPlanner_Excluded.ListOfFunctions}}</span></span>
<span class="line"><span style="color:#D73A49;">-</span><span style="color:#24292E;"> End </span><span style="color:#005CC5;">list</span><span style="color:#24292E;"> of functions.</span></span>
<span class="line"><span style="color:#24292E;">Goal: {{ </span><span style="color:#B31D28;font-style:italic;">$</span><span style="color:#24292E;">goal }}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其中需要填充的有几个 semantic function：</p><ol><li><code>List of Functions</code> : 将所有函数的 description，名字，输入，输出等信息拼接。示例如下：</li></ol><div class="language-text line-numbers-mode" data-ext="text"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#24292e;">// Returns the Addition result of the values provided.</span></span>
<span class="line"><span style="color:#24292e;">math.Add</span></span>
<span class="line"><span style="color:#24292e;">Parameter &quot;&quot;input&quot;&quot;: the first number to add.</span></span>
<span class="line"><span style="color:#24292e;">Parameter &quot;&quot;amount&quot;&quot;: the second number to add.</span></span>
<span class="line"><span style="color:#24292e;">// Subtracts value to a value.</span></span>
<span class="line"><span style="color:#24292e;">math.Subtract</span></span>
<span class="line"><span style="color:#24292e;">Parameter &quot;&quot;input&quot;&quot;: the first number.</span></span>
<span class="line"><span style="color:#24292e;">Parameter &quot;&quot;amount&quot;&quot;: the number to subtract.</span></span>
<span class="line"><span style="color:#24292e;"></span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li><code>GoodExamples</code>：固定的 prompt example，应该是用来控制输出样式</li></ol><div class="language-text line-numbers-mode" data-ext="text"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#24292e;">&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#24292e;">[EXAMPLE]</span></span>
<span class="line"><span style="color:#24292e;">- List of functions:</span></span>
<span class="line"><span style="color:#24292e;">// Get the current time.</span></span>
<span class="line"><span style="color:#24292e;">TimePlugin.Time</span></span>
<span class="line"><span style="color:#24292e;">No parameters.</span></span>
<span class="line"><span style="color:#24292e;">// Makes a POST request to a uri.</span></span>
<span class="line"><span style="color:#24292e;">HttpPlugin.PostAsync</span></span>
<span class="line"><span style="color:#24292e;">Parameter &quot;&quot;body&quot;&quot;: The body of the request.</span></span>
<span class="line"><span style="color:#24292e;">- End list of functions.</span></span>
<span class="line"><span style="color:#24292e;">Goal: get the current time.</span></span>
<span class="line"><span style="color:#24292e;">{&quot;&quot;plan&quot;&quot;:{</span></span>
<span class="line"><span style="color:#24292e;">&quot;&quot;rationale&quot;&quot;: &quot;&quot;the list contains a function that gets the current time (now)&quot;&quot;,</span></span>
<span class="line"><span style="color:#24292e;">&quot;&quot;function&quot;&quot;: &quot;&quot;TimePlugin.Time&quot;&quot;</span></span>
<span class="line"><span style="color:#24292e;">}}</span></span>
<span class="line"><span style="color:#24292e;">#END-OF-PLAN</span></span>
<span class="line"><span style="color:#24292e;">&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#24292e;"></span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li><code>EdgeCaseExamples</code>：固定的 prompt example，应该是用来控制输出样式</li></ol><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#032F62;">&#39;&#39;&#39;</span></span>
<span class="line"><span style="color:#032F62;">[EXAMPLE]</span></span>
<span class="line"><span style="color:#032F62;">- List of functions:</span></span>
<span class="line"><span style="color:#032F62;">// Get the current time.</span></span>
<span class="line"><span style="color:#032F62;">TimePlugin.Time</span></span>
<span class="line"><span style="color:#032F62;">No parameters.</span></span>
<span class="line"><span style="color:#032F62;">// Write a file.</span></span>
<span class="line"><span style="color:#032F62;">FileIOPlugin.WriteAsync</span></span>
<span class="line"><span style="color:#032F62;">Parameter &quot;&quot;path&quot;&quot;: Destination file. (default value: sample.txt)</span></span>
<span class="line"><span style="color:#032F62;">Parameter &quot;&quot;content&quot;&quot;: File content.</span></span>
<span class="line"><span style="color:#032F62;">// Makes a POST request to a uri.</span></span>
<span class="line"><span style="color:#032F62;">HttpPlugin.PostAsync</span></span>
<span class="line"><span style="color:#032F62;">Parameter &quot;&quot;body&quot;&quot;: The body of the request.</span></span>
<span class="line"><span style="color:#032F62;">- End list of functions.</span></span>
<span class="line"><span style="color:#032F62;">Goal: tell me a joke.</span></span>
<span class="line"><span style="color:#032F62;">{&quot;&quot;plan&quot;&quot;:{</span></span>
<span class="line"><span style="color:#032F62;">&quot;&quot;rationale&quot;&quot;: &quot;&quot;the list does not contain functions to tell jokes or something funny&quot;&quot;,</span></span>
<span class="line"><span style="color:#032F62;">&quot;&quot;function&quot;&quot;: &quot;&quot;&quot;&quot;,</span></span>
<span class="line"><span style="color:#032F62;">&quot;&quot;parameters&quot;&quot;: {</span></span>
<span class="line"><span style="color:#032F62;">}}}</span></span>
<span class="line"><span style="color:#032F62;">#END-OF-PLAN</span></span>
<span class="line"><span style="color:#032F62;">&#39;&#39;&#39;</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>一些细节：</p><ul><li>与其他 planner 相似的，虽然要求 GPT 输出 json 格式，但是在解析 json 前都会对字符串进行预处理。</li></ul><h3 id="_6-4-stepwise-planner" tabindex="-1"><a class="header-anchor" href="#_6-4-stepwise-planner" aria-hidden="true">#</a> 6.4 Stepwise Planner</h3><p>根据官方描述，该 planner 参考了 MRKL (Modular Reasoning, Knowledge and Language) ，该 planner 有点类似 ReACT。</p><p>使用示例：</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"></span>
<span class="line"><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">MathPlugin</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#032F62;">    Description: MathPlugin provides a set of functions to make Math calculations.</span></span>
<span class="line"><span style="color:#032F62;">    &quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">@kernel_function</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#E36209;">description</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;Subtracts value to a value&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#E36209;">name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;Subtract&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    )</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">subtract</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">        self,</span></span>
<span class="line"><span style="color:#24292E;">        input: Annotated[</span><span style="color:#005CC5;">float</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;the first number&quot;</span><span style="color:#24292E;">],</span></span>
<span class="line"><span style="color:#24292E;">        amount: Annotated[</span><span style="color:#005CC5;">float</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;the number to subtract&quot;</span><span style="color:#24292E;">],</span></span>
<span class="line"><span style="color:#24292E;">    ) -&gt; </span><span style="color:#005CC5;">float</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#032F62;">&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#032F62;">        Returns the difference of numbers provided.</span></span>
<span class="line"><span style="color:#032F62;">        &quot;&quot;&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">input</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> amount</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">@kernel_function</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#E36209;">description</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;Add value to a value&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#E36209;">name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;Add&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    )</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">add</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">        self,</span></span>
<span class="line"><span style="color:#24292E;">        input: Annotated[</span><span style="color:#005CC5;">float</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;the first number&quot;</span><span style="color:#24292E;">],</span></span>
<span class="line"><span style="color:#24292E;">        amount: Annotated[</span><span style="color:#005CC5;">float</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;the number to add&quot;</span><span style="color:#24292E;">],</span></span>
<span class="line"><span style="color:#24292E;">    ) -&gt; </span><span style="color:#005CC5;">float</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#032F62;">&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#032F62;">        Returns the sum of numbers provided.</span></span>
<span class="line"><span style="color:#032F62;">        &quot;&quot;&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">input</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> amount </span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">@kernel_function</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#E36209;">description</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;Multiply value to a value&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#E36209;">name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;Multiply&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    )</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">multiply</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">        self,</span></span>
<span class="line"><span style="color:#24292E;">        input: Annotated[</span><span style="color:#005CC5;">float</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;the first number&quot;</span><span style="color:#24292E;">],</span></span>
<span class="line"><span style="color:#24292E;">        amount: Annotated[</span><span style="color:#005CC5;">float</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;the number to multiply&quot;</span><span style="color:#24292E;">],</span></span>
<span class="line"><span style="color:#24292E;">    ) -&gt; </span><span style="color:#005CC5;">float</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#032F62;">&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#032F62;">        Returns the difference of numbers provided.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">        :param initial_value_text: Initial value as string to subtract the specified amount</span></span>
<span class="line"><span style="color:#032F62;">        :param context: Contains the context to get the numbers from</span></span>
<span class="line"><span style="color:#032F62;">        :return: The resulting subtraction as a string</span></span>
<span class="line"><span style="color:#032F62;">        &quot;&quot;&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">input</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> amount</span></span>
<span class="line"><span style="color:#24292E;">        </span></span>
<span class="line"><span style="color:#6A737D;"># from semantic_kernel.core_plugins import MathPlugin, TextPlugin, TimePlugin</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">text_plugin </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> kernel.import_plugin_from_object(MathPlugin(), </span><span style="color:#032F62;">&quot;MathPlugin&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> semantic_kernel.planners.stepwise_planner </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> StepwisePlanner, StepwisePlannerConfig</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">planner </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> StepwisePlanner(kernel, StepwisePlannerConfig(</span><span style="color:#E36209;">max_iterations</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">5</span><span style="color:#24292E;">, </span><span style="color:#E36209;">min_iteration_time_ms</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1000</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#D73A49;">async</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">(): </span></span>
<span class="line"><span style="color:#24292E;">    ask </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;Figure out how much I have if first, my investment of 2130.23 dollars increased by 23%, and then I spend $5 on a coffee&quot;</span><span style="color:#24292E;">  </span><span style="color:#6A737D;"># noqa: E501</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    plan </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> planner.create_plan(</span><span style="color:#E36209;">goal</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">ask)</span></span>
<span class="line"><span style="color:#24292E;">    result </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">await</span><span style="color:#24292E;"> plan.invoke(kernel)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> index, step </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">enumerate</span><span style="color:#24292E;">(plan._steps):</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Step:&quot;</span><span style="color:#24292E;">, index)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Description:&quot;</span><span style="color:#24292E;">, step.description)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Function:&quot;</span><span style="color:#24292E;">, step.plugin_name </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;.&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> step._function.name)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">f</span><span style="color:#032F62;">&quot;  Output: </span><span style="color:#005CC5;">{</span><span style="color:#032F62;">&#39;,&#39;</span><span style="color:#24292E;">.join(</span><span style="color:#005CC5;">str</span><span style="color:#24292E;">(res) </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> res </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> result.metadata[</span><span style="color:#032F62;">&#39;results&#39;</span><span style="color:#24292E;">])</span><span style="color:#005CC5;">}</span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>分析：</p><ol><li>潜在 bug：</li></ol><p>由于采用了类似 ReACT 的思路，因此在调用 openai api 时，需要设置 <code>stop</code> 参数为 <code>[&quot;[OBSERVATION]&quot;, &quot;\n[THOUGHT]&quot;]</code>。部分官方的源码中，<code>stop</code> 参数为 None，却设置了 <code>&quot;stop_sequences&quot;: [&quot;[OBSERVATION]&quot;, &quot;\n[THOUGHT]&quot;]</code> 导致 planner 运行不成功。</p><ol><li>初始 prompt 如下：</li></ol><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#24292E;">[</span><span style="color:#005CC5;">INSTRUCTION</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">Answer the following questions </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> accurately </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> possible using the provided functions.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#005CC5;">AVAILABLE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">FUNCTIONS</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">The function definitions below are </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> the following </span><span style="color:#005CC5;">format</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">functionName</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">: </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">description</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">  inputs:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">parameterName</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">: </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">parameterDescription</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">{{</span><span style="color:#B31D28;font-style:italic;">$</span><span style="color:#24292E;">function_descriptions}}</span></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#005CC5;">END</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">AVAILABLE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">FUNCTIONS</span><span style="color:#24292E;">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#005CC5;">USAGE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">INSTRUCTIONS</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">To use the functions, specify a </span><span style="color:#005CC5;">JSON</span><span style="color:#24292E;"> blob representing an action. The </span><span style="color:#005CC5;">JSON</span><span style="color:#24292E;"> blob should contain an </span><span style="color:#032F62;">&quot;action&quot;</span><span style="color:#24292E;"> key </span><span style="color:#D73A49;">with</span><span style="color:#24292E;"> the name of the function to use, </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> an </span><span style="color:#032F62;">&quot;action_variables&quot;</span><span style="color:#24292E;"> key </span><span style="color:#D73A49;">with</span><span style="color:#24292E;"> a </span><span style="color:#005CC5;">JSON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">object</span><span style="color:#24292E;"> of string values to use when calling the function.</span></span>
<span class="line"><span style="color:#24292E;">Do </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> call functions directly; they must be invoked through an action.</span></span>
<span class="line"><span style="color:#24292E;">The </span><span style="color:#032F62;">&quot;action_variables&quot;</span><span style="color:#24292E;"> value should always include an </span><span style="color:#032F62;">&quot;input&quot;</span><span style="color:#24292E;"> key, even </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> the </span><span style="color:#005CC5;">input</span><span style="color:#24292E;"> value </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> empty. Additional keys </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> the </span><span style="color:#032F62;">&quot;action_variables&quot;</span><span style="color:#24292E;"> value should match the defined [</span><span style="color:#005CC5;">PARAMETERS</span><span style="color:#24292E;">] of the named </span><span style="color:#032F62;">&quot;action&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> [</span><span style="color:#005CC5;">AVAILABLE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">FUNCTIONS</span><span style="color:#24292E;">].</span></span>
<span class="line"><span style="color:#24292E;">Dictionary values </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;action_variables&quot;</span><span style="color:#24292E;"> must be strings </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> represent the actual values to be passed to the function.</span></span>
<span class="line"><span style="color:#24292E;">Ensure that the </span><span style="color:#B31D28;font-style:italic;">$</span><span style="color:#005CC5;">JSON_BLOB</span><span style="color:#24292E;"> contains only a </span><span style="color:#005CC5;">SINGLE</span><span style="color:#24292E;"> action; do </span><span style="color:#005CC5;">NOT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> multiple actions.</span></span>
<span class="line"><span style="color:#005CC5;">IMPORTANT</span><span style="color:#24292E;">: Use only the available functions listed </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> the [</span><span style="color:#005CC5;">AVAILABLE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">FUNCTIONS</span><span style="color:#24292E;">] section. Do </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> attempt to use </span><span style="color:#005CC5;">any</span><span style="color:#24292E;"> other functions that are </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> specified.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">Here </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> an example of a valid </span><span style="color:#B31D28;font-style:italic;">$</span><span style="color:#005CC5;">JSON_BLOB</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#032F62;">&quot;action&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;pluginName-functionName&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#032F62;">&quot;action_variables&quot;</span><span style="color:#24292E;">: {</span><span style="color:#032F62;">&quot;parameterName&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;some value&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">...</span><span style="color:#24292E;">}</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">Here </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> another example of a valid </span><span style="color:#B31D28;font-style:italic;">$</span><span style="color:#005CC5;">JSON_BLOB</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#032F62;">&quot;action&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;Plugin-Function&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#032F62;">&quot;action_variables&quot;</span><span style="color:#24292E;">: {</span><span style="color:#032F62;">&quot;parameterName&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;some value&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">...</span><span style="color:#24292E;">}</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">Here </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> another example of a valid </span><span style="color:#B31D28;font-style:italic;">$</span><span style="color:#005CC5;">JSON_BLOB</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#032F62;">&quot;action&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;Plugin-FunctionName2&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#032F62;">&quot;action_variables&quot;</span><span style="color:#24292E;">: {</span><span style="color:#032F62;">&quot;parameterName&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;some value&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">...</span><span style="color:#24292E;">}</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">The </span><span style="color:#B31D28;font-style:italic;">$</span><span style="color:#005CC5;">JSON_BLOB</span><span style="color:#24292E;"> must contain an </span><span style="color:#032F62;">&quot;action_variables&quot;</span><span style="color:#24292E;"> key, </span><span style="color:#D73A49;">with</span><span style="color:#24292E;"> the {</span><span style="color:#032F62;">&quot;parameterName&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;some value&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">...</span><span style="color:#24292E;">} value </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> the response.</span></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#005CC5;">END</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">USAGE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">INSTRUCTIONS</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#005CC5;">END</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">INSTRUCTION</span><span style="color:#24292E;">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#005CC5;">THOUGHT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">PROCESS</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#005CC5;">QUESTION</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">the </span><span style="color:#005CC5;">input</span><span style="color:#24292E;"> question I must answer</span></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#005CC5;">THOUGHT</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">To solve this problem, I should carefully analyze the given question </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> identify the necessary steps. Any facts I discover earlier </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> my thought process should be repeated here to keep them readily available.</span></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#005CC5;">ACTION</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#032F62;">&quot;action&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;plugin-functionName&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#032F62;">&quot;action_variables&quot;</span><span style="color:#24292E;">: {</span><span style="color:#032F62;">&quot;parameterName&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;some value&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">...</span><span style="color:#24292E;">}</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#005CC5;">OBSERVATION</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">The result of the action will be provided here.</span></span>
<span class="line"><span style="color:#005CC5;">...</span><span style="color:#24292E;"> (These Thought</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">Action</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">Observation can repeat until the final answer </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> reached.)</span></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#005CC5;">FINAL</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ANSWER</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">Once I have gathered </span><span style="color:#005CC5;">all</span><span style="color:#24292E;"> the necessary observations </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> performed </span><span style="color:#005CC5;">any</span><span style="color:#24292E;"> required actions, I can provide the final answer </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> a clear </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> human</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">readable </span><span style="color:#005CC5;">format</span><span style="color:#24292E;">.</span></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#005CC5;">END</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">THOUGHT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">PROCESS</span><span style="color:#24292E;">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">Let</span><span style="color:#032F62;">&#39;s break down the problem step by step and think about the best approach. Questions and observations should be followed by a single thought and an optional single action to take.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">Begin!</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#005CC5;">QUESTION</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">{{</span><span style="color:#B31D28;font-style:italic;">$</span><span style="color:#24292E;">question}}</span></span>
<span class="line"><span style="color:#24292E;">{{</span><span style="color:#B31D28;font-style:italic;">$</span><span style="color:#24292E;">agent_scratch_pad}}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>后续的会根据 GPT 的回复，进行 Aciton 提取，Observation 计算以及 Thought 生成，逻辑与 ReACT 一致。参考上文中的实例代码，我们将对应的 GPT 回复都打印出来如下：</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#D73A49;">&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#005CC5;">THOUGHT</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">To solve this problem, we need to perform two actions: first, we need to calculate the increase </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> the investment by </span><span style="color:#005CC5;">23</span><span style="color:#D73A49;">%</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> then we need to subtract </span><span style="color:#B31D28;font-style:italic;">$</span><span style="color:#005CC5;">5</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> the result. We can use the MathPlugin</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">Add </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> MathPlugin</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">Multiply functions to calculate the increase, </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> the MathPlugin</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">Subtract function to subtract </span><span style="color:#B31D28;font-style:italic;">$</span><span style="color:#005CC5;">5</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> the result.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#005CC5;">ACTION</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#032F62;">&quot;action&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;MathPlugin-Multiply&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#032F62;">&quot;action_variables&quot;</span><span style="color:#24292E;">: {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;input&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;2130.23&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;amount&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;0.23&quot;</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span></span>
<span class="line"><span style="color:#24292E;">Error parsing </span><span style="color:#005CC5;">XML</span><span style="color:#24292E;"> of prompt: mismatched tag: line </span><span style="color:#005CC5;">87</span><span style="color:#24292E;">, column </span><span style="color:#005CC5;">10</span></span>
<span class="line"><span style="color:#D73A49;">&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#005CC5;">THOUGHT</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">Now that we have the increase </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> the investment, we can use the MathPlugin</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">Add function to add it to the original investment.</span></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#005CC5;">ACTION</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">{</span><span style="color:#032F62;">&quot;action&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;MathPlugin-Add&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;action_variables&quot;</span><span style="color:#24292E;">: {</span><span style="color:#032F62;">&quot;input&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;2130.23&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;amount&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;489.9529&quot;</span><span style="color:#24292E;">}}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span></span>
<span class="line"><span style="color:#24292E;">Error parsing </span><span style="color:#005CC5;">XML</span><span style="color:#24292E;"> of prompt: mismatched tag: line </span><span style="color:#005CC5;">93</span><span style="color:#24292E;">, column </span><span style="color:#005CC5;">11</span></span>
<span class="line"><span style="color:#D73A49;">&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#005CC5;">THOUGHT</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">Finally, we need to subtract </span><span style="color:#B31D28;font-style:italic;">$</span><span style="color:#005CC5;">5</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> the result to get the final amount.</span></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#005CC5;">ACTION</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">{</span><span style="color:#032F62;">&quot;action&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;MathPlugin-Subtract&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;action_variables&quot;</span><span style="color:#24292E;">: {</span><span style="color:#032F62;">&quot;input&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;2620.1829&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;amount&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;5&quot;</span><span style="color:#24292E;">}}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span></span>
<span class="line"><span style="color:#24292E;">Error parsing </span><span style="color:#005CC5;">XML</span><span style="color:#24292E;"> of prompt: mismatched tag: line </span><span style="color:#005CC5;">99</span><span style="color:#24292E;">, column </span><span style="color:#005CC5;">11</span></span>
<span class="line"><span style="color:#D73A49;">&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#005CC5;">FINAL</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ANSWER</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">After investing </span><span style="color:#B31D28;font-style:italic;">$</span><span style="color:#005CC5;">2130.23</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> increasing it by </span><span style="color:#005CC5;">23</span><span style="color:#D73A49;">%</span><span style="color:#24292E;">, then spending </span><span style="color:#B31D28;font-style:italic;">$</span><span style="color:#005CC5;">5</span><span style="color:#24292E;"> on a coffee, the final amount </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> </span><span style="color:#B31D28;font-style:italic;">$</span><span style="color:#005CC5;">2615.1829</span><span style="color:#24292E;">.</span></span>
<span class="line"><span style="color:#D73A49;">&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span></span>
<span class="line"><span style="color:#24292E;">Step: </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;">Description: Execute a plan</span></span>
<span class="line"><span style="color:#24292E;">Function: StepwisePlanner.ExecutePlan</span></span>
<span class="line"><span style="color:#24292E;">  Output: After investing </span><span style="color:#B31D28;font-style:italic;">$</span><span style="color:#005CC5;">2130.23</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> increasing it by </span><span style="color:#005CC5;">23</span><span style="color:#D73A49;">%</span><span style="color:#24292E;">, then spending </span><span style="color:#B31D28;font-style:italic;">$</span><span style="color:#005CC5;">5</span><span style="color:#24292E;"> on a coffee, the final amount </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> </span><span style="color:#B31D28;font-style:italic;">$</span><span style="color:#005CC5;">2615.1829</span><span style="color:#24292E;">.</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>关于 GPT 回复的处理，与其他 planner 类似的，当尝试使用 json 或者 xml 等工具无法正确提取时，都会使用 re 进行预处理。</p><h2 id="_7-其他" tabindex="-1"><a class="header-anchor" href="#_7-其他" aria-hidden="true">#</a> 7. 其他</h2><p><a href="https://github.com/microsoft/promptflow/tree/main" target="_blank" rel="noopener noreferrer">promptflowopen in new window<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 中有对 Planner 进行评测的示例</p></div><!----><footer class="page-meta"><!----><div class="meta-item git-info"><div class="update-time"><span class="label">上次编辑于: </span><!----></div><div class="contributors"><span class="label">贡献者: </span><!--[--><!--[--><span class="contributor" title="email: 417333277@qq.com">kevinng77</span><!--]--><!--]--></div></div></footer><!----><!----><!----><!--]--></main><!--]--><footer class="vp-footer-wrapper"><div class="vp-footer"><a href="https://beian.miit.gov.cn/" target="_blank">沪ICP备2023027904号-1</a>&nbsp;<a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=" target="_blank"><img src="/assets/gongan.png">公安备案号 </a></div><div class="vp-copyright">Copyright © 2024 Kevin 吴嘉文</div></footer></div><!--]--><!--]--><!----><!--]--></div>
    <script type="module" src="/assets/app-90f47110.js" defer></script>
  </body>
</html>
