<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.67" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="http://antarina.tech/posts/notes/articles/%E7%AC%94%E8%AE%B0spark.html"><meta property="og:site_name" content="è®°å¿†ç¬”ä¹¦"><meta property="og:title" content="Spark - æ¡†æ¶ç†è§£ä¸ä½¿ç”¨"><meta property="og:description" content="å†…å®¹åŒ…æ‹¬ï¼šSpark æ­å»ºæœ¬åœ°æ¨¡å¼ï¼Œé›†ç¾¤æ¨¡å¼ï¼ˆStandAlon, YARNï¼‰æ­å»ºï¼›è®¤è¯† Spark æ¡†æ¶ã€è¿è¡Œé€»è¾‘ï¼›è®¤è¯† PySpark ä¸‹ SparkCoreã€SparkSQL æ“ä½œã€‚ python ä¸Š Spark ä¸æ–­ä¸ªæ›´æ–°ï¼Œå®æ—¶å…³æ³¨ å®˜æ–¹æ–‡æ¡£"><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2023-12-26T15:42:10.000Z"><meta property="article:author" content="Kevin å´å˜‰æ–‡"><meta property="article:tag" content="å¤§æ•°æ®"><meta property="article:published_time" content="2022-03-07T00:00:00.000Z"><meta property="article:modified_time" content="2023-12-26T15:42:10.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"Spark - æ¡†æ¶ç†è§£ä¸ä½¿ç”¨","image":[""],"datePublished":"2022-03-07T00:00:00.000Z","dateModified":"2023-12-26T15:42:10.000Z","author":[{"@type":"Person","name":"Kevin å´å˜‰æ–‡"}]}</script><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin=""><link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;500;700&display=swap" rel="stylesheet"><link rel="icon" href="/logo.svg"><title>Spark - æ¡†æ¶ç†è§£ä¸ä½¿ç”¨ | è®°å¿†ç¬”ä¹¦</title><meta name="description" content="å†…å®¹åŒ…æ‹¬ï¼šSpark æ­å»ºæœ¬åœ°æ¨¡å¼ï¼Œé›†ç¾¤æ¨¡å¼ï¼ˆStandAlon, YARNï¼‰æ­å»ºï¼›è®¤è¯† Spark æ¡†æ¶ã€è¿è¡Œé€»è¾‘ï¼›è®¤è¯† PySpark ä¸‹ SparkCoreã€SparkSQL æ“ä½œã€‚ python ä¸Š Spark ä¸æ–­ä¸ªæ›´æ–°ï¼Œå®æ—¶å…³æ³¨ å®˜æ–¹æ–‡æ¡£">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d1e1f;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/assets/style-99575b2e.css" as="style"><link rel="stylesheet" href="/assets/style-99575b2e.css">
    <link rel="modulepreload" href="/assets/app-86c9497f.js"><link rel="modulepreload" href="/assets/ç¬”è®°spark.html-d7c1d7c1.js"><link rel="modulepreload" href="/assets/ç¬”è®°spark.html-00f4893a.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper-c27b6911.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">è·³è‡³ä¸»è¦å…§å®¹</a><!--]--><!--[--><div class="theme-container no-sidebar has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><!--[--><a class="vp-link vp-brand vp-brand" href="/"><!----><!----><span class="vp-site-name">è®°å¿†ç¬”ä¹¦</span></a><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-center"><!--[--><!----><!--]--><!--[--><nav class="vp-nav-links"><div class="nav-item hide-in-mobile"><a aria-label="ä¸»é¡µ" class="vp-link nav-link nav-link" href="/"><span class="font-icon icon iconfont icon-home" style=""></span>ä¸»é¡µ<!----></a></div><div class="nav-item hide-in-mobile"><a aria-label="å½’æ¡£" class="vp-link nav-link nav-link" href="/timeline/"><span class="font-icon icon iconfont icon-categoryselected" style=""></span>å½’æ¡£<!----></a></div></nav><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-end"><!--[--><!----><!--]--><!--[--><!----><div class="nav-item vp-repo"><a class="vp-repo-link" href="https://github.com/kevinng77" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><!----><!--[--><button type="button" class="search-pro-button" role="search" aria-label="æœç´¢"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="search-pro-placeholder">æœç´¢</div><div class="search-pro-key-hints"><kbd class="search-pro-key">Ctrl</kbd><kbd class="search-pro-key">K</kbd></div></button><!--]--><!--]--><!--[--><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!--[--><!----><!--]--><ul class="vp-sidebar-links"></ul><!--[--><!----><!--]--></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->Spark - æ¡†æ¶ç†è§£ä¸ä½¿ç”¨</h1><div class="page-info"><span class="page-author-info" aria-label="ä½œè€…ğŸ–Š" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><span class="page-author-item">Kevin å´å˜‰æ–‡</span></span><span property="author" content="Kevin å´å˜‰æ–‡"></span></span><!----><span class="page-date-info" aria-label="å†™ä½œæ—¥æœŸğŸ“…" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2022-03-07T00:00:00.000Z"></span><!----><span class="page-reading-time-info" aria-label="é˜…è¯»æ—¶é—´âŒ›" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>å¤§çº¦ 23 åˆ†é’Ÿ</span><meta property="timeRequired" content="PT23M"></span><span class="page-category-info" aria-label="åˆ†ç±»ğŸŒˆ" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><!--[--><span class="page-category-item category7 clickable" role="navigation">çŸ¥è¯†ç¬”è®°</span><!--]--><meta property="articleSection" content="çŸ¥è¯†ç¬”è®°"></span><span class="page-tag-info" aria-label="æ ‡ç­¾ğŸ·" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><!--[--><span class="page-tag-item tag8 clickable" role="navigation">å¤§æ•°æ®</span><!--]--><meta property="keywords" content="å¤§æ•°æ®"></span></div><hr></div><div class="toc-place-holder"><aside id="toc"><!--[--><!----><!--]--><div class="toc-header">æ­¤é¡µå†…å®¹<!----></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#spark-ä¸-hadoop">Spark ä¸ hadoop</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#spark-æ¡†æ¶æ¨¡å‹">spark æ¡†æ¶æ¨¡å‹</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#spark-æ¶æ„è§’è‰²">Spark æ¶æ„è§’è‰²</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/#æœ¬åœ°-local-æ¨¡å¼é…ç½®">æœ¬åœ° local æ¨¡å¼é…ç½®</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#spark-æ“ä½œä»‹ç»">Spark æ“ä½œä»‹ç»</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#spark-ç«¯å£">Spark ç«¯å£</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/#pyspark">PySpark</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#åˆä½“éªŒ-wordcount-å®ä¾‹">åˆä½“éªŒï¼šWordCount å®ä¾‹</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/#spark-core-api">Spark Core API</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#åˆ›å»º-rdd">åˆ›å»º RDD</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#rdd-ç®—å­">RDD ç®—å­</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#rdd-æŒä¹…åŒ–">RDD æŒä¹…åŒ–</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#å…±äº«å˜é‡">å…±äº«å˜é‡</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#å†…æ ¸è°ƒåº¦">å†…æ ¸è°ƒåº¦</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#æ€»ç»“-spark-å±‚çº§">æ€»ç»“ Spark å±‚çº§</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#spark-shuffle">Spark Shuffle</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/#sparksql">SparkSQL</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#å¿«é€Ÿä½“éªŒ">å¿«é€Ÿä½“éªŒ</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#dataframe">DataFrame</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#sparksql-å®šä¹‰-udf">SparkSQL å®šä¹‰ UDF</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#çª—å£å‡½æ•°">çª—å£å‡½æ•°</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#sql-æµç¨‹">SQL æµç¨‹</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#spark-on-hive">Spark on Hive</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#åˆ†å¸ƒå¼-sql-æ‰§è¡Œå¼•æ“">åˆ†å¸ƒå¼ SQL æ‰§è¡Œå¼•æ“</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/#standalone-æ¶æ„">Standalone æ¶æ„</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#å®ä¾‹é›†ç¾¤è§„åˆ’">å®ä¾‹é›†ç¾¤è§„åˆ’</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#å®‰è£…">å®‰è£…</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#é…ç½®é…ç½®æ–‡ä»¶">é…ç½®é…ç½®æ–‡ä»¶</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#å°†-spark-å®‰è£…æ–‡ä»¶å¤¹-åˆ†å‘åˆ°å…¶å®ƒçš„èŠ‚ç‚¹ä¸Š">å°† Spark å®‰è£…æ–‡ä»¶å¤¹ åˆ†å‘åˆ°å…¶å®ƒçš„èŠ‚ç‚¹ä¸Š</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#éªŒè¯ç¯å¢ƒ">éªŒè¯ç¯å¢ƒ</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/#spark-standalone-ha">Spark StandAlone HA</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#æ­¥éª¤">æ­¥éª¤</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#master-ä¸»å¤‡åˆ‡æ¢">master ä¸»å¤‡åˆ‡æ¢</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/#spark-on-yarn-ç¯å¢ƒæ­å»º">Spark On YARN ç¯å¢ƒæ­å»º</a></li><!----><!--]--></ul><div class="toc-marker" style="top:-1.7rem;"></div></div><!--[--><!----><!--]--></aside></div><!----><div class="theme-hope-content"><blockquote><p>å†…å®¹åŒ…æ‹¬ï¼šSpark æ­å»ºæœ¬åœ°æ¨¡å¼ï¼Œé›†ç¾¤æ¨¡å¼ï¼ˆStandAlon, YARNï¼‰æ­å»ºï¼›è®¤è¯† Spark æ¡†æ¶ã€è¿è¡Œé€»è¾‘ï¼›è®¤è¯† PySpark ä¸‹ SparkCoreã€SparkSQL æ“ä½œã€‚</p><p>python ä¸Š Spark ä¸æ–­ä¸ªæ›´æ–°ï¼Œå®æ—¶å…³æ³¨ <a href="https://spark.apache.org/docs/3.1.2/api/python/user_guide/index.html" target="_blank" rel="noopener noreferrer">å®˜æ–¹æ–‡æ¡£<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></blockquote><!--more--><h1 id="æ¦‚è¿°" tabindex="-1"><a class="header-anchor" href="#æ¦‚è¿°" aria-hidden="true">#</a> æ¦‚è¿°</h1><p>Spark ç”¨äºå¤§è§„æ¨¡æ•°æ®å¤„ç†çš„ç»Ÿä¸€åˆ†æå¼•æ“ã€‚å…¶ç‰¹ç‚¹å°±æ˜¯å¯¹ä»»æ„ç±»å‹çš„æ•°æ®è¿›è¡Œè‡ªå®šä¹‰è®¡ç®—ã€‚ RDD æ˜¯ä¸€ç§åˆ†å¸ƒå¼å†…å­˜æŠ½è±¡ï¼Œä½¿ç¨‹åºå‘˜èƒ½å¤Ÿåœ¨å¤§è§„æ¨¡é›†ç¾¤ä¸­åšå†…å­˜è¿ç®—ï¼Œå¹¶ä¸”æœ‰ä¸€å®šçš„å®¹é”™æ–¹å¼ã€‚è¿™ä¹Ÿæ˜¯ Spark çš„æ ¸å¿ƒæ•°æ®ç»“æ„ã€‚<a href="https://zhuanlan.zhihu.com/p/34436165" target="_blank" rel="noopener noreferrer">çŸ¥ä¹è§£ç­” - spark æ¦‚è¿°<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h3 id="spark-ä¸-hadoop" tabindex="-1"><a class="header-anchor" href="#spark-ä¸-hadoop" aria-hidden="true">#</a> <strong>Spark ä¸ hadoop</strong></h3><p>Spark ä»…åšè®¡ç®—ï¼Œè€Œ Hadoop ç”Ÿæ€åœˆä¸ä»…æœ‰è®¡ç®—ï¼ˆMRï¼‰ä¹Ÿæœ‰å­˜å‚¨ï¼ˆHDFSï¼‰å’Œèµ„æºç®¡ç†è°ƒåº¦ï¼ˆYARNï¼‰ï¼ŒHDFS å’Œ YARN ä»æ˜¯è®¸å¤šå¤§æ•°æ®ä½“ç³»çš„æ ¸å¿ƒæ¶æ„ã€‚åœ¨è®¡ç®—å±‚é¢ï¼ŒSpark ç›¸æ¯”è¾ƒ MRï¼ˆMapReduceï¼‰æœ‰å·¨å¤§çš„æ€§èƒ½ä¼˜åŠ¿ï¼Œä½†è‡³ä»Šä»æœ‰è®¸å¤šè®¡ç®—å·¥å…·åŸºäº MR æ„æ¶ï¼Œæ¯”å¦‚éå¸¸æˆç†Ÿçš„ Hive</p><h3 id="spark-æ¡†æ¶æ¨¡å‹" tabindex="-1"><a class="header-anchor" href="#spark-æ¡†æ¶æ¨¡å‹" aria-hidden="true">#</a> spark æ¡†æ¶æ¨¡å‹</h3><p><strong>Spark Coreï¼š</strong> Spark çš„æ ¸å¿ƒï¼ŒSpark æ ¸å¿ƒåŠŸèƒ½å‡ç”± Spark Core æ¨¡å—æä¾›ï¼Œæ˜¯ Spark è¿è¡Œçš„åŸºç¡€ã€‚Spark Core ä»¥ RDD ä¸ºæ•°æ®æŠ½è±¡ï¼Œæä¾› Pythonã€Javaã€Scalaã€R è¯­è¨€çš„ APIï¼Œå¯ä»¥ç¼–ç¨‹è¿›è¡Œæµ·é‡ç¦»çº¿æ•°æ®æ‰¹å¤„ç†è®¡ç®—ã€‚</p><p><strong>SparkSQLï¼š</strong> åŸºäº SparkCore ä¹‹ä¸Šï¼Œæä¾›ç»“æ„åŒ–æ•°æ®çš„å¤„ç†æ¨¡å—ã€‚SparkSQL æ”¯æŒä»¥ SQL è¯­è¨€å¯¹æ•°æ®è¿›è¡Œå¤„ç†ï¼ŒSparkSQL æœ¬èº«é’ˆå¯¹ç¦»çº¿è®¡ç®—åœºæ™¯ã€‚åŒæ—¶åŸºäº SparkSQLï¼ŒSpark æä¾›äº† StructuredStreaming æ¨¡å—ï¼Œå¯ä»¥ä»¥ SparkSQL ä¸ºåŸºç¡€ï¼Œè¿›è¡Œæ•°æ®çš„æµå¼è®¡ç®—ã€‚</p><p><strong>SparkStreamingï¼š</strong> ä»¥ SparkCore ä¸ºåŸºç¡€ï¼Œæä¾›æ•°æ®çš„æµå¼è®¡ç®—åŠŸèƒ½ã€‚</p><p><strong>MLlibï¼š</strong> ä»¥ SparkCore ä¸ºåŸºç¡€ï¼Œè¿›è¡Œæœºå™¨å­¦ä¹ è®¡ç®—ï¼Œå†…ç½®äº†å¤§é‡çš„æœºå™¨å­¦ä¹ åº“å’Œ API ç®—æ³•ç­‰ã€‚æ–¹ä¾¿ç”¨æˆ·ä»¥åˆ†å¸ƒå¼è®¡ç®—çš„æ¨¡å¼è¿›è¡Œæœºå™¨å­¦ä¹ è®¡ç®—ã€‚</p><p><strong>GraphXï¼š</strong> ä»¥ SparkCore ä¸ºåŸºç¡€ï¼Œè¿›è¡Œå›¾è®¡ç®—ï¼Œæä¾›äº†å¤§é‡çš„å›¾è®¡ç®— APIï¼Œæ–¹ä¾¿ç”¨äºä»¥åˆ†å¸ƒå¼è®¡ç®—æ¨¡å¼è¿›è¡Œå›¾è®¡ç®—ã€‚</p><h3 id="spark-æ¶æ„è§’è‰²" tabindex="-1"><a class="header-anchor" href="#spark-æ¶æ„è§’è‰²" aria-hidden="true">#</a> Spark æ¶æ„è§’è‰²</h3><p><strong>èµ„æºç®¡ç†å±‚é¢ï¼š</strong> ç®¡ç†é›†ç¾¤èµ„æºï¼šMaster ç®¡ç†å•ä¸ªæœåŠ¡å™¨èµ„æºï¼šworker</p><p><strong>ä»»åŠ¡æ‰§è¡Œå±‚é¢ï¼š</strong> ç®¡ç†å•ä¸ª spark ä»»åŠ¡åœ¨è¿è¡Œçš„æ—¶å€™çš„å·¥ä½œï¼šDriver å•ä¸ªä»»åŠ¡è¿è¡Œæ—¶çš„å·¥ä½œè€…ï¼š Executor</p><h1 id="å¿«é€Ÿå¼€å§‹" tabindex="-1"><a class="header-anchor" href="#å¿«é€Ÿå¼€å§‹" aria-hidden="true">#</a> å¿«é€Ÿå¼€å§‹</h1><p>æ ¹æ® <a href="https://spark.apache.org/docs/latest/quick-start.html" target="_blank" rel="noopener noreferrer">å®˜æ–¹æŒ‡å—<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ï¼Œ spark æä¾›äº†å¤šç§è¿è¡Œæ¨¡å¼ï¼šåŒ…æ‹¬æœ¬åœ°ï¼Œé›†ç¾¤ï¼ˆStandAlone, YARN, K8Sï¼‰ï¼Œäº‘æ¨¡å¼ã€‚</p><h2 id="æœ¬åœ°-local-æ¨¡å¼é…ç½®" tabindex="-1"><a class="header-anchor" href="#æœ¬åœ°-local-æ¨¡å¼é…ç½®" aria-hidden="true">#</a> æœ¬åœ° local æ¨¡å¼é…ç½®</h2><p>Local æ¨¡å¼æ­å»ºæ–¹ä¾¿ï¼Œæ˜¯å­¦ä¹  Spark å…¥é—¨æ“ä½œåº”ç”¨çš„é¦–é€‰æ¨¡å¼ã€‚Local æ¨¡å¼çš„æœ¬è´¨æ˜¯å¯åŠ¨ä¸€ä¸ª JVM Process è¿›ç¨‹(ä¸€ä¸ªè¿›ç¨‹é‡Œé¢æœ‰å¤šä¸ªçº¿ç¨‹)ï¼Œæ‰§è¡Œä»»åŠ¡ Taskã€‚Local æ¨¡å¼å¯ä»¥ä½¿ç”¨<code>Local[N]</code> æˆ– <code>Local[*]</code> é™åˆ¶æ¨¡æ‹Ÿ Spark é›†ç¾¤ç¯å¢ƒçš„çº¿ç¨‹æ•°é‡ã€‚N ä¸ºçº¿ç¨‹æ•°ï¼Œ<code>*</code> ä¸º CPU æœ€å¤§æ ¸å¿ƒæ•°ã€‚ åœ¨ local æ¨¡å¼ä¸‹ï¼Œå…¨éƒ¨å››ç§ spark è§’è‰²éƒ½ä¸º jvm è¿›ç¨‹æœ¬èº«ï¼Œä¸”åªèƒ½è¿è¡Œä¸€ä¸ª Spark ç¨‹åºã€‚Local æ¨¡å¼å¯ä»¥åšåˆ°å¼€ç®±å³ç”¨ï¼šè§£å‹ä»å®˜ç½‘ä¸‹è½½çš„ Spark å®‰è£…åŒ…ï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6F42C1;">tar</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-zxvf</span><span style="color:#24292E;"> </span><span style="color:#032F62;">spark-3.2.0-bin-hadoop3.2.tgz</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-C</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/export/server/</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>é…ç½® Spark éœ€è¦è°ƒæ•´ä»¥ä¸‹ 5 ä¸ªç¯å¢ƒå˜é‡ï¼š<code>SPARK_HOME</code>,<code>PYSPARK_PYTHON</code>,<code>JAVA_HOME</code>,<code>HADOOP_CONF_DIR</code>,<code>HADOOP_HOME</code></p><h3 id="spark-æ“ä½œä»‹ç»" tabindex="-1"><a class="header-anchor" href="#spark-æ“ä½œä»‹ç»" aria-hidden="true">#</a> Spark æ“ä½œä»‹ç»</h3><p>é…ç½®å¥½åæµ‹è¯•ç¯å¢ƒï¼Œåˆ†åˆ«è¿è¡Œï¼š</p><p><code>bin/pyspark</code> å¯ä»¥æä¾›ä¸€ä¸ª <code>äº¤äº’å¼</code>çš„ Python è§£é‡Šå™¨ç¯å¢ƒ, åœ¨è¿™é‡Œé¢å¯ä»¥å†™æ™®é€š python ä»£ç ã€‚æ·»åŠ  <code>--master local[*]</code> å‚æ•°æ§åˆ¶ä½¿ç”¨çº¿ç¨‹æ•°é‡ã€‚</p><p><code>bin/spark-shell</code> æä¾›äº¤äº’å¼è§£æå™¨ç¯å¢ƒï¼Œè¿è¡Œ scala ç¨‹åºä»£ç ã€‚</p><p><code>bin/spark-submit</code> æäº¤æŒ‡å®šçš„ Spark ä»£ç åˆ° Spark ç¯å¢ƒä¸­è¿è¡Œã€‚å¦‚ <code>bin/spark-submit /export/server/spark/examples/src/main/python/pi.py 10</code></p><h3 id="spark-ç«¯å£" tabindex="-1"><a class="header-anchor" href="#spark-ç«¯å£" aria-hidden="true">#</a> Spark ç«¯å£</h3><p><strong>4040:</strong> ä¸€ä¸ªè¿è¡Œçš„ Application åœ¨è¿è¡Œçš„è¿‡ç¨‹ä¸­ä¸´æ—¶ç»‘å®šçš„ç«¯å£ï¼Œç”¨ä»¥æŸ¥çœ‹å½“å‰ä»»åŠ¡çš„çŠ¶æ€ï¼Œå½“å‰ç¨‹åºè¿è¡Œå®Œæˆå,ï¼Œ4040 å°±ä¼šè¢«æ³¨é”€ã€‚4040 è¢«å ç”¨ä¼šé¡ºå»¶åˆ° 4041.4042 ç­‰</p><p><strong>8080</strong> : é»˜è®¤æ˜¯ StandAlone ä¸‹, Master è§’è‰²(è¿›ç¨‹)çš„ WEB ç«¯å£,ç”¨ä»¥æŸ¥çœ‹å½“å‰ Master(é›†ç¾¤)çš„çŠ¶æ€</p><p><strong>18080/9870</strong> : é»˜è®¤æ˜¯å†å²æœåŠ¡å™¨çš„ç«¯å£, å›çœ‹æŸä¸ªç¨‹åºçš„è¿è¡ŒçŠ¶æ€å°±å¯ä»¥é€šè¿‡å†å²æœåŠ¡å™¨æŸ¥çœ‹,å†å²æœåŠ¡å™¨é•¿æœŸç¨³å®šè¿è¡Œ,å¯ä¾›éšæ—¶æŸ¥çœ‹è¢«è®°å½•çš„ç¨‹åºçš„è¿è¡Œè¿‡ç¨‹ã€‚</p><h2 id="pyspark" tabindex="-1"><a class="header-anchor" href="#pyspark" aria-hidden="true">#</a> PySpark</h2><p><a href="https://spark.apache.org/docs/3.1.2/rdd-programming-guide.html" target="_blank" rel="noopener noreferrer">å®˜æ–¹æ–‡æ¡£<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>å¯¹äºå¤§è§„æ¨¡æ•°æ®é›†å¤„ç†ï¼Œå®‰è£…ç›´æ¥ä½¿ç”¨ <code>pip install pyspark</code> å³å¯ã€‚</p><h3 id="åˆä½“éªŒ-wordcount-å®ä¾‹" tabindex="-1"><a class="header-anchor" href="#åˆä½“éªŒ-wordcount-å®ä¾‹" aria-hidden="true">#</a> åˆä½“éªŒï¼šWordCount å®ä¾‹</h3><p><strong>åˆå§‹åŒ–</strong></p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#24292E;">conf </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> SparkConf().setAppName(appName).setMaster(master)</span></span>
<span class="line"><span style="color:#24292E;">sc </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> SparkContext(</span><span style="color:#E36209;">conf</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">conf)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>local æ¨¡å¼çš„è¯ <code>master=&#39;local[n]&#39;</code></p><p><strong>è¯»å–æ•°æ®åˆ° RDD å¯¹è±¡ï¼š</strong></p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#24292E;">wordsRDD </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> sc.textFile(</span><span style="color:#032F62;">&quot;hdfs://node1:8020/input/words.txt&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#6A737D;"># æœ¬åœ°æ–‡ä»¶è¯»å–ï¼šfile:///home/data/word.txt</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>RDD å¯¹è±¡å¤„ç†</strong></p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#24292E;">flatMapRDD </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> wordsRDD.flatMap(</span><span style="color:#D73A49;">lambda</span><span style="color:#24292E;"> line: line.split(</span><span style="color:#032F62;">&quot; &quot;</span><span style="color:#24292E;">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">mapRDD </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> flatMapRDD.map(</span><span style="color:#D73A49;">lambda</span><span style="color:#24292E;"> x: (x, </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># ä»¥ä¸Šæ­¥éª¤å°†åœ¨ä¸åŒçš„é›†ç¾¤èŠ‚ç‚¹ä¸Šæ‰§è¡Œï¼Œå‚è€ƒä¸‹å›¾ã€‚å› æ­¤å¯ä»¥å¹¶è¡Œæ‰§è¡Œï¼ŒåŠ å¿«æ•ˆç‡ã€‚</span></span>
<span class="line"><span style="color:#24292E;">resultRDD </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> mapRDD.reduceByKey(</span><span style="color:#D73A49;">lambda</span><span style="color:#24292E;"> a, b: a </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> b)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">res_rdd_col2 </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> resultRDD.collect()</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="/assets/img/spark/image-20220401122356005.png" alt="image-20220401122356005" tabindex="0" loading="lazy"><figcaption>image-20220401122356005</figcaption></figure><p>å°†ç»“æœå†™å…¥æ–‡ä»¶å¹¶é€šè¿‡ spark å‚¨å­˜äº HDFSï¼š<code>resultRDD.saveAsTextFile(&quot;hdfs://node1:8020/words_new.txt&quot;)</code></p><p>æäº¤ä»£ç åˆ°é›†ç¾¤è¿è¡Œï¼Œéœ€è¦ä¿®æ”¹åˆå§‹åŒ–æ–¹å¼ï¼š<code>conf = SparkConf().setAppName(appName)</code></p><p>è€Œåé€šè¿‡ <code>bin/spark-submit</code> æäº¤åˆ°é›†ç¾¤è¿è¡Œï¼šé€šè¿‡ <code>--py-files</code> æäº¤ä¾èµ–æ–‡ä»¶ï¼Œå¯ä»¥å•ä¸ªæ–‡ä»¶ <code>.py</code> æˆ–è€…å¤šä¸ªæ–‡ä»¶ <code>.zip</code>ã€‚</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6F42C1;">/export/server/spark/bin/spark-submit</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--master</span><span style="color:#24292E;"> </span><span style="color:#032F62;">yarn</span><span style="color:#24292E;"> </span><span style="color:#032F62;">./test.py</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>è¯¥ python ä»£ç åº•å±‚ç”± java å®ç°ï¼ˆé€šè¿‡ py4j äº¤äº’)</p><h2 id="spark-core-api" tabindex="-1"><a class="header-anchor" href="#spark-core-api" aria-hidden="true">#</a> Spark Core API</h2><p>åˆ†å¸ƒå¼æ¡†æ¶ä¸­ï¼Œéœ€è¦ç”±åŒæ„çš„æ•°æ®ç»“æ„å¯¹è±¡æ¥å®ç°åˆ†å¸ƒå¼è®¡ç®—æ‰€éœ€åŠŸèƒ½ï¼Œè¿™ä¸ªå¯¹è±¡å°±æ˜¯ <strong>RDDï¼ˆResilient Distributed Datasetï¼‰</strong> ã€‚åœ¨åˆä½“éªŒä¸­ <code>wordsRDD = sc.textFile(&quot;hdfs://node1:8020/input/words.txt&quot;)</code> è¯»å–çš„å°±æ˜¯ RDD å¯¹è±¡ã€‚RDD æ˜¯é€šè¿‡ java å®ç°çš„æŠ½è±¡ç±»ã€æ³›å‹ç±»å‹ã€‚ç‰¹å¾åŒ…æ‹¬ï¼š</p><ul><li><strong>æœ‰åˆ†åŒºï¼ˆRDD is a list of partitionsï¼‰</strong></li></ul><p>RDD çš„åˆ†åŒºæ˜¯ RDD æ•°æ®å­˜å‚¨çš„æœ€å°å•ä½ï¼Œå¦‚ï¼š</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#24292E;">sc.parallelize([</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">3</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">4</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">5</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">6</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">7</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">8</span><span style="color:#24292E;">], </span><span style="color:#E36209;">numSlices</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">3</span><span style="color:#24292E;">).glom().collect()</span></span>
<span class="line"><span style="color:#6A737D;"># [[1, 2], [3, 4], [5, 6, 7, 8]] </span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>åˆ†åŒºä¸º 3 æ—¶ï¼ŒRDD å†…æ•°æ®åˆ†ä¸º 3 ä»½ã€‚</p><ul><li><strong>å¯å¹¶è¡Œè®¡ç®—ï¼Œè®¡ç®—æ–¹æ³•ä¼šä½œç”¨åˆ°æ¯ä¸€ä¸ªåˆ†åŒºä¸Š</strong></li></ul><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#24292E;">resultRDD </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> sc.parallelize([</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">3</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">4</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">5</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">6</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">7</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">8</span><span style="color:#24292E;">], </span><span style="color:#E36209;">numSlices</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">3</span><span style="color:#24292E;">).map(</span><span style="color:#D73A49;">lambda</span><span style="color:#24292E;"> x: x</span><span style="color:#D73A49;">*</span><span style="color:#005CC5;">10</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(resultRDD.glom().collect())</span></span>
<span class="line"><span style="color:#6A737D;"># [[10, 20], [30, 40], [50, 60, 70, 80]]</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>RDD ä¹‹é—´ç›¸äº’ä¾èµ–ã€è¿­ä»£çš„ï¼›</strong></li></ul><p>é’ˆå¯¹å¿«é€Ÿæ¢ç´¢ä¸­çš„ wordcount æ¡ˆä¾‹ï¼Œæ¯ä¸ªæ“ä½œæ­¥éª¤éƒ½æ˜¯ä¸€æ¬¡å¯¹ RDD çš„è¿­ä»£ã€‚ä¸€ä¸ªæ–°çš„ RDD ç”±ä¸Šä¸€æ­¥éª¤çš„ RDD è®¡ç®—å¾—æ¥ã€‚</p><ul><li><strong>KV å‹ RDD å¯ä»¥ç”±åˆ†åŒºå™¨ï¼›</strong></li></ul><p>å¯¹ key-value å‹çš„ RDDï¼Œé»˜è®¤é‡‡ç”¨ Hash åˆ†åŒºï¼Œå¯ä»¥æ‰‹åŠ¨ä½¿ç”¨ <code>rdd.partitionBy</code> è®¾ç½®åˆ†åŒºã€‚</p><ul><li><strong>åˆ†åŒºçš„è®¡ç®—ä¼šå°½é‡é€‰æ‹©é è¿‘æ•°æ®æ‰€åœ¨åœ°</strong></li></ul><p>ç›®çš„æ˜¯æœ€å¤§åŒ–æ€§èƒ½ï¼Œæ¯•ç«Ÿæœ¬åœ°è¯»å–æ•ˆç‡æ˜¯å¤§äºç½‘ç»œè¯»å–çš„ã€‚</p><h3 id="åˆ›å»º-rdd" tabindex="-1"><a class="header-anchor" href="#åˆ›å»º-rdd" aria-hidden="true">#</a> åˆ›å»º RDD</h3><p>å¯ä»¥ä»æ–‡ä»¶åŠ è½½ï¼š<code>sc.textFile(&quot;hdfs://node1:8020/input/words.txt&quot;)</code>ï¼Œæˆ–è€…ä»æœ¬åœ°çš„é›†åˆå¯¹è±¡ï¼ˆå¦‚ listï¼‰åˆ›å»ºï¼š<code>sc.parallelize(set(), numSlices=3)</code>ï¼Œä»æ–‡ä»¶å¤¹åŠ è½½ï¼š<code>sc.wholeTextFiles(&quot;hdfs://node1:8020/input&quot;)</code></p><h3 id="rdd-ç®—å­" tabindex="-1"><a class="header-anchor" href="#rdd-ç®—å­" aria-hidden="true">#</a> RDD ç®—å­</h3><p>è¯¦ç»†ç®—å­ <a href="https://spark.apache.org/docs/3.1.2/rdd-programming-guide.html#" target="_blank" rel="noopener noreferrer">å®˜ç½‘<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> å¯æŸ¥çœ‹ï¼Œä»¥ä¸‹æ€»ç»“ä¸€äº›å¸¸ç”¨çš„ã€‚</p><h4 id="transformation-ç®—å­" tabindex="-1"><a class="header-anchor" href="#transformation-ç®—å­" aria-hidden="true">#</a> <strong>Transformation ç®—å­</strong></h4><p>è¿”å›ä¸€ä¸ª RDDï¼Œå¦‚æœæ²¡æœ‰ action ç®—å­ï¼Œé‚£ä¹ˆè¿™ç±»ç®—å­æ˜¯ä¸å·¥ä½œçš„ã€‚</p><p><code>flatMap()</code>ï¼šå¯¹ rdd è¿›è¡Œ map åæ¥è§¦åµŒå¥—ã€‚å¦‚ï¼š</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#24292E;">resultRDD </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> sc.parallelize([</span><span style="color:#032F62;">&quot;hello hello&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;nihao nihao &quot;</span><span style="color:#24292E;">])</span></span>
<span class="line"><span style="color:#24292E;">resultRDD.map(</span><span style="color:#D73A49;">lambda</span><span style="color:#24292E;"> x:x.split()).collect()</span></span>
<span class="line"><span style="color:#6A737D;"># [[&#39;hello&#39;, &#39;hello&#39;], [&#39;nihao&#39;, &#39;nihao&#39;]]</span></span>
<span class="line"><span style="color:#24292E;">mappedRDD </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> resultRDD.flatMap(</span><span style="color:#D73A49;">lambda</span><span style="color:#24292E;"> x:x.split())</span></span>
<span class="line"><span style="color:#6A737D;"># [&#39;hello&#39;, &#39;hello&#39;, &#39;nihao&#39;, &#39;nihao&#39;]</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>reduceByKey()</code>ï¼šçœŸèƒ½å¯¹ KV å‹ RDDï¼Œå¯¹ç»„å†…æ•°æ®æ ¹æ® key åˆ†ç±»å¹¶èšåˆã€‚å¦‚ï¼š</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># æ¥ flatmap() ä¾‹å­</span></span>
<span class="line"><span style="color:#24292E;">mappedRDD </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> mappedRDD.map(</span><span style="color:#D73A49;">lambda</span><span style="color:#24292E;"> x: (x, </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#24292E;">resultRDD </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> mappedRDD.reduceByKey(</span><span style="color:#D73A49;">lambda</span><span style="color:#24292E;"> a, b: a </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> b)</span></span>
<span class="line"><span style="color:#6A737D;"># [(&#39;nihao&#39;, 2), (&#39;hello&#39;, 2)]</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>groupBy()</code>ï¼šå°†å…ƒç´ åˆ†ç»„ï¼Œåˆ†ç»„åæ¯ä¸ªç»„æ˜¯ä¸€ä¸ª KVï¼Œkey ä¸ºåˆ†ç»„ <code>func</code> çš„è¿”å›å€¼ï¼Œvalue ä¸ºè¯¥ç»„å…ƒç´ æ„æˆçš„è¿­ä»£å™¨ã€‚</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#24292E;">dataRDD </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> sc.parallelize([</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">3</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">4</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">5</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">6</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">7</span><span style="color:#24292E;">])</span></span>
<span class="line"><span style="color:#24292E;">mappedRDD </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> dataRDD.groupBy(</span><span style="color:#D73A49;">lambda</span><span style="color:#24292E;"> x: </span><span style="color:#032F62;">&quot;even&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> x </span><span style="color:#D73A49;">%</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;odd&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">resultRDD </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> mappedRDD.map(</span><span style="color:#D73A49;">lambda</span><span style="color:#24292E;"> x:(x[</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">], </span><span style="color:#005CC5;">list</span><span style="color:#24292E;">(x[</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">])))</span></span>
<span class="line"><span style="color:#005CC5;">print</span><span style="color:#24292E;">(resultRDD.collect())</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>Filter(func)</code>ï¼šè¿‡æ»¤å…ƒç´ ï¼Œä¼ å…¥çš„å‡½æ•°æ–¹æ³•éœ€è¦è¿”å›å¸ƒå°”å€¼ã€‚</p><p><code>distinct()</code>ï¼šæ•°æ®å»é‡ï¼Œä¸€èˆ¬ä¸éœ€è¦ä¼ å…¥å‚æ•°ã€‚</p><p><code>union()</code>ï¼šåˆå¹¶ä¸¤ä¸ª RDD å¹¶è¿”å›ï¼Œæ”¯æŒä¸åŒå„ç±»å‹ã€‚<code>union_rdd = rdd1.union(rdd2)</code></p><p><code>join()</code>ï¼šåŒ sql çš„ joinã€‚æ”¯æŒå·¦å³æ‹¼æ¥ï¼Œ<code>leftOuterJoin()</code>, <code>rightOuterJoin()</code></p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#24292E;">dataRDD </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> sc.parallelize([(</span><span style="color:#032F62;">&quot;hello&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">), (</span><span style="color:#032F62;">&quot;good&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">)])</span></span>
<span class="line"><span style="color:#24292E;">dataRDD2 </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> sc.parallelize([(</span><span style="color:#032F62;">&quot;hello&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">10</span><span style="color:#24292E;">), (</span><span style="color:#032F62;">&quot;good&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">20</span><span style="color:#24292E;">), (</span><span style="color:#032F62;">&quot;world&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">30</span><span style="color:#24292E;">)])</span></span>
<span class="line"><span style="color:#24292E;">resultRDD </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> dataRDD.join(dataRDD2)</span></span>
<span class="line"><span style="color:#6A737D;"># [(&#39;good&#39;, (2, 20)), (&#39;hello&#39;, (1, 10))]</span></span>
<span class="line"><span style="color:#6A737D;"># rightOuterJoin åï¼š[(&#39;good&#39;, (2, 20)), (&#39;hello&#39;, (1, 10)), (&#39;world&#39;, (None, 30))]</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>intersection()</code>ï¼šè¿”å›äº¤é›†<code>rdd1.intersection(rdd2)</code></p><p><code>glom()</code> ï¼šå°† RDD æ•°æ®æ ¹æ®åˆ†åŒºè¿›è¡ŒåµŒå¥—ã€‚</p><p><code>groupByKey()</code>ï¼šé’ˆå¯¹ KV å‹ RDDï¼Œæ ¹æ® key åˆ†ç»„ï¼Œä½†ä¸èšåˆï¼Œç±»ä¼¼ <code>grouBy()</code>ã€‚ä½¿ç”¨<code>groupByKey()</code> + èšåˆçš„æ€§èƒ½æ˜¯è¿œå·®ä¸ç›´æ¥ä½¿ç”¨ <code>reduceByKey()</code> çš„ã€‚</p><p><code>sortByKey()</code> æˆ– <code>sortBy(func, ascending=False, numPartitions=1)</code>ï¼šæ’åº <code>func</code> ä¸ºæ’åºä¾æ®ã€‚ <strong>å¦‚æœè¦å…¨å±€æœ‰åºï¼Œæ’åºåˆ†åŒºæ•°éœ€è¦è®¾ç½®ä¸º 1ã€‚</strong></p><p><code>mapPartition(func)</code>ï¼š<code>func</code> è¾“å…¥å¯è¿­ä»£å¯¹è±¡ï¼Œè¾“å‡ºå¯è¿­ä»£å¯¹è±¡ã€‚</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">func</span><span style="color:#24292E;">(iter_tool):</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> x </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> iter_tool:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">yield</span><span style="color:#24292E;"> x</span><span style="color:#D73A49;">+</span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">rdd1 </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> sc.parallelize([</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">3</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">4</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">5</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">6</span><span style="color:#24292E;">], </span><span style="color:#005CC5;">3</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#005CC5;">print</span><span style="color:#24292E;">(rdd1.mapPartitions(func).glom().collect())</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>partitionBy(func)</code>ï¼š<code>func</code> å‚æ•°åº”è¯¥ä¸ºå…ƒç´  hash å€¼åˆ°åˆ†åŒºç¼–å·çš„æ˜ å°„ã€‚åªèƒ½æ ¹æ® hash åˆ†åŒºï¼Œå› æ­¤é KV å‹ RDD éœ€è¦å…ˆè¿›è¡Œè½¬æ¢ã€‚</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#24292E;">rdd1 </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> sc.parallelize([</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">3</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">4</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">5</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">6</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">7</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">8</span><span style="color:#24292E;">]).map(</span><span style="color:#D73A49;">lambda</span><span style="color:#24292E;"> x:(x,x))</span></span>
<span class="line"><span style="color:#005CC5;">print</span><span style="color:#24292E;">(rdd1.partitionBy(</span><span style="color:#005CC5;">3</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">lambda</span><span style="color:#24292E;"> x: x </span><span style="color:#D73A49;">%</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3</span><span style="color:#24292E;">).glom().collect())</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><code>repartition(N)</code>ï¼šå°† RDD é‡æ–°åˆ†ä¸º N ä¸ªåˆ†åŒºï¼Œä¸€èˆ¬é™¤äº†è¦å…¨å±€æ’åºå¤–ï¼Œä¸ä¼šè¿›è¡Œå……åˆ†åŒºã€‚</p><p><code>coalesce()</code>ï¼šå¯¹åˆ†åŒºæ•°é‡è¿›è¡ŒåŠ å‡ï¼Œæ¯”<code>repartition()</code>å¸¸ç”¨ï¼Œ<code>rdd.coalesce(4,shuffle=True)</code> å¦‚æœ <code>shuffle</code> ä¸º <code>Flase</code>ï¼Œé‚£ä¹ˆå°†å¿½ç•¥åˆ†åŒºå¢åŠ æ“ä½œï¼Œä»…æ”¯æŒåˆ†åŒºå‡å°‘ã€‚ <strong>å°½é‡ä¸è¦å¢åŠ åˆ†åŒºï¼Œå¯èƒ½ç ´åå†…å­˜è¿­ä»£çš„è®¡ç®—ç®¡é“ã€‚</strong></p><p><code>mapValues(func)</code>ï¼šä»…é’ˆå¯¹ KV å‹ RDDï¼ŒåŠŸèƒ½ç­‰ä»·äº <code>.map(lambda x:(x[0],func(x[1])))</code></p><h4 id="action-ç®—å­" tabindex="-1"><a class="header-anchor" href="#action-ç®—å­" aria-hidden="true">#</a> <strong>Action ç®—å­</strong></h4><p><code>countByKey()</code>ï¼šè¿”å›ä¸€ä¸ª <code>collections.defaultdict</code></p><p><code>collect()</code>ï¼šç»Ÿä¸€å„åˆ†åŒºçš„æ•°æ®ï¼Œå½¢æˆä¸€ä¸ª<code>List</code>ã€‚ <strong>è°¨æ…ä½¿ç”¨ï¼šç»“æœæ•°æ®é›†å¤ªå¤§çš„è¯ï¼ŒDriver å†…å­˜ä¼šçˆ†ç‚¸ã€‚</strong></p><p><code>reduce(func)</code>ï¼šè¿­ä»£åœ°å‡å°æ•°æ®ç»´åº¦ï¼š</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#24292E;">sc.parallelize([</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">3</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">4</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">5</span><span style="color:#24292E;">]).reduce(</span><span style="color:#D73A49;">lambda</span><span style="color:#24292E;"> a, b: a </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> b)</span></span>
<span class="line"><span style="color:#6A737D;"># è¿”å› 15</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><code>fold()</code>ï¼šåˆ†åˆ«å¯¹å„åˆ†åŒºè¿›è¡Œ reduceï¼Œç„¶åèšåˆã€‚reduce æ˜¯æœ‰åˆå§‹å€¼çš„ï¼šå¦‚ï¼š</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#24292E;">rdd1 </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> sc.parallelize([</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">3</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">4</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">5</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">6</span><span style="color:#24292E;">], </span><span style="color:#005CC5;">3</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#005CC5;">print</span><span style="color:#24292E;">(rdd1.glom().collect())</span></span>
<span class="line"><span style="color:#6A737D;"># [[1, 2], [3, 4], [5, 6]]</span></span>
<span class="line"><span style="color:#005CC5;">print</span><span style="color:#24292E;">(rdd1.fold(</span><span style="color:#005CC5;">10</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">lambda</span><span style="color:#24292E;"> a, b: a </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> b))  </span></span>
<span class="line"><span style="color:#6A737D;"># (1+2+10) + (3+4+10)+(5+6+10) = 61</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>first()</code>ï¼šè¿”å›ç¬¬ä¸€ä¸ªå…ƒç´ ã€‚</p><p><code>take(N)</code>ï¼šè¿”å›å‰ N ä¸ªå…ƒç´ ï¼Œ<code>List</code> å½¢å¼å‚¨å­˜ã€‚</p><p><code>top(N)</code>ï¼šè¿”å›é™åºæ’åºåçš„å‰ N ä¸ªå€¼ï¼Œ<code>List</code> å‚¨å­˜ã€‚</p><p><code>count()</code>ï¼šè¿”å› RDD æ•°æ®æ•°é‡ï¼Œ<code>int</code>ã€‚</p><p><code>takeSample(withReplacement=True, num=10, seed=7))</code>ï¼šéšæœºæŠ½å– n ä¸ªæ ·æœ¬ã€‚</p><p><code>takeOrdered(num, key=func)</code>ï¼šè¿”å› <code>List</code> ä¸ºæ ¹æ® <code>func()</code> æ’åºåçš„å‰ <code>num</code> ä¸ªå…ƒç´ </p><p><code>foreach(func)</code>ï¼šè¿­ä»£å¯¹æ‰€æœ‰å…ƒç´ è¿›è¡Œå¤„ç†ã€‚è¯¥æ‰§è¡Œä¸ç»è¿‡ Driverã€‚</p><p><code>saveAsTextFile()</code>ï¼šå°† RDD å†™å…¥æ–‡æœ¬æ–‡ä»¶ä¸­ã€‚ç”± Executor ç›´æ¥æ‰§è¡Œï¼Œæ‰§è¡Œç»“æœä¸ä¼šå‘é€åˆ° Driverã€‚</p><p><code>foreachPartition()</code>ï¼šä¸ <code>foreach()</code> ç±»ä¼¼ï¼Œä½†è°ƒç”¨ä¸€æ¬¡å‡½æ•°å¤„ç†ä¸€ä¸ªåˆ†åŒºçš„æ•°æ®ã€‚</p><h3 id="rdd-æŒä¹…åŒ–" tabindex="-1"><a class="header-anchor" href="#rdd-æŒä¹…åŒ–" aria-hidden="true">#</a> RDD æŒä¹…åŒ–</h3><p>spark æä¾›äº† RDD ç¼“å­˜ API ä»¥å‡å°‘é‡å¤è®¡ç®—ã€‚å¯ä»¥ä½¿ç”¨ <code>persist()</code> æˆ– <code>cache()</code> æ¥ç¼“å­˜ï¼Œä¸€èˆ¬ç”¨çš„è¾ƒå¤šçš„æ˜¯ï¼š<code>persist(StorageLevel.MEMORY_AND_DISK)</code> ã€‚å¯¹äº pythonï¼Œéƒ½æ˜¯ç”¨ Pickle è¿›è¡Œåºåˆ—åŒ–ç¼“å­˜ï¼Œæ›´å¤šç¼“å­˜ç­‰çº§å‚è€ƒï¼š<a href="https://spark.apache.org/docs/3.1.2/rdd-programming-guide.html#rdd-persistence" target="_blank" rel="noopener noreferrer">å®˜æ–¹<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ã€‚ä¸»åŠ¨æ¸…ç†ç¼“å­˜çš„ APIï¼š<code>rdd.unpersist()</code>ã€‚ <strong>ç¼“å­˜å¹¶ä¸æ˜¯å®‰å…¨çš„ï¼Œå†…å­˜ä¸è¶³/æ–­ç”µ/ç¡¬ç›˜æŸåç­‰éƒ½å¯èƒ½é€ æˆæ•°æ®å‡ºé”™ã€‚</strong></p><p>RDD çš„ CheckPoint è¢«è®¾è®¡è®¤ä¸ºæ˜¯å®‰å…¨çš„ï¼ˆä¸æ’é™¤ç‰©ç†å› ç´ ç ´åæ•°æ®ï¼‰ï¼Œä»…æ”¯æŒç¡¬ç›˜å‚¨å­˜ã€‚checkpoint å¯ä»¥é€‰æ‹©æ•°æ®å¤‡ä»½åœ°å€ï¼Œå› æ­¤å¯ä»¥å­˜å‚¨åœ¨ HDFS ä¸­ï¼›æ€§èƒ½æ¯”ç¼“å­˜æ›´å¥½ï¼›ä¸ç®¡åˆ†åŒºå¤šå°‘ï¼Œé£é™©æ˜¯ä¸€æ ·çš„ï¼ˆä¸åŒäºç¼“å­˜ï¼‰ã€‚</p><p>é…ç½® checkpoint ç›®æ ‡åœ°å€ï¼š<code>sc.setCheckpointDir(&quot;hdfs://node1:8020/output/bj52kp&quot;)</code>ï¼›ä¿å­˜æ—¶ç›´æ¥è°ƒç”¨ï¼š<code>rdd.checkpoint()</code></p><p><strong>ç¼“å­˜ä¸ checkpoint éƒ½ä¸æ˜¯ action æ“ä½œï¼Œæ‰€ä»¥åé¢è¦åŠ ä¸Š Actionã€‚</strong></p><h3 id="å…±äº«å˜é‡" tabindex="-1"><a class="header-anchor" href="#å…±äº«å˜é‡" aria-hidden="true">#</a> å…±äº«å˜é‡</h3><p>æ¯ä¸ª excutor è¿›ç¨‹å¯ä»¥å¤„ç†å¤šä¸ªåˆ†åŒºã€‚å½“ excutor å¤„ç† RDD æ—¶éœ€è¦æŸäº› python å˜é‡ï¼ˆRDD å¤–çš„ python å˜é‡éƒ½ç”± Driver å¤„ç†ä¸å‚¨å­˜ã€‚ï¼‰ï¼ŒDriver éœ€è¦ä¸ºæ¯ä¸ªåˆ†åŒºå‘é€ä¸€ä»½æ•°æ®ã€‚å› æ­¤æ¯ä¸ª excutor ä¸­å°±æœ‰å¤šä¸ªç›¸åŒæ•°æ®ï¼Œé€ æˆé¢å¤–ç½‘ç»œ IO å¼€é”€ä¸å†…å­˜æµªè´¹ã€‚</p><p><strong>å¹¿æ’­å˜é‡ï¼š</strong> å°† python å˜é‡æ•°æ® <code>python_val</code> æ ‡è®°ä¸ºå¹¿æ’­å˜é‡ï¼š<code>broadcase = sc.broadcast(python_val)</code>ã€‚ä½¿ç”¨æ—¶ï¼š<code>broadcast.value</code> æå–æ•°æ®ã€‚</p><p><strong>ç´¯åŠ å™¨ï¼š</strong> éœ€æ±‚ï¼šå½“ä¸åŒåˆ†åŒºè¿è¡Œæ—¶ï¼Œä»–ä»¬éœ€è¦å¯¹åŒä¸€ä¸ªå…¨å±€å˜é‡è¿›è¡Œæ“ä½œã€‚python çš„ <code>global</code> æ— æ³•æ»¡è¶³éœ€æ±‚ï¼Œç”±äºæœºå™¨ä¸åŒï¼Œæ— æ³•é€šè¿‡æŒ‡é’ˆç­‰å®ç°ã€‚éœ€è¦ä½¿ç”¨ spark æä¾›çš„ç´¯åŠ å™¨ã€‚</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#24292E;">acmlt </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> sc.accumulator(</span><span style="color:#005CC5;">66</span><span style="color:#24292E;">)  </span><span style="color:#6A737D;"># åˆå§‹åŒ–å€¼ä¸º acmlt=66</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">map_func</span><span style="color:#24292E;">(data):</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">global</span><span style="color:#24292E;"> acmlt</span></span>
<span class="line"><span style="color:#24292E;">    acmlt </span><span style="color:#D73A49;">+=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ç´¯åŠ å™¨éœ€æ³¨æ„ï¼š</strong> å¯èƒ½éœ€è¦åŠ ç¼“å­˜æ¥è§£å†³ä»¥ä¸‹é—®é¢˜ã€‚</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#24292E;">rdd </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> sc.parallelize([</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">3</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">4</span><span style="color:#24292E;">],</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">acmlt </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> sc.accumulator(</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">rdd2 </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> rdd.map(map_func)</span></span>
<span class="line"><span style="color:#24292E;">rdd2.collect()  </span><span style="color:#6A737D;"># rdd2 action åä¸ä¿å­˜æ•°æ®ã€‚æ­¤æ—¶ acmlt ä¸º 4</span></span>
<span class="line"><span style="color:#24292E;">rdd3 </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> rdd2.map(</span><span style="color:#D73A49;">lambda</span><span style="color:#24292E;"> x:x)  </span><span style="color:#6A737D;"># rdd3 æ„é€ éœ€è¦å†æ¬¡æ„é€  rdd2ï¼Œæ­¤æ—¶ acmlt ä¸º 8.</span></span>
<span class="line"><span style="color:#24292E;">rdd3.collect() </span></span>
<span class="line"><span style="color:#005CC5;">print</span><span style="color:#24292E;">(accmlt)  </span><span style="color:#6A737D;"># 8</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="å†…æ ¸è°ƒåº¦" tabindex="-1"><a class="header-anchor" href="#å†…æ ¸è°ƒåº¦" aria-hidden="true">#</a> å†…æ ¸è°ƒåº¦</h3><p>æ ¹æ® RDD çš„è¿­ä»£ç‰¹æ€§ï¼Œç¨‹åºçš„æ•´ä¸ªè®¡ç®—è·¯ç¨‹å¯ä»¥é€šè¿‡ <strong>DAG</strong> æœ‰å‘æ— ç¯å›¾è¡¨ç¤ºã€‚æ¯ä¸ª Action æ“ä½œçš„æ‰§è¡Œéƒ½ä¼šè§¦å‘è¯¥ä¸€ä¸ª JOB æ¥è®¡ç®— Action ä¹‹å‰çš„å­å›¾ã€‚<code>1 ä¸ª action=1 ä¸ªæœ‰å‘æ— ç¯å›¾=1 ä¸ª JOB</code>ã€‚å¦‚æœæœ‰ 3 ä¸ª actionï¼Œé‚£ä¹ˆä»£ç å°±äº§ç”Ÿ 3 ä¸ª JOBï¼Œè¿™äº› JOBï¼ŒSpark ç§°ä¸º Applicationã€‚</p><p>DAG ä¸­ RDD èŠ‚ç‚¹ä¹‹é—´çš„å…³ç³»åˆ†ä¸ºï¼š <strong>çª„ä¾èµ–</strong> ï¼šçˆ¶ RDD çš„ä¸€ä¸ªåˆ†åŒºï¼Œå…¨éƒ¨å°†æ•°æ®å‘ç»™å­ RDD çš„ä¸€ä¸ªåˆ†åŒºã€‚ <strong>å®½ä¾èµ–/shuffle</strong> ï¼šçˆ¶ RDD çš„ä¸€ä¸ªåˆ†åŒºï¼Œå°†æ•°æ®å‘ç»™å­ RDD çš„å¤šä¸ªåˆ†åŒºã€‚</p><p><strong>stage æ ¹æ®å®½ä¾èµ–è¿›è¡Œåˆ’åˆ†</strong> ï¼Œå› æ­¤æ¯ä¸ª stage å†…éƒ¨éƒ½æ˜¯çª„ä¾èµ–ã€‚</p><p>æ¯ä¸ª task æ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼ˆDAG ä¸Šå‘ˆç°ä¸ºï¼Œä¸€ä¸ª stage ä¸­çš„ä¸€æ¡æ¥è¿é€šçš„è®¡ç®—æµç¨‹çº¿ï¼‰ï¼Œçº¿ç¨‹å†…æ˜¯çº¯å†…å­˜è®¡ç®—ï¼Œæ‰€æœ‰çº¿ç¨‹å¹¶è¡Œè®¡ç®—ï¼Œå¹¶è¡Œç¨‹åº¦å—å…¨å±€å¹¶è¡Œåº¦ <code>spark.default.parallelism</code>ã€åˆ†åŒºæ•°é‡å½±å“ã€‚ <strong>spark ä¸€èˆ¬ä¸è¦å†ç®—å­ä¸Šè®¾ç½®å¹¶è¡Œåº¦ï¼Œé™¤äº†éƒ¨åˆ†æ’åºç®—å­ï¼Œåˆ†åŒºæ•°é‡è®©ç³»ç»Ÿè‡ªåŠ¨è®¾ç½®å³å¯</strong> ã€‚</p><p>é›†ç¾¤ä¸­ï¼Œå¹¶è¡Œåº¦å¯ä»¥è®¾ç½®ä¸º CPU æ€»æ ¸å¿ƒçš„ 2 åˆ° 10 å€ã€‚<code>spark.default.parallelism=1000</code>ã€‚</p><p>åŸºäºä»¥ä¸Šåˆ†æï¼Œspark ç¨‹åºçš„è°ƒåº¦æµç¨‹ä¸ºï¼š</p><ul><li>æ„å»º Driver</li><li>æ„å»º SparkContext</li><li>äº§ç”Ÿ DAGï¼ŒåŸºäº <strong>DAG Scheduler</strong> æ„å»ºé€»è¾‘ task åˆ†é…</li><li>åŸºäº <strong>Task Scheduler</strong> ï¼Œå°† Task åˆ†é…åˆ° executor ä¸Šå·¥ä½œå¹¶ç›‘ç£ä»–ä»¬ï¼Œexecutor å·¥ä½œæ—¶æ±‡æŠ¥è¿›åº¦ã€‚</li></ul><p>å…¶ä¸­ DAG Scheduler ä¸ Task Scheduler ä¸º Driver å†…éƒ¨çš„ä¸¤ä¸ªç»„ä»¶ã€‚</p><h3 id="æ€»ç»“-spark-å±‚çº§" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“-spark-å±‚çº§" aria-hidden="true">#</a> æ€»ç»“ Spark å±‚çº§</h3><p>ä¸€ä¸ª Spark Application ï¼ˆå¦‚ bin/pysparkï¼‰ä¸­ï¼ŒåŒ…å«å¤šä¸ª Jobï¼Œæ¯ä¸ª Job ç”±å¤šä¸ª Stage ç»„æˆï¼Œæ¯ä¸ª Job æ‰§è¡ŒæŒ‰ç…§ DAG å›¾è¿›è¡Œã€‚æ¯ä¸ª Stage ä¸­åŒ…å«å¤šä¸ª Task ä»»åŠ¡ï¼Œæ¯ä¸ª Task ä»¥çº¿ç¨‹ Thread æ–¹å¼æ‰§è¡Œï¼Œéœ€è¦ 1Core CPUã€‚</p><ul><li><strong>Jobï¼š</strong> ç”±å¤šä¸ª Task çš„å¹¶è¡Œè®¡ç®—éƒ¨åˆ†ï¼Œä¸€èˆ¬ Spark ä¸­çš„ action æ“ä½œï¼ˆå¦‚ saveã€collectï¼‰ï¼Œä¼šç”Ÿæˆä¸€ä¸ª Jobã€‚</li><li><strong>Stageï¼š</strong> Job çš„ç»„æˆå•ä½ï¼Œä¸€ä¸ª Job ä¼šåˆ‡åˆ†æˆå¤šä¸ª Stageï¼ŒStage å½¼æ­¤ä¹‹é—´ç›¸äº’ä¾èµ–é¡ºåºæ‰§è¡Œï¼Œè€Œæ¯ä¸ª Stage æ˜¯å¤šä¸ª Task çš„é›†åˆï¼Œç±»ä¼¼ map å’Œ reduce stageã€‚</li><li><strong>Taskï¼š</strong> è¢«åˆ†é…åˆ°å„ä¸ª Executor çš„å•ä½å·¥ä½œå†…å®¹ï¼Œå®ƒæ˜¯ Spark ä¸­çš„æœ€å°æ‰§è¡Œå•ä½ï¼Œä¸€èˆ¬æ¥è¯´æœ‰å¤šå°‘ä¸ª Parititionï¼ˆç‰©ç†å±‚é¢çš„æ¦‚å¿µï¼Œå³åˆ†æ”¯å¯ä»¥ç†è§£ä¸ºå°†æ•°æ®åˆ’åˆ†æˆä¸åŒéƒ¨åˆ†å¹¶è¡Œå¤„ç†ï¼‰ï¼Œå°±ä¼šæœ‰å¤šå°‘ä¸ª Taskï¼Œæ¯ä¸ª Task åªä¼šå¤„ç†å•ä¸€åˆ†æ”¯ä¸Šçš„æ•°æ®ã€‚</li></ul><p>åœ¨ 18080 ä¸­é€‰æ‹© åˆšåˆšæäº¤çš„ pi è®¡ç®—ä»»åŠ¡ã€‚é€‰æ‹© Executors æŸ¥çœ‹ã€‚ä» é¡µé¢ç»“æœå¯ä»¥çœ‹å‡ºï¼ŒSpark Application è¿è¡Œåˆ°é›†ç¾¤ä¸Šæ—¶ï¼Œç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼šDriver Program å’Œ Executors</p><h3 id="spark-shuffle" tabindex="-1"><a class="header-anchor" href="#spark-shuffle" aria-hidden="true">#</a> Spark Shuffle</h3><p>DAG å°†ä¸€ä¸ª Job åˆ’åˆ†ä¸ºå¤šä¸ª Stageï¼Œè‹¥ç”¨ map æˆ– reduce æ¥æ ‡æ³¨æ¯ä¸ª Stageï¼ŒSpark Shuffle çš„ä½œç”¨æ—¶å°† map çš„è¾“å‡ºå¯¹åº”åˆ° reduce ä¸Šã€‚shuffle åˆ†ä¸º shuffle writeï¼ˆmap çš„æœ€åä¸€æ­¥ï¼‰ ä¸ shuffle readï¼ˆreduce çš„ç¬¬ä¸€æ­¥ï¼‰ã€‚å› æ­¤æ•°æ®æµå¤§è‡´ä¸º <code> stage1 - partition - stage2</code>ã€‚</p><h2 id="sparksql" tabindex="-1"><a class="header-anchor" href="#sparksql" aria-hidden="true">#</a> SparkSQL</h2><p>ç”¨äºå­˜å‚¨æµ·é‡ç»“æ„åŒ–æ•°æ®ã€‚æ”¯æŒ SQLï¼ŒHIVE ç­‰ã€‚SparkSQL ä¸ HIVE éƒ½ä¸ºåˆ†å¸ƒå¼ SQL è®¡ç®—å¼•æ“ï¼ŒSparkSQL å…·æœ‰æ›´å¥½çš„æ€§èƒ½ã€‚SparkSQL ä¸­å…±æœ‰ DataSetã€DataFrame å¯¹è±¡ã€‚Python ä»…æ”¯æŒ DataFrame å¯¹è±¡ï¼Œå³ä¸€åŠ©æ”»äºŒç»´è¡¨ç»“æ„æ•°æ®ã€‚</p><h3 id="å¿«é€Ÿä½“éªŒ" tabindex="-1"><a class="header-anchor" href="#å¿«é€Ÿä½“éªŒ" aria-hidden="true">#</a> å¿«é€Ÿä½“éªŒ</h3><p>Spark 2.0 åï¼Œæ¨å‡ºäº† SparkSession ç»Ÿä¸€ç¼–ç å…¥å£å¯¹è±¡ï¼Œæ”¯æŒ RDD ç¼–ç¨‹ä¸ SparkSQL ç¼–ç¨‹ã€‚</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> pyspark.sql </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> SparkSession</span></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">__name__</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;__main__&#39;</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    spark </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> SparkSession.builder. \</span></span>
<span class="line"><span style="color:#24292E;">        appName(</span><span style="color:#032F62;">&quot;local[*]&quot;</span><span style="color:#24292E;">). \</span></span>
<span class="line"><span style="color:#24292E;">        config(</span><span style="color:#032F62;">&quot;spark.sql.shuffle.partitions&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;4&quot;</span><span style="color:#24292E;">). \</span></span>
<span class="line"><span style="color:#24292E;">        getOrCreate()</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># appName è®¾ç½®ç¨‹åºåç§°, config è®¾ç½®ä¸€äº›å¸¸ç”¨å±æ€§</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># æœ€åé€šè¿‡ getOrCreate()æ–¹æ³•åˆ›å»º SparkSession å¯¹è±¡</span></span>
<span class="line"><span style="color:#24292E;">    df </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> spark.read.csv(</span><span style="color:#032F62;">&#39;file:///home/data/sql/stu_score.txt&#39;</span><span style="color:#24292E;">, </span><span style="color:#E36209;">sep</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;,&#39;</span><span style="color:#24292E;">, </span><span style="color:#E36209;">header</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">False</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    df2 </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> df.toDF(</span><span style="color:#032F62;">&#39;id&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;name&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;score&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    df2.printSchema()</span></span>
<span class="line"><span style="color:#24292E;">    df2.show()</span></span>
<span class="line"><span style="color:#24292E;">    df2.createTempView(</span><span style="color:#032F62;">&quot;score&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    spark.sql(</span><span style="color:#032F62;">&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#032F62;">    SELECT * FROM score WHERE name=&#39;è¯­æ–‡&#39; LIMIT 5</span></span>
<span class="line"><span style="color:#032F62;">    &quot;&quot;&quot;</span><span style="color:#24292E;">).show()</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="dataframe" tabindex="-1"><a class="header-anchor" href="#dataframe" aria-hidden="true">#</a> DataFrame</h3><p>DataFrame ä¸ºäºŒç»´è¡¨ç»“æ„ï¼Œå…¶ä¸­å‚¨å­˜å››ä¸ªå¯¹è±¡ï¼š</p><p><strong>StructType</strong> ï¼šæ•´ä¸ªè¡¨ç»“æ„çš„ä¿¡æ¯ <strong>StructField</strong> ï¼šæè¿°åˆ—çš„ä¿¡æ¯ <strong>Row</strong> ï¼šè¡Œæ•°æ® <strong>Column</strong> ï¼šåˆ—æ•°æ®ä»¥åŠåˆ—çš„ä¿¡æ¯</p><h4 id="åˆ›å»º-dataframe" tabindex="-1"><a class="header-anchor" href="#åˆ›å»º-dataframe" aria-hidden="true">#</a> åˆ›å»º DataFrame</h4><p>ä» RDD åˆ›å»ºï¼Œæ•°æ®ç±»å‹æ ¹æ® RDD æ¨æ–­ã€‚</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#24292E;">sc </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> spark.sparkContext</span></span>
<span class="line"><span style="color:#24292E;">rdd </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> sc.textFile(</span><span style="color:#032F62;">&quot;../data/sql/people.txt&quot;</span><span style="color:#24292E;">).\</span></span>
<span class="line"><span style="color:#005CC5;">map</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">lambda</span><span style="color:#24292E;"> x: x.split(</span><span style="color:#032F62;">&#39;,&#39;</span><span style="color:#24292E;">)).\</span></span>
<span class="line"><span style="color:#005CC5;">map</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">lambda</span><span style="color:#24292E;"> x: [x[</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">], </span><span style="color:#005CC5;">int</span><span style="color:#24292E;">(x[</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">])])</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">df </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> spark.createDataFrame(rdd, </span><span style="color:#E36209;">schema</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> [</span><span style="color:#032F62;">&#39;name&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;age&#39;</span><span style="color:#24292E;">])</span></span>
<span class="line"><span style="color:#6A737D;"># æˆ– df = rdd.toDF([&#39;name&#39;, &#39;age&#39;])</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å…¶ä¸­çš„ <code>schema</code> å‚æ•°å¯ä»¥é€šè¿‡ <code>StructType</code> å®šä¹‰ï¼š</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> pyspark.sql.types </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> StructType, StringType, IntegerType</span></span>
<span class="line"><span style="color:#24292E;">schema </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> StructType().\</span></span>
<span class="line"><span style="color:#24292E;">add(</span><span style="color:#032F62;">&quot;id&quot;</span><span style="color:#24292E;">, IntegerType(), </span><span style="color:#E36209;">nullable</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">False</span><span style="color:#24292E;">).\</span></span>
<span class="line"><span style="color:#24292E;">add(</span><span style="color:#032F62;">&quot;name&quot;</span><span style="color:#24292E;">, StringType(), </span><span style="color:#E36209;">nullable</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">True</span><span style="color:#24292E;">).\</span></span>
<span class="line"><span style="color:#24292E;">add(</span><span style="color:#032F62;">&quot;score&quot;</span><span style="color:#24292E;">, IntegerType(), </span><span style="color:#E36209;">nullable</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">False</span><span style="color:#24292E;">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä» <code>pd.DataFrame</code> åˆ›å»ºï¼šç›´æ¥ä½¿ç”¨ <code>spark_df = spark.createDataFrame(p_df)</code></p><p>ä»å¤–éƒ¨æ–‡ä»¶è¯»å–ï¼š</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#24292E;">schema </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> StructType().add(</span><span style="color:#032F62;">&quot;data&quot;</span><span style="color:#24292E;">, StringType(), </span><span style="color:#E36209;">nullable</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">True</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">df </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> spark.read.format(</span><span style="color:#032F62;">&quot;text&quot;</span><span style="color:#24292E;">)\</span></span>
<span class="line"><span style="color:#24292E;">.schema(schema)\</span></span>
<span class="line"><span style="color:#24292E;">.load(</span><span style="color:#032F62;">&quot;../data/sql/people.txt&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸€èˆ¬è¯»å–çš„æ—¶ <code>json</code>ã€<code>parquet</code> ç±»å‹çš„è¯ï¼Œä¸éœ€è¦æä¾›<code>schema</code>ã€‚</p><p>å¯¹äº CSV ç­‰ï¼Œå¯èƒ½éœ€è¦æä¾› <code>option</code> å‚æ•°ã€‚</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#24292E;">df </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> spark.read.format(</span><span style="color:#032F62;">&quot;csv&quot;</span><span style="color:#24292E;">)\</span></span>
<span class="line"><span style="color:#24292E;">.option(</span><span style="color:#032F62;">&quot;sep&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;;&quot;</span><span style="color:#24292E;">)\</span></span>
<span class="line"><span style="color:#24292E;">.option(</span><span style="color:#032F62;">&quot;header&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">False</span><span style="color:#24292E;">)\</span></span>
<span class="line"><span style="color:#24292E;">.option(</span><span style="color:#032F62;">&quot;encoding&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;utf-8&quot;</span><span style="color:#24292E;">)\</span></span>
<span class="line"><span style="color:#24292E;">.schema(</span><span style="color:#032F62;">&quot;name STRING, age INT, job STRING&quot;</span><span style="color:#24292E;">)\</span></span>
<span class="line"><span style="color:#24292E;">.load(</span><span style="color:#032F62;">&quot;../data/sql/people.csv&quot;</span><span style="color:#24292E;">)</span><span style="color:#6A737D;">#</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="dataframe-æ“ä½œ" tabindex="-1"><a class="header-anchor" href="#dataframe-æ“ä½œ" aria-hidden="true">#</a> DataFrame æ“ä½œ</h4><p>DataFrame å¯ä»¥é€šè¿‡ <code>sparksession.sql()</code> ç›´æ¥æ“ä½œï¼Œä½¿ç”¨ sql å‘½ä»¤éœ€è¦å…ˆæ³¨å†Œæˆä¸´æ—¶è¡¨ï¼š<code>df.createTempView(&quot;temp_name&quot;)</code>ï¼Œä»¥ä¸‹å±•ç¤ºéƒ¨åˆ†å¤„ <code>sparksession.sql()</code> å¤–çš„å¸¸ç”¨æ“ä½œï¼Œè¯¦ç»†æŸ¥çœ‹ <a href="https://spark.apache.org/docs/3.1.2/api/python/reference/api/pyspark.sql.DataFrame.html#pyspark.sql.DataFrame" target="_blank" rel="noopener noreferrer">å®˜æ–¹ API<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p><code>.show(n)</code>ï¼Œ<code>.printSchema()</code>ï¼šæŸ¥çœ‹æ•°æ®ä¿¡æ¯ã€‚</p><p><code>.select()</code>ï¼šé€‰æ‹©æŒ‡å®šçš„åˆ—ï¼Œä¼ å…¥åˆ—åæˆ– Column å¯¹è±¡ã€‚</p><p><code>.filter(condition)</code>ï¼Œ<code>.where()</code>ï¼šç­›é€‰è¡Œï¼Œæ¡ä»¶å¦‚ï¼šå¸ƒå°”å€¼çš„åˆ—æ•°æ®<code>df[&#39;score&#39;]&lt;9</code> æˆ– SQL é£æ ¼<code>&#39;score&#39;&lt;9</code></p><p><code>.groupBy()</code>ï¼šæŒ‰åˆ—åˆ†ç»„ï¼Œä¼ å…¥åˆ—åæˆ–åˆ—å¯¹è±¡ã€‚è¿”å› <code>GroupedData</code> å¯¹è±¡</p><p><code>from pyspark.sql import functions as F</code> æä¾›äº†åŸºç¡€è¡¨æ•°æ®è®¡ç®—åŠŸèƒ½ï¼Œå¦‚ <code>F.round()</code>, <code>F.avg()</code>, <code>F.min()</code>, <code>F.count</code> ç­‰æ¥ç›´æ¥å¯¹äºŒç»´æ•°æ®è¿›è¡Œè®¡ç®—ã€‚</p><p><code>.dropDuplicates()</code>ï¼šé»˜è®¤å¯¹æ•´ä½“å»é‡ï¼Œä¼ å…¥éœ€è¦å»é‡çš„åˆ—ã€‚</p><p><code>.dropna(thresh, subset)</code>ï¼šé’ˆå¯¹ <code>subset</code> ç»™å‡ºçš„åˆ—ï¼Œæœ‰æ•ˆä¿¡æ¯è‡³å°‘ä¸º <code>thresh</code> ä¸ªæ‰ä¿ç•™è¯¥è¡Œæ•°æ®ã€‚</p><p><code>.fillna()</code>ï¼š ä¼ å…¥ä¸€ä¸ªå¡«å……è§„åˆ™ï¼Œè¡¨ç¤ºæ¯ä¸ªåˆ—çš„å¡«å……å€¼<code>{&#39;name&#39;:&quot;unk&quot;,&quot;job&quot;:0}</code></p><h4 id="è¯»å†™æ•°æ®" tabindex="-1"><a class="header-anchor" href="#è¯»å†™æ•°æ®" aria-hidden="true">#</a> è¯»å†™æ•°æ®</h4><p>å†™å‡ºä¸ºæ–‡ä»¶ï¼š</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#24292E;">df.write.mode(</span><span style="color:#032F62;">&quot;overwrite&quot;</span><span style="color:#24292E;">).format(</span><span style="color:#032F62;">&quot;csv&quot;</span><span style="color:#24292E;">).\</span></span>
<span class="line"><span style="color:#24292E;">option(</span><span style="color:#032F62;">&quot;sep&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;,&quot;</span><span style="color:#24292E;">).option(</span><span style="color:#032F62;">&quot;header&quot;</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">True</span><span style="color:#24292E;">).\</span></span>
<span class="line"><span style="color:#24292E;">save(</span><span style="color:#032F62;">&quot;../mydata.csv&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯¹äº <code>json</code>æ ¼å¼ç›´æ¥å†™å‡ºï¼Œä¸éœ€è¦ <code>option</code>ï¼Œé»˜è®¤çš„æ–‡ä»¶å†™å‡ºæ ¼å¼ä¸º <code>parquet</code>ã€‚</p><p><strong>ä½¿ç”¨ JDBC è¯»å†™æ•°æ®åº“</strong> ï¼Œéœ€è¦é©±åŠ¨<code>mysql-connector-java-5.1.41-bin.jar</code> ä¸åŒ mysql å¯¹åº”ç‰ˆæœ¬ä¸åŒã€‚jar åŒ…å­˜æ”¾åœ°å€ï¼š<code>py è§£æå™¨ç¯å¢ƒ/lib/python3.8/site-packages/pyspark/jars</code></p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#24292E;">df.write.mode(</span><span style="color:#032F62;">&quot;overwrite&quot;</span><span style="color:#24292E;">).format(</span><span style="color:#032F62;">&quot;jdbc&quot;</span><span style="color:#24292E;">).\</span></span>
<span class="line"><span style="color:#24292E;">option(</span><span style="color:#032F62;">&quot;url&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;jdbc:mysql://node1:3306/databese?useSSL=false&amp;useUnicode=true&quot;</span><span style="color:#24292E;">).\</span></span>
<span class="line"><span style="color:#24292E;">option(</span><span style="color:#032F62;">&quot;dbtable&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;u_data&quot;</span><span style="color:#24292E;">).\</span></span>
<span class="line"><span style="color:#24292E;">option(</span><span style="color:#032F62;">&quot;user&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;root&quot;</span><span style="color:#24292E;">).\</span></span>
<span class="line"><span style="color:#24292E;">option(</span><span style="color:#032F62;">&quot;password&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;123456&quot;</span><span style="color:#24292E;">).\</span></span>
<span class="line"><span style="color:#24292E;">save()</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>jdbc</code> è¿æ¥å­—ç¬¦ä¸²ä¸­ï¼Œå»ºè®®ä½¿ç”¨ <code>useSSL=false</code> ä¿è¯æ­£å¸¸è¿æ¥ï¼Œ<code>useUnicode=true</code> ä¿è¯ä¼ è¾“æ— ä¹±ç ã€‚<code>dbtable</code> ä¸ºå†™å‡ºçš„è¡¨åã€‚</p><p><strong>ä½¿ç”¨ JDBC è¯»å–æ•°æ®åº“ï¼š</strong></p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#24292E;">df </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> read.format(</span><span style="color:#032F62;">&quot;jdbc&quot;</span><span style="color:#24292E;">).\</span></span>
<span class="line"><span style="color:#24292E;">option(</span><span style="color:#032F62;">&quot;url&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;jdbc:mysql://node1:3306/databese?useSSL=false&amp;useUnicode=true&quot;</span><span style="color:#24292E;">).\</span></span>
<span class="line"><span style="color:#24292E;">option(</span><span style="color:#032F62;">&quot;dbtable&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;u_data&quot;</span><span style="color:#24292E;">).\</span></span>
<span class="line"><span style="color:#24292E;">option(</span><span style="color:#032F62;">&quot;user&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;root&quot;</span><span style="color:#24292E;">).\</span></span>
<span class="line"><span style="color:#24292E;">option(</span><span style="color:#032F62;">&quot;password&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;123456&quot;</span><span style="color:#24292E;">).\</span></span>
<span class="line"><span style="color:#24292E;">load()</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="sparksql-å®šä¹‰-udf" tabindex="-1"><a class="header-anchor" href="#sparksql-å®šä¹‰-udf" aria-hidden="true">#</a> SparkSQL å®šä¹‰ UDF</h3><p>User-Define-Functionï¼Œå¯¹ python å‡½æ•°è¿›è¡Œæ³¨å†Œï¼Œè¿”å›å¯ç”¨äº DSL çš„å‡½æ•°æ“ä½œï¼Œæ³¨å†Œçš„å‡½æ•°åç§°å¯ç”¨äº SQL é£æ ¼ã€‚</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#24292E;">udf </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> spark.udf.register(</span><span style="color:#032F62;">&quot;udf1&quot;</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">lambda</span><span style="color:#24292E;"> x: x </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10</span><span style="color:#24292E;">, BooleanType())</span></span>
<span class="line"><span style="color:#24292E;">df.filter(udf(df[</span><span style="color:#032F62;">&#39;age&#39;</span><span style="color:#24292E;">])).show()</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯¹äºä¼ é€’çš„è¿”å›ç±»å‹å‚æ•°ï¼Œéœ€è¦ä» <code>pyspark.sql.types</code> ä¸­é€‰å–ï¼Œæ•°ç»„ç±»å‹å¯ç”¨ <code>ArrayType(StringType())</code>ï¼ˆå³ python ä¸­çš„ <code>List(Str)</code>ï¼‰ï¼›å­—å…¸ç±»å‹ä½¿ç”¨ <code>StructType()</code>ï¼Œæ­¤å¤„éœ€è¦æå‰å£°æ˜ <code>StructTrype()</code> ä¸­çš„ç»“æ„ä½“ä¿¡æ¯ã€‚</p><h3 id="çª—å£å‡½æ•°" tabindex="-1"><a class="header-anchor" href="#çª—å£å‡½æ•°" aria-hidden="true">#</a> çª—å£å‡½æ•°</h3><p>å¯ä»¥å°†èšåˆå‰ä¸èšåˆåçš„æ•°æ®æ˜¾ç¤ºåœ¨åŒä¸€ä¸ªè¡¨ä¸­ã€‚</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#24292E;"># åœ¨ </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> æ•°æ®åè¿½åŠ ä¸€åˆ—çª—å£ï¼Œä»£è¡¨å­¦ç”Ÿçš„å¹³å‡æˆç»©</span></span>
<span class="line"><span style="color:#005CC5;">spark</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">sql</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#032F62;">          SELECT *, AVG(SCORE) OVER() AS avg_score FROM stu</span></span>
<span class="line"><span style="color:#032F62;">          &quot;&quot;&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">          </span></span>
<span class="line"><span style="color:#24292E;"># èšåˆç±»å‹ SUM</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">MIN</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">MAX</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">AVG</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">COUNT</span></span>
<span class="line"><span style="color:#005CC5;">SUM</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">OVER</span><span style="color:#24292E;">([PARTITION BY XX][ORDER BY XX])</span></span>
<span class="line"><span style="color:#24292E;"># æ’åºç±»å‹ RANK</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">ROW_NUMBER</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">DENSE_RANK</span></span>
<span class="line"><span style="color:#005CC5;">RANK</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">OVER</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;"># åˆ†åŒºç±»å‹ NTILE</span></span>
<span class="line"><span style="color:#005CC5;">NTILE</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">number</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">OVER</span><span style="color:#24292E;">() </span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="sql-æµç¨‹" tabindex="-1"><a class="header-anchor" href="#sql-æµç¨‹" aria-hidden="true">#</a> SQL æµç¨‹</h3><p>SparkSQL å¯ä»¥è‡ªåŠ¨ä¼˜åŒ–ï¼ˆä¾èµ–äº Catalyst ä¼˜åŒ–å™¨ï¼‰ï¼Œæå‡ä»£ç è¿è¡Œæ•ˆç‡ã€‚SparkSQL æ¥æ”¶åˆ° SQL è¯­å¥åï¼Œé€šè¿‡ Catalyst è§£æï¼Œå¹¶ç”Ÿæˆ RDD æ‰§è¡Œè®¡åˆ’ï¼Œè€Œåäº¤ç»™é›†ç¾¤æ‰§è¡Œã€‚</p><p><strong>Catalyst ä¼˜åŒ–ï¼š</strong></p><p>é¦–å…ˆç”Ÿæˆ AST æŠ½è±¡è¯­æ³•æ ‘ï¼Œåœ¨ AST ä¸­åŠ å…¥å…ƒæ•°æ®ä¿¡æ¯ï¼ˆä»¥ä¾›ä¼˜åŒ–ï¼‰ã€‚ä¼˜åŒ–æ–¹å¼åŒ…æ‹¬ï¼š</p><ul><li><p><strong>Predicate Pushdown</strong> æ–­è¨€ä¸‹æ¨ï¼šå°† Filter è¿™ç§å¯ä»¥å‡å°æ•°æ®é›†çš„æ“ä½œä¸‹æ¨ï¼Œæ”¾åœ¨ Scan çš„ä½ç½®ï¼Œå‡å°‘æ— ç”¨æ“ä½œé‡ã€‚ï¼ˆå¦‚æå‰æ‰§è¡Œ whereï¼‰</p></li><li><p><strong>Column Pruning</strong> åˆ—å€¼è£å‰ªï¼šæ–­è¨€ä¸‹æ¨åï¼Œå¯¹æ— ç”¨çš„åˆ—è¿›è¡Œè£å‰ªã€‚ï¼ˆå¦‚æå‰è§„åˆ’ select æ•°é‡ï¼‰</p></li><li><p><strong>ç­‰ç­‰è®¸å¤šä¼˜åŒ–æ–¹æ¡ˆ</strong> ï¼Œå…·ä½“å¯æŸ¥çœ‹ <code>org.apache.spark.sql.catalyst.optimizer.Optimizer</code> æºç </p></li></ul><h3 id="spark-on-hive" tabindex="-1"><a class="header-anchor" href="#spark-on-hive" aria-hidden="true">#</a> Spark on Hive</h3><p>ç›¸å½“äºå°† HIVE SQL è§£é‡Šå™¨å¼•æ“æ¢æˆäº† SparkSQL è§£é‡Šå™¨å¼•æ“ã€‚</p><p>Spark è‡ªèº«æ²¡æœ‰å…ƒæ•°æ®ç®¡ç†åŠŸèƒ½ï¼Œå½“ Spark æ‰§è¡Œ SQL é£æ ¼è¯­å¥å¦‚ <code>SELECT * FROM person</code> æ—¶å€™ï¼Œå¦‚æœæ²¡æœ‰ person å‚¨å­˜ä½ç½®ï¼Œperson åŒ…å«çš„å­—æ®µã€å­—æ®µç±»å‹çš„è¯ï¼Œåˆ™ SQL è¯­å¥å°†æ— æ³•è¢«è§£æå¹¶æ‰§è¡Œã€‚</p><p>SparkSQL ä¸­å°†è¿™äº›å…ƒæ•°æ®ä¿¡æ¯æ³¨å†Œåœ¨äº† DataFrame ä¸­ï¼Œè€Œæ•°æ®åº“çš„å…ƒæ•°æ®ä¿¡æ¯ï¼Œç”± Hive çš„ MetaStore æ¥æä¾›ç®¡ç†ï¼ŒSpark åªæ˜¯æä¾›æ‰§è¡Œå¼•æ“ã€‚å› æ­¤ Spark èƒ½å¤Ÿé“¾æ¥ä¸Š Hive çš„ MetaStore å°±å¯ä»¥äº†ï¼ŒMetaStore éœ€è¦å­˜åœ¨å¹¶å¼€æœºï¼Œé€šè¿‡é…ç½® <code>hive-site.xml</code> Spark èƒ½çŸ¥é“ MetaStore çš„ç«¯å£å·ï¼š</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#24292E;">&lt;</span><span style="color:#22863A;">property</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">    &lt;</span><span style="color:#22863A;">name</span><span style="color:#24292E;">&gt;hive.metastore.uris&lt;/</span><span style="color:#22863A;">name</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">    &lt;</span><span style="color:#22863A;">value</span><span style="color:#24292E;">&gt;thrift://node1:9083&lt;/</span><span style="color:#22863A;">value</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">&lt;/</span><span style="color:#22863A;">property</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»£ç ä¸­åªéœ€è¦å¢åŠ  3 è¡Œä»£ç ä»¥ç»§æ‰¿ Hive</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#24292E;">spark </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> SparkSession.builder. \</span></span>
<span class="line"><span style="color:#24292E;">        appName(</span><span style="color:#032F62;">&quot;local[*]&quot;</span><span style="color:#24292E;">). \</span></span>
<span class="line"><span style="color:#24292E;">        config(</span><span style="color:#032F62;">&quot;spark.sql.shuffle.partitions&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;4&quot;</span><span style="color:#24292E;">). \</span></span>
<span class="line"><span style="color:#24292E;">        config(</span><span style="color:#032F62;">&quot;spark.sql.warehouse.dir&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;hdfs://node1:8020/user/hive/warehouse&quot;</span><span style="color:#24292E;">).\</span></span>
<span class="line"><span style="color:#24292E;">        config(</span><span style="color:#032F62;">&quot;hive.metastore.uris&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;thrift://node1:9083&quot;</span><span style="color:#24292E;">).\</span></span>
<span class="line"><span style="color:#24292E;">        enableHiveSupport().\ </span></span>
<span class="line"><span style="color:#24292E;">        getOrCreate()</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="åˆ†å¸ƒå¼-sql-æ‰§è¡Œå¼•æ“" tabindex="-1"><a class="header-anchor" href="#åˆ†å¸ƒå¼-sql-æ‰§è¡Œå¼•æ“" aria-hidden="true">#</a> åˆ†å¸ƒå¼ SQL æ‰§è¡Œå¼•æ“</h3><p>Spark çš„ ThriftServer æœåŠ¡å¯ä»¥åœ¨ 10000 ç«¯å£ç›‘å¬ã€‚é€šè¿‡è¯¥æœåŠ¡ï¼Œç”¨æˆ·ä¼šå†™ SQL å°±å¯æ“ä½œ sparkã€‚</p><p><strong>å¯åŠ¨ ThriftServer æœåŠ¡</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#24292E;">$SPARK_HOME/sbin/start-thriftserver.sh \</span></span>
<span class="line"><span style="color:#6F42C1;">--hiveconf</span><span style="color:#24292E;"> </span><span style="color:#032F62;">hive.server2.thrift.port=</span><span style="color:#005CC5;">10000</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\</span></span>
<span class="line"><span style="color:#24292E;">--hiveconf </span><span style="color:#032F62;">hive.server.thrift.bind.host=node1</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\</span></span>
<span class="line"><span style="color:#24292E;">--master </span><span style="color:#032F62;">local[</span><span style="color:#005CC5;">2</span><span style="color:#032F62;">]</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¸¸ç”¨çš„ç”¨æ¥é“¾æ¥çš„å®¢æˆ·ç«¯å·¥å…·æœ‰ DBeaver, datagrip, heidisqlã€‚python ä»£ç é“¾æ¥ Thrift å¯ä½¿ç”¨ pyhive åº“ã€‚</p><p><code>pip install pyhive pymysql sasl thrift thrift_sasl</code></p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> pyhive </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> hive</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">conn </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> hive.Connection(</span><span style="color:#E36209;">host</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;node1&quot;</span><span style="color:#24292E;">, </span><span style="color:#E36209;">port</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">10000</span><span style="color:#24292E;">, </span><span style="color:#E36209;">username</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;hadoop&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">cursor </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> conn.cursor()</span></span>
<span class="line"><span style="color:#24292E;">cursor.execute(</span><span style="color:#032F62;">&quot;SELECT * FROM test&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">result </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> cursor.fetchall()</span></span>
<span class="line"><span style="color:#005CC5;">print</span><span style="color:#24292E;">(result)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="å…¶ä»–" tabindex="-1"><a class="header-anchor" href="#å…¶ä»–" aria-hidden="true">#</a> å…¶ä»–</h1><p>Koalasâ€”â€”åŸºäº Apache Spark çš„ pandas API å®ç°</p><p><a href="https://spark.apache.org/docs/latest/ml-guide.html" target="_blank" rel="noopener noreferrer">Spark mllib æ–‡æ¡£<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> MLlib æä¾›åŸºç¡€çš„æœºæ¢°å­¦ä¹ ç®—æ³•ï¼Œä»£ç é£æ ¼ç±»ä¼¼ sklearnã€‚</p><h1 id="å…¶ä»–è¿è¡Œæ¨¡å¼æ­å»º" tabindex="-1"><a class="header-anchor" href="#å…¶ä»–è¿è¡Œæ¨¡å¼æ­å»º" aria-hidden="true">#</a> å…¶ä»–è¿è¡Œæ¨¡å¼æ­å»º</h1><h2 id="standalone-æ¶æ„" tabindex="-1"><a class="header-anchor" href="#standalone-æ¶æ„" aria-hidden="true">#</a> Standalone æ¶æ„</h2><p>Standalone æ¨¡å¼æ˜¯ Spark è‡ªå¸¦çš„ä¸€ç§é›†ç¾¤æ¨¡å¼ï¼Œè¯¥æ¨¡å¼ä¸­ master ä¸ worker ä»¥ç‹¬ç«‹è¿›ç¨‹çš„å½¢å¼å­˜åœ¨ã€‚ StandAlone æ˜¯å®Œæ•´çš„ Spark è¿è¡Œç¯å¢ƒï¼Œå…¶ä¸­: Master è§’è‰²ä»¥ Master è¿›ç¨‹å­˜åœ¨, Worker è§’è‰²ä»¥ Worker è¿›ç¨‹å­˜åœ¨ Driver å’Œ Executor è¿è¡Œäº Worker è¿›ç¨‹å†…, ç”± Worker æä¾›èµ„æºä¾›ç»™å®ƒä»¬è¿è¡Œ</p><p>StandAlone é›†ç¾¤åœ¨è¿›ç¨‹ä¸Šä¸»è¦æœ‰ 3 ç±»è¿›ç¨‹:</p><ul><li>ä¸»èŠ‚ç‚¹ Master è¿›ç¨‹ï¼šMaster è§’è‰², ç®¡ç†æ•´ä¸ªé›†ç¾¤èµ„æºï¼Œå¹¶æ‰˜ç®¡è¿è¡Œå„ä¸ªä»»åŠ¡çš„ Driver</li><li>ä»èŠ‚ç‚¹ Workersï¼šWorker è§’è‰², ç®¡ç†æ¯ä¸ªæœºå™¨çš„èµ„æºï¼Œåˆ†é…å¯¹åº”çš„èµ„æºæ¥- è¿è¡Œ Executor(Task)ï¼› æ¯ä¸ªä»èŠ‚ç‚¹åˆ†é…èµ„æºä¿¡æ¯ç»™ Worker ç®¡ç†ï¼Œèµ„æºä¿¡æ¯åŒ…å«å†…å­˜ Memory å’Œ CPU Cores æ ¸æ•°</li><li>å†å²æœåŠ¡å™¨ HistoryServer(å¯é€‰)ï¼šSpark Application è¿è¡Œå®Œæˆä»¥åï¼Œä¿å­˜äº‹ä»¶æ—¥å¿—æ•°æ®è‡³ HDFSï¼Œå¯åŠ¨ HistoryServer å¯ä»¥æŸ¥çœ‹åº”ç”¨è¿è¡Œç›¸å…³ä¿¡æ¯ã€‚</li></ul><h3 id="å®ä¾‹é›†ç¾¤è§„åˆ’" tabindex="-1"><a class="header-anchor" href="#å®ä¾‹é›†ç¾¤è§„åˆ’" aria-hidden="true">#</a> å®ä¾‹é›†ç¾¤è§„åˆ’</h3><p>å°è¯•ä½¿ç”¨ä¸‰å° Linux è™šæ‹Ÿæœºæ¥ç»„æˆé›†ç¾¤ç¯å¢ƒè¿›è¡Œä½“éªŒï¼Œéåˆ«æ˜¯:</p><p>node1 è¿è¡Œ: Spark çš„ Master è¿›ç¨‹ å’Œ 1 ä¸ª Worker è¿›ç¨‹ node2 è¿è¡Œ: spark çš„ 1 ä¸ª worker è¿›ç¨‹ node3 è¿è¡Œ: spark çš„ 1 ä¸ª worker è¿›ç¨‹</p><p>æ•´ä¸ªé›†ç¾¤æä¾›: 1 ä¸ª master è¿›ç¨‹ å’Œ 3 ä¸ª worker è¿›ç¨‹</p><h3 id="å®‰è£…" tabindex="-1"><a class="header-anchor" href="#å®‰è£…" aria-hidden="true">#</a> å®‰è£…</h3><p>åœ¨æ‰€æœ‰èŠ‚ç‚¹ä¸Šå®‰è£… python anaconda ï¼ŒåŒæ—¶ä¸è¦å¿˜è®° éƒ½åˆ›å»º<code>pyspark</code>è™šæ‹Ÿç¯å¢ƒ ä»¥åŠå®‰è£…è™šæ‹Ÿç¯å¢ƒæ‰€éœ€è¦çš„åŒ…<code>pyspark jieba pyhive</code></p><p>ä¸ºäº†è®© spark æ‹¥æœ‰ hdfs æœ€å¤§æƒé™ï¼Œspark å®‰è£…ä¹Ÿä½¿ç”¨ hadoop ç”¨æˆ·ï¼š<code>chown -R hadoop:hadoop spark*</code></p><h3 id="é…ç½®é…ç½®æ–‡ä»¶" tabindex="-1"><a class="header-anchor" href="#é…ç½®é…ç½®æ–‡ä»¶" aria-hidden="true">#</a> é…ç½®é…ç½®æ–‡ä»¶</h3><p>è¿›å…¥åˆ° spark çš„é…ç½®æ–‡ä»¶ç›®å½•ä¸­, <code>cd $SPARK_HOME/conf</code></p><p>é…ç½® workers æ–‡ä»¶</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># æ”¹å, å»æ‰åé¢çš„.template åç¼€</span></span>
<span class="line"><span style="color:#6F42C1;">mv</span><span style="color:#24292E;"> </span><span style="color:#032F62;">workers.template</span><span style="color:#24292E;"> </span><span style="color:#032F62;">workers</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># ç¼–è¾‘ worker æ–‡ä»¶</span></span>
<span class="line"><span style="color:#6F42C1;">vim</span><span style="color:#24292E;"> </span><span style="color:#032F62;">workers</span></span>
<span class="line"><span style="color:#6A737D;"># å°†é‡Œé¢çš„ localhost åˆ é™¤, è¿½åŠ </span></span>
<span class="line"><span style="color:#6F42C1;">node1</span></span>
<span class="line"><span style="color:#6F42C1;">node2</span></span>
<span class="line"><span style="color:#6F42C1;">node3</span></span>
<span class="line"><span style="color:#6F42C1;">åˆ°</span><span style="color:#24292E;"> </span><span style="color:#032F62;">workers</span><span style="color:#24292E;"> </span><span style="color:#032F62;">æ–‡ä»¶å†…</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># åŠŸèƒ½: è¿™ä¸ªæ–‡ä»¶å°±æ˜¯æŒ‡ç¤ºäº†  å½“å‰ SparkStandAlone ç¯å¢ƒä¸‹, æœ‰å“ªäº› worker</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é…ç½® spark-env.sh æ–‡ä»¶</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># 1. æ”¹å</span></span>
<span class="line"><span style="color:#6F42C1;">mv</span><span style="color:#24292E;"> </span><span style="color:#032F62;">spark-env.sh.template</span><span style="color:#24292E;"> </span><span style="color:#032F62;">spark-env.sh</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 2. ç¼–è¾‘ spark-env.sh, åœ¨åº•éƒ¨è¿½åŠ å¦‚ä¸‹å†…å®¹</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">## è®¾ç½® JAVA å®‰è£…ç›®å½•</span></span>
<span class="line"><span style="color:#24292E;">JAVA_HOME</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">/export/server/jdk</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">## HADOOP è½¯ä»¶é…ç½®æ–‡ä»¶ç›®å½•ï¼Œè¯»å– HDFS ä¸Šæ–‡ä»¶å’Œè¿è¡Œ YARN é›†ç¾¤</span></span>
<span class="line"><span style="color:#24292E;">HADOOP_CONF_DIR</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">/export/server/hadoop/etc/hadoop</span></span>
<span class="line"><span style="color:#24292E;">YARN_CONF_DIR</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">/export/server/hadoop/etc/hadoop</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">## æŒ‡å®š spark è€å¤§ Master çš„ IP å’Œæäº¤ä»»åŠ¡çš„é€šä¿¡ç«¯å£</span></span>
<span class="line"><span style="color:#6A737D;"># å‘ŠçŸ¥ Spark çš„ master è¿è¡Œåœ¨å“ªä¸ªæœºå™¨ä¸Š</span></span>
<span class="line"><span style="color:#D73A49;">export</span><span style="color:#24292E;"> SPARK_MASTER_HOST</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">node1</span></span>
<span class="line"><span style="color:#6A737D;"># å‘ŠçŸ¥ sparkmaster çš„é€šè®¯ç«¯å£</span></span>
<span class="line"><span style="color:#D73A49;">export</span><span style="color:#24292E;"> SPARK_MASTER_PORT</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">7077</span></span>
<span class="line"><span style="color:#6A737D;"># å‘ŠçŸ¥ spark master çš„ webui ç«¯å£</span></span>
<span class="line"><span style="color:#24292E;">SPARK_MASTER_WEBUI_PORT</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">8080</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># worker cpu å¯ç”¨æ ¸æ•°</span></span>
<span class="line"><span style="color:#24292E;">SPARK_WORKER_CORES</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#6A737D;"># worker å¯ç”¨å†…å­˜</span></span>
<span class="line"><span style="color:#24292E;">SPARK_WORKER_MEMORY</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#032F62;">g</span></span>
<span class="line"><span style="color:#6A737D;"># worker çš„å·¥ä½œé€šè®¯åœ°å€</span></span>
<span class="line"><span style="color:#24292E;">SPARK_WORKER_PORT</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">7078</span></span>
<span class="line"><span style="color:#6A737D;"># worker çš„ webui åœ°å€</span></span>
<span class="line"><span style="color:#24292E;">SPARK_WORKER_WEBUI_PORT</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">8081</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">## è®¾ç½®å†å²æœåŠ¡å™¨</span></span>
<span class="line"><span style="color:#6A737D;"># é…ç½®çš„æ„æ€æ˜¯  å°† spark ç¨‹åºè¿è¡Œçš„å†å²æ—¥å¿— å­˜åˆ° hdfs çš„/sparklog æ–‡ä»¶å¤¹ä¸­</span></span>
<span class="line"><span style="color:#24292E;">SPARK_HISTORY_OPTS</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;-Dspark.history.fs.logDirectory=hdfs://node1:8020/sparklog/ -Dspark.history.fs.cleaner.enabled=true&quot;</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ³¨æ„, ä¸Šé¢çš„é…ç½®çš„è·¯å¾„ è¦æ ¹æ®ä½ è‡ªå·±æœºå™¨å®é™…çš„è·¯å¾„æ¥å†™</p><p>åœ¨ HDFS ä¸Šåˆ›å»ºç¨‹åºè¿è¡Œå†å²è®°å½•å­˜æ”¾çš„æ–‡ä»¶å¤¹:</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6F42C1;">hadoop</span><span style="color:#24292E;"> </span><span style="color:#032F62;">fs</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-mkdir</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/sparklog</span></span>
<span class="line"><span style="color:#6F42C1;">hadoop</span><span style="color:#24292E;"> </span><span style="color:#032F62;">fs</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-chmod</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">777</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/sparklog</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é…ç½® spark-defaults.conf æ–‡ä»¶</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># 1. æ”¹å</span></span>
<span class="line"><span style="color:#6F42C1;">mv</span><span style="color:#24292E;"> </span><span style="color:#032F62;">spark-defaults.conf.template</span><span style="color:#24292E;"> </span><span style="color:#032F62;">spark-defaults.conf</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 2. ä¿®æ”¹å†…å®¹, è¿½åŠ å¦‚ä¸‹å†…å®¹</span></span>
<span class="line"><span style="color:#6A737D;"># å¼€å¯ spark çš„æ—¥æœŸè®°å½•åŠŸèƒ½</span></span>
<span class="line"><span style="color:#6F42C1;">spark.eventLog.enabled</span><span style="color:#24292E;"> 	</span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#6A737D;"># è®¾ç½® spark æ—¥å¿—è®°å½•çš„è·¯å¾„</span></span>
<span class="line"><span style="color:#6F42C1;">spark.eventLog.dir</span><span style="color:#24292E;">	 </span><span style="color:#032F62;">hdfs://node1:8020/sparklog/</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#6A737D;"># è®¾ç½® spark æ—¥å¿—æ˜¯å¦å¯åŠ¨å‹ç¼©</span></span>
<span class="line"><span style="color:#6F42C1;">spark.eventLog.compress</span><span style="color:#24292E;"> 	</span><span style="color:#005CC5;">true</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é…ç½® log4j.properties æ–‡ä»¶ [å¯é€‰é…ç½®]</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># 1. æ”¹å</span></span>
<span class="line"><span style="color:#6F42C1;">mv</span><span style="color:#24292E;"> </span><span style="color:#032F62;">log4j.properties.template</span><span style="color:#24292E;"> </span><span style="color:#032F62;">log4j.properties</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 2. ä¿®æ”¹æ—¥å¿—è­¦æŠ¥çº§åˆ« å› ä¸º Spark æ˜¯ä¸ªè¯ç—¨</span></span>
<span class="line"><span style="color:#6F42C1;">log4j.rootCategory</span><span style="color:#24292E;">=WARN, </span><span style="color:#032F62;">console</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="å°†-spark-å®‰è£…æ–‡ä»¶å¤¹-åˆ†å‘åˆ°å…¶å®ƒçš„èŠ‚ç‚¹ä¸Š" tabindex="-1"><a class="header-anchor" href="#å°†-spark-å®‰è£…æ–‡ä»¶å¤¹-åˆ†å‘åˆ°å…¶å®ƒçš„èŠ‚ç‚¹ä¸Š" aria-hidden="true">#</a> å°† Spark å®‰è£…æ–‡ä»¶å¤¹ åˆ†å‘åˆ°å…¶å®ƒçš„èŠ‚ç‚¹ä¸Š</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6F42C1;">scp</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-r</span><span style="color:#24292E;"> </span><span style="color:#032F62;">spark-3.1.2-bin-hadoop3.2</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node2:/export/server/</span></span>
<span class="line"><span style="color:#6F42C1;">scp</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-r</span><span style="color:#24292E;"> </span><span style="color:#032F62;">spark-3.1.2-bin-hadoop3.2</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node3:/export/server/</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸è¦å¿˜è®°, åœ¨ node2 å’Œ node3 ä¸Š ç»™ spark å®‰è£…ç›®å½•å¢åŠ è½¯é“¾æ¥</p><p><code>ln -s /export/server/spark-3.1.2-bin-hadoop3.2 /export/server/spark</code></p><h3 id="éªŒè¯ç¯å¢ƒ" tabindex="-1"><a class="header-anchor" href="#éªŒè¯ç¯å¢ƒ" aria-hidden="true">#</a> éªŒè¯ç¯å¢ƒ</h3><p>å…ˆå¼€å¯ zoopkeeper <code>zookeeper/bin/zkServer.sh start</code>, hadoop <code>s</code>ç­‰ã€‚ å¯åŠ¨å†å²æœåŠ¡å™¨ <code>sbin/start-history-server.sh</code> å¯åŠ¨å…¨éƒ¨ workers å’Œ masterï¼š<code>sbin/start-all.sh</code></p><p>åˆ†åˆ«æµ‹è¯• <code>pyspark</code>, <code>spark-shell</code>, <code>spark-submit</code> ä½¿ç”¨æƒ…å†µï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6F42C1;">bin/pyspark</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--master</span><span style="color:#24292E;"> </span><span style="color:#032F62;">spark://node1:7077</span></span>
<span class="line"><span style="color:#6A737D;"># æä¾› --master è¿æ¥åˆ° StandAloneï¼Œä¸å†™é»˜è®¤æ˜¯ local æ¨¡å¼</span></span>
<span class="line"><span style="color:#6F42C1;">bin/spark-shell</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--master</span><span style="color:#24292E;"> </span><span style="color:#032F62;">spark://node1:7077</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">bin/spark-submit</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--master</span><span style="color:#24292E;"> </span><span style="color:#032F62;">spark://node1:7077</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/export/server/spark/examples/src/main/python/pi.py</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">100</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿è¡Œåé€šè¿‡ web <code>node1:18080</code> æŸ¥çœ‹å†å²æœåŠ¡å™¨ä¿¡æ¯ï¼›<code>node1:8080</code> æŸ¥çœ‹ masterã€‚</p><h2 id="spark-standalone-ha" tabindex="-1"><a class="header-anchor" href="#spark-standalone-ha" aria-hidden="true">#</a> Spark StandAlone HA</h2><p>Spark Standalone é›†ç¾¤æ˜¯ Master-Slaves æ¶æ„çš„é›†ç¾¤æ¨¡å¼ï¼Œå’Œå¤§éƒ¨åˆ†çš„ Master-Slaves ç»“æ„é›†ç¾¤ä¸€æ ·ï¼Œå­˜åœ¨ç€ Master å•ç‚¹æ•…éšœï¼ˆSPOFï¼‰çš„é—®é¢˜ã€‚ å¦‚ä½•è§£å†³è¿™ä¸ªå•ç‚¹æ•…éšœçš„é—®é¢˜ï¼ŒSpark æä¾›äº†ä¸¤ç§æ–¹æ¡ˆï¼š 1.åŸºäºæ–‡ä»¶ç³»ç»Ÿçš„å•ç‚¹æ¢å¤(Single-Node Recovery with Local File System)--åªèƒ½ç”¨äºå¼€å‘æˆ–æµ‹è¯•ç¯å¢ƒã€‚ 2.åŸºäº zookeeper çš„ Standby Masters(Standby Masters with ZooKeeper)--å¯ä»¥ç”¨äºç”Ÿäº§ç¯å¢ƒã€‚ ZooKeeper æä¾›äº†ä¸€ä¸ª Leader Election æœºåˆ¶ï¼Œåˆ©ç”¨è¿™ä¸ªæœºåˆ¶å¯ä»¥ä¿è¯è™½ç„¶é›†ç¾¤å­˜åœ¨å¤šä¸ª Masterï¼Œä½†æ˜¯åªæœ‰ä¸€ä¸ªæ˜¯ Active çš„ï¼Œå…¶ä»–çš„éƒ½æ˜¯ Standbyã€‚å½“ Active çš„ Master å‡ºç°æ•…éšœæ—¶ï¼Œå¦å¤–çš„ä¸€ä¸ª Standby Master ä¼šè¢«é€‰ä¸¾å‡ºæ¥ã€‚ç”±äºé›†ç¾¤çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬ Workerï¼ŒDriver å’Œ Application çš„ä¿¡æ¯éƒ½å·²ç»æŒä¹…åŒ–åˆ°æ–‡ä»¶ç³»ç»Ÿï¼Œå› æ­¤åœ¨åˆ‡æ¢çš„è¿‡ç¨‹ä¸­åªä¼šå½±å“æ–° Job çš„æäº¤ï¼Œå¯¹äºæ­£åœ¨è¿›è¡Œçš„ Job æ²¡æœ‰ä»»ä½•çš„å½±å“ã€‚åŠ å…¥ ZooKeeper çš„é›†ç¾¤æ•´ä½“æ¶æ„å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ toadd <a href="https://spark.apache.org/docs/3.1.2/spark-standalone.html#standby-masters-with-zookeeper" target="_blank" rel="noopener noreferrer">åŸºäº Zookeeper å®ç° HA<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h3 id="æ­¥éª¤" tabindex="-1"><a class="header-anchor" href="#æ­¥éª¤" aria-hidden="true">#</a> æ­¥éª¤</h3><p>å‰æ: ç¡®ä¿ Zookeeper å’Œ HDFS å‡å·²ç»å¯åŠ¨ åœ¨<code>spark-env.sh</code>ä¸­, åˆ é™¤: <code>SPARK_MASTER_HOST=node1</code> åœ¨<code>spark-env.sh</code>ä¸­, å¢åŠ :</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#24292E;">SPARK_DAEMON_JAVA_OPTS</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;-Dspark.deploy.recoveryMode=ZOOKEEPER -Dspark.deploy.zookeeper.url=node1:2181,node2:2181,node3:2181 -Dspark.deploy.zookeeper.dir=/spark-ha&quot;</span></span>
<span class="line"><span style="color:#6A737D;"># spark.deploy.recoveryMode æŒ‡å®š HA æ¨¡å¼ åŸºäº Zookeeper å®ç°</span></span>
<span class="line"><span style="color:#6A737D;"># æŒ‡å®š Zookeeper çš„è¿æ¥åœ°å€</span></span>
<span class="line"><span style="color:#6A737D;"># æŒ‡å®šåœ¨ Zookeeper ä¸­æ³¨å†Œä¸´æ—¶èŠ‚ç‚¹çš„è·¯å¾„</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><a href="http://xn--spark-env-kj5q.sh/" target="_blank" rel="noopener noreferrer">å°† spark-env.sh<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> åˆ†å‘åˆ°æ¯ä¸€å°æœåŠ¡å™¨ä¸Š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6F42C1;">scp</span><span style="color:#24292E;"> </span><span style="color:#032F62;">spark-env.sh</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node2:/export/server/spark/conf/</span></span>
<span class="line"><span style="color:#6F42C1;">scp</span><span style="color:#24292E;"> </span><span style="color:#032F62;">spark-env.sh</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node3:/export/server/spark/conf/</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>åœæ­¢å½“å‰ StandAlone é›†ç¾¤</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6F42C1;">sbin/stop-all.sh</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="master-ä¸»å¤‡åˆ‡æ¢" tabindex="-1"><a class="header-anchor" href="#master-ä¸»å¤‡åˆ‡æ¢" aria-hidden="true">#</a> master ä¸»å¤‡åˆ‡æ¢</h3><p>æäº¤ä¸€ä¸ª spark ä»»åŠ¡åˆ°å½“å‰<code>alive</code>master ä¸Š:</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6F42C1;">bin/spark-submit</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--master</span><span style="color:#24292E;"> </span><span style="color:#032F62;">spark://node1:7077</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/export/server/spark/examples/src/main/python/pi.py</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1000</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>åœ¨æäº¤æˆåŠŸå, å°† alivemaster ç›´æ¥ kill æ‰ï¼Œä¸ä¼šå½±å“ç¨‹åºè¿è¡Œ:<br><img src="https://pybd.yuque.com/api/filetransfer/images?url=https%3A%2F%2Fimage-set.oss-cn-zhangjiakou.aliyuncs.com%2Fimg-out%2F2021%2F09%2F08%2F20210908162555.png&amp;sign=6c267116ad788645fdc2af413af7ac1c6e22ae0d655afe3dd4fda1117f6d5253#from=url&amp;id=AAdNb&amp;margin=[object Object]&amp;originHeight=314&amp;originWidth=1889&amp;originalType=binary&amp;ratio=1&amp;status=done&amp;style=none" alt="" loading="lazy"><br> å½“æ–°çš„ master æ¥æ”¶é›†ç¾¤å, ç¨‹åºç»§ç»­è¿è¡Œ, æ­£å¸¸å¾—åˆ°ç»“æœã€‚åŒæ—¶æ–° master çš„ 8080 ç•Œé¢æ˜¾ç¤ºçŠ¶æ€ä» STANDBY å˜ä¸º RECOVERING/ ACTIVEã€‚</p><p>HA æ¨¡å¼ä¸‹, ä¸»å¤‡åˆ‡æ¢ ä¸ä¼šå½±å“åˆ°æ­£åœ¨è¿è¡Œçš„ç¨‹åº.</p><h2 id="spark-on-yarn-ç¯å¢ƒæ­å»º" tabindex="-1"><a class="header-anchor" href="#spark-on-yarn-ç¯å¢ƒæ­å»º" aria-hidden="true">#</a> Spark On YARN ç¯å¢ƒæ­å»º</h2><p>è®¸å¤šä¼ä¸šä¸ç®¡åšä»€ä¹ˆä¸šåŠ¡,éƒ½åŸºæœ¬ä¸Šä¼šæœ‰ Hadoop é›†ç¾¤. ä¹Ÿå°±æ˜¯ä¼šæœ‰ YARN é›†ç¾¤ã€‚å› æ­¤åœ¨æœ‰ YARN é›†ç¾¤çš„å‰æä¸‹å•ç‹¬å‡†å¤‡ Spark StandAlone é›†ç¾¤,å¯¹èµ„æºçš„åˆ©ç”¨å°±ä¸é«˜ã€‚ Spark on YARN æ˜¯æœ€å¸¸è§çš„åº”ç”¨æ¡†æ¶ã€‚ å¯¹äº Spark On YARN, æ— éœ€éƒ¨ç½² Spark é›†ç¾¤, åªè¦æ‰¾ä¸€å°æœåŠ¡å™¨, å……å½“ Spark çš„å®¢æˆ·ç«¯, å³å¯æäº¤ä»»åŠ¡åˆ° YARN é›†ç¾¤ä¸­è¿è¡Œã€‚</p><p><strong>æœ¬è´¨</strong></p><p>Master è§’è‰²ç”± YARN çš„ ResourceManager æ‹…ä»» Worker è§’è‰²ç”± YARN çš„ NodeManager æ‹…ä»» Driver è§’è‰²è¿è¡Œåœ¨ YARN å®¹å™¨å†…æˆ–æäº¤ä»»åŠ¡çš„å®¢æˆ·ç«¯è¿›ç¨‹ä¸­ çœŸæ­£å¹²æ´»çš„ Executor è¿è¡Œåœ¨ YARN æä¾›çš„å®¹å™¨å†…</p><p><strong>éƒ¨ç½²</strong></p><p>é…ç½® spark-env.sh ä¸­çš„ HADOOP_CONF_DIRã€ YARN_CONF_DIR ç¯å¢ƒå˜é‡ï¼ŒæŒ‡å‘ hadoop ä¸ yarn çš„é…ç½®æ–‡ä»¶ç›®å½•</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#24292E;">HADOOP_CONF_DIR</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">/export/server/hadoop/etc/hadoop/</span></span>
<span class="line"><span style="color:#24292E;">YARN_CONF_DIR</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">/export/server/hadoop/etc/hadoop/</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><a href="https://www.cnblogs.com/rmxd/p/12273395.html" target="_blank" rel="noopener noreferrer">å‚è€ƒé“¾æ¥ - è¿æ¥åˆ° YARN ä¸­<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></div><!----><footer class="page-meta"><!----><div class="meta-item git-info"><div class="update-time"><span class="label">ä¸Šæ¬¡ç¼–è¾‘äº: </span><!----></div><div class="contributors"><span class="label">è´¡çŒ®è€…: </span><!--[--><!--[--><span class="contributor" title="email: 417333277@qq.com">kevinng77</span><!--]--><!--]--></div></div></footer><!----><!----><!----><!--]--></main><!--]--><footer class="vp-footer-wrapper"><div class="vp-footer"><a href="https://beian.miit.gov.cn/" target="_blank">æ²ªICPå¤‡2023027904å·-1</a>&nbsp;<a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=" target="_blank"><img src="/assets/gongan.png">å…¬å®‰å¤‡æ¡ˆå· </a></div><div class="vp-copyright">Copyright Â© 2024 Kevin å´å˜‰æ–‡</div></footer></div><!--]--><!--]--><!----><!--]--></div>
    <script type="module" src="/assets/app-86c9497f.js" defer></script>
  </body>
</html>
