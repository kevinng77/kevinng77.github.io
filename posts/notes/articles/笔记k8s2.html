<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.61" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="http://wujiawen.xyz/posts/notes/articles/%E7%AC%94%E8%AE%B0k8s2.html"><meta property="og:site_name" content="è®°å¿†ç¬”ä¹¦"><meta property="og:title" content="Kubernetes è¯¦ç»†æ•™ç¨‹(ä¸‹)"><meta property="og:description" content="ä»¥ä¸‹ç¬”è®°æ¥è‡ªäºç¬”è®° Kubernetes(K8S) å…¥é—¨è¿›é˜¶å®æˆ˜å®Œæ•´æ•™ç¨‹ï¼Œé»‘é©¬ç¨‹åºå‘˜ K8S å…¨å¥—æ•™ç¨‹ é™¤äº† é»‘é©¬çš„ç¬”è®°ï¼Œå¯ä»¥å‚è€ƒ kuboard çš„å¯è§†åŒ–ç•Œé¢ + kubectl è¿›è¡Œ k8s åŠŸèƒ½å¤ä¹ ã€‚kuboard link"><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2023-03-26T07:48:04.000Z"><meta property="article:author" content="Kevin å´å˜‰æ–‡"><meta property="article:tag" content="Linux"><meta property="article:published_time" content="2022-12-26T00:00:00.000Z"><meta property="article:modified_time" content="2023-03-26T07:48:04.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"Kubernetes è¯¦ç»†æ•™ç¨‹(ä¸‹)","image":[""],"datePublished":"2022-12-26T00:00:00.000Z","dateModified":"2023-03-26T07:48:04.000Z","author":[{"@type":"Person","name":"Kevin å´å˜‰æ–‡"}]}</script><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin=""><link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;500;700&display=swap" rel="stylesheet"><link rel="icon" href="/logo.svg"><title>Kubernetes è¯¦ç»†æ•™ç¨‹(ä¸‹) | è®°å¿†ç¬”ä¹¦</title><meta name="description" content="ä»¥ä¸‹ç¬”è®°æ¥è‡ªäºç¬”è®° Kubernetes(K8S) å…¥é—¨è¿›é˜¶å®æˆ˜å®Œæ•´æ•™ç¨‹ï¼Œé»‘é©¬ç¨‹åºå‘˜ K8S å…¨å¥—æ•™ç¨‹ é™¤äº† é»‘é©¬çš„ç¬”è®°ï¼Œå¯ä»¥å‚è€ƒ kuboard çš„å¯è§†åŒ–ç•Œé¢ + kubectl è¿›è¡Œ k8s åŠŸèƒ½å¤ä¹ ã€‚kuboard link">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d1e1f;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/assets/style-f0172e8a.css" as="style"><link rel="stylesheet" href="/assets/style-f0172e8a.css">
    <link rel="modulepreload" href="/assets/app-0e28a919.js"><link rel="modulepreload" href="/assets/framework-d5c0d2cb.js"><link rel="modulepreload" href="/assets/ç¬”è®°k8s2.html-0cd8e1c7.js"><link rel="modulepreload" href="/assets/ç¬”è®°k8s2.html-04058343.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">è·³è‡³ä¸»è¦å…§å®¹</a><!--]--><!--[--><div class="theme-container no-sidebar has-toc"><!--[--><header class="navbar" id="navbar"><div class="navbar-start"><button type="button" class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><a href="/" class="brand"><!----><!----><span class="site-name">è®°å¿†ç¬”ä¹¦</span></a><!--[--><!----><!--]--></div><div class="navbar-center"><!--[--><!----><!--]--><nav class="nav-links"><div class="nav-item hide-in-mobile"><a href="/" class="nav-link" aria-label="ä¸»é¡µ"><span class="font-icon icon iconfont icon-home" style=""></span>ä¸»é¡µ<!----></a></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="åšæ–‡"><span class="title"><span class="font-icon icon iconfont icon-blog" style=""></span>åšæ–‡</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/posts/notes/" class="nav-link active" aria-label="çŸ¥è¯†ç¬”è®°"><span class="font-icon icon iconfont icon-note" style=""></span>çŸ¥è¯†ç¬”è®°<!----></a></li><li class="dropdown-item"><a href="/posts/hometown/" class="nav-link" aria-label="æ³‰å·å¿†å¾€æ˜”"><span class="font-icon icon iconfont icon-like" style=""></span>æ³‰å·å¿†å¾€æ˜”<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><a href="/timeline/" class="nav-link" aria-label="å½’æ¡£"><span class="font-icon icon iconfont icon-categoryselected" style=""></span>å½’æ¡£<!----></a></div></nav><!--[--><!----><!--]--></div><div class="navbar-end"><!--[--><!----><!--]--><!----><div class="nav-item"><a class="repo-link" href="https://github.com/kevinng77" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><!----><!--[--><button type="button" class="search-pro-button" role="search" aria-label="æœç´¢"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="placeholder">æœç´¢</div><div class="key-hints"><kbd class="key">Ctrl</kbd><kbd class="key">K</kbd></div></button><!--]--><!--[--><!----><!--]--><button type="button" class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside class="sidebar" id="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!--[--><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><!---->Kubernetes è¯¦ç»†æ•™ç¨‹(ä¸‹)</h1><div class="page-info"><span class="page-author-info" aria-label="ä½œè€…ğŸ–Š" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><span class="page-author-item">Kevin å´å˜‰æ–‡</span></span><span property="author" content="Kevin å´å˜‰æ–‡"></span></span><!----><span class="page-date-info" aria-label="å†™ä½œæ—¥æœŸğŸ“…" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2022-12-26T00:00:00.000Z"></span><!----><span class="page-reading-time-info" aria-label="é˜…è¯»æ—¶é—´âŒ›" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>å¤§çº¦ 63 åˆ†é’Ÿ</span><meta property="timeRequired" content="PT63M"></span><span class="page-category-info" aria-label="åˆ†ç±»ğŸŒˆ" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><span class="page-category-item category7 clickable" role="navigation">çŸ¥è¯†ç¬”è®°</span><meta property="articleSection" content="çŸ¥è¯†ç¬”è®°"></span><span class="page-tag-info" aria-label="æ ‡ç­¾ğŸ·" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><span class="page-tag-item tag0 clickable" role="navigation">Linux</span><meta property="keywords" content="Linux"></span></div><hr></div><div class="toc-place-holder"><aside id="toc"><!--[--><!----><!--]--><div class="toc-header">æ­¤é¡µå†…å®¹<!----></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/posts/notes/articles/%E7%AC%94%E8%AE%B0k8s2.html#_6-pod-æ§åˆ¶å™¨è¯¦è§£" class="router-link-active router-link-exact-active toc-link level2">6. Pod æ§åˆ¶å™¨è¯¦è§£</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/posts/notes/articles/%E7%AC%94%E8%AE%B0k8s2.html#_6-1-pod-æ§åˆ¶å™¨ä»‹ç»" class="router-link-active router-link-exact-active toc-link level3">6.1 Pod æ§åˆ¶å™¨ä»‹ç»</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/notes/articles/%E7%AC%94%E8%AE%B0k8s2.html#_6-2-replicaset-rs" class="router-link-active router-link-exact-active toc-link level3">6.2 ReplicaSet(RS)</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/notes/articles/%E7%AC%94%E8%AE%B0k8s2.html#_6-3-deployment-deploy" class="router-link-active router-link-exact-active toc-link level3">6.3 Deployment(Deploy)</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/notes/articles/%E7%AC%94%E8%AE%B0k8s2.html#_6-4-horizontal-pod-autoscaler-hpa" class="router-link-active router-link-exact-active toc-link level3">6.4 Horizontal Pod Autoscaler(HPA)</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/notes/articles/%E7%AC%94%E8%AE%B0k8s2.html#_6-5-daemonset-ds" class="router-link-active router-link-exact-active toc-link level3">6.5 DaemonSet(DS)</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/notes/articles/%E7%AC%94%E8%AE%B0k8s2.html#_6-6-job" class="router-link-active router-link-exact-active toc-link level3">6.6 Job</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/notes/articles/%E7%AC%94%E8%AE%B0k8s2.html#_6-7-cronjob-cj" class="router-link-active router-link-exact-active toc-link level3">6.7 CronJob(CJ)</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/notes/articles/%E7%AC%94%E8%AE%B0k8s2.html#_7-service-è¯¦è§£" class="router-link-active router-link-exact-active toc-link level2">7. Service è¯¦è§£</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/posts/notes/articles/%E7%AC%94%E8%AE%B0k8s2.html#_7-1-service-ä»‹ç»" class="router-link-active router-link-exact-active toc-link level3">7.1 Service ä»‹ç»</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/notes/articles/%E7%AC%94%E8%AE%B0k8s2.html#_7-2-service-ç±»å‹" class="router-link-active router-link-exact-active toc-link level3">7.2 Service ç±»å‹</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/notes/articles/%E7%AC%94%E8%AE%B0k8s2.html#_7-3-service-ä½¿ç”¨" class="router-link-active router-link-exact-active toc-link level3">7.3 Service ä½¿ç”¨</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/notes/articles/%E7%AC%94%E8%AE%B0k8s2.html#_7-4-ingress-ä»‹ç»" class="router-link-active router-link-exact-active toc-link level3">7.4 Ingress ä»‹ç»</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/notes/articles/%E7%AC%94%E8%AE%B0k8s2.html#_7-5-ingress-ä½¿ç”¨" class="router-link-active router-link-exact-active toc-link level3">7.5 Ingress ä½¿ç”¨</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/notes/articles/%E7%AC%94%E8%AE%B0k8s2.html#_8-æ•°æ®å­˜å‚¨" class="router-link-active router-link-exact-active toc-link level2">8. æ•°æ®å­˜å‚¨</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/posts/notes/articles/%E7%AC%94%E8%AE%B0k8s2.html#_8-1-åŸºæœ¬å­˜å‚¨" class="router-link-active router-link-exact-active toc-link level3">8.1 åŸºæœ¬å­˜å‚¨</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/notes/articles/%E7%AC%94%E8%AE%B0k8s2.html#_8-2-é«˜çº§å­˜å‚¨" class="router-link-active router-link-exact-active toc-link level3">8.2 é«˜çº§å­˜å‚¨</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/notes/articles/%E7%AC%94%E8%AE%B0k8s2.html#_8-3-é…ç½®å­˜å‚¨" class="router-link-active router-link-exact-active toc-link level3">8.3 é…ç½®å­˜å‚¨</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/notes/articles/%E7%AC%94%E8%AE%B0k8s2.html#_9-å®‰å…¨è®¤è¯" class="router-link-active router-link-exact-active toc-link level2">9. å®‰å…¨è®¤è¯</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/posts/notes/articles/%E7%AC%94%E8%AE%B0k8s2.html#_9-1-è®¿é—®æ§åˆ¶æ¦‚è¿°" class="router-link-active router-link-exact-active toc-link level3">9.1 è®¿é—®æ§åˆ¶æ¦‚è¿°</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/notes/articles/%E7%AC%94%E8%AE%B0k8s2.html#_9-2-è®¤è¯ç®¡ç†" class="router-link-active router-link-exact-active toc-link level3">9.2 è®¤è¯ç®¡ç†</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/notes/articles/%E7%AC%94%E8%AE%B0k8s2.html#_9-3-æˆæƒç®¡ç†" class="router-link-active router-link-exact-active toc-link level3">9.3 æˆæƒç®¡ç†</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/notes/articles/%E7%AC%94%E8%AE%B0k8s2.html#_9-4-å‡†å…¥æ§åˆ¶" class="router-link-active router-link-exact-active toc-link level3">9.4 å‡†å…¥æ§åˆ¶</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/notes/articles/%E7%AC%94%E8%AE%B0k8s2.html#_10-dashboard" class="router-link-active router-link-exact-active toc-link level2">10. DashBoard</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/posts/notes/articles/%E7%AC%94%E8%AE%B0k8s2.html#_10-1-éƒ¨ç½²-dashboard" class="router-link-active router-link-exact-active toc-link level3">10.1 éƒ¨ç½² Dashboard</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/notes/articles/%E7%AC%94%E8%AE%B0k8s2.html#_10-2-ä½¿ç”¨-dashboard" class="router-link-active router-link-exact-active toc-link level3">10.2 ä½¿ç”¨ DashBoard</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/notes/articles/%E7%AC%94%E8%AE%B0k8s2.html#_10-3-å…¶ä»–-ui-kuboard" class="router-link-active router-link-exact-active toc-link level3">10.3 å…¶ä»– UIï¼škuboard</a></li><!----><!--]--></ul><!--]--></ul></div><!--[--><!----><!--]--></aside></div><!----><div class="theme-hope-content"><p>ä»¥ä¸‹ç¬”è®°æ¥è‡ªäºç¬”è®° <a href="https://www.bilibili.com/video/BV1Qv41167ck/?p=39&amp;spm_id_from=pageDriver&amp;vd_source=4418d5cd5be787be7e3ff4138eeb9b0a" target="_blank" rel="noopener noreferrer">Kubernetes(K8S) å…¥é—¨è¿›é˜¶å®æˆ˜å®Œæ•´æ•™ç¨‹ï¼Œé»‘é©¬ç¨‹åºå‘˜ K8S å…¨å¥—æ•™ç¨‹<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>é™¤äº† é»‘é©¬çš„ç¬”è®°ï¼Œå¯ä»¥å‚è€ƒ kuboard çš„å¯è§†åŒ–ç•Œé¢ + kubectl è¿›è¡Œ k8s åŠŸèƒ½å¤ä¹ ã€‚<a href="https://kuboard.cn/install/v3/install-built-in.html#%E9%83%A8%E7%BD%B2%E8%AE%A1%E5%88%92" target="_blank" rel="noopener noreferrer">kuboard link<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><ol><li><p>æ¦‚è¿°</p></li><li><p>é›†ç¾¤æ­å»º</p></li><li><p>èµ„æºç®¡ç†æ–¹å¼ï¼šé€šè¿‡ yaml æ–‡ä»¶é…ç½® K8S</p></li><li><p>åŸºç¡€æ¶æ„ï¼šNamespaceï¼ŒPodï¼ŒLabelï¼ŒDeploymentï¼ŒService</p></li><li><p>Pod è¯¦è§£ï¼šPod é…ç½®æ–‡ä»¶ï¼ˆç¯å¢ƒå˜é‡ï¼Œç«¯å£ï¼Œèµ„æºé™åˆ¶ç­‰ï¼‰ï¼ŒPod è°ƒåº¦ï¼ˆå®šå‘è°ƒåº¦ï¼Œäº²å’Œæ€§è°ƒåº¦ç­‰ï¼‰</p></li><li><p>Pod æ§åˆ¶å™¨ï¼šReplicaSet, Deployment, é‡‘ä¸é›€å‘å¸ƒ, HPA, DaemonSet, Job, CronJob</p><ol><li>æ‰©ç¼©å®¹ Podï¼ŒPod ç‰ˆæœ¬æ§åˆ¶ï¼Œ Pod ä¸­é•œåƒå‡çº§ï¼Œæ ¹æ®ç³»ç»Ÿè´Ÿè½½è‡ªåŠ¨æ‰©ç¼©ç­‰</li></ol></li><li><p>Serviceï¼šå®ç°æœåŠ¡ç«¯å£åˆ°å¤–éƒ¨è®¿é—®ç«¯å£çš„ä»£ç†/æ˜ å°„ <a href="https://zhuanlan.zhihu.com/p/526042184" target="_blank" rel="noopener noreferrer">K8s ç½‘å…³é€‰å‹åˆåˆ¤ï¼šNginx è¿˜æ˜¯ Envoyï¼Ÿ<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><ol><li>ClusterIPï¼šNodePortï¼šLoadBalancerï¼šExternalNameï¼š</li><li>Ingressï¼šé€šè¿‡ä¸€ä¸ª NodePort æˆ–è€…ä¸€ä¸ª LB å®ç°æš´éœ²å¤šä¸ªæœåŠ¡ï¼Œæ•ˆæœç›¸å½“äºåå‘ä»£ç†ã€‚ <ol><li>åœ¨ Ingress ä¸­é…ç½®ï¼Œ <code>host + path</code> ä»£ç†åˆ° <code>targetservice+port</code> çš„è§„åˆ™ã€‚path ç›¸å½“äº nginx çš„ locationï¼Œtargetsecice ç›¸å½“äº upstreamï¼Œservice å¯¹åº”åˆ°çš„ pods ç›¸å½“äº upstream ä¸­çš„ IP åœ°å€ã€‚ä¸åŒçš„æ˜¯ ingress ä¸­å¯ä»¥ä½¿ç”¨ tag è¿›è¡ŒæœåŠ¡é”å®šã€‚</li></ol></li></ol></li><li><p>æ•°æ®å­˜å‚¨:</p><ol><li>å¯ä½¿ç”¨ NFS ç­‰å®ç°å¤šä¸ª pod ä¹‹é—´å…±äº«æ•°æ®ï¼Œå¹¶ä¸”å‚¨å­˜åœ¨å¤–éƒ¨ç­‰ã€‚å¯¹äºå¤æ‚ç®¡ç†æƒ…å†µï¼Œè€ƒè™‘ pv,pvc ç­‰æ–¹æ¡ˆã€‚</li></ol></li></ol><h2 id="_6-pod-æ§åˆ¶å™¨è¯¦è§£" tabindex="-1"><a class="header-anchor" href="#_6-pod-æ§åˆ¶å™¨è¯¦è§£" aria-hidden="true">#</a> 6. Pod æ§åˆ¶å™¨è¯¦è§£</h2><h3 id="_6-1-pod-æ§åˆ¶å™¨ä»‹ç»" tabindex="-1"><a class="header-anchor" href="#_6-1-pod-æ§åˆ¶å™¨ä»‹ç»" aria-hidden="true">#</a> 6.1 Pod æ§åˆ¶å™¨ä»‹ç»</h3><p>Pod æ˜¯ kubernetes çš„æœ€å°ç®¡ç†å•å…ƒï¼Œåœ¨ kubernetes ä¸­ï¼ŒæŒ‰ç…§ pod çš„åˆ›å»ºæ–¹å¼å¯ä»¥å°†å…¶åˆ†ä¸ºä¸¤ç±»ï¼š</p><ul><li><strong>è‡ªä¸»å¼ podï¼š</strong> kubernetes ç›´æ¥åˆ›å»ºå‡ºæ¥çš„ Podï¼Œè¿™ç§ pod åˆ é™¤åå°±æ²¡æœ‰äº†ï¼Œä¹Ÿä¸ä¼šé‡å»º</li><li><strong>æ§åˆ¶å™¨åˆ›å»ºçš„ podï¼š</strong> kubernetes é€šè¿‡æ§åˆ¶å™¨åˆ›å»ºçš„ podï¼Œè¿™ç§ pod åˆ é™¤äº†ä¹‹åè¿˜ä¼šè‡ªåŠ¨é‡å»º</li></ul><blockquote><p><strong><code>ä»€ä¹ˆæ˜¯ Pod æ§åˆ¶å™¨</code></strong></p><p>Pod æ§åˆ¶å™¨æ˜¯ç®¡ç† pod çš„ä¸­é—´å±‚ï¼Œä½¿ç”¨ Pod æ§åˆ¶å™¨ä¹‹åï¼Œåªéœ€è¦å‘Šè¯‰ Pod æ§åˆ¶å™¨ï¼Œæƒ³è¦å¤šå°‘ä¸ªä»€ä¹ˆæ ·çš„ Pod å°±å¯ä»¥äº†ï¼Œå®ƒä¼šåˆ›å»ºå‡ºæ»¡è¶³æ¡ä»¶çš„ Pod å¹¶ç¡®ä¿æ¯ä¸€ä¸ª Pod èµ„æºå¤„äºç”¨æˆ·æœŸæœ›çš„ç›®æ ‡çŠ¶æ€ã€‚å¦‚æœ Pod èµ„æºåœ¨è¿è¡Œä¸­å‡ºç°æ•…éšœï¼Œå®ƒä¼šåŸºäºæŒ‡å®šç­–ç•¥é‡æ–°ç¼–æ’ Podã€‚</p></blockquote><p>åœ¨ kubernetes ä¸­ï¼Œæœ‰å¾ˆå¤šç±»å‹çš„ pod æ§åˆ¶å™¨ï¼Œæ¯ç§éƒ½æœ‰è‡ªå·±çš„é€‚åˆçš„åœºæ™¯ï¼Œå¸¸è§çš„æœ‰ä¸‹é¢è¿™äº›ï¼š</p><ul><li>ReplicationControllerï¼šæ¯”è¾ƒåŸå§‹çš„ pod æ§åˆ¶å™¨ï¼Œå·²ç»è¢«åºŸå¼ƒï¼Œç”± ReplicaSet æ›¿ä»£</li><li>ReplicaSetï¼šä¿è¯å‰¯æœ¬æ•°é‡ä¸€ç›´ç»´æŒåœ¨æœŸæœ›å€¼ï¼Œå¹¶æ”¯æŒ pod æ•°é‡æ‰©ç¼©å®¹ï¼Œé•œåƒç‰ˆæœ¬å‡çº§</li><li><strong>Deploymentï¼š</strong> é€šè¿‡æ§åˆ¶ ReplicaSet æ¥æ§åˆ¶ Podï¼Œå¹¶æ”¯æŒæ»šåŠ¨å‡çº§ã€å›é€€ç‰ˆæœ¬</li><li><strong>Horizontal Pod Autoscalerï¼š</strong> å¯ä»¥æ ¹æ®é›†ç¾¤è´Ÿè½½è‡ªåŠ¨æ°´å¹³è°ƒæ•´ Pod çš„æ•°é‡ï¼Œå®ç°å‰Šå³°å¡«è°·</li><li><strong>DaemonSetï¼š</strong> åœ¨é›†ç¾¤ä¸­çš„æŒ‡å®š Node ä¸Šè¿è¡Œä¸”ä»…è¿è¡Œä¸€ä¸ªå‰¯æœ¬ï¼Œä¸€èˆ¬ç”¨äºå®ˆæŠ¤è¿›ç¨‹ç±»çš„ä»»åŠ¡</li><li>Jobï¼šå®ƒåˆ›å»ºå‡ºæ¥çš„ pod åªè¦å®Œæˆä»»åŠ¡å°±ç«‹å³é€€å‡ºï¼Œä¸éœ€è¦é‡å¯æˆ–é‡å»ºï¼Œç”¨äºæ‰§è¡Œä¸€æ¬¡æ€§ä»»åŠ¡</li><li><strong>Cronjobï¼š</strong> å®ƒåˆ›å»ºçš„ Pod è´Ÿè´£å‘¨æœŸæ€§ä»»åŠ¡æ§åˆ¶ï¼Œä¸éœ€è¦æŒç»­åå°è¿è¡Œ</li><li>StatefulSetï¼šç®¡ç†æœ‰çŠ¶æ€åº”ç”¨</li></ul><h3 id="_6-2-replicaset-rs" tabindex="-1"><a class="header-anchor" href="#_6-2-replicaset-rs" aria-hidden="true">#</a> 6.2 ReplicaSet(RS)</h3><p>ReplicaSet çš„ä¸»è¦ä½œç”¨æ˜¯ <strong>ä¿è¯ä¸€å®šæ•°é‡çš„ pod æ­£å¸¸è¿è¡Œ</strong> ï¼Œå®ƒä¼šæŒç»­ç›‘å¬è¿™äº› Pod çš„è¿è¡ŒçŠ¶æ€ï¼Œä¸€æ—¦ Pod å‘ç”Ÿæ•…éšœï¼Œå°±ä¼šé‡å¯æˆ–é‡å»ºã€‚åŒæ—¶å®ƒè¿˜æ”¯æŒå¯¹ pod æ•°é‡çš„æ‰©ç¼©å®¹å’Œé•œåƒç‰ˆæœ¬çš„å‡é™çº§ã€‚</p><figure><img src="/assets/img/k8s/image-20200612005334159.png" alt="ç›¸å…³å›¾ç‰‡" tabindex="0" loading="lazy"><figcaption>ç›¸å…³å›¾ç‰‡</figcaption></figure><p>ReplicaSet çš„èµ„æºæ¸…å•æ–‡ä»¶ï¼š</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1 <span class="token comment"># ç‰ˆæœ¬å·</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ReplicaSet <span class="token comment"># ç±»å‹       </span>
<span class="token key atrule">metadata</span><span class="token punctuation">:</span> <span class="token comment"># å…ƒæ•°æ®</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token comment"># rs åç§° </span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> <span class="token comment"># æ‰€å±å‘½åç©ºé—´ </span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span> <span class="token comment">#æ ‡ç­¾</span>
    <span class="token key atrule">controller</span><span class="token punctuation">:</span> rs
<span class="token key atrule">spec</span><span class="token punctuation">:</span> <span class="token comment"># è¯¦æƒ…æè¿°</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span> <span class="token comment"># å‰¯æœ¬æ•°é‡</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span> <span class="token comment"># é€‰æ‹©å™¨ï¼Œé€šè¿‡å®ƒæŒ‡å®šè¯¥æ§åˆ¶å™¨ç®¡ç†å“ªäº› pod</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token comment"># Labels åŒ¹é…è§„åˆ™</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
    <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span> <span class="token comment"># Expressions åŒ¹é…è§„åˆ™</span>
      <span class="token punctuation">-</span> <span class="token punctuation">{</span><span class="token key atrule">key</span><span class="token punctuation">:</span> app<span class="token punctuation">,</span> <span class="token key atrule">operator</span><span class="token punctuation">:</span> In<span class="token punctuation">,</span> <span class="token key atrule">values</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>nginx<span class="token punctuation">-</span>pod<span class="token punctuation">]</span><span class="token punctuation">}</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span> <span class="token comment"># æ¨¡æ¿ï¼Œå½“å‰¯æœ¬æ•°é‡ä¸è¶³æ—¶ï¼Œä¼šæ ¹æ®ä¸‹é¢çš„æ¨¡æ¿åˆ›å»º pod å‰¯æœ¬</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™é‡Œé¢ï¼Œéœ€è¦æ–°äº†è§£çš„é…ç½®é¡¹å°±æ˜¯<code>spec</code>ä¸‹é¢å‡ ä¸ªé€‰é¡¹ï¼š</p><ul><li><p>replicasï¼šæŒ‡å®šå‰¯æœ¬æ•°é‡ï¼Œå…¶å®å°±æ˜¯å½“å‰ rs åˆ›å»ºå‡ºæ¥çš„ pod çš„æ•°é‡ï¼Œé»˜è®¤ä¸º 1</p></li><li><p>selectorï¼šé€‰æ‹©å™¨ï¼Œå®ƒçš„ä½œç”¨æ˜¯å»ºç«‹ pod æ§åˆ¶å™¨å’Œ pod ä¹‹é—´çš„å…³è”å…³ç³»ï¼Œé‡‡ç”¨çš„ Label Selector æœºåˆ¶</p><p>åœ¨ pod æ¨¡æ¿ä¸Šå®šä¹‰ labelï¼Œåœ¨æ§åˆ¶å™¨ä¸Šå®šä¹‰é€‰æ‹©å™¨ï¼Œå°±å¯ä»¥è¡¨æ˜å½“å‰æ§åˆ¶å™¨èƒ½ç®¡ç†å“ªäº› pod äº†</p></li><li><p>templateï¼šæ¨¡æ¿ï¼Œå°±æ˜¯å½“å‰æ§åˆ¶å™¨åˆ›å»º pod æ‰€ä½¿ç”¨çš„æ¨¡æ¿æ¿ï¼Œé‡Œé¢å…¶å®å°±æ˜¯å‰ä¸€ç« å­¦è¿‡çš„ pod çš„å®šä¹‰</p></li></ul><h4 id="åˆ›å»º-replicaset" tabindex="-1"><a class="header-anchor" href="#åˆ›å»º-replicaset" aria-hidden="true">#</a> <strong>åˆ›å»º ReplicaSet</strong></h4><p>åˆ›å»º pc-replicaset.yaml æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ReplicaSet   
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pc<span class="token punctuation">-</span>replicaset
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span> 
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># åˆ›å»º rs</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pc-replicaset.yaml</span>
replicaset.apps/pc-replicaset created

<span class="token comment"># æŸ¥çœ‹ rs</span>
<span class="token comment"># DESIRED:æœŸæœ›å‰¯æœ¬æ•°é‡  </span>
<span class="token comment"># CURRENT:å½“å‰å‰¯æœ¬æ•°é‡  </span>
<span class="token comment"># READY:å·²ç»å‡†å¤‡å¥½æä¾›æœåŠ¡çš„å‰¯æœ¬æ•°é‡</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get rs pc-replicaset -n dev -o wide</span>
NAME          DESIRED   CURRENT READY AGE   CONTAINERS   IMAGES             SELECTOR
pc-replicaset <span class="token number">3</span>         <span class="token number">3</span>       <span class="token number">3</span>     22s   nginx        nginx:1.17.1       <span class="token assign-left variable">app</span><span class="token operator">=</span>nginx-pod

<span class="token comment"># æŸ¥çœ‹å½“å‰æ§åˆ¶å™¨åˆ›å»ºå‡ºæ¥çš„ pod</span>
<span class="token comment"># è¿™é‡Œå‘ç°æ§åˆ¶å™¨åˆ›å»ºå‡ºæ¥çš„ pod çš„åç§°æ˜¯åœ¨æ§åˆ¶å™¨åç§°åé¢æ‹¼æ¥äº†-xxxxx éšæœºç </span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod -n dev</span>
NAME                          READY   STATUS    RESTARTS   AGE
pc-replicaset-6vmvt   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          54s
pc-replicaset-fmb8f   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          54s
pc-replicaset-snrk2   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          54s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="æ‰©ç¼©å®¹" tabindex="-1"><a class="header-anchor" href="#æ‰©ç¼©å®¹" aria-hidden="true">#</a> <strong>æ‰©ç¼©å®¹</strong></h4><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># ç¼–è¾‘ rs çš„å‰¯æœ¬æ•°é‡ï¼Œä¿®æ”¹ spec:replicas: 6 å³å¯</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl edit rs pc-replicaset -n dev</span>
replicaset.apps/pc-replicaset edited

<span class="token comment"># æŸ¥çœ‹ pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev</span>
NAME                          READY   STATUS    RESTARTS   AGE
pc-replicaset-6vmvt   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          114m
pc-replicaset-cftnp   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          10s
pc-replicaset-fjlm6   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          10s
pc-replicaset-fmb8f   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          114m
pc-replicaset-s2whj   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          10s
pc-replicaset-snrk2   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          114m

<span class="token comment"># å½“ç„¶ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨å‘½ä»¤å®ç°</span>
<span class="token comment"># ä½¿ç”¨ scale å‘½ä»¤å®ç°æ‰©ç¼©å®¹ï¼Œ åé¢--replicas=n ç›´æ¥æŒ‡å®šç›®æ ‡æ•°é‡å³å¯</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl scale rs pc-replicaset --replicas=2 -n dev</span>
replicaset.apps/pc-replicaset scaled

<span class="token comment"># å‘½ä»¤è¿è¡Œå®Œæ¯•ï¼Œç«‹å³æŸ¥çœ‹ï¼Œå‘ç°å·²ç»æœ‰ 4 ä¸ªå¼€å§‹å‡†å¤‡é€€å‡ºäº†</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev</span>
NAME                       READY   STATUS        RESTARTS   AGE
pc-replicaset-6vmvt   <span class="token number">0</span>/1     Terminating   <span class="token number">0</span>          118m
pc-replicaset-cftnp   <span class="token number">0</span>/1     Terminating   <span class="token number">0</span>          4m17s
pc-replicaset-fjlm6   <span class="token number">0</span>/1     Terminating   <span class="token number">0</span>          4m17s
pc-replicaset-fmb8f   <span class="token number">1</span>/1     Running       <span class="token number">0</span>          118m
pc-replicaset-s2whj   <span class="token number">0</span>/1     Terminating   <span class="token number">0</span>          4m17s
pc-replicaset-snrk2   <span class="token number">1</span>/1     Running       <span class="token number">0</span>          118m

<span class="token comment">#ç¨ç­‰ç‰‡åˆ»ï¼Œå°±åªå‰©ä¸‹ 2 ä¸ªäº†</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev</span>
NAME                       READY   STATUS    RESTARTS   AGE
pc-replicaset-fmb8f   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          119m
pc-replicaset-snrk2   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          119m
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="é•œåƒå‡çº§" tabindex="-1"><a class="header-anchor" href="#é•œåƒå‡çº§" aria-hidden="true">#</a> <strong>é•œåƒå‡çº§</strong></h4><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># ç¼–è¾‘ rs çš„å®¹å™¨é•œåƒ - image: nginx:1.17.2</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl edit rs pc-replicaset -n dev</span>
replicaset.apps/pc-replicaset edited

<span class="token comment"># å†æ¬¡æŸ¥çœ‹ï¼Œå‘ç°é•œåƒç‰ˆæœ¬å·²ç»å˜æ›´äº†</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get rs -n dev -o wide</span>
NAME                DESIRED  CURRENT   READY   AGE    CONTAINERS   IMAGES        <span class="token punctuation">..</span>.
pc-replicaset       <span class="token number">2</span>        <span class="token number">2</span>         <span class="token number">2</span>       140m   nginx         nginx:1.17.2  <span class="token punctuation">..</span>.

<span class="token comment"># åŒæ ·çš„é“ç†ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å‘½ä»¤å®Œæˆè¿™ä¸ªå·¥ä½œ</span>
<span class="token comment"># kubectl set image rs rs åç§° å®¹å™¨=é•œåƒç‰ˆæœ¬ -n namespace</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl set image rs pc-replicaset nginx=nginx:1.17.1  -n dev</span>
replicaset.apps/pc-replicaset image updated

<span class="token comment"># å†æ¬¡æŸ¥çœ‹ï¼Œå‘ç°é•œåƒç‰ˆæœ¬å·²ç»å˜æ›´äº†</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get rs -n dev -o wide</span>
NAME                 DESIRED  CURRENT   READY   AGE    CONTAINERS   IMAGES            <span class="token punctuation">..</span>.
pc-replicaset        <span class="token number">2</span>        <span class="token number">2</span>         <span class="token number">2</span>       145m   nginx        nginx:1.17.1 <span class="token punctuation">..</span>. 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="åˆ é™¤-replicaset" tabindex="-1"><a class="header-anchor" href="#åˆ é™¤-replicaset" aria-hidden="true">#</a> <strong>åˆ é™¤ ReplicaSet</strong></h4><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># ä½¿ç”¨ kubectl delete å‘½ä»¤ä¼šåˆ é™¤æ­¤ RS ä»¥åŠå®ƒç®¡ç†çš„ Pod</span>
<span class="token comment"># åœ¨ kubernetes åˆ é™¤ RS å‰ï¼Œä¼šå°† RS çš„ replicasclear è°ƒæ•´ä¸º 0ï¼Œç­‰å¾…æ‰€æœ‰çš„ Pod è¢«åˆ é™¤åï¼Œåœ¨æ‰§è¡Œ RS å¯¹è±¡çš„åˆ é™¤</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete rs pc-replicaset -n dev</span>
replicaset.apps <span class="token string">&quot;pc-replicaset&quot;</span> deleted
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod -n dev -o wide</span>
No resources found <span class="token keyword">in</span> dev namespace.

<span class="token comment"># å¦‚æœå¸Œæœ›ä»…ä»…åˆ é™¤ RS å¯¹è±¡ï¼ˆä¿ç•™ Podï¼‰ï¼Œå¯ä»¥ä½¿ç”¨ kubectl delete å‘½ä»¤æ—¶æ·»åŠ --cascade=false é€‰é¡¹ï¼ˆä¸æ¨èï¼‰ã€‚</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete rs pc-replicaset -n dev --cascade=false</span>
replicaset.apps <span class="token string">&quot;pc-replicaset&quot;</span> deleted
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev</span>
NAME                  READY   STATUS    RESTARTS   AGE
pc-replicaset-cl82j   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          75s
pc-replicaset-dslhb   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          75s

<span class="token comment"># ä¹Ÿå¯ä»¥ä½¿ç”¨ yaml ç›´æ¥åˆ é™¤(æ¨è)</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete -f pc-replicaset.yaml</span>
replicaset.apps <span class="token string">&quot;pc-replicaset&quot;</span> deleted
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-3-deployment-deploy" tabindex="-1"><a class="header-anchor" href="#_6-3-deployment-deploy" aria-hidden="true">#</a> 6.3 Deployment(Deploy)</h3><p>ä¸ºäº†æ›´å¥½çš„è§£å†³æœåŠ¡ç¼–æ’çš„é—®é¢˜ï¼Œkubernetes åœ¨ V1.2 ç‰ˆæœ¬å¼€å§‹ï¼Œå¼•å…¥äº† Deployment æ§åˆ¶å™¨ã€‚å€¼å¾—ä¸€æçš„æ˜¯ï¼Œè¿™ç§æ§åˆ¶å™¨å¹¶ä¸ç›´æ¥ç®¡ç† podï¼Œè€Œæ˜¯é€šè¿‡ç®¡ç† ReplicaSet æ¥ç®€ä»‹ç®¡ç† Podï¼Œå³ï¼šDeployment ç®¡ç† ReplicaSetï¼ŒReplicaSet ç®¡ç† Podã€‚æ‰€ä»¥ Deployment æ¯” ReplicaSet åŠŸèƒ½æ›´åŠ å¼ºå¤§ã€‚</p><figure><img src="/assets/img/k8s/image-20200612005524778.png" alt="ç›¸å…³å›¾ç‰‡" tabindex="0" loading="lazy"><figcaption>ç›¸å…³å›¾ç‰‡</figcaption></figure><p>Deployment ä¸»è¦åŠŸèƒ½æœ‰ä¸‹é¢å‡ ä¸ªï¼š</p><ul><li>æ”¯æŒ ReplicaSet çš„æ‰€æœ‰åŠŸèƒ½</li><li>æ”¯æŒå‘å¸ƒçš„åœæ­¢ã€ç»§ç»­</li><li>æ”¯æŒæ»šåŠ¨å‡çº§å’Œå›æ»šç‰ˆæœ¬</li></ul><p>Deployment çš„èµ„æºæ¸…å•æ–‡ä»¶ï¼š</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1 <span class="token comment"># ç‰ˆæœ¬å·</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment <span class="token comment"># ç±»å‹       </span>
<span class="token key atrule">metadata</span><span class="token punctuation">:</span> <span class="token comment"># å…ƒæ•°æ®</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token comment"># rs åç§° </span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> <span class="token comment"># æ‰€å±å‘½åç©ºé—´ </span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span> <span class="token comment">#æ ‡ç­¾</span>
    <span class="token key atrule">controller</span><span class="token punctuation">:</span> deploy
<span class="token key atrule">spec</span><span class="token punctuation">:</span> <span class="token comment"># è¯¦æƒ…æè¿°</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span> <span class="token comment"># å‰¯æœ¬æ•°é‡</span>
  <span class="token key atrule">revisionHistoryLimit</span><span class="token punctuation">:</span> <span class="token number">3</span> <span class="token comment"># ä¿ç•™å†å²ç‰ˆæœ¬</span>
  <span class="token key atrule">paused</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># æš‚åœéƒ¨ç½²ï¼Œé»˜è®¤æ˜¯ false</span>
  <span class="token key atrule">progressDeadlineSeconds</span><span class="token punctuation">:</span> <span class="token number">600</span> <span class="token comment"># éƒ¨ç½²è¶…æ—¶æ—¶é—´ï¼ˆsï¼‰ï¼Œé»˜è®¤æ˜¯ 600</span>
  <span class="token key atrule">strategy</span><span class="token punctuation">:</span> <span class="token comment"># ç­–ç•¥</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate <span class="token comment"># æ»šåŠ¨æ›´æ–°ç­–ç•¥</span>
    <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span> <span class="token comment"># æ»šåŠ¨æ›´æ–°</span>
      <span class="token key atrule">è¿è§„è¯æ±‡</span><span class="token punctuation">:</span> 30% <span class="token comment"># æœ€å¤§é¢å¤–å¯ä»¥å­˜åœ¨çš„å‰¯æœ¬æ•°ï¼Œå¯ä»¥ä¸ºç™¾åˆ†æ¯”ï¼Œä¹Ÿå¯ä»¥ä¸ºæ•´æ•°</span>
      <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> 30% <span class="token comment"># æœ€å¤§ä¸å¯ç”¨çŠ¶æ€çš„ Pod çš„æœ€å¤§å€¼ï¼Œå¯ä»¥ä¸ºç™¾åˆ†æ¯”ï¼Œä¹Ÿå¯ä»¥ä¸ºæ•´æ•°</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span> <span class="token comment"># é€‰æ‹©å™¨ï¼Œé€šè¿‡å®ƒæŒ‡å®šè¯¥æ§åˆ¶å™¨ç®¡ç†å“ªäº› pod</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token comment"># Labels åŒ¹é…è§„åˆ™</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
    <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span> <span class="token comment"># Expressions åŒ¹é…è§„åˆ™</span>
      <span class="token punctuation">-</span> <span class="token punctuation">{</span><span class="token key atrule">key</span><span class="token punctuation">:</span> app<span class="token punctuation">,</span> <span class="token key atrule">operator</span><span class="token punctuation">:</span> In<span class="token punctuation">,</span> <span class="token key atrule">values</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>nginx<span class="token punctuation">-</span>pod<span class="token punctuation">]</span><span class="token punctuation">}</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span> <span class="token comment"># æ¨¡æ¿ï¼Œå½“å‰¯æœ¬æ•°é‡ä¸è¶³æ—¶ï¼Œä¼šæ ¹æ®ä¸‹é¢çš„æ¨¡æ¿åˆ›å»º pod å‰¯æœ¬</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_6-3-1-åˆ›å»º-deployment" tabindex="-1"><a class="header-anchor" href="#_6-3-1-åˆ›å»º-deployment" aria-hidden="true">#</a> 6.3.1 åˆ›å»º deployment</h4><p>åˆ›å»º pc-deployment.yamlï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment      
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pc<span class="token punctuation">-</span>deployment
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span> 
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_6-3-2-æ‰©ç¼©å®¹" tabindex="-1"><a class="header-anchor" href="#_6-3-2-æ‰©ç¼©å®¹" aria-hidden="true">#</a> 6.3.2 æ‰©ç¼©å®¹</h4><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># å˜æ›´å‰¯æœ¬æ•°é‡ä¸º 5 ä¸ª</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl scale deploy pc-deployment --replicas=5  -n dev</span>
deployment.apps/pc-deployment scaled

<span class="token comment"># æŸ¥çœ‹ deployment</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get deploy pc-deployment -n dev</span>
NAME            READY   UP-TO-DATE   AVAILABLE   AGE
pc-deployment   <span class="token number">5</span>/5     <span class="token number">5</span>            <span class="token number">5</span>           2m

<span class="token comment"># æŸ¥çœ‹ pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment">#  kubectl get pods -n dev</span>
NAME                             READY   STATUS    RESTARTS   AGE
pc-deployment-6696798b78-d2c8n   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          4m19s
pc-deployment-6696798b78-jxmdq   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          94s
pc-deployment-6696798b78-mktqv   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          93s
pc-deployment-6696798b78-smpvp   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          4m19s
pc-deployment-6696798b78-wvjd8   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          4m19s

<span class="token comment"># ç¼–è¾‘ deployment çš„å‰¯æœ¬æ•°é‡ï¼Œä¿®æ”¹ spec:replicas: 4 å³å¯</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl edit deploy pc-deployment -n dev</span>
deployment.apps/pc-deployment edited

<span class="token comment"># æŸ¥çœ‹ pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev</span>
NAME                             READY   STATUS    RESTARTS   AGE
pc-deployment-6696798b78-d2c8n   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          5m23s
pc-deployment-6696798b78-jxmdq   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          2m38s
pc-deployment-6696798b78-smpvp   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          5m23s
pc-deployment-6696798b78-wvjd8   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          5m23s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>é•œåƒæ›´æ–°</strong></p><p>deployment æ”¯æŒä¸¤ç§æ›´æ–°ç­–ç•¥:<code>é‡å»ºæ›´æ–°</code>å’Œ<code>æ»šåŠ¨æ›´æ–°</code>,å¯ä»¥é€šè¿‡<code>strategy</code>æŒ‡å®šç­–ç•¥ç±»å‹,æ”¯æŒä¸¤ä¸ªå±æ€§:</p><div class="language-markdown line-numbers-mode" data-ext="md"><pre class="language-markdown"><code>strategyï¼šæŒ‡å®šæ–°çš„ Pod æ›¿æ¢æ—§çš„ Pod çš„ç­–ç•¥ï¼Œ æ”¯æŒä¸¤ä¸ªå±æ€§ï¼š
  typeï¼šæŒ‡å®šç­–ç•¥ç±»å‹ï¼Œæ”¯æŒä¸¤ç§ç­–ç•¥
    Recreateï¼šåœ¨åˆ›å»ºå‡ºæ–°çš„ Pod ä¹‹å‰ä¼šå…ˆæ€æ‰æ‰€æœ‰å·²å­˜åœ¨çš„ Pod
    RollingUpdateï¼šæ»šåŠ¨æ›´æ–°ï¼Œå°±æ˜¯æ€æ­»ä¸€éƒ¨åˆ†ï¼Œå°±å¯åŠ¨ä¸€éƒ¨åˆ†ï¼Œåœ¨æ›´æ–°è¿‡ç¨‹ä¸­ï¼Œå­˜åœ¨ä¸¤ä¸ªç‰ˆæœ¬ Pod
  rollingUpdateï¼šå½“ type ä¸º RollingUpdate æ—¶ç”Ÿæ•ˆï¼Œç”¨äºä¸º RollingUpdate è®¾ç½®å‚æ•°ï¼Œæ”¯æŒä¸¤ä¸ªå±æ€§ï¼š
    maxUnavailableï¼šç”¨æ¥æŒ‡å®šåœ¨å‡çº§è¿‡ç¨‹ä¸­ä¸å¯ç”¨ Pod çš„æœ€å¤§æ•°é‡ï¼Œé»˜è®¤ä¸º 25%ã€‚
    è¿è§„è¯æ±‡ï¼š ç”¨æ¥æŒ‡å®šåœ¨å‡çº§è¿‡ç¨‹ä¸­å¯ä»¥è¶…è¿‡æœŸæœ›çš„ Pod çš„æœ€å¤§æ•°é‡ï¼Œé»˜è®¤ä¸º 25%ã€‚
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é‡å»ºæ›´æ–° ( åœ¨åˆ›å»ºå‡ºæ–°çš„ Pod ä¹‹å‰ä¼šå…ˆæ€æ‰æ‰€æœ‰å·²å­˜åœ¨çš„ Pod )</p><ol><li>ç¼–è¾‘ pc-deployment.yaml,åœ¨ spec èŠ‚ç‚¹ä¸‹æ·»åŠ æ›´æ–°ç­–ç•¥</li></ol><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">strategy</span><span class="token punctuation">:</span> <span class="token comment"># ç­–ç•¥</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> Recreate <span class="token comment"># é‡å»ºæ›´æ–°</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>åˆ›å»º deploy è¿›è¡ŒéªŒè¯</li></ol><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># å˜æ›´é•œåƒ</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl set image deployment pc-deployment nginx=nginx:1.17.2 -n dev</span>
deployment.apps/pc-deployment image updated

<span class="token comment"># è§‚å¯Ÿå‡çº§è¿‡ç¨‹</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment">#  kubectl get pods -n dev -w</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ»šåŠ¨æ›´æ–°</p><ol><li>ç¼–è¾‘ pc-deployment.yaml,åœ¨ spec èŠ‚ç‚¹ä¸‹æ·»åŠ æ›´æ–°ç­–ç•¥</li></ol><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">strategy</span><span class="token punctuation">:</span> <span class="token comment"># ç­–ç•¥</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate <span class="token comment"># æ»šåŠ¨æ›´æ–°ç­–ç•¥</span>
    <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>
      <span class="token key atrule">è¿è§„è¯æ±‡</span><span class="token punctuation">:</span> 25% 
      <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> 25%
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>åˆ›å»º deploy è¿›è¡ŒéªŒè¯</li></ol><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># å˜æ›´é•œåƒ</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl set image deployment pc-deployment nginx=nginx:1.17.3 -n dev </span>
deployment.apps/pc-deployment image updated


<span class="token comment"># è‡³æ­¤ï¼Œæ–°ç‰ˆæœ¬çš„ pod åˆ›å»ºå®Œæ¯•ï¼Œå°±ç‰ˆæœ¬çš„ pod é”€æ¯å®Œæ¯•</span>
<span class="token comment"># ä¸­é—´è¿‡ç¨‹æ˜¯æ»šåŠ¨è¿›è¡Œçš„ï¼Œä¹Ÿå°±æ˜¯è¾¹é”€æ¯è¾¹åˆ›å»º</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ»šåŠ¨æ›´æ–°çš„è¿‡ç¨‹ï¼š</p><figure><img src="/assets/img/k8s/image-20200416140251491.png" alt="ç›¸å…³å›¾ç‰‡" tabindex="0" loading="lazy"><figcaption>ç›¸å…³å›¾ç‰‡</figcaption></figure><p><strong>é•œåƒæ›´æ–°ä¸­ rs çš„å˜åŒ–</strong></p><p>æŸ¥çœ‹ rs,å‘ç°åŸæ¥çš„ rs çš„ä¾æ—§å­˜åœ¨ï¼Œåªæ˜¯ pod æ•°é‡å˜ä¸ºäº† 0ï¼Œè€Œååˆæ–°äº§ç”Ÿäº†ä¸€ä¸ª rsï¼Œpod æ•°é‡ä¸º 4ã€‚å…¶å®è¿™å°±æ˜¯ deployment èƒ½å¤Ÿè¿›è¡Œç‰ˆæœ¬å›é€€çš„å¥¥å¦™æ‰€åœ¨ï¼Œåé¢ä¼šè¯¦ç»†è§£é‡Šã€‚</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get rs -n dev</span>
NAME                       DESIRED   CURRENT   READY   AGE
pc-deployment-6696798b78   <span class="token number">0</span>         <span class="token number">0</span>         <span class="token number">0</span>       7m37s
pc-deployment-6696798b11   <span class="token number">0</span>         <span class="token number">0</span>         <span class="token number">0</span>       5m37s
pc-deployment-c848d76789   <span class="token number">4</span>         <span class="token number">4</span>         <span class="token number">4</span>       72s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_6-3-3-ç‰ˆæœ¬å›é€€" tabindex="-1"><a class="header-anchor" href="#_6-3-3-ç‰ˆæœ¬å›é€€" aria-hidden="true">#</a> 6.3.3 ç‰ˆæœ¬å›é€€</h4><p>deployment æ”¯æŒç‰ˆæœ¬å‡çº§è¿‡ç¨‹ä¸­çš„æš‚åœã€ç»§ç»­åŠŸèƒ½ä»¥åŠç‰ˆæœ¬å›é€€ç­‰è¯¸å¤šåŠŸèƒ½ï¼Œä¸‹é¢å…·ä½“æ¥çœ‹.</p><p>kubectl rolloutï¼š ç‰ˆæœ¬å‡çº§ç›¸å…³åŠŸèƒ½ï¼Œæ”¯æŒä¸‹é¢çš„é€‰é¡¹ï¼š</p><ul><li><code>status</code> æ˜¾ç¤ºå½“å‰å‡çº§çŠ¶æ€</li><li><code>history</code> æ˜¾ç¤º å‡çº§å†å²è®°å½•</li><li><code>pause</code> æš‚åœç‰ˆæœ¬å‡çº§è¿‡ç¨‹</li><li><code>resume</code> ç»§ç»­å·²ç»æš‚åœçš„ç‰ˆæœ¬å‡çº§è¿‡ç¨‹</li><li><code>restart</code> é‡å¯ç‰ˆæœ¬å‡çº§è¿‡ç¨‹</li><li><code>undo</code> å›æ»šåˆ°ä¸Šä¸€çº§ç‰ˆæœ¬ï¼ˆå¯ä»¥ä½¿ç”¨--to-revision å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬ï¼‰</li></ul><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># æŸ¥çœ‹å½“å‰å‡çº§ç‰ˆæœ¬çš„çŠ¶æ€</span>
kubectl rollout status deploy pc-deployment <span class="token parameter variable">-n</span> dev

<span class="token comment"># æŸ¥çœ‹å‡çº§å†å²è®°å½•</span>
kubectl rollout <span class="token function">history</span> deploy pc-deployment <span class="token parameter variable">-n</span> dev

<span class="token comment"># å¯ä»¥å‘ç°æœ‰ä¸‰æ¬¡ç‰ˆæœ¬è®°å½•ï¼Œè¯´æ˜å®Œæˆè¿‡ä¸¤æ¬¡å‡çº§</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç‰ˆæœ¬å›æ»š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># è¿™é‡Œç›´æ¥ä½¿ç”¨--to-revision=1 å›æ»šåˆ°äº† 1 ç‰ˆæœ¬ï¼Œ å¦‚æœçœç•¥è¿™ä¸ªé€‰é¡¹ï¼Œå°±æ˜¯å›é€€åˆ°ä¸Šä¸ªç‰ˆæœ¬ï¼Œå°±æ˜¯ 2 ç‰ˆæœ¬</span>
kubectl rollout undo deployment pc-deployment --to-revision<span class="token operator">=</span><span class="token number">1</span> <span class="token parameter variable">-n</span> dev
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>æŸ¥çœ‹å‘ç°ï¼Œé€šè¿‡ nginx é•œåƒç‰ˆæœ¬å¯ä»¥å‘ç°åˆ°äº†ç¬¬ä¸€ç‰ˆ</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get deploy -n dev -o wide</span>
NAME            READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES         
pc-deployment   <span class="token number">4</span>/4     <span class="token number">4</span>            <span class="token number">4</span>           74m   nginx        nginx:1.17.1   

<span class="token comment"># æŸ¥çœ‹ rsï¼Œå‘ç°ç¬¬ä¸€ä¸ª rs ä¸­æœ‰ 4 ä¸ª pod è¿è¡Œï¼Œåé¢ä¸¤ä¸ªç‰ˆæœ¬çš„ rs ä¸­ pod ä¸ºè¿è¡Œ</span>
<span class="token comment"># å…¶å® deployment ä¹‹æ‰€ä»¥å¯æ˜¯å®ç°ç‰ˆæœ¬çš„å›æ»šï¼Œå°±æ˜¯é€šè¿‡è®°å½•ä¸‹å†å² rs æ¥å®ç°çš„ï¼Œ</span>
<span class="token comment"># ä¸€æ—¦æƒ³å›æ»šåˆ°å“ªä¸ªç‰ˆæœ¬ï¼Œåªéœ€è¦å°†å½“å‰ç‰ˆæœ¬ pod æ•°é‡é™ä¸º 0ï¼Œç„¶åå°†å›æ»šç‰ˆæœ¬çš„ pod æå‡ä¸ºç›®æ ‡æ•°é‡å°±å¯ä»¥äº†</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get rs -n dev</span>
NAME                       DESIRED   CURRENT   READY   AGE
pc-deployment-6696798b78   <span class="token number">4</span>         <span class="token number">4</span>         <span class="token number">4</span>       78m
pc-deployment-966bf7f44    <span class="token number">0</span>         <span class="token number">0</span>         <span class="token number">0</span>       37m
pc-deployment-c848d767     <span class="token number">0</span>         <span class="token number">0</span>         <span class="token number">0</span>       71m
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_6-3-4-é‡‘ä¸é›€å‘å¸ƒ" tabindex="-1"><a class="header-anchor" href="#_6-3-4-é‡‘ä¸é›€å‘å¸ƒ" aria-hidden="true">#</a> 6.3.4 é‡‘ä¸é›€å‘å¸ƒ</h4><p>Deployment æ§åˆ¶å™¨æ”¯æŒæ§åˆ¶æ›´æ–°è¿‡ç¨‹ä¸­çš„æ§åˆ¶ï¼Œå¦‚â€œæš‚åœ(pause)â€æˆ–â€œç»§ç»­(resume)â€æ›´æ–°æ“ä½œã€‚</p><p>æ¯”å¦‚æœ‰ä¸€æ‰¹æ–°çš„ Pod èµ„æºåˆ›å»ºå®Œæˆåç«‹å³æš‚åœæ›´æ–°è¿‡ç¨‹ï¼Œæ­¤æ—¶ï¼Œä»…å­˜åœ¨ä¸€éƒ¨åˆ†æ–°ç‰ˆæœ¬çš„åº”ç”¨ï¼Œä¸»ä½“éƒ¨åˆ†è¿˜æ˜¯æ—§çš„ç‰ˆæœ¬ã€‚ç„¶åï¼Œå†ç­›é€‰ä¸€å°éƒ¨åˆ†çš„ç”¨æˆ·è¯·æ±‚è·¯ç”±åˆ°æ–°ç‰ˆæœ¬çš„ Pod åº”ç”¨ï¼Œç»§ç»­è§‚å¯Ÿèƒ½å¦ç¨³å®šåœ°æŒ‰æœŸæœ›çš„æ–¹å¼è¿è¡Œã€‚ç¡®å®šæ²¡é—®é¢˜ä¹‹åå†ç»§ç»­å®Œæˆä½™ä¸‹çš„ Pod èµ„æºæ»šåŠ¨æ›´æ–°ï¼Œå¦åˆ™ç«‹å³å›æ»šæ›´æ–°æ“ä½œã€‚è¿™å°±æ˜¯æ‰€è°“çš„é‡‘ä¸é›€å‘å¸ƒã€‚</p><p>æ›´æ–° deployment çš„ç‰ˆæœ¬ï¼Œå¹¶é…ç½®æš‚åœ deployment</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>kubectl <span class="token builtin class-name">set</span> image deploy pc-deployment <span class="token assign-left variable">nginx</span><span class="token operator">=</span>nginx:1.17.4 <span class="token parameter variable">-n</span> dev <span class="token operator">&amp;&amp;</span> kubectl rollout pause deployment pc-deployment  <span class="token parameter variable">-n</span> dev
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment">#è§‚å¯Ÿæ›´æ–°çŠ¶æ€</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl rollout status deploy pc-deployment -n devã€€</span>
Waiting <span class="token keyword">for</span> deployment <span class="token string">&quot;pc-deployment&quot;</span> rollout to finish: <span class="token number">2</span> out of <span class="token number">4</span> new replicas have been updated<span class="token punctuation">..</span>.

<span class="token comment"># ç›‘æ§æ›´æ–°çš„è¿‡ç¨‹ï¼Œå¯ä»¥çœ‹åˆ°å·²ç»æ–°å¢äº†ä¸€ä¸ªèµ„æºï¼Œä½†æ˜¯å¹¶æœªæŒ‰ç…§é¢„æœŸçš„çŠ¶æ€å»åˆ é™¤ä¸€ä¸ªæ—§çš„èµ„æºï¼Œå°±æ˜¯å› ä¸ºä½¿ç”¨äº† pause æš‚åœå‘½ä»¤</span>

<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get rs -n dev -o wide</span>
NAME                       DESIRED   CURRENT   READY   AGE     CONTAINERS   IMAGES         
pc-deployment-5d89bdfbf9   <span class="token number">3</span>         <span class="token number">3</span>         <span class="token number">3</span>       19m     nginx        nginx:1.17.1   
pc-deployment-675d469f8b   <span class="token number">0</span>         <span class="token number">0</span>         <span class="token number">0</span>       14m     nginx        nginx:1.17.2   
pc-deployment-6c9f56fcfb   <span class="token number">2</span>         <span class="token number">2</span>         <span class="token number">2</span>       3m16s   nginx        nginx:1.17.4   
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev</span>
NAME                             READY   STATUS    RESTARTS   AGE
pc-deployment-5d89bdfbf9-rj8sq   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          7m33s
pc-deployment-5d89bdfbf9-ttwgg   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          7m35s
pc-deployment-5d89bdfbf9-v4wvc   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          7m34s
pc-deployment-6c9f56fcfb-996rt   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          3m31s
pc-deployment-6c9f56fcfb-j2gtj   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          3m31s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç¡®ä¿æ›´æ–°çš„ pod æ²¡é—®é¢˜äº†ï¼Œç»§ç»­æ›´æ–°</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>kubectl rollout resume deploy pc-deployment <span class="token parameter variable">-n</span> dev
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>åˆ é™¤ Deployment</strong></p><p>åˆ é™¤ deploymentï¼Œå…¶ä¸‹çš„ rs å’Œ pod ä¹Ÿå°†è¢«åˆ é™¤</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>kubectl delete <span class="token parameter variable">-f</span> pc-deployment.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="_6-4-horizontal-pod-autoscaler-hpa" tabindex="-1"><a class="header-anchor" href="#_6-4-horizontal-pod-autoscaler-hpa" aria-hidden="true">#</a> 6.4 Horizontal Pod Autoscaler(HPA)</h3><p>åœ¨å‰é¢çš„è¯¾ç¨‹ä¸­ï¼Œæˆ‘ä»¬å·²ç»å¯ä»¥å®ç°é€šè¿‡æ‰‹å·¥æ‰§è¡Œ<code>kubectl scale</code>å‘½ä»¤å®ç° Pod æ‰©å®¹æˆ–ç¼©å®¹ï¼Œä½†æ˜¯è¿™æ˜¾ç„¶ä¸ç¬¦åˆ Kubernetes çš„å®šä½ç›®æ ‡--è‡ªåŠ¨åŒ–ã€æ™ºèƒ½åŒ–ã€‚ Kubernetes æœŸæœ›å¯ä»¥å®ç°é€šè¿‡ç›‘æµ‹ Pod çš„ä½¿ç”¨æƒ…å†µï¼Œå®ç° pod æ•°é‡çš„è‡ªåŠ¨è°ƒæ•´ï¼Œäºæ˜¯å°±äº§ç”Ÿäº† Horizontal Pod Autoscalerï¼ˆHPAï¼‰è¿™ç§æ§åˆ¶å™¨ã€‚</p><p>HPA å¯ä»¥è·å–æ¯ä¸ª Pod åˆ©ç”¨ç‡ï¼Œç„¶åå’Œ HPA ä¸­å®šä¹‰çš„æŒ‡æ ‡è¿›è¡Œå¯¹æ¯”ï¼ŒåŒæ—¶è®¡ç®—å‡ºéœ€è¦ä¼¸ç¼©çš„å…·ä½“å€¼ï¼Œæœ€åå®ç° Pod çš„æ•°é‡çš„è°ƒæ•´ã€‚å…¶å® HPA ä¸ä¹‹å‰çš„ Deployment ä¸€æ ·ï¼Œä¹Ÿå±äºä¸€ç§ Kubernetes èµ„æºå¯¹è±¡ï¼Œå®ƒé€šè¿‡è¿½è¸ªåˆ†æ RC æ§åˆ¶çš„æ‰€æœ‰ç›®æ ‡ Pod çš„è´Ÿè½½å˜åŒ–æƒ…å†µï¼Œæ¥ç¡®å®šæ˜¯å¦éœ€è¦é’ˆå¯¹æ€§åœ°è°ƒæ•´ç›®æ ‡ Pod çš„å‰¯æœ¬æ•°ï¼Œè¿™æ˜¯ HPA çš„å®ç°åŸç†ã€‚</p><figure><img src="/assets/img/k8s/image-20200608155858271.png" alt="ç›¸å…³å›¾ç‰‡" height="300" tabindex="0" loading="lazy"><figcaption>ç›¸å…³å›¾ç‰‡</figcaption></figure><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥åšä¸€ä¸ªå®éªŒ</p><h4 id="_6-4-1-å®‰è£…-metrics-server" tabindex="-1"><a class="header-anchor" href="#_6-4-1-å®‰è£…-metrics-server" aria-hidden="true">#</a> 6.4.1 å®‰è£… metrics-server</h4><p>metrics-server å¯ä»¥ç”¨æ¥æ”¶é›†é›†ç¾¤ä¸­çš„èµ„æºä½¿ç”¨æƒ…å†µ</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>yum <span class="token function">install</span> <span class="token function">git</span> <span class="token parameter variable">-y</span>
<span class="token comment"># è·å– metrics-server, æ³¨æ„ä½¿ç”¨çš„ç‰ˆæœ¬</span>
<span class="token function">git</span> clone <span class="token parameter variable">-b</span> v0.3.6 https://github.com/kubernetes-incubator/metrics-server
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¿®æ”¹ deployment, æ³¨æ„ä¿®æ”¹çš„æ˜¯é•œåƒå’Œåˆå§‹åŒ–å‚æ•°</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># cd /root/metrics-server/deploy/1.8+/</span>
<span class="token punctuation">[</span>root@k8s-master01 <span class="token number">1.8</span>+<span class="token punctuation">]</span><span class="token comment"># vim metrics-server-deployment.yaml</span>
<span class="token comment"># æŒ‰å›¾ä¸­æ·»åŠ ä¸‹é¢é€‰é¡¹</span>
hostNetwork: <span class="token boolean">true</span>
image: registry.cn-hangzhou.aliyuncs.com/google_containers/metrics-server-amd64:v0.3.6
args:
- --kubelet-insecure-tls
- --kubelet-preferred-address-types<span class="token operator">=</span>InternalIP,Hostname,InternalDNS,ExternalDNS,ExternalIP
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="/assets/img/k8s/image-20200608163326496.png" alt="ç›¸å…³å›¾ç‰‡" tabindex="0" loading="lazy"><figcaption>ç›¸å…³å›¾ç‰‡</figcaption></figure><p>å®‰è£… metrics-server</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>kubectl apply <span class="token parameter variable">-f</span> ./
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>æŸ¥çœ‹èµ„æºä½¿ç”¨æƒ…å†µ</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># æŸ¥çœ‹ pod è¿è¡Œæƒ…å†µ</span>
<span class="token punctuation">[</span>root@k8s-master01 <span class="token number">1.8</span>+<span class="token punctuation">]</span><span class="token comment"># kubectl get pod -n kube-system</span>
metrics-server-6b976979db-2xwbj   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          90s

<span class="token comment"># ä½¿ç”¨ kubectl top node æŸ¥çœ‹èµ„æºä½¿ç”¨æƒ…å†µï¼ˆç¨å¾®ç­‰ä¸€ä¸‹ï¼‰</span>
<span class="token punctuation">[</span>root@k8s-master01 <span class="token number">1.8</span>+<span class="token punctuation">]</span><span class="token comment"># kubectl top node</span>
NAME           CPU<span class="token punctuation">(</span>cores<span class="token punctuation">)</span>   CPU%   MEMORY<span class="token punctuation">(</span>bytes<span class="token punctuation">)</span>   MEMORY%
k8s-master01   289m         <span class="token number">14</span>%    1582Mi          <span class="token number">54</span>%       
k8s-node01     81m          <span class="token number">4</span>%     1195Mi          <span class="token number">40</span>%       
k8s-node02     72m          <span class="token number">3</span>%     1211Mi          <span class="token number">41</span>%  
<span class="token punctuation">[</span>root@k8s-master01 <span class="token number">1.8</span>+<span class="token punctuation">]</span><span class="token comment"># kubectl top pod -n kube-system</span>
NAME                              CPU<span class="token punctuation">(</span>cores<span class="token punctuation">)</span>   MEMORY<span class="token punctuation">(</span>bytes<span class="token punctuation">)</span>
coredns-6955765f44-7ptsb          3m           9Mi
coredns-6955765f44-vcwr5          3m           8Mi
etcd-master                       14m          145Mi
<span class="token punctuation">..</span>.
<span class="token comment"># è‡³æ­¤,metrics-server å®‰è£…å®Œæˆ</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_6-4-2-å‡†å¤‡-deployment-å’Œ-servie" tabindex="-1"><a class="header-anchor" href="#_6-4-2-å‡†å¤‡-deployment-å’Œ-servie" aria-hidden="true">#</a> 6.4.2 å‡†å¤‡ deployment å’Œ servie</h4><p>åˆ›å»º pc-hpa-pod.yaml æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">strategy</span><span class="token punctuation">:</span> <span class="token comment"># ç­–ç•¥</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate <span class="token comment"># æ»šåŠ¨æ›´æ–°ç­–ç•¥</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
        <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token comment"># èµ„æºé…é¢</span>
          <span class="token key atrule">limits</span><span class="token punctuation">:</span>  <span class="token comment"># é™åˆ¶èµ„æºï¼ˆä¸Šé™ï¼‰</span>
            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">&quot;1&quot;</span> <span class="token comment"># CPU é™åˆ¶ï¼Œå•ä½æ˜¯ core æ•°</span>
          <span class="token key atrule">requests</span><span class="token punctuation">:</span> <span class="token comment"># è¯·æ±‚èµ„æºï¼ˆä¸‹é™ï¼‰</span>
            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">&quot;100m&quot;</span>  <span class="token comment"># CPU é™åˆ¶ï¼Œå•ä½æ˜¯ core æ•°</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># åˆ›å»º deployment</span>
<span class="token punctuation">[</span>root@k8s-master01 <span class="token number">1.8</span>+<span class="token punctuation">]</span><span class="token comment"># kubectl run nginx --image=nginx:1.17.1 --requests=cpu=100m -n dev</span>
<span class="token comment"># åˆ›å»º service</span>
<span class="token punctuation">[</span>root@k8s-master01 <span class="token number">1.8</span>+<span class="token punctuation">]</span><span class="token comment"># kubectl expose deployment nginx --type=NodePort --port=80 -n dev</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># æŸ¥çœ‹</span>
<span class="token punctuation">[</span>root@k8s-master01 <span class="token number">1.8</span>+<span class="token punctuation">]</span><span class="token comment"># kubectl get deployment,pod,svc -n dev</span>
NAME                    READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/nginx   <span class="token number">1</span>/1     <span class="token number">1</span>            <span class="token number">1</span>           47s

NAME                         READY   STATUS    RESTARTS   AGE
pod/nginx-7df9756ccc-bh8dr   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          47s

NAME            TYPE       CLUSTER-IP      EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>        AGE
service/nginx   NodePort   <span class="token number">10.101</span>.18.29   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">80</span>:31830/TCP   35s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_6-4-3-éƒ¨ç½²-hpa" tabindex="-1"><a class="header-anchor" href="#_6-4-3-éƒ¨ç½²-hpa" aria-hidden="true">#</a> 6.4.3 éƒ¨ç½² HPA</h4><p>åˆ›å»º pc-hpa.yaml æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> autoscaling/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> HorizontalPodAutoscaler
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pc<span class="token punctuation">-</span>hpa
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">minReplicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token comment">#æœ€å° pod æ•°é‡</span>
  <span class="token key atrule">maxReplicas</span><span class="token punctuation">:</span> <span class="token number">10</span> <span class="token comment">#æœ€å¤§ pod æ•°é‡</span>
  <span class="token key atrule">targetCPUUtilizationPercentage</span><span class="token punctuation">:</span> <span class="token number">3</span> <span class="token comment"># CPU ä½¿ç”¨ç‡æŒ‡æ ‡</span>
  <span class="token key atrule">scaleTargetRef</span><span class="token punctuation">:</span>   <span class="token comment"># æŒ‡å®šè¦æ§åˆ¶çš„ nginx ä¿¡æ¯</span>
    <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span>  /v1
    <span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
    <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># åˆ›å»º hpa</span>
<span class="token punctuation">[</span>root@k8s-master01 <span class="token number">1.8</span>+<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pc-hpa.yaml</span>
horizontalpodautoscaler.autoscaling/pc-hpa created

<span class="token comment"># æŸ¥çœ‹ hpa</span>
    <span class="token punctuation">[</span>root@k8s-master01 <span class="token number">1.8</span>+<span class="token punctuation">]</span><span class="token comment"># kubectl get hpa -n dev</span>
NAME     REFERENCE          TARGETS   MINPODS   MAXPODS   REPLICAS   AGE
pc-hpa   Deployment/nginx   <span class="token number">0</span>%/3%     <span class="token number">1</span>         <span class="token number">10</span>        <span class="token number">1</span>          62s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_6-4-4-æµ‹è¯•" tabindex="-1"><a class="header-anchor" href="#_6-4-4-æµ‹è¯•" aria-hidden="true">#</a> 6.4.4 æµ‹è¯•</h4><p>ä½¿ç”¨å‹æµ‹å·¥å…·å¯¹ service åœ°å€<code>192.168.5.4:31830</code>è¿›è¡Œå‹æµ‹ï¼Œç„¶åé€šè¿‡æ§åˆ¶å°æŸ¥çœ‹ hpa å’Œ pod çš„å˜åŒ–</p><p>hpa å˜åŒ–</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get hpa -n dev -w</span>
NAME   REFERENCE      TARGETS  MINPODS  MAXPODS  REPLICAS  AGE
pc-hpa  Deployment/nginx  <span class="token number">0</span>%/3%   <span class="token number">1</span>     <span class="token number">10</span>     <span class="token number">1</span>      4m11s
pc-hpa  Deployment/nginx  <span class="token number">0</span>%/3%   <span class="token number">1</span>     <span class="token number">10</span>     <span class="token number">1</span>      5m19s
pc-hpa  Deployment/nginx  <span class="token number">22</span>%/3%   <span class="token number">1</span>     <span class="token number">10</span>     <span class="token number">1</span>      6m50s
pc-hpa  Deployment/nginx  <span class="token number">22</span>%/3%   <span class="token number">1</span>     <span class="token number">10</span>     <span class="token number">4</span>      7m5s
pc-hpa  Deployment/nginx  <span class="token number">22</span>%/3%   <span class="token number">1</span>     <span class="token number">10</span>     <span class="token number">8</span>      7m21s
pc-hpa  Deployment/nginx  <span class="token number">6</span>%/3%   <span class="token number">1</span>     <span class="token number">10</span>     <span class="token number">8</span>      7m51s
pc-hpa  Deployment/nginx  <span class="token number">0</span>%/3%   <span class="token number">1</span>     <span class="token number">10</span>     <span class="token number">8</span>      9m6s
pc-hpa  Deployment/nginx  <span class="token number">0</span>%/3%   <span class="token number">1</span>     <span class="token number">10</span>     <span class="token number">8</span>      13m
pc-hpa  Deployment/nginx  <span class="token number">0</span>%/3%   <span class="token number">1</span>     <span class="token number">10</span>     <span class="token number">1</span>      14m
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>deployment å˜åŒ–</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get deployment -n dev -w</span>
NAME    READY   UP-TO-DATE   AVAILABLE   AGE
nginx   <span class="token number">1</span>/1     <span class="token number">1</span>            <span class="token number">1</span>           11m
nginx   <span class="token number">1</span>/4     <span class="token number">1</span>            <span class="token number">1</span>           13m
nginx   <span class="token number">1</span>/4     <span class="token number">1</span>            <span class="token number">1</span>           13m
nginx   <span class="token number">1</span>/4     <span class="token number">1</span>            <span class="token number">1</span>           13m
nginx   <span class="token number">1</span>/4     <span class="token number">4</span>            <span class="token number">1</span>           13m
nginx   <span class="token number">1</span>/8     <span class="token number">4</span>            <span class="token number">1</span>           14m
nginx   <span class="token number">1</span>/8     <span class="token number">4</span>            <span class="token number">1</span>           14m
nginx   <span class="token number">1</span>/8     <span class="token number">4</span>            <span class="token number">1</span>           14m
nginx   <span class="token number">1</span>/8     <span class="token number">8</span>            <span class="token number">1</span>           14m
nginx   <span class="token number">2</span>/8     <span class="token number">8</span>            <span class="token number">2</span>           14m
nginx   <span class="token number">3</span>/8     <span class="token number">8</span>            <span class="token number">3</span>           14m
nginx   <span class="token number">4</span>/8     <span class="token number">8</span>            <span class="token number">4</span>           14m
nginx   <span class="token number">5</span>/8     <span class="token number">8</span>            <span class="token number">5</span>           14m
nginx   <span class="token number">6</span>/8     <span class="token number">8</span>            <span class="token number">6</span>           14m
nginx   <span class="token number">7</span>/8     <span class="token number">8</span>            <span class="token number">7</span>           14m
nginx   <span class="token number">8</span>/8     <span class="token number">8</span>            <span class="token number">8</span>           15m
nginx   <span class="token number">8</span>/1     <span class="token number">8</span>            <span class="token number">8</span>           20m
nginx   <span class="token number">8</span>/1     <span class="token number">8</span>            <span class="token number">8</span>           20m
nginx   <span class="token number">1</span>/1     <span class="token number">1</span>            <span class="token number">1</span>           20m
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>pod å˜åŒ–</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>[root@k8s-master01 ~]# kubectl get pods -n dev -w
NAME                     READY   STATUS    RESTARTS   AGE
nginx-7df9756ccc-bh8dr   1/1     Running   0          11m
nginx-7df9756ccc-cpgrv   0/1     Pending   0          0s
nginx-7df9756ccc-8zhwk   0/1     Pending   0          0s
nginx-7df9756ccc-rr9bn   0/1     Pending   0          0s
nginx-7df9756ccc-cpgrv   0/1     ContainerCreating   0          0s
nginx-7df9756ccc-8zhwk   0/1     ContainerCreating   0          0s
nginx-7df9756ccc-rr9bn   0/1     ContainerCreating   0          0s
nginx-7df9756ccc-m9gsj   0/1     Pending             0          0s
nginx-7df9756ccc-g56qb   0/1     Pending             0          0s
nginx-7df9756ccc-sl9c6   0/1     Pending             0          0s
nginx-7df9756ccc-fgst7   0/1     Pending             0          0s
nginx-7df9756ccc-g56qb   0/1     ContainerCreating   0          0s
nginx-7df9756ccc-m9gsj   0/1     ContainerCreating   0          0s
nginx-7df9756ccc-sl9c6   0/1     ContainerCreating   0          0s
nginx-7df9756ccc-fgst7   0/1     ContainerCreating   0          0s
nginx-7df9756ccc-8zhwk   1/1     Running             0          19s
nginx-7df9756ccc-rr9bn   1/1     Running             0          30s
nginx-7df9756ccc-m9gsj   1/1     Running             0          21s
nginx-7df9756ccc-cpgrv   1/1     Running             0          47s
nginx-7df9756ccc-sl9c6   1/1     Running             0          33s
nginx-7df9756ccc-g56qb   1/1     Running             0          48s
nginx-7df9756ccc-fgst7   1/1     Running             0          66s
nginx-7df9756ccc-fgst7   1/1     Terminating         0          6m50s
nginx-7df9756ccc-8zhwk   1/1     Terminating         0          7m5s
nginx-7df9756ccc-cpgrv   1/1     Terminating         0          7m5s
nginx-7df9756ccc-g56qb   1/1     Terminating         0          6m50s
nginx-7df9756ccc-rr9bn   1/1     Terminating         0          7m5s
nginx-7df9756ccc-m9gsj   1/1     Terminating         0          6m50s
nginx-7df9756ccc-sl9c6   1/1     Terminating         0          6m50s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-5-daemonset-ds" tabindex="-1"><a class="header-anchor" href="#_6-5-daemonset-ds" aria-hidden="true">#</a> 6.5 DaemonSet(DS)</h3><p>DaemonSet ç±»å‹çš„æ§åˆ¶å™¨å¯ä»¥ä¿è¯åœ¨é›†ç¾¤ä¸­çš„æ¯ä¸€å°ï¼ˆæˆ–æŒ‡å®šï¼‰èŠ‚ç‚¹ä¸Šéƒ½è¿è¡Œä¸€ä¸ªå‰¯æœ¬ã€‚ä¸€èˆ¬é€‚ç”¨äºæ—¥å¿—æ”¶é›†ã€èŠ‚ç‚¹ç›‘æ§ç­‰åœºæ™¯ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœä¸€ä¸ª Pod æä¾›çš„åŠŸèƒ½æ˜¯èŠ‚ç‚¹çº§åˆ«çš„ï¼ˆæ¯ä¸ªèŠ‚ç‚¹éƒ½éœ€è¦ä¸”åªéœ€è¦ä¸€ä¸ªï¼‰ï¼Œé‚£ä¹ˆè¿™ç±» Pod å°±é€‚åˆä½¿ç”¨ DaemonSet ç±»å‹çš„æ§åˆ¶å™¨åˆ›å»ºã€‚</p><figure><img src="/assets/img/k8s/image-20200612010223537.png" alt="ç›¸å…³å›¾ç‰‡" tabindex="0" loading="lazy"><figcaption>ç›¸å…³å›¾ç‰‡</figcaption></figure><p>DaemonSet æ§åˆ¶å™¨çš„ç‰¹ç‚¹ï¼š</p><ul><li>æ¯å½“å‘é›†ç¾¤ä¸­æ·»åŠ ä¸€ä¸ªèŠ‚ç‚¹æ—¶ï¼ŒæŒ‡å®šçš„ Pod å‰¯æœ¬ä¹Ÿå°†æ·»åŠ åˆ°è¯¥èŠ‚ç‚¹ä¸Š</li><li>å½“èŠ‚ç‚¹ä»é›†ç¾¤ä¸­ç§»é™¤æ—¶ï¼ŒPod ä¹Ÿå°±è¢«åƒåœ¾å›æ”¶äº†</li></ul><p>ä¸‹é¢å…ˆæ¥çœ‹ä¸‹ DaemonSet çš„èµ„æºæ¸…å•æ–‡ä»¶</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1 <span class="token comment"># ç‰ˆæœ¬å·</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DaemonSet <span class="token comment"># ç±»å‹       </span>
<span class="token key atrule">metadata</span><span class="token punctuation">:</span> <span class="token comment"># å…ƒæ•°æ®</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token comment"># rs åç§° </span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> <span class="token comment"># æ‰€å±å‘½åç©ºé—´ </span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span> <span class="token comment">#æ ‡ç­¾</span>
    <span class="token key atrule">controller</span><span class="token punctuation">:</span> daemonset
<span class="token key atrule">spec</span><span class="token punctuation">:</span> <span class="token comment"># è¯¦æƒ…æè¿°</span>
  <span class="token key atrule">revisionHistoryLimit</span><span class="token punctuation">:</span> <span class="token number">3</span> <span class="token comment"># ä¿ç•™å†å²ç‰ˆæœ¬</span>
  <span class="token key atrule">updateStrategy</span><span class="token punctuation">:</span> <span class="token comment"># æ›´æ–°ç­–ç•¥</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate <span class="token comment"># æ»šåŠ¨æ›´æ–°ç­–ç•¥</span>
    <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span> <span class="token comment"># æ»šåŠ¨æ›´æ–°</span>
      <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> <span class="token number">1</span> <span class="token comment"># æœ€å¤§ä¸å¯ç”¨çŠ¶æ€çš„ Pod çš„æœ€å¤§å€¼ï¼Œå¯ä»¥ä¸ºç™¾åˆ†æ¯”ï¼Œä¹Ÿå¯ä»¥ä¸ºæ•´æ•°</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span> <span class="token comment"># é€‰æ‹©å™¨ï¼Œé€šè¿‡å®ƒæŒ‡å®šè¯¥æ§åˆ¶å™¨ç®¡ç†å“ªäº› pod</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token comment"># Labels åŒ¹é…è§„åˆ™</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
    <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span> <span class="token comment"># Expressions åŒ¹é…è§„åˆ™</span>
      <span class="token punctuation">-</span> <span class="token punctuation">{</span><span class="token key atrule">key</span><span class="token punctuation">:</span> app<span class="token punctuation">,</span> <span class="token key atrule">operator</span><span class="token punctuation">:</span> In<span class="token punctuation">,</span> <span class="token key atrule">values</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>nginx<span class="token punctuation">-</span>pod<span class="token punctuation">]</span><span class="token punctuation">}</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span> <span class="token comment"># æ¨¡æ¿ï¼Œå½“å‰¯æœ¬æ•°é‡ä¸è¶³æ—¶ï¼Œä¼šæ ¹æ®ä¸‹é¢çš„æ¨¡æ¿åˆ›å»º pod å‰¯æœ¬</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åˆ›å»º pc-daemonset.yamlï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DaemonSet      
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pc<span class="token punctuation">-</span>daemonset
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span> 
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># åˆ›å»º daemonset</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f  pc-daemonset.yaml</span>
daemonset.apps/pc-daemonset created

<span class="token comment"># æŸ¥çœ‹ daemonset</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment">#  kubectl get ds -n dev -o wide</span>
NAME        DESIRED  CURRENT  READY  UP-TO-DATE  AVAILABLE   AGE   CONTAINERS   IMAGES         
pc-daemonset   <span class="token number">2</span>        <span class="token number">2</span>        <span class="token number">2</span>      <span class="token number">2</span>           <span class="token number">2</span>        24s   nginx        nginx:1.17.1   

<span class="token comment"># æŸ¥çœ‹ pod,å‘ç°åœ¨æ¯ä¸ª Node ä¸Šéƒ½è¿è¡Œä¸€ä¸ª pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment">#  kubectl get pods -n dev -o wide</span>
NAME                 READY   STATUS    RESTARTS   AGE   IP            NODE    
pc-daemonset-9bck8   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          37s   <span class="token number">10.244</span>.1.43   node1     
pc-daemonset-k224w   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          37s   <span class="token number">10.244</span>.2.74   node2      

<span class="token comment"># åˆ é™¤ daemonset</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete -f pc-daemonset.yaml</span>
daemonset.apps <span class="token string">&quot;pc-daemonset&quot;</span> deleted
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-6-job" tabindex="-1"><a class="header-anchor" href="#_6-6-job" aria-hidden="true">#</a> 6.6 Job</h3><p>Jobï¼Œä¸»è¦ç”¨äºè´Ÿè´£ <strong>æ‰¹é‡å¤„ç†(ä¸€æ¬¡è¦å¤„ç†æŒ‡å®šæ•°é‡ä»»åŠ¡)</strong> çŸ­æš‚çš„ <strong>ä¸€æ¬¡æ€§(æ¯ä¸ªä»»åŠ¡ä»…è¿è¡Œä¸€æ¬¡å°±ç»“æŸ)</strong> ä»»åŠ¡ã€‚Job ç‰¹ç‚¹å¦‚ä¸‹ï¼š</p><ul><li>å½“ Job åˆ›å»ºçš„ pod æ‰§è¡ŒæˆåŠŸç»“æŸæ—¶ï¼ŒJob å°†è®°å½•æˆåŠŸç»“æŸçš„ pod æ•°é‡</li><li>å½“æˆåŠŸç»“æŸçš„ pod è¾¾åˆ°æŒ‡å®šçš„æ•°é‡æ—¶ï¼ŒJob å°†å®Œæˆæ‰§è¡Œ</li></ul><figure><img src="/assets/img/k8s/image-20200618213054113.png" alt="ç›¸å…³å›¾ç‰‡" tabindex="0" loading="lazy"><figcaption>ç›¸å…³å›¾ç‰‡</figcaption></figure><p>Job çš„èµ„æºæ¸…å•æ–‡ä»¶ï¼š</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> batch/v1 <span class="token comment"># ç‰ˆæœ¬å·</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Job <span class="token comment"># ç±»å‹       </span>
<span class="token key atrule">metadata</span><span class="token punctuation">:</span> <span class="token comment"># å…ƒæ•°æ®</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token comment"># rs åç§° </span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> <span class="token comment"># æ‰€å±å‘½åç©ºé—´ </span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span> <span class="token comment">#æ ‡ç­¾</span>
    <span class="token key atrule">controller</span><span class="token punctuation">:</span> job
<span class="token key atrule">spec</span><span class="token punctuation">:</span> <span class="token comment"># è¯¦æƒ…æè¿°</span>
  <span class="token key atrule">completions</span><span class="token punctuation">:</span> <span class="token number">1</span> <span class="token comment"># æŒ‡å®š job éœ€è¦æˆåŠŸè¿è¡Œ Pods çš„æ¬¡æ•°ã€‚é»˜è®¤å€¼: 1</span>
  <span class="token key atrule">parallelism</span><span class="token punctuation">:</span> <span class="token number">1</span> <span class="token comment"># æŒ‡å®š job åœ¨ä»»ä¸€æ—¶åˆ»åº”è¯¥å¹¶å‘è¿è¡Œ Pods çš„æ•°é‡ã€‚é»˜è®¤å€¼: 1</span>
  <span class="token key atrule">activeDeadlineSeconds</span><span class="token punctuation">:</span> <span class="token number">30</span> <span class="token comment"># æŒ‡å®š job å¯è¿è¡Œçš„æ—¶é—´æœŸé™ï¼Œè¶…è¿‡æ—¶é—´è¿˜æœªç»“æŸï¼Œç³»ç»Ÿå°†ä¼šå°è¯•è¿›è¡Œç»ˆæ­¢ã€‚</span>
  <span class="token key atrule">backoffLimit</span><span class="token punctuation">:</span> <span class="token number">6</span> <span class="token comment"># æŒ‡å®š job å¤±è´¥åè¿›è¡Œé‡è¯•çš„æ¬¡æ•°ã€‚é»˜è®¤æ˜¯ 6</span>
  <span class="token key atrule">manualSelector</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># æ˜¯å¦å¯ä»¥ä½¿ç”¨ selector é€‰æ‹©å™¨é€‰æ‹© podï¼Œé»˜è®¤æ˜¯ false</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span> <span class="token comment"># é€‰æ‹©å™¨ï¼Œé€šè¿‡å®ƒæŒ‡å®šè¯¥æ§åˆ¶å™¨ç®¡ç†å“ªäº› pod</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token comment"># Labels åŒ¹é…è§„åˆ™</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> counter<span class="token punctuation">-</span>pod
    <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span> <span class="token comment"># Expressions åŒ¹é…è§„åˆ™</span>
      <span class="token punctuation">-</span> <span class="token punctuation">{</span><span class="token key atrule">key</span><span class="token punctuation">:</span> app<span class="token punctuation">,</span> <span class="token key atrule">operator</span><span class="token punctuation">:</span> In<span class="token punctuation">,</span> <span class="token key atrule">values</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>counter<span class="token punctuation">-</span>pod<span class="token punctuation">]</span><span class="token punctuation">}</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span> <span class="token comment"># æ¨¡æ¿ï¼Œå½“å‰¯æœ¬æ•°é‡ä¸è¶³æ—¶ï¼Œä¼šæ ¹æ®ä¸‹é¢çš„æ¨¡æ¿åˆ›å»º pod å‰¯æœ¬</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> counter<span class="token punctuation">-</span>pod
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Never <span class="token comment"># é‡å¯ç­–ç•¥åªèƒ½è®¾ç½®ä¸º Never æˆ–è€… OnFailure</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> counter
        <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.30</span>
        <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;bin/sh&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;-c&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;for i in 9 8 7 6 5 4 3 2 1; do echo $i;sleep 2;done&quot;</span><span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å…³äºé‡å¯ç­–ç•¥è®¾ç½®çš„è¯´æ˜ï¼š</p><ul><li>å¦‚æœæŒ‡å®šä¸º OnFailureï¼Œåˆ™ job ä¼šåœ¨ pod å‡ºç°æ•…éšœæ—¶é‡å¯å®¹å™¨ï¼Œè€Œä¸æ˜¯åˆ›å»º podï¼Œfailed æ¬¡æ•°ä¸å˜</li><li>å¦‚æœæŒ‡å®šä¸º Neverï¼Œåˆ™ job ä¼šåœ¨ pod å‡ºç°æ•…éšœæ—¶åˆ›å»ºæ–°çš„ podï¼Œå¹¶ä¸”æ•…éšœ pod ä¸ä¼šæ¶ˆå¤±ï¼Œä¹Ÿä¸ä¼šé‡å¯ï¼Œfailed æ¬¡æ•°åŠ  1</li><li>å¦‚æœæŒ‡å®šä¸º Always çš„è¯ï¼Œå°±æ„å‘³ç€ä¸€ç›´é‡å¯ï¼Œæ„å‘³ç€ job ä»»åŠ¡ä¼šé‡å¤å»æ‰§è¡Œäº†ï¼Œå½“ç„¶ä¸å¯¹ï¼Œæ‰€ä»¥ä¸èƒ½è®¾ç½®ä¸º Always</li></ul><p>åˆ›å»º pc-job.yamlï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> batch/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Job      
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pc<span class="token punctuation">-</span>job
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">manualSelector</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> counter<span class="token punctuation">-</span>pod
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> counter<span class="token punctuation">-</span>pod
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Never
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> counter
        <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.30</span>
        <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;bin/sh&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;-c&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;for i in 9 8 7 6 5 4 3 2 1; do echo $i;sleep 3;done&quot;</span><span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># åˆ›å»º job</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pc-job.yaml</span>
job.batch/pc-job created

<span class="token comment"># æŸ¥çœ‹ job</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get job -n dev -o wide  -w</span>
NAME     COMPLETIONS   DURATION   AGE   CONTAINERS   IMAGES         SELECTOR
pc-job   <span class="token number">0</span>/1           21s        21s   counter      busybox:1.30   <span class="token assign-left variable">app</span><span class="token operator">=</span>counter-pod
pc-job   <span class="token number">1</span>/1           31s        79s   counter      busybox:1.30   <span class="token assign-left variable">app</span><span class="token operator">=</span>counter-pod

<span class="token comment"># é€šè¿‡è§‚å¯Ÿ pod çŠ¶æ€å¯ä»¥çœ‹åˆ°ï¼Œpod åœ¨è¿è¡Œå®Œæ¯•ä»»åŠ¡åï¼Œå°±ä¼šå˜æˆ Completed çŠ¶æ€</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev -w</span>
NAME           READY   STATUS     RESTARTS      AGE
pc-job-rxg96   <span class="token number">1</span>/1     Running     <span class="token number">0</span>            29s
pc-job-rxg96   <span class="token number">0</span>/1     Completed   <span class="token number">0</span>            33s

<span class="token comment"># æ¥ä¸‹æ¥ï¼Œè°ƒæ•´ä¸‹ pod è¿è¡Œçš„æ€»æ•°é‡å’Œå¹¶è¡Œæ•°é‡ å³ï¼šåœ¨ spec ä¸‹è®¾ç½®ä¸‹é¢ä¸¤ä¸ªé€‰é¡¹</span>
<span class="token comment">#  completions: 6 # æŒ‡å®š job éœ€è¦æˆåŠŸè¿è¡Œ Pods çš„æ¬¡æ•°ä¸º 6</span>
<span class="token comment">#  parallelism: 3 # æŒ‡å®š job å¹¶å‘è¿è¡Œ Pods çš„æ•°é‡ä¸º 3</span>
<span class="token comment">#  ç„¶åé‡æ–°è¿è¡Œ jobï¼Œè§‚å¯Ÿæ•ˆæœï¼Œæ­¤æ—¶ä¼šå‘ç°ï¼Œjob ä¼šæ¯æ¬¡è¿è¡Œ 3 ä¸ª podï¼Œæ€»å…±æ‰§è¡Œäº† 6 ä¸ª pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev -w</span>
NAME           READY   STATUS    RESTARTS   AGE
pc-job-684ft   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          5s
pc-job-jhj49   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          5s
pc-job-pfcvh   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          5s
pc-job-684ft   <span class="token number">0</span>/1     Completed   <span class="token number">0</span>          11s
pc-job-v7rhr   <span class="token number">0</span>/1     Pending     <span class="token number">0</span>          0s
pc-job-v7rhr   <span class="token number">0</span>/1     Pending     <span class="token number">0</span>          0s
pc-job-v7rhr   <span class="token number">0</span>/1     ContainerCreating   <span class="token number">0</span>          0s
pc-job-jhj49   <span class="token number">0</span>/1     Completed           <span class="token number">0</span>          11s
pc-job-fhwf7   <span class="token number">0</span>/1     Pending             <span class="token number">0</span>          0s
pc-job-fhwf7   <span class="token number">0</span>/1     Pending             <span class="token number">0</span>          0s
pc-job-pfcvh   <span class="token number">0</span>/1     Completed           <span class="token number">0</span>          11s
pc-job-5vg2j   <span class="token number">0</span>/1     Pending             <span class="token number">0</span>          0s
pc-job-fhwf7   <span class="token number">0</span>/1     ContainerCreating   <span class="token number">0</span>          0s
pc-job-5vg2j   <span class="token number">0</span>/1     Pending             <span class="token number">0</span>          0s
pc-job-5vg2j   <span class="token number">0</span>/1     ContainerCreating   <span class="token number">0</span>          0s
pc-job-fhwf7   <span class="token number">1</span>/1     Running             <span class="token number">0</span>          2s
pc-job-v7rhr   <span class="token number">1</span>/1     Running             <span class="token number">0</span>          2s
pc-job-5vg2j   <span class="token number">1</span>/1     Running             <span class="token number">0</span>          3s
pc-job-fhwf7   <span class="token number">0</span>/1     Completed           <span class="token number">0</span>          12s
pc-job-v7rhr   <span class="token number">0</span>/1     Completed           <span class="token number">0</span>          12s
pc-job-5vg2j   <span class="token number">0</span>/1     Completed           <span class="token number">0</span>          12s

<span class="token comment"># åˆ é™¤ job</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete -f pc-job.yaml</span>
job.batch <span class="token string">&quot;pc-job&quot;</span> deleted
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-7-cronjob-cj" tabindex="-1"><a class="header-anchor" href="#_6-7-cronjob-cj" aria-hidden="true">#</a> 6.7 CronJob(CJ)</h3><p>CronJob æ§åˆ¶å™¨ä»¥ Job æ§åˆ¶å™¨èµ„æºä¸ºå…¶ç®¡æ§å¯¹è±¡ï¼Œå¹¶å€ŸåŠ©å®ƒç®¡ç† pod èµ„æºå¯¹è±¡ï¼ŒJob æ§åˆ¶å™¨å®šä¹‰çš„ä½œä¸šä»»åŠ¡åœ¨å…¶æ§åˆ¶å™¨èµ„æºåˆ›å»ºä¹‹åä¾¿ä¼šç«‹å³æ‰§è¡Œï¼Œä½† CronJob å¯ä»¥ä»¥ç±»ä¼¼äº Linux æ“ä½œç³»ç»Ÿçš„å‘¨æœŸæ€§ä»»åŠ¡ä½œä¸šè®¡åˆ’çš„æ–¹å¼æ§åˆ¶å…¶è¿è¡Œ <strong>æ—¶é—´ç‚¹</strong> åŠ <strong>é‡å¤è¿è¡Œ</strong> çš„æ–¹å¼ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ <strong>CronJob å¯ä»¥åœ¨ç‰¹å®šçš„æ—¶é—´ç‚¹(åå¤çš„)å»è¿è¡Œ job ä»»åŠ¡</strong> ã€‚</p><figure><img src="/assets/img/k8s/image-20200618213149531.png" alt="ç›¸å…³å›¾ç‰‡" tabindex="0" loading="lazy"><figcaption>ç›¸å…³å›¾ç‰‡</figcaption></figure><p>CronJob çš„èµ„æºæ¸…å•æ–‡ä»¶ï¼š</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> batch/v1beta1 <span class="token comment"># ç‰ˆæœ¬å·</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> CronJob <span class="token comment"># ç±»å‹       </span>
<span class="token key atrule">metadata</span><span class="token punctuation">:</span> <span class="token comment"># å…ƒæ•°æ®</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token comment"># rs åç§° </span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> <span class="token comment"># æ‰€å±å‘½åç©ºé—´ </span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span> <span class="token comment">#æ ‡ç­¾</span>
    <span class="token key atrule">controller</span><span class="token punctuation">:</span> cronjob
<span class="token key atrule">spec</span><span class="token punctuation">:</span> <span class="token comment"># è¯¦æƒ…æè¿°</span>
  <span class="token key atrule">schedule</span><span class="token punctuation">:</span> <span class="token comment"># cron æ ¼å¼çš„ä½œä¸šè°ƒåº¦è¿è¡Œæ—¶é—´ç‚¹,ç”¨äºæ§åˆ¶ä»»åŠ¡åœ¨ä»€ä¹ˆæ—¶é—´æ‰§è¡Œ</span>
  <span class="token key atrule">concurrencyPolicy</span><span class="token punctuation">:</span> <span class="token comment"># å¹¶å‘æ‰§è¡Œç­–ç•¥ï¼Œç”¨äºå®šä¹‰å‰ä¸€æ¬¡ä½œä¸šè¿è¡Œå°šæœªå®Œæˆæ—¶æ˜¯å¦ä»¥åŠå¦‚ä½•è¿è¡Œåä¸€æ¬¡çš„ä½œä¸š</span>
  <span class="token key atrule">failedJobHistoryLimit</span><span class="token punctuation">:</span> <span class="token comment"># ä¸ºå¤±è´¥çš„ä»»åŠ¡æ‰§è¡Œä¿ç•™çš„å†å²è®°å½•æ•°ï¼Œé»˜è®¤ä¸º 1</span>
  <span class="token key atrule">successfulJobHistoryLimit</span><span class="token punctuation">:</span> <span class="token comment"># ä¸ºæˆåŠŸçš„ä»»åŠ¡æ‰§è¡Œä¿ç•™çš„å†å²è®°å½•æ•°ï¼Œé»˜è®¤ä¸º 3</span>
  <span class="token key atrule">startingDeadlineSeconds</span><span class="token punctuation">:</span> <span class="token comment"># å¯åŠ¨ä½œä¸šé”™è¯¯çš„è¶…æ—¶æ—¶é•¿</span>
  <span class="token key atrule">jobTemplate</span><span class="token punctuation">:</span> <span class="token comment"># job æ§åˆ¶å™¨æ¨¡æ¿ï¼Œç”¨äºä¸º cronjob æ§åˆ¶å™¨ç”Ÿæˆ job å¯¹è±¡;ä¸‹é¢å…¶å®å°±æ˜¯ job çš„å®šä¹‰</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">completions</span><span class="token punctuation">:</span> <span class="token number">1</span>
      <span class="token key atrule">parallelism</span><span class="token punctuation">:</span> <span class="token number">1</span>
      <span class="token key atrule">activeDeadlineSeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>
      <span class="token key atrule">backoffLimit</span><span class="token punctuation">:</span> <span class="token number">6</span>
      <span class="token key atrule">manualSelector</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">selector</span><span class="token punctuation">:</span>
        <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
          <span class="token key atrule">app</span><span class="token punctuation">:</span> counter<span class="token punctuation">-</span>pod
        <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span> è§„åˆ™
          <span class="token punctuation">-</span> <span class="token punctuation">{</span><span class="token key atrule">key</span><span class="token punctuation">:</span> app<span class="token punctuation">,</span> <span class="token key atrule">operator</span><span class="token punctuation">:</span> In<span class="token punctuation">,</span> <span class="token key atrule">values</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>counter<span class="token punctuation">-</span>pod<span class="token punctuation">]</span><span class="token punctuation">}</span>
      <span class="token key atrule">template</span><span class="token punctuation">:</span>
        <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
          <span class="token key atrule">labels</span><span class="token punctuation">:</span>
            <span class="token key atrule">app</span><span class="token punctuation">:</span> counter<span class="token punctuation">-</span>pod
        <span class="token key atrule">spec</span><span class="token punctuation">:</span>
          <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Never 
          <span class="token key atrule">containers</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> counter
            <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.30</span>
            <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;bin/sh&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;-c&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;for i in 9 8 7 6 5 4 3 2 1; do echo $i;sleep 20;done&quot;</span><span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>éœ€è¦é‡ç‚¹è§£é‡Šçš„å‡ ä¸ªé€‰é¡¹ï¼š</p><div class="language-markdown line-numbers-mode" data-ext="md"><pre class="language-markdown"><code>schedule: cron è¡¨è¾¾å¼ï¼Œç”¨äºæŒ‡å®šä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´
    <span class="token italic"><span class="token punctuation">*</span><span class="token content">/1    </span><span class="token punctuation">*</span></span>      <span class="token italic"><span class="token punctuation">*</span><span class="token content">    </span><span class="token punctuation">*</span></span>     *
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>åˆ†é’Ÿ</span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>å°æ—¶</span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>æ—¥</span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>æœˆä»½</span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>æ˜ŸæœŸ</span><span class="token punctuation">&gt;</span></span>

<span class="token code keyword">    åˆ†é’Ÿ å€¼ä» 0 åˆ° 59.
    å°æ—¶ å€¼ä» 0 åˆ° 23.
    æ—¥ å€¼ä» 1 åˆ° 31.
    æœˆ å€¼ä» 1 åˆ° 12.
    æ˜ŸæœŸ å€¼ä» 0 åˆ° 6, 0 ä»£è¡¨æ˜ŸæœŸæ—¥
    å¤šä¸ªæ—¶é—´å¯ä»¥ç”¨é€—å·éš”å¼€ï¼› èŒƒå›´å¯ä»¥ç”¨è¿å­—ç¬¦ç»™å‡ºï¼›*å¯ä»¥ä½œä¸ºé€šé…ç¬¦ï¼› /è¡¨ç¤ºæ¯...</span>
concurrencyPolicy:
    Allow:   å…è®¸ Jobs å¹¶å‘è¿è¡Œ(é»˜è®¤)
    Forbid:  ç¦æ­¢å¹¶å‘è¿è¡Œï¼Œå¦‚æœä¸Šä¸€æ¬¡è¿è¡Œå°šæœªå®Œæˆï¼Œåˆ™è·³è¿‡ä¸‹ä¸€æ¬¡è¿è¡Œ
    Replace: æ›¿æ¢ï¼Œå–æ¶ˆå½“å‰æ­£åœ¨è¿è¡Œçš„ä½œä¸šå¹¶ç”¨æ–°ä½œä¸šæ›¿æ¢å®ƒ
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åˆ›å»º pc-cronjob.yamlï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> batch/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> CronJob
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pc<span class="token punctuation">-</span>cronjob
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">controller</span><span class="token punctuation">:</span> cronjob
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">schedule</span><span class="token punctuation">:</span> <span class="token string">&quot;*/1 * * * *&quot;</span>
  <span class="token key atrule">jobTemplate</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">template</span><span class="token punctuation">:</span>
        <span class="token key atrule">spec</span><span class="token punctuation">:</span>
          <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Never
          <span class="token key atrule">containers</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> counter
            <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.30</span>
            <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;bin/sh&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;-c&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;for i in 9 8 7 6 5 4 3 2 1; do echo $i;sleep 3;done&quot;</span><span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># åˆ›å»º cronjob</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pc-cronjob.yaml</span>
cronjob.batch/pc-cronjob created

<span class="token comment"># æŸ¥çœ‹ cronjob</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get cronjobs -n dev</span>
NAME         SCHEDULE      SUSPEND   ACTIVE   LAST SCHEDULE   AGE
pc-cronjob   */1 * * * *   False     <span class="token number">0</span>        <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>          6s

<span class="token comment"># æŸ¥çœ‹ job</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get jobs -n dev</span>
NAME                    COMPLETIONS   DURATION   AGE
pc-cronjob-1592587800   <span class="token number">1</span>/1           28s        3m26s
pc-cronjob-1592587860   <span class="token number">1</span>/1           28s        2m26s
pc-cronjob-1592587920   <span class="token number">1</span>/1           28s        86s

<span class="token comment"># æŸ¥çœ‹ pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev</span>
pc-cronjob-1592587800-x4tsm   <span class="token number">0</span>/1     Completed   <span class="token number">0</span>          2m24s
pc-cronjob-1592587860-r5gv4   <span class="token number">0</span>/1     Completed   <span class="token number">0</span>          84s
pc-cronjob-1592587920-9dxxq   <span class="token number">1</span>/1     Running     <span class="token number">0</span>          24s


<span class="token comment"># åˆ é™¤ cronjob</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl  delete -f pc-cronjob.yaml</span>
cronjob.batch <span class="token string">&quot;pc-cronjob&quot;</span> deleted
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_7-service-è¯¦è§£" tabindex="-1"><a class="header-anchor" href="#_7-service-è¯¦è§£" aria-hidden="true">#</a> 7. Service è¯¦è§£</h2><h3 id="_7-1-service-ä»‹ç»" tabindex="-1"><a class="header-anchor" href="#_7-1-service-ä»‹ç»" aria-hidden="true">#</a> 7.1 Service ä»‹ç»</h3><p>åœ¨ kubernetes ä¸­ï¼Œpod æ˜¯åº”ç”¨ç¨‹åºçš„è½½ä½“ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ pod çš„ ip æ¥è®¿é—®åº”ç”¨ç¨‹åºï¼Œä½†æ˜¯ pod çš„ ip åœ°å€ä¸æ˜¯å›ºå®šçš„ï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€ä¸æ–¹ä¾¿ç›´æ¥é‡‡ç”¨ pod çš„ ip å¯¹æœåŠ¡è¿›è¡Œè®¿é—®ã€‚</p><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œkubernetes æä¾›äº† Service èµ„æºï¼ŒService ä¼šå¯¹æä¾›åŒä¸€ä¸ªæœåŠ¡çš„å¤šä¸ª pod è¿›è¡Œèšåˆï¼Œå¹¶ä¸”æä¾›ä¸€ä¸ªç»Ÿä¸€çš„å…¥å£åœ°å€ã€‚é€šè¿‡è®¿é—® Service çš„å…¥å£åœ°å€å°±èƒ½è®¿é—®åˆ°åé¢çš„ pod æœåŠ¡ã€‚</p><figure><img src="/assets/img/k8s/image-20200408194716912-1626783758946.png" alt="ç›¸å…³å›¾ç‰‡" tabindex="0" loading="lazy"><figcaption>ç›¸å…³å›¾ç‰‡</figcaption></figure><p>Service åœ¨å¾ˆå¤šæƒ…å†µä¸‹åªæ˜¯ä¸€ä¸ªæ¦‚å¿µï¼ŒçœŸæ­£èµ·ä½œç”¨çš„å…¶å®æ˜¯ kube-proxy æœåŠ¡è¿›ç¨‹ï¼Œæ¯ä¸ª Node èŠ‚ç‚¹ä¸Šéƒ½è¿è¡Œç€ä¸€ä¸ª kube-proxy æœåŠ¡è¿›ç¨‹ã€‚å½“åˆ›å»º Service çš„æ—¶å€™ä¼šé€šè¿‡ api-server å‘ etcd å†™å…¥åˆ›å»ºçš„ service çš„ä¿¡æ¯ï¼Œè€Œ kube-proxy ä¼šåŸºäºç›‘å¬çš„æœºåˆ¶å‘ç°è¿™ç§ Service çš„å˜åŠ¨ï¼Œç„¶å <strong>å®ƒä¼šå°†æœ€æ–°çš„ Service ä¿¡æ¯è½¬æ¢æˆå¯¹åº”çš„è®¿é—®è§„åˆ™</strong> ã€‚</p><figure><img src="/assets/img/k8s/image-20200509121254425.png" alt="ç›¸å…³å›¾ç‰‡" tabindex="0" loading="lazy"><figcaption>ç›¸å…³å›¾ç‰‡</figcaption></figure><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code># 10.97.97.97:80 æ˜¯ service æä¾›çš„è®¿é—®å…¥å£
# å½“è®¿é—®è¿™ä¸ªå…¥å£çš„æ—¶å€™ï¼Œå¯ä»¥å‘ç°åé¢æœ‰ä¸‰ä¸ª pod çš„æœåŠ¡åœ¨ç­‰å¾…è°ƒç”¨ï¼Œ
# kube-proxy ä¼šåŸºäº rrï¼ˆè½®è¯¢ï¼‰çš„ç­–ç•¥ï¼Œå°†è¯·æ±‚åˆ†å‘åˆ°å…¶ä¸­ä¸€ä¸ª pod ä¸Šå»
# è¿™ä¸ªè§„åˆ™ä¼šåŒæ—¶åœ¨é›†ç¾¤å†…çš„æ‰€æœ‰èŠ‚ç‚¹ä¸Šéƒ½ç”Ÿæˆï¼Œæ‰€ä»¥åœ¨ä»»ä½•ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè®¿é—®éƒ½å¯ä»¥ã€‚
[root@node1 ~]# ipvsadm -Ln
IP Virtual Server version 1.2.1 (size=4096)
Prot LocalAddress:Port Scheduler Flags
  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn
TCP  10.97.97.97:80 rr
  -&gt; 10.244.1.39:80               Masq    1      0          0
  -&gt; 10.244.1.40:80               Masq    1      0          0
  -&gt; 10.244.2.33:80               Masq    1      0          0
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>kube-proxy ç›®å‰æ”¯æŒä¸‰ç§å·¥ä½œæ¨¡å¼:</p><p>kube-proxy ç›®å‰æ”¯æŒä¸‰ç§å·¥ä½œæ¨¡å¼:</p><h4 id="_7-1-1-userspace-æ¨¡å¼" tabindex="-1"><a class="header-anchor" href="#_7-1-1-userspace-æ¨¡å¼" aria-hidden="true">#</a> 7.1.1 userspace æ¨¡å¼</h4><p>userspace æ¨¡å¼ä¸‹ï¼Œkube-proxy ä¼šä¸ºæ¯ä¸€ä¸ª Service åˆ›å»ºä¸€ä¸ªç›‘å¬ç«¯å£ï¼Œå‘å‘ Cluster IP çš„è¯·æ±‚è¢« Iptables è§„åˆ™é‡å®šå‘åˆ° kube-proxy ç›‘å¬çš„ç«¯å£ä¸Šï¼Œkube-proxy æ ¹æ® LB ç®—æ³•é€‰æ‹©ä¸€ä¸ªæä¾›æœåŠ¡çš„ Pod å¹¶å’Œå…¶å»ºç«‹é“¾æ¥ï¼Œä»¥å°†è¯·æ±‚è½¬å‘åˆ° Pod ä¸Šã€‚ è¯¥æ¨¡å¼ä¸‹ï¼Œkube-proxy å……å½“äº†ä¸€ä¸ªå››å±‚è´Ÿè´£å‡è¡¡å™¨çš„è§’è‰²ã€‚ç”±äº kube-proxy è¿è¡Œåœ¨ userspace ä¸­ï¼Œåœ¨è¿›è¡Œè½¬å‘å¤„ç†æ—¶ä¼šå¢åŠ å†…æ ¸å’Œç”¨æˆ·ç©ºé—´ä¹‹é—´çš„æ•°æ®æ‹·è´ï¼Œè™½ç„¶æ¯”è¾ƒç¨³å®šï¼Œä½†æ˜¯æ•ˆç‡æ¯”è¾ƒä½ã€‚</p><figure><img src="/assets/img/k8s/image-20200509151424280.png" alt="ç›¸å…³å›¾ç‰‡" height="300" tabindex="0" loading="lazy"><figcaption>ç›¸å…³å›¾ç‰‡</figcaption></figure><h4 id="_7-1-2-iptables-æ¨¡å¼" tabindex="-1"><a class="header-anchor" href="#_7-1-2-iptables-æ¨¡å¼" aria-hidden="true">#</a> 7.1.2 iptables æ¨¡å¼</h4><p>iptables æ¨¡å¼ä¸‹ï¼Œkube-proxy ä¸º service åç«¯çš„æ¯ä¸ª Pod åˆ›å»ºå¯¹åº”çš„ iptables è§„åˆ™ï¼Œç›´æ¥å°†å‘å‘ Cluster IP çš„è¯·æ±‚é‡å®šå‘åˆ°ä¸€ä¸ª Pod IPã€‚ è¯¥æ¨¡å¼ä¸‹ kube-proxy ä¸æ‰¿æ‹…å››å±‚è´Ÿè´£å‡è¡¡å™¨çš„è§’è‰²ï¼Œåªè´Ÿè´£åˆ›å»º iptables è§„åˆ™ã€‚è¯¥æ¨¡å¼çš„ä¼˜ç‚¹æ˜¯è¾ƒ userspace æ¨¡å¼æ•ˆç‡æ›´é«˜ï¼Œä½†ä¸èƒ½æä¾›çµæ´»çš„ LB ç­–ç•¥ï¼Œå½“åç«¯ Pod ä¸å¯ç”¨æ—¶ä¹Ÿæ— æ³•è¿›è¡Œé‡è¯•ã€‚</p><figure><img src="/assets/img/k8s/image-20200509152947714.png" alt="ç›¸å…³å›¾ç‰‡" height="300" tabindex="0" loading="lazy"><figcaption>ç›¸å…³å›¾ç‰‡</figcaption></figure><h4 id="_7-1-3-ipvs-æ¨¡å¼" tabindex="-1"><a class="header-anchor" href="#_7-1-3-ipvs-æ¨¡å¼" aria-hidden="true">#</a> 7.1.3 ipvs æ¨¡å¼</h4><p>ipvs æ¨¡å¼å’Œ iptables ç±»ä¼¼ï¼Œkube-proxy ç›‘æ§ Pod çš„å˜åŒ–å¹¶åˆ›å»ºç›¸åº”çš„ ipvs è§„åˆ™ã€‚ipvs ç›¸å¯¹ iptables è½¬å‘æ•ˆç‡æ›´é«˜ã€‚é™¤æ­¤ä»¥å¤–ï¼Œipvs æ”¯æŒæ›´å¤šçš„ LB ç®—æ³•ã€‚</p><figure><img src="/assets/img/k8s/image-20200509153731363.png" alt="ç›¸å…³å›¾ç‰‡" height="300" tabindex="0" loading="lazy"><figcaption>ç›¸å…³å›¾ç‰‡</figcaption></figure><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># æ­¤æ¨¡å¼å¿…é¡»å®‰è£… ipvs å†…æ ¸æ¨¡å—ï¼Œå¦åˆ™ä¼šé™çº§ä¸º iptables</span>
<span class="token comment"># å¼€å¯ ipvs</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl edit cm kube-proxy -n kube-system</span>
<span class="token comment"># ä¿®æ”¹ mode: &quot;ipvs&quot;</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete pod -l k8s-app=kube-proxy -n kube-system</span>
<span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span><span class="token comment"># ipvsadm -Ln</span>
IP Virtual Server version <span class="token number">1.2</span>.1 <span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">4096</span><span class="token punctuation">)</span>
Prot LocalAddress:Port Scheduler Flags
  -<span class="token operator">&gt;</span> RemoteAddress:Port           Forward Weight ActiveConn InActConn
TCP  <span class="token number">10.97</span>.97.97:80 rr
  -<span class="token operator">&gt;</span> <span class="token number">10.244</span>.1.39:80               Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span>
  -<span class="token operator">&gt;</span> <span class="token number">10.244</span>.1.40:80               Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span>
  -<span class="token operator">&gt;</span> <span class="token number">10.244</span>.2.33:80               Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-2-service-ç±»å‹" tabindex="-1"><a class="header-anchor" href="#_7-2-service-ç±»å‹" aria-hidden="true">#</a> 7.2 Service ç±»å‹</h3><p>Service çš„èµ„æºæ¸…å•æ–‡ä»¶ï¼š</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">kind</span><span class="token punctuation">:</span> Service  <span class="token comment"># èµ„æºç±»å‹</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1  <span class="token comment"># èµ„æºç‰ˆæœ¬</span>
<span class="token key atrule">metadata</span><span class="token punctuation">:</span> <span class="token comment"># å…ƒæ•°æ®</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> service <span class="token comment"># èµ„æºåç§°</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev <span class="token comment"># å‘½åç©ºé—´</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span> <span class="token comment"># æè¿°</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span> <span class="token comment"># æ ‡ç­¾é€‰æ‹©å™¨ï¼Œç”¨äºç¡®å®šå½“å‰ service ä»£ç†å“ªäº› pod</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">type</span><span class="token punctuation">:</span> <span class="token comment"># Service ç±»å‹ï¼ŒæŒ‡å®š service çš„è®¿é—®æ–¹å¼</span>
  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span>  <span class="token comment"># è™šæ‹ŸæœåŠ¡çš„ ip åœ°å€</span>
  <span class="token key atrule">sessionAffinity</span><span class="token punctuation">:</span> <span class="token comment"># session äº²å’Œæ€§ï¼Œæ”¯æŒ ClientIPã€None ä¸¤ä¸ªé€‰é¡¹</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span> <span class="token comment"># ç«¯å£ä¿¡æ¯</span>
    <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP 
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3017</span>  <span class="token comment"># service ç«¯å£</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">5003</span> <span class="token comment"># pod ç«¯å£</span>
      <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">31122</span> <span class="token comment"># ä¸»æœºç«¯å£</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>ClusterIPï¼šé»˜è®¤å€¼ï¼Œå®ƒæ˜¯ Kubernetes ç³»ç»Ÿè‡ªåŠ¨åˆ†é…çš„è™šæ‹Ÿ IPï¼Œåªèƒ½åœ¨é›†ç¾¤å†…éƒ¨è®¿é—®</li><li>NodePortï¼šå°† Service é€šè¿‡æŒ‡å®šçš„ Node ä¸Šçš„ç«¯å£æš´éœ²ç»™å¤–éƒ¨ï¼Œé€šè¿‡æ­¤æ–¹æ³•ï¼Œå°±å¯ä»¥åœ¨é›†ç¾¤å¤–éƒ¨è®¿é—®æœåŠ¡</li><li>LoadBalancerï¼šä½¿ç”¨å¤–æ¥è´Ÿè½½å‡è¡¡å™¨å®Œæˆåˆ°æœåŠ¡çš„è´Ÿè½½åˆ†å‘ï¼Œæ³¨æ„æ­¤æ¨¡å¼éœ€è¦å¤–éƒ¨äº‘ç¯å¢ƒæ”¯æŒ</li><li>ExternalNameï¼š æŠŠé›†ç¾¤å¤–éƒ¨çš„æœåŠ¡å¼•å…¥é›†ç¾¤å†…éƒ¨ï¼Œç›´æ¥ä½¿ç”¨</li></ul><h3 id="_7-3-service-ä½¿ç”¨" tabindex="-1"><a class="header-anchor" href="#_7-3-service-ä½¿ç”¨" aria-hidden="true">#</a> 7.3 Service ä½¿ç”¨</h3><h4 id="_7-3-1-å®éªŒç¯å¢ƒå‡†å¤‡" tabindex="-1"><a class="header-anchor" href="#_7-3-1-å®éªŒç¯å¢ƒå‡†å¤‡" aria-hidden="true">#</a> 7.3.1 å®éªŒç¯å¢ƒå‡†å¤‡</h4><p>åœ¨ä½¿ç”¨ service ä¹‹å‰ï¼Œé¦–å…ˆåˆ©ç”¨ Deployment åˆ›å»ºå‡º 3 ä¸ª podï¼Œæ³¨æ„è¦ä¸º pod è®¾ç½®<code>app=nginx-pod</code>çš„æ ‡ç­¾</p><p>åˆ›å»º deployment.yamlï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment      
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pc<span class="token punctuation">-</span>deployment
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span> 
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f deployment.yaml</span>
deployment.apps/pc-deployment created

<span class="token comment"># æŸ¥çœ‹ pod è¯¦æƒ…</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev -o wide --show-labels</span>
NAME                             READY   STATUS     IP            NODE     LABELS
pc-deployment-66cb59b984-8p84h   <span class="token number">1</span>/1     Running    <span class="token number">10.244</span>.1.39   node1    <span class="token assign-left variable">app</span><span class="token operator">=</span>nginx-pod
pc-deployment-66cb59b984-vx8vx   <span class="token number">1</span>/1     Running    <span class="token number">10.244</span>.2.33   node2    <span class="token assign-left variable">app</span><span class="token operator">=</span>nginx-pod
pc-deployment-66cb59b984-wnncx   <span class="token number">1</span>/1     Running    <span class="token number">10.244</span>.1.40   node1    <span class="token assign-left variable">app</span><span class="token operator">=</span>nginx-pod

<span class="token comment"># ä¸ºäº†æ–¹ä¾¿åé¢çš„æµ‹è¯•ï¼Œä¿®æ”¹ä¸‹ä¸‰å° nginx çš„ index.html é¡µé¢ï¼ˆä¸‰å°ä¿®æ”¹çš„ IP åœ°å€ä¸ä¸€è‡´ï¼‰</span>
<span class="token comment"># kubectl exec -it pc-deployment-66cb59b984-8p84h -n dev /bin/sh</span>
<span class="token comment"># echo &quot;10.244.1.39&quot; &gt; /usr/share/nginx/html/index.html</span>

<span class="token comment">#ä¿®æ”¹å®Œæ¯•ä¹‹åï¼Œè®¿é—®æµ‹è¯•</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># curl 10.244.1.39</span>
<span class="token number">10.244</span>.1.39
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># curl 10.244.2.33</span>
<span class="token number">10.244</span>.2.33
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># curl 10.244.1.40</span>
<span class="token number">10.244</span>.1.40
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_7-3-2-clusterip-ç±»å‹çš„-service" tabindex="-1"><a class="header-anchor" href="#_7-3-2-clusterip-ç±»å‹çš„-service" aria-hidden="true">#</a> 7.3.2 ClusterIP ç±»å‹çš„ Service</h4><p>åˆ›å»º service-clusterip.yaml æ–‡ä»¶</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> service<span class="token punctuation">-</span>clusterip
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> 10.97.97.97 <span class="token comment"># service çš„ ip åœ°å€ï¼Œå¦‚æœä¸å†™ï¼Œé»˜è®¤ä¼šç”Ÿæˆä¸€ä¸ª</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>  <span class="token comment"># Service ç«¯å£       </span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span> <span class="token comment"># pod ç«¯å£</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># åˆ›å»º service</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f service-clusterip.yaml</span>
service/service-clusterip created

<span class="token comment"># æŸ¥çœ‹ service</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get svc -n dev -o wide</span>
NAME                TYPE        CLUSTER-IP    EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>   AGE   SELECTOR
service-clusterip   ClusterIP   <span class="token number">10.97</span>.97.97   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">80</span>/TCP    13s   <span class="token assign-left variable">app</span><span class="token operator">=</span>nginx-pod

<span class="token comment"># æŸ¥çœ‹ service çš„è¯¦ç»†ä¿¡æ¯</span>
<span class="token comment"># åœ¨è¿™é‡Œæœ‰ä¸€ä¸ª Endpoints åˆ—è¡¨ï¼Œé‡Œé¢å°±æ˜¯å½“å‰ service å¯ä»¥è´Ÿè½½åˆ°çš„æœåŠ¡å…¥å£</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl describe svc service-clusterip -n dev</span>
Name:              service-clusterip
Namespace:         dev
Labels:            <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
Annotations:       <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
Selector:          <span class="token assign-left variable">app</span><span class="token operator">=</span>nginx-pod
Type:              ClusterIP
IP:                <span class="token number">10.97</span>.97.97
Port:              <span class="token operator">&lt;</span>unset<span class="token operator">&gt;</span>  <span class="token number">80</span>/TCP
TargetPort:        <span class="token number">80</span>/TCP
Endpoints:         <span class="token number">10.244</span>.1.39:80,10.244.1.40:80,10.244.2.33:80
Session Affinity:  None
Events:            <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>

<span class="token comment"># æŸ¥çœ‹ ipvs çš„æ˜ å°„è§„åˆ™</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># ipvsadm -Ln</span>
TCP  <span class="token number">10.97</span>.97.97:80 rr
  -<span class="token operator">&gt;</span> <span class="token number">10.244</span>.1.39:80               Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span>
  -<span class="token operator">&gt;</span> <span class="token number">10.244</span>.1.40:80               Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span>
  -<span class="token operator">&gt;</span> <span class="token number">10.244</span>.2.33:80               Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span>

<span class="token comment"># è®¿é—® 10.97.97.97:80 è§‚å¯Ÿæ•ˆæœ</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># curl 10.97.97.97:80</span>
<span class="token number">10.244</span>.2.33
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_7-3-3-endpoint" tabindex="-1"><a class="header-anchor" href="#_7-3-3-endpoint" aria-hidden="true">#</a> 7.3.3 Endpoint</h4><p>Endpoint æ˜¯ kubernetes ä¸­çš„ä¸€ä¸ªèµ„æºå¯¹è±¡ï¼Œå­˜å‚¨åœ¨ etcd ä¸­ï¼Œç”¨æ¥è®°å½•ä¸€ä¸ª service å¯¹åº”çš„æ‰€æœ‰ pod çš„è®¿é—®åœ°å€ï¼Œå®ƒæ˜¯æ ¹æ® service é…ç½®æ–‡ä»¶ä¸­ selector æè¿°äº§ç”Ÿçš„ã€‚</p><p>ä¸€ä¸ª Service ç”±ä¸€ç»„ Pod ç»„æˆï¼Œè¿™äº› Pod é€šè¿‡ Endpoints æš´éœ²å‡ºæ¥ï¼Œ <strong>Endpoints æ˜¯å®ç°å®é™…æœåŠ¡çš„ç«¯ç‚¹é›†åˆ</strong> ã€‚æ¢å¥è¯è¯´ï¼Œservice å’Œ pod ä¹‹é—´çš„è”ç³»æ˜¯é€šè¿‡ endpoints å®ç°çš„ã€‚</p><figure><img src="/assets/img/k8s/image-20200509191917069.png" alt="ç›¸å…³å›¾ç‰‡" tabindex="0" loading="lazy"><figcaption>ç›¸å…³å›¾ç‰‡</figcaption></figure><p><strong>è´Ÿè½½åˆ†å‘ç­–ç•¥</strong></p><p>å¯¹ Service çš„è®¿é—®è¢«åˆ†å‘åˆ°äº†åç«¯çš„ Pod ä¸Šå»ï¼Œç›®å‰ kubernetes æä¾›äº†ä¸¤ç§è´Ÿè½½åˆ†å‘ç­–ç•¥ï¼š</p><ul><li><p>å¦‚æœä¸å®šä¹‰ï¼Œé»˜è®¤ä½¿ç”¨ kube-proxy çš„ç­–ç•¥ï¼Œæ¯”å¦‚éšæœºã€è½®è¯¢</p></li><li><p>åŸºäºå®¢æˆ·ç«¯åœ°å€çš„ä¼šè¯ä¿æŒæ¨¡å¼ï¼Œå³æ¥è‡ªåŒä¸€ä¸ªå®¢æˆ·ç«¯å‘èµ·çš„æ‰€æœ‰è¯·æ±‚éƒ½ä¼šè½¬å‘åˆ°å›ºå®šçš„ä¸€ä¸ª Pod ä¸Š</p><p>æ­¤æ¨¡å¼å¯ä»¥ä½¿åœ¨ spec ä¸­æ·»åŠ <code>sessionAffinity:ClientIP</code>é€‰é¡¹</p></li></ul><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># æŸ¥çœ‹ ipvs çš„æ˜ å°„è§„åˆ™ã€rr è½®è¯¢ã€‘</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># ipvsadm -Ln</span>
TCP  <span class="token number">10.97</span>.97.97:80 rr
  -<span class="token operator">&gt;</span> <span class="token number">10.244</span>.1.39:80               Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span>
  -<span class="token operator">&gt;</span> <span class="token number">10.244</span>.1.40:80               Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span>
  -<span class="token operator">&gt;</span> <span class="token number">10.244</span>.2.33:80               Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span>

<span class="token comment"># å¾ªç¯è®¿é—®æµ‹è¯•</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># while true;do curl 10.97.97.97:80; sleep 5; done;</span>
<span class="token number">10.244</span>.1.40
<span class="token number">10.244</span>.1.39
<span class="token number">10.244</span>.2.33
<span class="token number">10.244</span>.1.40
<span class="token number">10.244</span>.1.39
<span class="token number">10.244</span>.2.33

<span class="token comment"># ä¿®æ”¹åˆ†å‘ç­–ç•¥----sessionAffinity:ClientIP</span>

<span class="token comment"># æŸ¥çœ‹ ipvs è§„åˆ™ã€persistent ä»£è¡¨æŒä¹…ã€‘</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># ipvsadm -Ln</span>
TCP  <span class="token number">10.97</span>.97.97:80 rr persistent <span class="token number">10800</span>
  -<span class="token operator">&gt;</span> <span class="token number">10.244</span>.1.39:80               Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span>
  -<span class="token operator">&gt;</span> <span class="token number">10.244</span>.1.40:80               Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span>
  -<span class="token operator">&gt;</span> <span class="token number">10.244</span>.2.33:80               Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span>

<span class="token comment"># å¾ªç¯è®¿é—®æµ‹è¯•</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># while true;do curl 10.97.97.97; sleep 5; done;</span>
<span class="token number">10.244</span>.2.33
<span class="token number">10.244</span>.2.33
<span class="token number">10.244</span>.2.33
  
<span class="token comment"># åˆ é™¤ service</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete -f service-clusterip.yaml</span>
<span class="token function">service</span> <span class="token string">&quot;service-clusterip&quot;</span> deleted
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_7-3-4-headliness-ç±»å‹çš„-service" tabindex="-1"><a class="header-anchor" href="#_7-3-4-headliness-ç±»å‹çš„-service" aria-hidden="true">#</a> 7.3.4 HeadLiness ç±»å‹çš„ Service</h4><p>åœ¨æŸäº›åœºæ™¯ä¸­ï¼Œå¼€å‘äººå‘˜å¯èƒ½ä¸æƒ³ä½¿ç”¨ Service æä¾›çš„è´Ÿè½½å‡è¡¡åŠŸèƒ½ï¼Œè€Œå¸Œæœ›è‡ªå·±æ¥æ§åˆ¶è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œé’ˆå¯¹è¿™ç§æƒ…å†µï¼Œkubernetes æä¾›äº† HeadLiness Serviceï¼Œè¿™ç±» Service ä¸ä¼šåˆ†é… Cluster IPï¼Œå¦‚æœæƒ³è¦è®¿é—® serviceï¼Œåªèƒ½é€šè¿‡ service çš„åŸŸåè¿›è¡ŒæŸ¥è¯¢ã€‚</p><p>åˆ›å»º service-headliness.yaml</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> service<span class="token punctuation">-</span>headliness
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> None <span class="token comment"># å°† clusterIP è®¾ç½®ä¸º Noneï¼Œå³å¯åˆ›å»º headliness Service</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>    
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># åˆ›å»º service</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f service-headliness.yaml</span>
service/service-headliness created

<span class="token comment"># è·å– serviceï¼Œ å‘ç° CLUSTER-IP æœªåˆ†é…</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get svc service-headliness -n dev -o wide</span>
NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>   AGE   SELECTOR
service-headliness   ClusterIP   None         <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">80</span>/TCP    11s   <span class="token assign-left variable">app</span><span class="token operator">=</span>nginx-pod

<span class="token comment"># æŸ¥çœ‹ service è¯¦æƒ…</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl describe svc service-headliness  -n dev</span>
Name:              service-headliness
Namespace:         dev
Labels:            <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
Annotations:       <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
Selector:          <span class="token assign-left variable">app</span><span class="token operator">=</span>nginx-pod
Type:              ClusterIP
IP:                None
Port:              <span class="token operator">&lt;</span>unset<span class="token operator">&gt;</span>  <span class="token number">80</span>/TCP
TargetPort:        <span class="token number">80</span>/TCP
Endpoints:         <span class="token number">10.244</span>.1.39:80,10.244.1.40:80,10.244.2.33:80
Session Affinity:  None
Events:            <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>

<span class="token comment"># æŸ¥çœ‹åŸŸåçš„è§£ææƒ…å†µ</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl exec -it pc-deployment-66cb59b984-8p84h -n dev /bin/sh</span>
/ <span class="token comment"># cat /etc/resolv.conf</span>
nameserver <span class="token number">10.96</span>.0.10
search dev.svc.cluster.local svc.cluster.local cluster.local

<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># dig @10.96.0.10 service-headliness.dev.svc.cluster.local</span>
service-headliness.dev.svc.cluster.local. <span class="token number">30</span> IN A <span class="token number">10.244</span>.1.40
service-headliness.dev.svc.cluster.local. <span class="token number">30</span> IN A <span class="token number">10.244</span>.1.39
service-headliness.dev.svc.cluster.local. <span class="token number">30</span> IN A <span class="token number">10.244</span>.2.33
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_7-3-5-nodeport-ç±»å‹çš„-service" tabindex="-1"><a class="header-anchor" href="#_7-3-5-nodeport-ç±»å‹çš„-service" aria-hidden="true">#</a> 7.3.5 NodePort ç±»å‹çš„ Service</h4><p>åœ¨ä¹‹å‰çš„æ ·ä¾‹ä¸­ï¼Œåˆ›å»ºçš„ Service çš„ ip åœ°å€åªæœ‰é›†ç¾¤å†…éƒ¨æ‰å¯ä»¥è®¿é—®ï¼Œå¦‚æœå¸Œæœ›å°† Service æš´éœ²ç»™é›†ç¾¤å¤–éƒ¨ä½¿ç”¨ï¼Œé‚£ä¹ˆå°±è¦ä½¿ç”¨åˆ°å¦å¤–ä¸€ç§ç±»å‹çš„ Serviceï¼Œç§°ä¸º NodePort ç±»å‹ã€‚NodePort çš„å·¥ä½œåŸç†å…¶å®å°±æ˜¯ <strong>å°† service çš„ç«¯å£æ˜ å°„åˆ° Node çš„ä¸€ä¸ªç«¯å£ä¸Š</strong> ï¼Œç„¶åå°±å¯ä»¥é€šè¿‡<code>NodeIp:NodePort</code>æ¥è®¿é—® service äº†ã€‚</p><figure><img src="/assets/img/k8s/image-20200620175731338.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>åˆ›å»º service-nodeport.yaml</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> service<span class="token punctuation">-</span>nodeport
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort <span class="token comment"># service ç±»å‹</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">30002</span> <span class="token comment"># æŒ‡å®šç»‘å®šçš„ node çš„ç«¯å£(é»˜è®¤çš„å–å€¼èŒƒå›´æ˜¯ï¼š30000-32767), å¦‚æœä¸æŒ‡å®šï¼Œä¼šé»˜è®¤åˆ†é…</span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># åˆ›å»º service</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f service-nodeport.yaml</span>
service/service-nodeport created

<span class="token comment"># æŸ¥çœ‹ service</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get svc -n dev -o wide</span>
NAME               TYPE       CLUSTER-IP      EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>       SELECTOR
service-nodeport   NodePort   <span class="token number">10.105</span>.64.191   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">80</span>:30002/TCP  <span class="token assign-left variable">app</span><span class="token operator">=</span>nginx-pod

<span class="token comment"># æ¥ä¸‹æ¥å¯ä»¥é€šè¿‡ç”µè„‘ä¸»æœºçš„æµè§ˆå™¨å»è®¿é—®é›†ç¾¤ä¸­ä»»æ„ä¸€ä¸ª nodeip çš„ 30002 ç«¯å£ï¼Œå³å¯è®¿é—®åˆ° pod</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_7-3-6-loadbalancer-ç±»å‹çš„-service" tabindex="-1"><a class="header-anchor" href="#_7-3-6-loadbalancer-ç±»å‹çš„-service" aria-hidden="true">#</a> 7.3.6 LoadBalancer ç±»å‹çš„ Service</h4><p>LoadBalancer å’Œ NodePort å¾ˆç›¸ä¼¼ï¼Œç›®çš„éƒ½æ˜¯å‘å¤–éƒ¨æš´éœ²ä¸€ä¸ªç«¯å£ï¼ŒåŒºåˆ«åœ¨äº LoadBalancer ä¼šåœ¨é›†ç¾¤çš„å¤–éƒ¨å†æ¥åšä¸€ä¸ªè´Ÿè½½å‡è¡¡è®¾å¤‡ï¼Œè€Œè¿™ä¸ªè®¾å¤‡éœ€è¦å¤–éƒ¨ç¯å¢ƒæ”¯æŒçš„ï¼Œå¤–éƒ¨æœåŠ¡å‘é€åˆ°è¿™ä¸ªè®¾å¤‡ä¸Šçš„è¯·æ±‚ï¼Œä¼šè¢«è®¾å¤‡è´Ÿè½½ä¹‹åè½¬å‘åˆ°é›†ç¾¤ä¸­ã€‚</p><figure><img src="/assets/img/k8s/image-20200510103945494.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><h4 id="_7-3-7-externalname-ç±»å‹çš„-service" tabindex="-1"><a class="header-anchor" href="#_7-3-7-externalname-ç±»å‹çš„-service" aria-hidden="true">#</a> 7.3.7 ExternalName ç±»å‹çš„ Service</h4><p>ExternalName ç±»å‹çš„ Service ç”¨äºå¼•å…¥é›†ç¾¤å¤–éƒ¨çš„æœåŠ¡ï¼Œå®ƒé€šè¿‡<code>externalName</code>å±æ€§æŒ‡å®šå¤–éƒ¨ä¸€ä¸ªæœåŠ¡çš„åœ°å€ï¼Œç„¶ååœ¨é›†ç¾¤å†…éƒ¨è®¿é—®æ­¤ service å°±å¯ä»¥è®¿é—®åˆ°å¤–éƒ¨çš„æœåŠ¡äº†ã€‚</p><figure><img src="/assets/img/k8s/image-20200510113311209.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>apiVersion: v1
kind: Service
metadata:
  name: service-externalname
  namespace: dev
spec:
  type: ExternalName <span class="token comment"># service ç±»å‹</span>
  externalName: www.baidu.com  <span class="token comment">#æ”¹æˆ ip åœ°å€ä¹Ÿå¯ä»¥</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># åˆ›å»º service</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl  create -f service-externalname.yaml</span>
service/service-externalname created

<span class="token comment"># åŸŸåè§£æ</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># dig @10.96.0.10 service-externalname.dev.svc.cluster.local</span>
service-externalname.dev.svc.cluster.local. <span class="token number">30</span> IN CNAME www.baidu.com.
www.baidu.com.          <span class="token number">30</span>      IN      CNAME   www.a.shifen.com.
www.a.shifen.com.       <span class="token number">30</span>      IN      A       <span class="token number">39.156</span>.66.18
www.a.shifen.com.       <span class="token number">30</span>      IN      A       <span class="token number">39.156</span>.66.14
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-4-ingress-ä»‹ç»" tabindex="-1"><a class="header-anchor" href="#_7-4-ingress-ä»‹ç»" aria-hidden="true">#</a> 7.4 Ingress ä»‹ç»</h3><p>åœ¨å‰é¢è¯¾ç¨‹ä¸­å·²ç»æåˆ°ï¼ŒService å¯¹é›†ç¾¤ä¹‹å¤–æš´éœ²æœåŠ¡çš„ä¸»è¦æ–¹å¼æœ‰ä¸¤ç§ï¼šNotePort å’Œ LoadBalancerï¼Œä½†æ˜¯è¿™ä¸¤ç§æ–¹å¼ï¼Œéƒ½æœ‰ä¸€å®šçš„ç¼ºç‚¹ï¼š</p><ul><li>NodePort æ–¹å¼çš„ç¼ºç‚¹æ˜¯ä¼šå ç”¨å¾ˆå¤šé›†ç¾¤æœºå™¨çš„ç«¯å£ï¼Œé‚£ä¹ˆå½“é›†ç¾¤æœåŠ¡å˜å¤šçš„æ—¶å€™ï¼Œè¿™ä¸ªç¼ºç‚¹å°±æ„ˆå‘æ˜æ˜¾</li><li>LB æ–¹å¼çš„ç¼ºç‚¹æ˜¯æ¯ä¸ª service éœ€è¦ä¸€ä¸ª LBï¼Œæµªè´¹ã€éº»çƒ¦ï¼Œå¹¶ä¸”éœ€è¦ kubernetes ä¹‹å¤–è®¾å¤‡çš„æ”¯æŒ</li></ul><p>åŸºäºè¿™ç§ç°çŠ¶ï¼Œkubernetes æä¾›äº† Ingress èµ„æºå¯¹è±¡ï¼ŒIngress åªéœ€è¦ä¸€ä¸ª NodePort æˆ–è€…ä¸€ä¸ª LB å°±å¯ä»¥æ»¡è¶³æš´éœ²å¤šä¸ª Service çš„éœ€æ±‚ã€‚å·¥ä½œæœºåˆ¶å¤§è‡´å¦‚ä¸‹å›¾è¡¨ç¤ºï¼š</p><figure><img src="/assets/img/k8s/image-20200623092808049.png" alt="ç›¸å…³å›¾ç‰‡" tabindex="0" loading="lazy"><figcaption>ç›¸å…³å›¾ç‰‡</figcaption></figure><p>å®é™…ä¸Šï¼ŒIngress ç›¸å½“äºä¸€ä¸ª 7 å±‚çš„è´Ÿè½½å‡è¡¡å™¨ï¼Œæ˜¯ kubernetes å¯¹åå‘ä»£ç†çš„ä¸€ä¸ªæŠ½è±¡ï¼Œå®ƒçš„å·¥ä½œåŸç†ç±»ä¼¼äº Nginxï¼Œå¯ä»¥ç†è§£æˆåœ¨ <strong>Ingress é‡Œå»ºç«‹è¯¸å¤šæ˜ å°„è§„åˆ™ï¼ŒIngress Controller é€šè¿‡ç›‘å¬è¿™äº›é…ç½®è§„åˆ™å¹¶è½¬åŒ–æˆ Nginx çš„åå‘ä»£ç†é…ç½® , ç„¶åå¯¹å¤–éƒ¨æä¾›æœåŠ¡</strong> ã€‚åœ¨è¿™é‡Œæœ‰ä¸¤ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼š</p><ul><li>ingressï¼škubernetes ä¸­çš„ä¸€ä¸ªå¯¹è±¡ï¼Œä½œç”¨æ˜¯å®šä¹‰è¯·æ±‚å¦‚ä½•è½¬å‘åˆ° service çš„è§„åˆ™</li><li>ingress controllerï¼šå…·ä½“å®ç°åå‘ä»£ç†åŠè´Ÿè½½å‡è¡¡çš„ç¨‹åºï¼Œå¯¹ ingress å®šä¹‰çš„è§„åˆ™è¿›è¡Œè§£æï¼Œæ ¹æ®é…ç½®çš„è§„åˆ™æ¥å®ç°è¯·æ±‚è½¬å‘ï¼Œå®ç°æ–¹å¼æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚ Nginx, Contour, Haproxy ç­‰ç­‰</li></ul><p><strong>Ingressï¼ˆä»¥ Nginx ä¸ºä¾‹ï¼‰çš„å·¥ä½œåŸç†å¦‚ä¸‹ï¼š</strong> åŸæœ¬éœ€è¦è‡ªåŠ¨é…ç½® nginxï¼Œç°åœ¨é€šè¿‡ ingress è‡ªåŠ¨æ›´æ–° nginxã€‚</p><ol><li>ç”¨æˆ·ç¼–å†™ Ingress è§„åˆ™ï¼Œè¯´æ˜å“ªä¸ªåŸŸåå¯¹åº” kubernetes é›†ç¾¤ä¸­çš„å“ªä¸ª Service</li><li>Ingress æ§åˆ¶å™¨åŠ¨æ€æ„ŸçŸ¥ Ingress æœåŠ¡è§„åˆ™çš„å˜åŒ–ï¼Œç„¶åç”Ÿæˆä¸€æ®µå¯¹åº”çš„ Nginx åå‘ä»£ç†é…ç½®</li><li>Ingress æ§åˆ¶å™¨ä¼šå°†ç”Ÿæˆçš„ Nginx é…ç½®å†™å…¥åˆ°ä¸€ä¸ªè¿è¡Œç€çš„ Nginx æœåŠ¡ä¸­ï¼Œå¹¶åŠ¨æ€æ›´æ–°</li><li>åˆ°æ­¤ä¸ºæ­¢ï¼Œå…¶å®çœŸæ­£åœ¨å·¥ä½œçš„å°±æ˜¯ä¸€ä¸ª Nginx äº†ï¼Œå†…éƒ¨é…ç½®äº†ç”¨æˆ·å®šä¹‰çš„è¯·æ±‚è½¬å‘è§„åˆ™</li></ol><figure><img src="/assets/img/k8s/image-20200516112704764.png" alt="ç›¸å…³å›¾ç‰‡" tabindex="0" loading="lazy"><figcaption>ç›¸å…³å›¾ç‰‡</figcaption></figure><h3 id="_7-5-ingress-ä½¿ç”¨" tabindex="-1"><a class="header-anchor" href="#_7-5-ingress-ä½¿ç”¨" aria-hidden="true">#</a> 7.5 Ingress ä½¿ç”¨</h3><h4 id="_7-5-1-ç¯å¢ƒå‡†å¤‡-æ­å»º-ingress-ç¯å¢ƒ" tabindex="-1"><a class="header-anchor" href="#_7-5-1-ç¯å¢ƒå‡†å¤‡-æ­å»º-ingress-ç¯å¢ƒ" aria-hidden="true">#</a> 7.5.1 ç¯å¢ƒå‡†å¤‡ æ­å»º ingress ç¯å¢ƒ</h4><div class="language-makefile line-numbers-mode" data-ext="makefile"><pre class="language-makefile"><code><span class="token comment"># åˆ›å»ºæ–‡ä»¶å¤¹</span>
[root<span class="token operator">@</span>k8s-master01 ~]<span class="token comment"># mkdir ingress-controller</span>
[root<span class="token operator">@</span>k8s-master01 ~]<span class="token comment"># cd ingress-controller/</span>

<span class="token comment"># è·å– ingress-nginxï¼Œæœ¬æ¬¡æ¡ˆä¾‹ä½¿ç”¨çš„æ˜¯ 0.30 ç‰ˆæœ¬</span>
[root<span class="token operator">@</span>k8s-master01 ingress-controller]<span class="token comment"># wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/nginx-0.30.0/deploy/static/mandatory.yaml</span>
[root<span class="token operator">@</span>k8s-master01 ingress-controller]<span class="token comment"># wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/nginx-0.30.0/deploy/static/provider/baremetal/service-nodeport.yaml</span>

<span class="token comment"># ä¿®æ”¹ mandatory.yaml æ–‡ä»¶ä¸­çš„ä»“åº“</span>
<span class="token comment"># ä¿®æ”¹ quay.io/kubernetes-ingress-controller/nginx-ingress-controller:0.30.0</span>
<span class="token comment"># ä¸º quay-mirror.qiniu.com/kubernetes-ingress-controller/nginx-ingress-controller:0.30.0</span>
<span class="token comment"># åˆ›å»º ingress-nginx</span>
[root<span class="token operator">@</span>k8s-master01 ingress-controller]<span class="token comment"># kubectl apply -f ./</span>

<span class="token comment"># æŸ¥çœ‹ ingress-nginx</span>
[root<span class="token operator">@</span>k8s-master01 ingress-controller]<span class="token comment"># kubectl get pod -n ingress-nginx</span>
NAME                                           READY   STATUS    RESTARTS   AGE
pod/nginx-ingress-controller-fbf967dd5-4qpbp   1/1     Running   0          12h

<span class="token comment"># æŸ¥çœ‹ service</span>
[root<span class="token operator">@</span>k8s-master01 ingress-controller]<span class="token comment"># kubectl get svc -n ingress-nginx</span>
NAME            TYPE       CLUSTER-IP     EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>                      AGE
<span class="token target symbol">ingress-nginx   NodePort   10.98.75.163   &lt;none&gt;        80</span><span class="token punctuation">:</span>32240/TCP,443<span class="token punctuation">:</span>31335/TCP   11h
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_7-5-2-å‡†å¤‡-service-å’Œ-pod" tabindex="-1"><a class="header-anchor" href="#_7-5-2-å‡†å¤‡-service-å’Œ-pod" aria-hidden="true">#</a> 7.5.2 å‡†å¤‡ service å’Œ pod</h4><p>ä¸ºäº†åé¢çš„å®éªŒæ¯”è¾ƒæ–¹ä¾¿ï¼Œåˆ›å»ºå¦‚ä¸‹å›¾æ‰€ç¤ºçš„æ¨¡å‹</p><figure><img src="/assets/img/k8s/image-20200516102419998.png" alt="ç›¸å…³å›¾ç‰‡" tabindex="0" loading="lazy"><figcaption>ç›¸å…³å›¾ç‰‡</figcaption></figure><p>åˆ›å»º tomcat-nginx.yaml</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>deployment
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>

<span class="token punctuation">---</span>

<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> tomcat<span class="token punctuation">-</span>deployment
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> tomcat<span class="token punctuation">-</span>pod
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> tomcat<span class="token punctuation">-</span>pod
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> tomcat
        <span class="token key atrule">image</span><span class="token punctuation">:</span> tomcat<span class="token punctuation">:</span>8.5<span class="token punctuation">-</span>jre10<span class="token punctuation">-</span>slim
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>

<span class="token punctuation">---</span>

<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>service
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> None
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>

<span class="token punctuation">---</span>

<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> tomcat<span class="token punctuation">-</span>service
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> tomcat<span class="token punctuation">-</span>pod
  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> None
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># åˆ›å»º</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f tomcat-nginx.yaml</span>

<span class="token comment"># æŸ¥çœ‹</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get svc -n dev</span>
NAME             TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>    AGE
nginx-service    ClusterIP   None         <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">80</span>/TCP     48s
tomcat-service   ClusterIP   None         <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">8080</span>/TCP   48s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_7-5-3-http-ä»£ç†" tabindex="-1"><a class="header-anchor" href="#_7-5-3-http-ä»£ç†" aria-hidden="true">#</a> 7.5.3 Http ä»£ç†</h4><p>åˆ›å»º ingress-http.yaml</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>http
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> nginx.itheima.com
    <span class="token key atrule">http</span><span class="token punctuation">:</span>
      <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /
        <span class="token key atrule">backend</span><span class="token punctuation">:</span>
          <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>service
          <span class="token key atrule">servicePort</span><span class="token punctuation">:</span> <span class="token number">80</span>
  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> tomcat.itheima.com
    <span class="token key atrule">http</span><span class="token punctuation">:</span>
      <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /
        <span class="token key atrule">backend</span><span class="token punctuation">:</span>
          <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> tomcat<span class="token punctuation">-</span>service
          <span class="token key atrule">servicePort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># åˆ›å»º</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f ingress-http.yaml</span>
ingress.extensions/ingress-http created

<span class="token comment"># æŸ¥çœ‹</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get ing ingress-http -n dev</span>
NAME           HOSTS                                  ADDRESS   PORTS   AGE
ingress-http   nginx.itheima.com,tomcat.itheima.com             <span class="token number">80</span>      22s

<span class="token comment"># æŸ¥çœ‹è¯¦æƒ…</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl describe ing ingress-http  -n dev</span>
<span class="token punctuation">..</span>.
Rules:
Host                Path  Backends
----                ----  --------
nginx.itheima.com   / nginx-service:80 <span class="token punctuation">(</span><span class="token number">10.244</span>.1.96:80,10.244.1.97:80,10.244.2.112:80<span class="token punctuation">)</span>
tomcat.itheima.com  / tomcat-service:8080<span class="token punctuation">(</span><span class="token number">10.244</span>.1.94:8080,10.244.1.95:8080,10.244.2.111:8080<span class="token punctuation">)</span>
<span class="token punctuation">..</span>.

<span class="token comment"># æ¥ä¸‹æ¥,åœ¨æœ¬åœ°ç”µè„‘ä¸Šé…ç½® host æ–‡ä»¶,è§£æä¸Šé¢çš„ä¸¤ä¸ªåŸŸååˆ° 192.168.109.100(master)ä¸Š</span>
<span class="token comment"># ç„¶å,å°±å¯ä»¥åˆ†åˆ«è®¿é—® tomcat.itheima.com:32240  å’Œ  nginx.itheima.com:32240 æŸ¥çœ‹æ•ˆæœäº†</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_7-5-4-https-ä»£ç†" tabindex="-1"><a class="header-anchor" href="#_7-5-4-https-ä»£ç†" aria-hidden="true">#</a> 7.5.4 Https ä»£ç†</h4><p>åˆ›å»ºè¯ä¹¦</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># ç”Ÿæˆè¯ä¹¦</span>
openssl req <span class="token parameter variable">-x509</span> <span class="token parameter variable">-sha256</span> <span class="token parameter variable">-nodes</span> <span class="token parameter variable">-days</span> <span class="token number">365</span> <span class="token parameter variable">-newkey</span> rsa:2048 <span class="token parameter variable">-keyout</span> tls.key <span class="token parameter variable">-out</span> tls.crt <span class="token parameter variable">-subj</span> <span class="token string">&quot;/C=CN/ST=BJ/L=BJ/O=nginx/CN=itheima.com&quot;</span>

<span class="token comment"># åˆ›å»ºå¯†é’¥</span>
kubectl create secret tls tls-secret <span class="token parameter variable">--key</span> tls.key <span class="token parameter variable">--cert</span> tls.crt
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åˆ›å»º ingress-https.yaml</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>https
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">tls</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> nginx.itheima.com
      <span class="token punctuation">-</span> tomcat.itheima.com
      <span class="token key atrule">secretName</span><span class="token punctuation">:</span> tls<span class="token punctuation">-</span>secret <span class="token comment"># æŒ‡å®šç§˜é’¥</span>
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> nginx.itheima.com
    <span class="token key atrule">http</span><span class="token punctuation">:</span>
      <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /
        <span class="token key atrule">backend</span><span class="token punctuation">:</span>
          <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>service
          <span class="token key atrule">servicePort</span><span class="token punctuation">:</span> <span class="token number">80</span>
  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> tomcat.itheima.com
    <span class="token key atrule">http</span><span class="token punctuation">:</span>
      <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /
        <span class="token key atrule">backend</span><span class="token punctuation">:</span>
          <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> tomcat<span class="token punctuation">-</span>service
          <span class="token key atrule">servicePort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># åˆ›å»º</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f ingress-https.yaml</span>
ingress.extensions/ingress-https created

<span class="token comment"># æŸ¥çœ‹</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get ing ingress-https -n dev</span>
NAME            HOSTS                                  ADDRESS         PORTS     AGE
ingress-https   nginx.itheima.com,tomcat.itheima.com   <span class="token number">10.104</span>.184.38   <span class="token number">80</span>, <span class="token number">443</span>   2m42s

<span class="token comment"># æŸ¥çœ‹è¯¦æƒ…</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl describe ing ingress-https -n dev</span>
<span class="token punctuation">..</span>.
TLS:
  tls-secret terminates nginx.itheima.com,tomcat.itheima.com
Rules:
Host              Path Backends
----              ---- --------
nginx.itheima.com  /  nginx-service:80 <span class="token punctuation">(</span><span class="token number">10.244</span>.1.97:80,10.244.1.98:80,10.244.2.119:80<span class="token punctuation">)</span>
tomcat.itheima.com /  tomcat-service:8080<span class="token punctuation">(</span><span class="token number">10.244</span>.1.99:8080,10.244.2.117:8080,10.244.2.120:8080<span class="token punctuation">)</span>
<span class="token punctuation">..</span>.

<span class="token comment"># ä¸‹é¢å¯ä»¥é€šè¿‡æµè§ˆå™¨è®¿é—® https://nginx.itheima.com:31335 å’Œ https://tomcat.itheima.com:31335 æ¥æŸ¥çœ‹äº†</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_8-æ•°æ®å­˜å‚¨" tabindex="-1"><a class="header-anchor" href="#_8-æ•°æ®å­˜å‚¨" aria-hidden="true">#</a> 8. æ•°æ®å­˜å‚¨</h2><p>åœ¨å‰é¢å·²ç»æåˆ°ï¼Œå®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸå¯èƒ½å¾ˆçŸ­ï¼Œä¼šè¢«é¢‘ç¹åœ°åˆ›å»ºå’Œé”€æ¯ã€‚é‚£ä¹ˆå®¹å™¨åœ¨é”€æ¯æ—¶ï¼Œä¿å­˜åœ¨å®¹å™¨ä¸­çš„æ•°æ®ä¹Ÿä¼šè¢«æ¸…é™¤ã€‚è¿™ç§ç»“æœå¯¹ç”¨æˆ·æ¥è¯´ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹æ˜¯ä¸ä¹æ„çœ‹åˆ°çš„ã€‚ä¸ºäº†æŒä¹…åŒ–ä¿å­˜å®¹å™¨çš„æ•°æ®ï¼Œkubernetes å¼•å…¥äº† Volume çš„æ¦‚å¿µã€‚</p><p>Volume æ˜¯ Pod ä¸­èƒ½å¤Ÿè¢«å¤šä¸ªå®¹å™¨è®¿é—®çš„å…±äº«ç›®å½•ï¼Œå®ƒè¢«å®šä¹‰åœ¨ Pod ä¸Šï¼Œç„¶åè¢«ä¸€ä¸ª Pod é‡Œçš„å¤šä¸ªå®¹å™¨æŒ‚è½½åˆ°å…·ä½“çš„æ–‡ä»¶ç›®å½•ä¸‹ï¼Œkubernetes é€šè¿‡ Volume å®ç°åŒä¸€ä¸ª Pod ä¸­ä¸åŒå®¹å™¨ä¹‹é—´çš„æ•°æ®å…±äº«ä»¥åŠæ•°æ®çš„æŒä¹…åŒ–å­˜å‚¨ã€‚Volume çš„ç”Ÿå‘½å®¹å™¨ä¸ä¸ Pod ä¸­å•ä¸ªå®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸç›¸å…³ï¼Œå½“å®¹å™¨ç»ˆæ­¢æˆ–è€…é‡å¯æ—¶ï¼ŒVolume ä¸­çš„æ•°æ®ä¹Ÿä¸ä¼šä¸¢å¤±ã€‚</p><p>kubernetes çš„ Volume æ”¯æŒå¤šç§ç±»å‹ï¼Œæ¯”è¾ƒå¸¸è§çš„æœ‰ä¸‹é¢å‡ ä¸ªï¼š</p><ul><li>ç®€å•å­˜å‚¨ï¼šEmptyDirã€HostPathã€NFS</li><li>é«˜çº§å­˜å‚¨ï¼šPVã€PVC</li><li>é…ç½®å­˜å‚¨ï¼šConfigMapã€Secret</li></ul><h3 id="_8-1-åŸºæœ¬å­˜å‚¨" tabindex="-1"><a class="header-anchor" href="#_8-1-åŸºæœ¬å­˜å‚¨" aria-hidden="true">#</a> 8.1 åŸºæœ¬å­˜å‚¨</h3><h4 id="_8-1-1-emptydir" tabindex="-1"><a class="header-anchor" href="#_8-1-1-emptydir" aria-hidden="true">#</a> 8.1.1 EmptyDir</h4><p>EmptyDir æ˜¯æœ€åŸºç¡€çš„ Volume ç±»å‹ï¼Œä¸€ä¸ª EmptyDir å°±æ˜¯ Host ä¸Šçš„ä¸€ä¸ªç©ºç›®å½•ã€‚</p><p>EmptyDir æ˜¯åœ¨ Pod è¢«åˆ†é…åˆ° Node æ—¶åˆ›å»ºçš„ï¼Œå®ƒçš„åˆå§‹å†…å®¹ä¸ºç©ºï¼Œå¹¶ä¸”æ— é¡»æŒ‡å®šå®¿ä¸»æœºä¸Šå¯¹åº”çš„ç›®å½•æ–‡ä»¶ï¼Œå› ä¸º kubernetes ä¼šè‡ªåŠ¨åˆ†é…ä¸€ä¸ªç›®å½•ï¼Œå½“ Pod é”€æ¯æ—¶ï¼Œ EmptyDir ä¸­çš„æ•°æ®ä¹Ÿä¼šè¢«æ°¸ä¹…åˆ é™¤ã€‚ EmptyDir ç”¨é€”å¦‚ä¸‹ï¼š</p><ul><li>ä¸´æ—¶ç©ºé—´ï¼Œä¾‹å¦‚ç”¨äºæŸäº› åº”ç”¨ç¨‹åºè¿è¡Œæ—¶æ‰€éœ€çš„ä¸´æ—¶ç›®å½•ï¼Œä¸”æ— é¡»æ°¸ä¹…ä¿ç•™</li><li>ä¸€ä¸ªå®¹å™¨éœ€è¦ä»å¦ä¸€ä¸ªå®¹å™¨ä¸­è·å–æ•°æ®çš„ç›®å½•ï¼ˆå¤šå®¹å™¨å…±äº«ç›®å½•ï¼‰</li></ul><p>æ¥ä¸‹æ¥ï¼Œé€šè¿‡ä¸€ä¸ªå®¹å™¨ä¹‹é—´æ–‡ä»¶å…±äº«çš„æ¡ˆä¾‹æ¥ä½¿ç”¨ä¸€ä¸‹ EmptyDirã€‚</p><p>åœ¨ä¸€ä¸ª Pod ä¸­å‡†å¤‡ä¸¤ä¸ªå®¹å™¨ nginx å’Œ busyboxï¼Œç„¶åå£°æ˜ä¸€ä¸ª Volume åˆ†åˆ«æŒ‚åœ¨åˆ°ä¸¤ä¸ªå®¹å™¨çš„ç›®å½•ä¸­ï¼Œç„¶å nginx å®¹å™¨è´Ÿè´£å‘ Volume ä¸­å†™æ—¥å¿—ï¼Œbusybox ä¸­é€šè¿‡å‘½ä»¤å°†æ—¥å¿—å†…å®¹è¯»åˆ°æ§åˆ¶å°ã€‚</p><figure><img src="/assets/img/k8s/image-20200413174713773.png" alt="ç›¸å…³å›¾ç‰‡" tabindex="0" loading="lazy"><figcaption>ç›¸å…³å›¾ç‰‡</figcaption></figure><p>åˆ›å»ºä¸€ä¸ª volume-emptydir.yaml</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> volume<span class="token punctuation">-</span>emptydir
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>  <span class="token comment"># å°† logs-volume æŒ‚åœ¨åˆ° nginx å®¹å™¨ä¸­ï¼Œå¯¹åº”çš„ç›®å½•ä¸º /var/log/nginx</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> logs<span class="token punctuation">-</span>volume
      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/log/nginx
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> busybox
    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.30</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;/bin/sh&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;-c&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;tail -f /logs/access.log&quot;</span><span class="token punctuation">]</span> <span class="token comment"># åˆå§‹å‘½ä»¤ï¼ŒåŠ¨æ€è¯»å–æŒ‡å®šæ–‡ä»¶ä¸­å†…å®¹</span>
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>  <span class="token comment"># å°† logs-volume æŒ‚åœ¨åˆ° busybox å®¹å™¨ä¸­ï¼Œå¯¹åº”çš„ç›®å½•ä¸º /logs</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> logs<span class="token punctuation">-</span>volume
      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /logs
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span> <span class="token comment"># å£°æ˜ volumeï¼Œ name ä¸º logs-volumeï¼Œç±»å‹ä¸º emptyDir</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> logs<span class="token punctuation">-</span>volume
    <span class="token key atrule">emptyDir</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># åˆ›å»º Pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f volume-emptydir.yaml</span>
pod/volume-emptydir created

<span class="token comment"># æŸ¥çœ‹ pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods volume-emptydir -n dev -o wide</span>
NAME                  READY   STATUS    RESTARTS   AGE      IP       NODE   <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span> 
volume-emptydir       <span class="token number">2</span>/2     Running   <span class="token number">0</span>          97s   <span class="token number">10.42</span>.2.9   node1  <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>

<span class="token comment"># é€šè¿‡ podIp è®¿é—® nginx</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># curl 10.42.2.9</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>

<span class="token comment"># é€šè¿‡ kubectl logs å‘½ä»¤æŸ¥çœ‹æŒ‡å®šå®¹å™¨çš„æ ‡å‡†è¾“å‡º</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl logs -f volume-emptydir -n dev -c busybox</span>
<span class="token number">10.42</span>.1.0 - - <span class="token punctuation">[</span><span class="token number">27</span>/Jun/2021:15:08:54 +0000<span class="token punctuation">]</span> <span class="token string">&quot;GET / HTTP/1.1&quot;</span> <span class="token number">200</span> <span class="token number">612</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;curl/7.29.0&quot;</span> <span class="token string">&quot;-&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-1-2-hostpath" tabindex="-1"><a class="header-anchor" href="#_8-1-2-hostpath" aria-hidden="true">#</a> 8.1.2 HostPath</h4><p>ä¸ŠèŠ‚è¯¾æåˆ°ï¼ŒEmptyDir ä¸­æ•°æ®ä¸ä¼šè¢«æŒä¹…åŒ–ï¼Œå®ƒä¼šéšç€ Pod çš„ç»“æŸè€Œé”€æ¯ï¼Œå¦‚æœæƒ³ç®€å•çš„å°†æ•°æ®æŒä¹…åŒ–åˆ°ä¸»æœºä¸­ï¼Œå¯ä»¥é€‰æ‹© HostPathã€‚</p><p>HostPath å°±æ˜¯å°† Node ä¸»æœºä¸­ä¸€ä¸ªå®é™…ç›®å½•æŒ‚åœ¨åˆ° Pod ä¸­ï¼Œä»¥ä¾›å®¹å™¨ä½¿ç”¨ï¼Œè¿™æ ·çš„è®¾è®¡å°±å¯ä»¥ä¿è¯ Pod é”€æ¯äº†ï¼Œä½†æ˜¯æ•°æ®ä¾æ®å¯ä»¥å­˜åœ¨äº Node ä¸»æœºä¸Šã€‚</p><figure><img src="/assets/img/k8s/image-20200413214031331.png" alt="ç›¸å…³å›¾ç‰‡" tabindex="0" loading="lazy"><figcaption>ç›¸å…³å›¾ç‰‡</figcaption></figure><p>åˆ›å»ºä¸€ä¸ª volume-hostpath.yamlï¼š</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> volume<span class="token punctuation">-</span>hostpath
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> logs<span class="token punctuation">-</span>volume
      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/log/nginx
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> busybox
    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.30</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;/bin/sh&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;-c&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;tail -f /logs/access.log&quot;</span><span class="token punctuation">]</span>
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> logs<span class="token punctuation">-</span>volume
      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /logs
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> logs<span class="token punctuation">-</span>volume
    <span class="token key atrule">hostPath</span><span class="token punctuation">:</span> 
      <span class="token key atrule">path</span><span class="token punctuation">:</span> /root/logs
      <span class="token key atrule">type</span><span class="token punctuation">:</span> DirectoryOrCreate  <span class="token comment"># ç›®å½•å­˜åœ¨å°±ä½¿ç”¨ï¼Œä¸å­˜åœ¨å°±å…ˆåˆ›å»ºåä½¿ç”¨</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>æ–‡ä»¶å°†ä¿å­˜åœ¨èŠ‚ç‚¹ä¸Šï¼Œéœ€è¦æŸ¥çœ‹ volume å…·ä½“éƒ¨ç½²åˆ°äº†é‚£ä¸ªèŠ‚ç‚¹ä¸Šã€‚</strong></p><p>å…³äº type çš„å€¼çš„ä¸€ç‚¹è¯´æ˜ï¼š</p><ul><li>DirectoryOrCreate ç›®å½•å­˜åœ¨å°±ä½¿ç”¨ï¼Œä¸å­˜åœ¨å°±å…ˆåˆ›å»ºåä½¿ç”¨</li><li>Directory ç›®å½•å¿…é¡»å­˜åœ¨</li><li>FileOrCreate æ–‡ä»¶å­˜åœ¨å°±ä½¿ç”¨ï¼Œä¸å­˜åœ¨å°±å…ˆåˆ›å»ºåä½¿ç”¨</li><li>File æ–‡ä»¶å¿…é¡»å­˜åœ¨</li><li>Socket unix å¥—æ¥å­—å¿…é¡»å­˜åœ¨</li><li>CharDevice å­—ç¬¦è®¾å¤‡å¿…é¡»å­˜åœ¨</li><li>BlockDevice å—è®¾å¤‡å¿…é¡»å­˜åœ¨</li></ul><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># åˆ›å»º Pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f volume-hostpath.yaml</span>
pod/volume-hostpath created

<span class="token comment"># æŸ¥çœ‹ Pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods volume-hostpath -n dev -o wide</span>
NAME                  READY   STATUS    RESTARTS   AGE   IP             NODE   <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
pod-volume-hostpath   <span class="token number">2</span>/2     Running   <span class="token number">0</span>          16s   <span class="token number">10.42</span>.2.10     node1  <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>

<span class="token comment">#è®¿é—® nginx</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># curl 10.42.2.10</span>

<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl logs -f volume-emptydir -n dev -c busybox</span>

<span class="token comment"># æ¥ä¸‹æ¥å°±å¯ä»¥å» host çš„/root/logs ç›®å½•ä¸‹æŸ¥çœ‹å­˜å‚¨çš„æ–‡ä»¶äº†</span>
<span class="token comment">##  æ³¨æ„: ä¸‹é¢çš„æ“ä½œéœ€è¦åˆ° Pod æ‰€åœ¨çš„èŠ‚ç‚¹è¿è¡Œï¼ˆæ¡ˆä¾‹ä¸­æ˜¯ node1ï¼‰</span>
<span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span><span class="token comment"># ls /root/logs/</span>
access.log  error.log

<span class="token comment"># åŒæ ·çš„é“ç†ï¼Œå¦‚æœåœ¨æ­¤ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ï¼Œåˆ°å®¹å™¨ä¸­ä¹Ÿæ˜¯å¯ä»¥çœ‹åˆ°çš„</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-1-3-nfs" tabindex="-1"><a class="header-anchor" href="#_8-1-3-nfs" aria-hidden="true">#</a> 8.1.3 NFS</h4><p>HostPath å¯ä»¥è§£å†³æ•°æ®æŒä¹…åŒ–çš„é—®é¢˜ï¼Œä½†æ˜¯ä¸€æ—¦ Node èŠ‚ç‚¹æ•…éšœäº†ï¼ŒPod å¦‚æœè½¬ç§»åˆ°äº†åˆ«çš„èŠ‚ç‚¹ï¼Œåˆä¼šå‡ºç°é—®é¢˜äº†ï¼Œæ­¤æ—¶éœ€è¦å‡†å¤‡å•ç‹¬çš„ç½‘ç»œå­˜å‚¨ç³»ç»Ÿï¼Œæ¯”è¾ƒå¸¸ç”¨çš„ç”¨ NFSã€CIFSã€‚</p><p>NFS æ˜¯ä¸€ä¸ªç½‘ç»œæ–‡ä»¶å­˜å‚¨ç³»ç»Ÿï¼Œå¯ä»¥æ­å»ºä¸€å° NFS æœåŠ¡å™¨ï¼Œç„¶åå°† Pod ä¸­çš„å­˜å‚¨ç›´æ¥è¿æ¥åˆ° NFS ç³»ç»Ÿä¸Šï¼Œè¿™æ ·çš„è¯ï¼Œæ— è®º Pod åœ¨èŠ‚ç‚¹ä¸Šæ€ä¹ˆè½¬ç§»ï¼Œåªè¦ Node è·Ÿ NFS çš„å¯¹æ¥æ²¡é—®é¢˜ï¼Œæ•°æ®å°±å¯ä»¥æˆåŠŸè®¿é—®ã€‚</p><figure><img src="/assets/img/k8s/image-20200413215133559.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>1ï¼‰é¦–å…ˆè¦å‡†å¤‡ nfs çš„æœåŠ¡å™¨ï¼Œè¿™é‡Œä¸ºäº†ç®€å•ï¼Œç›´æ¥æ˜¯ master èŠ‚ç‚¹åš nfs æœåŠ¡å™¨</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># åœ¨ nfs ä¸Šå®‰è£… nfs æœåŠ¡</span>
<span class="token punctuation">[</span>root@nfs ~<span class="token punctuation">]</span><span class="token comment"># yum install nfs-utils -y</span>

<span class="token comment"># å‡†å¤‡ä¸€ä¸ªå…±äº«ç›®å½•</span>
<span class="token punctuation">[</span>root@nfs ~<span class="token punctuation">]</span><span class="token comment"># mkdir /root/data/nfs -pv</span>

<span class="token comment"># å°†å…±äº«ç›®å½•ä»¥è¯»å†™æƒé™æš´éœ²ç»™ 192.168.5.0/24 ç½‘æ®µä¸­çš„æ‰€æœ‰ä¸»æœº</span>
<span class="token punctuation">[</span>root@nfs ~<span class="token punctuation">]</span><span class="token comment"># vim /etc/exports</span>
<span class="token punctuation">[</span>root@nfs ~<span class="token punctuation">]</span><span class="token comment"># more /etc/exports</span>
/root/data/nfs     <span class="token number">192.168</span>.5.0/24<span class="token punctuation">(</span>rw,no_root_squash<span class="token punctuation">)</span>

<span class="token comment"># å¯åŠ¨ nfs æœåŠ¡</span>
<span class="token punctuation">[</span>root@nfs ~<span class="token punctuation">]</span><span class="token comment"># systemctl restart nfs</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2ï¼‰æ¥ä¸‹æ¥ï¼Œè¦åœ¨çš„æ¯ä¸ª node èŠ‚ç‚¹ä¸Šéƒ½å®‰è£…ä¸‹ nfsï¼Œè¿™æ ·çš„ç›®çš„æ˜¯ä¸ºäº† node èŠ‚ç‚¹å¯ä»¥é©±åŠ¨ nfs è®¾å¤‡</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># åœ¨ node ä¸Šå®‰è£… nfs æœåŠ¡ï¼Œæ³¨æ„ä¸éœ€è¦å¯åŠ¨</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># yum install nfs-utils -y</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>3ï¼‰æ¥ä¸‹æ¥ï¼Œå°±å¯ä»¥ç¼–å†™ pod çš„é…ç½®æ–‡ä»¶äº†ï¼Œåˆ›å»º volume-nfs.yaml</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> volume<span class="token punctuation">-</span>nfs
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> logs<span class="token punctuation">-</span>volume
      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/log/nginx
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> busybox
    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.30</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;/bin/sh&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;-c&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;tail -f /logs/access.log&quot;</span><span class="token punctuation">]</span> 
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> logs<span class="token punctuation">-</span>volume
      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /logs
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> logs<span class="token punctuation">-</span>volume
    <span class="token key atrule">nfs</span><span class="token punctuation">:</span>
      <span class="token key atrule">server</span><span class="token punctuation">:</span> 192.168.5.6  <span class="token comment">#nfs æœåŠ¡å™¨åœ°å€</span>
      <span class="token key atrule">path</span><span class="token punctuation">:</span> /root/data/nfs <span class="token comment">#å…±äº«æ–‡ä»¶è·¯å¾„</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>4ï¼‰æœ€åï¼Œè¿è¡Œä¸‹ podï¼Œè§‚å¯Ÿç»“æœ</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># åˆ›å»º pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f volume-nfs.yaml</span>
pod/volume-nfs created

<span class="token comment"># æŸ¥çœ‹ pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods volume-nfs -n dev</span>
NAME                  READY   STATUS    RESTARTS   AGE
volume-nfs        <span class="token number">2</span>/2     Running   <span class="token number">0</span>          2m9s

<span class="token comment"># æŸ¥çœ‹ nfs æœåŠ¡å™¨ä¸Šçš„å…±äº«ç›®å½•ï¼Œå‘ç°å·²ç»æœ‰æ–‡ä»¶äº†</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># ls /root/data/</span>
access.log  error.log
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-2-é«˜çº§å­˜å‚¨" tabindex="-1"><a class="header-anchor" href="#_8-2-é«˜çº§å­˜å‚¨" aria-hidden="true">#</a> 8.2 é«˜çº§å­˜å‚¨</h3><p>å‰é¢å·²ç»å­¦ä¹ äº†ä½¿ç”¨ NFS æä¾›å­˜å‚¨ï¼Œæ­¤æ—¶å°±è¦æ±‚ç”¨æˆ·ä¼šæ­å»º NFS ç³»ç»Ÿï¼Œå¹¶ä¸”ä¼šåœ¨ yaml é…ç½® nfsã€‚ç”±äº kubernetes æ”¯æŒçš„å­˜å‚¨ç³»ç»Ÿæœ‰å¾ˆå¤šï¼Œè¦æ±‚å®¢æˆ·å…¨éƒ½æŒæ¡ï¼Œæ˜¾ç„¶ä¸ç°å®ã€‚ä¸ºäº†èƒ½å¤Ÿ <strong>å±è”½åº•å±‚å­˜å‚¨å®ç°çš„ç»†èŠ‚ï¼Œæ–¹ä¾¿ç”¨æˆ·ä½¿ç”¨</strong> ï¼Œ kubernetes å¼•å…¥ PV å’Œ PVC ä¸¤ç§èµ„æºå¯¹è±¡ã€‚</p><ul><li><p>PVï¼ˆPersistent Volumeï¼‰æ˜¯æŒä¹…åŒ–å·çš„æ„æ€ï¼Œæ˜¯å¯¹åº•å±‚çš„å…±äº«å­˜å‚¨çš„ä¸€ç§æŠ½è±¡ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ PV ç”± kubernetes ç®¡ç†å‘˜è¿›è¡Œåˆ›å»ºå’Œé…ç½®ï¼Œå®ƒä¸åº•å±‚å…·ä½“çš„å…±äº«å­˜å‚¨æŠ€æœ¯æœ‰å…³ï¼Œå¹¶é€šè¿‡æ’ä»¶å®Œæˆä¸å…±äº«å­˜å‚¨çš„å¯¹æ¥ã€‚</p></li><li><p>PVCï¼ˆPersistent Volume Claimï¼‰æ˜¯æŒä¹…å·å£°æ˜çš„æ„æ€ï¼Œæ˜¯ç”¨æˆ·å¯¹äºå­˜å‚¨éœ€æ±‚çš„ä¸€ç§å£°æ˜ã€‚æ¢å¥è¯è¯´ï¼ŒPVC å…¶å®å°±æ˜¯ç”¨æˆ·å‘ kubernetes ç³»ç»Ÿå‘å‡ºçš„ä¸€ç§èµ„æºéœ€æ±‚ç”³è¯·ã€‚</p></li></ul><figure><img src="/assets/img/k8s/image-20200514194111567.png" alt="ç›¸å…³å›¾ç‰‡" height="300" tabindex="0" loading="lazy"><figcaption>ç›¸å…³å›¾ç‰‡</figcaption></figure><p>ä½¿ç”¨äº† PV å’Œ PVC ä¹‹åï¼Œå·¥ä½œå¯ä»¥å¾—åˆ°è¿›ä¸€æ­¥çš„ç»†åˆ†ï¼š</p><ul><li>å­˜å‚¨ï¼šå­˜å‚¨å·¥ç¨‹å¸ˆç»´æŠ¤</li><li>PVï¼š kubernetes ç®¡ç†å‘˜ç»´æŠ¤</li><li>PVCï¼škubernetes ç”¨æˆ·ç»´æŠ¤</li></ul><h4 id="_8-2-1-pv" tabindex="-1"><a class="header-anchor" href="#_8-2-1-pv" aria-hidden="true">#</a> 8.2.1 PV</h4><p>PV æ˜¯å­˜å‚¨èµ„æºçš„æŠ½è±¡ï¼Œä¸‹é¢æ˜¯èµ„æºæ¸…å•æ–‡ä»¶:</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1  
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pv2
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">nfs</span><span class="token punctuation">:</span> <span class="token comment"># å­˜å‚¨ç±»å‹ï¼Œä¸åº•å±‚çœŸæ­£å­˜å‚¨å¯¹åº”</span>
  <span class="token key atrule">capacity</span><span class="token punctuation">:</span>  <span class="token comment"># å­˜å‚¨èƒ½åŠ›ï¼Œç›®å‰åªæ”¯æŒå­˜å‚¨ç©ºé—´çš„è®¾ç½®</span>
    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 2Gi
  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>  <span class="token comment"># è®¿é—®æ¨¡å¼</span>
  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> <span class="token comment"># å­˜å‚¨ç±»åˆ«</span>
  <span class="token key atrule">persistentVolumeReclaimPolicy</span><span class="token punctuation">:</span> <span class="token comment"># å›æ”¶ç­–ç•¥</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>PV çš„å…³é”®é…ç½®å‚æ•°è¯´æ˜ï¼š</p><ul><li><strong>å­˜å‚¨ç±»å‹</strong></li></ul><p>åº•å±‚å®é™…å­˜å‚¨çš„ç±»å‹ï¼Œkubernetes æ”¯æŒå¤šç§å­˜å‚¨ç±»å‹ï¼Œæ¯ç§å­˜å‚¨ç±»å‹çš„é…ç½®éƒ½æœ‰æ‰€å·®å¼‚</p><ul><li><strong>å­˜å‚¨èƒ½åŠ›ï¼ˆcapacityï¼‰</strong></li></ul><p>ç›®å‰åªæ”¯æŒå­˜å‚¨ç©ºé—´çš„è®¾ç½®( storage=1Gi )ï¼Œä¸è¿‡æœªæ¥å¯èƒ½ä¼šåŠ å…¥ IOPSã€ååé‡ç­‰æŒ‡æ ‡çš„é…ç½®</p><ul><li><strong>è®¿é—®æ¨¡å¼ï¼ˆaccessModesï¼‰</strong></li></ul><p>ç”¨äºæè¿°ç”¨æˆ·åº”ç”¨å¯¹å­˜å‚¨èµ„æºçš„è®¿é—®æƒé™ï¼Œè®¿é—®æƒé™åŒ…æ‹¬ä¸‹é¢å‡ ç§æ–¹å¼ï¼š</p><ul><li>ReadWriteOnceï¼ˆRWOï¼‰ï¼šè¯»å†™æƒé™ï¼Œä½†æ˜¯åªèƒ½è¢«å•ä¸ªèŠ‚ç‚¹æŒ‚è½½</li><li>ReadOnlyManyï¼ˆROXï¼‰ï¼š åªè¯»æƒé™ï¼Œå¯ä»¥è¢«å¤šä¸ªèŠ‚ç‚¹æŒ‚è½½</li><li>ReadWriteManyï¼ˆRWXï¼‰ï¼šè¯»å†™æƒé™ï¼Œå¯ä»¥è¢«å¤šä¸ªèŠ‚ç‚¹æŒ‚è½½</li></ul><p><code>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåº•å±‚ä¸åŒçš„å­˜å‚¨ç±»å‹å¯èƒ½æ”¯æŒçš„è®¿é—®æ¨¡å¼ä¸åŒ</code></p><ul><li><strong>å›æ”¶ç­–ç•¥ï¼ˆpersistentVolumeReclaimPolicyï¼‰</strong></li></ul><p>å½“ PV ä¸å†è¢«ä½¿ç”¨äº†ä¹‹åï¼Œå¯¹å…¶çš„å¤„ç†æ–¹å¼ã€‚ç›®å‰æ”¯æŒä¸‰ç§ç­–ç•¥ï¼š</p><ul><li>Retain ï¼ˆä¿ç•™ï¼‰ ä¿ç•™æ•°æ®ï¼Œéœ€è¦ç®¡ç†å‘˜æ‰‹å·¥æ¸…ç†æ•°æ®</li><li>Recycleï¼ˆå›æ”¶ï¼‰ æ¸…é™¤ PV ä¸­çš„æ•°æ®ï¼Œæ•ˆæœç›¸å½“äºæ‰§è¡Œ rm -rf /thevolume/*</li><li>Delete ï¼ˆåˆ é™¤ï¼‰ ä¸ PV ç›¸è¿çš„åç«¯å­˜å‚¨å®Œæˆ volume çš„åˆ é™¤æ“ä½œï¼Œå½“ç„¶è¿™å¸¸è§äºäº‘æœåŠ¡å•†çš„å­˜å‚¨æœåŠ¡</li></ul><p><code>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåº•å±‚ä¸åŒçš„å­˜å‚¨ç±»å‹å¯èƒ½æ”¯æŒçš„å›æ”¶ç­–ç•¥ä¸åŒ</code></p><ul><li><strong>å­˜å‚¨ç±»åˆ«</strong></li></ul><p>PV å¯ä»¥é€šè¿‡ storageClassName å‚æ•°æŒ‡å®šä¸€ä¸ªå­˜å‚¨ç±»åˆ«</p><ul><li><p>å…·æœ‰ç‰¹å®šç±»åˆ«çš„ PV åªèƒ½ä¸è¯·æ±‚äº†è¯¥ç±»åˆ«çš„ PVC è¿›è¡Œç»‘å®š</p></li><li><p>æœªè®¾å®šç±»åˆ«çš„ PV åˆ™åªèƒ½ä¸ä¸è¯·æ±‚ä»»ä½•ç±»åˆ«çš„ PVC è¿›è¡Œç»‘å®š</p></li><li><p><strong>çŠ¶æ€ï¼ˆstatusï¼‰</strong></p></li></ul><p>ä¸€ä¸ª PV çš„ç”Ÿå‘½å‘¨æœŸä¸­ï¼Œå¯èƒ½ä¼šå¤„äº 4 ä¸­ä¸åŒçš„é˜¶æ®µï¼š</p><ul><li>Availableï¼ˆå¯ç”¨ï¼‰ï¼š è¡¨ç¤ºå¯ç”¨çŠ¶æ€ï¼Œè¿˜æœªè¢«ä»»ä½• PVC ç»‘å®š</li><li>Boundï¼ˆå·²ç»‘å®šï¼‰ï¼š è¡¨ç¤º PV å·²ç»è¢« PVC ç»‘å®š</li><li>Releasedï¼ˆå·²é‡Šæ”¾ï¼‰ï¼š è¡¨ç¤º PVC è¢«åˆ é™¤ï¼Œä½†æ˜¯èµ„æºè¿˜æœªè¢«é›†ç¾¤é‡æ–°å£°æ˜</li><li>Failedï¼ˆå¤±è´¥ï¼‰ï¼š è¡¨ç¤ºè¯¥ PV çš„è‡ªåŠ¨å›æ”¶å¤±è´¥</li></ul><p><strong>å®éªŒ</strong></p><p>ä½¿ç”¨ NFS ä½œä¸ºå­˜å‚¨ï¼Œæ¥æ¼”ç¤º PV çš„ä½¿ç”¨ï¼Œåˆ›å»º 3 ä¸ª PVï¼Œå¯¹åº” NFS ä¸­çš„ 3 ä¸ªæš´éœ²çš„è·¯å¾„ã€‚</p><ol><li>å‡†å¤‡ NFS ç¯å¢ƒ</li></ol><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># åˆ›å»ºç›®å½•</span>
<span class="token punctuation">[</span>root@nfs ~<span class="token punctuation">]</span><span class="token comment"># mkdir /root/data/{pv1,pv2,pv3} -pv</span>

<span class="token comment"># æš´éœ²æœåŠ¡</span>
<span class="token punctuation">[</span>root@nfs ~<span class="token punctuation">]</span><span class="token comment"># more /etc/exports</span>
/root/data/pv1     <span class="token number">192.168</span>.5.0/24<span class="token punctuation">(</span>rw,no_root_squash<span class="token punctuation">)</span>
/root/data/pv2     <span class="token number">192.168</span>.5.0/24<span class="token punctuation">(</span>rw,no_root_squash<span class="token punctuation">)</span>
/root/data/pv3     <span class="token number">192.168</span>.5.0/24<span class="token punctuation">(</span>rw,no_root_squash<span class="token punctuation">)</span>

<span class="token comment"># é‡å¯æœåŠ¡</span>
<span class="token punctuation">[</span>root@nfs ~<span class="token punctuation">]</span><span class="token comment">#  systemctl restart nfs</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>åˆ›å»º pv.yaml</li></ol><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span>  pv1
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">capacity</span><span class="token punctuation">:</span> 
    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi
  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ReadWriteMany
  <span class="token key atrule">persistentVolumeReclaimPolicy</span><span class="token punctuation">:</span> Retain
  <span class="token key atrule">nfs</span><span class="token punctuation">:</span>
    <span class="token key atrule">path</span><span class="token punctuation">:</span> /root/data/pv1
    <span class="token key atrule">server</span><span class="token punctuation">:</span> 192.168.5.6

<span class="token punctuation">---</span>

<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span>  pv2
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">capacity</span><span class="token punctuation">:</span> 
    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 2Gi
  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ReadWriteMany
  <span class="token key atrule">persistentVolumeReclaimPolicy</span><span class="token punctuation">:</span> Retain
  <span class="token key atrule">nfs</span><span class="token punctuation">:</span>
    <span class="token key atrule">path</span><span class="token punctuation">:</span> /root/data/pv2
    <span class="token key atrule">server</span><span class="token punctuation">:</span> 192.168.5.6
    
<span class="token punctuation">---</span>

<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span>  pv3
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">capacity</span><span class="token punctuation">:</span> 
    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 3Gi
  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ReadWriteMany
  <span class="token key atrule">persistentVolumeReclaimPolicy</span><span class="token punctuation">:</span> Retain
  <span class="token key atrule">nfs</span><span class="token punctuation">:</span>
    <span class="token key atrule">path</span><span class="token punctuation">:</span> /root/data/pv3
    <span class="token key atrule">server</span><span class="token punctuation">:</span> 192.168.5.6
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># åˆ›å»º pv</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pv.yaml</span>
persistentvolume/pv1 created
persistentvolume/pv2 created
persistentvolume/pv3 created

<span class="token comment"># æŸ¥çœ‹ pv</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pv -o wide</span>
NAME   CAPACITY   ACCESS MODES  RECLAIM POLICY  STATUS      AGE   VOLUMEMODE
pv1    1Gi        RWX            Retain        Available    10s   Filesystem
pv2    2Gi        RWX            Retain        Available    10s   Filesystem
pv3    3Gi        RWX            Retain        Available    9s    Filesystem
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-2-2-pvc" tabindex="-1"><a class="header-anchor" href="#_8-2-2-pvc" aria-hidden="true">#</a> 8.2.2 PVC</h4><p>PVC æ˜¯èµ„æºçš„ç”³è¯·ï¼Œç”¨æ¥å£°æ˜å¯¹å­˜å‚¨ç©ºé—´ã€è®¿é—®æ¨¡å¼ã€å­˜å‚¨ç±»åˆ«éœ€æ±‚ä¿¡æ¯ã€‚ä¸‹é¢æ˜¯èµ„æºæ¸…å•æ–‡ä»¶:</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pvc
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span> <span class="token comment"># è®¿é—®æ¨¡å¼</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span> <span class="token comment"># é‡‡ç”¨æ ‡ç­¾å¯¹ PV é€‰æ‹©</span>
  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> <span class="token comment"># å­˜å‚¨ç±»åˆ«</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token comment"># è¯·æ±‚ç©ºé—´</span>
    <span class="token key atrule">requests</span><span class="token punctuation">:</span>
      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 5Gi
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>PVC çš„å…³é”®é…ç½®å‚æ•°è¯´æ˜ï¼š</p><ul><li><strong>è®¿é—®æ¨¡å¼ï¼ˆaccessModesï¼‰</strong></li></ul><p>ç”¨äºæè¿°ç”¨æˆ·åº”ç”¨å¯¹å­˜å‚¨èµ„æºçš„è®¿é—®æƒé™</p><ul><li><strong>é€‰æ‹©æ¡ä»¶ï¼ˆselectorï¼‰</strong></li></ul><p>é€šè¿‡ Label Selector çš„è®¾ç½®ï¼Œå¯ä½¿ PVC å¯¹äºç³»ç»Ÿä¸­å·±å­˜åœ¨çš„ PV è¿›è¡Œç­›é€‰</p><ul><li><strong>å­˜å‚¨ç±»åˆ«ï¼ˆstorageClassNameï¼‰</strong></li></ul><p>PVC åœ¨å®šä¹‰æ—¶å¯ä»¥è®¾å®šéœ€è¦çš„åç«¯å­˜å‚¨çš„ç±»åˆ«ï¼Œåªæœ‰è®¾ç½®äº†è¯¥ class çš„ pv æ‰èƒ½è¢«ç³»ç»Ÿé€‰å‡º</p><ul><li><strong>èµ„æºè¯·æ±‚ï¼ˆResources ï¼‰</strong></li></ul><p>æè¿°å¯¹å­˜å‚¨èµ„æºçš„è¯·æ±‚</p><p><strong>å®éªŒ</strong></p><ol><li>åˆ›å»º pvc.yamlï¼Œç”³è¯· pv</li></ol><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pvc1
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span> 
  <span class="token punctuation">-</span> ReadWriteMany
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token key atrule">requests</span><span class="token punctuation">:</span>
      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pvc2
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span> 
  <span class="token punctuation">-</span> ReadWriteMany
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token key atrule">requests</span><span class="token punctuation">:</span>
      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pvc3
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span> 
  <span class="token punctuation">-</span> ReadWriteMany
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token key atrule">requests</span><span class="token punctuation">:</span>
      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># åˆ›å»º pvc</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pvc.yaml</span>
persistentvolumeclaim/pvc1 created
persistentvolumeclaim/pvc2 created
persistentvolumeclaim/pvc3 created

<span class="token comment"># æŸ¥çœ‹ pvc</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pvc  -n dev -o wide</span>
NAME   STATUS   VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS   AGE   VOLUMEMODE
pvc1   Bound    pv1      1Gi        RWX                           15s   Filesystem
pvc2   Bound    pv2      2Gi        RWX                           15s   Filesystem
pvc3   Bound    pv3      3Gi        RWX                           15s   Filesystem

<span class="token comment"># æŸ¥çœ‹ pv</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pv -o wide</span>
NAME  CAPACITY ACCESS MODES  RECLAIM POLICY  STATUS    CLAIM       AGE     VOLUMEMODE
pv1    1Gi        RWx        Retain          Bound    dev/pvc1    3h37m    Filesystem
pv2    2Gi        RWX        Retain          Bound    dev/pvc2    3h37m    Filesystem
pv3    3Gi        RWX        Retain          Bound    dev/pvc3    3h37m    Filesystem   
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>åˆ›å»º pods.yaml, ä½¿ç”¨ pv</li></ol><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod1
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> busybox
    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.30</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;/bin/sh&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;-c&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;while true;do echo pod1 &gt;&gt; /root/out.txt; sleep 10; done;&quot;</span><span class="token punctuation">]</span>
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> volume
      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /root/
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> volume
      <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>
        <span class="token key atrule">claimName</span><span class="token punctuation">:</span> pvc1
        <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod2
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> busybox
    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.30</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;/bin/sh&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;-c&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;while true;do echo pod2 &gt;&gt; /root/out.txt; sleep 10; done;&quot;</span><span class="token punctuation">]</span>
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> volume
      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /root/
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> volume
      <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>
        <span class="token key atrule">claimName</span><span class="token punctuation">:</span> pvc2
        <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># åˆ›å»º pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pods.yaml</span>
pod/pod1 created
pod/pod2 created

<span class="token comment"># æŸ¥çœ‹ pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev -o wide</span>
NAME   READY   STATUS    RESTARTS   AGE   IP            NODE   
pod1   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          14s   <span class="token number">10.244</span>.1.69   node1   
pod2   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          14s   <span class="token number">10.244</span>.1.70   node1  

<span class="token comment"># æŸ¥çœ‹ pvc</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pvc -n dev -o wide</span>
NAME   STATUS   VOLUME   CAPACITY   ACCESS MODES      AGE   VOLUMEMODE
pvc1   Bound    pv1      1Gi        RWX               94m   Filesystem
pvc2   Bound    pv2      2Gi        RWX               94m   Filesystem
pvc3   Bound    pv3      3Gi        RWX               94m   Filesystem

<span class="token comment"># æŸ¥çœ‹ pv</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pv -n dev -o wide</span>
NAME   CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM       AGE     VOLUMEMODE
pv1    1Gi        RWX            Retain           Bound    dev/pvc1    5h11m   Filesystem
pv2    2Gi        RWX            Retain           Bound    dev/pvc2    5h11m   Filesystem
pv3    3Gi        RWX            Retain           Bound    dev/pvc3    5h11m   Filesystem

<span class="token comment"># æŸ¥çœ‹ nfs ä¸­çš„æ–‡ä»¶å­˜å‚¨</span>
<span class="token punctuation">[</span>root@nfs ~<span class="token punctuation">]</span><span class="token comment"># more /root/data/pv1/out.txt</span>
node1
node1
<span class="token punctuation">[</span>root@nfs ~<span class="token punctuation">]</span><span class="token comment"># more /root/data/pv2/out.txt</span>
node2
node2
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-2-3-ç”Ÿå‘½å‘¨æœŸ" tabindex="-1"><a class="header-anchor" href="#_8-2-3-ç”Ÿå‘½å‘¨æœŸ" aria-hidden="true">#</a> 8.2.3 ç”Ÿå‘½å‘¨æœŸ</h4><p>PVC å’Œ PV æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼ŒPV å’Œ PVC ä¹‹é—´çš„ç›¸äº’ä½œç”¨éµå¾ªä»¥ä¸‹ç”Ÿå‘½å‘¨æœŸï¼š</p><ul><li><p><strong>èµ„æºä¾›åº”</strong> ï¼šç®¡ç†å‘˜æ‰‹åŠ¨åˆ›å»ºåº•å±‚å­˜å‚¨å’Œ PV</p></li><li><p><strong>èµ„æºç»‘å®š</strong> ï¼šç”¨æˆ·åˆ›å»º PVCï¼Œkubernetes è´Ÿè´£æ ¹æ® PVC çš„å£°æ˜å»å¯»æ‰¾ PVï¼Œå¹¶ç»‘å®š</p></li></ul><p>åœ¨ç”¨æˆ·å®šä¹‰å¥½ PVC ä¹‹åï¼Œç³»ç»Ÿå°†æ ¹æ® PVC å¯¹å­˜å‚¨èµ„æºçš„è¯·æ±‚åœ¨å·²å­˜åœ¨çš„ PV ä¸­é€‰æ‹©ä¸€ä¸ªæ»¡è¶³æ¡ä»¶çš„</p><ul><li>ä¸€æ—¦æ‰¾åˆ°ï¼Œå°±å°†è¯¥ PV ä¸ç”¨æˆ·å®šä¹‰çš„ PVC è¿›è¡Œç»‘å®šï¼Œç”¨æˆ·çš„åº”ç”¨å°±å¯ä»¥ä½¿ç”¨è¿™ä¸ª PVC äº†</li><li>å¦‚æœæ‰¾ä¸åˆ°ï¼ŒPVC åˆ™ä¼šæ— é™æœŸå¤„äº Pending çŠ¶æ€ï¼Œç›´åˆ°ç­‰åˆ°ç³»ç»Ÿç®¡ç†å‘˜åˆ›å»ºäº†ä¸€ä¸ªç¬¦åˆå…¶è¦æ±‚çš„ PV</li></ul><p>PV ä¸€æ—¦ç»‘å®šåˆ°æŸä¸ª PVC ä¸Šï¼Œå°±ä¼šè¢«è¿™ä¸ª PVC ç‹¬å ï¼Œä¸èƒ½å†ä¸å…¶ä»– PVC è¿›è¡Œç»‘å®šäº†</p><ul><li><strong>èµ„æºä½¿ç”¨</strong> ï¼šç”¨æˆ·å¯åœ¨ pod ä¸­åƒ volume ä¸€æ ·ä½¿ç”¨ pvc</li></ul><p>Pod ä½¿ç”¨ Volume çš„å®šä¹‰ï¼Œå°† PVC æŒ‚è½½åˆ°å®¹å™¨å†…çš„æŸä¸ªè·¯å¾„è¿›è¡Œä½¿ç”¨ã€‚</p><ul><li><strong>èµ„æºé‡Šæ”¾</strong> ï¼šç”¨æˆ·åˆ é™¤ pvc æ¥é‡Šæ”¾ pv</li></ul><p>å½“å­˜å‚¨èµ„æºä½¿ç”¨å®Œæ¯•åï¼Œç”¨æˆ·å¯ä»¥åˆ é™¤ PVCï¼Œä¸è¯¥ PVC ç»‘å®šçš„ PV å°†ä¼šè¢«æ ‡è®°ä¸ºâ€œå·²é‡Šæ”¾â€ï¼Œä½†è¿˜ä¸èƒ½ç«‹åˆ»ä¸å…¶ä»– PVC è¿›è¡Œç»‘å®šã€‚é€šè¿‡ä¹‹å‰ PVC å†™å…¥çš„æ•°æ®å¯èƒ½è¿˜è¢«ç•™åœ¨å­˜å‚¨è®¾å¤‡ä¸Šï¼Œåªæœ‰åœ¨æ¸…é™¤ä¹‹åè¯¥ PV æ‰èƒ½å†æ¬¡ä½¿ç”¨ã€‚</p><ul><li><strong>èµ„æºå›æ”¶</strong> ï¼škubernetes æ ¹æ® pv è®¾ç½®çš„å›æ”¶ç­–ç•¥è¿›è¡Œèµ„æºçš„å›æ”¶</li></ul><p>å¯¹äº PVï¼Œç®¡ç†å‘˜å¯ä»¥è®¾å®šå›æ”¶ç­–ç•¥ï¼Œç”¨äºè®¾ç½®ä¸ä¹‹ç»‘å®šçš„ PVC é‡Šæ”¾èµ„æºä¹‹åå¦‚ä½•å¤„ç†é—ç•™æ•°æ®çš„é—®é¢˜ã€‚åªæœ‰ PV çš„å­˜å‚¨ç©ºé—´å®Œæˆå›æ”¶ï¼Œæ‰èƒ½ä¾›æ–°çš„ PVC ç»‘å®šå’Œä½¿ç”¨</p><figure><img src="/assets/img/k8s/image-20200515002806726.png" alt="ç›¸å…³å›¾ç‰‡" tabindex="0" loading="lazy"><figcaption>ç›¸å…³å›¾ç‰‡</figcaption></figure><h3 id="_8-3-é…ç½®å­˜å‚¨" tabindex="-1"><a class="header-anchor" href="#_8-3-é…ç½®å­˜å‚¨" aria-hidden="true">#</a> 8.3 é…ç½®å­˜å‚¨</h3><h4 id="_8-3-1-configmap" tabindex="-1"><a class="header-anchor" href="#_8-3-1-configmap" aria-hidden="true">#</a> 8.3.1 ConfigMap</h4><p>ConfigMap æ˜¯ä¸€ç§æ¯”è¾ƒç‰¹æ®Šçš„å­˜å‚¨å·ï¼Œå®ƒçš„ä¸»è¦ä½œç”¨æ˜¯ç”¨æ¥å­˜å‚¨é…ç½®ä¿¡æ¯çš„ã€‚</p><p>åˆ›å»º configmap.yamlï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> configmap
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">info</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
    username:admin
    password:123456</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¥ä¸‹æ¥ï¼Œä½¿ç”¨æ­¤é…ç½®æ–‡ä»¶åˆ›å»º configmap</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># åˆ›å»º configmap</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f configmap.yaml</span>
configmap/configmap created

<span class="token comment"># æŸ¥çœ‹ configmap è¯¦æƒ…</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl describe cm configmap -n dev</span>
Name:         configmap
Namespace:    dev
Labels:       <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
Annotations:  <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>

Data
<span class="token operator">==</span><span class="token operator">==</span>
info:
----
username:admin
password:123456

Events:  <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¥ä¸‹æ¥åˆ›å»ºä¸€ä¸ª pod-configmap.yamlï¼Œå°†ä¸Šé¢åˆ›å»ºçš„ configmap æŒ‚è½½è¿›å»</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>configmap
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span> <span class="token comment"># å°† configmap æŒ‚è½½åˆ°ç›®å½•</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> config
      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /configmap/config
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span> <span class="token comment"># å¼•ç”¨ configmap</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> config
    <span class="token key atrule">configMap</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> configmap
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># åˆ›å»º pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pod-configmap.yaml</span>
pod/pod-configmap created

<span class="token comment"># æŸ¥çœ‹ pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod pod-configmap -n dev</span>
NAME            READY   STATUS    RESTARTS   AGE
pod-configmap   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          6s

<span class="token comment">#è¿›å…¥å®¹å™¨</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl exec -it pod-configmap -n dev /bin/sh</span>
<span class="token comment"># cd /configmap/config/</span>
<span class="token comment"># ls</span>
info
<span class="token comment"># more info</span>
username:admin
password:123456

<span class="token comment"># å¯ä»¥çœ‹åˆ°æ˜ å°„å·²ç»æˆåŠŸï¼Œæ¯ä¸ª configmap éƒ½æ˜ å°„æˆäº†ä¸€ä¸ªç›®å½•</span>
<span class="token comment"># key---&gt;æ–‡ä»¶     value----&gt;æ–‡ä»¶ä¸­çš„å†…å®¹</span>
<span class="token comment"># æ­¤æ—¶å¦‚æœæ›´æ–° configmap çš„å†…å®¹, å®¹å™¨ä¸­çš„å€¼ä¹Ÿä¼šåŠ¨æ€æ›´æ–°</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-3-2-secret" tabindex="-1"><a class="header-anchor" href="#_8-3-2-secret" aria-hidden="true">#</a> 8.3.2 Secret</h4><blockquote><p>åœ¨ kubernetes ä¸­ï¼Œè¿˜å­˜åœ¨ä¸€ç§å’Œ ConfigMap éå¸¸ç±»ä¼¼çš„å¯¹è±¡ï¼Œç§°ä¸º Secret å¯¹è±¡ã€‚å®ƒä¸»è¦ç”¨äºå­˜å‚¨æ•æ„Ÿä¿¡æ¯ï¼Œä¾‹å¦‚å¯†ç ã€ç§˜é’¥ã€è¯ä¹¦ç­‰ç­‰ã€‚</p></blockquote><ol><li>é¦–å…ˆä½¿ç”¨ base64 å¯¹æ•°æ®è¿›è¡Œç¼–ç </li></ol><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># echo -n &#39;admin&#39; | base64 #å‡†å¤‡ username</span>
<span class="token assign-left variable">YWRtaW4</span><span class="token operator">=</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># echo -n &#39;123456&#39; | base64 #å‡†å¤‡ password</span>
MTIzNDU2
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>æ¥ä¸‹æ¥ç¼–å†™ secret.yamlï¼Œå¹¶åˆ›å»º Secret</li></ol><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Secret
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> secret
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">type</span><span class="token punctuation">:</span> Opaque
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">username</span><span class="token punctuation">:</span> YWRtaW4=
  <span class="token key atrule">password</span><span class="token punctuation">:</span> MTIzNDU2
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># åˆ›å»º secret</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f secret.yaml</span>
secret/secret created

<span class="token comment"># æŸ¥çœ‹ secret è¯¦æƒ…</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl describe secret secret -n dev</span>
Name:         secret
Namespace:    dev
Labels:       <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
Annotations:  <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
Type:  Opaque
Data
<span class="token operator">==</span><span class="token operator">==</span>
password:  <span class="token number">6</span> bytes
username:  <span class="token number">5</span> bytes
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li>åˆ›å»º pod-secret.yamlï¼Œå°†ä¸Šé¢åˆ›å»ºçš„ secret æŒ‚è½½è¿›å»ï¼š</li></ol><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>secret
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span> <span class="token comment"># å°† secret æŒ‚è½½åˆ°ç›®å½•</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> config
      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /secret/config
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> config
    <span class="token key atrule">secret</span><span class="token punctuation">:</span>
      <span class="token key atrule">secretName</span><span class="token punctuation">:</span> secret
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># åˆ›å»º pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pod-secret.yaml</span>
pod/pod-secret created

<span class="token comment"># æŸ¥çœ‹ pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod pod-secret -n dev</span>
NAME            READY   STATUS    RESTARTS   AGE
pod-secret      <span class="token number">1</span>/1     Running   <span class="token number">0</span>          2m28s

<span class="token comment"># è¿›å…¥å®¹å™¨ï¼ŒæŸ¥çœ‹ secret ä¿¡æ¯ï¼Œå‘ç°å·²ç»è‡ªåŠ¨è§£ç äº†</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl exec -it pod-secret /bin/sh -n dev</span>
/ <span class="token comment"># ls /secret/config/</span>
password  username
/ <span class="token comment"># more /secret/config/username</span>
admin
/ <span class="token comment"># more /secret/config/password</span>
<span class="token number">123456</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è‡³æ­¤ï¼Œå·²ç»å®ç°äº†åˆ©ç”¨ secret å®ç°äº†ä¿¡æ¯çš„ç¼–ç ã€‚</p><h2 id="_9-å®‰å…¨è®¤è¯" tabindex="-1"><a class="header-anchor" href="#_9-å®‰å…¨è®¤è¯" aria-hidden="true">#</a> 9. å®‰å…¨è®¤è¯</h2><h3 id="_9-1-è®¿é—®æ§åˆ¶æ¦‚è¿°" tabindex="-1"><a class="header-anchor" href="#_9-1-è®¿é—®æ§åˆ¶æ¦‚è¿°" aria-hidden="true">#</a> 9.1 è®¿é—®æ§åˆ¶æ¦‚è¿°</h3><p>Kubernetes ä½œä¸ºä¸€ä¸ªåˆ†å¸ƒå¼é›†ç¾¤çš„ç®¡ç†å·¥å…·ï¼Œä¿è¯é›†ç¾¤çš„å®‰å…¨æ€§æ˜¯å…¶ä¸€ä¸ªé‡è¦çš„ä»»åŠ¡ã€‚æ‰€è°“çš„å®‰å…¨æ€§å…¶å®å°±æ˜¯ä¿è¯å¯¹ Kubernetes çš„å„ç§ <strong>å®¢æˆ·ç«¯</strong> è¿›è¡Œ <strong>è®¤è¯å’Œé‰´æƒ</strong> æ“ä½œã€‚</p><p><strong>å®¢æˆ·ç«¯</strong></p><p>åœ¨ Kubernetes é›†ç¾¤ä¸­ï¼Œå®¢æˆ·ç«¯é€šå¸¸æœ‰ä¸¤ç±»ï¼š</p><ul><li><strong>User Account</strong> ï¼šä¸€èˆ¬æ˜¯ç‹¬ç«‹äº kubernetes ä¹‹å¤–çš„å…¶ä»–æœåŠ¡ç®¡ç†çš„ç”¨æˆ·è´¦å·ã€‚</li><li><strong>Service Account</strong> ï¼škubernetes ç®¡ç†çš„è´¦å·ï¼Œç”¨äºä¸º Pod ä¸­çš„æœåŠ¡è¿›ç¨‹åœ¨è®¿é—® Kubernetes æ—¶æä¾›èº«ä»½æ ‡è¯†ã€‚</li></ul><figure><img src="/assets/img/k8s/image-20200520102949189.png" alt="ç›¸å…³å›¾ç‰‡" tabindex="0" loading="lazy"><figcaption>ç›¸å…³å›¾ç‰‡</figcaption></figure><p><strong>è®¤è¯ã€æˆæƒä¸å‡†å…¥æ§åˆ¶</strong></p><p>ApiServer æ˜¯è®¿é—®åŠç®¡ç†èµ„æºå¯¹è±¡çš„å”¯ä¸€å…¥å£ã€‚ä»»ä½•ä¸€ä¸ªè¯·æ±‚è®¿é—® ApiServerï¼Œéƒ½è¦ç»è¿‡ä¸‹é¢ä¸‰ä¸ªæµç¨‹ï¼š</p><ul><li><strong>Authenticationï¼ˆè®¤è¯ï¼‰ï¼š</strong> èº«ä»½é‰´åˆ«ï¼Œåªæœ‰æ­£ç¡®çš„è´¦å·æ‰èƒ½å¤Ÿé€šè¿‡è®¤è¯</li><li><strong>Authorizationï¼ˆæˆæƒï¼‰ï¼š</strong> åˆ¤æ–­ç”¨æˆ·æ˜¯å¦æœ‰æƒé™å¯¹è®¿é—®çš„èµ„æºæ‰§è¡Œç‰¹å®šçš„åŠ¨ä½œ</li><li><strong>Admission Controlï¼ˆå‡†å…¥æ§åˆ¶ï¼‰ï¼š</strong> ç”¨äºè¡¥å……æˆæƒæœºåˆ¶ä»¥å®ç°æ›´åŠ ç²¾ç»†çš„è®¿é—®æ§åˆ¶åŠŸèƒ½ã€‚</li></ul><figure><img src="/assets/img/k8s/image-20200520103942580.png" alt="ç›¸å…³å›¾ç‰‡" tabindex="0" loading="lazy"><figcaption>ç›¸å…³å›¾ç‰‡</figcaption></figure><h3 id="_9-2-è®¤è¯ç®¡ç†" tabindex="-1"><a class="header-anchor" href="#_9-2-è®¤è¯ç®¡ç†" aria-hidden="true">#</a> 9.2 è®¤è¯ç®¡ç†</h3><p>Kubernetes é›†ç¾¤å®‰å…¨çš„æœ€å…³é”®ç‚¹åœ¨äºå¦‚ä½•è¯†åˆ«å¹¶è®¤è¯å®¢æˆ·ç«¯èº«ä»½ï¼Œå®ƒæä¾›äº† 3 ç§å®¢æˆ·ç«¯èº«ä»½è®¤è¯æ–¹å¼ï¼š</p><ul><li><strong>HTTP Base è®¤è¯ï¼š</strong> é€šè¿‡ç”¨æˆ·å+å¯†ç çš„æ–¹å¼è®¤è¯</li></ul><p>è¿™ç§è®¤è¯æ–¹å¼æ˜¯æŠŠâ€œç”¨æˆ·å:å¯†ç â€ç”¨ BASE64 ç®—æ³•è¿›è¡Œç¼–ç åçš„å­—ç¬¦ä¸²æ”¾åœ¨ HTTP è¯·æ±‚ä¸­çš„ Header Authorization åŸŸé‡Œå‘é€ç»™æœåŠ¡ç«¯ã€‚æœåŠ¡ç«¯æ”¶åˆ°åè¿›è¡Œè§£ç ï¼Œè·å–ç”¨æˆ·ååŠå¯†ç ï¼Œç„¶åè¿›è¡Œç”¨æˆ·èº«ä»½è®¤è¯çš„è¿‡ç¨‹ã€‚</p><ul><li><strong>HTTP Token è®¤è¯ï¼š</strong> é€šè¿‡ä¸€ä¸ª Token æ¥è¯†åˆ«åˆæ³•ç”¨æˆ·</li></ul><p>è¿™ç§è®¤è¯æ–¹å¼æ˜¯ç”¨ä¸€ä¸ªå¾ˆé•¿çš„éš¾ä»¥è¢«æ¨¡ä»¿çš„å­—ç¬¦ä¸²--Token æ¥è¡¨æ˜å®¢æˆ·èº«ä»½çš„ä¸€ç§æ–¹å¼ã€‚æ¯ä¸ª Token å¯¹åº”ä¸€ä¸ªç”¨æˆ·åï¼Œå½“å®¢æˆ·ç«¯å‘èµ· API è°ƒç”¨è¯·æ±‚æ—¶ï¼Œéœ€è¦åœ¨ HTTP Header é‡Œæ”¾å…¥ Tokenï¼ŒAPI Server æ¥åˆ° Token åä¼šè·ŸæœåŠ¡å™¨ä¸­ä¿å­˜çš„ token è¿›è¡Œæ¯”å¯¹ï¼Œç„¶åè¿›è¡Œç”¨æˆ·èº«ä»½è®¤è¯çš„è¿‡ç¨‹ã€‚</p><ul><li><strong>HTTPS è¯ä¹¦è®¤è¯ï¼š</strong> åŸºäº CA æ ¹è¯ä¹¦ç­¾åçš„åŒå‘æ•°å­—è¯ä¹¦è®¤è¯æ–¹å¼</li></ul><p>è¿™ç§è®¤è¯æ–¹å¼æ˜¯å®‰å…¨æ€§æœ€é«˜çš„ä¸€ç§æ–¹å¼ï¼Œä½†æ˜¯åŒæ—¶ä¹Ÿæ˜¯æ“ä½œèµ·æ¥æœ€éº»çƒ¦çš„ä¸€ç§æ–¹å¼ã€‚</p><figure><img src="/assets/img/k8s/image-20200518211037434.png" alt="ç›¸å…³å›¾ç‰‡" tabindex="0" loading="lazy"><figcaption>ç›¸å…³å›¾ç‰‡</figcaption></figure><p><strong>HTTPS è®¤è¯å¤§ä½“åˆ†ä¸º 3 ä¸ªè¿‡ç¨‹ï¼š</strong></p><ol><li><p>è¯ä¹¦ç”³è¯·å’Œä¸‹å‘</p><ul><li>HTTPS é€šä¿¡åŒæ–¹çš„æœåŠ¡å™¨å‘ CA æœºæ„ç”³è¯·è¯ä¹¦ï¼ŒCA æœºæ„ä¸‹å‘æ ¹è¯ä¹¦ã€æœåŠ¡ç«¯è¯ä¹¦åŠç§é’¥ç»™ç”³è¯·è€…</li></ul></li><li><p>å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„åŒå‘è®¤è¯</p><ul><li>å®¢æˆ·ç«¯å‘æœåŠ¡å™¨ç«¯å‘èµ·è¯·æ±‚ï¼ŒæœåŠ¡ç«¯ä¸‹å‘è‡ªå·±çš„è¯ä¹¦ç»™å®¢æˆ·ç«¯ï¼Œ å®¢æˆ·ç«¯æ¥æ”¶åˆ°è¯ä¹¦åï¼Œé€šè¿‡ç§é’¥è§£å¯†è¯ä¹¦ï¼Œåœ¨è¯ä¹¦ä¸­è·å¾—æœåŠ¡ç«¯çš„å…¬é’¥ï¼Œ å®¢æˆ·ç«¯åˆ©ç”¨æœåŠ¡å™¨ç«¯çš„å…¬é’¥è®¤è¯è¯ä¹¦ä¸­çš„ä¿¡æ¯ï¼Œå¦‚æœä¸€è‡´ï¼Œåˆ™è®¤å¯è¿™ä¸ªæœåŠ¡å™¨</li><li>å®¢æˆ·ç«¯å‘é€è‡ªå·±çš„è¯ä¹¦ç»™æœåŠ¡å™¨ç«¯ï¼ŒæœåŠ¡ç«¯æ¥æ”¶åˆ°è¯ä¹¦åï¼Œé€šè¿‡ç§é’¥è§£å¯†è¯ä¹¦ï¼Œ åœ¨è¯ä¹¦ä¸­è·å¾—å®¢æˆ·ç«¯çš„å…¬é’¥ï¼Œå¹¶ç”¨è¯¥å…¬é’¥è®¤è¯è¯ä¹¦ä¿¡æ¯ï¼Œç¡®è®¤å®¢æˆ·ç«¯æ˜¯å¦åˆæ³•</li></ul></li><li><p>æœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯è¿›è¡Œé€šä¿¡</p><ul><li><p>æœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯åå•†å¥½åŠ å¯†æ–¹æ¡ˆåï¼Œå®¢æˆ·ç«¯ä¼šäº§ç”Ÿä¸€ä¸ªéšæœºçš„ç§˜é’¥å¹¶åŠ å¯†ï¼Œç„¶åå‘é€åˆ°æœåŠ¡å™¨ç«¯ã€‚</p></li><li><p>æœåŠ¡å™¨ç«¯æ¥æ”¶è¿™ä¸ªç§˜é’¥åï¼ŒåŒæ–¹æ¥ä¸‹æ¥é€šä¿¡çš„æ‰€æœ‰å†…å®¹éƒ½é€šè¿‡è¯¥éšæœºç§˜é’¥åŠ å¯†</p></li></ul></li></ol><blockquote><p>æ³¨æ„: Kubernetes å…è®¸åŒæ—¶é…ç½®å¤šç§è®¤è¯æ–¹å¼ï¼Œåªè¦å…¶ä¸­ä»»æ„ä¸€ä¸ªæ–¹å¼è®¤è¯é€šè¿‡å³å¯</p></blockquote><h3 id="_9-3-æˆæƒç®¡ç†" tabindex="-1"><a class="header-anchor" href="#_9-3-æˆæƒç®¡ç†" aria-hidden="true">#</a> 9.3 æˆæƒç®¡ç†</h3><p>æˆæƒå‘ç”Ÿåœ¨è®¤è¯æˆåŠŸä¹‹åï¼Œé€šè¿‡è®¤è¯å°±å¯ä»¥çŸ¥é“è¯·æ±‚ç”¨æˆ·æ˜¯è°ï¼Œ ç„¶å Kubernetes ä¼šæ ¹æ®äº‹å…ˆå®šä¹‰çš„æˆæƒç­–ç•¥æ¥å†³å®šç”¨æˆ·æ˜¯å¦æœ‰æƒé™è®¿é—®ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±ç§°ä¸ºæˆæƒã€‚</p><p>æ¯ä¸ªå‘é€åˆ° ApiServer çš„è¯·æ±‚éƒ½å¸¦ä¸Šäº†ç”¨æˆ·å’Œèµ„æºçš„ä¿¡æ¯ï¼šæ¯”å¦‚å‘é€è¯·æ±‚çš„ç”¨æˆ·ã€è¯·æ±‚çš„è·¯å¾„ã€è¯·æ±‚çš„åŠ¨ä½œç­‰ï¼Œæˆæƒå°±æ˜¯æ ¹æ®è¿™äº›ä¿¡æ¯å’Œæˆæƒç­–ç•¥è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœç¬¦åˆç­–ç•¥ï¼Œåˆ™è®¤ä¸ºæˆæƒé€šè¿‡ï¼Œå¦åˆ™ä¼šè¿”å›é”™è¯¯ã€‚</p><p>API Server ç›®å‰æ”¯æŒä»¥ä¸‹å‡ ç§æˆæƒç­–ç•¥ï¼š</p><ul><li>AlwaysDenyï¼šè¡¨ç¤ºæ‹’ç»æ‰€æœ‰è¯·æ±‚ï¼Œä¸€èˆ¬ç”¨äºæµ‹è¯•</li><li>AlwaysAllowï¼šå…è®¸æ¥æ”¶æ‰€æœ‰è¯·æ±‚ï¼Œç›¸å½“äºé›†ç¾¤ä¸éœ€è¦æˆæƒæµç¨‹ï¼ˆKubernetes é»˜è®¤çš„ç­–ç•¥ï¼‰</li><li>ABACï¼šåŸºäºå±æ€§çš„è®¿é—®æ§åˆ¶ï¼Œè¡¨ç¤ºä½¿ç”¨ç”¨æˆ·é…ç½®çš„æˆæƒè§„åˆ™å¯¹ç”¨æˆ·è¯·æ±‚è¿›è¡ŒåŒ¹é…å’Œæ§åˆ¶</li><li>Webhookï¼šé€šè¿‡è°ƒç”¨å¤–éƒ¨ REST æœåŠ¡å¯¹ç”¨æˆ·è¿›è¡Œæˆæƒ</li><li>Nodeï¼šæ˜¯ä¸€ç§ä¸“ç”¨æ¨¡å¼ï¼Œç”¨äºå¯¹ kubelet å‘å‡ºçš„è¯·æ±‚è¿›è¡Œè®¿é—®æ§åˆ¶</li><li>RBACï¼šåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆkubeadm å®‰è£…æ–¹å¼ä¸‹çš„é»˜è®¤é€‰é¡¹ï¼‰</li></ul><p>RBAC(Role-Based Access Control) åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼Œä¸»è¦æ˜¯åœ¨æè¿°ä¸€ä»¶äº‹æƒ…ï¼š <strong>ç»™å“ªäº›å¯¹è±¡æˆäºˆäº†å“ªäº›æƒé™</strong></p><p>å…¶ä¸­æ¶‰åŠåˆ°äº†ä¸‹é¢å‡ ä¸ªæ¦‚å¿µï¼š</p><ul><li>å¯¹è±¡ï¼šUserã€Groupsã€ServiceAccount</li><li>è§’è‰²ï¼šä»£è¡¨ç€ä¸€ç»„å®šä¹‰åœ¨èµ„æºä¸Šçš„å¯æ“ä½œåŠ¨ä½œ(æƒé™)çš„é›†åˆ</li><li>ç»‘å®šï¼šå°†å®šä¹‰å¥½çš„è§’è‰²è·Ÿç”¨æˆ·ç»‘å®šåœ¨ä¸€èµ·</li></ul><figure><img src="/assets/img/k8s/image-20200519181209566.png" alt="ç›¸å…³å›¾ç‰‡" height="300" tabindex="0" loading="lazy"><figcaption>ç›¸å…³å›¾ç‰‡</figcaption></figure><p>RBAC å¼•å…¥äº† 4 ä¸ªé¡¶çº§èµ„æºå¯¹è±¡ï¼š</p><ul><li>Roleã€ClusterRoleï¼šè§’è‰²ï¼Œç”¨äºæŒ‡å®šä¸€ç»„æƒé™</li><li>RoleBindingã€ClusterRoleBindingï¼šè§’è‰²ç»‘å®šï¼Œç”¨äºå°†è§’è‰²ï¼ˆæƒé™ï¼‰èµ‹äºˆç»™å¯¹è±¡</li></ul><p><strong>Roleã€ClusterRole</strong></p><p>ä¸€ä¸ªè§’è‰²å°±æ˜¯ä¸€ç»„æƒé™çš„é›†åˆï¼Œè¿™é‡Œçš„æƒé™éƒ½æ˜¯è®¸å¯å½¢å¼çš„ï¼ˆç™½åå•ï¼‰ã€‚</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token comment"># Role åªèƒ½å¯¹å‘½åç©ºé—´å†…çš„èµ„æºè¿›è¡Œæˆæƒï¼Œéœ€è¦æŒ‡å®š nameapce</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Role
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1beta1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
  <span class="token key atrule">name</span><span class="token punctuation">:</span> authorization<span class="token punctuation">-</span>role
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;&quot;</span><span class="token punctuation">]</span>  <span class="token comment"># æ”¯æŒçš„ API ç»„åˆ—è¡¨,&quot;&quot; ç©ºå­—ç¬¦ä¸²ï¼Œè¡¨ç¤ºæ ¸å¿ƒ API ç¾¤</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;pods&quot;</span><span class="token punctuation">]</span> <span class="token comment"># æ”¯æŒçš„èµ„æºå¯¹è±¡åˆ—è¡¨</span>
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;watch&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;list&quot;</span><span class="token punctuation">]</span> <span class="token comment"># å…è®¸çš„å¯¹èµ„æºå¯¹è±¡çš„æ“ä½œæ–¹æ³•åˆ—è¡¨</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token comment"># ClusterRole å¯ä»¥å¯¹é›†ç¾¤èŒƒå›´å†…èµ„æºã€è·¨ namespaces çš„èŒƒå›´èµ„æºã€éèµ„æºç±»å‹è¿›è¡Œæˆæƒ</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1beta1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
 <span class="token key atrule">name</span><span class="token punctuation">:</span> authorization<span class="token punctuation">-</span>clusterrole
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;&quot;</span><span class="token punctuation">]</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;pods&quot;</span><span class="token punctuation">]</span>
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;watch&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;list&quot;</span><span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>éœ€è¦è¯¦ç»†è¯´æ˜çš„æ˜¯ï¼Œrules ä¸­çš„å‚æ•°ï¼š</p><ul><li><p>apiGroups: æ”¯æŒçš„ API ç»„åˆ—è¡¨</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token string">&quot;&quot;</span>,<span class="token string">&quot;apps&quot;</span>, <span class="token string">&quot;autoscaling&quot;</span>, <span class="token string">&quot;batch&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>resourcesï¼šæ”¯æŒçš„èµ„æºå¯¹è±¡åˆ—è¡¨</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token string">&quot;services&quot;</span>, <span class="token string">&quot;endpoints&quot;</span>, <span class="token string">&quot;pods&quot;</span>,<span class="token string">&quot;secrets&quot;</span>,<span class="token string">&quot;configmaps&quot;</span>,<span class="token string">&quot;crontabs&quot;</span>,<span class="token string">&quot;deployments&quot;</span>,<span class="token string">&quot;jobs&quot;</span>,
<span class="token string">&quot;nodes&quot;</span>,<span class="token string">&quot;rolebindings&quot;</span>,<span class="token string">&quot;clusterroles&quot;</span>,<span class="token string">&quot;daemonsets&quot;</span>,<span class="token string">&quot;replicasets&quot;</span>,<span class="token string">&quot;statefulsets&quot;</span>,
<span class="token string">&quot;horizontalpodautoscalers&quot;</span>,<span class="token string">&quot;replicationcontrollers&quot;</span>,<span class="token string">&quot;cronjobs&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>verbsï¼šå¯¹èµ„æºå¯¹è±¡çš„æ“ä½œæ–¹æ³•åˆ—è¡¨</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token string">&quot;get&quot;</span>, <span class="token string">&quot;list&quot;</span>, <span class="token string">&quot;watch&quot;</span>, <span class="token string">&quot;create&quot;</span>, <span class="token string">&quot;update&quot;</span>, <span class="token string">&quot;patch&quot;</span>, <span class="token string">&quot;delete&quot;</span>, <span class="token string">&quot;exec&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li></ul><p><strong>RoleBindingã€ClusterRoleBinding</strong></p><p>è§’è‰²ç»‘å®šç”¨æ¥æŠŠä¸€ä¸ªè§’è‰²ç»‘å®šåˆ°ä¸€ä¸ªç›®æ ‡å¯¹è±¡ä¸Šï¼Œç»‘å®šç›®æ ‡å¯ä»¥æ˜¯ Userã€Group æˆ–è€… ServiceAccountã€‚</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token comment"># RoleBinding å¯ä»¥å°†åŒä¸€ namespace ä¸­çš„ subject ç»‘å®šåˆ°æŸä¸ª Role ä¸‹ï¼Œåˆ™æ­¤ subject å³å…·æœ‰è¯¥ Role å®šä¹‰çš„æƒé™</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> RoleBinding
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1beta1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> authorization<span class="token punctuation">-</span>role<span class="token punctuation">-</span>binding
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> User
  <span class="token key atrule">name</span><span class="token punctuation">:</span> heima
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> Role
  <span class="token key atrule">name</span><span class="token punctuation">:</span> authorization<span class="token punctuation">-</span>role
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token comment"># ClusterRoleBinding åœ¨æ•´ä¸ªé›†ç¾¤çº§åˆ«å’Œæ‰€æœ‰ namespaces å°†ç‰¹å®šçš„ subject ä¸ ClusterRole ç»‘å®šï¼Œæˆäºˆæƒé™</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1beta1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
 <span class="token key atrule">name</span><span class="token punctuation">:</span> authorization<span class="token punctuation">-</span>clusterrole<span class="token punctuation">-</span>binding
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> User
  <span class="token key atrule">name</span><span class="token punctuation">:</span> heima
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
  <span class="token key atrule">name</span><span class="token punctuation">:</span> authorization<span class="token punctuation">-</span>clusterrole
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>RoleBinding å¼•ç”¨ ClusterRole è¿›è¡Œæˆæƒ</strong></p><p>RoleBinding å¯ä»¥å¼•ç”¨ ClusterRoleï¼Œå¯¹å±äºåŒä¸€å‘½åç©ºé—´å†… ClusterRole å®šä¹‰çš„èµ„æºä¸»ä½“è¿›è¡Œæˆæƒã€‚</p><p>ä¸€ç§å¾ˆå¸¸ç”¨çš„åšæ³•å°±æ˜¯ï¼Œé›†ç¾¤ç®¡ç†å‘˜ä¸ºé›†ç¾¤èŒƒå›´é¢„å®šä¹‰å¥½ä¸€ç»„è§’è‰²ï¼ˆClusterRoleï¼‰ï¼Œç„¶ååœ¨å¤šä¸ªå‘½åç©ºé—´ä¸­é‡å¤ä½¿ç”¨è¿™äº› ClusterRoleã€‚è¿™æ ·å¯ä»¥å¤§å¹…æé«˜æˆæƒç®¡ç†å·¥ä½œæ•ˆç‡ï¼Œä¹Ÿä½¿å¾—å„ä¸ªå‘½åç©ºé—´ä¸‹çš„åŸºç¡€æ€§æˆæƒè§„åˆ™ä¸ä½¿ç”¨ä½“éªŒä¿æŒä¸€è‡´ã€‚</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token comment"># è™½ç„¶ authorization-clusterrole æ˜¯ä¸€ä¸ªé›†ç¾¤è§’è‰²ï¼Œä½†æ˜¯å› ä¸ºä½¿ç”¨äº† RoleBinding</span>
<span class="token comment"># æ‰€ä»¥ heima åªèƒ½è¯»å– dev å‘½åç©ºé—´ä¸­çš„èµ„æº</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> RoleBinding
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1beta1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> authorization<span class="token punctuation">-</span>role<span class="token punctuation">-</span>binding<span class="token punctuation">-</span>ns
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> User
  <span class="token key atrule">name</span><span class="token punctuation">:</span> heima
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
  <span class="token key atrule">name</span><span class="token punctuation">:</span> authorization<span class="token punctuation">-</span>clusterrole
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>å®æˆ˜ï¼šåˆ›å»ºä¸€ä¸ªåªèƒ½ç®¡ç† dev ç©ºé—´ä¸‹ Pods èµ„æºçš„è´¦å·</strong></p><ol><li>åˆ›å»ºè´¦å·</li></ol><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 1) åˆ›å»ºè¯ä¹¦</span>
<span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># cd /etc/kubernetes/pki/</span>
<span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># (umask 077;openssl genrsa -out devman.key 2048)</span>

<span class="token comment"># 2) ç”¨ apiserver çš„è¯ä¹¦å»ç­¾ç½²</span>
<span class="token comment"># 2-1) ç­¾åç”³è¯·ï¼Œç”³è¯·çš„ç”¨æˆ·æ˜¯ devman,ç»„æ˜¯ devgroup</span>
<span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># openssl req -new -key devman.key -out devman.csr -subj &quot;/CN=devman/O=devgroup&quot;     </span>
<span class="token comment"># 2-2) ç­¾ç½²è¯ä¹¦</span>
<span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># openssl x509 -req -in devman.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out devman.crt -days 3650</span>

<span class="token comment"># 3) è®¾ç½®é›†ç¾¤ã€ç”¨æˆ·ã€ä¸Šä¸‹æ–‡ä¿¡æ¯</span>
<span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># kubectl config set-cluster kubernetes --embed-certs=true --certificate-authority=/etc/kubernetes/pki/ca.crt --server=https://192.168.109.100:6443</span>

<span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># kubectl config set-credentials devman --embed-certs=true --client-certificate=/etc/kubernetes/pki/devman.crt --client-key=/etc/kubernetes/pki/devman.key</span>

<span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># kubectl config set-context devman@kubernetes --cluster=kubernetes --user=devman</span>

<span class="token comment"># åˆ‡æ¢è´¦æˆ·åˆ° devman</span>
<span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># kubectl config use-context devman@kubernetes</span>
Switched to context <span class="token string">&quot;devman@kubernetes&quot;</span><span class="token builtin class-name">.</span>

<span class="token comment"># æŸ¥çœ‹ dev ä¸‹ podï¼Œå‘ç°æ²¡æœ‰æƒé™</span>
<span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev</span>
Error from server <span class="token punctuation">(</span>Forbidden<span class="token punctuation">)</span>: pods is forbidden: User <span class="token string">&quot;devman&quot;</span> cannot list resource <span class="token string">&quot;pods&quot;</span> <span class="token keyword">in</span> API group <span class="token string">&quot;&quot;</span> <span class="token keyword">in</span> the namespace <span class="token string">&quot;dev&quot;</span>

<span class="token comment"># åˆ‡æ¢åˆ° admin è´¦æˆ·</span>
<span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># kubectl config use-context kubernetes-admin@kubernetes</span>
Switched to context <span class="token string">&quot;kubernetes-admin@kubernetes&quot;</span><span class="token builtin class-name">.</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2ï¼‰ åˆ›å»º Role å’Œ RoleBindingï¼Œä¸º devman ç”¨æˆ·æˆæƒ</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">kind</span><span class="token punctuation">:</span> Role
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1beta1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
  <span class="token key atrule">name</span><span class="token punctuation">:</span> dev<span class="token punctuation">-</span>role
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;&quot;</span><span class="token punctuation">]</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;pods&quot;</span><span class="token punctuation">]</span>
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;watch&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;list&quot;</span><span class="token punctuation">]</span>
  
<span class="token punctuation">---</span>

<span class="token key atrule">kind</span><span class="token punctuation">:</span> RoleBinding
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1beta1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> authorization<span class="token punctuation">-</span>role<span class="token punctuation">-</span>binding
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> User
  <span class="token key atrule">name</span><span class="token punctuation">:</span> devman
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> Role
  <span class="token key atrule">name</span><span class="token punctuation">:</span> dev<span class="token punctuation">-</span>role
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># kubectl create -f dev-role.yaml</span>
role.rbac.authorization.k8s.io/dev-role created
rolebinding.rbac.authorization.k8s.io/authorization-role-binding created
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li>åˆ‡æ¢è´¦æˆ·ï¼Œå†æ¬¡éªŒè¯</li></ol><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># åˆ‡æ¢è´¦æˆ·åˆ° devman</span>
<span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># kubectl config use-context devman@kubernetes</span>
Switched to context <span class="token string">&quot;devman@kubernetes&quot;</span><span class="token builtin class-name">.</span>

<span class="token comment"># å†æ¬¡æŸ¥çœ‹</span>
<span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev</span>
NAME                                 READY   STATUS             RESTARTS   AGE
nginx-deployment-66cb59b984-8wp2k    <span class="token number">1</span>/1     Running            <span class="token number">0</span>          4d1h
nginx-deployment-66cb59b984-dc46j    <span class="token number">1</span>/1     Running            <span class="token number">0</span>          4d1h
nginx-deployment-66cb59b984-thfck    <span class="token number">1</span>/1     Running            <span class="token number">0</span>          4d1h

<span class="token comment"># ä¸ºäº†ä¸å½±å“åé¢çš„å­¦ä¹ ,åˆ‡å› admin è´¦æˆ·</span>
<span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># kubectl config use-context kubernetes-admin@kubernetes</span>
Switched to context <span class="token string">&quot;kubernetes-admin@kubernetes&quot;</span><span class="token builtin class-name">.</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_9-4-å‡†å…¥æ§åˆ¶" tabindex="-1"><a class="header-anchor" href="#_9-4-å‡†å…¥æ§åˆ¶" aria-hidden="true">#</a> 9.4 å‡†å…¥æ§åˆ¶</h3><p>é€šè¿‡äº†å‰é¢çš„è®¤è¯å’Œæˆæƒä¹‹åï¼Œè¿˜éœ€è¦ç»è¿‡å‡†å…¥æ§åˆ¶å¤„ç†é€šè¿‡ä¹‹åï¼Œapiserver æ‰ä¼šå¤„ç†è¿™ä¸ªè¯·æ±‚ã€‚</p><p>å‡†å…¥æ§åˆ¶æ˜¯ä¸€ä¸ªå¯é…ç½®çš„æ§åˆ¶å™¨åˆ—è¡¨ï¼Œå¯ä»¥é€šè¿‡åœ¨ Api-Server ä¸Šé€šè¿‡å‘½ä»¤è¡Œè®¾ç½®é€‰æ‹©æ‰§è¡Œå“ªäº›å‡†å…¥æ§åˆ¶å™¨ï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>--admission-control<span class="token operator">=</span>NamespaceLifecycle,LimitRanger,ServiceAccount,PersistentVolumeLabel,
                      DefaultStorageClass,ResourceQuota,DefaultTolerationSeconds
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>åªæœ‰å½“æ‰€æœ‰çš„å‡†å…¥æ§åˆ¶å™¨éƒ½æ£€æŸ¥é€šè¿‡ä¹‹åï¼Œapiserver æ‰æ‰§è¡Œè¯¥è¯·æ±‚ï¼Œå¦åˆ™è¿”å›æ‹’ç»ã€‚</p><p>å½“å‰å¯é…ç½®çš„ Admission Control å‡†å…¥æ§åˆ¶å¦‚ä¸‹ï¼š</p><ul><li>AlwaysAdmitï¼šå…è®¸æ‰€æœ‰è¯·æ±‚</li><li>AlwaysDenyï¼šç¦æ­¢æ‰€æœ‰è¯·æ±‚ï¼Œä¸€èˆ¬ç”¨äºæµ‹è¯•</li><li>AlwaysPullImagesï¼šåœ¨å¯åŠ¨å®¹å™¨ä¹‹å‰æ€»å»ä¸‹è½½é•œåƒ</li><li>DenyExecOnPrivilegedï¼šå®ƒä¼šæ‹¦æˆªæ‰€æœ‰æƒ³åœ¨ Privileged Container ä¸Šæ‰§è¡Œå‘½ä»¤çš„è¯·æ±‚</li><li>ImagePolicyWebhookï¼šè¿™ä¸ªæ’ä»¶å°†å…è®¸åç«¯çš„ä¸€ä¸ª Webhook ç¨‹åºæ¥å®Œæˆ admission controller çš„åŠŸèƒ½ã€‚</li><li>Service Accountï¼šå®ç° ServiceAccount å®ç°äº†è‡ªåŠ¨åŒ–</li><li>SecurityContextDenyï¼šè¿™ä¸ªæ’ä»¶å°†ä½¿ç”¨ SecurityContext çš„ Pod ä¸­çš„å®šä¹‰å…¨éƒ¨å¤±æ•ˆ</li><li>ResourceQuotaï¼šç”¨äºèµ„æºé…é¢ç®¡ç†ç›®çš„ï¼Œè§‚å¯Ÿæ‰€æœ‰è¯·æ±‚ï¼Œç¡®ä¿åœ¨ namespace ä¸Šçš„é…é¢ä¸ä¼šè¶…æ ‡</li><li>LimitRangerï¼šç”¨äºèµ„æºé™åˆ¶ç®¡ç†ï¼Œä½œç”¨äº namespace ä¸Šï¼Œç¡®ä¿å¯¹ Pod è¿›è¡Œèµ„æºé™åˆ¶</li><li>InitialResourcesï¼šä¸ºæœªè®¾ç½®èµ„æºè¯·æ±‚ä¸é™åˆ¶çš„ Podï¼Œæ ¹æ®å…¶é•œåƒçš„å†å²èµ„æºçš„ä½¿ç”¨æƒ…å†µè¿›è¡Œè®¾ç½®</li><li>NamespaceLifecycleï¼šå¦‚æœå°è¯•åœ¨ä¸€ä¸ªä¸å­˜åœ¨çš„ namespace ä¸­åˆ›å»ºèµ„æºå¯¹è±¡ï¼Œåˆ™è¯¥åˆ›å»ºè¯·æ±‚å°†è¢«æ‹’ç»ã€‚å½“åˆ é™¤ä¸€ä¸ª namespace æ—¶ï¼Œç³»ç»Ÿå°†ä¼šåˆ é™¤è¯¥ namespace ä¸­æ‰€æœ‰å¯¹è±¡ã€‚</li><li>DefaultStorageClassï¼šä¸ºäº†å®ç°å…±äº«å­˜å‚¨çš„åŠ¨æ€ä¾›åº”ï¼Œä¸ºæœªæŒ‡å®š StorageClass æˆ– PV çš„ PVC å°è¯•åŒ¹é…é»˜è®¤çš„ StorageClassï¼Œå°½å¯èƒ½å‡å°‘ç”¨æˆ·åœ¨ç”³è¯· PVC æ—¶æ‰€éœ€äº†è§£çš„åç«¯å­˜å‚¨ç»†èŠ‚</li><li>DefaultTolerationSecondsï¼šè¿™ä¸ªæ’ä»¶ä¸ºé‚£äº›æ²¡æœ‰è®¾ç½® forgiveness tolerations å¹¶å…·æœ‰ notready:NoExecute å’Œ unreachable:NoExecute ä¸¤ç§ taints çš„ Pod è®¾ç½®é»˜è®¤çš„â€œå®¹å¿â€æ—¶é—´ï¼Œä¸º 5min</li><li>PodSecurityPolicyï¼šè¿™ä¸ªæ’ä»¶ç”¨äºåœ¨åˆ›å»ºæˆ–ä¿®æ”¹ Pod æ—¶å†³å®šæ˜¯å¦æ ¹æ® Pod çš„ security context å’Œå¯ç”¨çš„ PodSecurityPolicy å¯¹ Pod çš„å®‰å…¨ç­–ç•¥è¿›è¡Œæ§åˆ¶</li></ul><h2 id="_10-dashboard" tabindex="-1"><a class="header-anchor" href="#_10-dashboard" aria-hidden="true">#</a> 10. DashBoard</h2><p>ä¹‹å‰åœ¨ kubernetes ä¸­å®Œæˆçš„æ‰€æœ‰æ“ä½œéƒ½æ˜¯é€šè¿‡å‘½ä»¤è¡Œå·¥å…· kubectl å®Œæˆçš„ã€‚å…¶å®ï¼Œä¸ºäº†æä¾›æ›´ä¸°å¯Œçš„ç”¨æˆ·ä½“éªŒï¼Œkubernetes è¿˜å¼€å‘äº†ä¸€ä¸ªåŸºäº web çš„ç”¨æˆ·ç•Œé¢ï¼ˆDashboardï¼‰ã€‚ç”¨æˆ·å¯ä»¥ä½¿ç”¨ Dashboard éƒ¨ç½²å®¹å™¨åŒ–çš„åº”ç”¨ï¼Œè¿˜å¯ä»¥ç›‘æ§åº”ç”¨çš„çŠ¶æ€ï¼Œæ‰§è¡Œæ•…éšœæ’æŸ¥ä»¥åŠç®¡ç† kubernetes ä¸­å„ç§èµ„æºã€‚</p><h3 id="_10-1-éƒ¨ç½²-dashboard" tabindex="-1"><a class="header-anchor" href="#_10-1-éƒ¨ç½²-dashboard" aria-hidden="true">#</a> 10.1 éƒ¨ç½² Dashboard</h3><ol><li>ä¸‹è½½ yamlï¼Œå¹¶è¿è¡Œ Dashboard</li></ol><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># ä¸‹è½½ yaml</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># wget  https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0/aio/deploy/recommended.yaml</span>

<span class="token comment"># ä¿®æ”¹ kubernetes-dashboard çš„ Service ç±»å‹</span>
kind: Service
apiVersion: v1
metadata:
  labels:
    k8s-app: kubernetes-dashboard
  name: kubernetes-dashboard
  namespace: kubernetes-dashboard
spec:
  type: NodePort  <span class="token comment"># æ–°å¢</span>
  ports:
    - port: <span class="token number">443</span>
      targetPort: <span class="token number">8443</span>
      nodePort: <span class="token number">30009</span>  <span class="token comment"># æ–°å¢</span>
  selector:
    k8s-app: kubernetes-dashboard

<span class="token comment"># éƒ¨ç½²</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f recommended.yaml</span>

<span class="token comment"># æŸ¥çœ‹ namespace ä¸‹çš„ kubernetes-dashboard ä¸‹çš„èµ„æº</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod,svc -n kubernetes-dashboard</span>
NAME                                            READY   STATUS    RESTARTS   AGE
pod/dashboard-metrics-scraper-c79c65bb7-zwfvw   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          111s
pod/kubernetes-dashboard-56484d4c5-z95z5        <span class="token number">1</span>/1     Running   <span class="token number">0</span>          111s

NAME                               TYPE       CLUSTER-IP      EXTERNAL-IP  PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>         AGE
service/dashboard-metrics-scraper  ClusterIP  <span class="token number">10.96</span>.89.218    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>       <span class="token number">8000</span>/TCP        111s
service/kubernetes-dashboard       NodePort   <span class="token number">10.104</span>.178.171  <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>       <span class="token number">443</span>:30009/TCP   111s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2ï¼‰åˆ›å»ºè®¿é—®è´¦æˆ·ï¼Œè·å– token</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># åˆ›å»ºè´¦å·</span>
<span class="token punctuation">[</span>root@k8s-master01-1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create serviceaccount dashboard-admin -n kubernetes-dashboard</span>

<span class="token comment"># æˆæƒ</span>
<span class="token punctuation">[</span>root@k8s-master01-1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create clusterrolebinding dashboard-admin-rb --clusterrole=cluster-admin --serviceaccount=kubernetes-dashboard:dashboard-admin</span>

<span class="token comment"># è·å–è´¦å· token</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment">#  kubectl get secrets -n kubernetes-dashboard | grep dashboard-admin</span>
dashboard-admin-token-xbqhh        kubernetes.io/service-account-token   <span class="token number">3</span>      2m35s

<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl describe secrets dashboard-admin-token-xbqhh -n kubernetes-dashboard</span>
Name:         dashboard-admin-token-xbqhh
Namespace:    kubernetes-dashboard
Labels:       <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
Annotations:  kubernetes.io/service-account.name: dashboard-admin
              kubernetes.io/service-account.uid: 95d84d80-be7a-4d10-a2e0-68f90222d039

Type:  kubernetes.io/service-account-token

Data
<span class="token operator">==</span><span class="token operator">==</span>
namespace:  <span class="token number">20</span> bytes
token:      eyJhbGciOiJSUzI1NiIsImtpZCI6ImJrYkF4bW5XcDhWcmNGUGJtek5NODFuSXl1aWptMmU2M3o4LTY5a2FKS2cifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJkYXNoYm9hcmQtYWRtaW4tdG9rZW4teGJxaGgiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiZGFzaGJvYXJkLWFkbWluIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQudWlkIjoiOTVkODRkODAtYmU3YS00ZDEwLWEyZTAtNjhmOTAyMjJkMDM5Iiwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50Omt1YmVybmV0ZXMtZGFzaGJvYXJkOmRhc2hib2FyZC1hZG1pbiJ9.NAl7e8ZfWWdDoPxkqzJzTB46sK9E8iuJYnUI9vnBaY3Jts7T1g1msjsBnbxzQSYgAG--cV0WYxjndzJY_UWCwaGPrQrt_GunxmOK9AUnzURqm55GR2RXIZtjsWVP2EBatsDgHRmuUbQvTFOvdJB4x3nXcYLN2opAaMqg3rnU2rr-A8zCrIuX_eca12wIp_QiuP3SF-tzpdLpsyRfegTJZl6YnSGyaVkC9id-cxZRb307qdCfXPfCHR_2rt5FVfxARgg_C0e3eFHaaYQO7CitxsnIoIXpOFNAR8aUrmopJyODQIPqBWUehb7FhlU1DCduHnIIXVC_UICZ-MKYewBDLw
ca.crt:     <span class="token number">1025</span> bytes
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3ï¼‰é€šè¿‡æµè§ˆå™¨è®¿é—® Dashboard çš„ UI</p><p>åœ¨ç™»å½•é¡µé¢ä¸Šè¾“å…¥ä¸Šé¢çš„ token</p><figure><img src="/assets/img/k8s/image-20200520144548997.png" alt="ç›¸å…³å›¾ç‰‡" height="300" tabindex="0" loading="lazy"><figcaption>ç›¸å…³å›¾ç‰‡</figcaption></figure><p>å‡ºç°ä¸‹é¢çš„é¡µé¢ä»£è¡¨æˆåŠŸ</p><figure><img src="/assets/img/k8s/image-20200520144959353.png" alt="ç›¸å…³å›¾ç‰‡" tabindex="0" loading="lazy"><figcaption>ç›¸å…³å›¾ç‰‡</figcaption></figure><h3 id="_10-2-ä½¿ç”¨-dashboard" tabindex="-1"><a class="header-anchor" href="#_10-2-ä½¿ç”¨-dashboard" aria-hidden="true">#</a> 10.2 ä½¿ç”¨ DashBoard</h3><p>æœ¬ç« èŠ‚ä»¥ Deployment ä¸ºä¾‹æ¼”ç¤º DashBoard çš„ä½¿ç”¨</p><p><strong>æŸ¥çœ‹</strong></p><p>é€‰æ‹©æŒ‡å®šçš„å‘½åç©ºé—´<code>dev</code>ï¼Œç„¶åç‚¹å‡»<code>Deployments</code>ï¼ŒæŸ¥çœ‹ dev ç©ºé—´ä¸‹çš„æ‰€æœ‰ deployment</p><figure><img src="/assets/img/k8s/image-20200520154628679.png" alt="ç›¸å…³å›¾ç‰‡" tabindex="0" loading="lazy"><figcaption>ç›¸å…³å›¾ç‰‡</figcaption></figure><p><strong>æ‰©ç¼©å®¹</strong></p><p>åœ¨<code>Deployment</code>ä¸Šç‚¹å‡»<code>è§„æ¨¡</code>ï¼Œç„¶åæŒ‡å®š<code>ç›®æ ‡å‰¯æœ¬æ•°é‡</code>ï¼Œç‚¹å‡»ç¡®å®š</p><figure><img src="/assets/img/k8s/image-20200520162605102.png" alt="ç›¸å…³å›¾ç‰‡" tabindex="0" loading="lazy"><figcaption>ç›¸å…³å›¾ç‰‡</figcaption></figure><p><strong>ç¼–è¾‘</strong></p><p>åœ¨<code>Deployment</code>ä¸Šç‚¹å‡»<code>ç¼–è¾‘</code>ï¼Œç„¶åä¿®æ”¹<code>yaml æ–‡ä»¶</code>ï¼Œç‚¹å‡»ç¡®å®š</p><figure><img src="/assets/img/k8s/image-20200520163253644.png" alt="ç›¸å…³å›¾ç‰‡" tabindex="0" loading="lazy"><figcaption>ç›¸å…³å›¾ç‰‡</figcaption></figure><p><strong>æŸ¥çœ‹ Pod</strong></p><p>ç‚¹å‡»<code>Pods</code>, æŸ¥çœ‹ pods åˆ—è¡¨</p><figure><img src="/assets/img/k8s/image-20200520163552110.png" alt="ç›¸å…³å›¾ç‰‡" tabindex="0" loading="lazy"><figcaption>ç›¸å…³å›¾ç‰‡</figcaption></figure><p><strong>æ“ä½œ Pod</strong></p><p>é€‰ä¸­æŸä¸ª Podï¼Œå¯ä»¥å¯¹å…¶æ‰§è¡Œæ—¥å¿—ï¼ˆlogsï¼‰ã€è¿›å…¥æ‰§è¡Œï¼ˆexecï¼‰ã€ç¼–è¾‘ã€åˆ é™¤æ“ä½œ</p><figure><img src="/assets/img/k8s/image-20200520163832827.png" alt="ç›¸å…³å›¾ç‰‡" tabindex="0" loading="lazy"><figcaption>ç›¸å…³å›¾ç‰‡</figcaption></figure><blockquote><p>Dashboard æä¾›äº† kubectl çš„ç»å¤§éƒ¨åˆ†åŠŸèƒ½ï¼Œè¿™é‡Œä¸å†ä¸€ä¸€æ¼”ç¤º</p></blockquote><h3 id="_10-3-å…¶ä»–-ui-kuboard" tabindex="-1"><a class="header-anchor" href="#_10-3-å…¶ä»–-ui-kuboard" aria-hidden="true">#</a> 10.3 å…¶ä»– UIï¼škuboard</h3><p>å®˜ç½‘æœ‰ç›¸å…³æ•™ç¨‹ <a href="https://kuboard.cn/install/v3/install-built-in.html#%E9%83%A8%E7%BD%B2%E8%AE%A1%E5%88%92" target="_blank" rel="noopener noreferrer">link<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">sudo</span> <span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">--restart</span><span class="token operator">=</span>unless-stopped <span class="token punctuation">\</span>
  <span class="token parameter variable">--name</span><span class="token operator">=</span>kuboard <span class="token punctuation">\</span>
  <span class="token parameter variable">-p</span> <span class="token number">80</span>:80/tcp <span class="token punctuation">\</span>
  <span class="token parameter variable">-p</span> <span class="token number">10081</span>:10081/tcp <span class="token punctuation">\</span>
  <span class="token parameter variable">-e</span> <span class="token assign-left variable">KUBOARD_ENDPOINT</span><span class="token operator">=</span><span class="token string">&quot;http://192.168.88.100:80&quot;</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-e</span> <span class="token assign-left variable">KUBOARD_AGENT_SERVER_TCP_PORT</span><span class="token operator">=</span><span class="token string">&quot;10081&quot;</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-e</span> <span class="token assign-left variable">KUBOARD_ADMIN_DERAULT_PASSWORD</span><span class="token operator">=</span><span class="token string">&quot;passwd&quot;</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-v</span> /root/kuboard-data:/data <span class="token punctuation">\</span>
  eipwork/kuboard:v3
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><!----><footer class="page-meta"><!----><div class="meta-item git-info"><div class="update-time"><span class="label">ä¸Šæ¬¡ç¼–è¾‘äº: </span><!----></div><div class="contributors"><span class="label">è´¡çŒ®è€…: </span><!--[--><!--[--><span class="contributor" title="email: 417333277@qq.com">kevinng77</span><!--]--><!--]--></div></div></footer><!----><!----><!----><!--]--></main><!--]--><footer class="footer-wrapper"><div class="footer"><a href="https://beian.miit.gov.cn/" target="_blank">é—½ICPå¤‡2020021116å·</a>&nbsp;<a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=" target="_blank"><img src="/assets/gongan.png">é—½å…¬ç½‘å®‰å¤‡ 35058102000231å· </a></div><div class="copyright">Copyright Â© 2023 Kevin å´å˜‰æ–‡</div></footer></div><!--]--><!--]--><!----><!--]--></div>
    <script type="module" src="/assets/app-0e28a919.js" defer></script>
  </body>
</html>
