<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.67" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="http://antarina.tech/posts/notes/articles/%E7%AC%94%E8%AE%B0langchain.html"><meta property="og:site_name" content="记忆笔书"><meta property="og:title" content="LangChain 源码理解"><meta property="og:description" content="LangChain link: https://github.com/hwchase17/langchain langchain 算是工程类的仓库，大模型应用的框架，提供了大模型和个人数据交互的框架，目前很多应用都有着和 langchain 非常相似的架构和目的，如 LLAMA INDEX，haystack， semantic-kernel 等。 主要的应用场景有：私人助理 ，问答系统 等。"><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2023-07-27T15:28:00.000Z"><meta property="article:author" content="Kevin 吴嘉文"><meta property="article:tag" content="NLP"><meta property="article:tag" content="AIGC"><meta property="article:published_time" content="2023-05-15T00:00:00.000Z"><meta property="article:modified_time" content="2023-07-27T15:28:00.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"LangChain 源码理解","image":[""],"datePublished":"2023-05-15T00:00:00.000Z","dateModified":"2023-07-27T15:28:00.000Z","author":[{"@type":"Person","name":"Kevin 吴嘉文"}]}</script><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin=""><link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;500;700&display=swap" rel="stylesheet"><link rel="icon" href="/logo.svg"><title>LangChain 源码理解 | 记忆笔书</title><meta name="description" content="LangChain link: https://github.com/hwchase17/langchain langchain 算是工程类的仓库，大模型应用的框架，提供了大模型和个人数据交互的框架，目前很多应用都有着和 langchain 非常相似的架构和目的，如 LLAMA INDEX，haystack， semantic-kernel 等。 主要的应用场景有：私人助理 ，问答系统 等。">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d1e1f;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/assets/style-a733c29d.css" as="style"><link rel="stylesheet" href="/assets/style-a733c29d.css">
    <link rel="modulepreload" href="/assets/app-465f02d8.js"><link rel="modulepreload" href="/assets/笔记langchain.html-eacda05f.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper-c27b6911.js"><link rel="modulepreload" href="/assets/笔记langchain.html-901ad0f3.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">跳至主要內容</a><!--]--><!--[--><div class="theme-container no-sidebar has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><!--[--><a class="vp-link vp-brand vp-brand" href="/"><!----><!----><span class="vp-site-name">记忆笔书</span></a><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-center"><!--[--><!----><!--]--><!--[--><nav class="vp-nav-links"><div class="nav-item hide-in-mobile"><a aria-label="主页" class="vp-link nav-link nav-link" href="/"><span class="font-icon icon iconfont icon-home" style=""></span>主页<!----></a></div><div class="nav-item hide-in-mobile"><a aria-label="归档" class="vp-link nav-link nav-link" href="/timeline/"><span class="font-icon icon iconfont icon-categoryselected" style=""></span>归档<!----></a></div></nav><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-end"><!--[--><!----><!--]--><!--[--><!----><div class="nav-item vp-repo"><a class="vp-repo-link" href="https://github.com/kevinng77" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><!----><!--[--><button type="button" class="search-pro-button" role="search" aria-label="搜索"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="search-pro-placeholder">搜索</div><div class="search-pro-key-hints"><kbd class="search-pro-key">Ctrl</kbd><kbd class="search-pro-key">K</kbd></div></button><!--]--><!--]--><!--[--><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!--[--><!----><!--]--><ul class="vp-sidebar-links"></ul><!--[--><!----><!--]--></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->LangChain 源码理解</h1><div class="page-info"><span class="page-author-info" aria-label="作者🖊" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><span class="page-author-item">Kevin 吴嘉文</span></span><span property="author" content="Kevin 吴嘉文"></span></span><!----><span class="page-date-info" aria-label="写作日期📅" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2023-05-15T00:00:00.000Z"></span><!----><span class="page-reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 10 分钟</span><meta property="timeRequired" content="PT10M"></span><span class="page-category-info" aria-label="分类🌈" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><!--[--><span class="page-category-item category7 clickable" role="navigation">知识笔记</span><!--]--><meta property="articleSection" content="知识笔记"></span><span class="page-tag-info" aria-label="标签🏷" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><!--[--><span class="page-tag-item tag8 clickable" role="navigation">NLP</span><span class="page-tag-item tag4 clickable" role="navigation">AIGC</span><!--]--><meta property="keywords" content="NLP,AIGC"></span></div><hr></div><div class="toc-place-holder"><aside id="toc"><!--[--><!----><!--]--><div class="toc-header">此页内容<!----></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/#源码框架梳理">源码框架梳理</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#models">Models</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#indexes-和-数据库">Indexes 和 数据库</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#chains">chains</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#agent">Agent</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#prompts">Prompts</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#callback">Callback</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#other-utils">Other Utils</a></li><!----><!--]--></ul></li><!--]--></ul><div class="toc-marker" style="top:-1.7rem;"></div></div><!--[--><!----><!--]--></aside></div><!----><div class="theme-hope-content"><h1 id="langchain" tabindex="-1"><a class="header-anchor" href="#langchain" aria-hidden="true">#</a> LangChain</h1><p>link: https://github.com/hwchase17/langchain</p><p>langchain 算是工程类的仓库，大模型应用的框架，提供了大模型和个人数据交互的框架，目前很多应用都有着和 langchain 非常相似的架构和目的，如 LLAMA INDEX，haystack， semantic-kernel 等。</p><p>主要的应用场景有：<a href="https://python.langchain.com/en/latest/use_cases/personal_assistants.html" target="_blank" rel="noopener noreferrer">私人助理<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> ，<a href="https://python.langchain.com/en/latest/use_cases/question_answering.html" target="_blank" rel="noopener noreferrer">问答系统<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 等。</p><p>主要特点在于：</p><ul><li>支持异构数据输入</li><li>提供了各种 Plugin 的实现方案</li><li>支持除文本回复之外的反馈操作，如执行代码等。</li></ul><div class="hint-container warning"><p class="hint-container-title">注意</p><p>由于 LangChain 在快速更新截断，因此文中的示例代码，可能与源码存在差异。但大致上，框架的逻辑思路是相同的。</p></div><h2 id="源码框架梳理" tabindex="-1"><a class="header-anchor" href="#源码框架梳理" aria-hidden="true">#</a> 源码框架梳理</h2><h3 id="models" tabindex="-1"><a class="header-anchor" href="#models" aria-hidden="true">#</a> Models</h3><p>LangChain 中的模型相关代码较少，大部分主要是调用外部资源，如 OPENAI 或者 Huggingface 等模型/API。Model 模块下提供了 <code>llms</code>, <code>cache</code>, <code>embeddings</code> 等子模块。</p><h4 id="llms" tabindex="-1"><a class="header-anchor" href="#llms" aria-hidden="true">#</a> llms</h4><p>llms 用于输入 input 文本，输出文本回复。该模块保存了各种 llm 接口。</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> langchain </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> HuggingFacePipeline</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">llm </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> HuggingFacePipeline.from_model_id(</span><span style="color:#E36209;">model_id</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;bigscience/bloom-1b7&quot;</span><span style="color:#24292E;">, </span><span style="color:#E36209;">task</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;text-generation&quot;</span><span style="color:#24292E;">, </span><span style="color:#E36209;">model_kwargs</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">{</span><span style="color:#032F62;">&quot;temperature&quot;</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;max_length&quot;</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">64</span><span style="color:#24292E;">})</span></span>
<span class="line"></span>
<span class="line"><span style="color:#005CC5;">print</span><span style="color:#24292E;">(llm(</span><span style="color:#032F62;">&quot;Hello, what is apple?&quot;</span><span style="color:#24292E;">))</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container info"><p class="hint-container-title">相关信息</p><p>在 langchain 中自定义 LLM 的话，只需要重写 <code>_call()</code> 方法即可。使其接受一个字符串，输出一个字符串</p></div><h4 id="cache" tabindex="-1"><a class="header-anchor" href="#cache" aria-hidden="true">#</a> cache</h4><p>当用户对相同的问题进行提问时，如果配置了 cache 的话，回复会更快。</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> redis </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> Redis</span></span>
<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> langchain.cache </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> RedisCache</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">langchain.llm_cache </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> RedisCache(</span><span style="color:#E36209;">redis_</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">Redis())</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="embeddings" tabindex="-1"><a class="header-anchor" href="#embeddings" aria-hidden="true">#</a> embeddings</h4><p><code>embeddings</code> 输入文本，输出对应的 embedding。主要用于编码本地数据以及用户 query，以方便检索。langchain 整合了部分开箱即用的 embedding 服务，包括比较流行的 sentance Transformer 库：</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> langchain.embeddings </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> HuggingFaceEmbeddings, SentenceTransformerEmbeddings </span></span>
<span class="line"><span style="color:#24292E;">embeddings </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> HuggingFaceEmbeddings(</span><span style="color:#E36209;">model_name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;all-MiniLM-L6-v2&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">query_result </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> embeddings.embed_query(</span><span style="color:#032F62;">&quot;your text input&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">doc_result </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> embeddings.embed_documents([</span><span style="color:#032F62;">&quot;text input1&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;text input2.&quot;</span><span style="color:#24292E;">])</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="自定义-embedding" tabindex="-1"><a class="header-anchor" href="#自定义-embedding" aria-hidden="true">#</a> 自定义 Embedding</h5><p>如果需要使用自定义的模型进行编码的话，仅需重写 <code>embed_documents</code>， <code>embed_query</code> 两个方法即可</p><p>如 <code>embeddings.huggingface</code> 下的 <code>HuggingFaceEmbeddings</code>，使用 <code>sentence_transformers</code> 对文本进行编码，那么 <code>embed_documents</code>， <code>embed_query</code> 的实现方式为：</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6A737D;">#   self.client = sentence_transformers.SentenceTransformer(self.model_name)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">embed_documents</span><span style="color:#24292E;">(self, texts: List[</span><span style="color:#005CC5;">str</span><span style="color:#24292E;">]) -&gt; List[List[</span><span style="color:#005CC5;">float</span><span style="color:#24292E;">]]:</span></span>
<span class="line"><span style="color:#24292E;">    texts </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">list</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">map</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">lambda</span><span style="color:#24292E;"> x: x.replace(</span><span style="color:#032F62;">&quot;</span><span style="color:#005CC5;">\n</span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot; &quot;</span><span style="color:#24292E;">), texts))</span></span>
<span class="line"><span style="color:#24292E;">    embeddings </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.client.encode(texts)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> embeddings.tolist()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">embed_query</span><span style="color:#24292E;">(self, text: </span><span style="color:#005CC5;">str</span><span style="color:#24292E;">) -&gt; List[</span><span style="color:#005CC5;">float</span><span style="color:#24292E;">]:</span></span>
<span class="line"><span style="color:#24292E;">    text </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> text.replace(</span><span style="color:#032F62;">&quot;</span><span style="color:#005CC5;">\n</span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot; &quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    embedding </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.client.encode(text)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> embedding.tolist()</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="indexes-和-数据库" tabindex="-1"><a class="header-anchor" href="#indexes-和-数据库" aria-hidden="true">#</a> Indexes 和 数据库</h3><p>Langchain 提供好了 <code>index</code>, <code>document_store</code> 等模块，能够方便地进行数据库管理、异构数据处理、数据读写等操作。Indexes 主要用于数据检索。</p><h4 id="document-loaders" tabindex="-1"><a class="header-anchor" href="#document-loaders" aria-hidden="true">#</a> document_loaders</h4><p><code>document_loaders</code> 主要用于管理数据库元数据。提供了读写文件时候必要的方法，包括文件地址，文件读取方式，文件分段方式等。</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> langchain.document_loaders </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> TextLoader</span></span>
<span class="line"><span style="color:#24292E;">loader </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> TextLoader(</span><span style="color:#032F62;">&#39;./mydoc.txt&#39;</span><span style="color:#24292E;">, </span><span style="color:#E36209;">encoding</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;utf8&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>如上创建 loader 之后，loader 中储存了 <code>loader.file_path = &quot;./mydoc.txt&quot;</code> 等元数据。</p><h4 id="text-splitter" tabindex="-1"><a class="header-anchor" href="#text-splitter" aria-hidden="true">#</a> text splitter</h4><p>通常，我们需要对一整篇文章进行分段，才能方便我们对段落进行检索。langchain 提供了部分 splitter，可以针对 markdown，pdf 等进行分段。分段后的文章，会被储存成 <code>Document</code> 数据格式。</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#24292E;">markdown_splitter </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> MarkdownTextSplitter(</span><span style="color:#E36209;">chunk_size</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">100</span><span style="color:#24292E;">, </span><span style="color:#E36209;">chunk_overlap</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">mymdstr </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;&quot;### this is md content&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#6A737D;">## 可以使用 create_documents 从字符串列表直接获得 List[Documents]</span></span>
<span class="line"><span style="color:#24292E;">docs </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> markdown_splitter.create_documents([mymdstr])</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">## 也可以使用 split_documents() 为现有的 Documents 进行二次细分</span></span>
<span class="line"><span style="color:#24292E;">docs </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> markdown_splitter.split_documents(documents)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如上代码， <code>docs</code> 为 <code>List[Document]</code></p><h4 id="vectorstores" tabindex="-1"><a class="header-anchor" href="#vectorstores" aria-hidden="true">#</a> vectorstores</h4><p><code>vectorstores</code> 用于储存文档、数据及其对应 embedding 等信息的引擎。</p><p>比如，要将文档与对应的 embedding 储存与 ElasticSearch 当中，可以参考 <code>elastic_vector_search.py</code> 中的内容。几个比较常见的数据库以及 NLP 检索框架在 langchain 中都写好了对应的 vectorstores， 如 <code>redis</code>, <code>faiss</code>, <code>elasticsearch</code> 等。以下为使用 <code>FAISS</code> 进行相似文档检索的操作：</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> langchain.vectorstores </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">FAISS</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 可以更换自定义 Embedding</span></span>
<span class="line"><span style="color:#24292E;">embeddings </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> HuggingFaceEmbeddings(</span><span style="color:#E36209;">model_name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;all-MiniLM-L6-v2&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">db </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">FAISS</span><span style="color:#24292E;">.from_documents(docs, embeddings)</span></span>
<span class="line"><span style="color:#24292E;">query </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;What did the president say about Ketanji Brown Jackson&quot;</span></span>
<span class="line"><span style="color:#24292E;">similar_docs </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> db.similarity_search(query)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>要支持其他数据库的话，可以自定义 vectorstore 类。自定义的话需要继承 <code>base.VectorStore</code>，而后重写下面几个主要的功能函数即可：</p><ol><li><code>add_texts</code>, <code>from_texts</code>：往数据库中添加数据的一些操作</li><li><code>similarity_search</code>：从数据库中检索本文的一些操作。该操作自定义程度搞，如对于 <code>elastic search</code>， 可以将 <code>retrievers</code> 下的 <code>elastic_search_bm25</code> 召回，以及 <code>elastic_vector_search</code> 的精排结合使用，以进行性能调优。</li></ol><p>自定义 vectorstores 可以考虑参考 <code>vectorstores.redis</code> ，使用另个一类 <code>RedisVectorStoreRetriever</code>来负责数据的检索。</p><h3 id="chains" tabindex="-1"><a class="header-anchor" href="#chains" aria-hidden="true">#</a> chains</h3><p>Chain 的作用相当于 pipeline，主要将多个 LLM 模块和程序处理环节进行拼接，将复杂任务成应用。有点像 transformers 中的 pipeline。以下是基础的 LLMChain 示例：</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> langchain.chains </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> LLMChain</span></span>
<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> langchain.prompts </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> PromptTemplate</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">prompt </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> PromptTemplate(</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#E36209;">input_variables</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">[</span><span style="color:#032F62;">&quot;thing&quot;</span><span style="color:#24292E;">],</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#E36209;">template</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;Hello, what is </span><span style="color:#005CC5;">{thing}</span><span style="color:#032F62;">?&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">mychain </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> LLMChain(</span><span style="color:#E36209;">llm</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">llm, </span><span style="color:#E36209;">prompt</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">prompt, </span><span style="color:#E36209;">verbose</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">True</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#005CC5;">print</span><span style="color:#24292E;">(mychain.run(</span><span style="color:#032F62;">&quot;banana&quot;</span><span style="color:#24292E;">))</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>以上示例对输入进行 <strong>模板填充</strong> ，而后进行 <strong>LLM 推理</strong> ，将答案整理并返回给用户。Chain 之间能够相互组合：</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> langchain.chains </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> SimpleSequentialChain</span></span>
<span class="line"><span style="color:#24292E;">overall_chain </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> SimpleSequentialChain(</span><span style="color:#E36209;">chains</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">[chain, chain_two], </span><span style="color:#E36209;">verbose</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">True</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Run the chain specifying only the input variable for the first chain.</span></span>
<span class="line"><span style="color:#24292E;">catchphrase </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> overall_chain.run(</span><span style="color:#032F62;">&quot;colorful socks&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><a href="https://python.langchain.com/en/latest/modules/chains/how_to_guides.html" target="_blank" rel="noopener noreferrer">官方文档<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 中有部分 chain 的示例代码，在源码 <code>chains.__init__</code> 中可以查看到所有默认的 chain。一些比较有意思的 chain：</p><ol><li><code>ChatVectorDBChain</code>：从 vectorstore 检索和 query 最相近的 k 条文档；而后根据这些文档生成回复。</li><li><code>LLMBashChain</code>：先通过 <code>LLMChain</code> 对 query 生成回复，如果回复中包含了 ````bash` 字样，则执行对应位置的代码。</li><li><code>LLMMathChain</code>：首先让 LLM 将需要数学计算的部分用 ````python` 进行标注，而后通过 python 进行对应的数学计算返回结果。</li><li><code>SQLDatabaseChain</code>：先用 LLM 解析 query，输出 sql；用 sql database 执行 sql 语句，抽取回复 query 时需要用到的数据；根据检索的数据，将结果返回给用户。对于这种 chain，以下是一个可以参考的 prompt：</li></ol><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#032F62;">&quot;&quot;&quot;Given an input question, first create a syntactically correct {dialect} query to run, then look at the results of the query and return the answer. Unless the user specifies in his question a specific number of examples he wishes to obtain, always limit your query to at most {top_k} results. You can order the results by a relevant column to return the most interesting examples in the database.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">Never query for all the columns from a specific table, only ask for a the few relevant columns given the question.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">Pay attention to use only the column names that you can see in the schema description. Be careful to not query for columns that do not exist. Also, pay attention to which column is in which table.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">Use the following format:</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">Question: &quot;Question here&quot;</span></span>
<span class="line"><span style="color:#032F62;">SQLQuery: &quot;SQL Query to run&quot;</span></span>
<span class="line"><span style="color:#032F62;">SQLResult: &quot;Result of the SQLQuery&quot;</span></span>
<span class="line"><span style="color:#032F62;">Answer: &quot;Final answer here&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">Only use the tables listed below.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">{table_info}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">Question: {input}&quot;&quot;&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>自定义 chain 需要重写下面三种方法：</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> langchain.chains </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> LLMChain</span></span>
<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> langchain.chains.base </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> Chain</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> typing </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> Dict, List</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ConcatenateChain</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">Chain</span><span style="color:#24292E;">):</span></span>
<span class="line"><span style="color:#24292E;">    chain_1: LLMChain</span></span>
<span class="line"><span style="color:#24292E;">    chain_2: LLMChain</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">@</span><span style="color:#005CC5;">property</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">input_keys</span><span style="color:#24292E;">(self) -&gt; List[</span><span style="color:#005CC5;">str</span><span style="color:#24292E;">]:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;"># Union of the input keys of the two chains.</span></span>
<span class="line"><span style="color:#24292E;">        all_input_vars </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.chain_1.input_keys).union(</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.chain_2.input_keys))</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">list</span><span style="color:#24292E;">(all_input_vars)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">@</span><span style="color:#005CC5;">property</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">output_keys</span><span style="color:#24292E;">(self) -&gt; List[</span><span style="color:#005CC5;">str</span><span style="color:#24292E;">]:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> [</span><span style="color:#032F62;">&#39;concat_output&#39;</span><span style="color:#24292E;">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">_call</span><span style="color:#24292E;">(self, inputs: Dict[</span><span style="color:#005CC5;">str</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">str</span><span style="color:#24292E;">]) -&gt; Dict[</span><span style="color:#005CC5;">str</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">str</span><span style="color:#24292E;">]:</span></span>
<span class="line"><span style="color:#24292E;">        output_1 </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.chain_1.run(inputs)</span></span>
<span class="line"><span style="color:#24292E;">        output_2 </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.chain_2.run(inputs)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> {</span><span style="color:#032F62;">&#39;concat_output&#39;</span><span style="color:#24292E;">: output_1 </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> output_2}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="agent" tabindex="-1"><a class="header-anchor" href="#agent" aria-hidden="true">#</a> Agent</h3><p>Agent 是 AI 的一个关键概念。Agent 能够根据不同的问题，决定要执行哪一个 chain。以下是一个基础 agent 的调用示例。</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> langchain.agents </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> load_tools</span></span>
<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> langchain.agents </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> initialize_agent</span></span>
<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> langchain.agents </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> AgentType</span></span>
<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> langchain.llms </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> OpenAI</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">llm </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> OpenAI(</span><span style="color:#E36209;">temperature</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">tools </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> load_tools([</span><span style="color:#032F62;">&quot;serpapi&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;llm-math&quot;</span><span style="color:#24292E;">], </span><span style="color:#E36209;">llm</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">llm)</span></span>
<span class="line"><span style="color:#24292E;">agent </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> initialize_agent(tools, llm, </span><span style="color:#E36209;">agent</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">AgentType.</span><span style="color:#005CC5;">ZERO_SHOT_REACT_DESCRIPTION</span><span style="color:#24292E;">, </span><span style="color:#E36209;">verbose</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">True</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">agent.run(</span><span style="color:#032F62;">&quot;Who is Leo DiCaprio&#39;s girlfriend? What is her current age raised to the 0.43 power?&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>以下是上面这串代码执行后的结果：</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> Entering new AgentExecutor chain</span><span style="color:#005CC5;">...</span></span>
<span class="line"><span style="color:#24292E;"> I need to find out who Leo DiCaprio</span><span style="color:#032F62;">&#39;s girlfriend is and then calculate her age raised to the 0.43 power.</span></span>
<span class="line"><span style="color:#24292E;">Action: Search</span></span>
<span class="line"><span style="color:#24292E;">Action Input: </span><span style="color:#032F62;">&quot;Leo DiCaprio girlfriend&quot;</span></span>
<span class="line"><span style="color:#24292E;">Observation: Camila Morrone</span></span>
<span class="line"><span style="color:#24292E;">Thought: I need to find out Camila Morrone</span><span style="color:#032F62;">&#39;s age</span></span>
<span class="line"><span style="color:#24292E;">Action: Search</span></span>
<span class="line"><span style="color:#24292E;">Action Input: </span><span style="color:#032F62;">&quot;Camila Morrone age&quot;</span></span>
<span class="line"><span style="color:#24292E;">Observation: </span><span style="color:#005CC5;">25</span><span style="color:#24292E;"> years</span></span>
<span class="line"><span style="color:#24292E;">Thought: I need to calculate </span><span style="color:#005CC5;">25</span><span style="color:#24292E;"> raised to the </span><span style="color:#005CC5;">0.43</span><span style="color:#24292E;"> power</span></span>
<span class="line"><span style="color:#24292E;">Action: Calculator</span></span>
<span class="line"><span style="color:#24292E;">Action Input: </span><span style="color:#005CC5;">25</span><span style="color:#D73A49;">^</span><span style="color:#005CC5;">0.43</span></span>
<span class="line"><span style="color:#24292E;">Observation: Answer: </span><span style="color:#005CC5;">3.991298452658078</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">Thought: I now know the final answer</span></span>
<span class="line"><span style="color:#24292E;">Final Answer: Camila Morrone </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> Leo DiCaprio</span><span style="color:#032F62;">&#39;s girlfriend and her current age raised to the 0.43 power is 3.991298452658078.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> Finished chain.</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="agent-单元" tabindex="-1"><a class="header-anchor" href="#agent-单元" aria-hidden="true">#</a> Agent 单元</h4><p>一个 Agent 单元负责执行一次任务。如 langchain 中的 <code>langchain.agents.agent.Agent</code></p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Agent</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">BaseSingleActionAgent</span><span style="color:#24292E;">):</span></span>
<span class="line"><span style="color:#24292E;">    llm_chain: LLMChain</span></span>
<span class="line"><span style="color:#24292E;">    allowed_tools: Optional[List[</span><span style="color:#005CC5;">str</span><span style="color:#24292E;">]] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">None</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>agent 的执行功能在于 <code>Agent.plan()</code>：</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">plan</span><span style="color:#24292E;">(intermediate_steps: List[Tuple[AgentAction, </span><span style="color:#005CC5;">str</span><span style="color:#24292E;">]], </span><span style="color:#D73A49;">**</span><span style="color:#24292E;">kwargs) :   </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># 将各种异构的历史信息转换成 inputs，传入到 LLM 当中</span></span>
<span class="line"><span style="color:#24292E;">    thoughts </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> action, observation </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> intermediate_steps:</span></span>
<span class="line"><span style="color:#24292E;">            thoughts </span><span style="color:#D73A49;">+=</span><span style="color:#24292E;"> action.log</span></span>
<span class="line"><span style="color:#24292E;">            thoughts </span><span style="color:#D73A49;">+=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">f</span><span style="color:#032F62;">&quot;</span><span style="color:#005CC5;">\n{self</span><span style="color:#24292E;">.observation_prefix</span><span style="color:#005CC5;">}{</span><span style="color:#24292E;">observation</span><span style="color:#005CC5;">}\n{self</span><span style="color:#24292E;">.llm_prefix</span><span style="color:#005CC5;">}</span><span style="color:#032F62;">&quot;</span></span>
<span class="line"><span style="color:#24292E;">            </span></span>
<span class="line"><span style="color:#24292E;">    full_input </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> {</span><span style="color:#032F62;">&quot;agent_scratchpad&quot;</span><span style="color:#24292E;">: thoughts, </span><span style="color:#032F62;">&quot;stop&quot;</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">._stop, </span><span style="color:#D73A49;">**</span><span style="color:#24292E;">kwargs}  </span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># 根据 LLM 生成的反馈，采取决策</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">## prompt template: &quot;your input xx {other prompt slot} xx, {agent_scratchpad}&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">## full_output: LLM 输出的回复，字符串形式</span></span>
<span class="line"><span style="color:#24292E;">    full_output </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.llm_chain.predict(</span><span style="color:#D73A49;">**</span><span style="color:#24292E;">full_inputs)</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">    parsed_output </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">._extract_tool_and_input(full_output)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">while</span><span style="color:#24292E;"> parsed_output </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">None</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        full_output </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">._fix_text(full_output)</span></span>
<span class="line"><span style="color:#24292E;">        full_inputs[</span><span style="color:#032F62;">&quot;agent_scratchpad&quot;</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">+=</span><span style="color:#24292E;"> full_output</span></span>
<span class="line"><span style="color:#24292E;">        output </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.llm_chain.predict(</span><span style="color:#D73A49;">**</span><span style="color:#24292E;">full_inputs)</span></span>
<span class="line"><span style="color:#24292E;">        full_output </span><span style="color:#D73A49;">+=</span><span style="color:#24292E;"> output</span></span>
<span class="line"><span style="color:#24292E;">        parsed_output </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">._extract_tool_and_input(full_output)</span></span>
<span class="line"><span style="color:#24292E;">        </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># 或者返回 AgentFinish({&quot;output&quot;: action.tool_input}, action.log)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> AgentAction(</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#E36209;">tool</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">parsed_output[</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">], </span><span style="color:#E36209;">tool_input</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">parsed_output[</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">], </span><span style="color:#E36209;">log</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">full_output</span></span>
<span class="line"><span style="color:#24292E;">        )</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对于 Agent，能够从历史操作中获取信息，并根据目的做出决策是很重要的。对于 Langchain 的 Agent，我们解析他的 <code>.plan()</code> 方法：</p><p><code>.plan()</code> 的参数有 <code>intermediate_steps</code> 和 <code>**kwargs</code>，前者保存了 agent 之前做过的一些行为。后者通常会储存 agent 的目标，如用户提出的 query 等。</p><p><code>.plan()</code> 可以看做两步：</p><ol><li>将各种异构的历史信息转换成 inputs，传入到 LLM 当中；对于 Langchain，其做法就是简单的将 <code>intermediate_steps</code> 中的 action 日志和 <code>observation</code> 进行拼接，而后统一放在 <code>inputs</code> 后面。在 langchain 的 prompt template 当中，经常会看到 <code>agent_scratchpad</code> 的填充字段，它就是用来放历史信息的。</li><li>根据 LLM 生成的反馈，采取决策。LLM 生成的回复是 string 格式，我们会将回复出来的 <code>full_output</code> 在 <code>_extract_tool_and_input</code> 中进行处理。一个例子就是 <code>agents.mrkl.base.get_action_and_tool()</code>。</li></ol><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">get_action_and_input</span><span style="color:#24292E;">(llm_output: </span><span style="color:#005CC5;">str</span><span style="color:#24292E;">) -&gt; Tuple[</span><span style="color:#005CC5;">str</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">str</span><span style="color:#24292E;">]:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;&quot;&quot;Parse out the action and input from the LLM output.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">    Note: if you&#39;re specifying a custom prompt for the ZeroShotAgent,</span></span>
<span class="line"><span style="color:#032F62;">    you will need to ensure that it meets the following Regex requirements.</span></span>
<span class="line"><span style="color:#032F62;">    The string starting with &quot;Action:&quot; and the following string starting</span></span>
<span class="line"><span style="color:#032F62;">    with &quot;Action Input:&quot; should be separated by a newline.</span></span>
<span class="line"><span style="color:#032F62;">    &quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">FINAL_ANSWER_ACTION</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> llm_output:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;Final Answer&quot;</span><span style="color:#24292E;">, llm_output.split(</span><span style="color:#005CC5;">FINAL_ANSWER_ACTION</span><span style="color:#24292E;">)[</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">].strip()</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># \s matches against tab/newline/whitespace</span></span>
<span class="line"><span style="color:#24292E;">    regex </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">r</span><span style="color:#032F62;">&quot;Action: </span><span style="color:#005CC5;">(.</span><span style="color:#D73A49;">*?</span><span style="color:#005CC5;">)[</span><span style="color:#22863A;font-weight:bold;">\n</span><span style="color:#005CC5;">]</span><span style="color:#D73A49;">*</span><span style="color:#032F62;">Action Input:</span><span style="color:#005CC5;">[\s]</span><span style="color:#D73A49;">*</span><span style="color:#005CC5;">(.</span><span style="color:#D73A49;">*</span><span style="color:#005CC5;">)</span><span style="color:#032F62;">&quot;</span></span>
<span class="line"><span style="color:#24292E;">    match </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> re.search(regex, llm_output, re.</span><span style="color:#005CC5;">DOTALL</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> match:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">raise</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ValueError</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">f</span><span style="color:#032F62;">&quot;Could not parse LLM output: `</span><span style="color:#005CC5;">{</span><span style="color:#24292E;">llm_output</span><span style="color:#005CC5;">}</span><span style="color:#032F62;">`&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    action </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> match.group(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">).strip()</span></span>
<span class="line"><span style="color:#24292E;">    action_input </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> match.group(</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> action, action_input.strip(</span><span style="color:#032F62;">&quot; &quot;</span><span style="color:#24292E;">).strip(</span><span style="color:#032F62;">&#39;&quot;&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到，langchain 中<code>ZeroShotAgent</code> 通过字符串匹配的方式来识别 action。因此，agent 能否正常运行，与 prompt 格式，以及 LLM 的 ICL 以及 alignment 能力有着很大的关系。</p><div class="hint-container info"><p class="hint-container-title">相关信息</p><p>最后的输出 <code>AgentAction</code> 中会包括：需要使用的 tool，使用该 tool 时候，对应的执行命令。可以使用的 tool 会在 prompt template 中提示出来，比如如果你采用 <code>create_pandas_dataframe_agent</code> 构造了一个 agent，那么它的 prompt template 就会编程：</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#032F62;">&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#032F62;">You are working with a pandas dataframe in Python. The name of the dataframe is `df`.</span></span>
<span class="line"><span style="color:#032F62;">You should use the tools below to answer the question posed of you:</span></span>
<span class="line"><span style="color:#032F62;">python_repl_ast</span></span>
<span class="line"><span style="color:#032F62;">A Python shell. Use this to execute python commands. &quot;</span></span>
<span class="line"><span style="color:#032F62;">        &quot;Input should be a valid python command. &quot;</span></span>
<span class="line"><span style="color:#032F62;">        &quot;When using this tool, sometimes output is abbreviated - &quot;</span></span>
<span class="line"><span style="color:#032F62;">        &quot;make sure it does not look abbreviated before using it in your answer.&quot;</span></span>
<span class="line"><span style="color:#032F62;">This is the result of `print(df.head())`:</span></span>
<span class="line"><span style="color:#032F62;">Begin!</span></span>
<span class="line"><span style="color:#032F62;">Question: {input}</span></span>
<span class="line"><span style="color:#032F62;">{agent_scratchpad}</span></span>
<span class="line"><span style="color:#032F62;">&quot;&quot;&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><h4 id="agentexecutor" tabindex="-1"><a class="header-anchor" href="#agentexecutor" aria-hidden="true">#</a> AgentExecutor</h4><p>不论是通过 <code>initialize_agent</code> 或者是 <code>create_pandas_dataframe_agent</code> 等方式，我们都可以得到 <code>AgentExecutor</code> 来执行 agent 相关的任务。</p><p><code>AgentExecutor</code> 实际上是一个 <code>Chain</code>，可以通过 <code>.run()</code> 或者 <code>_call()</code> 来调用。如：</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#24292E;">agent_executor </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> create_pandas_dataframe_agent(</span><span style="color:#E36209;">llm</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">llm, </span><span style="color:#E36209;">df</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">df)</span></span>
<span class="line"><span style="color:#24292E;">agent_executor.run(</span><span style="color:#032F62;">&quot;how many rows are there?&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><code>agent_executor.run()</code> 通过迭代地执行 agent</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#24292E;">intermediate_steps </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> [] </span><span style="color:#6A737D;"># List[(AgentAction, str)]</span></span>
<span class="line"><span style="color:#6A737D;"># 其中 str 为 oservation，是每次迭代后，我们调用 tool 得到的结果。</span></span>
<span class="line"><span style="color:#24292E;">agent_action </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.agent.plan(</span></span>
<span class="line"><span style="color:#24292E;">                intermediate_steps,</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">**</span><span style="color:#24292E;">inputs)</span></span>
<span class="line"><span style="color:#6A737D;"># inputs 是一个用于填充 prompt.format 的字典，参考 prompts 部分。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">for</span><span style="color:#24292E;"> agent_action </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> actions:</span></span>
<span class="line"><span style="color:#24292E;">	tools2run </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> name_to_tool_map[agent_action.tool]</span></span>
<span class="line"><span style="color:#24292E;">    observation </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> tool.run(agent_action.tool_input, </span><span style="color:#D73A49;">**</span><span style="color:#24292E;">tool_run_kwargs,)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">intermediate_steps.append([agent_action, observation])</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>因此，结合上面 Agent 部分的 <code>plan</code>，我们就可以理解 langchain 中 Agent 执行的大致逻辑。</p><h3 id="prompts" tabindex="-1"><a class="header-anchor" href="#prompts" aria-hidden="true">#</a> Prompts</h3><p>Langchain 当中，定义好了不同的 Prompt template，以面对不同的用户提问，prompt template 应该与模型绑定。Prompts 模块当中也提供了 example selector，方便用户进行 few shot 选择。</p><h3 id="callback" tabindex="-1"><a class="header-anchor" href="#callback" aria-hidden="true">#</a> Callback</h3><p>可以在各个环节对你的 LLM 应用进行监控， callback 可以用于各个环节，如 Chain 开始，Chain 结束，LLM 开始， LLM 出错，接受到新的 Token 等等。</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> langchain.callbacks </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> StdOutCallbackHandler</span></span>
<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> langchain.chains </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> LLMChain</span></span>
<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> langchain.llms </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> OpenAI</span></span>
<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> langchain.prompts </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> PromptTemplate</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">handler </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> StdOutCallbackHandler()</span></span>
<span class="line"><span style="color:#24292E;">llm </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> OpenAI()</span></span>
<span class="line"><span style="color:#24292E;">prompt </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> PromptTemplate.from_template(</span><span style="color:#032F62;">&quot;1 + </span><span style="color:#005CC5;">{number}</span><span style="color:#032F62;"> = &quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># First, let&#39;s explicitly set the StdOutCallbackHandler in `callbacks`</span></span>
<span class="line"><span style="color:#24292E;">chain </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> LLMChain(</span><span style="color:#E36209;">llm</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">llm, </span><span style="color:#E36209;">prompt</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">prompt, </span><span style="color:#E36209;">callbacks</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">[handler])</span></span>
<span class="line"><span style="color:#24292E;">chain.run(</span><span style="color:#E36209;">number</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>自定义 callback 需要实现 <code>langchain.callbacks.base.BaseCallBackHandler</code> 中的接口。</p><h3 id="other-utils" tabindex="-1"><a class="header-anchor" href="#other-utils" aria-hidden="true">#</a> Other Utils</h3><h4 id="output-parser" tabindex="-1"><a class="header-anchor" href="#output-parser" aria-hidden="true">#</a> Output Parser</h4><h4 id="api-工具" tabindex="-1"><a class="header-anchor" href="#api-工具" aria-hidden="true">#</a> API 工具</h4><p>在 <code>tools</code> 目录下，可以看到各种适配 Plugin 等插件。支持通过 python 运行各种脚本、调用各类 API 。</p></div><!----><footer class="page-meta"><!----><div class="meta-item git-info"><div class="update-time"><span class="label">上次编辑于: </span><!----></div><div class="contributors"><span class="label">贡献者: </span><!--[--><!--[--><span class="contributor" title="email: 417333277@qq.com">kevinng77</span><!--]--><!--]--></div></div></footer><!----><!----><!----><!--]--></main><!--]--><footer class="vp-footer-wrapper"><div class="vp-footer"><a href="https://beian.miit.gov.cn/" target="_blank">沪ICP备2023027904号-1</a>&nbsp;<a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=" target="_blank"><img src="/assets/gongan.png">公安备案号 </a></div><div class="vp-copyright">Copyright © 2024 Kevin 吴嘉文</div></footer></div><!--]--><!--]--><!----><!--]--></div>
    <script type="module" src="/assets/app-465f02d8.js" defer></script>
  </body>
</html>
