<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.67" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="http://antarina.tech/posts/notes/articles/%E7%AC%94%E8%AE%B0mika_1.html"><meta property="og:site_name" content="记忆笔书"><meta property="og:title" content="咪咔相机分享 | 从零到上线一款 AI 相机小程序"><meta property="og:description" content="1. 背景 2023 年，妙鸭相机因其创意性的 AI 写真生成功能受到广泛关注，市场上也随之涌现了大量基于 Stable Diffusion（SD）模型的生图应用。作为一名技术爱好者，笔者在妙鸭相机发布后不久，进行了 Stable Diffusion + LoRA 的技术验证，并发现了搭建类似 AI 相机的可行性。 参考文章：妙鸭=SD + Lora? 对 SD+LoRA 的一些探索与验证"><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2025-01-30T08:25:09.000Z"><meta property="article:author" content="Kevin 吴嘉文"><meta property="article:tag" content="Other"><meta property="article:tag" content="创业"><meta property="article:published_time" content="2025-01-02T00:00:00.000Z"><meta property="article:modified_time" content="2025-01-30T08:25:09.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"咪咔相机分享 | 从零到上线一款 AI 相机小程序","image":[""],"datePublished":"2025-01-02T00:00:00.000Z","dateModified":"2025-01-30T08:25:09.000Z","author":[{"@type":"Person","name":"Kevin 吴嘉文"}]}</script><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin=""><link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;500;700&display=swap" rel="stylesheet"><link rel="icon" href="/logo.svg"><title>咪咔相机分享 | 从零到上线一款 AI 相机小程序 | 记忆笔书</title><meta name="description" content="1. 背景 2023 年，妙鸭相机因其创意性的 AI 写真生成功能受到广泛关注，市场上也随之涌现了大量基于 Stable Diffusion（SD）模型的生图应用。作为一名技术爱好者，笔者在妙鸭相机发布后不久，进行了 Stable Diffusion + LoRA 的技术验证，并发现了搭建类似 AI 相机的可行性。 参考文章：妙鸭=SD + Lora? 对 SD+LoRA 的一些探索与验证">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d1e1f;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/assets/style-99575b2e.css" as="style"><link rel="stylesheet" href="/assets/style-99575b2e.css">
    <link rel="modulepreload" href="/assets/app-8f289594.js"><link rel="modulepreload" href="/assets/笔记mika_1.html-94631aac.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper-c27b6911.js"><link rel="modulepreload" href="/assets/笔记mika_1.html-53d7fcb6.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">跳至主要內容</a><!--]--><!--[--><div class="theme-container no-sidebar has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><!--[--><a class="vp-link vp-brand vp-brand" href="/"><!----><!----><span class="vp-site-name">记忆笔书</span></a><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-center"><!--[--><!----><!--]--><!--[--><nav class="vp-nav-links"><div class="nav-item hide-in-mobile"><a aria-label="主页" class="vp-link nav-link nav-link" href="/"><span class="font-icon icon iconfont icon-home" style=""></span>主页<!----></a></div><div class="nav-item hide-in-mobile"><a aria-label="归档" class="vp-link nav-link nav-link" href="/timeline/"><span class="font-icon icon iconfont icon-categoryselected" style=""></span>归档<!----></a></div></nav><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-end"><!--[--><!----><!--]--><!--[--><!----><div class="nav-item vp-repo"><a class="vp-repo-link" href="https://github.com/kevinng77" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><!----><!--[--><button type="button" class="search-pro-button" role="search" aria-label="搜索"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="search-pro-placeholder">搜索</div><div class="search-pro-key-hints"><kbd class="search-pro-key">Ctrl</kbd><kbd class="search-pro-key">K</kbd></div></button><!--]--><!--]--><!--[--><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!--[--><!----><!--]--><ul class="vp-sidebar-links"></ul><!--[--><!----><!--]--></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->咪咔相机分享 | 从零到上线一款 AI 相机小程序</h1><div class="page-info"><span class="page-author-info" aria-label="作者🖊" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><span class="page-author-item">Kevin 吴嘉文</span></span><span property="author" content="Kevin 吴嘉文"></span></span><!----><span class="page-date-info" aria-label="写作日期📅" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2025-01-02T00:00:00.000Z"></span><!----><span class="page-reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 31 分钟</span><meta property="timeRequired" content="PT31M"></span><span class="page-category-info" aria-label="分类🌈" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><!--[--><span class="page-category-item category7 clickable" role="navigation">知识笔记</span><!--]--><meta property="articleSection" content="知识笔记"></span><span class="page-tag-info" aria-label="标签🏷" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><!--[--><span class="page-tag-item tag1 clickable" role="navigation">Other</span><span class="page-tag-item tag0 clickable" role="navigation">创业</span><!--]--><meta property="keywords" content="Other,创业"></span></div><hr></div><div class="toc-place-holder"><aside id="toc"><!--[--><!----><!--]--><div class="toc-header">此页内容<!----></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/#_1-背景">1.  背景</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/#_2-功能介绍">2.  功能介绍</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/#_3-走过的坑和技术分享">3.  走过的坑和技术分享</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#_3-3-1-咪咔相机架构总览">3.3.1  咪咔相机架构总览</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#_3-3-2-前端与微信小程序">3.3.2 前端与微信小程序</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#_3-3-3-后端开发">3.3.3 后端开发</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/#_3-收获">3.  收获</a></li><!----><!--]--></ul><div class="toc-marker" style="top:-1.7rem;"></div></div><!--[--><!----><!--]--></aside></div><!----><div class="theme-hope-content"><h2 id="_1-背景" tabindex="-1"><a class="header-anchor" href="#_1-背景" aria-hidden="true">#</a> 1. <strong>背景</strong></h2><p>2023 年，妙鸭相机因其创意性的 AI 写真生成功能受到广泛关注，市场上也随之涌现了大量基于 Stable Diffusion（SD）模型的生图应用。作为一名技术爱好者，笔者在妙鸭相机发布后不久，进行了 Stable Diffusion + LoRA 的技术验证，并发现了搭建类似 AI 相机的可行性。</p><p>参考文章：<a href="https://zhuanlan.zhihu.com/p/651809963" target="_blank" rel="noopener noreferrer">妙鸭=SD + Lora? 对 SD+LoRA 的一些探索与验证<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>于是和几个朋友设计一款专门为宠物主人设计的微信小程序—— <strong>咪咔相机</strong> ，作为一个理论实践项目。</p><p>该系列文章中，笔者会分享咪咔相机项目的一些心得，以及对各个技术环节做分享包括了微信小程序开发，figma，产品设计，Stable Diffusion 训练与部署，API 开发，K8S 部署，消息队列，监控与报警，airflow 任务编，数据库管理等。</p><p>希望这些分享能对正在学习小程序开发的朋友有所帮助。</p><h2 id="_2-功能介绍" tabindex="-1"><a class="header-anchor" href="#_2-功能介绍" aria-hidden="true">#</a> 2. <strong>功能介绍</strong></h2><p>咪咔相机和妙鸭相机功能很像，但针对宠物用户进行了优化和细化。用户可以通过平台为宠物生成多种风格的 AI 照片，比如：卡通化、写实风格等。</p><figure><img src="/assets/img/mika_1/image-20250105135049011.jpg" alt="img" height="500" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>以下是一些咪咔相机的主要界面图，咪咔相机小程序包含了 5 个 tab 栏，包括主页、拍照、相册、宠物档案、以及我的。</p><p><strong>(1) 首页</strong></p><p>用户进入小程序后，会首先看到首页。首页设计包括：</p><ul><li><strong>轮播图</strong> ：展示平台精选的宠物 AI 作品。</li><li><strong>热门风格推荐</strong> ：帮助用户快速了解热门风格。</li></ul><figure><img src="/assets/img/mika_1/image-20250105234357129.jpg" alt="image-20250105234357129" tabindex="0" loading="lazy"><figcaption>image-20250105234357129</figcaption></figure><p><strong>(2) 宠物档案</strong></p><p>用户可通过上传 <strong>12-16 张宠物照片</strong> 来生成“数字档案”（LoRA 权重）。宠物档案页面展示宠物的详细信息和生成记录，生成完成后，用户可随时使用档案生成 AI 风格照片。</p><p><strong>创建档案流程：</strong></p><ol><li>填写宠物基本信息（如名称、品种）。</li><li>上传图片（系统将进行质量检查）。</li><li>启动档案生成（需稍作等待，系统后台完成训练）。</li></ol><figure><img src="/assets/img/mika_1/image-20250105142848652.jpg" alt="image-20250105142848652" tabindex="0" loading="lazy"><figcaption>image-20250105142848652</figcaption></figure><p><strong>(3) 拍照和相册</strong></p><p>拍照页面展示多种可选风格，用户只需选择风格并点击生成，即可完成照片制作。</p><ul><li><strong>生成流程</strong> ：用户选择宠物档案并选择风格，点击生成后稍等数秒，即可获得高质量 AI 照片。</li><li><strong>结果展示</strong> ：支持用户直接分享照片至微信朋友圈等社交平台。</li></ul><p>所有生成的 AI 照片会自动归档至用户的宝贝相册。用户可以浏览、下载或分享已生成的照片。</p><figure><img src="/assets/img/mika_1/image-20250105144203883.jpg" alt="image-20250105144203883" tabindex="0" loading="lazy"><figcaption>image-20250105144203883</figcaption></figure><p><strong>(5) 我的</strong></p><p>该模块提供账户相关功能，包括：</p><ul><li><strong>充值与余额管理</strong> ：用户可通过微信支付充值平台专用虚拟货币“小鱼干”。</li><li><strong>联系客服</strong> ：用户可通过微信内置的客服系统提交问题或建议。</li><li><strong>常见问题解答</strong> ：提供操作指引与 FAQ。</li></ul><figure><img src="/assets/img/mika_1/image-20250105145818466.jpg" alt="image-20250105145818466" tabindex="0" loading="lazy"><figcaption>image-20250105145818466</figcaption></figure><h2 id="_3-走过的坑和技术分享" tabindex="-1"><a class="header-anchor" href="#_3-走过的坑和技术分享" aria-hidden="true">#</a> 3. <strong>走过的坑和技术分享</strong></h2><p>在这一章节中，笔者将分享从零开始开发“咪咔相机”小程序的整个过程，重点讲述项目筹备、开发中的挑战，以及遇到的一些坑。</p><p>3.0 <strong>项目可行性分析</strong></p><p>妙鸭相机火了一段时间后，笔者对 stable diffusion + Lora 技术进行了<a href="https://zhuanlan.zhihu.com/p/651809963" target="_blank" rel="noopener noreferrer">初步验证<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>，实验证明采用 sd+lora，是可以搭建一款类似于妙鸭一样的 AI 照相软件的。妙鸭相机是针对人物拍摄写真照片的，于是笔者便想着开发一款宠物 AI 相机，当做业余项目。</p><p>在简单构思了项目架构后，发现涉及到的技术并不复杂，并且当时 ai 生成图片也算挺有意思，于是便找了几个想学 ai 相机的伙伴一起参与这个业余项目。</p><p>简单和几个伙伴介绍了以下项目的“宏伟”计划，画了一下大饼后，项目便开始了。</p><p><strong>3.1 市场分析及产品设计</strong> ：</p><ul><li><strong>市场分析：</strong> 在开发“咪咔相机”之前，我们研究了市场上现有的宠物 AI 相机和真人 AI 相机产品。虽然大部分产品使用的技术相似，但在用户体验上存在很大差异。尤其是在收费机制方面，AI 相机的过程分为两个主要环节：数字分身的制作（Lora 训练）和照片生成（模型推理）。整个环节大概为：</li></ul><ol><li>用户提供照片-&gt;</li><li>相机制作数字分身（lora 训练）-&gt;</li><li>生成 ai 相片（sd+lora+prompt 进行风格推理）</li></ol><p>训练 lora 的成本是模型推理成本的 6000 倍。对于 AI 相机，有 2 中较常见的收费方案：</p><ol><li><strong>按制作数字分身收费：</strong> 把制作宠物档案设置成收费项，用户需要支付一定费用制作数字分身，完成后可以免费使用所有 AI 模板生成照片。该方案与服务的成本比较匹配。</li><li><strong>按生成照片收费</strong> ：用户可以免费制作数字分身，但在生成照片环节需要支付费用，该方案用户能够提前体验到拍照的乐趣。</li></ol><p>咪咔采用了按生成照片收费，并且用户注册后会赠送一定量的“咪咔货币”（小鱼干），可以免费制作宠物档案并生成 AI 照片。</p><ul><li><strong>功能、界面与原型设计</strong> ：</li></ul><p>我们与几个小伙伴一起，筛选并设计了小程序的基本功能，包括注册、档案制作、图片生成、充值和分享等。在统一了基础功能后，由于“咪咔相机”并未使用复杂的动画效果，所有功能均通过简单的页面跳转来实现。为了高效设计界面，我使用 Figma 设计了各页面之间的跳转，并与伙伴们合作完成了界面的美术设计。</p><figure><img src="/assets/img/mika_1/image-20250101205841372.jpg" alt=" " tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>然而，作为第一次使用 Figma 进行设计，并且并非前端开发出身，我在过程中踩了不少坑，特别是在 Figma 设计与前端开发的配合上，导致后期开发中花费了不少时间进行调整。</p><p>Figma 的精细设计能够显著提高前端开发的效率。设计者不仅需要具备基础的前端开发知识，还应采用“优雅的设计方案”以确保设计的可实现性。例如，在设计登录界面时，如果要将用户头像居中，Figma 提供了多种实现方式，其中“自动居中”效果比手动设置位置更加适合开发需求。在 Figma 中，如果我们设计一个 480px 宽的界面，并希望将 40px 的头像居中，可以选择两种方式：</p><ol><li>使用 Figma 的自动居中功能。</li><li>手动将头像设置为离画布左边 220px 的位置。</li></ol><p>虽然这两种方法在 Figma 中的效果图看起来相同，但在实际开发中，只有第一种方法才能确保头像在所有设备上都居中。因为并非每个设备的屏幕宽度都与设计宽度一致，手动计算的方式可能导致在某些设备上位置偏移。</p><p>Figma 支持设计任意大小的画布，并且内置了多个手机型号的画布模板，如 iPhone 14、13 等。刚开始时，我使用了 iPhone 14 的画布设计所有界面和原型，但在开发微信小程序时才发现，这并不是最理想的选择。原因在于微信小程序使用<code>rpx</code>（响应式像素）来衡量尺寸，而不是<code>px</code>或<code>em/rem</code>。<code>rpx</code>可以根据屏幕宽度自适应，规定屏幕宽度为 750rpx。因此，在设计时，如果选择了 iPhone 14 的画布宽度（395px），会导致后期换算时需要手动调整每个元素的<code>rpx</code>值。而如果设计时直接选用 375px 宽度作为画布，则在开发时可以直接使用<code>1rpx = 0.5px</code>的规则，简化了开发过程。</p><p>另外，尽管 Figma 提供了多个插件来帮助生成前端代码，但大多数插件在实际应用中并不十分实用。例如，一款插件在将 Figma 设计转换为 HTML 时，会将整个页面保存为一张图片，而在代码中只生成一个<code>&lt;img&gt;</code>标签。其他插件虽然没有那么极端，但也不同程度地存在类似问题。最实用的还是 Figma 自带的开发者模式，它可以更准确地将设计转化为前端代码，且具备较好的适配性。</p><p>有时，产品经理希望实现的某些效果在 Figma 中无法完全体现，这时就需要设计师、前端开发人员以及产品经理之间的有效沟通与协调。通过及时的交流，可以确保设计需求得到准确理解和实现，避免开发过程中出现不必要的返工。</p><h3 id="_3-3-1-咪咔相机架构总览" tabindex="-1"><a class="header-anchor" href="#_3-3-1-咪咔相机架构总览" aria-hidden="true">#</a> 3.3.1 <strong>咪咔相机架构总览</strong></h3><p>咪咔相机可以大致分为 4 个部分：</p><ul><li><p><strong>数据库：</strong> 咪咔相机使用阿里云的 PostgreSQL 数据库存储结构化数据，同时借助阿里云 OSS（对象存储服务）来存储非结构化数据，如图片、Lora 权重等。</p></li><li><p><strong>UI：</strong> 作为一款微信小程序，咪咔相机的前端部署无需额外的服务器支持，所有前端服务均由微信平台提供支持，简化了基础设施的管理。</p></li><li><p><strong>咪咔基础 API：</strong> 微信小程序通过调用咪咔基础 API 服务来执行各种操作，包括获取用户数据、下单、充值、分享等。这些 API 服务部署在阿里云上，确保稳定性与可扩展性。</p></li><li><p><strong>AI 生图服务 API：</strong> 由于 AI 图像生成需要大量 GPU 计算，咪咔相机选择在本地搭建 GPU 服务器来处理这一需求，而非使用云端 GPU 服务，主要考虑到成本因素。</p></li></ul><p>用户在微信小程序中的操作会通过这些服务进行处理，整体运作流程如下图所示：</p><figure><img src="/assets/img/mika_1/image-20250101192938270.jpg" alt="image-20250101192938270" tabindex="0" loading="lazy"><figcaption>image-20250101192938270</figcaption></figure><h3 id="_3-3-2-前端与微信小程序" tabindex="-1"><a class="header-anchor" href="#_3-3-2-前端与微信小程序" aria-hidden="true">#</a> 3.3.2 前端与微信小程序</h3><h4 id="_1-技术选择" tabindex="-1"><a class="header-anchor" href="#_1-技术选择" aria-hidden="true">#</a> 1. 技术选择</h4><p>在开发咪咔相机时，我们的目标是快速上线，但由于笔者在前端开发方面经验有限（熟悉 Vue，但主要有 AI 相关开发经验，对 React 的实际开发经验较少），我们经过调研后选择了 <strong>uniapp</strong> 来开发微信小程序。uniapp 上手简单，与 Vue 的语法类似，非常适合用来开发小型应用。通过 uniapp，我们可以轻松编译并生成适用于微信小程序的代码。</p><p>在决定使用 uniapp 后，笔者跟随黑马教育的“小兔仙教程”学习了 uniapp 的开发流程，并参考了该教程的项目文件夹架构及设置，建议大家也可以查看教程：</p><p>https://www.bilibili.com/video/BV1Bp4y1379L/?spm_id_from=333.337.search-card.all.click&amp;vd_source=4418d5cd5be787be7e3ff4138eeb9b0a</p><h4 id="_2-小程序开发" tabindex="-1"><a class="header-anchor" href="#_2-小程序开发" aria-hidden="true">#</a> 2 小程序开发</h4><p>uniapp 编写的代码可以直接编译为微信小程序所需的代码，开发语言包括 JavaScript、WXML 和 WXSS。这些语法与 HTML 和 CSS 类似，因此对于前端开发者来说，从网页开发迁移到小程序开发的成本相对较低，但二者之间仍有一些差异：</p><ul><li>一些常见的前端库，如 jQuery，在小程序中无法使用。</li><li>iOS 和 Android 小程序的运行环境存在一些小差异。</li></ul><p>小程序开发需要使用 <a href="https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html" target="_blank" rel="noopener noreferrer">微信开发者工具<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>。安装好微信开发者工具后，选择创建小程序，然后选择对应的 APPID（注册好小程序之后会给）</p><figure><img src="https://antarina.tech/assets/img/xiaochengxu/image-20230827140557736.png" alt="tu" tabindex="0" loading="lazy"><figcaption>tu</figcaption></figure><p>点击确认后进入编辑页面，官方会为你创建好程序的模板：</p><figure><img src="https://antarina.tech/assets/img/xiaochengxu/image-20230827164718808.png" alt="tu " tabindex="0" loading="lazy"><figcaption>tu </figcaption></figure><p>微信小程序开发使用 WXML，WXSS 等微信专用语法进行开发。语法类似 HTML 和 CSS。</p><p>微信小程序包含了不同的版本：</p><ul><li><p><strong>开发版本</strong> ：开发人员在微信开发工具上开发完成后，，可将代码上传到开发版本中。 开发人员可以在手机微信上体验测试开发版本的微信小程序。开发版本只保留每人最新的一份上传的代码。 点击提交审核，可将代码提交审核。开发版本可删除，不影响线上版本和审核中版本的代码。</p></li><li><p><strong>体验版本</strong> ：当开发人员觉得开发版本可行后，可以选择某个开发版本作为体验版，并且选取一份体验版。（点击开发者小程序中的上传，然后让管理员将该版本设置为体验版本。）体验版本只有授权用户可以体验，我们当时邀请了约 30 人来体验我们的小程序，主要用于收集 bug 反馈。在 管理-版本管理 中，可以找到开发版本，并选择对应开发版本为体验版本。</p></li><li><p><strong>审核版本</strong> ：当团队觉得小程序没有问题后，可以把小程序上线，让所有用户使用，但那之前我们需要把代码提交给微信进行审核。只能有一份代码处于审核中。有审核结果后可以发布到线上，也可直接重新提交审核，覆盖原审核版本。在 管理-版本管理 中，可以找到开发版本，点击提交审核。提交审核规则需要符合 <a href="https://developers.weixin.qq.com/miniprogram/product/" target="_blank" rel="noopener noreferrer">小程序平台运营规范 open in new window<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>。</p></li><li><p><strong>线上版本</strong> ：线上所有用户使用的代码版本，该版本代码在新版本代码发布后被覆盖更新。</p></li></ul><h4 id="_3-开发经验" tabindex="-1"><a class="header-anchor" href="#_3-开发经验" aria-hidden="true">#</a> 3. 开发经验</h4><p>前后端交互开发时，咪咔项目使用 <strong>Apifox</strong> 来生成 API 文档和 Mock API，从而简化开发过程。以下是前后端交互的主要流程：</p><ol><li>定义好产品所需功能。（产品经理负责）</li><li>为产品的每一项功能确定好技术实现方案（产品经理与技术总监讨论）</li><li>编写好 mock api 和 API 文档（后端开发）</li><li>根据 API 文档开发前端，而后使用 mock api 做测试。（前端开发）</li><li>编写 API 文档以及 mock api 的优点在于：前端后端的开发可以同时进行开发。等后端开发好全部 API 后，前端只需要替换掉 mock api 地址就可以进行测试了。同时团队也可以通过 API 文档来初步检测产品逻辑是否存在漏洞等。</li><li>前后端人员开发好后，进行产品测试与发布。</li></ol><p>示例图片：咪咔相机 Airfox API 文档</p><figure><img src="/assets/img/mika_1/image-20250103190949881.jpg" alt="image-20250103190949881" tabindex="0" loading="lazy"><figcaption>image-20250103190949881</figcaption></figure><h4 id="_4-部分页面的实现逻辑分享" tabindex="-1"><a class="header-anchor" href="#_4-部分页面的实现逻辑分享" aria-hidden="true">#</a> 4. 部分页面的实现逻辑分享</h4><ol><li>首页</li></ol><figure><img src="/assets/img/mika_1/image-20250105234357129.jpg" alt="image-20250105234357129" tabindex="0" loading="lazy"><figcaption>image-20250105234357129</figcaption></figure><p>当用户进入微信小程序时，首先会看到首页。首页展示咪咔相机生成的宠物 AI 照片，包含了两个主要模块：轮播图和下拉栏。</p><p>首页的实现逻辑如下：</p><ul><li>图片存储在阿里云 OSS 上，图片 URL 地址存储在 PostgreSQL 数据库中。</li><li>前端通过调用 <code>/api/v1/home/carousel</code> 获取首页轮播图的链接，并展示给用户。</li></ul><figure><img src="/assets/img/mika_1/image-20250103193815655.jpg" alt="image-20250103193815655" tabindex="0" loading="lazy"><figcaption>image-20250103193815655</figcaption></figure><ol start="2"><li>我的</li></ol><p>我的页面中提供了充值，登录， 查看余额，联系客服等操作。</p><ul><li><p><strong>充值功能</strong> ：使用微信小程序内置的微信支付功能。用户完成支付后，数据库会自动更新用户余额。微信小程序调用微信支付：https://antarina.tech/posts/notes/articles/%E7%AC%94%E8%AE%B0wxpay.html</p></li><li><p>登录部分，咪咔基于微信自带的 <code>wx.login</code> 设置了登录方案。用户第一次登录时，小程序会将 openid 发送到 <code>/api/v1/login/token</code> API 上来获取 <code>access_token</code> (JWT 令牌，用户请求业务 API 时的凭证，前端需要将 token 保存在 localstorage 当中)，用户余额等信息。后端负责创建用户数据，生成 JWT token。登录前，用户需要同意咪咔用户协议和微信隐私协议，用户协议全文由咪咔团队编写，隐私协议使用了微信提供的模板编写。</p></li></ul><figure><img src="/assets/img/mika_1/image-20250103194347640.jpg" alt="image-20250103194347640" tabindex="0" loading="lazy"><figcaption>image-20250103194347640</figcaption></figure><ul><li>联系客服方案，咪咔采用了微信自带的客服助手，前端上开启客服助手后，客服人员可以在客服小助手小程序上看到用户的留言。</li></ul><ol start="3"><li>拍照页面</li></ol><p>用户可以选择不同的拍照风格，点击后进入对应的风格页面。用户在选择拍摄风格后，前端会请求 <code>/api/v1/pet/generate_image</code> API 生成宠物照片。照片生成后，用户可以查看并分享给微信好友。</p><p>用户点击某个风格后，会跳转到风格对应的页面，如点击口袋宝贝，会跳转到口袋宝贝页面，页面中包含了几张口袋宝贝的示例图片。</p><p>用户点击生成风格后，可以选择想要拍摄的宝贝，稍作等待后，一张口袋宝贝的 AI 相册就生成好了。</p><figure><img src="/assets/img/mika_1/image-20250105144203883.jpg" alt="image-20250105144203883" tabindex="0" loading="lazy"><figcaption>image-20250105144203883</figcaption></figure><p>当用户点击生成风格后，前端会向 <code>/api/v1/pet/generate_image</code> API 发送请求，其中包含了宠物类别，宠物名称，宠物 ID，风格 ID，风格名称（如口袋宝贝）等。后端接收到请求后，会先验证用户的 JWT token，而后检测用户余额是否足够。余额足够的话，咪咔会将该生成图片的任务提交给消息队列，并在阿里云 postgres 上记录，该照片的状态为 <code>queue</code>，本地 GPU 服务器会处理这些消息，处理完毕后会将状态改为 <code>success</code> 或 <code>fail</code>。</p><figure><img src="/assets/img/mika_1/image-20250103200315205.jpg" alt="image-20250103200315205" tabindex="0" loading="lazy"><figcaption>image-20250103200315205</figcaption></figure><ol start="3"><li>相册</li></ol><p>用户提交拍照订单后，可在相册页面查看订单进度。正在生成中的照片会显示等待中的标志。</p><ul><li>每隔一段时间，前端会检查图片状态并更新。</li><li>用户可以分享生成的图片，并且每日首次分享可获得奖励。</li></ul><p>咪咔后台处理用户订单时，会将信息记录在阿里云 postgres 上。相册页面每隔一段时间，会往咪咔 API 发送请求，来检查用户宠物的图片状态是否改变，如果有改变的话，会更新对应的图片。</p><figure><img src="/assets/img/mika_1/image-20250103201003994.jpg" alt="image-20250103201003994" tabindex="0" loading="lazy"><figcaption>image-20250103201003994</figcaption></figure><p>每个订单中，咪咔会为用户生成 4 张该风格的图片，用户可以点击分享图片，来将图片分享给微信好友。咪咔采用了微信自带的分享 SDK 来实现了这个功能。一个比较特殊的设定是，用户每日首次分享，可以获得 150 个小鱼干， 用户点击了分享按钮后，咪咔后台会自动为用户添加这 150 个小鱼干，而后再触发分享功能。</p><ol start="3"><li>宠物档案</li></ol><p>宠物档案功能主要用于创建与宠物相关的 Lora 模型。用户可以在宠物档案页面通过左右滑动来浏览自己的宠物档案。</p><p>当用户点击“添加宠物”按钮时，会被引导至档案创建页面。在此页面，用户需填写宠物的基本信息，如名字和类型，同时上传 12 至 16 张宠物照片用于 Lora 训练。</p><figure><img src="/assets/img/mika_1/image-20250105142848652.jpg" alt="image-20250105142848652" tabindex="0" loading="lazy"><figcaption>image-20250105142848652</figcaption></figure><p>用户提交图片并点击“开始创建宠物档案”后，照片将被上传至阿里云 OSS，接着前端会向 <code>api/v1/pet/train</code> API 发送请求。咪咔 API 首先会验证用户的 JWT token。验证成功后，系统将按照以下步骤执行：</p><ol><li>在阿里云 PostgreSQL 数据库中添加对应的宠物数据（如名字、ID 等），并将宠物档案的状态设置为“队列中”（queue）。</li><li>将宠物 Lora 训练任务提交至消息队列（使用 RabbitMQ）。同时，系统将向用户发送一个订阅通知，用户点击同意后，便能在 Lora 训练完成时，第一时间收到微信服务消息的提醒。</li><li>本地 GPU 服务器将处理消息队列中的任务，并在处理过程中不断更新 PostgreSQL 中的档案状态。一旦 Lora 训练完成，后台 GPU 服务器会向用户发送微信服务消息。</li><li>用户最终会收到微信服务消息通知：【您的宝贝档案已生成】。</li></ol><figure><img src="/assets/img/mika_1/image-20250103201729971.jpg" alt="image-20250103201729971" tabindex="0" loading="lazy"><figcaption>image-20250103201729971</figcaption></figure><h3 id="_3-3-3-后端开发" tabindex="-1"><a class="header-anchor" href="#_3-3-3-后端开发" aria-hidden="true">#</a> 3.3.3 后端开发</h3><h4 id="数据库" tabindex="-1"><a class="header-anchor" href="#数据库" aria-hidden="true">#</a> 数据库</h4><p>咪咔采用阿里云 PostgreSQL 数据库，这一选择不仅符合成本要求，还提供了多项配套服务，如用户界面（类似于 PostgreSQL 的 pgAdmin）、异常监控等。由于咪咔的后端 API 也基于阿里云设备，因此 API 与数据库之间的通信可以通过阿里云内网进行，这样有效减少了网络通信费用。</p><p>数据库包含以下表格：</p><figure><img src="/assets/img/mika_1/image-20250105235000294.jpg" alt="image-20250105235000294" tabindex="0" loading="lazy"><figcaption>image-20250105235000294</figcaption></figure><ul><li><strong>充值订单表</strong> ：记录用户充值金额和时间。</li><li><strong>公告表</strong> ：用于发布和更新公告内容。</li><li><strong>商品定价表</strong> ：储存各风格对应的价格。</li><li><strong>宠物证件照表</strong> ：存储展示宠物档案页面的宠物图片。</li><li><strong>训练示例图片表</strong> ：用户提交 Lora 训练时，需要上传 12-16 张宠物图片。咪咔提供合格图片和错误图片的示例。</li><li><strong>首页图片表</strong> ：存储首页轮播图的图片链接。</li><li><strong>首页风格图片表</strong> ：储存拍照页面所有风格的图片链接。</li><li><strong>鱼干结算表</strong> ：记录用户的鱼干消费历史。</li></ul><h4 id="后端-api" tabindex="-1"><a class="header-anchor" href="#后端-api" aria-hidden="true">#</a> 后端 API</h4><p>咪咔的后端 API 采用<code>FastAPI</code>框架来与前端进行交互，整体项目架构参考了<a href="https://github.com/fastapi/full-stack-fastapi-template" target="_blank" rel="noopener noreferrer">FastAPI Full Stack 模板<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>。API 与数据库的连接通过<code>SQLAlchemy</code>实现，数据库迁移采用<code>Alembic</code>，而 API 请求的头部验证则使用 JWT token。</p><p>部署流程如下：</p><ol><li>注册域名并购买 SSL 证书。</li><li>将 API 服务打包为 Docker 镜像并部署在阿里云上。</li><li>配置域名解析到指定 IP 地址。</li><li>在微信小程序中，将域名添加到安全域名列表。</li></ol><h4 id="消息队列" tabindex="-1"><a class="header-anchor" href="#消息队列" aria-hidden="true">#</a> 消息队列</h4><p>咪咔采用 RabbitMQ 搭建消息队列服务，详细操作可参考[笔者的 RabbitMQ 博客文章](https://antarina.tech/posts/notes/articles/笔记 mq.html)。</p><p>咪咔设置了四个消息队列：</p><ul><li><strong>default</strong> ：处理普通任务。</li><li><strong>preprocess</strong> ：处理图片预处理任务，如目标识别、像素优化（超分辨率）、图片拆分等。</li><li><strong>train</strong> ：用于宠物档案制作（Lora 训练）。</li><li><strong>inference</strong> ：用于 AI 照片生成（SD + Lora 推理）。</li></ul><p>由于<code>train</code>和<code>inference</code>分布在不同设备上，Lora 训练任务完成后，训练好的 Lora 会上传到 OSS，<code>inference</code>设备获取任务后，从 OSS 下载 Lora 进行推理。</p><p>在处理流程中，<code>preprocess</code>、<code>train</code>和<code>inference</code>通常运行在不同设备上，因此<code>preprocess</code>会先从 OSS 下载用户上传的图片，进行目标检测（识别猫狗）、像素优化、生成图片描述等操作，处理好的图片会重新上传至 OSS，描述信息通过消息存入队列中。</p><h4 id="gpu-服务器" tabindex="-1"><a class="header-anchor" href="#gpu-服务器" aria-hidden="true">#</a> GPU 服务器</h4><p>GPU 服务器主要用于 Lora 训练和图片生成。Lora 训练流程包括图片下载、数据库更新、目标检测、生成图片描述、Lora 训练、宠物档案照片生成等操作。咪咔使用 Airflow 对任务进行管理和调度：</p><figure><img src="/assets/img/mika_1/image-20250103223401650.jpg" alt="image-20250103223401650" tabindex="0" loading="lazy"><figcaption>image-20250103223401650</figcaption></figure><p>在 Airflow 中，咪咔使用<code>Celery</code>和<code>RabbitMQ</code>来管理消息队列，<code>PostgreSQL</code>用于 Airflow 的数据管理。同时，咪咔还集成了阿里云提供的 Airflow SDK，以便与阿里云 OSS 进行数据交互。</p><h5 id="lora-训练" tabindex="-1"><a class="header-anchor" href="#lora-训练" aria-hidden="true">#</a> Lora 训练</h5><p>当 GPU 服务器接收到 Lora 训练任务时，后台会依次触发以下任务：</p><ul><li><strong>图片预处理：</strong><code>image_preprocess</code> 是一个 <code>Airflow Task Group</code>，负责处理用户上传的图片。假设用户上传了 12 张图片，Airflow 会将目标检测任务和图片描述生成任务分配给消息队列，由多个 worker 并行处理。咪咔配置了 4 个 worker 同时处理这些任务。</li><li><strong>图片目标检测：</strong> 为了确保训练效果，咪咔使用 YoloV5 对图片进行目标检测，并裁剪图片，使宠物占据图片的大部分区域。目标检测任务资源消耗较低且执行快速，4 个 worker 足以处理。</li><li><strong>图片描述生成：</strong> 为了生成 Lora 训练所需的描述（如 “cat”, “cute”, “on a beach” 等），咪咔将描述生成转化为多分类任务，通过模型自动选择与图片相匹配的描述词。此过程仅消耗 CPU 资源，且推理速度较快。相较于 GPT2 等大型模型，使用该方法能更有效地生成符合 SD 要求的描述。</li><li>lora 训练：<code>train</code> 任务是整个流程中最耗时的部分。咪咔采用 SDXL 架构进行 Lora 微调，训练时使用以下配置：在一台 4090 上训练的话，只需要花费 6 分钟就可以完成训练了。关于 sd + lora 方案的验证，欢迎查看笔者这篇文章：<a href="https://zhuanlan.zhihu.com/p/651809963" target="_blank" rel="noopener noreferrer">妙鸭=SD + Lora? 对 SD+LoRA 的一些探索与验证<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>。</li></ul><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6F42C1;">accelerate</span><span style="color:#24292E;"> </span><span style="color:#032F62;">launch</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--num_cpu_threads_per_process=2</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;/workspace/sdxl_train.py&quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">--enable_bucket</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">--pretrained_model_name_or_path=</span><span style="color:#032F62;">&quot;/models/kevinng/sdxl-train-base/sd_xl_base_1.0.safetensors&quot;</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">\</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">--train_data_dir=</span><span style="color:#032F62;">&quot;${</span><span style="color:#24292E;">TRAIN_DATA_DIR</span><span style="color:#032F62;">}&quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">--resolution=</span><span style="color:#032F62;">&quot;1024,1024&quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">--output_dir=</span><span style="color:#032F62;">&quot;${</span><span style="color:#24292E;">OUTPUT_LORA_FOLDER</span><span style="color:#032F62;">}&quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">--logging_dir=</span><span style="color:#032F62;">&quot;/workspace/logs&quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--network_alpha=</span><span style="color:#032F62;">&quot;8&quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--network_dim=8</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">--save_model_as=safetensors</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--network_module=networks.lora</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">\</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">--unet_lr=0.0004</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--output_name=</span><span style="color:#032F62;">&quot;${</span><span style="color:#24292E;">OUTPUT_LORA_NAME</span><span style="color:#032F62;">}&quot;</span><span style="color:#24292E;">             </span><span style="color:#005CC5;">\</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">--lr_scheduler_num_cycles=</span><span style="color:#032F62;">&quot;1&quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--no_half_vae</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--learning_rate=</span><span style="color:#032F62;">&quot;0.0004&quot;</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">\</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">--lr_scheduler=</span><span style="color:#032F62;">&quot;constant&quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--train_batch_size=</span><span style="color:#032F62;">&quot;2&quot;</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">\</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">--max_train_steps=</span><span style="color:#032F62;">&quot;${</span><span style="color:#24292E;">NUM_TRAIN_STEPS</span><span style="color:#032F62;">}&quot;</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">--save_every_n_epochs=</span><span style="color:#032F62;">&quot;1&quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--mixed_precision=</span><span style="color:#032F62;">&quot;bf16&quot;</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">\</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">--save_precision=</span><span style="color:#032F62;">&quot;bf16&quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--seed=</span><span style="color:#032F62;">&quot;1234&quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--caption_extension=</span><span style="color:#032F62;">&quot;.txt&quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--cache_latents</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">\</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">--optimizer_type=</span><span style="color:#032F62;">&quot;Adafactor&quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--max_data_loader_n_workers=</span><span style="color:#032F62;">&quot;4&quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--clip_skip=2</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">\</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">--bucket_reso_steps=64</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--xformers</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--bucket_no_upscale</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--noise_offset=0.0</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">--tokenizer_cache_dir=</span><span style="color:#032F62;">&quot;/models/kevinng/sdxl-train-base&quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">--optimizer_args</span><span style="color:#24292E;"> </span><span style="color:#032F62;">scale_parameter=False</span><span style="color:#24292E;"> </span><span style="color:#032F62;">relative_step=False</span><span style="color:#24292E;"> </span><span style="color:#032F62;">warmup_init=False</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">--gradient_checkpointing</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--cache_latents_to_disk</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--cache_text_encoder_outputs</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">--network_train_unet_only</span><span style="color:#24292E;"> </span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在单台 4090 GPU 上训练需要约 6 分钟。关于 SD + Lora 的验证，欢迎查看笔者的详细分析【添加链接】。</p><p>每当一个用户创建宠物档案时，咪咔根据当前队列任务数量计算预计等待时间，公式为：<strong>等待时间 = 15 分钟 * 任务个数</strong>。当订单数量超过 100 时，系统会自动启用第二个 GPU worker。</p><ul><li>生成宠物 ID 图片：宠物 ID 图片（带蝴蝶结或领带的证件照）通过 Lora 训练后生成。每个 Lora 都需要生成一个宠物 ID 图片，因此此任务与 Lora 训练任务共用同一容器。当 Lora 训练完成后，GPU 会加载 Lora 资源并进行 ID 图片生成。</li><li>上传数据：这部分的任务会被添加到 <code>default</code> 队列中，因为他们只涉及到了基础的数据库和通讯操作， 对性能的要求是微乎其微的（相比于其他任务来说）。当 lora 和宠物 ID 图片就绪后，这部分的任务会被触发，生成的 Lora 和宠物 ID 图片会上传到阿里云 OSS，相关资源链接会存入 PostgreSQL 数据库。</li><li>通知用户：当以上所有操作都成功后，这个 task 会发送一条微信服务通知给用户。即使用户关闭了小程序，他们也可以在微信服务中接受到这个通知。</li><li>失败报警：如果有任意一个环节出错了，airflow 会往企业微信机器人发送错误报警。根据经验，1000 个订单中大约出现 1 次错误，通常是网络或通讯问题（如 OSS 资源下载失败）。出错后，可以在 Airflow 上重新尝试该任务。</li></ul><p>总体而言，Lora 训练服务相当稳定。截至文章发布前，已经成功完成了 13,278 个任务，约有 1,100+ 个宠物档案顺利创建。</p><figure><img src="/assets/img/mika_1/image-20250103230757897.jpg" alt="image-20250103230757897" tabindex="0" loading="lazy"><figcaption>image-20250103230757897</figcaption></figure><h5 id="ai-相片生成" tabindex="-1"><a class="header-anchor" href="#ai-相片生成" aria-hidden="true">#</a> AI 相片生成</h5><p>图片生成的操作比较简单：</p><ol><li><strong>下载 Lora：</strong> 从 OSS 上下载用户对应的 Lora。</li><li><strong>下载风格参数：</strong> 从数据库获取用户所选风格的相关 prompt 和推理参数。</li><li><strong>使用 SDXL + Lora 进行推理：</strong> 通过 SDXL 和 Lora 模型生成图片。</li><li><strong>上传图片：</strong> 将生成的图片上传到 OSS，并在数据库中更新图片状态。</li></ol><p>咪咔提供约 70 种风格，所有风格的推理参数（包括 prompt 和 Lora 模型）都存储在数据库中。某些风格除了使用用户的宠物 Lora，还会使用咪咔自训练的风格 Lora，以提高生成图片的质量。</p><p>一般生成的图片尺寸为 1024x1024，咪咔会将原图和缩略图同时上传至阿里云 OSS。用户浏览相册时，显示的是约 70KB 的缩略图，而原图则在 1MB 到 2MB 之间。</p><p>SDXL + Lora 的推理速度较快，一台 4090 GPU 每生成一张图片大约需要 1 秒钟，包含了模型加载、推理和卸载的时间。不同风格可能会选择不同的 SDXL 模型，如户外野营风格可能使用 SDXL base 1.0，而夏日星空风格则使用更加动漫化的 SDXL 模型（如 Bluepencil）。频繁加载卸载不同的模型可能导致较大的时间开销，并且对显卡显存造成一定压力。</p><h4 id="日志和监控" tabindex="-1"><a class="header-anchor" href="#日志和监控" aria-hidden="true">#</a> 日志和监控</h4><p>咪咔的日志和监控系统由 Airflow、Grafana 和阿里云平台提供的日志系统构成。</p><p><strong>Airflow</strong> ：Airflow Web 界面用于监控每个任务的执行情况，包括任务参数、运行的具体代码日志等。使用 Airflow 作为日志系统时，确保日志和数据存储在相同的 OSS 和 PostgreSQL 平台上，否则可能会出现数据和日志无法匹配的情况，导致无法查看日志。</p><figure><img src="/assets/img/mika_1/image-20250105115542156.jpg" alt="image-20250105115542156" tabindex="0" loading="lazy"><figcaption>image-20250105115542156</figcaption></figure><p><strong>Grafana + Prometheus</strong> ：这两个工具主要用于监控消息队列的状态。咪咔使用 Celery 与 Grafana 和 Prometheus 配合，搭建了监控系统，实时追踪消息队列中的任务数量、消息处理速度等指标。当出现异常时，系统会自动向企业微信机器人发送警报。</p><p><strong>阿里云平台监控</strong> ：阿里云为平台提供了报警和监控功能，特别是针对阿里云 PostgreSQL 异常等问题。这些监控可以在阿里云平台上直接配置，当发生异常时，系统同样支持将警报发送至企业微信机器人。</p><h4 id="开发与更新" tabindex="-1"><a class="header-anchor" href="#开发与更新" aria-hidden="true">#</a> 开发与更新</h4><p><strong>代码仓库</strong> ：咪咔选择了 Gitee 作为代码托管平台，主要因为 GitHub 在国内访问速度较慢，且某些云平台在拉取 GitHub 代码时可能会有延迟。Docker 镜像仓库则采用了阿里云镜像服务，因其适合咪咔的需求。相比之下，Docker.io 服务不稳定，因此不推荐使用。</p><p><strong>SD 模型仓库</strong> ：咪咔使用 ModelScope 存储和共享训练好的模型，这样不同地区的 GPU 服务器可以更方便地拉取模型进行推理和训练。与此相比，Hugging Face 的服务经常出现下载不稳定的问题。</p><p><strong>CI/CD 流程</strong> ：最初，咪咔使用微软的 Azure Pipeline 进行 CI/CD，因其提供免费的使用时间。在 Azure Pipeline 上配置了自动化流程，每当上传代码到 GitHub 时，自动构建 Docker 镜像并推送到镜像仓库，同时更新阿里云服务。但随着免费时间的结束，咪咔停止使用自动化流程，改为手动更新代码、Docker 镜像和服务版本。</p><h2 id="_3-收获" tabindex="-1"><a class="header-anchor" href="#_3-收获" aria-hidden="true">#</a> 3. <strong>收获</strong></h2><p>咪咔相机作为笔者个人组织开发的第一个上线项目，也算是顺利完成了。从最初的灵感构思，到代码实现，再到上线运营，每一步都承载着咪咔的汗水与期待。几个月前，当小程序第一次上线时，我们迎来了第一位用户，那一刻百感交集。</p><p>最感动的瞬间，是看到用户用我们咪咔生产的图片当作微信头像，一直特具咪咔风格的卡通小猫，坐在一个盒子里，她一定很高兴，也很爱她的宠物宝贝吧。</p><p>另外有一次加班到晚上 11 点多，才匆匆登录微信客服助手，回复了用户的消息。本以为对方会感到不满，但用户却反过来劝我们不要太辛苦，说“明天再弄也可以”， “你们不要为了这个加班啊”。（泪目！）</p><p>体会到了 GM 的快乐，有些朋友特别喜欢我们生成的照片，时不时发来夸奖。作为管理员，我偷偷改了数据库，给这些朋友的账户充值了无限量的“小鱼干”（虚拟货币），让他们可以随意生成照片。</p><h4 id="产品成功的思考" tabindex="-1"><a class="header-anchor" href="#产品成功的思考" aria-hidden="true">#</a> 产品成功的思考</h4><p>在开发小程序的过程中，我也开始思考，什么才是“好产品”的标准。这个时代，开发一个能运行的产品并不难，但要创造一个真正打动人心的好产品，却需要极大的智慧与耐心。</p><p><strong>用户的需求定位</strong> 是第一要素。产品是否能够精准捕捉用户的痛点？能否解决他们最迫切的问题？</p><p><strong>价格的合理性</strong> 也至关重要。我们是否为用户提供了物有所值的体验？过高或过低的定价，都可能让产品失去竞争力。</p><p><strong>功能与用户体验的超预期表现</strong> ，则是吸引用户、留住用户的关键。功能不仅要运行顺畅，更要给用户带来惊喜和独特的体验，带给用户超出预期的体验。</p><p>此外 <strong>产品形象传递的情绪价值</strong> 等，也是产品成功的关键。</p><p>咪咖相机不是一款好的产品，我们把所有精力花费在了开发任务上，涉及到营销和推广的工作却微乎其微。尽管咪咔生成图片的质量的确不错，他里成功产品还有很大的距离。</p><p><strong>产品创造者</strong></p><p>作为程序员，曾经痴迷于从 0 到 1，独自把一个产品完整打造出来的过程。然而，完成咪咔之后，我发现，真正推动产品成功的，不仅仅是技术的实现，更是功能设计、营销推广、数据分析与运营管理的综合结果。技术是基础，但产品的灵魂在于如何通过设计和运营，让用户感受到价值与温度。</p><p>代码之外的世界更广阔，也更复杂。程序员可以成为优秀的产品创造者，但只有当他们开始理解市场、用户和情感，才能真正参与到好产品的创造中去。</p><p><strong>领导者</strong></p><p>“与一支出色的团队携手，打造一款卓越的产品。” 这令人向往的事，需要一个领导者带领。</p><p>领导者是能够激发他人、整合资源并引导团队实现共同目标的人。他们的职责不仅是完成任务，更重要的是塑造团队的整体方向和价值观，包括：</p><ul><li><strong>设定方向</strong> ：为团队提供清晰的愿景和战略。</li><li><strong>影响他人</strong> ：通过个人魅力、信任和专业能力影响团队成员的行为。为团队提供一个积极、安全的工作氛围，让每个成员都能贡献自己的独特优势。</li><li><strong>创造价值</strong> ：不仅关注目标结果，还注重实现过程中的学习、成长和可持续发展。</li></ul><p>理想的领导者不仅仅是指挥者，更是激励者、倾听者和支持者。他们通过明确的愿景、以身作则和有效的沟通，帮助团队成员实现个人成长，同时推动集体的成功。</p><p>要成为一名优秀的领导者，需要具备多方面的能力，并不断反思与学习：</p><ol><li><strong>培养战略思维</strong> 优秀的领导者能够从整体上把握局势，设定清晰的目标和可行的计划。他们善于分析问题、评估风险，并为团队制定创新的解决方案。</li><li><strong>提升人际沟通与情感智能</strong> 开放沟通和倾听能力是建立团队信任的基础。领导者需要通过同理心理解团队成员的需求，塑造支持性和包容性的工作环境。此外，学会用清晰的语言表达愿景和目标，让团队成员明确方向。</li><li><strong>增强凝聚力与号召力</strong> 领导者应激励团队成员，为他们赋予归属感和共同愿景。同时，通过以身作则和榜样作用，激发团队的信心和动力。</li><li><strong>优化组织与执行能力</strong> 将复杂任务合理分解，分配到合适的团队成员，并建立持续反馈机制，确保目标按时达成。同时，优秀的领导者具备很强的应急能力，在变化中快速调整策略，保证行动不脱轨。</li><li><strong>坚持学习与自我提升</strong> 成为优秀的领导者需要持续的学习和反思。他们在实践中不断积累经验，并通过失败中汲取教训，持续优化自己的领导风格。</li></ol><p>通过全面的能力发展和对团队价值的深刻理解，领导者可以不仅带领团队走向成功，还能创造一个鼓舞人心、充满信任和合作的工作环境，为团队成员的成长提供无限可能。</p></div><!----><footer class="page-meta"><!----><div class="meta-item git-info"><div class="update-time"><span class="label">上次编辑于: </span><!----></div><div class="contributors"><span class="label">贡献者: </span><!--[--><!--[--><span class="contributor" title="email: 417333277@qq.com">kevinng77</span><!--]--><!--]--></div></div></footer><!----><!----><!----><!--]--></main><!--]--><footer class="vp-footer-wrapper"><div class="vp-footer"><a href="https://beian.miit.gov.cn/" target="_blank">沪ICP备2023027904号-1</a>&nbsp;<a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=" target="_blank"><img src="/assets/gongan.png">公安备案号 </a></div><div class="vp-copyright">Copyright © 2025 Kevin 吴嘉文</div></footer></div><!--]--><!--]--><!----><!--]--></div>
    <script type="module" src="/assets/app-8f289594.js" defer></script>
  </body>
</html>
