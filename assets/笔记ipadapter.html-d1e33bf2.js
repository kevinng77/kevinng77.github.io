import{_ as e}from"./plugin-vue_export-helper-c27b6911.js";import{r as p,o as i,c as m,a as s,b as a,d as n,f as t}from"./app-735ae02b.js";const c={},r=s("p",null,"本文介绍 IP-Adapter，结合笔者的使用体验，在垫图方面，IP-Adapter 效果比 Controlnet reference only 及 SD 原生的 img2img 效果要好很多。并且可以配合 controlnet 的其他风格（如 canny 或者 depth）来实现多维度的图片生成控制。",-1),o=s("h3",{id:"ldm-回顾",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#ldm-回顾","aria-hidden":"true"},"#"),a(" LDM 回顾")],-1),h=s("p",null,"回顾 LDM 中的 img-to-img 部分，LDM 中图像与文字交互的方式为单纯的 cross-attention：",-1),d=s("figure",null,[s("img",{src:"https://pic3.zhimg.com/80/v2-da826549375793c4f8472a54a14c1616_1440w.webp",alt:"img",tabindex:"0",loading:"lazy"}),s("figcaption",null,"img")],-1),g=s("p",null,[a("文本先是被编码后， padding 到了固定的 77 长度，以此来保证文字的 hidden state 格式为 "),s("code",null,"[batch_size, 77, 1280]"),a("。")],-1),y=s("code",null,"Transformer2DModel",-1),u={href:"https://github.com/huggingface/diffusers/blob/16b9a57d29b6dbce4f97dbf439af1663d2c54588/src/diffusers/models/transformer_2d.py#L44C6-L44C6",target:"_blank",rel:"noopener noreferrer"},v=s("code",null,"(batch_size, channel, width, height)",-1),b=s("code",null,"(batch_size, num_image_vectors)",-1),_=s("code",null,"(batch_size, len_seq, hidden_size)",-1),f=s("code",null,"hidden_states",-1),z=s("code",null,"hidden_states",-1),E=s("code",null,"encoder_hidden_states",-1),x=t(`<div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># LDM 传统的 CrossAttnDownBlock2D（参考 huggingface diffusers 实现）</span></span>
<span class="line"><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">forward</span><span style="color:#24292E;">(self, hidden_states, temb, encoder_hidden_states</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">None</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">	output_states </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> ()</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> resnet, attn </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">zip</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.resnets, </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.attentions):</span></span>
<span class="line"><span style="color:#24292E;">        hidden_states </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> resnet(hidden_states, temb)</span></span>
<span class="line"><span style="color:#24292E;">        hidden_states </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> attn(</span></span>
<span class="line"><span style="color:#24292E;">            hidden_states,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#E36209;">encoder_hidden_states</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">encoder_hidden_states,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#E36209;">cross_attention_kwargs</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">cross_attention_kwargs,</span></span>
<span class="line"><span style="color:#24292E;">        ).sample</span></span>
<span class="line"><span style="color:#24292E;">        output_states </span><span style="color:#D73A49;">+=</span><span style="color:#24292E;"> (hidden_states,)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># downsampler = Conv2D </span></span>
<span class="line"><span style="color:#24292E;">    hidden_states </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> downsampler(hidden_states)</span></span>
<span class="line"><span style="color:#24292E;">    output_states </span><span style="color:#D73A49;">+=</span><span style="color:#24292E;"> (hidden_states,)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> hidden_states, output_states</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>由于每层 UNET 的维度不同，因此，在进行 cross attention 时候，图像的 hidden state （latent）大小分别被映射到了 <code>[4096, 320]</code>，<code>[2014, 640]</code>，<code>[256, 1280]</code> （以 SD 1.5 为例），而后与文字的 hidden state <code>[77, 768]</code> 进行 cross attention 计算。（以上张量维度省略了 batch size）</p><h3 id="ip-adapter-思路" tabindex="-1"><a class="header-anchor" href="#ip-adapter-思路" aria-hidden="true">#</a> IP-Adapter 思路</h3><figure><img src="https://pic2.zhimg.com/80/v2-63b7953178b8173709f7c32a1a804871_1440w.webp" alt="image-20231229213557294" tabindex="0" loading="lazy"><figcaption>image-20231229213557294</figcaption></figure><p>上图为 IP-Adapter 的架构图，IP-Adapter 论文中描述道，image prompt adapter 效果不好的一个主要因素是，图片的特征不能被很好的利用，大部分的 adapter 采用简单的 concatenated 的方式来注入图片特征信息。于是 IP-Adapter 提出了 decoupled cross-attention。</p><p>传统的 LDM cross attention 可以表示为：</p>`,6),w=s("p",{class:"katex-block"},[s("span",{class:"katex-display"},[s("span",{class:"katex"},[s("span",{class:"katex-mathml"},[s("math",{xmlns:"http://www.w3.org/1998/Math/MathML",display:"block"},[s("semantics",null,[s("mrow",null,[s("msup",null,[s("mi",{mathvariant:"bold"},"Z"),s("mo",{mathvariant:"normal",lspace:"0em",rspace:"0em"},"′")]),s("mo",null,"="),s("mi",{mathvariant:"normal"},"Attention"),s("mo",null,"⁡"),s("mo",{stretchy:"false"},"("),s("mi",{mathvariant:"bold"},"Q"),s("mo",{separator:"true"},","),s("mi",{mathvariant:"bold"},"K"),s("mo",{separator:"true"},","),s("mi",{mathvariant:"bold"},"V"),s("mo",{stretchy:"false"},")"),s("mo",null,"="),s("mi",{mathvariant:"normal"},"Softmax"),s("mo",null,"⁡"),s("mrow",null,[s("mo",{fence:"true"},"("),s("mfrac",null,[s("msup",null,[s("mrow",null,[s("mi",{mathvariant:"bold"},"Q"),s("mi",{mathvariant:"bold"},"K")]),s("mi",{mathvariant:"normal"},"⊤")]),s("msqrt",null,[s("mi",null,"d")])]),s("mo",{fence:"true"},")")]),s("mi",{mathvariant:"bold"},"V")]),s("annotation",{encoding:"application/x-tex"}," \\mathbf{Z}^{\\prime}=\\operatorname{Attention}(\\mathbf{Q}, \\mathbf{K}, \\mathbf{V})=\\operatorname{Softmax}\\left(\\frac{\\mathbf{Q K}^{\\top}}{\\sqrt{d}}\\right) \\mathbf{V} ")])])]),s("span",{class:"katex-html","aria-hidden":"true"},[s("span",{class:"base"},[s("span",{class:"strut",style:{height:"0.8019em"}}),s("span",{class:"mord"},[s("span",{class:"mord mathbf"},"Z"),s("span",{class:"msupsub"},[s("span",{class:"vlist-t"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.8019em"}},[s("span",{style:{top:"-3.113em","margin-right":"0.05em"}},[s("span",{class:"pstrut",style:{height:"2.7em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mtight"},[s("span",{class:"mord mtight"},"′")])])])])])])])]),s("span",{class:"mspace",style:{"margin-right":"0.2778em"}}),s("span",{class:"mrel"},"="),s("span",{class:"mspace",style:{"margin-right":"0.2778em"}})]),s("span",{class:"base"},[s("span",{class:"strut",style:{height:"1em","vertical-align":"-0.25em"}}),s("span",{class:"mop"},[s("span",{class:"mord mathrm"},"Attention")]),s("span",{class:"mopen"},"("),s("span",{class:"mord mathbf"},"Q"),s("span",{class:"mpunct"},","),s("span",{class:"mspace",style:{"margin-right":"0.1667em"}}),s("span",{class:"mord mathbf"},"K"),s("span",{class:"mpunct"},","),s("span",{class:"mspace",style:{"margin-right":"0.1667em"}}),s("span",{class:"mord mathbf",style:{"margin-right":"0.01597em"}},"V"),s("span",{class:"mclose"},")"),s("span",{class:"mspace",style:{"margin-right":"0.2778em"}}),s("span",{class:"mrel"},"="),s("span",{class:"mspace",style:{"margin-right":"0.2778em"}})]),s("span",{class:"base"},[s("span",{class:"strut",style:{height:"3em","vertical-align":"-1.25em"}}),s("span",{class:"mop"},[s("span",{class:"mord mathrm"},"Softmax")]),s("span",{class:"mspace",style:{"margin-right":"0.1667em"}}),s("span",{class:"minner"},[s("span",{class:"mopen delimcenter",style:{top:"0em"}},[s("span",{class:"delimsizing size4"},"(")]),s("span",{class:"mord"},[s("span",{class:"mopen nulldelimiter"}),s("span",{class:"mfrac"},[s("span",{class:"vlist-t vlist-t2"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"1.6021em"}},[s("span",{style:{top:"-2.1778em"}},[s("span",{class:"pstrut",style:{height:"3em"}}),s("span",{class:"mord"},[s("span",{class:"mord sqrt"},[s("span",{class:"vlist-t vlist-t2"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.9322em"}},[s("span",{class:"svg-align",style:{top:"-3em"}},[s("span",{class:"pstrut",style:{height:"3em"}}),s("span",{class:"mord",style:{"padding-left":"0.833em"}},[s("span",{class:"mord mathnormal"},"d")])]),s("span",{style:{top:"-2.8922em"}},[s("span",{class:"pstrut",style:{height:"3em"}}),s("span",{class:"hide-tail",style:{"min-width":"0.853em",height:"1.08em"}},[s("svg",{xmlns:"http://www.w3.org/2000/svg",width:"400em",height:"1.08em",viewBox:"0 0 400000 1080",preserveAspectRatio:"xMinYMin slice"},[s("path",{d:`M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z`})])])])]),s("span",{class:"vlist-s"},"​")]),s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.1078em"}},[s("span")])])])])])]),s("span",{style:{top:"-3.23em"}},[s("span",{class:"pstrut",style:{height:"3em"}}),s("span",{class:"frac-line",style:{"border-bottom-width":"0.04em"}})]),s("span",{style:{top:"-3.677em"}},[s("span",{class:"pstrut",style:{height:"3em"}}),s("span",{class:"mord"},[s("span",{class:"mord"},[s("span",{class:"mord"},[s("span",{class:"mord mathbf"},"QK")]),s("span",{class:"msupsub"},[s("span",{class:"vlist-t"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.9251em"}},[s("span",{style:{top:"-3.139em","margin-right":"0.05em"}},[s("span",{class:"pstrut",style:{height:"2.7em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mtight"},[s("span",{class:"mord mtight"},"⊤")])])])])])])])])])])]),s("span",{class:"vlist-s"},"​")]),s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.93em"}},[s("span")])])])]),s("span",{class:"mclose nulldelimiter"})]),s("span",{class:"mclose delimcenter",style:{top:"0em"}},[s("span",{class:"delimsizing size4"},")")])]),s("span",{class:"mspace",style:{"margin-right":"0.1667em"}}),s("span",{class:"mord mathbf",style:{"margin-right":"0.01597em"}},"V")])])])])],-1),A=s("p",null,[a("其中 "),s("span",{class:"katex"},[s("span",{class:"katex-mathml"},[s("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[s("semantics",null,[s("mrow",null,[s("mi",{mathvariant:"bold"},"Q"),s("mo",null,"="),s("mi",{mathvariant:"bold"},"Z"),s("msub",null,[s("mi",{mathvariant:"bold"},"W"),s("mi",null,"q")]),s("mo",{separator:"true"},","),s("mi",{mathvariant:"bold"},"K"),s("mo",null,"="),s("msub",null,[s("mi",{mathvariant:"bold-italic"},"c"),s("mi",null,"t")]),s("msub",null,[s("mi",{mathvariant:"bold"},"W"),s("mi",null,"k")]),s("mo",{separator:"true"},","),s("mi",{mathvariant:"bold"},"V"),s("mo",null,"="),s("msub",null,[s("mi",{mathvariant:"bold-italic"},"c"),s("mi",null,"t")]),s("msub",null,[s("mi",{mathvariant:"bold"},"W"),s("mi",null,"v")])]),s("annotation",{encoding:"application/x-tex"},"\\mathbf{Q}=\\mathbf{Z} \\mathbf{W}_q, \\mathbf{K}=\\boldsymbol{c}_t \\mathbf{W}_k, \\mathbf{V}=\\boldsymbol{c}_t \\mathbf{W}_v")])])]),s("span",{class:"katex-html","aria-hidden":"true"},[s("span",{class:"base"},[s("span",{class:"strut",style:{height:"0.8805em","vertical-align":"-0.1944em"}}),s("span",{class:"mord mathbf"},"Q"),s("span",{class:"mspace",style:{"margin-right":"0.2778em"}}),s("span",{class:"mrel"},"="),s("span",{class:"mspace",style:{"margin-right":"0.2778em"}})]),s("span",{class:"base"},[s("span",{class:"strut",style:{height:"0.9722em","vertical-align":"-0.2861em"}}),s("span",{class:"mord mathbf"},"Z"),s("span",{class:"mord"},[s("span",{class:"mord mathbf",style:{"margin-right":"0.01597em"}},"W"),s("span",{class:"msupsub"},[s("span",{class:"vlist-t vlist-t2"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.1514em"}},[s("span",{style:{top:"-2.55em","margin-left":"-0.016em","margin-right":"0.05em"}},[s("span",{class:"pstrut",style:{height:"2.7em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.03588em"}},"q")])])]),s("span",{class:"vlist-s"},"​")]),s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.2861em"}},[s("span")])])])])]),s("span",{class:"mpunct"},","),s("span",{class:"mspace",style:{"margin-right":"0.1667em"}}),s("span",{class:"mord mathbf"},"K"),s("span",{class:"mspace",style:{"margin-right":"0.2778em"}}),s("span",{class:"mrel"},"="),s("span",{class:"mspace",style:{"margin-right":"0.2778em"}})]),s("span",{class:"base"},[s("span",{class:"strut",style:{height:"0.8805em","vertical-align":"-0.1944em"}}),s("span",{class:"mord"},[s("span",{class:"mord"},[s("span",{class:"mord"},[s("span",{class:"mord boldsymbol"},"c")])]),s("span",{class:"msupsub"},[s("span",{class:"vlist-t vlist-t2"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.2806em"}},[s("span",{style:{top:"-2.55em","margin-right":"0.05em"}},[s("span",{class:"pstrut",style:{height:"2.7em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mathnormal mtight"},"t")])])]),s("span",{class:"vlist-s"},"​")]),s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.15em"}},[s("span")])])])])]),s("span",{class:"mord"},[s("span",{class:"mord mathbf",style:{"margin-right":"0.01597em"}},"W"),s("span",{class:"msupsub"},[s("span",{class:"vlist-t vlist-t2"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.3361em"}},[s("span",{style:{top:"-2.55em","margin-left":"-0.016em","margin-right":"0.05em"}},[s("span",{class:"pstrut",style:{height:"2.7em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.03148em"}},"k")])])]),s("span",{class:"vlist-s"},"​")]),s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.15em"}},[s("span")])])])])]),s("span",{class:"mpunct"},","),s("span",{class:"mspace",style:{"margin-right":"0.1667em"}}),s("span",{class:"mord mathbf",style:{"margin-right":"0.01597em"}},"V"),s("span",{class:"mspace",style:{"margin-right":"0.2778em"}}),s("span",{class:"mrel"},"="),s("span",{class:"mspace",style:{"margin-right":"0.2778em"}})]),s("span",{class:"base"},[s("span",{class:"strut",style:{height:"0.8361em","vertical-align":"-0.15em"}}),s("span",{class:"mord"},[s("span",{class:"mord"},[s("span",{class:"mord"},[s("span",{class:"mord boldsymbol"},"c")])]),s("span",{class:"msupsub"},[s("span",{class:"vlist-t vlist-t2"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.2806em"}},[s("span",{style:{top:"-2.55em","margin-right":"0.05em"}},[s("span",{class:"pstrut",style:{height:"2.7em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mathnormal mtight"},"t")])])]),s("span",{class:"vlist-s"},"​")]),s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.15em"}},[s("span")])])])])]),s("span",{class:"mord"},[s("span",{class:"mord mathbf",style:{"margin-right":"0.01597em"}},"W"),s("span",{class:"msupsub"},[s("span",{class:"vlist-t vlist-t2"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.1514em"}},[s("span",{style:{top:"-2.55em","margin-left":"-0.016em","margin-right":"0.05em"}},[s("span",{class:"pstrut",style:{height:"2.7em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.03588em"}},"v")])])]),s("span",{class:"vlist-s"},"​")]),s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.15em"}},[s("span")])])])])])])])]),a(" ，"),s("span",{class:"katex"},[s("span",{class:"katex-mathml"},[s("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[s("semantics",null,[s("mrow",null,[s("msub",null,[s("mi",null,"c"),s("mi",null,"t")])]),s("annotation",{encoding:"application/x-tex"},"c_t")])])]),s("span",{class:"katex-html","aria-hidden":"true"},[s("span",{class:"base"},[s("span",{class:"strut",style:{height:"0.5806em","vertical-align":"-0.15em"}}),s("span",{class:"mord"},[s("span",{class:"mord mathnormal"},"c"),s("span",{class:"msupsub"},[s("span",{class:"vlist-t vlist-t2"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.2806em"}},[s("span",{style:{top:"-2.55em","margin-left":"0em","margin-right":"0.05em"}},[s("span",{class:"pstrut",style:{height:"2.7em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mathnormal mtight"},"t")])])]),s("span",{class:"vlist-s"},"​")]),s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.15em"}},[s("span")])])])])])])])]),a(" 为文本特征，"),s("span",{class:"katex"},[s("span",{class:"katex-mathml"},[s("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[s("semantics",null,[s("mrow",null,[s("mi",null,"Z")]),s("annotation",{encoding:"application/x-tex"},"Z")])])]),s("span",{class:"katex-html","aria-hidden":"true"},[s("span",{class:"base"},[s("span",{class:"strut",style:{height:"0.6833em"}}),s("span",{class:"mord mathnormal",style:{"margin-right":"0.07153em"}},"Z")])])]),a(" 为与图像相关的 "),s("code",null,"hidden_state"),a("。")],-1),C=s("p",null,[a("IP-Adapter 进行注意力解耦后，分别单独计算了文字和 "),s("span",{class:"katex"},[s("span",{class:"katex-mathml"},[s("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[s("semantics",null,[s("mrow",null,[s("mi",{mathvariant:"bold"},"Q")]),s("annotation",{encoding:"application/x-tex"},"\\mathbf{Q}")])])]),s("span",{class:"katex-html","aria-hidden":"true"},[s("span",{class:"base"},[s("span",{class:"strut",style:{height:"0.8805em","vertical-align":"-0.1944em"}}),s("span",{class:"mord mathbf"},"Q")])])]),a(" 的交叉注意力，以及参考图和 "),s("span",{class:"katex"},[s("span",{class:"katex-mathml"},[s("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[s("semantics",null,[s("mrow",null,[s("mi",{mathvariant:"bold"},"Q")]),s("annotation",{encoding:"application/x-tex"},"\\mathbf{Q}")])])]),s("span",{class:"katex-html","aria-hidden":"true"},[s("span",{class:"base"},[s("span",{class:"strut",style:{height:"0.8805em","vertical-align":"-0.1944em"}}),s("span",{class:"mord mathbf"},"Q")])])]),a(" 的交叉注意力，而后对两个注意力矩阵进行加和，计算方式为：")],-1),D=s("p",{class:"katex-block"},[s("span",{class:"katex-display"},[s("span",{class:"katex"},[s("span",{class:"katex-mathml"},[s("math",{xmlns:"http://www.w3.org/1998/Math/MathML",display:"block"},[s("semantics",null,[s("mtable",{rowspacing:"0.16em",columnalign:"right",columnspacing:"1em"},[s("mtr",null,[s("mtd",null,[s("mstyle",{scriptlevel:"0",displaystyle:"false"},[s("mrow",null,[s("msup",null,[s("mi",{mathvariant:"bold"},"Z"),s("mtext",null,"new ")]),s("mo",null,"="),s("mi",{mathvariant:"normal"},"Softmax"),s("mo",null,"⁡"),s("mrow",null,[s("mo",{fence:"true"},"("),s("mfrac",null,[s("msup",null,[s("mrow",null,[s("mi",{mathvariant:"bold"},"Q"),s("mi",{mathvariant:"bold"},"K")]),s("mi",{mathvariant:"normal"},"⊤")]),s("msqrt",null,[s("mi",null,"d")])]),s("mo",{fence:"true"},")")]),s("mi",{mathvariant:"bold"},"V"),s("mo",null,"+"),s("mi",null,"λ"),s("mo",null,"×"),s("mi",{mathvariant:"normal"},"Softmax"),s("mo",null,"⁡"),s("mrow",null,[s("mo",{fence:"true"},"("),s("mfrac",null,[s("mrow",null,[s("mi",{mathvariant:"bold"},"Q"),s("msup",null,[s("mrow",null,[s("mo",{fence:"true"},"("),s("msup",null,[s("mi",{mathvariant:"bold"},"K"),s("mo",{mathvariant:"normal",lspace:"0em",rspace:"0em"},"′")]),s("mo",{fence:"true"},")")]),s("mi",{mathvariant:"normal"},"⊤")])]),s("msqrt",null,[s("mi",null,"d")])]),s("mo",{fence:"true"},")")]),s("msup",null,[s("mi",{mathvariant:"bold"},"V"),s("mo",{mathvariant:"normal",lspace:"0em",rspace:"0em"},"′")])])])])]),s("mtr",null,[s("mtd",null,[s("mstyle",{scriptlevel:"0",displaystyle:"false"},[s("mrow",null,[s("mtext",null," where "),s("mi",{mathvariant:"bold"},"Q"),s("mo",null,"="),s("mi",{mathvariant:"bold"},"Z"),s("msub",null,[s("mi",{mathvariant:"bold"},"W"),s("mi",null,"q")]),s("mo",{separator:"true"},","),s("mi",{mathvariant:"bold"},"K"),s("mo",null,"="),s("msub",null,[s("mi",{mathvariant:"bold-italic"},"c"),s("mi",null,"t")]),s("msub",null,[s("mi",{mathvariant:"bold"},"W"),s("mi",null,"k")]),s("mo",{separator:"true"},","),s("mi",{mathvariant:"bold"},"V"),s("mo",null,"="),s("msub",null,[s("mi",{mathvariant:"bold-italic"},"c"),s("mi",null,"t")]),s("msub",null,[s("mi",{mathvariant:"bold"},"W"),s("mi",null,"v")]),s("mo",{separator:"true"},","),s("msup",null,[s("mi",{mathvariant:"bold"},"K"),s("mo",{mathvariant:"normal",lspace:"0em",rspace:"0em"},"′")]),s("mo",null,"="),s("msub",null,[s("mi",{mathvariant:"bold-italic"},"c"),s("mi",null,"i")]),s("msubsup",null,[s("mi",{mathvariant:"bold"},"W"),s("mi",null,"k"),s("mo",{mathvariant:"normal",lspace:"0em",rspace:"0em"},"′")]),s("mo",{separator:"true"},","),s("msup",null,[s("mi",{mathvariant:"bold"},"V"),s("mo",{mathvariant:"normal",lspace:"0em",rspace:"0em"},"′")]),s("mo",null,"="),s("msub",null,[s("mi",{mathvariant:"bold-italic"},"c"),s("mi",null,"i")]),s("msubsup",null,[s("mi",{mathvariant:"bold"},"W"),s("mi",null,"v"),s("mo",{mathvariant:"normal",lspace:"0em",rspace:"0em"},"′")])])])])])]),s("annotation",{encoding:"application/x-tex"}," \\begin{array}{r} \\mathbf{Z}^{\\text {new }}=\\operatorname{Softmax}\\left(\\frac{\\mathbf{Q K}^{\\top}}{\\sqrt{d}}\\right) \\mathbf{V}+\\lambda \\times \\operatorname{Softmax}\\left(\\frac{\\mathbf{Q}\\left(\\mathbf{K}^{\\prime}\\right)^{\\top}}{\\sqrt{d}}\\right) \\mathbf{V}^{\\prime} \\\\ \\text { where } \\mathbf{Q}=\\mathbf{Z} \\mathbf{W}_q, \\mathbf{K}=\\boldsymbol{c}_t \\mathbf{W}_k, \\mathbf{V}=\\boldsymbol{c}_t \\mathbf{W}_v, \\mathbf{K}^{\\prime}=\\boldsymbol{c}_i \\mathbf{W}_k^{\\prime}, \\mathbf{V}^{\\prime}=\\boldsymbol{c}_i \\mathbf{W}_v^{\\prime} \\end{array} ")])])]),s("span",{class:"katex-html","aria-hidden":"true"},[s("span",{class:"base"},[s("span",{class:"strut",style:{height:"3.6em","vertical-align":"-1.55em"}}),s("span",{class:"mord"},[s("span",{class:"mtable"},[s("span",{class:"arraycolsep",style:{width:"0.5em"}}),s("span",{class:"col-align-r"},[s("span",{class:"vlist-t vlist-t2"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"2.05em"}},[s("span",{style:{top:"-4.05em"}},[s("span",{class:"pstrut",style:{height:"3.45em"}}),s("span",{class:"mord"},[s("span",{class:"mord"},[s("span",{class:"mord mathbf"},"Z"),s("span",{class:"msupsub"},[s("span",{class:"vlist-t"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.6644em"}},[s("span",{style:{top:"-3.063em","margin-right":"0.05em"}},[s("span",{class:"pstrut",style:{height:"2.7em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mtight"},[s("span",{class:"mord text mtight"},[s("span",{class:"mord mtight"},"new ")])])])])])])])])]),s("span",{class:"mspace",style:{"margin-right":"0.2778em"}}),s("span",{class:"mrel"},"="),s("span",{class:"mspace",style:{"margin-right":"0.2778em"}}),s("span",{class:"mop"},[s("span",{class:"mord mathrm"},"Softmax")]),s("span",{class:"mspace",style:{"margin-right":"0.1667em"}}),s("span",{class:"minner"},[s("span",{class:"mopen delimcenter",style:{top:"0em"}},[s("span",{class:"delimsizing size2"},"(")]),s("span",{class:"mord"},[s("span",{class:"mopen nulldelimiter"}),s("span",{class:"mfrac"},[s("span",{class:"vlist-t vlist-t2"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"1.095em"}},[s("span",{style:{top:"-2.5335em"}},[s("span",{class:"pstrut",style:{height:"3em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mtight"},[s("span",{class:"mord sqrt mtight"},[s("span",{class:"vlist-t vlist-t2"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.9378em"}},[s("span",{class:"svg-align",style:{top:"-3em"}},[s("span",{class:"pstrut",style:{height:"3em"}}),s("span",{class:"mord mtight",style:{"padding-left":"0.833em"}},[s("span",{class:"mord mathnormal mtight"},"d")])]),s("span",{style:{top:"-2.8978em"}},[s("span",{class:"pstrut",style:{height:"3em"}}),s("span",{class:"hide-tail mtight",style:{"min-width":"0.853em",height:"1.08em"}},[s("svg",{xmlns:"http://www.w3.org/2000/svg",width:"400em",height:"1.08em",viewBox:"0 0 400000 1080",preserveAspectRatio:"xMinYMin slice"},[s("path",{d:`M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z`})])])])]),s("span",{class:"vlist-s"},"​")]),s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.1022em"}},[s("span")])])])])])])]),s("span",{style:{top:"-3.23em"}},[s("span",{class:"pstrut",style:{height:"3em"}}),s("span",{class:"frac-line",style:{"border-bottom-width":"0.04em"}})]),s("span",{style:{top:"-3.4461em"}},[s("span",{class:"pstrut",style:{height:"3em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mtight"},[s("span",{class:"mord mtight"},[s("span",{class:"mord mtight"},[s("span",{class:"mord mathbf mtight"},"QK")]),s("span",{class:"msupsub"},[s("span",{class:"vlist-t"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.927em"}},[s("span",{style:{top:"-2.931em","margin-right":"0.0714em"}},[s("span",{class:"pstrut",style:{height:"2.5em"}}),s("span",{class:"sizing reset-size3 size1 mtight"},[s("span",{class:"mord mtight"},[s("span",{class:"mord mtight"},"⊤")])])])])])])])])])])])]),s("span",{class:"vlist-s"},"​")]),s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.538em"}},[s("span")])])])]),s("span",{class:"mclose nulldelimiter"})]),s("span",{class:"mclose delimcenter",style:{top:"0em"}},[s("span",{class:"delimsizing size2"},")")])]),s("span",{class:"mspace",style:{"margin-right":"0.1667em"}}),s("span",{class:"mord mathbf",style:{"margin-right":"0.01597em"}},"V"),s("span",{class:"mspace",style:{"margin-right":"0.2222em"}}),s("span",{class:"mbin"},"+"),s("span",{class:"mspace",style:{"margin-right":"0.2222em"}}),s("span",{class:"mord mathnormal"},"λ"),s("span",{class:"mspace",style:{"margin-right":"0.2222em"}}),s("span",{class:"mbin"},"×"),s("span",{class:"mspace",style:{"margin-right":"0.2222em"}}),s("span",{class:"mop"},[s("span",{class:"mord mathrm"},"Softmax")]),s("span",{class:"mspace",style:{"margin-right":"0.1667em"}}),s("span",{class:"minner"},[s("span",{class:"mopen delimcenter",style:{top:"0em"}},[s("span",{class:"delimsizing size3"},"(")]),s("span",{class:"mord"},[s("span",{class:"mopen nulldelimiter"}),s("span",{class:"mfrac"},[s("span",{class:"vlist-t vlist-t2"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"1.4102em"}},[s("span",{style:{top:"-2.5335em"}},[s("span",{class:"pstrut",style:{height:"3em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mtight"},[s("span",{class:"mord sqrt mtight"},[s("span",{class:"vlist-t vlist-t2"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.9378em"}},[s("span",{class:"svg-align",style:{top:"-3em"}},[s("span",{class:"pstrut",style:{height:"3em"}}),s("span",{class:"mord mtight",style:{"padding-left":"0.833em"}},[s("span",{class:"mord mathnormal mtight"},"d")])]),s("span",{style:{top:"-2.8978em"}},[s("span",{class:"pstrut",style:{height:"3em"}}),s("span",{class:"hide-tail mtight",style:{"min-width":"0.853em",height:"1.08em"}},[s("svg",{xmlns:"http://www.w3.org/2000/svg",width:"400em",height:"1.08em",viewBox:"0 0 400000 1080",preserveAspectRatio:"xMinYMin slice"},[s("path",{d:`M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z`})])])])]),s("span",{class:"vlist-s"},"​")]),s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.1022em"}},[s("span")])])])])])])]),s("span",{style:{top:"-3.23em"}},[s("span",{class:"pstrut",style:{height:"3em"}}),s("span",{class:"frac-line",style:{"border-bottom-width":"0.04em"}})]),s("span",{style:{top:"-3.6125em"}},[s("span",{class:"pstrut",style:{height:"3em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mtight"},[s("span",{class:"mord mathbf mtight"},"Q"),s("span",{class:"minner mtight"},[s("span",{class:"minner mtight"},[s("span",{class:"mopen sizing reset-size3 size6 mtight delimcenter",style:{top:"0.075em"}},[s("span",{class:"mtight"},"(")]),s("span",{class:"mord mtight"},[s("span",{class:"mord mathbf mtight"},"K"),s("span",{class:"msupsub"},[s("span",{class:"vlist-t"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.8278em"}},[s("span",{style:{top:"-2.931em","margin-right":"0.0714em"}},[s("span",{class:"pstrut",style:{height:"2.5em"}}),s("span",{class:"sizing reset-size3 size1 mtight"},[s("span",{class:"mord mtight"},[s("span",{class:"mord mtight"},"′")])])])])])])])]),s("span",{class:"mclose sizing reset-size3 size6 mtight delimcenter",style:{top:"0.075em"}},[s("span",{class:"mtight"},")")])]),s("span",{class:"msupsub"},[s("span",{class:"vlist-t"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"1.1396em"}},[s("span",{style:{top:"-3.1436em","margin-right":"0.0714em"}},[s("span",{class:"pstrut",style:{height:"2.5em"}}),s("span",{class:"sizing reset-size3 size1 mtight"},[s("span",{class:"mord mtight"},[s("span",{class:"mord mtight"},"⊤")])])])])])])])])])])])]),s("span",{class:"vlist-s"},"​")]),s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.538em"}},[s("span")])])])]),s("span",{class:"mclose nulldelimiter"})]),s("span",{class:"mclose delimcenter",style:{top:"0em"}},[s("span",{class:"delimsizing size3"},")")])]),s("span",{class:"mspace",style:{"margin-right":"0.1667em"}}),s("span",{class:"mord"},[s("span",{class:"mord mathbf",style:{"margin-right":"0.01597em"}},"V"),s("span",{class:"msupsub"},[s("span",{class:"vlist-t"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.7519em"}},[s("span",{style:{top:"-3.063em","margin-right":"0.05em"}},[s("span",{class:"pstrut",style:{height:"2.7em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mtight"},[s("span",{class:"mord mtight"},"′")])])])])])])])])])]),s("span",{style:{top:"-2.26em"}},[s("span",{class:"pstrut",style:{height:"3.45em"}}),s("span",{class:"mord"},[s("span",{class:"mord text"},[s("span",{class:"mord"}," where ")]),s("span",{class:"mord mathbf"},"Q"),s("span",{class:"mspace",style:{"margin-right":"0.2778em"}}),s("span",{class:"mrel"},"="),s("span",{class:"mspace",style:{"margin-right":"0.2778em"}}),s("span",{class:"mord mathbf"},"Z"),s("span",{class:"mord"},[s("span",{class:"mord mathbf",style:{"margin-right":"0.01597em"}},"W"),s("span",{class:"msupsub"},[s("span",{class:"vlist-t vlist-t2"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.1514em"}},[s("span",{style:{top:"-2.55em","margin-left":"-0.016em","margin-right":"0.05em"}},[s("span",{class:"pstrut",style:{height:"2.7em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.03588em"}},"q")])])]),s("span",{class:"vlist-s"},"​")]),s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.2861em"}},[s("span")])])])])]),s("span",{class:"mpunct"},","),s("span",{class:"mspace",style:{"margin-right":"0.1667em"}}),s("span",{class:"mord mathbf"},"K"),s("span",{class:"mspace",style:{"margin-right":"0.2778em"}}),s("span",{class:"mrel"},"="),s("span",{class:"mspace",style:{"margin-right":"0.2778em"}}),s("span",{class:"mord"},[s("span",{class:"mord"},[s("span",{class:"mord"},[s("span",{class:"mord boldsymbol"},"c")])]),s("span",{class:"msupsub"},[s("span",{class:"vlist-t vlist-t2"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.2806em"}},[s("span",{style:{top:"-2.55em","margin-right":"0.05em"}},[s("span",{class:"pstrut",style:{height:"2.7em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mathnormal mtight"},"t")])])]),s("span",{class:"vlist-s"},"​")]),s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.15em"}},[s("span")])])])])]),s("span",{class:"mord"},[s("span",{class:"mord mathbf",style:{"margin-right":"0.01597em"}},"W"),s("span",{class:"msupsub"},[s("span",{class:"vlist-t vlist-t2"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.3361em"}},[s("span",{style:{top:"-2.55em","margin-left":"-0.016em","margin-right":"0.05em"}},[s("span",{class:"pstrut",style:{height:"2.7em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.03148em"}},"k")])])]),s("span",{class:"vlist-s"},"​")]),s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.15em"}},[s("span")])])])])]),s("span",{class:"mpunct"},","),s("span",{class:"mspace",style:{"margin-right":"0.1667em"}}),s("span",{class:"mord mathbf",style:{"margin-right":"0.01597em"}},"V"),s("span",{class:"mspace",style:{"margin-right":"0.2778em"}}),s("span",{class:"mrel"},"="),s("span",{class:"mspace",style:{"margin-right":"0.2778em"}}),s("span",{class:"mord"},[s("span",{class:"mord"},[s("span",{class:"mord"},[s("span",{class:"mord boldsymbol"},"c")])]),s("span",{class:"msupsub"},[s("span",{class:"vlist-t vlist-t2"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.2806em"}},[s("span",{style:{top:"-2.55em","margin-right":"0.05em"}},[s("span",{class:"pstrut",style:{height:"2.7em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mathnormal mtight"},"t")])])]),s("span",{class:"vlist-s"},"​")]),s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.15em"}},[s("span")])])])])]),s("span",{class:"mord"},[s("span",{class:"mord mathbf",style:{"margin-right":"0.01597em"}},"W"),s("span",{class:"msupsub"},[s("span",{class:"vlist-t vlist-t2"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.1514em"}},[s("span",{style:{top:"-2.55em","margin-left":"-0.016em","margin-right":"0.05em"}},[s("span",{class:"pstrut",style:{height:"2.7em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.03588em"}},"v")])])]),s("span",{class:"vlist-s"},"​")]),s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.15em"}},[s("span")])])])])]),s("span",{class:"mpunct"},","),s("span",{class:"mspace",style:{"margin-right":"0.1667em"}}),s("span",{class:"mord"},[s("span",{class:"mord mathbf"},"K"),s("span",{class:"msupsub"},[s("span",{class:"vlist-t"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.7519em"}},[s("span",{style:{top:"-3.063em","margin-right":"0.05em"}},[s("span",{class:"pstrut",style:{height:"2.7em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mtight"},[s("span",{class:"mord mtight"},"′")])])])])])])])]),s("span",{class:"mspace",style:{"margin-right":"0.2778em"}}),s("span",{class:"mrel"},"="),s("span",{class:"mspace",style:{"margin-right":"0.2778em"}}),s("span",{class:"mord"},[s("span",{class:"mord"},[s("span",{class:"mord"},[s("span",{class:"mord boldsymbol"},"c")])]),s("span",{class:"msupsub"},[s("span",{class:"vlist-t vlist-t2"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.3117em"}},[s("span",{style:{top:"-2.55em","margin-right":"0.05em"}},[s("span",{class:"pstrut",style:{height:"2.7em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mathnormal mtight"},"i")])])]),s("span",{class:"vlist-s"},"​")]),s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.15em"}},[s("span")])])])])]),s("span",{class:"mord"},[s("span",{class:"mord mathbf",style:{"margin-right":"0.01597em"}},"W"),s("span",{class:"msupsub"},[s("span",{class:"vlist-t vlist-t2"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.7519em"}},[s("span",{style:{top:"-2.4169em","margin-left":"-0.016em","margin-right":"0.05em"}},[s("span",{class:"pstrut",style:{height:"2.7em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.03148em"}},"k")])]),s("span",{style:{top:"-3.063em","margin-right":"0.05em"}},[s("span",{class:"pstrut",style:{height:"2.7em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mtight"},[s("span",{class:"mord mtight"},"′")])])])]),s("span",{class:"vlist-s"},"​")]),s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.2831em"}},[s("span")])])])])]),s("span",{class:"mpunct"},","),s("span",{class:"mspace",style:{"margin-right":"0.1667em"}}),s("span",{class:"mord"},[s("span",{class:"mord mathbf",style:{"margin-right":"0.01597em"}},"V"),s("span",{class:"msupsub"},[s("span",{class:"vlist-t"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.7519em"}},[s("span",{style:{top:"-3.063em","margin-right":"0.05em"}},[s("span",{class:"pstrut",style:{height:"2.7em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mtight"},[s("span",{class:"mord mtight"},"′")])])])])])])])]),s("span",{class:"mspace",style:{"margin-right":"0.2778em"}}),s("span",{class:"mrel"},"="),s("span",{class:"mspace",style:{"margin-right":"0.2778em"}}),s("span",{class:"mord"},[s("span",{class:"mord"},[s("span",{class:"mord"},[s("span",{class:"mord boldsymbol"},"c")])]),s("span",{class:"msupsub"},[s("span",{class:"vlist-t vlist-t2"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.3117em"}},[s("span",{style:{top:"-2.55em","margin-right":"0.05em"}},[s("span",{class:"pstrut",style:{height:"2.7em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mathnormal mtight"},"i")])])]),s("span",{class:"vlist-s"},"​")]),s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.15em"}},[s("span")])])])])]),s("span",{class:"mord"},[s("span",{class:"mord mathbf",style:{"margin-right":"0.01597em"}},"W"),s("span",{class:"msupsub"},[s("span",{class:"vlist-t vlist-t2"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.7519em"}},[s("span",{style:{top:"-2.453em","margin-left":"-0.016em","margin-right":"0.05em"}},[s("span",{class:"pstrut",style:{height:"2.7em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.03588em"}},"v")])]),s("span",{style:{top:"-3.063em","margin-right":"0.05em"}},[s("span",{class:"pstrut",style:{height:"2.7em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mtight"},[s("span",{class:"mord mtight"},"′")])])])]),s("span",{class:"vlist-s"},"​")]),s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.247em"}},[s("span")])])])])])])])]),s("span",{class:"vlist-s"},"​")]),s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"1.55em"}},[s("span")])])])]),s("span",{class:"arraycolsep",style:{width:"0.5em"}})])])])])])])],-1),k=s("p",null,[a("其中， "),s("span",{class:"katex"},[s("span",{class:"katex-mathml"},[s("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[s("semantics",null,[s("mrow",null,[s("msub",null,[s("mi",null,"c"),s("mi",null,"i")])]),s("annotation",{encoding:"application/x-tex"},"c_i")])])]),s("span",{class:"katex-html","aria-hidden":"true"},[s("span",{class:"base"},[s("span",{class:"strut",style:{height:"0.5806em","vertical-align":"-0.15em"}}),s("span",{class:"mord"},[s("span",{class:"mord mathnormal"},"c"),s("span",{class:"msupsub"},[s("span",{class:"vlist-t vlist-t2"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.3117em"}},[s("span",{style:{top:"-2.55em","margin-left":"0em","margin-right":"0.05em"}},[s("span",{class:"pstrut",style:{height:"2.7em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mathnormal mtight"},"i")])])]),s("span",{class:"vlist-s"},"​")]),s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.15em"}},[s("span")])])])])])])])]),a(" 为使用 CLIP 对 IP-Adapter 对应参考图形进行编码，并处理后得到的 "),s("code",null,"hidden_state"),a("。 "),s("strong",null,[a("因此，原先的 SD img2img 是将图片作为 "),s("code",null,"latent"),a(" （initial latent）传入 SD，但 IP-Adapter 中传入的 latent 与 txt2img 一样是随机的。")])],-1),M=t(`<p>参考 IP-Adapter 官方的核心代码：</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> encoder_hidden_states </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">None</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    encoder_hidden_states </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> hidden_states</span></span>
<span class="line"><span style="color:#D73A49;">else</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># get encoder_hidden_states, ip_hidden_states</span></span>
<span class="line"><span style="color:#24292E;">    end_pos </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> encoder_hidden_states.shape[</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.num_tokens</span></span>
<span class="line"><span style="color:#24292E;">    encoder_hidden_states, ip_hidden_states </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (</span></span>
<span class="line"><span style="color:#24292E;">        encoder_hidden_states[:, :end_pos, :],</span></span>
<span class="line"><span style="color:#24292E;">        encoder_hidden_states[:, end_pos:, :],</span></span>
<span class="line"><span style="color:#24292E;">    )</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> attn.norm_cross:</span></span>
<span class="line"><span style="color:#24292E;">        encoder_hidden_states </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> attn.norm_encoder_hidden_states(encoder_hidden_states)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">key </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> attn.to_k(encoder_hidden_states)</span></span>
<span class="line"><span style="color:#24292E;">value </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> attn.to_v(encoder_hidden_states)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">inner_dim </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> key.shape[</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">head_dim </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> inner_dim </span><span style="color:#D73A49;">//</span><span style="color:#24292E;"> attn.heads</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">query </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> query.view(batch_size, </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, attn.heads, head_dim).transpose(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">key </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> key.view(batch_size, </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, attn.heads, head_dim).transpose(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">value </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> value.view(batch_size, </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, attn.heads, head_dim).transpose(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># the output of sdp = (batch, num_heads, seq_len, head_dim)</span></span>
<span class="line"><span style="color:#24292E;">hidden_states </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> F.scaled_dot_product_attention(</span></span>
<span class="line"><span style="color:#24292E;">    query, key, value, </span><span style="color:#E36209;">attn_mask</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">attention_mask, </span><span style="color:#E36209;">dropout_p</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0.0</span><span style="color:#24292E;">, </span><span style="color:#E36209;">is_causal</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">False</span></span>
<span class="line"><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">hidden_states </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> hidden_states.transpose(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">).reshape(batch_size, </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, attn.heads </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> head_dim)</span></span>
<span class="line"><span style="color:#24292E;">hidden_states </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> hidden_states.to(query.dtype)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># for ip-adapter</span></span>
<span class="line"><span style="color:#24292E;">ip_key </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.to_k_ip(ip_hidden_states)</span></span>
<span class="line"><span style="color:#24292E;">ip_value </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.to_v_ip(ip_hidden_states)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">ip_key </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> ip_key.view(batch_size, </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, attn.heads, head_dim).transpose(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">ip_value </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> ip_value.view(batch_size, </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, attn.heads, head_dim).transpose(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># the output of sdp = (batch, num_heads, seq_len, head_dim)</span></span>
<span class="line"><span style="color:#24292E;">ip_hidden_states </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> F.scaled_dot_product_attention(</span></span>
<span class="line"><span style="color:#24292E;">    query, ip_key, ip_value, </span><span style="color:#E36209;">attn_mask</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">None</span><span style="color:#24292E;">, </span><span style="color:#E36209;">dropout_p</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0.0</span><span style="color:#24292E;">, </span><span style="color:#E36209;">is_causal</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">False</span></span>
<span class="line"><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">ip_hidden_states </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> ip_hidden_states.transpose(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">).reshape(batch_size, </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, attn.heads </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> head_dim)</span></span>
<span class="line"><span style="color:#24292E;">ip_hidden_states </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> ip_hidden_states.to(query.dtype)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">hidden_states </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> hidden_states </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.scale </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> ip_hidden_states</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在训练期间，只对 IP-Adapter 相关的参数进行训练，使用 image-text 数据进行训练，训练优化对象与原先的 SD 一致。</p><p>在 IP-Adapter 的实验中，论文对 SD 模型中的所有 cross-attention 都加入了 IP-Adapter 相关参数进行调整，整个 IP-Adapter 一共约 22M 可训练参数。文中采用 8 卡 V100 训练了 1M 个 steps，每张卡 batch size 为 8（用 DeepSpeed Zero-2）。根据官方给出的参考图片看来，IP-Adapter 的效果挺不错。</p><figure><img src="https://pic4.zhimg.com/80/v2-884088aac7c63da8a75c1342fb602b2f_1440w.webp" alt="image-20231229224857119" tabindex="0" loading="lazy"><figcaption>image-20231229224857119</figcaption></figure>`,5),I={href:"https://huggingface.co/laion/CLIP-ViT-H-14-laion2B-s32B-b79K",target:"_blank",rel:"noopener noreferrer"},V={href:"https://huggingface.co/laion/CLIP-ViT-bigG-14-laion2B-39B-b160k",target:"_blank",rel:"noopener noreferrer"},P=s("p",null,"此外，由于每一层 cross attention 都有额外的 IP-Adapter 权重，因此可以调整要在什么阶段加入 IP-Adapter 额外注意力，这有利于控制。",-1),q=s("h3",{id:"官方示例",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#官方示例","aria-hidden":"true"},"#"),a(" 官方示例")],-1),L={href:"https://github.com/tencent-ailab/IP-Adapter/blob/main/ip_adapter-full-face_demo.ipynb",target:"_blank",rel:"noopener noreferrer"},Q=s("h2",{id:"t2i-adapter",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#t2i-adapter","aria-hidden":"true"},"#"),a(" T2I Adapter")],-1),W={href:"https://arxiv.org/abs/2302.08453",target:"_blank",rel:"noopener noreferrer"},K=t('<p>与 control net 相似的，用于控制图片生成的模型，大概思路为：</p><figure><img src="https://pic3.zhimg.com/80/v2-435c3120ee581e10074949e016a03eae_1440w.webp" alt="image-20231231215356205" tabindex="0" loading="lazy"><figcaption>image-20231231215356205</figcaption></figure><p>参考以上官方给的图片，我们可以看出 T2I Adapter 和 controlnet 的相似与不同。</p><p>相同点：</p><ol><li>每张条件图片都会别额外编码，编码信息会被加入到图像生成中。</li><li>可以通过 opse，depth，canny 等进行控制。</li><li>可以使用多张图片，进行多维度的控制。</li><li>训练时候，冻结了原先的 unet，只对 Adapter 部分进行微调。</li></ol><p>主要不同点：</p><ol><li>controlnet 的 encoder 架构普遍比 T2I 大很多，毕竟 controlnet 是直接复制 encoder 部分，但 T2I 并非复制的 encoder 部分。</li><li>T2I 将图片编码之后，加在了 U-NET 的 encoder 部分。controlnet 是再 decoder 部分进行相加处理的。</li></ol><h2 id="参考" tabindex="-1"><a class="header-anchor" href="#参考" aria-hidden="true">#</a> 参考</h2><p>代码：https://github.com/tencent-ailab/IP-Adapter</p>',9),T={href:"https://arxiv.org/abs/2308.06721",target:"_blank",rel:"noopener noreferrer"},S=s("p",null,"https://ip-adapter.github.io/",-1);function Z(B,N){const l=p("ExternalLinkIcon");return i(),m("div",null,[r,o,h,d,g,s("p",null,[a("而后再 UNET 的 "),y,a(" 当中。每个 "),s("a",u,[a("Transformer2DModel"),n(l)]),a(" 先对输入的图像数据进行预处理，将图片格式从如 "),v,a(" 或 "),b,a(" 转换为 "),_,a("，而后将 "),f,a(" 传入 1 层传统 Transformer layer（非 bert 或 GPT 类型），先对图像 "),z,a(" 进行 self-attention，而后结合文本编码 "),E,a(" 进行 cross attention 处理：")]),x,w,A,C,D,k,M,s("p",null,[a("IP-Adapter 中，图片编码器采用了 "),s("a",I,[a("OpenCLIP-ViT-H-14"),n(l)]),a(" ，其作者表示，这个编码器效果和 "),s("a",V,[a("OpenCLIP-ViT-bigG-14"),n(l)]),a(" 差不多，但是参数量小了很多。")]),P,q,s("p",null,[a("换脸：除了 Lora 微调，face fusion 等技术外，IP-Adapter 也可以实现克隆人脸，参考官方提供的 "),s("a",L,[a("ip_adapter-full-face"),n(l)]),a(" 效果还不错。")]),Q,s("p",null,[a("参考文章 "),s("a",W,[a("T2I-Adapter: Learning Adapters to Dig out More Controllable Ability for Text-to-Image Diffusion Models"),n(l)])]),K,s("p",null,[a("论文："),s("a",T,[a("IP-Adapter: Text Compatible Image Prompt Adapter for Text-to-Image Diffusion Models"),n(l)])]),S])}const G=e(c,[["render",Z],["__file","笔记ipadapter.html.vue"]]);export{G as default};
