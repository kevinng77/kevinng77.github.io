import{_ as p}from"./plugin-vue_export-helper-c27b6911.js";import{r as o,o as c,c as r,a as s,d as l,b as n,f as e}from"./app-cce74234.js";const i={},t=s("h2",{id:"nginx-目的",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#nginx-目的","aria-hidden":"true"},"#"),n(" Nginx 目的")],-1),y=s("p",null,"在客户端和服务器之间加入管理层，实现用户访问同一地址，但能在不同服务器地址上操作。session 共享的话还是需要使用 redis 等来实现。",-1),d=s("h2",{id:"nginx",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#nginx","aria-hidden":"true"},"#"),n(" Nginx")],-1),v=s("p",null,"官方数据测试表明能够支持高达 50,000 个并发连接数的响应。平时一个 Nginx 可能就能满足小规模的业务需求。",-1),u=s("p",null,"Nginx 可以用来做很多事情：",-1),E=s("ul",null,[s("li",null,"Http 代理，反向代理"),s("li",null,"负载均衡：Nginx 提供的负载均衡策略有 2 种：内置策略和扩展策略。内置策略为轮询，加权轮询，Ip hash。扩展策略，就天马行空，只有你想不到的没有他做不到的啦，你可以参照所有的负载均衡算法，给他一一找出来做下实现。")],-1),m={href:"https://camo.githubusercontent.com/d13d6330de88bf9f549b8086be9a91cea00a0fba6093cb690afcb4b49b8834d0/68747470733a2f2f7777772e72756e6f6f622e636f6d2f77702d636f6e74656e742f75706c6f6164732f323031382f30382f313533353732353037382d383330332d32303136303230323133333735333338322d313836333635373234322e6a7067",target:"_blank",rel:"noopener noreferrer"},b=s("img",{src:"https://camo.githubusercontent.com/d13d6330de88bf9f549b8086be9a91cea00a0fba6093cb690afcb4b49b8834d0/68747470733a2f2f7777772e72756e6f6f622e636f6d2f77702d636f6e74656e742f75706c6f6164732f323031382f30382f313533353732353037382d383330332d32303136303230323133333735333338322d313836333635373234322e6a7067",alt:"img",tabindex:"0",loading:"lazy"},null,-1),D=s("figcaption",null,"img",-1),A={href:"https://www.liaoxuefeng.com/article/990311924891552",target:"_blank",rel:"noopener noreferrer"},_=s("li",null,"一组 host：nginx 配置更简单；",-1),h=s("li",null,"限流：nginx 配置更简单；",-1),x=s("li",null,"限 ip：nginx 配置更简单；",-1),g=s("li",null,"静态文件：nginx 可缓存；",-1),f=s("li",null,"http2：nginx 支持，内部转 http1.x 到 tomcat；",-1),C=s("li",null,"http3：nginx 支持，内部转 http1.x 到 tomcat；",-1),F=s("li",null,"临时重定向 url：nginx 改配置 reload 不重启；",-1),S=s("li",null,"遇到 500 错误：nginx 可重试；",-1),k=s("li",null,"很多 cors、自定义 header 配置、[http://www.example.com 转 http://example.com 放 nginx 不用改 java 应用。](http://www.example.xn--comhttp-c72v//example.com 放 nginx 不用改 java 应用。)",-1),w=e(`<p>核心思想是利用 nginx 强大的配置能力，避免改配置反复部署 ja 应用。</p><h2 id="nginx-的安装" tabindex="-1"><a class="header-anchor" href="#nginx-的安装" aria-hidden="true">#</a> Nginx 的安装</h2><p>可以直接用 docker 进行配置：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6F42C1;">docker</span><span style="color:#24292E;"> </span><span style="color:#032F62;">run</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--rm</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-d</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--name</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nginx</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">--net</span><span style="color:#24292E;"> </span><span style="color:#032F62;">host</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">-v</span><span style="color:#24292E;"> </span><span style="color:#032F62;">./log:/var/log/nginx</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">-v</span><span style="color:#24292E;"> </span><span style="color:#032F62;">./nginx.conf:/etc/nginx/nginx.conf:ro</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">nginx</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="nginx-配置示例" tabindex="-1"><a class="header-anchor" href="#nginx-配置示例" aria-hidden="true">#</a> Nginx 配置示例</h2><div class="language-nginx line-numbers-mode" data-ext="nginx"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6A737D;">########### 每个指令必须有分号结束。#################</span></span>
<span class="line"><span style="color:#6A737D;">#user administrator administrators;  #配置用户或者组，默认为 nobody nobody。</span></span>
<span class="line"><span style="color:#6A737D;">#worker_processes 2;  #允许生成的进程数，默认为 1</span></span>
<span class="line"><span style="color:#6A737D;">#pid /nginx/pid/nginx.pid;   #指定 nginx 进程运行文件存放地址</span></span>
<span class="line"><span style="color:#D73A49;">error_log </span><span style="color:#24292E;">log/error.log</span><span style="color:#005CC5;"> debug</span><span style="color:#24292E;">;  </span><span style="color:#6A737D;">#制定日志路径，级别。这个设置可以放入全局块，http 块，server 块，级别以此为：debug|info|notice|warn|error|crit|alert|emerg</span></span>
<span class="line"><span style="color:#D73A49;">events</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> accept_mutex </span><span style="color:#24292E;">on;   </span><span style="color:#6A737D;">#设置网路连接序列化，防止惊群现象发生，默认为 on</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> multi_accept </span><span style="color:#24292E;">on;  </span><span style="color:#6A737D;">#设置一个进程是否同时接受多个网络连接，默认为 off</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">#use epoll;      #事件驱动模型，select|poll|kqueue|epoll|resig|/dev/poll|eventport</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> worker_connections </span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1024</span><span style="color:#24292E;">;    </span><span style="color:#6A737D;">#最大连接数，默认为 512</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"><span style="color:#D73A49;">http</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> include </span><span style="color:#24292E;">      mime.types;   </span><span style="color:#6A737D;">#文件扩展名与文件类型映射表</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> default_type </span><span style="color:#24292E;"> application/octet-stream; </span><span style="color:#6A737D;">#默认文件类型，默认为 text/plain</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">#access_log off; #取消服务日志    </span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> log_format </span><span style="color:#24292E;">myFormat </span><span style="color:#032F62;">&#39;$</span><span style="color:#24292E;">remote_addr</span><span style="color:#032F62;">–$</span><span style="color:#24292E;">remote_user</span><span style="color:#032F62;"> [$</span><span style="color:#24292E;">time_local</span><span style="color:#032F62;">] $</span><span style="color:#24292E;">request</span><span style="color:#032F62;"> $</span><span style="color:#24292E;">status</span><span style="color:#032F62;"> $</span><span style="color:#24292E;">body_bytes_sent</span><span style="color:#032F62;"> $</span><span style="color:#24292E;">http_referer</span><span style="color:#032F62;"> $</span><span style="color:#24292E;">http_user_agent</span><span style="color:#032F62;"> $</span><span style="color:#24292E;">http_x_forwarded_for</span><span style="color:#032F62;">&#39;</span><span style="color:#24292E;">; </span><span style="color:#6A737D;">#自定义格式</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> access_log </span><span style="color:#24292E;">log/access.log myFormat;  </span><span style="color:#6A737D;">#combined 为日志格式的默认值</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> sendfile </span><span style="color:#24292E;">on;   </span><span style="color:#6A737D;">#允许 sendfile 方式传输文件，默认为 off，可以在 http 块，server 块，location 块。</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> sendfile_max_chunk </span><span style="color:#24292E;">100k;  </span><span style="color:#6A737D;">#每个进程每次调用传输数量不能大于设定的值，默认为 0，即不设上限。</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> keepalive_timeout </span><span style="color:#24292E;">65;  </span><span style="color:#6A737D;">#连接超时时间，默认为 75s，可以在 http，server，location 块。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">upstream</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">mysvr </span><span style="color:#24292E;">{   </span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">server</span><span style="color:#24292E;"> 127.0.0.1:7878;</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">server</span><span style="color:#24292E;"> 192.168.10.121:3333 backup;  </span><span style="color:#6A737D;">#热备</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> error_page </span><span style="color:#24292E;">404 https://www.baidu.com; </span><span style="color:#6A737D;">#错误页</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">server</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#D73A49;"> keepalive_requests </span><span style="color:#24292E;">120; </span><span style="color:#6A737D;">#单连接请求上限次数。</span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#D73A49;"> listen </span><span style="color:#24292E;">      </span><span style="color:#005CC5;">4545</span><span style="color:#24292E;">;   </span><span style="color:#6A737D;">#监听端口</span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#D73A49;"> server_name </span><span style="color:#24292E;"> </span><span style="color:#005CC5;">127.0.0.1</span><span style="color:#24292E;">;   </span><span style="color:#6A737D;">#监听地址       </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">location</span><span style="color:#24292E;">  </span><span style="color:#6F42C1;">~*^.+$ </span><span style="color:#24292E;">{       </span><span style="color:#6A737D;">#请求的 url 过滤，正则匹配，~为区分大小写，~*为不区分大小写。</span></span>
<span class="line"><span style="color:#24292E;">           </span><span style="color:#6A737D;">#root path;  #根目录</span></span>
<span class="line"><span style="color:#24292E;">           </span><span style="color:#6A737D;">#index vv.txt;  #设置默认页</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#D73A49;"> proxy_pass </span><span style="color:#24292E;"> http://mysvr;  </span><span style="color:#6A737D;">#请求转向 mysvr 定义的服务器列表</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#D73A49;"> deny </span><span style="color:#24292E;">127.0.0.1;  </span><span style="color:#6A737D;">#拒绝的 ip</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#D73A49;"> allow </span><span style="color:#24292E;">172.18.5.54; </span><span style="color:#6A737D;">#允许的 ip           </span></span>
<span class="line"><span style="color:#24292E;">        } </span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><details class="hint-container details"><summary>示例配置 2</summary><div class="language-nginx line-numbers-mode" data-ext="nginx"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># 全局参数</span></span>
<span class="line"><span style="color:#D73A49;">user </span><span style="color:#24292E;">nginx;              </span><span style="color:#6A737D;"># Nginx 进程运行用户</span></span>
<span class="line"><span style="color:#D73A49;">worker_processes </span><span style="color:#24292E;">auto;   </span><span style="color:#6A737D;"># Nginx 工作进程数，通常设置为 CPU 核数</span></span>
<span class="line"><span style="color:#D73A49;">error_log </span><span style="color:#24292E;">/var/log/nginx/error.log</span><span style="color:#005CC5;"> warn</span><span style="color:#24292E;">;    </span><span style="color:#6A737D;"># 错误日志路径和日志级别</span></span>
<span class="line"><span style="color:#D73A49;">pid </span><span style="color:#24292E;">/run/nginx.pid;      </span><span style="color:#6A737D;"># 进程 PID 保存路径</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 定义事件模块</span></span>
<span class="line"><span style="color:#D73A49;">events</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> worker_connections </span><span style="color:#24292E;">1024;    </span><span style="color:#6A737D;"># 每个工作进程最大并发连接数</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> use </span><span style="color:#24292E;">epoll;                  </span><span style="color:#6A737D;"># 使用 epoll 网络模型，提高性能</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> multi_accept </span><span style="color:#24292E;">on;            </span><span style="color:#6A737D;"># 开启支持多个连接同时建立</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 定义 HTTP 服务器模块</span></span>
<span class="line"><span style="color:#D73A49;">http</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># 缓存文件目录</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> client_body_temp_path </span><span style="color:#24292E;">/var/cache/nginx/client_temp;</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> proxy_temp_path </span><span style="color:#24292E;">/var/cache/nginx/proxy_temp;</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> fastcgi_temp_path </span><span style="color:#24292E;">/var/cache/nginx/fastcgi_temp;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># 定义日志格式，main 是默认的日志格式</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> log_format </span><span style="color:#24292E;">main </span><span style="color:#032F62;">&#39;$</span><span style="color:#24292E;">remote_addr</span><span style="color:#032F62;"> - $</span><span style="color:#24292E;">remote_user</span><span style="color:#032F62;"> [$</span><span style="color:#24292E;">time_local</span><span style="color:#032F62;">] &quot;$</span><span style="color:#24292E;">request</span><span style="color:#032F62;">&quot; &#39;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#032F62;">&#39;$</span><span style="color:#24292E;">status</span><span style="color:#032F62;"> $</span><span style="color:#24292E;">body_bytes_sent</span><span style="color:#032F62;"> &quot;$</span><span style="color:#24292E;">http_referer</span><span style="color:#032F62;">&quot; &#39;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#032F62;">&#39;&quot;$</span><span style="color:#24292E;">http_user_agent</span><span style="color:#032F62;">&quot; &quot;$</span><span style="color:#24292E;">http_x_forwarded_for</span><span style="color:#032F62;">&quot;&#39;</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># 默认访问日志保存路径和格式</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> access_log </span><span style="color:#24292E;">/var/log/nginx/access.log</span><span style="color:#005CC5;"> main</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># 定义 MIME 类型</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> include </span><span style="color:#24292E;">/etc/nginx/mime.types;</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> default_type </span><span style="color:#24292E;">application/octet-stream;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># 代理参数</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> proxy_connect_timeout </span><span style="color:#24292E;">6s;       </span><span style="color:#6A737D;"># 连接超时时间</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> proxy_send_timeout </span><span style="color:#24292E;">10s;         </span><span style="color:#6A737D;"># 发送超时时间</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> proxy_read_timeout </span><span style="color:#24292E;">10s;         </span><span style="color:#6A737D;"># 接收超时时间</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> proxy_buffer_size </span><span style="color:#24292E;">16k;          </span><span style="color:#6A737D;"># 缓冲区大小</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> proxy_buffers </span><span style="color:#24292E;">4 </span><span style="color:#005CC5;">32k</span><span style="color:#24292E;">;            </span><span style="color:#6A737D;"># 缓冲区个数和大小</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> proxy_busy_buffers_size </span><span style="color:#24292E;">64k;    </span><span style="color:#6A737D;"># 忙碌缓冲区大小</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> proxy_temp_file_write_size </span><span style="color:#24292E;">64k; </span><span style="color:#6A737D;"># 代理临时文件写入大小</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># 启用压缩，可以提高网站访问速度</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> gzip </span><span style="color:#24292E;">on;</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> gzip_min_length </span><span style="color:#24292E;">1k;                    </span><span style="color:#6A737D;"># 最小压缩文件大小</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> gzip_types </span><span style="color:#24292E;">text/plain text/css application/json application/javascript application/xml;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># 定义 HTTP 服务器</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">server</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#D73A49;"> listen </span><span style="color:#24292E;">80;              </span><span style="color:#6A737D;"># 监听端口</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#D73A49;"> server_name </span><span style="color:#24292E;">example.com;    </span><span style="color:#6A737D;"># 域名</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;"># 重定向到 HTTPS，强制使用 HTTPS 访问</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ($scheme </span><span style="color:#D73A49;">!= </span><span style="color:#032F62;">&quot;https&quot;</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">301</span><span style="color:#24292E;"> https://$server_name$request_uri;</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;"># HTTPS 服务器配置</span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#D73A49;"> ssl_certificate </span><span style="color:#24292E;">     /etc/nginx/ssl/server.crt;    </span><span style="color:#6A737D;"># SSL 证书路径</span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#D73A49;"> ssl_certificate_key </span><span style="color:#24292E;"> /etc/nginx/ssl/server.key;    </span><span style="color:#6A737D;"># SSL 私钥路径</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;"># SSL 会话缓存参数</span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#D73A49;"> ssl_session_cache </span><span style="color:#24292E;">shared:SSL:10m;</span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#D73A49;"> ssl_session_timeout </span><span style="color:#24292E;">10m;</span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#D73A49;"> ssl_protocols </span><span style="color:#24292E;">TLSv1 TLSv1.1 TLSv1.2;</span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#D73A49;"> ssl_prefer_server_ciphers </span><span style="color:#24292E;">on;</span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#D73A49;"> ssl_ciphers </span><span style="color:#24292E;">ECDH+AESGCM:ECDH+AES256:ECDH+AES128:DH+3DES:!ADH:!AECDH:!MD5;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;"># 配置代理路径</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">location</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">/ </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">           </span><span style="color:#D73A49;"> proxy_pass </span><span style="color:#24292E;">http://localhost:8080;        </span><span style="color:#6A737D;"># 转发请求的目标地址</span></span>
<span class="line"><span style="color:#24292E;">           </span><span style="color:#D73A49;"> proxy_set_header </span><span style="color:#24292E;">Host $host;             </span><span style="color:#6A737D;"># 设置请求头中的 Host 字段</span></span>
<span class="line"><span style="color:#24292E;">           </span><span style="color:#D73A49;"> proxy_set_header </span><span style="color:#24292E;">X-Forwarded-For $proxy_add_x_forwarded_for;</span></span>
<span class="line"><span style="color:#24292E;">                            </span><span style="color:#6A737D;"># 设置 HTTP 头中的 X-Forwarded-For 字段，表示客户端真实 IP，多个 IP 用逗号隔开</span></span>
<span class="line"><span style="color:#24292E;">           </span><span style="color:#D73A49;"> proxy_set_header </span><span style="color:#24292E;">X-Real-IP $remote_addr; </span><span style="color:#6A737D;"># 设置请求头中的 X-Real-IP 字段，表示客户端真实 IP</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;"># 配置静态文件访问路径</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">location</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">/static/ </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">           </span><span style="color:#D73A49;"> alias </span><span style="color:#24292E;">/path/to/static/files/;   </span><span style="color:#6A737D;"># 静态文件的目录</span></span>
<span class="line"><span style="color:#24292E;">           </span><span style="color:#D73A49;"> expires </span><span style="color:#24292E;">7d;                     </span><span style="color:#6A737D;"># 静态文件缓存时间</span></span>
<span class="line"><span style="color:#24292E;">           </span><span style="color:#D73A49;"> add_header </span><span style="color:#24292E;">Pragma public;       </span><span style="color:#6A737D;"># 添加 HTTP 响应头</span></span>
<span class="line"><span style="color:#24292E;">           </span><span style="color:#D73A49;"> add_header </span><span style="color:#24292E;">Cache-Control </span><span style="color:#032F62;">&quot;public, must-revalidate, proxy-revalidate&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;"># 配置错误页面</span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#D73A49;"> error_page </span><span style="color:#24292E;">404 /404.html;           </span><span style="color:#6A737D;"># 404 错误页</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">location</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/404.html </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">internal</span><span style="color:#24292E;">;                       </span><span style="color:#6A737D;"># 不接受外部访问</span></span>
<span class="line"><span style="color:#24292E;">           </span><span style="color:#D73A49;"> root </span><span style="color:#24292E;">/usr/share/nginx/html;     </span><span style="color:#6A737D;"># 404 错误页文件所在目录</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;"># 配置重定向</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">location</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">/old/ </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">rewrite</span><span style="color:#24292E;"> </span><span style="color:#032F62;">^/old/([^/]+) /new/$</span><span style="color:#24292E;">1 </span><span style="color:#D73A49;">permanent</span><span style="color:#24292E;">;   </span><span style="color:#6A737D;"># 将/old/xxx 路径重定向为/new/xxx，返回 301 状态码</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># 其他服务配置</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># server {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">#     ...</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># 配置 TCP 负载均衡</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">upstream</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">backends </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">server</span><span style="color:#24292E;"> backend1.example.com:8080 </span><span style="color:#E36209;">weight</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">5</span><span style="color:#24292E;">;  </span><span style="color:#6A737D;"># 后端服务器地址和权重</span></span>
<span class="line"><span style="color:#24292E;">        server backend2.example.com:8080;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">server</span><span style="color:#24292E;"> backend3.example.com:8080 backup;   </span><span style="color:#6A737D;"># 备用服务器</span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#D73A49;"> keepalive </span><span style="color:#24292E;">16;                               </span><span style="color:#6A737D;"># 连接池大小</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">server</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#D73A49;"> listen </span><span style="color:#24292E;">80;</span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#D73A49;"> server_name </span><span style="color:#24292E;">example.com;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">location</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">/ </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">           </span><span style="color:#D73A49;"> proxy_pass </span><span style="color:#24292E;">http://backends;             </span><span style="color:#6A737D;"># 负载均衡转发请求的目标地址</span></span>
<span class="line"><span style="color:#24292E;">           </span><span style="color:#D73A49;"> proxy_set_header </span><span style="color:#24292E;">Host $host;            </span><span style="color:#6A737D;"># 设置请求头中的 Host 字段</span></span>
<span class="line"><span style="color:#24292E;">           </span><span style="color:#D73A49;"> proxy_set_header </span><span style="color:#24292E;">X-Real-IP $remote_addr; </span><span style="color:#6A737D;"># 设置请求头中的 X-Real-IP 字段，表示客户端真实 IP</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details><h3 id="nginx-https-配置" tabindex="-1"><a class="header-anchor" href="#nginx-https-配置" aria-hidden="true">#</a> Nginx HTTPS 配置</h3><h3 id="let-s-encrypt-免费-ssl" tabindex="-1"><a class="header-anchor" href="#let-s-encrypt-免费-ssl" aria-hidden="true">#</a> Let&#39;s Encrypt 免费 SSL</h3><p>Let&#39;s Encrypt 是一个由权威机构设置的计划，为网站用户提供免费的 SSL 证书。Let&#39;s Encrypt 证书是由非营利组织 Electronic Frontier Foundation（EFF）以及 Mozilla、Akamai、Cisco、IETF 等企业和组织提供支持，同时它也依托了 Linux 社区的合作。用户可以使用任何采用 Let&#39;s Encrypt 证书的网站而无需支付任何费用。Let&#39;s Encrypt 发行的数字证书有“DV SSL”和“OV SSL”两种类型。</p>`,10),L={href:"https://certbot.eff.org/instructions?ws=nginx&os=centosrhel8",target:"_blank",rel:"noopener noreferrer"},$=e(`<p>或者可以使用 https://github.com/kevinng77/nginx-certbot/tree/master 一键部署。</p><p>配置 <code>app.conf</code> 文件：</p><div class="language-nginx line-numbers-mode" data-ext="nginx"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#D73A49;">server</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> listen </span><span style="color:#24292E;">80;</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> server_name </span><span style="color:#24292E;">wujiawen.xyz;</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> server_tokens </span><span style="color:#24292E;">off;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">location</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">/.well-known/acme-challenge/ </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#D73A49;"> root </span><span style="color:#24292E;">/var/www/certbot;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">location</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">/ </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">301</span><span style="color:#24292E;"> https://$host$request_uri;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">server</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> listen </span><span style="color:#24292E;">443 ssl;</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> server_name </span><span style="color:#24292E;">wujiawen.xyz;</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> server_tokens </span><span style="color:#24292E;">off;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> ssl_certificate </span><span style="color:#24292E;">/etc/letsencrypt/live/wujiawen.xyz/fullchain.pem;</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> ssl_certificate_key </span><span style="color:#24292E;">/etc/letsencrypt/live/wujiawen.xyz/privkey.pem;</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> include </span><span style="color:#24292E;">/etc/letsencrypt/options-ssl-nginx.conf;</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> ssl_dhparam </span><span style="color:#24292E;">/etc/letsencrypt/ssl-dhparams.pem;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">location</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">/ </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#D73A49;"> root </span><span style="color:#24292E;">/home/blog;</span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#D73A49;"> index </span><span style="color:#24292E;"> index.html index.htm;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后启动服务：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6F42C1;">docker</span><span style="color:#24292E;"> </span><span style="color:#032F62;">compose</span><span style="color:#24292E;"> </span><span style="color:#032F62;">up</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-d</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div>`,5),T={href:"https://pentacent.medium.com/nginx-and-lets-encrypt-with-docker-in-less-than-5-minutes-b4b8a60d3a71",target:"_blank",rel:"noopener noreferrer"},P=s("h3",{id:"其他免费-ssl-证书",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#其他免费-ssl-证书","aria-hidden":"true"},"#"),n(" 其他免费 ssl 证书")],-1),H=s("p",null,"Cloudflare",-1),q=s("p",null,"Cloudflare 是另一个可提供免费 SSL 证书的公司，他们是一家全球性的提供缓存和 DNS 技术的公司。Cloudflare 提供的 SSL 证书包括“Flexible SSL”、“Full SSL”、“Full SSL Strict”三种类型。CloudFlare 还提供“Always Use HTTPS”选项，将网站访问升级到 HTTPS。",-1),N=s("p",null,"SSLForFree",-1),I=s("p",null,"SSLForFree 是一个提供免费 SSL 证书的网站。用户可以在这里获取有效的数字证书。“SSLForFree”支持 RapidSSL, GeoTrust 和 Comodo 域名验证证书，用户只需要验证域名所有权，即可获得 SSL 证书的使用权。",-1),z=s("h2",{id:"资料",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#资料","aria-hidden":"true"},"#"),n(" 资料")],-1),j={href:"https://www.nginx-cn.net/",target:"_blank",rel:"noopener noreferrer"};function V(X,M){const a=o("ExternalLinkIcon");return c(),r("div",null,[t,y,d,v,u,E,s("figure",null,[s("a",m,[b,l(a)]),D]),s("ul",null,[s("li",null,[n("https 证书：nginx 配置更简单（"),s("a",A,[n("SSL 证书配置"),l(a)]),n("）；")]),_,h,x,g,f,C,F,S,k]),w,s("p",null,[n("如果可以通过命令行方式，以 root 权限进入你的服务器时，推荐使用功能 "),s("a",L,[n("certbot"),l(a)]),n("。根据官方指南操作即可。")]),$,s("p",null,[s("a",T,[n("参考文章"),l(a)])]),P,H,q,N,I,z,s("p",null,[s("a",j,[n("nginx 中文指南"),l(a)])])])}const G=p(i,[["render",V],["__file","笔记nginx.html.vue"]]);export{G as default};
