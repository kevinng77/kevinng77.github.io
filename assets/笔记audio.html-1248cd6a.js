import{_ as l}from"./plugin-vue_export-helper-c27b6911.js";import{o as p,c as e,f as a,a as s,b as n}from"./app-61501907.js";const o={},t=a('<h2 id="音频格式与编码" tabindex="-1"><a class="header-anchor" href="#音频格式与编码" aria-hidden="true">#</a> 音频格式与编码</h2><ol><li>声音是什么？</li></ol><ul><li><strong>物理层面</strong> ：空气分子的振动 → 声压随时间变化的波。</li><li><strong>模拟信号</strong> ：连续的波形，既有时间连续性，也有幅度连续性。</li></ul><blockquote><p>但计算机只能处理离散的数字，所以要“采样 + 量化”成数字信号。</p></blockquote><hr><ol start="2"><li>采样与量化（数字化的第一步）</li></ol><p>声音本质：连续的模拟信号</p><ul><li>人的讲话、音乐等都是空气压力随时间 <strong>连续变化</strong> 的波。</li><li>这是一条模拟信号曲线（time-continuous, amplitude-continuous）。</li></ul><p>麦克风：声波 → 电压信号</p><ul><li>麦克风膜片随声压振动，把空气压力变化转成 <strong>电压变化</strong> 。</li><li>电压信号依然是 <strong>连续的模拟信号</strong> ，例如 0.1V → 0.15V → 0.2V …。</li></ul><p>采样（Sampling）：时间离散化</p>',11),r=s("ul",null,[s("li",null,[n("使用模数转换器（ADC, Analog-to-Digital Converter）， "),s("strong",null,"定时读取电压的瞬时值"),n(" 。")]),s("li",null,[s("strong",null,[n("采样频率（Sampling rate, "),s("span",{class:"katex"},[s("span",{class:"katex-mathml"},[s("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[s("semantics",null,[s("mrow",null,[s("msub",null,[s("mi",null,"f"),s("mi",null,"s")])]),s("annotation",{encoding:"application/x-tex"},"f_s")])])]),s("span",{class:"katex-html","aria-hidden":"true"},[s("span",{class:"base"},[s("span",{class:"strut",style:{height:"0.8889em","vertical-align":"-0.1944em"}}),s("span",{class:"mord"},[s("span",{class:"mord mathnormal",style:{"margin-right":"0.10764em"}},"f"),s("span",{class:"msupsub"},[s("span",{class:"vlist-t vlist-t2"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.1514em"}},[s("span",{style:{top:"-2.55em","margin-left":"-0.1076em","margin-right":"0.05em"}},[s("span",{class:"pstrut",style:{height:"2.7em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mathnormal mtight"},"s")])])]),s("span",{class:"vlist-s"},"​")]),s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.15em"}},[s("span")])])])])])])])]),n("）")]),n(" = 每秒取多少个点。")]),s("li",null,"CD 音频：44.1 kHz ⇒ 每秒取 44,100 个点；"),s("li",null,"语音识别：16 kHz ⇒ 每秒取 16,000 个点。")],-1),c=a(`<p>根据 <strong>奈奎斯特采样定理</strong> ：采样率 ≥ 2 × 信号最高频率，才能无失真重建。 人耳最高能听约 20 kHz ⇒ CD 选择 44.1 kHz（略高于 2×20 kHz）。</p><p>量化（Quantization）：幅度离散化</p><ul><li>每个采样点的电压值是连续的，计算机必须用有限比特表示。</li><li><strong>量化位深（bit depth）</strong> ：</li><li>8-bit ⇒ 256 个电平；</li><li>16-bit ⇒ 65,536 个电平（CD 质量）；</li><li>24-bit ⇒ 16,777,216 个电平（录音室常用）。</li></ul><p>例子：</p><ul><li>真实电压值 = 0.12345 V</li><li>如果 16-bit 量化 ⇒ 可能存储为“0.12340 V”对应的离散电平。</li><li>越高位深 ⇒ 还原越接近真实，噪声（量化误差）越小。</li></ul><p>编码（Encoding）：存入文件</p><ul><li>采样 + 量化后，得到一串整数序列（PCM 数据）。</li><li>再打包进 <strong>文件容器（如 WAV、AIFF）</strong> ，并写入参数：采样率、位深、声道数。</li></ul><p>示例（16kHz，16-bit，单声道，1 秒音频）：</p><ul><li>总采样点数 = 16,000；</li><li>每个点 16 bit = 2 字节；</li><li>文件大小 ≈ 16,000 × 2 = 32 KB。</li></ul><hr><ol start="3"><li>音频文件格式（File Format）</li></ol><p>音频文件格式一般分两部分： <strong>容器格式</strong> （file container）+ <strong>编码格式</strong> （codec）。</p><ol><li><strong>容器格式（Container）</strong></li></ol><ul><li>就像文件的外壳，负责存储数据、采样率、声道数、比特率等元信息（metadata）。</li><li>常见容器：WAV、AIFF、MP4、MKV。</li></ul><ol start="2"><li><strong>编码格式（Codec, Coder-Decoder）</strong></li></ol><ul><li>决定音频数据如何压缩和存储。</li><li>分为无压缩、无损压缩和有损压缩。</li></ul><hr><ol start="4"><li>音频编码方式（Encoding）</li></ol><p><strong>无压缩（Uncompressed）</strong></p><ul><li><strong>PCM</strong> ：最常见，几乎所有音频处理都会先转成 PCM。</li><li>格式：WAV（Windows）、AIFF（Mac）。</li><li>优点：质量最高；缺点：体积大。</li></ul><p><strong>无损压缩（Lossless Compression）</strong></p><ul><li>压缩但不丢失信息，解码后与原始 PCM 完全一致。</li><li>常见：FLAC、ALAC（Apple）、APE。</li><li>优点：比无压缩小一半左右；缺点：还是比较大。</li></ul><p><strong>有损压缩（Lossy Compression）</strong></p><ul><li>丢弃人耳不敏感的部分信息，用心理声学模型压缩。</li><li>常见：MP3、AAC、OGG Vorbis、Opus。</li><li>优点：体积小，适合传输；缺点：不可逆，质量取决于比特率。</li></ul><hr><ol start="5"><li>常见音频格式速查表</li></ol><table><thead><tr><th>格式</th><th>编码方式</th><th>特点</th><th>应用场景</th></tr></thead><tbody><tr><td><strong>WAV</strong></td><td>PCM（无压缩）</td><td>保真度高，体积大</td><td>专业录音、音频处理</td></tr><tr><td><strong>AIFF</strong></td><td>PCM（无压缩）</td><td>Apple 标准，类似 WAV</td><td>专业音频工作站</td></tr><tr><td><strong>FLAC</strong></td><td>无损压缩</td><td>体积缩小 ~50%，质量无损</td><td>高保真音乐收藏</td></tr><tr><td><strong>ALAC</strong></td><td>无损压缩</td><td>Apple 的 FLAC</td><td>iTunes, iOS</td></tr><tr><td><strong>MP3</strong></td><td>有损压缩</td><td>最流行，兼容性强</td><td>音乐流媒体</td></tr><tr><td><strong>AAC</strong></td><td>有损压缩</td><td>比 MP3 更高效</td><td>YouTube, iTunes, iPhone</td></tr><tr><td><strong>OGG (Vorbis)</strong></td><td>有损压缩</td><td>开源 MP3 替代品</td><td>游戏、开源应用</td></tr><tr><td><strong>Opus</strong></td><td>有损压缩</td><td>动态码率，超低延迟</td><td>Zoom、Discord、WebRTC</td></tr></tbody></table><hr><ol start="6"><li>音频的重要参数</li></ol><ul><li><strong>采样率</strong> ：决定频率范围（8kHz 电话质感，44.1kHz CD，48kHz 视频）。</li><li><strong>比特率（Bitrate）</strong> ：每秒数据量（kbps）。</li><li>比如 MP3 常见 128 kbps、192 kbps、320 kbps；</li><li>AAC/Opus 用同样比特率通常效果更好。</li><li><strong>声道（Channels）</strong> ：单声道（Mono）、立体声（Stereo）、环绕声（5.1、7.1）。</li></ul><hr><ol start="7"><li>编解码流程（Codec Pipeline）</li></ol><p><strong>编码（Encoding）</strong> ：</p><ul><li>模拟 → 数字（采样 + 量化） → 压缩（可选） → 存储为文件。</li></ul><p><strong>解码（Decoding）</strong> ：</p><ul><li>文件 → 解压缩 → PCM 波形 → 声卡 → 模拟信号 → 耳机/音响。</li></ul><hr><ol start="8"><li>信号，傅里叶变化， Mel 频谱图；参考 文章：https://zhuanlan.zhihu.com/p/198900624</li></ol><hr><h2 id="whisper-audio-encoder" tabindex="-1"><a class="header-anchor" href="#whisper-audio-encoder" aria-hidden="true">#</a> Whisper Audio Encoder</h2><p>参考 <code>from transformers import WhisperProcessor, WhisperForConditionalGeneration</code> 中的源码，在 whisper 中，模型对 raw speech 进行了以下预处理。</p><ol><li><p>通常音频文件需要转换成 numpy 形式。并且仅支持 <code>mono-channel</code>，输出的 Numpy array shape 如 <code>(60075,)</code>。</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> numpy </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> np</span></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> subprocess</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ffmpeg_read</span><span style="color:#24292E;">(bpayload: </span><span style="color:#005CC5;">bytes</span><span style="color:#24292E;">, sampling_rate: </span><span style="color:#005CC5;">int</span><span style="color:#24292E;">) -&gt; np.array:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#032F62;">    Helper function to read an audio file through ffmpeg.</span></span>
<span class="line"><span style="color:#032F62;">    &quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#24292E;">    ar </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">f</span><span style="color:#032F62;">&quot;</span><span style="color:#005CC5;">{</span><span style="color:#24292E;">sampling_rate</span><span style="color:#005CC5;">}</span><span style="color:#032F62;">&quot;</span></span>
<span class="line"><span style="color:#24292E;">    ac </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;1&quot;</span></span>
<span class="line"><span style="color:#24292E;">    format_for_conversion </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;f32le&quot;</span></span>
<span class="line"><span style="color:#24292E;">    ffmpeg_command </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> [</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#032F62;">&quot;ffmpeg&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#032F62;">&quot;-i&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#032F62;">&quot;pipe:0&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#032F62;">&quot;-ac&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        ac,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#032F62;">&quot;-ar&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        ar,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#032F62;">&quot;-f&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        format_for_conversion,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#032F62;">&quot;-hide_banner&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#032F62;">&quot;-loglevel&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#032F62;">&quot;quiet&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#032F62;">&quot;pipe:1&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    ]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">try</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">with</span><span style="color:#24292E;"> subprocess.Popen(ffmpeg_command, </span><span style="color:#E36209;">stdin</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">subprocess.</span><span style="color:#005CC5;">PIPE</span><span style="color:#24292E;">, </span><span style="color:#E36209;">stdout</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">subprocess.</span><span style="color:#005CC5;">PIPE</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> ffmpeg_process:</span></span>
<span class="line"><span style="color:#24292E;">            output_stream </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> ffmpeg_process.communicate(bpayload)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">except</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">FileNotFoundError</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> error:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">raise</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ValueError</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;ffmpeg was not found but is required to load audio files from filename&quot;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> error</span></span>
<span class="line"><span style="color:#24292E;">    out_bytes </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> output_stream[</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">    audio </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> np.frombuffer(out_bytes, np.float32)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> audio.shape[</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">raise</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ValueError</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#032F62;">&quot;Soundfile is either not in the correct format or is malformed. Ensure that the soundfile has &quot;</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#032F62;">&quot;a valid audio file extension (e.g. wav, flac or mp3) and is not corrupted. If reading from a remote &quot;</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#032F62;">&quot;URL, ensure that the URL is the full address to  **download**  the audio file.&quot;</span></span>
<span class="line"><span style="color:#24292E;">        )</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> audio</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>默认情况下，再 batch 处理时候，根据 max-length 进行 padding</p><ul><li>在 Whisper Processor 中，预处理根据 <code>self.n_samples = chunk_length * sampling_rate</code> 进行 padding。其中 <code>chunk_length=30</code>, <code>sampling_rate=16000</code></li></ul></li><li><p>根据输入，计算 log-mel spectrogram</p><ol><li><p>将输入的波形按照 <code>frame_length</code> 的大小切分成一系列帧，相邻帧之间有 <code>frame_length - hop_length</code> 个采样点的重叠。</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># split waveform into frames of frame_length size</span></span>
<span class="line"><span style="color:#24292E;">    num_frames </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">int</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> np.floor((waveform.size </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> frame_length) </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> hop_length))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    num_frequency_bins </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (fft_length </span><span style="color:#D73A49;">//</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> onesided </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> fft_length</span></span>
<span class="line"><span style="color:#24292E;">    spectrogram </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> np.empty((num_frames, num_frequency_bins), </span><span style="color:#E36209;">dtype</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">np.complex64)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># num_frequency_bins = 201, num_frames 根据输入长度而定</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>每一帧都与一个窗口函数相乘，然后放入大小为 <code>fft_length</code> 的缓冲区。</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#24292E;">spectrogram </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> np.empty((num_batches, num_frames, num_frequency_bins), </span><span style="color:#E36209;">dtype</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">np.complex64)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># rfft is faster than fft</span></span>
<span class="line"><span style="color:#24292E;">fft_func </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> np.fft.rfft </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> onesided </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> np.fft.fft</span></span>
<span class="line"><span style="color:#24292E;">buffer </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> np.zeros((num_batches, fft_length))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">for</span><span style="color:#24292E;"> frame_idx </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">range</span><span style="color:#24292E;">(num_frames):</span></span>
<span class="line"><span style="color:#24292E;">    timestep </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> frame_idx </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> hop_length</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># frame_length = 400, hop_length = 160</span></span>
<span class="line"><span style="color:#24292E;">    buffer[:, :frame_length] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> padded_waveform_batch[:, timestep : timestep </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> frame_length]</span></span>
<span class="line"><span style="color:#24292E;">    buffer[:, :frame_length] </span><span style="color:#D73A49;">*=</span><span style="color:#24292E;"> window</span></span>
<span class="line"><span style="color:#24292E;">   </span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>对每个加窗后的帧进行离散傅里叶变换（DFT）。</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#24292E;">spectrogram[:, frame_idx] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> fft_func(buffer)</span></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> mel_filters </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">None</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    spectrogram </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> np.maximum(mel_floor, np.dot(mel_filters.T, spectrogram))</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># mel_filters.shape=(201, 80)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># spectrogram.shape=(x, 201)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>将结果堆叠起来，得到频谱图（spectrogram）。形状如 <code>[2, 80, 3000]</code></p></li></ol></li></ol><p>参考 openai whisper 的预处理器：</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> typing </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> Optional, Union</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> numpy </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> np</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> ... </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> is_torch_available</span></span>
<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> ...audio_utils </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> mel_filter_bank, spectrogram, window_function</span></span>
<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> ...feature_extraction_sequence_utils </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> SequenceFeatureExtractor</span></span>
<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> ...feature_extraction_utils </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> BatchFeature</span></span>
<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> ...utils </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> TensorType, logging</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> is_torch_available():</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> torch</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">logger </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> logging.get_logger(</span><span style="color:#005CC5;">__name__</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">WhisperFeatureExtractor</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">SequenceFeatureExtractor</span><span style="color:#24292E;">):</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">r</span><span style="color:#032F62;">&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#032F62;">    Constructs a Whisper feature extractor.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">    This feature extractor inherits from [\`~feature_extraction_sequence_utils.SequenceFeatureExtractor\`] which contains</span></span>
<span class="line"><span style="color:#032F62;">    most of the main methods. Users should refer to this superclass for more information regarding those methods.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">    This class extracts mel-filter bank features from raw speech using a custom numpy implementation of the \`Short Time</span></span>
<span class="line"><span style="color:#032F62;">    Fourier Transform\` which should match pytorch&#39;s \`torch.stft\` equivalent.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">    Args:</span></span>
<span class="line"><span style="color:#032F62;">        feature_size (\`int\`, *optional*, defaults to 80):</span></span>
<span class="line"><span style="color:#032F62;">            The feature dimension of the extracted features.</span></span>
<span class="line"><span style="color:#032F62;">        sampling_rate (\`int\`, *optional*, defaults to 16000):</span></span>
<span class="line"><span style="color:#032F62;">            The sampling rate at which the audio files should be digitalized expressed in hertz (Hz).</span></span>
<span class="line"><span style="color:#032F62;">        hop_length (\`int\`, *optional*, defaults to 160):</span></span>
<span class="line"><span style="color:#032F62;">            Length of the overlapping windows for the STFT used to obtain the Mel Frequency coefficients.</span></span>
<span class="line"><span style="color:#032F62;">        chunk_length (\`int\`, *optional*, defaults to 30):</span></span>
<span class="line"><span style="color:#032F62;">            The maximum number of chunks of \`sampling_rate\` samples used to trim and pad longer or shorter audio</span></span>
<span class="line"><span style="color:#032F62;">            sequences.</span></span>
<span class="line"><span style="color:#032F62;">        n_fft (\`int\`, *optional*, defaults to 400):</span></span>
<span class="line"><span style="color:#032F62;">            Size of the Fourier transform.</span></span>
<span class="line"><span style="color:#032F62;">        padding_value (\`float\`, *optional*, defaults to 0.0):</span></span>
<span class="line"><span style="color:#032F62;">            Padding value used to pad the audio. Should correspond to silences.</span></span>
<span class="line"><span style="color:#032F62;">        dither (\`float\`, *optional*, defaults to 0.0):</span></span>
<span class="line"><span style="color:#032F62;">            Adds dithering. In other words, adds a small Gaussian noise to each frame.</span></span>
<span class="line"><span style="color:#032F62;">            E.g. use 0.0001 to add dithering with a normal distribution centered</span></span>
<span class="line"><span style="color:#032F62;">            around 0.0 with standard deviation 0.0001 (assuming [-1,+1] range of raw_speech).</span></span>
<span class="line"><span style="color:#032F62;">            The value 0.0 means no dithering.</span></span>
<span class="line"><span style="color:#032F62;">            Dithering has similar effect as \`spectrogram(mel_floor=...)\`. It reduces</span></span>
<span class="line"><span style="color:#032F62;">            the high log_mel_fbank values for signals with hard-zero sections,</span></span>
<span class="line"><span style="color:#032F62;">            when VAD cutoff is present in the signal.</span></span>
<span class="line"><span style="color:#032F62;">    &quot;&quot;&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    model_input_names </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> [</span><span style="color:#032F62;">&quot;input_features&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">__init__</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">        self,</span></span>
<span class="line"><span style="color:#24292E;">        feature_size</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">80</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        sampling_rate</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">16000</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        hop_length</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">160</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        chunk_length</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">30</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        n_fft</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">400</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        padding_value</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0.0</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        dither</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0.0</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        return_attention_mask</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">False</span><span style="color:#24292E;">,  </span><span style="color:#6A737D;"># pad inputs to max length with silence token (zero) and no attention mask</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">**</span><span style="color:#24292E;">kwargs,</span></span>
<span class="line"><span style="color:#24292E;">    ):</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">super</span><span style="color:#24292E;">().</span><span style="color:#005CC5;">__init__</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#E36209;">feature_size</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">feature_size,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#E36209;">sampling_rate</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">sampling_rate,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#E36209;">padding_value</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">padding_value,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#E36209;">return_attention_mask</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">return_attention_mask,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">**</span><span style="color:#24292E;">kwargs,</span></span>
<span class="line"><span style="color:#24292E;">        )</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.n_fft </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> n_fft</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.hop_length </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> hop_length</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.chunk_length </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> chunk_length</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.n_samples </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> chunk_length </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> sampling_rate</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.nb_max_frames </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.n_samples </span><span style="color:#D73A49;">//</span><span style="color:#24292E;"> hop_length</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.sampling_rate </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> sampling_rate</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.dither </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> dither</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.mel_filters </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> mel_filter_bank(</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#E36209;">num_frequency_bins</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> n_fft </span><span style="color:#D73A49;">//</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#E36209;">num_mel_filters</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">feature_size,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#E36209;">min_frequency</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0.0</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#E36209;">max_frequency</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">8000.0</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#E36209;">sampling_rate</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">sampling_rate,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#E36209;">norm</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;slaney&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#E36209;">mel_scale</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;slaney&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">_np_extract_fbank_features</span><span style="color:#24292E;">(self, waveform_batch: np.array, device: </span><span style="color:#005CC5;">str</span><span style="color:#24292E;">) -&gt; np.ndarray:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#032F62;">&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#032F62;">        Compute the log-mel spectrogram of the provided audio, gives similar results to Whisper&#39;s original torch</span></span>
<span class="line"><span style="color:#032F62;">        implementation with 1e-5 tolerance.</span></span>
<span class="line"><span style="color:#032F62;">        &quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> device </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;cpu&quot;</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">raise</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ValueError</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">f</span><span style="color:#032F62;">&quot;Got device \`</span><span style="color:#005CC5;">{</span><span style="color:#24292E;">device</span><span style="color:#005CC5;">}</span><span style="color:#032F62;">\` for feature extraction, but feature extraction on CUDA accelerator &quot;</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#032F62;">&quot;devices requires torch, which is not installed. Either set \`device=&#39;cpu&#39;\`, or &quot;</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#032F62;">&quot;install torch according to the official instructions: https://pytorch.org/get-started/locally/&quot;</span></span>
<span class="line"><span style="color:#24292E;">            )</span></span>
<span class="line"><span style="color:#24292E;">        log_spec_batch </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> []</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> waveform </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> waveform_batch:</span></span>
<span class="line"><span style="color:#24292E;">            log_spec </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> spectrogram(</span></span>
<span class="line"><span style="color:#24292E;">                waveform,</span></span>
<span class="line"><span style="color:#24292E;">                window_function(</span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.n_fft, </span><span style="color:#032F62;">&quot;hann&quot;</span><span style="color:#24292E;">),</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#E36209;">frame_length</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.n_fft,</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#E36209;">hop_length</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.hop_length,</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#E36209;">power</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">2.0</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#E36209;">dither</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.dither,</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#E36209;">mel_filters</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.mel_filters,</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#E36209;">log_mel</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;log10&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">            )</span></span>
<span class="line"><span style="color:#24292E;">            log_spec </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> log_spec[:, :</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">            log_spec </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> np.maximum(log_spec, log_spec.max() </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">8.0</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">            log_spec </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (log_spec </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">4.0</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">4.0</span></span>
<span class="line"><span style="color:#24292E;">            log_spec_batch.append(log_spec)</span></span>
<span class="line"><span style="color:#24292E;">        log_spec_batch </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> np.array(log_spec_batch)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> log_spec_batch</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">_torch_extract_fbank_features</span><span style="color:#24292E;">(self, waveform: np.array, device: </span><span style="color:#005CC5;">str</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;cpu&quot;</span><span style="color:#24292E;">) -&gt; np.ndarray:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#032F62;">&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#032F62;">        Compute the log-mel spectrogram of the audio using PyTorch&#39;s GPU-accelerated STFT implementation with batching,</span></span>
<span class="line"><span style="color:#032F62;">        yielding results similar to cpu computing with 1e-5 tolerance.</span></span>
<span class="line"><span style="color:#032F62;">        &quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#24292E;">        waveform </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> torch.from_numpy(waveform).to(device, torch.float32)</span></span>
<span class="line"><span style="color:#24292E;">        window </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> torch.hann_window(</span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.n_fft, </span><span style="color:#E36209;">device</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">device)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;"># Note: it would be better to dither the chunked waveform,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;"># so overlapping signal does not get the same dithering.</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;"># But, chunking is happening inside pytorch, so it is here.</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.dither </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0.0</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            waveform </span><span style="color:#D73A49;">+=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.dither </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> torch.randn(waveform.shape, </span><span style="color:#E36209;">dtype</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">waveform.dtype, </span><span style="color:#E36209;">device</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">waveform.device)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        stft </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> torch.stft(waveform, </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.n_fft, </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.hop_length, </span><span style="color:#E36209;">window</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">window, </span><span style="color:#E36209;">return_complex</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">True</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        magnitudes </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> stft[</span><span style="color:#005CC5;">...</span><span style="color:#24292E;">, :</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">].abs() </span><span style="color:#D73A49;">**</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        mel_filters </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> torch.from_numpy(</span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.mel_filters).to(device, torch.float32)</span></span>
<span class="line"><span style="color:#24292E;">        mel_spec </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> mel_filters.T </span><span style="color:#D73A49;">@</span><span style="color:#24292E;"> magnitudes</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        log_spec </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> torch.clamp(mel_spec, </span><span style="color:#E36209;">min</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1e-10</span><span style="color:#24292E;">).log10()</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> waveform.dim() </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            max_val </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> log_spec.max(</span><span style="color:#E36209;">dim</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">, </span><span style="color:#E36209;">keepdim</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">True</span><span style="color:#24292E;">)[</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">].max(</span><span style="color:#E36209;">dim</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span><span style="color:#E36209;">keepdim</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">True</span><span style="color:#24292E;">)[</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">            log_spec </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> torch.maximum(log_spec, max_val </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">8.0</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">else</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            log_spec </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> torch.maximum(log_spec, log_spec.max() </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">8.0</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        log_spec </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (log_spec </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">4.0</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">4.0</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> device </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;cpu&quot;</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            log_spec </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> log_spec.detach().cpu()</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> log_spec.numpy()</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">__call__</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">        self,</span></span>
<span class="line"><span style="color:#24292E;">        raw_speech: Union[np.ndarray, list[</span><span style="color:#005CC5;">float</span><span style="color:#24292E;">], list[np.ndarray], list[list[</span><span style="color:#005CC5;">float</span><span style="color:#24292E;">]]],</span></span>
<span class="line"><span style="color:#24292E;">        truncation: </span><span style="color:#005CC5;">bool</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">True</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        pad_to_multiple_of: Optional[</span><span style="color:#005CC5;">int</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">None</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        return_tensors: Optional[Union[</span><span style="color:#005CC5;">str</span><span style="color:#24292E;">, TensorType]] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">None</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        return_attention_mask: Optional[</span><span style="color:#005CC5;">bool</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">None</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        padding: Optional[</span><span style="color:#005CC5;">str</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;max_length&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        max_length: Optional[</span><span style="color:#005CC5;">int</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">None</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        sampling_rate: Optional[</span><span style="color:#005CC5;">int</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">None</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        do_normalize: Optional[</span><span style="color:#005CC5;">bool</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">None</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        device: Optional[</span><span style="color:#005CC5;">str</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;cpu&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        return_token_timestamps: Optional[</span><span style="color:#005CC5;">bool</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">None</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">**</span><span style="color:#24292E;">kwargs,</span></span>
<span class="line"><span style="color:#24292E;">    ) -&gt; BatchFeature:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#032F62;">&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#032F62;">        Main method to featurize and prepare for the model one or several sequence(s). Implementation uses PyTorch for</span></span>
<span class="line"><span style="color:#032F62;">        the STFT computation if available, otherwise a slower NumPy based one.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">        Args:</span></span>
<span class="line"><span style="color:#032F62;">            raw_speech (\`np.ndarray\`, \`list[float]\`, \`list[np.ndarray]\`, \`list[list[float]]\`):</span></span>
<span class="line"><span style="color:#032F62;">                The sequence or batch of sequences to be padded. Each sequence can be a numpy array, a list of float</span></span>
<span class="line"><span style="color:#032F62;">                values, a list of numpy arrays or a list of list of float values. Must be mono channel audio, not</span></span>
<span class="line"><span style="color:#032F62;">                stereo, i.e. single float per timestep.</span></span>
<span class="line"><span style="color:#032F62;">            truncation (\`bool\`, *optional*, default to \`True\`):</span></span>
<span class="line"><span style="color:#032F62;">                Activates truncation to cut input sequences longer than *max_length* to *max_length*.</span></span>
<span class="line"><span style="color:#032F62;">            pad_to_multiple_of (\`int\`, *optional*, defaults to None):</span></span>
<span class="line"><span style="color:#032F62;">                If set will pad the sequence to a multiple of the provided value.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">                This is especially useful to enable the use of Tensor Cores on NVIDIA hardware with compute capability</span></span>
<span class="line"><span style="color:#032F62;">                \`&gt;= 7.5\` (Volta), or on TPUs which benefit from having sequence lengths be a multiple of 128.</span></span>
<span class="line"><span style="color:#032F62;">            return_attention_mask (\`bool\`, *optional*):</span></span>
<span class="line"><span style="color:#032F62;">                Whether to return the attention mask. If left to the default, will return the attention mask according</span></span>
<span class="line"><span style="color:#032F62;">                to the specific feature_extractor&#39;s default.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">                [What are attention masks?](../glossary#attention-mask)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">                &lt;Tip&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">                For Whisper models, \`attention_mask\` should always be passed for batched inference, to avoid subtle</span></span>
<span class="line"><span style="color:#032F62;">                bugs.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">                &lt;/Tip&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">            return_tensors (\`str\` or [\`~utils.TensorType\`], *optional*):</span></span>
<span class="line"><span style="color:#032F62;">                If set, will return tensors instead of list of python integers. Acceptable values are:</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">                - \`&#39;tf&#39;\`: Return TensorFlow \`tf.constant\` objects.</span></span>
<span class="line"><span style="color:#032F62;">                - \`&#39;pt&#39;\`: Return PyTorch \`torch.Tensor\` objects.</span></span>
<span class="line"><span style="color:#032F62;">                - \`&#39;np&#39;\`: Return Numpy \`np.ndarray\` objects.</span></span>
<span class="line"><span style="color:#032F62;">            sampling_rate (\`int\`, *optional*):</span></span>
<span class="line"><span style="color:#032F62;">                The sampling rate at which the \`raw_speech\` input was sampled. It is strongly recommended to pass</span></span>
<span class="line"><span style="color:#032F62;">                \`sampling_rate\` at the forward call to prevent silent errors and allow automatic speech recognition</span></span>
<span class="line"><span style="color:#032F62;">                pipeline.</span></span>
<span class="line"><span style="color:#032F62;">            padding_value (\`float\`, *optional*, defaults to 0.0):</span></span>
<span class="line"><span style="color:#032F62;">                The value that is used to fill the padding values / vectors.</span></span>
<span class="line"><span style="color:#032F62;">            do_normalize (\`bool\`, *optional*, defaults to \`False\`):</span></span>
<span class="line"><span style="color:#032F62;">                Whether or not to zero-mean unit-variance normalize the input. Normalizing can help to significantly</span></span>
<span class="line"><span style="color:#032F62;">                improve the performance of the model.</span></span>
<span class="line"><span style="color:#032F62;">            device (\`str\`, *optional*, defaults to \`&#39;cpu&#39;\`):</span></span>
<span class="line"><span style="color:#032F62;">                Specifies the device for computation of the log-mel spectrogram of audio signals in the</span></span>
<span class="line"><span style="color:#032F62;">                \`_torch_extract_fbank_features\` method. (e.g., &quot;cpu&quot;, &quot;cuda&quot;)</span></span>
<span class="line"><span style="color:#032F62;">            return_token_timestamps (\`bool\`, *optional*, defaults to \`None\`):</span></span>
<span class="line"><span style="color:#032F62;">                Deprecated. Use \`return_attention_mask\` instead from which the number of frames can be inferred.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">                Whether or not to return the number of frames of the input raw_speech.</span></span>
<span class="line"><span style="color:#032F62;">                These num_frames can be used by the model to compute word level timestamps.</span></span>
<span class="line"><span style="color:#032F62;">        &quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> sampling_rate </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">None</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> sampling_rate </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.sampling_rate:</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">raise</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ValueError</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">f</span><span style="color:#032F62;">&quot;The model corresponding to this feature extractor: </span><span style="color:#005CC5;">{self</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">__class__</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">__name__}</span><span style="color:#032F62;"> was trained using a&quot;</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">f</span><span style="color:#032F62;">&quot; sampling rate of </span><span style="color:#005CC5;">{self</span><span style="color:#24292E;">.sampling_rate</span><span style="color:#005CC5;">}</span><span style="color:#032F62;">. Please make sure that the provided \`raw_speech\` input&quot;</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">f</span><span style="color:#032F62;">&quot; was sampled with </span><span style="color:#005CC5;">{self</span><span style="color:#24292E;">.sampling_rate</span><span style="color:#005CC5;">}</span><span style="color:#032F62;"> and not </span><span style="color:#005CC5;">{</span><span style="color:#24292E;">sampling_rate</span><span style="color:#005CC5;">}</span><span style="color:#032F62;">.&quot;</span></span>
<span class="line"><span style="color:#24292E;">                )</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">else</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            logger.warning(</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">f</span><span style="color:#032F62;">&quot;It is strongly recommended to pass the \`sampling_rate\` argument to \`</span><span style="color:#005CC5;">{self</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">__class__</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">__name__}</span><span style="color:#032F62;">()\`. &quot;</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#032F62;">&quot;Failing to do so can result in silent errors that might be hard to debug.&quot;</span></span>
<span class="line"><span style="color:#24292E;">            )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        is_batched_numpy </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">isinstance</span><span style="color:#24292E;">(raw_speech, np.ndarray) </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">len</span><span style="color:#24292E;">(raw_speech.shape) </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> is_batched_numpy </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">len</span><span style="color:#24292E;">(raw_speech.shape) </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">raise</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ValueError</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">f</span><span style="color:#032F62;">&quot;Only mono-channel audio is supported for input to </span><span style="color:#005CC5;">{self}</span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        is_batched </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> is_batched_numpy </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> (</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">isinstance</span><span style="color:#24292E;">(raw_speech, (</span><span style="color:#005CC5;">list</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">tuple</span><span style="color:#24292E;">)) </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">isinstance</span><span style="color:#24292E;">(raw_speech[</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">], (np.ndarray, </span><span style="color:#005CC5;">tuple</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">list</span><span style="color:#24292E;">)))</span></span>
<span class="line"><span style="color:#24292E;">        )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> is_batched:</span></span>
<span class="line"><span style="color:#24292E;">            raw_speech </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> [np.asarray([speech], </span><span style="color:#E36209;">dtype</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">np.float32).T </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> speech </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> raw_speech]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">elif</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> is_batched </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">isinstance</span><span style="color:#24292E;">(raw_speech, np.ndarray):</span></span>
<span class="line"><span style="color:#24292E;">            raw_speech </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> np.asarray(raw_speech, </span><span style="color:#E36209;">dtype</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">np.float32)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">elif</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">isinstance</span><span style="color:#24292E;">(raw_speech, np.ndarray) </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> raw_speech.dtype </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> np.dtype(np.float64):</span></span>
<span class="line"><span style="color:#24292E;">            raw_speech </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> raw_speech.astype(np.float32)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;"># always return batch</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> is_batched:</span></span>
<span class="line"><span style="color:#24292E;">            raw_speech </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> [np.asarray([raw_speech]).T]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        batched_speech </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> BatchFeature({</span><span style="color:#032F62;">&quot;input_features&quot;</span><span style="color:#24292E;">: raw_speech})</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;"># convert into correct format for padding</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        padded_inputs </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.pad(</span></span>
<span class="line"><span style="color:#24292E;">            batched_speech,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#E36209;">padding</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">padding,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#E36209;">max_length</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">max_length </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> max_length </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.n_samples,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#E36209;">truncation</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">truncation,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#E36209;">pad_to_multiple_of</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">pad_to_multiple_of,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#E36209;">return_attention_mask</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">return_attention_mask </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> do_normalize,</span></span>
<span class="line"><span style="color:#24292E;">        )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;"># make sure list is in array format</span></span>
<span class="line"><span style="color:#24292E;">        input_features </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> padded_inputs.get(</span><span style="color:#032F62;">&quot;input_features&quot;</span><span style="color:#24292E;">).transpose(</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        extract_fbank_features </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">._torch_extract_fbank_features </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> is_torch_available() </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">._np_extract_fbank_features</span></span>
<span class="line"><span style="color:#24292E;">        )</span></span>
<span class="line"><span style="color:#24292E;">        input_features </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> extract_fbank_features(input_features[</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">], device)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">isinstance</span><span style="color:#24292E;">(input_features[</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">], </span><span style="color:#005CC5;">list</span><span style="color:#24292E;">):</span></span>
<span class="line"><span style="color:#24292E;">            padded_inputs[</span><span style="color:#032F62;">&quot;input_features&quot;</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> [np.asarray(feature, </span><span style="color:#E36209;">dtype</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">np.float32) </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> feature </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> input_features]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">else</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            padded_inputs[</span><span style="color:#032F62;">&quot;input_features&quot;</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> input_features</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> return_token_timestamps </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">None</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            logger.warning_once(</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">f</span><span style="color:#032F62;">&quot;\`return_token_timestamps\` is deprecated for </span><span style="color:#005CC5;">{self</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">__class__</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">__name__}</span><span style="color:#032F62;"> and will be removed in Transformers v5. Use \`return_attention_mask\` instead, as the number of frames can be inferred from it.&quot;</span></span>
<span class="line"><span style="color:#24292E;">            )</span></span>
<span class="line"><span style="color:#24292E;">            padded_inputs[</span><span style="color:#032F62;">&quot;num_frames&quot;</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> [</span><span style="color:#005CC5;">len</span><span style="color:#24292E;">(raw_speech_i) </span><span style="color:#D73A49;">//</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.hop_length </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> raw_speech_i </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> raw_speech]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> padded_inputs</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#005CC5;">__all__</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> [</span><span style="color:#032F62;">&quot;WhisperFeatureExtractor&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,44),i=[t,r,c];function y(d,u){return p(),e("div",null,i)}const E=l(o,[["render",y],["__file","笔记audio.html.vue"]]);export{E as default};
