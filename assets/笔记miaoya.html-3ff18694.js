import{_ as r,E as o,S as i,W as p,$ as a,a3 as e,Z as n,aS as t}from"./framework-d5c0d2cb.js";const l={},c=a("p",null,"妙鸭的热度过了一阵子了，网上对妙鸭背后的实现逻辑有这种各样的猜测，不少网友认为妙鸭只是简单的采用 SD + Lora。本文主要对 SD + Lora 方案进行探索，分析妙鸭采用 SD + Lora 方案的可能性。",-1),d=a("h2",{id:"环境准备",tabindex:"-1"},[a("a",{class:"header-anchor",href:"#环境准备","aria-hidden":"true"},"#"),e(),a("strong",null,"环境准备")],-1),u={href:"https://github.com/AUTOMATIC1111/stable-diffusion-webui",target:"_blank",rel:"noopener noreferrer"},h={href:"https://blog.csdn.net/weixin_43732022/article/details/129336297",target:"_blank",rel:"noopener noreferrer"},m=t('<h2 id="数据准备" tabindex="-1"><a class="header-anchor" href="#数据准备" aria-hidden="true">#</a> <strong>数据准备</strong></h2><h3 id="收集图片" tabindex="-1"><a class="header-anchor" href="#收集图片" aria-hidden="true">#</a> <strong>收集图片</strong></h3><p>大约 16 张图片。图中人物的风格尽量不同，图像的长宽大小没有要求，尽量像素高一点。</p><h3 id="图像人物裁剪" tabindex="-1"><a class="header-anchor" href="#图像人物裁剪" aria-hidden="true">#</a> <strong>图像人物裁剪</strong></h3><p>在训练 lora 的过程中，我们希望尽可能减少背景带来的影响。可以通过目标检测等技术对图像进行裁剪：</p><figure><img src="https://picx.zhimg.com/80/v2-0cc39055272b0c72cab14d84f5885cfa_1440w.png?source=d16d100b" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>当图中有多个人物时，使用目标检测自动裁剪会有点小复杂。因此我们尽量似使用单人照片进行处理。当然，如果只是想要训练个人 LORA 的话，手动对 16 张照片进行裁剪一下就行。</p><h3 id="图像质量提升" tabindex="-1"><a class="header-anchor" href="#图像质量提升" aria-hidden="true">#</a> <strong>图像质量提升</strong></h3>',8),_={href:"https://github.com/AUTOMATIC1111/stable-diffusion-webui",target:"_blank",rel:"noopener noreferrer"},b=t('<figure><img src="https://picx.zhimg.com/80/v2-297f1f46fb72b1d5ddbbe365557a1e6c_1440w.png?source=d16d100b" alt="AUTO1111 WEBUI 操作截图" tabindex="0" loading="lazy"><figcaption>AUTO1111 WEBUI 操作截图</figcaption></figure><p>scale 前后效果对比（左图为优化后的结果）：</p><figure><img src="https://picx.zhimg.com/80/v2-e62ce4ee1af4f139ea5ab5d807a755b3_1440w.png?source=d16d100b" alt="优化后图片 vs 优化前图片" tabindex="0" loading="lazy"><figcaption>优化后图片 vs 优化前图片</figcaption></figure><p>也可以采用 stable-diffusion 中 img2img 等功能，生成提升图片的质量。</p><h3 id="caption" tabindex="-1"><a class="header-anchor" href="#caption" aria-hidden="true">#</a> <strong>Caption</strong></h3><p>我们需要为每张图片写一句 prompt，用于 Lora 的训练。 Caption 过程中的一些小贴士：</p><ul><li>假设你要训练某男子的 Lora，那么所有的 prompt 中添加上相同的人物触发词，比如姓名或者拼音。触发词应该尽量独特，比如你要训练的人物名叫 coffee，那么训练时应尽量避免使用 coffee 这个容易混淆的词汇。</li><li>来自网友的意见：prompt 当中，应该避免提及到自定义人物的特点。比如自定义人物是某男子，那么就不要再 prompt 当中提到 man，black hair 等词。于此相反的，不属于该男子的特征应该尽量被提及（比如衣服的颜色，造型等等）。比如该男子平时穿衣风格丰富，但你提供的照片中，他总是穿着一件蓝色的 T shirt，那么 prompt 当中应该提及 blue T shirt。</li></ul><p>该过程可以人工写，当然也可以使用 CLIP 工具进行实现。比如 AUTO1111 里 img2img 一栏，提供了 Interrogate CLIP，可以针对每个图片进行 caption。</p><figure><img src="https://pic1.zhimg.com/80/v2-0b6e8e0648ed7b00470e32ef3b62caaa_1440w.png?source=d16d100b" alt="AUTO1111 webui Caption 操作截图" tabindex="0" loading="lazy"><figcaption>AUTO1111 webui Caption 操作截图</figcaption></figure><p>此外，可以采用如 kohya UI - utils 中的 BLIP Captioning。通常会将图像 img_1234.jpg 对应的 prompt 储存在 img_1234.txt 文件中。</p><h2 id="lora-训练" tabindex="-1"><a class="header-anchor" href="#lora-训练" aria-hidden="true">#</a> <strong>Lora 训练</strong></h2>',11),g={href:"https://github.com/bmaltais/kohya_ss",target:"_blank",rel:"noopener noreferrer"},k={href:"https://github.com/bmaltais/kohya_ss#installation",target:"_blank",rel:"noopener noreferrer"},f={href:"https://github.com/bmaltais/kohya_ss/blob/master/train_network.py",target:"_blank",rel:"noopener noreferrer"},v=t(`<h3 id="训练文件夹准备" tabindex="-1"><a class="header-anchor" href="#训练文件夹准备" aria-hidden="true">#</a> <strong>训练文件夹准备</strong></h3><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>└── abcboy
    └── 100_abcboy               # 文件夹命名为 {repeat}_{folder_name}
        ├── image_01.png         # 文件夹下放置图片
        ├── image_01.txt         # 还有图片对应的 prompt
        └── ....
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>参考以上文件夹结构，其中我们需要将图片和储存 prompt 的 .txt 文件放在名为 {repeat}_{folder_name} 的文件夹下，其中 repeat 为每张图片重复的次数，比如设置 repeat 为 100 时，假设文件夹下一共有 16 张图片，那么训练过程中每个 epoch 会训练 16 * 100 张图片。</p><h3 id="开始训练" tabindex="-1"><a class="header-anchor" href="#开始训练" aria-hidden="true">#</a> <strong>开始训练</strong></h3><p>经过几次调参后，以下参数效果相对理想。其中：</p>`,5),w={href:"https://zhuanlan.zhihu.com/p/651809963/runwayml/stable-diffusion-v1-5",target:"_blank",rel:"noopener noreferrer"},x={href:"https://huggingface.co/SG161222/Realistic_Vision_V5.1_noVAE",target:"_blank",rel:"noopener noreferrer"},y=a("li",null,"train_data_dir：选 abcboy 而不是 100_abcboy ，参考上文提到的训练文件夹准备。",-1),A=a("li",null,"network_alpha 和 network_dim：个人测试 alpha=128, dim=128 与 alpha=8, dim=8 VRAM 占用及训练时长差不多，但 128 效果好很多。",-1),q={href:"https://www.youtube.com/watch?v=k5imq01uvUY",target:"_blank",rel:"noopener noreferrer"},T=a("li",null,"clip_skip：个人测试，clip_skip=2 相对 clip_skip=1 效果好一点。",-1),I=a("li",null,"batch_size：batch size =2 算是一种权衡。由于我们数据集较小，batch size 过大会导致梯度更新速度太慢。",-1),L=t(`<div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>accelerate launch <span class="token parameter variable">--num_cpu_threads_per_process</span><span class="token operator">=</span><span class="token number">2</span> <span class="token string">&quot;/workspace/kohya_ss/train_network.py&quot;</span> <span class="token punctuation">\\</span>
    <span class="token parameter variable">--enable_bucket</span> <span class="token parameter variable">--min_bucket_reso</span><span class="token operator">=</span><span class="token number">256</span> <span class="token parameter variable">--max_bucket_reso</span><span class="token operator">=</span><span class="token number">2048</span> <span class="token punctuation">\\</span>
    <span class="token parameter variable">--pretrained_model_name_or_path</span><span class="token operator">=</span><span class="token string">&quot;runwayml/stable-diffusion-v1-5&quot;</span>  <span class="token punctuation">\\</span>
    <span class="token parameter variable">--train_data_dir</span><span class="token operator">=</span><span class="token string">&quot;/workspace/abcboy&quot;</span> <span class="token parameter variable">--resolution</span><span class="token operator">=</span><span class="token string">&quot;512,512&quot;</span> <span class="token punctuation">\\</span>
    <span class="token parameter variable">--output_dir</span><span class="token operator">=</span><span class="token string">&quot;/workspace/stable-diffusion-webui/models/Lora&quot;</span> <span class="token punctuation">\\</span>
    <span class="token parameter variable">--logging_dir</span><span class="token operator">=</span><span class="token string">&quot;/workspace/logs&quot;</span> <span class="token parameter variable">--network_alpha</span><span class="token operator">=</span><span class="token string">&quot;128&quot;</span> <span class="token punctuation">\\</span>
    <span class="token parameter variable">--save_model_as</span><span class="token operator">=</span>safetensors <span class="token parameter variable">--network_module</span><span class="token operator">=</span>networks.lora <span class="token parameter variable">--text_encoder_lr</span><span class="token operator">=</span>5e-05   <span class="token punctuation">\\</span>
    <span class="token parameter variable">--unet_lr</span><span class="token operator">=</span><span class="token number">0.0001</span> <span class="token parameter variable">--network_dim</span><span class="token operator">=</span><span class="token number">128</span> <span class="token parameter variable">--output_name</span><span class="token operator">=</span><span class="token string">&quot;abcboy_v1.0&quot;</span>             <span class="token punctuation">\\</span>
    <span class="token parameter variable">--lr_scheduler_num_cycles</span><span class="token operator">=</span><span class="token string">&quot;1&quot;</span> <span class="token parameter variable">--no_half_vae</span> <span class="token parameter variable">--learning_rate</span><span class="token operator">=</span><span class="token string">&quot;0.0001&quot;</span>        <span class="token punctuation">\\</span>
    <span class="token parameter variable">--lr_scheduler</span><span class="token operator">=</span><span class="token string">&quot;constant&quot;</span> <span class="token parameter variable">--train_batch_size</span><span class="token operator">=</span><span class="token string">&quot;2&quot;</span>        <span class="token punctuation">\\</span>
    <span class="token parameter variable">--max_train_steps</span><span class="token operator">=</span><span class="token string">&quot;800&quot;</span> <span class="token parameter variable">--save_every_n_epochs</span><span class="token operator">=</span><span class="token string">&quot;1&quot;</span> <span class="token parameter variable">--mixed_precision</span><span class="token operator">=</span><span class="token string">&quot;bf16&quot;</span>    <span class="token punctuation">\\</span>
    <span class="token parameter variable">--save_precision</span><span class="token operator">=</span><span class="token string">&quot;bf16&quot;</span> <span class="token parameter variable">--seed</span><span class="token operator">=</span><span class="token string">&quot;1234&quot;</span> <span class="token parameter variable">--caption_extension</span><span class="token operator">=</span><span class="token string">&quot;.txt&quot;</span> <span class="token parameter variable">--cache_latents</span>     <span class="token punctuation">\\</span>
    <span class="token parameter variable">--optimizer_type</span><span class="token operator">=</span><span class="token string">&quot;AdamW8bit&quot;</span> <span class="token parameter variable">--max_data_loader_n_workers</span><span class="token operator">=</span><span class="token string">&quot;1&quot;</span> <span class="token parameter variable">--clip_skip</span><span class="token operator">=</span><span class="token number">2</span>     <span class="token punctuation">\\</span>
    <span class="token parameter variable">--bucket_reso_steps</span><span class="token operator">=</span><span class="token number">64</span> <span class="token parameter variable">--xformers</span> <span class="token parameter variable">--bucket_no_upscale</span> <span class="token parameter variable">--noise_offset</span><span class="token operator">=</span><span class="token number">0.0</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>个人在本地 4090 运行，整个训练过程大约耗时 90 秒，VRAM 占用 7GB。</p><h2 id="效果测试" tabindex="-1"><a class="header-anchor" href="#效果测试" aria-hidden="true">#</a> <strong>效果测试</strong></h2><p>我们将训练好的 lora 权重保存在 AUTO1111 的 lora 权重位置： stable-diffusion-webui/models/Lora 下，而后通过 AUTO1111 webui 来进行简单的生成测试。</p><p>以下是个人使用生成图片的配置：</p>`,5),R={href:"https://huggingface.co/SG161222/Realistic_Vision_V5.1_noVAE",target:"_blank",rel:"noopener noreferrer"},V={href:"https://huggingface.co/stabilityai/sd-vae-ft-mse-original/blob/main/vae-ft-mse-840000-ema-pruned.ckpt",target:"_blank",rel:"noopener noreferrer"},S=a("li",null,"sampling method 采用 DPM++ SDE Karras",-1),U=a("li",null,"Clip Skip=2，width=512, height=768",-1),D={href:"https://huggingface.co/SG161222/Realistic_Vision_V5.1_noVAE",target:"_blank",rel:"noopener noreferrer"},O=a("li",null,"prompt: RAW photo, subject, 8k uhd, dslr, soft lighting, high quality, film grain, Fujifilm XT3",-1),z=a("li",null,"negative prompt： (deformed iris, deformed pupils, semi-realistic, cgi, 3d, render, sketch, cartoon, drawing, anime), text, cropped, out of frame, worst quality, low quality, jpeg artifacts, ugly, duplicate, morbid, mutilated, extra fingers, mutated hands, poorly drawn hands, poorly drawn face, mutation, deformed, blurry, dehydrated, bad anatomy, bad proportions, extra limbs, cloned face, disfigured, gross proportions, malformed limbs, missing arms, missing legs, extra arms, extra legs, fused fingers, too many fingers, long neck, UnrealisticDream",-1),C=t('<p>个人在本地测试，使用 16 张图片训练的 lora，能够生成与训练集人物相似的形象照：</p><figure><img src="https://picx.zhimg.com/80/v2-98ca5adbf325dd1b024c6383d1352efb_1440w.png?source=d16d100b" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>生成照片还有一些瑕疵（比如手，头发等），可以考虑使用一些其他 lora 或者 embedding 来完善。</p><h2 id="妙鸭的一些想法" tabindex="-1"><a class="header-anchor" href="#妙鸭的一些想法" aria-hidden="true">#</a> <strong>妙鸭的一些想法</strong></h2><p>如果使用 SD + Lora 训练方案，搭建一个类似妙鸭的服务，那么根据实验的信息： <strong>在单卡 4090 上用 16 张图片训练 LORA，只需要 90 秒不到，并且生成效果不错。</strong></p><p>而其他的图像处理流程，如图像生成，超分，人脸匹配，目标检测等，加起来也不到 90 秒。 因此我们可以判断，用一台 4090，单独服务一个客户只需要 3 分钟即可，大致一小时可以服务 20 个客户。</p><p>参考网友贴出的秒鸭排队情况：</p><figure><img src="https://picx.zhimg.com/80/v2-252d0c495c4f93d5d47d7e7d187d08c4_1440w.png?source=d16d100b" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>如果秒鸭采用了 LORA 训练的方案实现的话，部署 16 台 4090 ，8 小时可以服务约 2560 人。每个用户的训练和推理成本约为 0.15 元（参考 GPU 市场租赁价格，如 AUTODL 或恒源云，一小时 4090 价格约 3 元）。由于训练 LORA 以及推理过程中，实际只需要 7GB 的显存，因此每台 4090 可以部署多个实例。</p><h2 id="资源" tabindex="-1"><a class="header-anchor" href="#资源" aria-hidden="true">#</a> <strong>资源</strong></h2><p>可以考虑叠加其他风格的 lora 生成不同类型的艺术照：</p>',11),E={href:"https://civitai.com/images/1931055?period=AllTime&periodMode=published&sort=Newest&view=categories&modelVersionId=113479&modelId=25494&postId=474886",target:"_blank",rel:"noopener noreferrer"},N={href:"https://civitai.com/images/2001799?period=AllTime&periodMode=published&sort=Newest&view=categories&modelVersionId=113479&modelId=25494&postId=492440",target:"_blank",rel:"noopener noreferrer"},M={href:"https://civitai.com/images/1599751?period=AllTime&periodMode=published&sort=Newest&view=categories&modelVersionId=117437&modelId=109018&postId=403858",target:"_blank",rel:"noopener noreferrer"},B={href:"https://civitai.com/models/108815",target:"_blank",rel:"noopener noreferrer"},G={href:"https://civitai.com/images/1344910?period=AllTime&periodMode=published&sort=Newest&view=categories&modelVersionId=95103&modelId=89348&postId=347211",target:"_blank",rel:"noopener noreferrer"},P={href:"https://civitai.com/models/89348",target:"_blank",rel:"noopener noreferrer"},W={href:"https://civitai.com/images/1662448?period=AllTime&periodMode=published&sort=Newest&view=categories&username=y_tamura&withTags=false",target:"_blank",rel:"noopener noreferrer"},j={href:"https://civitai.com/models/23337",target:"_blank",rel:"noopener noreferrer"},H={href:"https://civitai.com/models/43331?modelVersionId=126470",target:"_blank",rel:"noopener noreferrer"},X={href:"https://civitai.com/models/25494/beautiful-realistic-asians",target:"_blank",rel:"noopener noreferrer"},K=a("h2",{id:"参考",tabindex:"-1"},[a("a",{class:"header-anchor",href:"#参考","aria-hidden":"true"},"#"),e(),a("strong",null,"参考")],-1),F={href:"https://github.com/bmaltais/kohya_ss",target:"_blank",rel:"noopener noreferrer"},Y={href:"https://www.youtube.com/watch?v=N4_-fB62Hwk",target:"_blank",rel:"noopener noreferrer"},Z={href:"https://www.youtube.com/watch?v=k5imq01uvUY",target:"_blank",rel:"noopener noreferrer"},Q={href:"https://www.youtube.com/watch?v=TpuDOsuKIBo",target:"_blank",rel:"noopener noreferrer"},$={href:"https://youtu.be/AY6DMBCIZ3A",target:"_blank",rel:"noopener noreferrer"},J={href:"https://imgur.com/a/mrTteIt",target:"_blank",rel:"noopener noreferrer"};function aa(ea,sa){const s=o("ExternalLinkIcon");return i(),p("div",null,[c,d,a("p",null,[e("推荐使用现有的 GUI "),a("a",u,[e("AUTO1111/stable-diffusion-webui"),n(s)]),e(" 。安装指南可以参考官方仓库下的安装方案，或者其他网友笔记，比如 "),a("a",h,[e("AUTOMATIC1111/stable-diffusion-webui 安装教程_咔！哈！的博客-CSDN 博客"),n(s)]),e(" 。")]),m,a("p",null,[e("对于 lora 训练，图像像素最好在 （512，512）以上。对于像素低的照片，可以使用一些算法来对图像进行优化（细节优化，分辨率提升等），如 ESRGAN，LDSR，R-ESRGAN 4x+等。我们采用 R-ESRGAN 4x+ 对图像进行优化。可以使用 "),a("a",_,[e("AUTO1111"),n(s)]),e(" 中 EXTRA 一栏下的 scale 工具，一键对图像进行处理：")]),b,a("p",null,[e("以下使用 "),a("a",g,[e("kohya_ss "),n(s)]),e(" 脚本进行训练（"),a("a",k,[e("安装参考"),n(s)]),e("）。 kohya_ss 提供了"),a("a",f,[e("训练代码"),n(s)]),e("，但使用代码前，需要先将图像储存在对应文件夹内：")]),v,a("ul",null,[a("li",null,[e("pretrained_model_name_or_path：建议选择 "),a("a",w,[e("runwayml/stable-diffusion-v1-5"),n(s)]),e("。有个 trick，个人尝试，如果使用 "),a("a",x,[e("realisticVision checkpoint"),n(s)]),e(" 进行图片生成，在 realisticVision checkpoint 上微调的 lora，效果不如在 SD-1.5 上微调的，不确定是什么原因。")]),y,A,a("li",null,[e("learning_rate 及 lr_scheduler：学习率参考了 "),a("a",q,[e("How to Create a LoRA Part 2: Training the Model"),n(s)])]),T,I]),L,a("ul",null,[a("li",null,[e("checkpoint 使用 "),a("a",R,[e("realisticVision checkpoint"),n(s)]),e(" 的效果，会比使用 SD1.5 效果好很多（尽管我们的 lora 是在 SD1.5 上训练的）")]),a("li",null,[e("SD VAE 采用 "),a("a",V,[e("vae-ft-mse-840000-ema-pruned.ckpt"),n(s)])]),S,U,a("li",null,[e("prompt 中，可以通过改动 prompt 来修改图片风格，建议添加上 "),a("a",D,[e("realisticVision checkpoint"),n(s)]),e(" 推荐的 prompt：")]),O,z]),C,a("ol",null,[a("li",null,[e("日常风景照："),a("a",E,[e("海边"),n(s)]),e("，"),a("a",N,[e("花海"),n(s)]),e("， "),a("a",M,[e("都市"),n(s)]),e("，居家")]),a("li",null,[e("传统服饰："),a("a",B,[e("汉服"),n(s)]),e("，"),a("a",G,[e("古装照"),n(s)]),e("，"),a("a",P,[e("花想容/Chinese style/古风/中国風です Lora"),n(s)])]),a("li",null,[e("其他 cos："),a("a",W,[e("歌手"),n(s)]),e("，"),a("a",j,[e("赛博朋克"),n(s)])])]),a("p",null,[e("当使用 realisticVision 效果不佳时，可以考虑换一下 checkpoint 比如 "),a("a",H,[e("majicMIX"),n(s)]),e(" 或 "),a("a",X,[e("Beautiful Realistic Asians"),n(s)])]),K,a("p",null,[a("a",F,[e("kohya_ss"),n(s)])]),a("p",null,[a("a",Y,[e("How to Create a LoRA Part 1: Dataset Preparation"),n(s)])]),a("p",null,[a("a",Z,[e("How to Create a LoRA Part 2: Training the Model"),n(s)])]),a("p",null,[a("a",Q,[e("Generate Studio Quality Realistic Photos By Kohya LoRA Stable Diffusion Training"),n(s)]),e(":")]),a("p",null,[a("a",$,[e("First Ever SDXL Training With Kohya LoRA - Stable Diffusion XL Training Will Replace Older Models"),n(s)]),e(":")]),a("p",null,[a("a",J,[e("DO FINE-TUNING WITH LORA"),n(s)])])])}const ta=r(l,[["render",aa],["__file","笔记miaoya.html.vue"]]);export{ta as default};
