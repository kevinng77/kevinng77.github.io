import{_ as o}from"./plugin-vue_export-helper-c27b6911.js";import{r as p,o as t,c,a as s,b as n,d as l,f as e}from"./app-79a64b8b.js";const i={},r=s("h1",{id:"langchain",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#langchain","aria-hidden":"true"},"#"),n(" LangChain")],-1),d=s("p",null,"link: https://github.com/hwchase17/langchain",-1),y=s("p",null,"langchain 算是工程类的仓库，大模型应用的框架，提供了大模型和个人数据交互的框架，目前很多应用都有着和 langchain 非常相似的架构和目的，如 LLAMA INDEX，haystack， semantic-kernel 等。",-1),u={href:"https://python.langchain.com/en/latest/use_cases/personal_assistants.html",target:"_blank",rel:"noopener noreferrer"},m={href:"https://python.langchain.com/en/latest/use_cases/question_answering.html",target:"_blank",rel:"noopener noreferrer"},v=e(`<p>主要特点在于：</p><ul><li>支持异构数据输入</li><li>提供了各种 Plugin 的实现方案</li><li>支持除文本回复之外的反馈操作，如执行代码等。</li></ul><div class="hint-container warning"><p class="hint-container-title">注意</p><p>由于 LangChain 在快速更新截断，因此文中的示例代码，可能与源码存在差异。但大致上，框架的逻辑思路是相同的。</p></div><h2 id="源码框架梳理" tabindex="-1"><a class="header-anchor" href="#源码框架梳理" aria-hidden="true">#</a> 源码框架梳理</h2><h3 id="models" tabindex="-1"><a class="header-anchor" href="#models" aria-hidden="true">#</a> Models</h3><p>LangChain 中的模型相关代码较少，大部分主要是调用外部资源，如 OPENAI 或者 Huggingface 等模型/API。Model 模块下提供了 <code>llms</code>, <code>cache</code>, <code>embeddings</code> 等子模块。</p><h4 id="llms" tabindex="-1"><a class="header-anchor" href="#llms" aria-hidden="true">#</a> llms</h4><p>llms 用于输入 input 文本，输出文本回复。该模块保存了各种 llm 接口。</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> langchain </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> HuggingFacePipeline</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">llm </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> HuggingFacePipeline.from_model_id(</span><span style="color:#E36209;">model_id</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;bigscience/bloom-1b7&quot;</span><span style="color:#24292E;">, </span><span style="color:#E36209;">task</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;text-generation&quot;</span><span style="color:#24292E;">, </span><span style="color:#E36209;">model_kwargs</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">{</span><span style="color:#032F62;">&quot;temperature&quot;</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;max_length&quot;</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">64</span><span style="color:#24292E;">})</span></span>
<span class="line"></span>
<span class="line"><span style="color:#005CC5;">print</span><span style="color:#24292E;">(llm(</span><span style="color:#032F62;">&quot;Hello, what is apple?&quot;</span><span style="color:#24292E;">))</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container info"><p class="hint-container-title">相关信息</p><p>在 langchain 中自定义 LLM 的话，只需要重写 <code>_call()</code> 方法即可。使其接受一个字符串，输出一个字符串</p></div><h4 id="cache" tabindex="-1"><a class="header-anchor" href="#cache" aria-hidden="true">#</a> cache</h4><p>当用户对相同的问题进行提问时，如果配置了 cache 的话，回复会更快。</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> redis </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> Redis</span></span>
<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> langchain.cache </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> RedisCache</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">langchain.llm_cache </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> RedisCache(</span><span style="color:#E36209;">redis_</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">Redis())</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="embeddings" tabindex="-1"><a class="header-anchor" href="#embeddings" aria-hidden="true">#</a> embeddings</h4><p><code>embeddings</code> 输入文本，输出对应的 embedding。主要用于编码本地数据以及用户 query，以方便检索。langchain 整合了部分开箱即用的 embedding 服务，包括比较流行的 sentance Transformer 库：</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> langchain.embeddings </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> HuggingFaceEmbeddings, SentenceTransformerEmbeddings </span></span>
<span class="line"><span style="color:#24292E;">embeddings </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> HuggingFaceEmbeddings(</span><span style="color:#E36209;">model_name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;all-MiniLM-L6-v2&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">query_result </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> embeddings.embed_query(</span><span style="color:#032F62;">&quot;your text input&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">doc_result </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> embeddings.embed_documents([</span><span style="color:#032F62;">&quot;text input1&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;text input2.&quot;</span><span style="color:#24292E;">])</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="自定义-embedding" tabindex="-1"><a class="header-anchor" href="#自定义-embedding" aria-hidden="true">#</a> 自定义 Embedding</h5><p>如果需要使用自定义的模型进行编码的话，仅需重写 <code>embed_documents</code>， <code>embed_query</code> 两个方法即可</p><p>如 <code>embeddings.huggingface</code> 下的 <code>HuggingFaceEmbeddings</code>，使用 <code>sentence_transformers</code> 对文本进行编码，那么 <code>embed_documents</code>， <code>embed_query</code> 的实现方式为：</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6A737D;">#   self.client = sentence_transformers.SentenceTransformer(self.model_name)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">embed_documents</span><span style="color:#24292E;">(self, texts: List[</span><span style="color:#005CC5;">str</span><span style="color:#24292E;">]) -&gt; List[List[</span><span style="color:#005CC5;">float</span><span style="color:#24292E;">]]:</span></span>
<span class="line"><span style="color:#24292E;">    texts </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">list</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">map</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">lambda</span><span style="color:#24292E;"> x: x.replace(</span><span style="color:#032F62;">&quot;</span><span style="color:#005CC5;">\\n</span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot; &quot;</span><span style="color:#24292E;">), texts))</span></span>
<span class="line"><span style="color:#24292E;">    embeddings </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.client.encode(texts)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> embeddings.tolist()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">embed_query</span><span style="color:#24292E;">(self, text: </span><span style="color:#005CC5;">str</span><span style="color:#24292E;">) -&gt; List[</span><span style="color:#005CC5;">float</span><span style="color:#24292E;">]:</span></span>
<span class="line"><span style="color:#24292E;">    text </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> text.replace(</span><span style="color:#032F62;">&quot;</span><span style="color:#005CC5;">\\n</span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot; &quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    embedding </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.client.encode(text)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> embedding.tolist()</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="indexes-和-数据库" tabindex="-1"><a class="header-anchor" href="#indexes-和-数据库" aria-hidden="true">#</a> Indexes 和 数据库</h3><p>Langchain 提供好了 <code>index</code>, <code>document_store</code> 等模块，能够方便地进行数据库管理、异构数据处理、数据读写等操作。Indexes 主要用于数据检索。</p><h4 id="document-loaders" tabindex="-1"><a class="header-anchor" href="#document-loaders" aria-hidden="true">#</a> document_loaders</h4><p><code>document_loaders</code> 主要用于管理数据库元数据。提供了读写文件时候必要的方法，包括文件地址，文件读取方式，文件分段方式等。</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> langchain.document_loaders </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> TextLoader</span></span>
<span class="line"><span style="color:#24292E;">loader </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> TextLoader(</span><span style="color:#032F62;">&#39;./mydoc.txt&#39;</span><span style="color:#24292E;">, </span><span style="color:#E36209;">encoding</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;utf8&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>如上创建 loader 之后，loader 中储存了 <code>loader.file_path = &quot;./mydoc.txt&quot;</code> 等元数据。</p><h4 id="text-splitter" tabindex="-1"><a class="header-anchor" href="#text-splitter" aria-hidden="true">#</a> text splitter</h4><p>通常，我们需要对一整篇文章进行分段，才能方便我们对段落进行检索。langchain 提供了部分 splitter，可以针对 markdown，pdf 等进行分段。分段后的文章，会被储存成 <code>Document</code> 数据格式。</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#24292E;">markdown_splitter </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> MarkdownTextSplitter(</span><span style="color:#E36209;">chunk_size</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">100</span><span style="color:#24292E;">, </span><span style="color:#E36209;">chunk_overlap</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">mymdstr </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;&quot;### this is md content&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#6A737D;">## 可以使用 create_documents 从字符串列表直接获得 List[Documents]</span></span>
<span class="line"><span style="color:#24292E;">docs </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> markdown_splitter.create_documents([mymdstr])</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">## 也可以使用 split_documents() 为现有的 Documents 进行二次细分</span></span>
<span class="line"><span style="color:#24292E;">docs </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> markdown_splitter.split_documents(documents)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如上代码， <code>docs</code> 为 <code>List[Document]</code></p><h4 id="vectorstores" tabindex="-1"><a class="header-anchor" href="#vectorstores" aria-hidden="true">#</a> vectorstores</h4><p><code>vectorstores</code> 用于储存文档、数据及其对应 embedding 等信息的引擎。</p><p>比如，要将文档与对应的 embedding 储存与 ElasticSearch 当中，可以参考 <code>elastic_vector_search.py</code> 中的内容。几个比较常见的数据库以及 NLP 检索框架在 langchain 中都写好了对应的 vectorstores， 如 <code>redis</code>, <code>faiss</code>, <code>elasticsearch</code> 等。以下为使用 <code>FAISS</code> 进行相似文档检索的操作：</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> langchain.vectorstores </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">FAISS</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 可以更换自定义 Embedding</span></span>
<span class="line"><span style="color:#24292E;">embeddings </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> HuggingFaceEmbeddings(</span><span style="color:#E36209;">model_name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;all-MiniLM-L6-v2&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">db </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">FAISS</span><span style="color:#24292E;">.from_documents(docs, embeddings)</span></span>
<span class="line"><span style="color:#24292E;">query </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;What did the president say about Ketanji Brown Jackson&quot;</span></span>
<span class="line"><span style="color:#24292E;">similar_docs </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> db.similarity_search(query)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>要支持其他数据库的话，可以自定义 vectorstore 类。自定义的话需要继承 <code>base.VectorStore</code>，而后重写下面几个主要的功能函数即可：</p><ol><li><code>add_texts</code>, <code>from_texts</code>：往数据库中添加数据的一些操作</li><li><code>similarity_search</code>：从数据库中检索本文的一些操作。该操作自定义程度搞，如对于 <code>elastic search</code>， 可以将 <code>retrievers</code> 下的 <code>elastic_search_bm25</code> 召回，以及 <code>elastic_vector_search</code> 的精排结合使用，以进行性能调优。</li></ol><p>自定义 vectorstores 可以考虑参考 <code>vectorstores.redis</code> ，使用另个一类 <code>RedisVectorStoreRetriever</code>来负责数据的检索。</p><h3 id="chains" tabindex="-1"><a class="header-anchor" href="#chains" aria-hidden="true">#</a> chains</h3><p>Chain 的作用相当于 pipeline，主要将多个 LLM 模块和程序处理环节进行拼接，将复杂任务成应用。有点像 transformers 中的 pipeline。以下是基础的 LLMChain 示例：</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> langchain.chains </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> LLMChain</span></span>
<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> langchain.prompts </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> PromptTemplate</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">prompt </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> PromptTemplate(</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#E36209;">input_variables</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">[</span><span style="color:#032F62;">&quot;thing&quot;</span><span style="color:#24292E;">],</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#E36209;">template</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;Hello, what is </span><span style="color:#005CC5;">{thing}</span><span style="color:#032F62;">?&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">mychain </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> LLMChain(</span><span style="color:#E36209;">llm</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">llm, </span><span style="color:#E36209;">prompt</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">prompt, </span><span style="color:#E36209;">verbose</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">True</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#005CC5;">print</span><span style="color:#24292E;">(mychain.run(</span><span style="color:#032F62;">&quot;banana&quot;</span><span style="color:#24292E;">))</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>以上示例对输入进行 <strong>模板填充</strong> ，而后进行 <strong>LLM 推理</strong> ，将答案整理并返回给用户。Chain 之间能够相互组合：</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> langchain.chains </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> SimpleSequentialChain</span></span>
<span class="line"><span style="color:#24292E;">overall_chain </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> SimpleSequentialChain(</span><span style="color:#E36209;">chains</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">[chain, chain_two], </span><span style="color:#E36209;">verbose</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">True</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Run the chain specifying only the input variable for the first chain.</span></span>
<span class="line"><span style="color:#24292E;">catchphrase </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> overall_chain.run(</span><span style="color:#032F62;">&quot;colorful socks&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,42),h={href:"https://python.langchain.com/en/latest/modules/chains/how_to_guides.html",target:"_blank",rel:"noopener noreferrer"},b=s("code",null,"chains.__init__",-1),E=e(`<ol><li><code>ChatVectorDBChain</code>：从 vectorstore 检索和 query 最相近的 k 条文档；而后根据这些文档生成回复。</li><li><code>LLMBashChain</code>：先通过 <code>LLMChain</code> 对 query 生成回复，如果回复中包含了 \`\`\`\`bash\` 字样，则执行对应位置的代码。</li><li><code>LLMMathChain</code>：首先让 LLM 将需要数学计算的部分用 \`\`\`\`python\` 进行标注，而后通过 python 进行对应的数学计算返回结果。</li><li><code>SQLDatabaseChain</code>：先用 LLM 解析 query，输出 sql；用 sql database 执行 sql 语句，抽取回复 query 时需要用到的数据；根据检索的数据，将结果返回给用户。对于这种 chain，以下是一个可以参考的 prompt：</li></ol><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#032F62;">&quot;&quot;&quot;Given an input question, first create a syntactically correct {dialect} query to run, then look at the results of the query and return the answer. Unless the user specifies in his question a specific number of examples he wishes to obtain, always limit your query to at most {top_k} results. You can order the results by a relevant column to return the most interesting examples in the database.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">Never query for all the columns from a specific table, only ask for a the few relevant columns given the question.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">Pay attention to use only the column names that you can see in the schema description. Be careful to not query for columns that do not exist. Also, pay attention to which column is in which table.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">Use the following format:</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">Question: &quot;Question here&quot;</span></span>
<span class="line"><span style="color:#032F62;">SQLQuery: &quot;SQL Query to run&quot;</span></span>
<span class="line"><span style="color:#032F62;">SQLResult: &quot;Result of the SQLQuery&quot;</span></span>
<span class="line"><span style="color:#032F62;">Answer: &quot;Final answer here&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">Only use the tables listed below.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">{table_info}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">Question: {input}&quot;&quot;&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>自定义 chain 需要重写下面三种方法：</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> langchain.chains </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> LLMChain</span></span>
<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> langchain.chains.base </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> Chain</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> typing </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> Dict, List</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ConcatenateChain</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">Chain</span><span style="color:#24292E;">):</span></span>
<span class="line"><span style="color:#24292E;">    chain_1: LLMChain</span></span>
<span class="line"><span style="color:#24292E;">    chain_2: LLMChain</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">@</span><span style="color:#005CC5;">property</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">input_keys</span><span style="color:#24292E;">(self) -&gt; List[</span><span style="color:#005CC5;">str</span><span style="color:#24292E;">]:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;"># Union of the input keys of the two chains.</span></span>
<span class="line"><span style="color:#24292E;">        all_input_vars </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.chain_1.input_keys).union(</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.chain_2.input_keys))</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">list</span><span style="color:#24292E;">(all_input_vars)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">@</span><span style="color:#005CC5;">property</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">output_keys</span><span style="color:#24292E;">(self) -&gt; List[</span><span style="color:#005CC5;">str</span><span style="color:#24292E;">]:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> [</span><span style="color:#032F62;">&#39;concat_output&#39;</span><span style="color:#24292E;">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">_call</span><span style="color:#24292E;">(self, inputs: Dict[</span><span style="color:#005CC5;">str</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">str</span><span style="color:#24292E;">]) -&gt; Dict[</span><span style="color:#005CC5;">str</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">str</span><span style="color:#24292E;">]:</span></span>
<span class="line"><span style="color:#24292E;">        output_1 </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.chain_1.run(inputs)</span></span>
<span class="line"><span style="color:#24292E;">        output_2 </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.chain_2.run(inputs)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> {</span><span style="color:#032F62;">&#39;concat_output&#39;</span><span style="color:#24292E;">: output_1 </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> output_2}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="agent" tabindex="-1"><a class="header-anchor" href="#agent" aria-hidden="true">#</a> Agent</h3><p>Agent 是 AI 的一个关键概念。Agent 能够根据不同的问题，决定要执行哪一个 chain。以下是一个基础 agent 的调用示例。</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> langchain.agents </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> load_tools</span></span>
<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> langchain.agents </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> initialize_agent</span></span>
<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> langchain.agents </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> AgentType</span></span>
<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> langchain.llms </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> OpenAI</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">llm </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> OpenAI(</span><span style="color:#E36209;">temperature</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">tools </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> load_tools([</span><span style="color:#032F62;">&quot;serpapi&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;llm-math&quot;</span><span style="color:#24292E;">], </span><span style="color:#E36209;">llm</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">llm)</span></span>
<span class="line"><span style="color:#24292E;">agent </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> initialize_agent(tools, llm, </span><span style="color:#E36209;">agent</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">AgentType.</span><span style="color:#005CC5;">ZERO_SHOT_REACT_DESCRIPTION</span><span style="color:#24292E;">, </span><span style="color:#E36209;">verbose</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">True</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">agent.run(</span><span style="color:#032F62;">&quot;Who is Leo DiCaprio&#39;s girlfriend? What is her current age raised to the 0.43 power?&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>以下是上面这串代码执行后的结果：</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> Entering new AgentExecutor chain</span><span style="color:#005CC5;">...</span></span>
<span class="line"><span style="color:#24292E;"> I need to find out who Leo DiCaprio</span><span style="color:#032F62;">&#39;s girlfriend is and then calculate her age raised to the 0.43 power.</span></span>
<span class="line"><span style="color:#24292E;">Action: Search</span></span>
<span class="line"><span style="color:#24292E;">Action Input: </span><span style="color:#032F62;">&quot;Leo DiCaprio girlfriend&quot;</span></span>
<span class="line"><span style="color:#24292E;">Observation: Camila Morrone</span></span>
<span class="line"><span style="color:#24292E;">Thought: I need to find out Camila Morrone</span><span style="color:#032F62;">&#39;s age</span></span>
<span class="line"><span style="color:#24292E;">Action: Search</span></span>
<span class="line"><span style="color:#24292E;">Action Input: </span><span style="color:#032F62;">&quot;Camila Morrone age&quot;</span></span>
<span class="line"><span style="color:#24292E;">Observation: </span><span style="color:#005CC5;">25</span><span style="color:#24292E;"> years</span></span>
<span class="line"><span style="color:#24292E;">Thought: I need to calculate </span><span style="color:#005CC5;">25</span><span style="color:#24292E;"> raised to the </span><span style="color:#005CC5;">0.43</span><span style="color:#24292E;"> power</span></span>
<span class="line"><span style="color:#24292E;">Action: Calculator</span></span>
<span class="line"><span style="color:#24292E;">Action Input: </span><span style="color:#005CC5;">25</span><span style="color:#D73A49;">^</span><span style="color:#005CC5;">0.43</span></span>
<span class="line"><span style="color:#24292E;">Observation: Answer: </span><span style="color:#005CC5;">3.991298452658078</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">Thought: I now know the final answer</span></span>
<span class="line"><span style="color:#24292E;">Final Answer: Camila Morrone </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> Leo DiCaprio</span><span style="color:#032F62;">&#39;s girlfriend and her current age raised to the 0.43 power is 3.991298452658078.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> Finished chain.</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="agent-单元" tabindex="-1"><a class="header-anchor" href="#agent-单元" aria-hidden="true">#</a> Agent 单元</h4><p>一个 Agent 单元负责执行一次任务。如 langchain 中的 <code>langchain.agents.agent.Agent</code></p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Agent</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">BaseSingleActionAgent</span><span style="color:#24292E;">):</span></span>
<span class="line"><span style="color:#24292E;">    llm_chain: LLMChain</span></span>
<span class="line"><span style="color:#24292E;">    allowed_tools: Optional[List[</span><span style="color:#005CC5;">str</span><span style="color:#24292E;">]] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">None</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>agent 的执行功能在于 <code>Agent.plan()</code>：</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">plan</span><span style="color:#24292E;">(intermediate_steps: List[Tuple[AgentAction, </span><span style="color:#005CC5;">str</span><span style="color:#24292E;">]], </span><span style="color:#D73A49;">**</span><span style="color:#24292E;">kwargs) :   </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># 将各种异构的历史信息转换成 inputs，传入到 LLM 当中</span></span>
<span class="line"><span style="color:#24292E;">    thoughts </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> action, observation </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> intermediate_steps:</span></span>
<span class="line"><span style="color:#24292E;">            thoughts </span><span style="color:#D73A49;">+=</span><span style="color:#24292E;"> action.log</span></span>
<span class="line"><span style="color:#24292E;">            thoughts </span><span style="color:#D73A49;">+=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">f</span><span style="color:#032F62;">&quot;</span><span style="color:#005CC5;">\\n{self</span><span style="color:#24292E;">.observation_prefix</span><span style="color:#005CC5;">}{</span><span style="color:#24292E;">observation</span><span style="color:#005CC5;">}\\n{self</span><span style="color:#24292E;">.llm_prefix</span><span style="color:#005CC5;">}</span><span style="color:#032F62;">&quot;</span></span>
<span class="line"><span style="color:#24292E;">            </span></span>
<span class="line"><span style="color:#24292E;">    full_input </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> {</span><span style="color:#032F62;">&quot;agent_scratchpad&quot;</span><span style="color:#24292E;">: thoughts, </span><span style="color:#032F62;">&quot;stop&quot;</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">._stop, </span><span style="color:#D73A49;">**</span><span style="color:#24292E;">kwargs}  </span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># 根据 LLM 生成的反馈，采取决策</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">## prompt template: &quot;your input xx {other prompt slot} xx, {agent_scratchpad}&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">## full_output: LLM 输出的回复，字符串形式</span></span>
<span class="line"><span style="color:#24292E;">    full_output </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.llm_chain.predict(</span><span style="color:#D73A49;">**</span><span style="color:#24292E;">full_inputs)</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">    parsed_output </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">._extract_tool_and_input(full_output)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">while</span><span style="color:#24292E;"> parsed_output </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">None</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        full_output </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">._fix_text(full_output)</span></span>
<span class="line"><span style="color:#24292E;">        full_inputs[</span><span style="color:#032F62;">&quot;agent_scratchpad&quot;</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">+=</span><span style="color:#24292E;"> full_output</span></span>
<span class="line"><span style="color:#24292E;">        output </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.llm_chain.predict(</span><span style="color:#D73A49;">**</span><span style="color:#24292E;">full_inputs)</span></span>
<span class="line"><span style="color:#24292E;">        full_output </span><span style="color:#D73A49;">+=</span><span style="color:#24292E;"> output</span></span>
<span class="line"><span style="color:#24292E;">        parsed_output </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">._extract_tool_and_input(full_output)</span></span>
<span class="line"><span style="color:#24292E;">        </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># 或者返回 AgentFinish({&quot;output&quot;: action.tool_input}, action.log)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> AgentAction(</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#E36209;">tool</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">parsed_output[</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">], </span><span style="color:#E36209;">tool_input</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">parsed_output[</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">], </span><span style="color:#E36209;">log</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">full_output</span></span>
<span class="line"><span style="color:#24292E;">        )</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对于 Agent，能够从历史操作中获取信息，并根据目的做出决策是很重要的。对于 Langchain 的 Agent，我们解析他的 <code>.plan()</code> 方法：</p><p><code>.plan()</code> 的参数有 <code>intermediate_steps</code> 和 <code>**kwargs</code>，前者保存了 agent 之前做过的一些行为。后者通常会储存 agent 的目标，如用户提出的 query 等。</p><p><code>.plan()</code> 可以看做两步：</p><ol><li>将各种异构的历史信息转换成 inputs，传入到 LLM 当中；对于 Langchain，其做法就是简单的将 <code>intermediate_steps</code> 中的 action 日志和 <code>observation</code> 进行拼接，而后统一放在 <code>inputs</code> 后面。在 langchain 的 prompt template 当中，经常会看到 <code>agent_scratchpad</code> 的填充字段，它就是用来放历史信息的。</li><li>根据 LLM 生成的反馈，采取决策。LLM 生成的回复是 string 格式，我们会将回复出来的 <code>full_output</code> 在 <code>_extract_tool_and_input</code> 中进行处理。一个例子就是 <code>agents.mrkl.base.get_action_and_tool()</code>。</li></ol><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">get_action_and_input</span><span style="color:#24292E;">(llm_output: </span><span style="color:#005CC5;">str</span><span style="color:#24292E;">) -&gt; Tuple[</span><span style="color:#005CC5;">str</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">str</span><span style="color:#24292E;">]:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;&quot;&quot;Parse out the action and input from the LLM output.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">    Note: if you&#39;re specifying a custom prompt for the ZeroShotAgent,</span></span>
<span class="line"><span style="color:#032F62;">    you will need to ensure that it meets the following Regex requirements.</span></span>
<span class="line"><span style="color:#032F62;">    The string starting with &quot;Action:&quot; and the following string starting</span></span>
<span class="line"><span style="color:#032F62;">    with &quot;Action Input:&quot; should be separated by a newline.</span></span>
<span class="line"><span style="color:#032F62;">    &quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">FINAL_ANSWER_ACTION</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> llm_output:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;Final Answer&quot;</span><span style="color:#24292E;">, llm_output.split(</span><span style="color:#005CC5;">FINAL_ANSWER_ACTION</span><span style="color:#24292E;">)[</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">].strip()</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># \\s matches against tab/newline/whitespace</span></span>
<span class="line"><span style="color:#24292E;">    regex </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">r</span><span style="color:#032F62;">&quot;Action: </span><span style="color:#005CC5;">(.</span><span style="color:#D73A49;">*?</span><span style="color:#005CC5;">)[</span><span style="color:#22863A;font-weight:bold;">\\n</span><span style="color:#005CC5;">]</span><span style="color:#D73A49;">*</span><span style="color:#032F62;">Action Input:</span><span style="color:#005CC5;">[\\s]</span><span style="color:#D73A49;">*</span><span style="color:#005CC5;">(.</span><span style="color:#D73A49;">*</span><span style="color:#005CC5;">)</span><span style="color:#032F62;">&quot;</span></span>
<span class="line"><span style="color:#24292E;">    match </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> re.search(regex, llm_output, re.</span><span style="color:#005CC5;">DOTALL</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> match:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">raise</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ValueError</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">f</span><span style="color:#032F62;">&quot;Could not parse LLM output: \`</span><span style="color:#005CC5;">{</span><span style="color:#24292E;">llm_output</span><span style="color:#005CC5;">}</span><span style="color:#032F62;">\`&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    action </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> match.group(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">).strip()</span></span>
<span class="line"><span style="color:#24292E;">    action_input </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> match.group(</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> action, action_input.strip(</span><span style="color:#032F62;">&quot; &quot;</span><span style="color:#24292E;">).strip(</span><span style="color:#032F62;">&#39;&quot;&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到，langchain 中<code>ZeroShotAgent</code> 通过字符串匹配的方式来识别 action。因此，agent 能否正常运行，与 prompt 格式，以及 LLM 的 ICL 以及 alignment 能力有着很大的关系。</p><div class="hint-container info"><p class="hint-container-title">相关信息</p><p>最后的输出 <code>AgentAction</code> 中会包括：需要使用的 tool，使用该 tool 时候，对应的执行命令。可以使用的 tool 会在 prompt template 中提示出来，比如如果你采用 <code>create_pandas_dataframe_agent</code> 构造了一个 agent，那么它的 prompt template 就会编程：</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#032F62;">&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#032F62;">You are working with a pandas dataframe in Python. The name of the dataframe is \`df\`.</span></span>
<span class="line"><span style="color:#032F62;">You should use the tools below to answer the question posed of you:</span></span>
<span class="line"><span style="color:#032F62;">python_repl_ast</span></span>
<span class="line"><span style="color:#032F62;">A Python shell. Use this to execute python commands. &quot;</span></span>
<span class="line"><span style="color:#032F62;">        &quot;Input should be a valid python command. &quot;</span></span>
<span class="line"><span style="color:#032F62;">        &quot;When using this tool, sometimes output is abbreviated - &quot;</span></span>
<span class="line"><span style="color:#032F62;">        &quot;make sure it does not look abbreviated before using it in your answer.&quot;</span></span>
<span class="line"><span style="color:#032F62;">This is the result of \`print(df.head())\`:</span></span>
<span class="line"><span style="color:#032F62;">Begin!</span></span>
<span class="line"><span style="color:#032F62;">Question: {input}</span></span>
<span class="line"><span style="color:#032F62;">{agent_scratchpad}</span></span>
<span class="line"><span style="color:#032F62;">&quot;&quot;&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><h4 id="agentexecutor" tabindex="-1"><a class="header-anchor" href="#agentexecutor" aria-hidden="true">#</a> AgentExecutor</h4><p>不论是通过 <code>initialize_agent</code> 或者是 <code>create_pandas_dataframe_agent</code> 等方式，我们都可以得到 <code>AgentExecutor</code> 来执行 agent 相关的任务。</p><p><code>AgentExecutor</code> 实际上是一个 <code>Chain</code>，可以通过 <code>.run()</code> 或者 <code>_call()</code> 来调用。如：</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#24292E;">agent_executor </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> create_pandas_dataframe_agent(</span><span style="color:#E36209;">llm</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">llm, </span><span style="color:#E36209;">df</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">df)</span></span>
<span class="line"><span style="color:#24292E;">agent_executor.run(</span><span style="color:#032F62;">&quot;how many rows are there?&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><code>agent_executor.run()</code> 通过迭代地执行 agent</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#24292E;">intermediate_steps </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> [] </span><span style="color:#6A737D;"># List[(AgentAction, str)]</span></span>
<span class="line"><span style="color:#6A737D;"># 其中 str 为 oservation，是每次迭代后，我们调用 tool 得到的结果。</span></span>
<span class="line"><span style="color:#24292E;">agent_action </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.agent.plan(</span></span>
<span class="line"><span style="color:#24292E;">                intermediate_steps,</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">**</span><span style="color:#24292E;">inputs)</span></span>
<span class="line"><span style="color:#6A737D;"># inputs 是一个用于填充 prompt.format 的字典，参考 prompts 部分。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">for</span><span style="color:#24292E;"> agent_action </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> actions:</span></span>
<span class="line"><span style="color:#24292E;">	tools2run </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> name_to_tool_map[agent_action.tool]</span></span>
<span class="line"><span style="color:#24292E;">    observation </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> tool.run(agent_action.tool_input, </span><span style="color:#D73A49;">**</span><span style="color:#24292E;">tool_run_kwargs,)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">intermediate_steps.append([agent_action, observation])</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>因此，结合上面 Agent 部分的 <code>plan</code>，我们就可以理解 langchain 中 Agent 执行的大致逻辑。</p><h3 id="prompts" tabindex="-1"><a class="header-anchor" href="#prompts" aria-hidden="true">#</a> Prompts</h3><p>Langchain 当中，定义好了不同的 Prompt template，以面对不同的用户提问，prompt template 应该与模型绑定。Prompts 模块当中也提供了 example selector，方便用户进行 few shot 选择。</p><h3 id="callback" tabindex="-1"><a class="header-anchor" href="#callback" aria-hidden="true">#</a> Callback</h3><p>可以在各个环节对你的 LLM 应用进行监控， callback 可以用于各个环节，如 Chain 开始，Chain 结束，LLM 开始， LLM 出错，接受到新的 Token 等等。</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> langchain.callbacks </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> StdOutCallbackHandler</span></span>
<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> langchain.chains </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> LLMChain</span></span>
<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> langchain.llms </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> OpenAI</span></span>
<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> langchain.prompts </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> PromptTemplate</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">handler </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> StdOutCallbackHandler()</span></span>
<span class="line"><span style="color:#24292E;">llm </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> OpenAI()</span></span>
<span class="line"><span style="color:#24292E;">prompt </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> PromptTemplate.from_template(</span><span style="color:#032F62;">&quot;1 + </span><span style="color:#005CC5;">{number}</span><span style="color:#032F62;"> = &quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># First, let&#39;s explicitly set the StdOutCallbackHandler in \`callbacks\`</span></span>
<span class="line"><span style="color:#24292E;">chain </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> LLMChain(</span><span style="color:#E36209;">llm</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">llm, </span><span style="color:#E36209;">prompt</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">prompt, </span><span style="color:#E36209;">callbacks</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">[handler])</span></span>
<span class="line"><span style="color:#24292E;">chain.run(</span><span style="color:#E36209;">number</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>自定义 callback 需要实现 <code>langchain.callbacks.base.BaseCallBackHandler</code> 中的接口。</p><h3 id="other-utils" tabindex="-1"><a class="header-anchor" href="#other-utils" aria-hidden="true">#</a> Other Utils</h3><h4 id="output-parser" tabindex="-1"><a class="header-anchor" href="#output-parser" aria-hidden="true">#</a> Output Parser</h4><h4 id="api-工具" tabindex="-1"><a class="header-anchor" href="#api-工具" aria-hidden="true">#</a> API 工具</h4><p>在 <code>tools</code> 目录下，可以看到各种适配 Plugin 等插件。支持通过 python 运行各种脚本、调用各类 API 。</p>`,38);function g(A,f){const a=p("ExternalLinkIcon");return t(),c("div",null,[r,d,y,s("p",null,[n("主要的应用场景有："),s("a",u,[n("私人助理"),l(a)]),n(" ，"),s("a",m,[n("问答系统"),l(a)]),n(" 等。")]),v,s("p",null,[s("a",h,[n("官方文档"),l(a)]),n(" 中有部分 chain 的示例代码，在源码 "),b,n(" 中可以查看到所有默认的 chain。一些比较有意思的 chain：")]),E])}const D=o(i,[["render",g],["__file","笔记langchain.html.vue"]]);export{D as default};
