import{_ as e,E as o,S as c,W as u,$ as n,a3 as s,Z as t,aS as p}from"./framework-d5c0d2cb.js";const l={},i=n("h3",{id:"h5df-简介",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#h5df-简介","aria-hidden":"true"},"#"),s(" H5DF 简介")],-1),r={href:"https://docs.h5py.org/en/stable/high/dataset.html#creating-datasets",target:"_blank",rel:"noopener noreferrer"},d=p(`<div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>conda <span class="token function">install</span> h5py
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="file" tabindex="-1"><a class="header-anchor" href="#file" aria-hidden="true">#</a> File</h4><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code>f <span class="token operator">=</span> h5py<span class="token punctuation">.</span>File<span class="token punctuation">(</span><span class="token string">&#39;myfile.hdf5&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;w&#39;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>文件模式 <code>w/a/r</code>等于 python io 类似。同时 H5PY 还提供了 SWMR 接口，可以实现但进程写入的同时多进程读取。此外，文件还提供不同的 driver 形式，已针对不同的数据场景：</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code>f <span class="token operator">=</span> h5py<span class="token punctuation">.</span>File<span class="token punctuation">(</span><span class="token string">&#39;myfile.hdf5&#39;</span><span class="token punctuation">,</span> driver<span class="token operator">=</span><span class="token operator">&lt;</span>driver name<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>driver_kwds<span class="token operator">&gt;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>使用结束后需要关闭：<code>f.close()</code>。对于一次性读取的可以使用 <code>with h5py.File() as fp:</code></p><h4 id="group" tabindex="-1"><a class="header-anchor" href="#group" aria-hidden="true">#</a> Group</h4><p>group 的功能类似于菜单，Group 下面可以储存 Group 和 dataset 类型数据。</p><p>创建组对象：</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code>grp <span class="token operator">=</span> f<span class="token punctuation">.</span>create_group<span class="token punctuation">(</span><span class="token string">&quot;bar&quot;</span><span class="token punctuation">)</span>
grp<span class="token punctuation">.</span>name  <span class="token comment"># &#39;/bar&#39;</span>
subgrp <span class="token operator">=</span> grp<span class="token punctuation">.</span>create_group<span class="token punctuation">(</span><span class="token string">&quot;baz&quot;</span><span class="token punctuation">)</span>
subgrp<span class="token punctuation">.</span>name  <span class="token comment"># &#39;/bar/baz&#39;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>引用组对象：</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code>grp3 <span class="token operator">=</span> f<span class="token punctuation">[</span><span class="token string">&#39;/some/long&#39;</span><span class="token punctuation">]</span>
grp3<span class="token punctuation">.</span>name  <span class="token comment"># &#39;/some/long&#39;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>可以采用 <code>keys()</code>, <code>values()</code> 遍历对象。但是更推荐使用 <code>group.visit()</code> 或 <code>group.visititems()</code>。</p><p><code>group.get()</code> 类似于字典的 <code>get</code>。判断某个 group 是否存在可以尝试使用：<code>if f[&#39;group_name&#39;]</code>，但部分 H5PY 版本不支持。</p><h4 id="datasets" tabindex="-1"><a class="header-anchor" href="#datasets" aria-hidden="true">#</a> Datasets</h4><p>h5py dataset 中的数据 API 与 numpy 类似。</p><p>创建 DATASET，必须指定 dataset 的 <code>name</code>, <code>shape</code>, <code>dtype</code>。默认的<code>dtype</code> 是 <code>f</code>。（除非创建 Empty dataset）</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code>dset <span class="token operator">=</span> f<span class="token punctuation">.</span>create_dataset<span class="token punctuation">(</span><span class="token string">&quot;ints&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span><span class="token string">&#39;i8&#39;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h5 id="dataset-导入数据" tabindex="-1"><a class="header-anchor" href="#dataset-导入数据" aria-hidden="true">#</a> dataset 导入数据</h5><p>创建时候导入</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code>arr <span class="token operator">=</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
dset <span class="token operator">=</span> f<span class="token punctuation">.</span>create_dataset<span class="token punctuation">(</span><span class="token string">&quot;init&quot;</span><span class="token punctuation">,</span> data<span class="token operator">=</span>arr<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>对以有 dataset 导入：</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code>dset<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">3.0</span>  <span class="token comment"># print(dset[0, 1])</span>
dset<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">=</span> other_data
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="dataset-引用数据" tabindex="-1"><a class="header-anchor" href="#dataset-引用数据" aria-hidden="true">#</a> dataset 引用数据</h5><p>注意：不能使用 numpy 中的双层索引，如<code>dset[0][3]</code></p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code>dset <span class="token operator">=</span> f<span class="token punctuation">.</span>create_dataset<span class="token punctuation">(</span><span class="token string">&quot;MyDataset&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&#39;f&#39;</span><span class="token punctuation">)</span>
dset<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span>
dset<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">9</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span>
dset<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span>
dset<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
dset<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span>
dset<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
dset<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">]</span>
dset<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果要遍历 dataset 的话，采用 <code>dataset.len()</code> 代替 <code>len(dataset)</code></p><h4 id="chunked" tabindex="-1"><a class="header-anchor" href="#chunked" aria-hidden="true">#</a> chunked</h4><p>默认 h5df dataset 采用连续空间存储。但可以采用 chunks 来指定数据存储的连续性。如下：</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code>dset <span class="token operator">=</span> f<span class="token punctuation">.</span>create_dataset<span class="token punctuation">(</span><span class="token string">&quot;chunked&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">,</span> chunks<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>案例中表示 <code>dset[0:100,0:100]</code>, <code>dset[200:300, 400:500]</code> 将被储存再连续空间。官方建议设置 chunk 块大小为 10kb - 1MB。chunked 的特点就是，当 chunked 中的一个数据被读取的时候，整个 chunked 的数据都会被读取。可以让 h5df 自动设置 chunk 的大小。</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code>dset <span class="token operator">=</span> f<span class="token punctuation">.</span>create_dataset<span class="token punctuation">(</span><span class="token string">&quot;autochunk&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">,</span> chunks<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>如对于深度学习，你可能希望将 chunks 手动设置为每个 samples 的大小，这样会比让系统自动设置快很多。（个人测试最快时候可以差 10 倍读取速度）</p><h4 id="resizable-dataset" tabindex="-1"><a class="header-anchor" href="#resizable-dataset" aria-hidden="true">#</a> resizable dataset</h4><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code>dset <span class="token operator">=</span> f<span class="token punctuation">.</span>create_dataset<span class="token punctuation">(</span><span class="token string">&quot;unlimited&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> maxshape<span class="token operator">=</span><span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>需要注意的是 resize 不是像 numpy 的 reshape，缩小维度上的数据会被直接丢弃掉</p><h4 id="compression" tabindex="-1"><a class="header-anchor" href="#compression" aria-hidden="true">#</a> compression</h4><p>compression 压缩有时候甚至可以提高读取的速度！压缩可以选择不同的方式，以及不同的等级。</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code>df<span class="token punctuation">.</span>create_dataset<span class="token punctuation">(</span>dset_name<span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">,</span> maxshape<span class="token operator">=</span><span class="token builtin">tuple</span><span class="token punctuation">(</span>shape_list<span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span><span class="token string">&#39;int64&#39;</span><span class="token punctuation">,</span>
                          chunks<span class="token operator">=</span><span class="token builtin">tuple</span><span class="token punctuation">(</span>data_shapes<span class="token punctuation">[</span>dset_name<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> compression<span class="token operator">=</span><span class="token string">&quot;gzip&quot;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="attibute" tabindex="-1"><a class="header-anchor" href="#attibute" aria-hidden="true">#</a> Attibute</h4><p>向 group 或者 dataset 添加 attibute。通常为 64kb 以下的小数据</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code>dset<span class="token punctuation">.</span>attrs<span class="token punctuation">[</span><span class="token string">&quot;myAttr1&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">]</span>
dset<span class="token punctuation">.</span>attrs<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;myAttr1&quot;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="其他" tabindex="-1"><a class="header-anchor" href="#其他" aria-hidden="true">#</a> 其他</h4><p>对于字符串内容，需要定义特殊类型</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code>f <span class="token operator">=</span> h5py<span class="token punctuation">.</span>File<span class="token punctuation">(</span><span class="token string">&#39;foo.hdf5&#39;</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> dt <span class="token operator">=</span> h5py<span class="token punctuation">.</span>string_dtype<span class="token punctuation">(</span>encoding<span class="token operator">=</span><span class="token string">&#39;utf-8&#39;</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> ds <span class="token operator">=</span> f<span class="token punctuation">.</span>create_dataset<span class="token punctuation">(</span><span class="token string">&#39;VLDS&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>dt<span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> ds<span class="token punctuation">.</span>dtype<span class="token punctuation">.</span>kind
<span class="token string">&#39;O&#39;</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> h5py<span class="token punctuation">.</span>check_string_dtype<span class="token punctuation">(</span>ds<span class="token punctuation">.</span>dtype<span class="token punctuation">)</span>
string_info<span class="token punctuation">(</span>encoding<span class="token operator">=</span><span class="token string">&#39;utf-8&#39;</span><span class="token punctuation">,</span> length<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,45),k=n("li",null,[n("p",null,"顺序读取 h5df 数据库的速度会比随机读取快很多！快将近 40%")],-1),m=n("li",null,[n("p",null,[s("使用 H5DF 配合 dataloader 的时候，建议添加 dataloader "),n("code",null,"num_workers > 0"),s("，个人测试可以提升最高 5%的训练速度。")])],-1),h=n("li",null,[n("p",null,"如果需要 shuffle 的话，建议同时使用 batchsampler，因为 h5df 的随机访问效率能够被提高。")],-1),v={href:"https://discuss.pytorch.org/t/dataloader-when-num-worker-0-there-is-bug/25643/14",target:"_blank",rel:"noopener noreferrer"},b=p(`<li><p>group 的访问也是需要时间的（命名空间上的搜索需要花费大量时间），因此如果要遍历 dataset 的话，最好直接采用变量引用到 dataset，而非在 group 基础上使用 group[&#39;dset&#39;] 来遍历。如：</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token comment"># 建议这样写，节省命名空间搜索</span>
self<span class="token punctuation">.</span>feature_dataset <span class="token operator">=</span> h5py<span class="token punctuation">.</span>File<span class="token punctuation">(</span>self<span class="token punctuation">.</span>h5df_path<span class="token punctuation">,</span> <span class="token string">&#39;r&#39;</span><span class="token punctuation">,</span> swmr<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">[</span>feature_group_name<span class="token punctuation">]</span>
features <span class="token operator">=</span> self<span class="token punctuation">.</span>feature_dataset<span class="token punctuation">[</span>self<span class="token punctuation">.</span>sample_ids<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">]</span>
data <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">&#39;input_ids&#39;</span><span class="token punctuation">:</span> features<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">&#39;input_mask&#39;</span><span class="token punctuation">:</span> features<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">&#39;segment_ids&#39;</span><span class="token punctuation">:</span> features<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上面方式会比下面方式速度快很多：</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code>self<span class="token punctuation">.</span>dataset <span class="token operator">=</span> h5py<span class="token punctuation">.</span>File<span class="token punctuation">(</span>self<span class="token punctuation">.</span>h5df_path<span class="token punctuation">,</span> <span class="token string">&#39;r&#39;</span><span class="token punctuation">,</span> swmr<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
features <span class="token operator">=</span> self<span class="token punctuation">.</span>dataset<span class="token punctuation">[</span>feature_group_name<span class="token punctuation">]</span><span class="token punctuation">[</span>self<span class="token punctuation">.</span>sample_ids<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">]</span>
data <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">&#39;input_ids&#39;</span><span class="token punctuation">:</span> features<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">&#39;input_mask&#39;</span><span class="token punctuation">:</span> features<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">&#39;segment_ids&#39;</span><span class="token punctuation">:</span> features<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li>`,1);function g(f,y){const a=o("ExternalLinkIcon");return c(),u("div",null,[i,n("p",null,[n("a",r,[s("HDF5 官方文档链接"),t(a)]),s("，以下对 H5PY 基础操作进行总结。安装：")]),d,n("ul",null,[k,m,h,n("li",null,[n("p",null,[s("似乎 h5df 1.10 的多线程处理效率更好？"),n("a",v,[s("h5df dataloader 相关"),t(a)])])]),b])])}const x=e(l,[["render",g],["__file","笔记h5df.html.vue"]]);export{x as default};
