import{_ as o}from"./plugin-vue_export-helper-c27b6911.js";import{r as p,o as t,c,a as n,b as s,d as l,f as e}from"./app-37c77bc0.js";const r={},i={href:"https://www.kuangstudy.com/bbs/1354069127022583809",target:"_blank",rel:"noopener noreferrer"},d={href:"https://www.bilibili.com/video/BV1hh411D7sb?p=5&spm_id_from=pageDriver&vd_source=4418d5cd5be787be7e3ff4138eeb9b0a",target:"_blank",rel:"noopener noreferrer"},y={href:"https://www.elastic.co/guide/cn/elasticsearch/guide/current/changing-similarities.html",target:"_blank",rel:"noopener noreferrer"},u={href:"https://www.elastic.co/guide/en/elasticsearch/client/python-api/current/overview.html",target:"_blank",rel:"noopener noreferrer"},v={href:"https://www.elastic.co/guide/cn/elasticsearch/guide/current/query-dsl-intro.html",target:"_blank",rel:"noopener noreferrer"},h=e('<h2 id="概述" tabindex="-1"><a class="header-anchor" href="#概述" aria-hidden="true">#</a> 概述</h2><p>Elasticsearch 是一个 <strong>实时分布式搜索和分析引擎</strong> 。比如博客全站搜索等功能可使用 ES 实现。</p><p>Elasticsearch 是一个基于 Apache Lucene(TM)的开源搜索引擎。无论在开源还是专有领域, Lucene 可被认为是迄今为止最先进、性能最好的、功能最全的搜索引擎库。</p><p>但是, <strong>Lucene 只是一个库</strong> 。 想要使用它,你必须使用 Java 来作为开发语言并将其直接集成到你的应用中,更糟糕的是, Lucene 非常复杂,你需要深入了解检索的相关知识来理解它是如何工作的。</p><h3 id="elk" tabindex="-1"><a class="header-anchor" href="#elk" aria-hidden="true">#</a> ELK</h3><p>ELK 是 <strong>Elasticsearch、Logstash、 Kibana 三大开源框架首字母大写简称</strong> 。市面上也被成为 Elastic Stack。</p><ol><li>收集清洗数据(Logstash) ==&gt; 搜索、存储(ElasticSearch) ==&gt; 展示(Kibana)</li></ol><p>ES 大致数据结构：</p><table><thead><tr><th>Relational DB</th><th>ElasticSearch</th></tr></thead><tbody><tr><td>数据库（database）</td><td>索引（indices）</td></tr><tr><td>表（tables）</td><td>types &lt;慢慢会被弃用!&gt;</td></tr><tr><td>行（rows）</td><td>documents</td></tr><tr><td>字段（columns）</td><td>fields</td></tr></tbody></table><p><strong>elasticsearch（集群）</strong> 中可以包含多个 <strong>索引（数据库）</strong> ,每个索引 <code>index</code> 中可以包含多个 <strong>类型（表）</strong> ,每个类型下又包含多个 <strong>文档（行）</strong> ,每个文档中又包含多个 <strong>字段（列）</strong> 。</p><h2 id="安装" tabindex="-1"><a class="header-anchor" href="#安装" aria-hidden="true">#</a> 安装</h2><h3 id="docker-示例" tabindex="-1"><a class="header-anchor" href="#docker-示例" aria-hidden="true">#</a> docker 示例</h3>',12),E={href:"https://www.elastic.co/guide/en/elasticsearch/reference/7.5/docker.html",target:"_blank",rel:"noopener noreferrer"},b=e(`<div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6F42C1;">https://www.elastic.co/guide/en/elasticsearch/reference/7.5/docker.html</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>不同版本的 ES 操作差别较大，以下以 7.8.0 版本进行实例，安装时需要 ES 和 kibana 版本相同。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6F42C1;">docker</span><span style="color:#24292E;"> </span><span style="color:#032F62;">run</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-d</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--name</span><span style="color:#24292E;"> </span><span style="color:#032F62;">elasticsearch</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-p</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">9200</span><span style="color:#032F62;">:9200</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-p</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">9300</span><span style="color:#032F62;">:9300</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-e</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;discovery.type=single-node&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">elasticsearch:7.8.0</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#6F42C1;">docker</span><span style="color:#24292E;"> </span><span style="color:#032F62;">run</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-d</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--name</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kibana</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--link</span><span style="color:#24292E;"> </span><span style="color:#032F62;">elasticsearch:elasticsearch</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-p</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">5601</span><span style="color:#032F62;">:5601</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kibana:7.8.0</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>启动之后可以通过 <code>curl http://localhost:9200/</code> 检查 ES 是否安装成功，通过浏览器 <code>http://localhost:5601/</code>检查 kibana 安装情况。若失败，则可以 <code>docker logs elasticsearch</code> 查看运行日志，而后结合官网文档查询解决方案。</p><h2 id="es-操作" tabindex="-1"><a class="header-anchor" href="#es-操作" aria-hidden="true">#</a> ES 操作</h2>`,5),m={href:"https://www.elastic.co/guide/en/elasticsearch/client/python-api/current/overview.html",target:"_blank",rel:"noopener noreferrer"},q=e('<p>ES 中使用 JSON 作为文档序列化格式。数据库整体的结构为：<code>索引 -&gt; 类型 -&gt; 文档 -&gt; 属性</code>。如，对于地址 <code>localhost:9200/megacorp/employee/1?pretty</code> 其中 <code>megacorp</code> 为索引， <code>employee</code> 为类型。在高版本中，类型已经被弃用。</p><h3 id="检索理论" tabindex="-1"><a class="header-anchor" href="#检索理论" aria-hidden="true">#</a> 检索理论</h3><h4 id="es-的搜索功能" tabindex="-1"><a class="header-anchor" href="#es-的搜索功能" aria-hidden="true">#</a> ES 的搜索功能</h4><p>ES 可以做到在某些字段上使用结构化查询，某些字段使用排序（与 SQL 结构化查询一样）。同时，应用全文检索，找出与关键字匹配的文档。</p><p>ES 的搜索存在三个关键概念：</p><ul><li><p>映射（Mapping）- 描述数据在每个字段内如何存储</p></li><li><p>分析（Analysis）- 全文是如何处理使之可以被搜索的</p></li><li><p>领域特定查询语言（Query DSL）- Elasticsearch 中强大灵活的查询语言</p></li></ul><h5 id="es-中的倒排索引" tabindex="-1"><a class="header-anchor" href="#es-中的倒排索引" aria-hidden="true">#</a> ES 中的倒排索引</h5>',7),C={href:"https://www.elastic.co/guide/cn/elasticsearch/guide/current/inverted-index.html",target:"_blank",rel:"noopener noreferrer"},g=e('<h5 id="分析器" tabindex="-1"><a class="header-anchor" href="#分析器" aria-hidden="true">#</a> 分析器</h5><p>倒排索引的一个关键点在于句词标准化，及分词和标准化。如中文分词，英文的词根提取等等。这个标准化也就是我们提到的 ES 关键概念之一：分析 <code>Analysis</code>。如对于英文的分析器，其中包含了：</p><ul><li>字符过滤器（&amp; 转 and，It&#39;s 转 it is）</li><li>分词器（根据空格和标点进行分词）</li><li>Token 过滤器。（过滤停用词、词干提取等）</li></ul><p>分析器与常规的 NLP 预处理方法大同小异。ES 中提供能标准分析器<code>standard</code>，简单分析器、空格分析器等等。</p>',4),F={href:"https://www.elastic.co/guide/cn/elasticsearch/guide/current/analysis-intro.html",target:"_blank",rel:"noopener noreferrer"},_={href:"https://www.elastic.co/guide/cn/elasticsearch/guide/current/using-language-analyzers.html",target:"_blank",rel:"noopener noreferrer"},f=e(`<p>自定以分析器大致模板：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">&quot;settings&quot;</span><span style="color:#24292E;">: {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">&quot;analysis&quot;</span><span style="color:#24292E;">: {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">&quot;char_filter&quot;</span><span style="color:#24292E;">: {</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#005CC5;">&quot;&amp;_to_and&quot;</span><span style="color:#24292E;">: {</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#005CC5;">&quot;type&quot;</span><span style="color:#24292E;">:       </span><span style="color:#032F62;">&quot;mapping&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#005CC5;">&quot;mappings&quot;</span><span style="color:#24292E;">: [ </span><span style="color:#032F62;">&quot;&amp;=&gt; and &quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">            }},  </span><span style="color:#6A737D;">// 把 &amp; 替换成 and</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">&quot;filter&quot;</span><span style="color:#24292E;">: {</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#005CC5;">&quot;my_stopwords&quot;</span><span style="color:#24292E;">: {</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#005CC5;">&quot;type&quot;</span><span style="color:#24292E;">:       </span><span style="color:#032F62;">&quot;stop&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#005CC5;">&quot;stopwords&quot;</span><span style="color:#24292E;">: [ </span><span style="color:#032F62;">&quot;the&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;a&quot;</span><span style="color:#24292E;"> ]  </span><span style="color:#6A737D;">// 过滤停用词</span></span>
<span class="line"><span style="color:#24292E;">            }},</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">&quot;analyzer&quot;</span><span style="color:#24292E;">: {</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#005CC5;">&quot;my_analyzer&quot;</span><span style="color:#24292E;">: {</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#005CC5;">&quot;type&quot;</span><span style="color:#24292E;">:         </span><span style="color:#032F62;">&quot;custom&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#005CC5;">&quot;char_filter&quot;</span><span style="color:#24292E;">:  [ </span><span style="color:#032F62;">&quot;html_strip&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;&amp;_to_and&quot;</span><span style="color:#24292E;"> ],</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#005CC5;">&quot;tokenizer&quot;</span><span style="color:#24292E;">:    </span><span style="color:#032F62;">&quot;standard&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#005CC5;">&quot;filter&quot;</span><span style="color:#24292E;">:       [ </span><span style="color:#032F62;">&quot;lowercase&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;my_stopwords&quot;</span><span style="color:#24292E;"> ]</span></span>
<span class="line"><span style="color:#24292E;">            }} </span><span style="color:#6A737D;">// 自定义分析器</span></span>
<span class="line"><span style="color:#24292E;">}}}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="映射" tabindex="-1"><a class="header-anchor" href="#映射" aria-hidden="true">#</a> 映射</h5><p>映射 <code>mapping</code> 中储存了每个文档中对应字段的类型。如：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#032F62;">&quot;mappings&quot;</span><span style="color:#24292E;">: {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">&quot;properties&quot;</span><span style="color:#24292E;">: {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">&quot;ziduan&quot;</span><span style="color:#24292E;">: {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">&quot;type&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;text&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">&quot;analyzer&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;standard&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">&quot;similarity&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;BM25&quot;</span></span>
<span class="line"><span style="color:#24292E;">        },</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其中，数据的类型有 <code>string</code>, <code>long</code>, <code>float</code>, <code>double</code>, <code>boolean</code>, <code>date</code>, <code>object</code>。<code>object</code> 的存在让 ES 支持内部对象的映射（多层结构的 JSON）。</p><p>除了 <code>type</code>， <code>mapping</code> 中还包含了其他元数据，如：</p>`,7),x=n("li",null,[n("code",null,"index"),s("：指示该字段的分析方式。（全文检索或精确检索?）")],-1),k=n("code",null,"analyzer",-1),w=n("code",null,"english",-1),D={href:"https://www.elastic.co/guide/cn/elasticsearch/guide/current/custom-analyzers.html",target:"_blank",rel:"noopener noreferrer"},A=n("li",null,"等",-1),S=e(`<h3 id="操作概览" tabindex="-1"><a class="header-anchor" href="#操作概览" aria-hidden="true">#</a> 操作概览</h3><p>ES 采用 RESTful 进行请求，使用 get/post 等操作来创建、查询等操作。</p><table><thead><tr><th>功能</th><th>请求方式</th><th>body</th><th>地址(localhost:9200+)</th></tr></thead><tbody><tr><td>创建索引</td><td>PUT</td><td></td><td>/yourdata</td></tr><tr><td>创建数据</td><td>POST</td><td><code>{&quot;doc&quot;:{&quot;title&quot;:xxx}}</code></td><td>/shopping/_doc</td></tr><tr><td>修改数据</td><td>POST</td><td>{}</td><td>/index/id/_update/</td></tr><tr><td>删除</td><td>DELETE</td><td></td><td>/shopping/_doc/1001</td></tr></tbody></table><p>此外也可以通过 <code>PUT /megacorp/employee/2</code> 来同时创建索引，并保存数据，如：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6F42C1;">curl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-X</span><span style="color:#24292E;"> </span><span style="color:#032F62;">PUT</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;localhost:9200/megacorp/employee/1?pretty&quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-H</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Content-Type: application/json&#39;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-d</span><span style="color:#032F62;">&#39;</span></span>
<span class="line"><span style="color:#032F62;">{</span></span>
<span class="line"><span style="color:#032F62;">    &quot;first_name&quot; : &quot;John&quot;,</span></span>
<span class="line"><span style="color:#032F62;">    &quot;last_name&quot; :  &quot;Smith&quot;,</span></span>
<span class="line"><span style="color:#032F62;">    &quot;age&quot; :        25,</span></span>
<span class="line"><span style="color:#032F62;">    &quot;about&quot; :      &quot;I love to go rock climbing&quot;,</span></span>
<span class="line"><span style="color:#032F62;">    &quot;interests&quot;: [ &quot;sports&quot;, &quot;music&quot; ]</span></span>
<span class="line"><span style="color:#032F62;">}</span></span>
<span class="line"><span style="color:#032F62;">&#39;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>创建文档时，可以采用 <code>POST /website/blog/</code> 让 ES 自动分配唯一 <code>_id</code>。同时可以使用 <code>PUT /website/blog/123/_create</code> 来创建指定 <code>_id</code> 的文档，当 <code>_id</code> 存在时创建失败，返回 409，创建成功返回 201。</p><h5 id="更新文档" tabindex="-1"><a class="header-anchor" href="#更新文档" aria-hidden="true">#</a> 更新文档</h5><p>更新文档示例：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6F42C1;">curl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-X</span><span style="color:#24292E;"> </span><span style="color:#032F62;">POST</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;localhost:9200/website/pageviews/1/_update?pretty&quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-H</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Content-Type: application/json&#39;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-d</span><span style="color:#032F62;">&#39;</span></span>
<span class="line"><span style="color:#032F62;">{</span></span>
<span class="line"><span style="color:#032F62;">   &quot;script&quot; : &quot;ctx._source.views+=1&quot;,</span></span>
<span class="line"><span style="color:#032F62;">   &quot;upsert&quot;: {</span></span>
<span class="line"><span style="color:#032F62;">       &quot;views&quot;: 1</span></span>
<span class="line"><span style="color:#032F62;">   }</span></span>
<span class="line"><span style="color:#032F62;">}</span></span>
<span class="line"><span style="color:#032F62;">&#39;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="分布式文件控制" tabindex="-1"><a class="header-anchor" href="#分布式文件控制" aria-hidden="true">#</a> 分布式文件控制</h5><p>ES <code>index</code> ， <code>GET</code> 和 <code>delete</code> 请求时，我们指出每个文档都有一个 <code>_version</code>，可以通过 <code>_version</code> 确保应用中文档不会冲突。如：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6F42C1;">curl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-X</span><span style="color:#24292E;"> </span><span style="color:#032F62;">PUT</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;localhost:9200/website/blog/1?version=1&amp;pretty&quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-H</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Content-Type: application/json&#39;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-d</span><span style="color:#032F62;">&#39;</span></span>
<span class="line"><span style="color:#032F62;">{</span></span>
<span class="line"><span style="color:#032F62;">  &quot;title&quot;: &quot;My first blog entry&quot;,</span></span>
<span class="line"><span style="color:#032F62;">  &quot;text&quot;:  &quot;Starting to get the hang of this...&quot;</span></span>
<span class="line"><span style="color:#032F62;">}</span></span>
<span class="line"><span style="color:#032F62;">&#39;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>以上指定了修改文档对应的 <code>version</code>。</p><h3 id="检索数据" tabindex="-1"><a class="header-anchor" href="#检索数据" aria-hidden="true">#</a> 检索数据</h3>`,14),T={href:"https://elasticsearch-py.readthedocs.io/en/v8.4.2/api.html?highlight=search",target:"_blank",rel:"noopener noreferrer"},L={href:"https://www.elastic.co/guide/cn/elasticsearch/guide/current/query-dsl-intro.html",target:"_blank",rel:"noopener noreferrer"},I=e(`<p>数据检索可以分为查询与过滤，通常查询（Query）语句用来进行任何需要影响相关性得分的搜索。而过滤则（Filtering）用来进行文档匹配。查询与过滤的性能差异较大。</p><p>查询主要是发送请求到<code>http://127.0.0.1:9200/shopping/_search</code>。以 <code>body</code> 的不同来实现不同检索方式：</p><h4 id="搜索结果" tabindex="-1"><a class="header-anchor" href="#搜索结果" aria-hidden="true">#</a> 搜索结果</h4><p>对于批量检索，返回的结果中有以下字段：</p><ul><li><code>timed_out</code> 值告诉我们查询是否超时，可以指定。</li><li><code>took</code> 搜索请求耗费了多少毫秒。</li><li><code>max_score</code> 值是与查询所匹配文档的 <code>_score</code> 的最大值。</li><li><code>hits</code> 包含 <code>total</code> 字段来表示匹配到的文档总数，并且一个 <code>hits</code> 数组包含所查询结果的前十个文档。在 <code>hits</code> 数组中每个结果包含文档的 <code>_index</code> 、 <code>_type</code> 、 <code>_id</code> ，加上 <code>_source</code> 字段。</li></ul><p>示例搜索结果：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6F42C1;">&quot;hits&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">{</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6F42C1;">&quot;total&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">:</span><span style="color:#24292E;">       </span><span style="color:#005CC5;">14</span><span style="color:#032F62;">,</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6F42C1;">&quot;hits&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">:</span><span style="color:#24292E;"> [</span></span>
<span class="line"><span style="color:#24292E;">        {</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#6F42C1;">&quot;_index&quot;</span><span style="color:#005CC5;">:</span><span style="color:#24292E;">   </span><span style="color:#032F62;">&quot;us&quot;,</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#6F42C1;">&quot;_type&quot;</span><span style="color:#005CC5;">:</span><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;tweet&quot;,</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#6F42C1;">&quot;_id&quot;</span><span style="color:#005CC5;">:</span><span style="color:#24292E;">      </span><span style="color:#032F62;">&quot;7&quot;,</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#6F42C1;">&quot;_score&quot;</span><span style="color:#005CC5;">:</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">,</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#6F42C1;">&quot;_source&quot;</span><span style="color:#005CC5;">:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">{</span></span>
<span class="line"><span style="color:#24292E;">             </span><span style="color:#6F42C1;">&quot;date&quot;</span><span style="color:#005CC5;">:</span><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;2014-09-17&quot;,</span></span>
<span class="line"><span style="color:#24292E;">             </span><span style="color:#6F42C1;">&quot;name&quot;</span><span style="color:#005CC5;">:</span><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;John Smith&quot;,</span></span>
<span class="line"><span style="color:#24292E;">             </span><span style="color:#6F42C1;">&quot;tweet&quot;</span><span style="color:#005CC5;">:</span><span style="color:#24292E;">   </span><span style="color:#032F62;">&quot;The Query DSL is really powerful and flexible&quot;,</span></span>
<span class="line"><span style="color:#24292E;">             </span><span style="color:#6F42C1;">&quot;user_id&quot;</span><span style="color:#005CC5;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span></span>
<span class="line"><span style="color:#24292E;">          }</span></span>
<span class="line"><span style="color:#24292E;">       },</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">...</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">9</span><span style="color:#24292E;"> </span><span style="color:#032F62;">RESULTS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">REMOVED</span><span style="color:#24292E;"> </span><span style="color:#032F62;">...</span></span>
<span class="line"><span style="color:#24292E;">      ],</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6F42C1;">&quot;max_score&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">:</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">   },</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6F42C1;">&quot;took&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">:</span><span style="color:#24292E;">           </span><span style="color:#005CC5;">4</span><span style="color:#032F62;">,</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6F42C1;">&quot;_shards&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">{</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6F42C1;">&quot;failed&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">:</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">,</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6F42C1;">&quot;successful&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">:</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">10</span><span style="color:#032F62;">,</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6F42C1;">&quot;total&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">:</span><span style="color:#24292E;">       </span><span style="color:#005CC5;">10</span></span>
<span class="line"><span style="color:#24292E;">   },</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6F42C1;">&quot;timed_out&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">:</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">false</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>结果分页</strong></p><p>类似 SQL 使用 <code>LIMIT</code> 限制输出数量，ES 使用 <code>size</code> 和 <code>from</code> 来限制。</p><p>检索时，ES 会见不同字段的内容进行组合，拼接成一个 <code>_all</code> 字段，而后对 <code>_all</code>字段进行检索。</p><h4 id="基础检索操作" tabindex="-1"><a class="header-anchor" href="#基础检索操作" aria-hidden="true">#</a> 基础检索操作</h4><p>通过文档的 ID 直接进行检索：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6F42C1;">curl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-X</span><span style="color:#24292E;"> </span><span style="color:#032F62;">GET</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;localhost:9200/megacorp/employee/1?pretty&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>将 <code>GET</code> 改为 <code>DELETE</code>，则变为删除指定文档。</p><h4 id="模糊匹配操作" tabindex="-1"><a class="header-anchor" href="#模糊匹配操作" aria-hidden="true">#</a> 模糊匹配操作</h4><p>主要使用 <code>match</code> 语法，<code>match</code> 中的文字会首先经过分词，而后通过倒排索引进行检索，以下示例仅展示请求的 <code>body</code> 内容。</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">&quot;query&quot;</span><span style="color:#24292E;">:{</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">&quot;match&quot;</span><span style="color:#24292E;">:{</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">&quot;last_name&quot;</span><span style="color:#24292E;">:</span><span style="color:#032F62;">&quot;smith&quot;</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    },</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">&quot;from&quot;</span><span style="color:#24292E;"> : </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span><span style="color:#6A737D;">// 其实位置</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">&quot;size&quot;</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">&quot;_source&quot;</span><span style="color:#24292E;">:[</span><span style="color:#032F62;">&quot;age&quot;</span><span style="color:#24292E;">],  </span><span style="color:#6A737D;">// 想要得到的数据。</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">&quot;sort&quot;</span><span style="color:#24292E;">: {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">&quot;age&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;decs&quot;</span><span style="color:#24292E;">  </span><span style="color:#6A737D;">// 降序排序</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>模糊查询的结果中，有 <code>_score</code> 的属性。其为相关性评分，在早期 ES 中，使用 TF-IDF 评分，后期采用 BM25。</p><h5 id="其他常用查询方式" tabindex="-1"><a class="header-anchor" href="#其他常用查询方式" aria-hidden="true">#</a> 其他常用查询方式</h5><p>其他常见的查询方式有：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// 在多个字段上查询</span></span>
<span class="line"><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">&quot;multi_match&quot;</span><span style="color:#24292E;">:{</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">&quot;query&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;text searched&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">&quot;fields&quot;</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;title&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;body&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 对于数字或者时间查询</span></span>
<span class="line"><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">&quot;range&quot;</span><span style="color:#24292E;">: {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">&quot;age&quot;</span><span style="color:#24292E;">: {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">&quot;gte&quot;</span><span style="color:#24292E;">:  </span><span style="color:#005CC5;">20</span><span style="color:#24292E;">, </span><span style="color:#6A737D;">// gt, lt, lte</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">&quot;lt&quot;</span><span style="color:#24292E;">:   </span><span style="color:#005CC5;">30</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 精确匹配</span></span>
<span class="line"><span style="color:#24292E;">{ </span><span style="color:#005CC5;">&quot;term&quot;</span><span style="color:#24292E;">: { </span><span style="color:#005CC5;">&quot;tag&quot;</span><span style="color:#24292E;">:    </span><span style="color:#032F62;">&quot;full_text&quot;</span><span style="color:#24292E;">  }}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 多字段匹配，只要包含其中一个，就算满足条件</span></span>
<span class="line"><span style="color:#24292E;">{ </span><span style="color:#005CC5;">&quot;terms&quot;</span><span style="color:#24292E;">: { </span><span style="color:#005CC5;">&quot;tag&quot;</span><span style="color:#24292E;">: [ </span><span style="color:#032F62;">&quot;search&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;full_text&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;nosql&quot;</span><span style="color:#24292E;"> ] }}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="复合查询操作" tabindex="-1"><a class="header-anchor" href="#复合查询操作" aria-hidden="true">#</a> 复合查询操作</h4><p>比如我们希望查询语句中必须包含某些字符，必须不出现某些字符，则可以使用复合查询。</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// must 相当于 and</span></span>
<span class="line"><span style="color:#6A737D;">// should 相当于 or</span></span>
<span class="line"><span style="color:#6A737D;">// must_not 相当于 not (... and ...)</span></span>
<span class="line"><span style="color:#6A737D;">// filter 过滤</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">&quot;bool&quot;</span><span style="color:#24292E;">: {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">&quot;must&quot;</span><span style="color:#24292E;">: { </span><span style="color:#005CC5;">&quot;match&quot;</span><span style="color:#24292E;">:   { </span><span style="color:#005CC5;">&quot;email&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;business opportunity&quot;</span><span style="color:#24292E;"> }},</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">&quot;should&quot;</span><span style="color:#24292E;">: [</span></span>
<span class="line"><span style="color:#24292E;">            { </span><span style="color:#005CC5;">&quot;match&quot;</span><span style="color:#24292E;">:       { </span><span style="color:#005CC5;">&quot;starred&quot;</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">true</span><span style="color:#24292E;"> }},</span></span>
<span class="line"><span style="color:#24292E;">            { </span><span style="color:#005CC5;">&quot;bool&quot;</span><span style="color:#24292E;">: {</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#005CC5;">&quot;must&quot;</span><span style="color:#24292E;">:      { </span><span style="color:#005CC5;">&quot;match&quot;</span><span style="color:#24292E;">: { </span><span style="color:#005CC5;">&quot;folder&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;inbox&quot;</span><span style="color:#24292E;"> }},</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#005CC5;">&quot;must_not&quot;</span><span style="color:#24292E;">:  { </span><span style="color:#005CC5;">&quot;match&quot;</span><span style="color:#24292E;">: { </span><span style="color:#005CC5;">&quot;spam&quot;</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">true</span><span style="color:#24292E;"> }}</span></span>
<span class="line"><span style="color:#24292E;">            }}</span></span>
<span class="line"><span style="color:#24292E;">        ],</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">&quot;minimum_should_match&quot;</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1</span><span style="color:#B31D28;font-style:italic;">，</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#032F62;">&quot;filter&quot;</span><span style="color:#B31D28;font-style:italic;">:</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#005CC5;">&quot;range&quot;</span><span style="color:#24292E;">: { </span><span style="color:#005CC5;">&quot;date&quot;</span><span style="color:#24292E;">: { </span><span style="color:#005CC5;">&quot;gte&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;2014-01-01&quot;</span><span style="color:#24292E;"> }} </span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="其他搜索" tabindex="-1"><a class="header-anchor" href="#其他搜索" aria-hidden="true">#</a> 其他搜索</h4>`,25),P={href:"https://www.elastic.co/guide/cn/elasticsearch/guide/current/_wildcard_and_regexp_queries.html",target:"_blank",rel:"noopener noreferrer"},j=n("h4",{id:"相关性",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#相关性","aria-hidden":"true"},"#"),s(" 相关性")],-1),z={href:"https://www.elastic.co/guide/cn/elasticsearch/guide/current/practical-scoring-function.html",target:"_blank",rel:"noopener noreferrer"},M={href:"https://www.elastic.co/guide/cn/elasticsearch/guide/current/boosting-by-popularity.html",target:"_blank",rel:"noopener noreferrer"},B=e(`<div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6F42C1;">GET</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/blogposts/post/_search</span></span>
<span class="line"><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">&quot;query&quot;</span><span style="color:#005CC5;">:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">{</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">&quot;function_score&quot;</span><span style="color:#005CC5;">:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">{</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6F42C1;">&quot;query&quot;</span><span style="color:#005CC5;">:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">{</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">&quot;multi_match&quot;</span><span style="color:#005CC5;">:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">{</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#6F42C1;">&quot;query&quot;</span><span style="color:#005CC5;">:</span><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;popularity&quot;,</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#6F42C1;">&quot;fields&quot;</span><span style="color:#005CC5;">:</span><span style="color:#24292E;"> [ </span><span style="color:#032F62;">&quot;title&quot;,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;content&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">]</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">      },</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6F42C1;">&quot;field_value_factor&quot;</span><span style="color:#005CC5;">:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">{</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">&quot;field&quot;</span><span style="color:#005CC5;">:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;votes&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">&quot;modifier&quot;</span><span style="color:#005CC5;">:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;log1p&quot;,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">&quot;factor&quot;</span><span style="color:#005CC5;">:</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">2</span></span>
<span class="line"><span style="color:#24292E;">      }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,1),N={href:"https://www.elastic.co/guide/cn/elasticsearch/guide/current/function-score-filters.html",target:"_blank",rel:"noopener noreferrer"},O=e(`<p>TF-IDF 还支持了部分其他流行的相似度，如 BM25，词频饱和度等。可以通过映射来配置 BM25 的超参：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">&quot;settings&quot;</span><span style="color:#005CC5;">:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">{</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">&quot;similarity&quot;</span><span style="color:#005CC5;">:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">{</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6F42C1;">&quot;my_bm25&quot;</span><span style="color:#005CC5;">:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">{</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">&quot;type&quot;</span><span style="color:#005CC5;">:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;BM25&quot;,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">&quot;b&quot;</span><span style="color:#005CC5;">:</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">  </span><span style="color:#6A737D;"># 设置 BM25 的超参 b 或 k</span></span>
<span class="line"><span style="color:#24292E;">      }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">  },</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">&quot;mappings&quot;</span><span style="color:#005CC5;">:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">{</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">&quot;doc&quot;</span><span style="color:#005CC5;">:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">{</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6F42C1;">&quot;properties&quot;</span><span style="color:#005CC5;">:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">{</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">&quot;title&quot;</span><span style="color:#005CC5;">:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">{</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#6F42C1;">&quot;type&quot;</span><span style="color:#005CC5;">:</span><span style="color:#24292E;">       </span><span style="color:#032F62;">&quot;string&quot;,</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#6F42C1;">&quot;similarity&quot;</span><span style="color:#005CC5;">:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;my_bm25&quot;</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">        },  </span><span style="color:#6A737D;"># 在 mapping 中配置即可生效</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">&quot;body&quot;</span><span style="color:#005CC5;">:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">{</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#6F42C1;">&quot;type&quot;</span><span style="color:#005CC5;">:</span><span style="color:#24292E;">       </span><span style="color:#032F62;">&quot;string&quot;,</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#6F42C1;">&quot;similarity&quot;</span><span style="color:#005CC5;">:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;BM25&quot;</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">      }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>此外我们可以提取搜索结果中的 TOP k 个相关语句，并返回，这需要用到 <code>minimum_should_match</code> 和 <code>rescore</code>，如：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6F42C1;">curl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-X</span><span style="color:#24292E;"> </span><span style="color:#032F62;">GET</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;localhost:9200/my_index/my_type/_search?pretty&quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-H</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Content-Type: application/json&#39;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-d</span><span style="color:#032F62;">&#39;</span></span>
<span class="line"><span style="color:#032F62;">{</span></span>
<span class="line"><span style="color:#032F62;">    &quot;query&quot;: {</span></span>
<span class="line"><span style="color:#032F62;">        &quot;match&quot;: {  </span></span>
<span class="line"><span style="color:#032F62;">            &quot;title&quot;: {</span></span>
<span class="line"><span style="color:#032F62;">                &quot;query&quot;:                &quot;quick brown fox&quot;,</span></span>
<span class="line"><span style="color:#032F62;">                &quot;minimum_should_match&quot;: &quot;30%&quot;</span></span>
<span class="line"><span style="color:#032F62;">            }</span></span>
<span class="line"><span style="color:#032F62;">        }</span></span>
<span class="line"><span style="color:#032F62;">    },</span></span>
<span class="line"><span style="color:#032F62;">    &quot;rescore&quot;: {</span></span>
<span class="line"><span style="color:#032F62;">        &quot;window_size&quot;: 50, </span></span>
<span class="line"><span style="color:#032F62;">        &quot;query&quot;: {         </span></span>
<span class="line"><span style="color:#032F62;">            &quot;rescore_query&quot;: {</span></span>
<span class="line"><span style="color:#032F62;">                &quot;match_phrase&quot;: {</span></span>
<span class="line"><span style="color:#032F62;">                    &quot;title&quot;: {</span></span>
<span class="line"><span style="color:#032F62;">                        &quot;query&quot;: &quot;quick brown fox&quot;,</span></span>
<span class="line"><span style="color:#032F62;">                        &quot;slop&quot;:  50</span></span>
<span class="line"><span style="color:#032F62;">                    }</span></span>
<span class="line"><span style="color:#032F62;">                }</span></span>
<span class="line"><span style="color:#032F62;">            }</span></span>
<span class="line"><span style="color:#032F62;">        }</span></span>
<span class="line"><span style="color:#032F62;">    }</span></span>
<span class="line"><span style="color:#032F62;">}</span></span>
<span class="line"><span style="color:#032F62;">&#39;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,4),J={href:"https://www.elastic.co/guide/cn/elasticsearch/guide/current/_Improving_Performance.html",target:"_blank",rel:"noopener noreferrer"},U=e(`<h4 id="书本金句" tabindex="-1"><a class="header-anchor" href="#书本金句" aria-hidden="true">#</a> 书本金句</h4><p>本章介绍了 Lucene 是如何基于 TF/IDF 生成评分的。理解评分过程是非常重要的，这样就可以根据具体的业务对评分结果进行调试、调节、减弱和定制。（所以书中大篇幅的介绍了如何去修改 TF-IDF 权重，或者自定义自己的相关性权重）</p><p>通常，经过对策略字段应用权重提升，或通过对查询语句结构的调整来强调某个句子的重要性这些方法，就足以获得良好的结果。</p><p>相关度是一个十分主观的概念，很容易进入反复调整相关度，而没有明显进展的怪圈。一定要在实践中，监控用户的行为，而后通过大众的反应来进行对应的调整。</p><h3 id="书中其他内容" tabindex="-1"><a class="header-anchor" href="#书中其他内容" aria-hidden="true">#</a> 书中其他内容</h3><p>等用到的时候在学吧，不然肯定忘记了。。。</p><ul><li><strong>集群相关操作：</strong> 集群维护、水平扩容、分布式文档储存</li><li><strong>其他匹配方式：</strong> 正则，Ngram 等</li><li><strong>管理监控和部署：</strong> 集群管理，索引统计等</li></ul><h2 id="python-elasticsearch-笔记" tabindex="-1"><a class="header-anchor" href="#python-elasticsearch-笔记" aria-hidden="true">#</a> Python Elasticsearch 笔记</h2><h3 id="安装-1" tabindex="-1"><a class="header-anchor" href="#安装-1" aria-hidden="true">#</a> 安装</h3><p>ES 版本 7.8.0，对应安装 <code>pip install -U &#39;elasticsearch&lt;7&#39;</code>。版本不对应时，会出现各种链接问题。以下代码测试版本： <code>elasticsearch-6.8.2</code></p><h3 id="操作" tabindex="-1"><a class="header-anchor" href="#操作" aria-hidden="true">#</a> 操作</h3><p>实例化</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> elasticsearch </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> Elasticsearch</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">es </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> Elasticsearch(</span><span style="color:#032F62;">&quot;https://localhost:9200&quot;</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">                   </span><span style="color:#E36209;">api_key</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;id&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;api_key&quot;</span><span style="color:#24292E;">))</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>创建索引</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#24292E;">body </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;settings&quot;</span><span style="color:#24292E;">: {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#032F62;">&quot;number_of_shards&quot;</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#032F62;">&quot;analysis&quot;</span><span style="color:#24292E;">: {</span><span style="color:#032F62;">&quot;analyzer&quot;</span><span style="color:#24292E;">: {</span><span style="color:#032F62;">&quot;stop_standard&quot;</span><span style="color:#24292E;">: {</span><span style="color:#032F62;">&quot;type&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;standard&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot; stopwords&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;_english_&quot;</span><span style="color:#24292E;">}}},</span></span>
<span class="line"><span style="color:#24292E;">    },</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;mappings&quot;</span><span style="color:#24292E;">: {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#032F62;">&quot;properties&quot;</span><span style="color:#24292E;">: {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#032F62;">&quot;text&quot;</span><span style="color:#24292E;">: {</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#032F62;">&quot;type&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;text&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#032F62;">&quot;analyzer&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;standard&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#032F62;">&quot;similarity&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;BM25&quot;</span></span>
<span class="line"><span style="color:#24292E;">            },</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    },</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">result </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> es.indices.create(</span><span style="color:#E36209;">index</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;test&quot;</span><span style="color:#24292E;">, </span><span style="color:#E36209;">body</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> body)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 删除：</span></span>
<span class="line"><span style="color:#24292E;">es.indices.delete(</span><span style="color:#032F62;">&quot;test&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>插入删除数据</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># 插入数据</span></span>
<span class="line"><span style="color:#24292E;">es.index(</span><span style="color:#E36209;">index</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;test&quot;</span><span style="color:#24292E;">, </span><span style="color:#E36209;">doc_type</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;_doc&quot;</span><span style="color:#24292E;">, </span><span style="color:#E36209;">id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span><span style="color:#E36209;">body</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> {</span><span style="color:#032F62;">&quot;id&quot;</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;name&quot;</span><span style="color:#24292E;">:</span><span style="color:#032F62;">&quot;小明&quot;</span><span style="color:#24292E;">})</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 删除指定数据</span></span>
<span class="line"><span style="color:#24292E;">es.delete(</span><span style="color:#E36209;">index</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;test&#39;</span><span style="color:#24292E;">, </span><span style="color:#E36209;">doc_type</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;_doc&#39;</span><span style="color:#24292E;">, </span><span style="color:#E36209;">id</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#修改字段</span></span>
<span class="line"><span style="color:#24292E;">es.update(</span><span style="color:#E36209;">index</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;test&quot;</span><span style="color:#24292E;">, </span><span style="color:#E36209;">doc_type</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;_doc&quot;</span><span style="color:#24292E;">, </span><span style="color:#E36209;">id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span><span style="color:#E36209;">body</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> {</span><span style="color:#032F62;">&quot;doc&quot;</span><span style="color:#24292E;">:{</span><span style="color:#032F62;">&quot;name&quot;</span><span style="color:#24292E;">:</span><span style="color:#032F62;">&quot;张三&quot;</span><span style="color:#24292E;">}})</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="查询" tabindex="-1"><a class="header-anchor" href="#查询" aria-hidden="true">#</a> 查询</h3>`,18),V={href:"https://elasticsearch-py.readthedocs.io/en/v8.4.2/api.html?highlight=search",target:"_blank",rel:"noopener noreferrer"},X={href:"https://www.elastic.co/guide/cn/elasticsearch/guide/current/query-dsl-intro.html",target:"_blank",rel:"noopener noreferrer"},G=e(`<p>最基础的查询语法：</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># 定义过滤字段，最终只显示此此段信息</span></span>
<span class="line"><span style="color:#24292E;">filter_path</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">[</span><span style="color:#032F62;">&#39;hits.hits._source.ziduan1&#39;</span><span style="color:#24292E;">,  </span><span style="color:#6A737D;"># 字段 1         &#39;hits.hits._source.ziduan2&#39;]  # 字段 2</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">body = {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&#39;query&#39;</span><span style="color:#24292E;">: {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#032F62;">&#39;match&#39;</span><span style="color:#24292E;">: {  </span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#032F62;">&#39;type&#39;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;我爱你中国&#39;</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">a = es.search(</span><span style="color:#E36209;">index</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;yourindex&#39;</span><span style="color:#24292E;">, </span><span style="color:#E36209;">filter_path</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">filter_path, </span><span style="color:#E36209;">body</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">body, </span><span style="color:#E36209;">size</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">20</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">for</span><span style="color:#24292E;"> hit </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> a[</span><span style="color:#032F62;">&#39;hits&#39;</span><span style="color:#24292E;">][</span><span style="color:#032F62;">&#39;hits&#39;</span><span style="color:#24292E;">]:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(hit)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,2),Q=n("code",null,"filter_path",-1),R=n("code",null,"_source",-1),H=n("code",null,"_score",-1),K=n("code",null,"size",-1),Z={href:"https://www.elastic.co/guide/en/elasticsearch/reference/current/search-search.html",target:"_blank",rel:"noopener noreferrer"},W=e('<h2 id="其他笔记" tabindex="-1"><a class="header-anchor" href="#其他笔记" aria-hidden="true">#</a> 其他笔记</h2><h3 id="如何批量导入" tabindex="-1"><a class="header-anchor" href="#如何批量导入" aria-hidden="true">#</a> 如何批量导入？</h3><h3 id="与-huggingface-datasets-如何配合" tabindex="-1"><a class="header-anchor" href="#与-huggingface-datasets-如何配合" aria-hidden="true">#</a> 与 huggingface datasets 如何配合？</h3>',3),Y={href:"https://github.com/yaoxingcheng/TLM",target:"_blank",rel:"noopener noreferrer"},$={href:"https://huggingface.co/docs/datasets/installation",target:"_blank",rel:"noopener noreferrer"},ss={href:"https://huggingface.co/docs/datasets/v2.6.1/en/package_reference/main_classes#datasets.Dataset.add_elasticsearch_index",target:"_blank",rel:"noopener noreferrer"},ns=e(`<div class="language-python line-numbers-mode" data-ext="py"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#24292E;">data_files </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;./TLM/example_data/source.csv&quot;</span></span>
<span class="line"><span style="color:#24292E;">ds </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> load_dataset(</span><span style="color:#032F62;">&quot;text&quot;</span><span style="color:#24292E;">, </span><span style="color:#E36209;">data_files</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">data_files)[</span><span style="color:#032F62;">&quot;train&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">es </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> Elasticsearch(</span><span style="color:#032F62;">&quot;http://localhost:9200&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> es.indices.exists(</span><span style="color:#E36209;">index</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;tt&quot;</span><span style="color:#24292E;">):</span></span>
<span class="line"><span style="color:#24292E;">    ds.add_elasticsearch_index(</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#032F62;">&quot;text&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#E36209;">es_client</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">es,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#E36209;">es_index_name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;tt&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#E36209;">es_index_config</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">es_config,</span></span>
<span class="line"><span style="color:#24292E;">    )</span></span>
<span class="line"><span style="color:#D73A49;">else</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    ds.load_elasticsearch_index(</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#032F62;">&quot;text&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#E36209;">es_client</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">es,</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#E36209;">es_index_name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;tt&#39;</span></span>
<span class="line"><span style="color:#24292E;">            )</span></span>
<span class="line"><span style="color:#24292E;">body </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&#39;query&#39;</span><span style="color:#24292E;">: {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#032F62;">&#39;match&#39;</span><span style="color:#24292E;">: {  </span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#032F62;">&#39;text&#39;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;hello world&#39;</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#005CC5;">print</span><span style="color:#24292E;">(ds.get_nearest_examples(</span><span style="color:#032F62;">&quot;text&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;hello world&quot;</span><span style="color:#24292E;">,</span><span style="color:#E36209;">k</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">))</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>通过上述方案，能够将 huggingface 的 datasets 导入到 es 数据库中，而后通过 es 数据库的方式进行检索。</p><h3 id="如何备份与转移数据" tabindex="-1"><a class="header-anchor" href="#如何备份与转移数据" aria-hidden="true">#</a> 如何备份与转移数据?</h3>`,3),as={href:"https://cloud.tencent.com/developer/article/1839060",target:"_blank",rel:"noopener noreferrer"},ls=e('<h3 id="es-与-solr" tabindex="-1"><a class="header-anchor" href="#es-与-solr" aria-hidden="true">#</a> ES 与 Solr</h3><p>1、 <strong>es</strong> 基本是 <strong>开箱即用</strong> (解压就可以用!) ,非常简单。Solr 安装略微复杂一丢丢! 2、 <strong>Solr 利用 Zookeeper 进行分布式管理</strong> ,而 <strong>Elasticsearch 自身带有分布式协调管理功能。</strong> 3、Solr 支持更多格式的数据,比如 JSON、XML、 CSV ,而 <strong>Elasticsearch 仅支持 json 文件格式</strong> 。 4、Solr 官方提供的功能更多,而 Elasticsearch 本身更注重于核心功能，高级功能多有第三方插件提供，例如图形化界面需要 kibana 友好支撑 5、 <strong>Solr 查询快,但更新索引时慢(即插入删除慢)</strong> ，用于电商等查询多的应用;</p><ul><li><strong>ES 建立索引快(即查询慢)</strong> ，即 <strong>实时性查询快</strong> ，用于 facebook 新浪等搜索。</li><li>Solr 是传统搜索应用的有力解决方案，但 Elasticsearch 更适用于新兴的实时搜索应用。</li></ul><p>6、Solr 比较成熟，有一个更大，更成熟的用户、开发和贡献者社区，而 Elasticsearch 相对开发维护者较少,更新太快,学习使用成本较高。</p>',4);function es(os,ps){const a=p("ExternalLinkIcon");return t(),c("div",null,[n("p",null,[s("用于快速了解 ES 的资料： "),n("a",i,[s("狂神说 ElasticSearch 笔记"),l(a)]),s(" 或 "),n("a",d,[s("【尚硅谷】ElasticSearch 教程入门到精通"),l(a)])]),n("p",null,[s("上手与入门推荐： "),n("a",y,[s("推荐 中文 Elastic 文档"),l(a)]),s(" 熟悉了 ES 的相关操作和环境。查看 "),n("a",u,[s("python elastic search 文档"),l(a)]),s("，"),n("a",v,[s("推荐 ES 语法文档"),l(a)])]),h,n("p",null,[s("该方法较少用，但是能够快速，安全地在本地上创建一个可以用于学习地 ES 环境。参考官方指南 "),n("a",E,[s("link"),l(a)]),s("。以单节点为例，根据 dockerhub ElasticSearch 的指南拉取对应镜像并开启。")]),b,n("p",null,[s("ES 主要通过 Java API 或者使用 RESTful API 通过 9200 端口进行交互。官方也提供了其他语言的客户端，如 "),n("a",m,[s("python API"),l(a)]),s("。")]),q,n("p",null,[n("a",C,[s("倒排索引文档"),l(a)]),s(" 简单的说就是给每个单词，简历一个单词到文档的映射。这样一来，搜索关键词时候就不需要遍历所有文档了。")]),g,n("p",null,[s("当然只有在进行全文检索的时候，才用到分析器。更多关于分析器的介绍，参考 "),n("a",F,[s("官方指南"),l(a)]),s("。")]),n("p",null,[s("当然，ES 中还支持各种语言处理方式，包括拼写错误、同义词转换等 "),n("a",_,[s("官方链接"),l(a)]),s("。")]),f,n("ul",null,[x,n("li",null,[k,s("：进行全文检索时候的分析器，如 "),w,s(" 等。 当然可以 "),n("a",D,[s("自定义分析器"),l(a)])]),A]),S,n("p",null,[s("更多查询语句方式，查看 "),n("a",T,[s("Python Elastic search 官网文档"),l(a)]),s(", "),n("a",L,[s("推荐 ES 语法文档"),l(a)])]),I,n("p",null,[s("正则表达式匹配 "),n("a",P,[s("link"),l(a)]),s(" 等")]),j,n("p",null,[s("这里有一份 "),n("a",z,[s("ES2.x TF-IDF 相关性计算方法"),l(a)]),s(" 指南。可以看到官方的 TF-IDF 与传统计算方式有些不同。")]),n("p",null,[s("当然，这里的相关性是支持自定义的，比如根据某个字段的值加上权重 "),n("a",M,[s("参考"),l(a)]),s(" ：")]),B,n("p",null,[s("或者对 TF-IDF 进行改造 "),n("a",N,[s("链接"),l(a)]),s("。")]),O,n("p",null,[s("具体查看 "),n("a",J,[s("官方文档"),l(a)])]),U,n("p",null,[n("a",V,[s("Python Elastic search 官网文档"),l(a)]),s(", "),n("a",X,[s("推荐 ES 语法文档"),l(a)])]),G,n("p",null,[s("注意，以上方法添加 "),Q,s(" 后，结果中将只有 "),R,s(" 内容，不会显示 "),H,s(" 等元数据。"),K,s(" 为返回最相关数据的数量。相似文档查询 "),n("a",Z,[s("官方链接"),l(a)])]),W,n("p",null,[n("a",Y,[s("TLM 参考"),l(a)]),s("datasets 与 ES 有配合 "),n("a",$,[s("huggingface datasets 官网"),l(a)]),s(",：")]),n("ul",null,[n("li",null,[n("a",ss,[s("add_elasticsearch_index"),l(a)]),s("：能够")])]),ns,n("p",null,[n("a",as,[s("网络资源很多"),l(a)])]),ls])}const rs=o(r,[["render",es],["__file","笔记es.html.vue"]]);export{rs as default};
