import{_ as e}from"./plugin-vue_export-helper-c27b6911.js";import{r as o,o as c,c as r,a as s,b as n,d as l,f as p}from"./app-c09ad24c.js";const t="/assets/img/k8s/image-20200612005334159.png",i="/assets/img/k8s/image-20200612005524778.png",y="/assets/img/k8s/image-20200416140251491.png",d="/assets/img/k8s/image-20200608155858271.png",v="/assets/img/k8s/image-20200608163326496.png",E="/assets/img/k8s/image-20200612010223537.png",u="/assets/img/k8s/image-20200618213054113.png",m="/assets/img/k8s/image-20200618213149531.png",b="/assets/img/k8s/image-20200408194716912-1626783758946.png",C="/assets/img/k8s/image-20200509121254425.png",F="/assets/img/k8s/image-20200509151424280.png",g="/assets/img/k8s/image-20200509152947714.png",A="/assets/img/k8s/image-20200509153731363.png",h="/assets/img/k8s/image-20200509191917069.png",k="/assets/img/k8s/image-20200620175731338.png",f="/assets/img/k8s/image-20200510103945494.png",D="/assets/img/k8s/image-20200510113311209.png",x="/assets/img/k8s/image-20200623092808049.png",P="/assets/img/k8s/image-20200516112704764.png",R="/assets/img/k8s/image-20200516102419998.png",S="/assets/img/k8s/image-20200413174713773.png",q="/assets/img/k8s/image-20200413214031331.png",T="/assets/img/k8s/image-20200413215133559.png",_="/assets/img/k8s/image-20200514194111567.png",N="/assets/img/k8s/image-20200515002806726.png",V="/assets/img/k8s/image-20200520102949189.png",I="/assets/img/k8s/image-20200520103942580.png",M="/assets/img/k8s/image-20200518211037434.png",j="/assets/img/k8s/image-20200519181209566.png",L="/assets/img/k8s/image-20200520144548997.png",w="/assets/img/k8s/image-20200520144959353.png",G="/assets/img/k8s/image-20200520154628679.png",U="/assets/img/k8s/image-20200520162605102.png",O="/assets/img/k8s/image-20200520163253644.png",z="/assets/img/k8s/image-20200520163552110.png",Y="/assets/img/k8s/image-20200520163832827.png",B={},W={href:"https://www.bilibili.com/video/BV1Qv41167ck/?p=39&spm_id_from=pageDriver&vd_source=4418d5cd5be787be7e3ff4138eeb9b0a",target:"_blank",rel:"noopener noreferrer"},J={href:"https://kuboard.cn/install/v3/install-built-in.html#%E9%83%A8%E7%BD%B2%E8%AE%A1%E5%88%92",target:"_blank",rel:"noopener noreferrer"},H=p("<li><p>概述</p></li><li><p>集群搭建</p></li><li><p>资源管理方式：通过 yaml 文件配置 K8S</p></li><li><p>基础架构：Namespace，Pod，Label，Deployment，Service</p></li><li><p>Pod 详解：Pod 配置文件（环境变量，端口，资源限制等），Pod 调度（定向调度，亲和性调度等）</p></li><li><p>Pod 控制器：ReplicaSet, Deployment, 金丝雀发布, HPA, DaemonSet, Job, CronJob</p><ol><li>扩缩容 Pod，Pod 版本控制， Pod 中镜像升级，根据系统负载自动扩缩等</li></ol></li>",6),X={href:"https://zhuanlan.zhihu.com/p/526042184",target:"_blank",rel:"noopener noreferrer"},Z=s("ol",null,[s("li",null,"ClusterIP：NodePort：LoadBalancer：ExternalName："),s("li",null,[n("Ingress：通过一个 NodePort 或者一个 LB 实现暴露多个服务，效果相当于反向代理。 "),s("ol",null,[s("li",null,[n("在 Ingress 中配置， "),s("code",null,"host + path"),n(" 代理到 "),s("code",null,"targetservice+port"),n(" 的规则。path 相当于 nginx 的 location，targetsecice 相当于 upstream，service 对应到的 pods 相当于 upstream 中的 IP 地址。不同的是 ingress 中可以使用 tag 进行服务锁定。")])])])],-1),K=s("li",null,[s("p",null,"数据存储:"),s("ol",null,[s("li",null,"可使用 NFS 等实现多个 pod 之间共享数据，并且储存在外部等。对于复杂管理情况，考虑 pv,pvc 等方案。")])],-1),Q=p('<h2 id="_6-pod-控制器详解" tabindex="-1"><a class="header-anchor" href="#_6-pod-控制器详解" aria-hidden="true">#</a> 6. Pod 控制器详解</h2><h3 id="_6-1-pod-控制器介绍" tabindex="-1"><a class="header-anchor" href="#_6-1-pod-控制器介绍" aria-hidden="true">#</a> 6.1 Pod 控制器介绍</h3><p>Pod 是 kubernetes 的最小管理单元，在 kubernetes 中，按照 pod 的创建方式可以将其分为两类：</p><ul><li><strong>自主式 pod：</strong> kubernetes 直接创建出来的 Pod，这种 pod 删除后就没有了，也不会重建</li><li><strong>控制器创建的 pod：</strong> kubernetes 通过控制器创建的 pod，这种 pod 删除了之后还会自动重建</li></ul><blockquote><p><strong><code>什么是 Pod 控制器</code></strong></p><p>Pod 控制器是管理 pod 的中间层，使用 Pod 控制器之后，只需要告诉 Pod 控制器，想要多少个什么样的 Pod 就可以了，它会创建出满足条件的 Pod 并确保每一个 Pod 资源处于用户期望的目标状态。如果 Pod 资源在运行中出现故障，它会基于指定策略重新编排 Pod。</p></blockquote><p>在 kubernetes 中，有很多类型的 pod 控制器，每种都有自己的适合的场景，常见的有下面这些：</p><ul><li>ReplicationController：比较原始的 pod 控制器，已经被废弃，由 ReplicaSet 替代</li><li>ReplicaSet：保证副本数量一直维持在期望值，并支持 pod 数量扩缩容，镜像版本升级</li><li><strong>Deployment：</strong> 通过控制 ReplicaSet 来控制 Pod，并支持滚动升级、回退版本</li><li><strong>Horizontal Pod Autoscaler：</strong> 可以根据集群负载自动水平调整 Pod 的数量，实现削峰填谷</li><li><strong>DaemonSet：</strong> 在集群中的指定 Node 上运行且仅运行一个副本，一般用于守护进程类的任务</li><li>Job：它创建出来的 pod 只要完成任务就立即退出，不需要重启或重建，用于执行一次性任务</li><li><strong>Cronjob：</strong> 它创建的 Pod 负责周期性任务控制，不需要持续后台运行</li><li>StatefulSet：管理有状态应用</li></ul><h3 id="_6-2-replicaset-rs" tabindex="-1"><a class="header-anchor" href="#_6-2-replicaset-rs" aria-hidden="true">#</a> 6.2 ReplicaSet(RS)</h3><p>ReplicaSet 的主要作用是 <strong>保证一定数量的 pod 正常运行</strong> ，它会持续监听这些 Pod 的运行状态，一旦 Pod 发生故障，就会重启或重建。同时它还支持对 pod 数量的扩缩容和镜像版本的升降级。</p><figure><img src="'+t+`" alt="相关图片" tabindex="0" loading="lazy"><figcaption>相关图片</figcaption></figure><p>ReplicaSet 的资源清单文件：</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">apps/v1</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 版本号</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ReplicaSet</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 类型       </span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># 元数据</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># rs 名称 </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># 所属命名空间 </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">: </span><span style="color:#6A737D;">#标签</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">controller</span><span style="color:#24292E;">: </span><span style="color:#032F62;">rs</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># 详情描述</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">replicas</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">3</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 副本数量</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># 选择器，通过它指定该控制器管理哪些 pod</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">matchLabels</span><span style="color:#24292E;">:      </span><span style="color:#6A737D;"># Labels 匹配规则</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx-pod</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">matchExpressions</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># Expressions 匹配规则</span></span>
<span class="line"><span style="color:#24292E;">      - {</span><span style="color:#22863A;">key</span><span style="color:#24292E;">: </span><span style="color:#032F62;">app</span><span style="color:#24292E;">, </span><span style="color:#22863A;">operator</span><span style="color:#24292E;">: </span><span style="color:#032F62;">In</span><span style="color:#24292E;">, </span><span style="color:#22863A;">values</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">nginx-pod</span><span style="color:#24292E;">]}</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">template</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># 模板，当副本数量不足时，会根据下面的模板创建 pod 副本</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx-pod</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx:1.17.1</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">containerPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在这里面，需要新了解的配置项就是<code>spec</code>下面几个选项：</p><ul><li><p>replicas：指定副本数量，其实就是当前 rs 创建出来的 pod 的数量，默认为 1</p></li><li><p>selector：选择器，它的作用是建立 pod 控制器和 pod 之间的关联关系，采用的 Label Selector 机制</p><p>在 pod 模板上定义 label，在控制器上定义选择器，就可以表明当前控制器能管理哪些 pod 了</p></li><li><p>template：模板，就是当前控制器创建 pod 所使用的模板板，里面其实就是前一章学过的 pod 的定义</p></li></ul><h4 id="创建-replicaset" tabindex="-1"><a class="header-anchor" href="#创建-replicaset" aria-hidden="true">#</a> <strong>创建 ReplicaSet</strong></h4><p>创建 pc-replicaset.yaml 文件，内容如下：</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">apps/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ReplicaSet</span><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">pc-replicaset</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">dev</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">replicas</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">3</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">: </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">matchLabels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx-pod</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">template</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx-pod</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx:1.17.1</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># 创建 rs</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl create -f pc-replicaset.yaml</span></span>
<span class="line"><span style="color:#6F42C1;">replicaset.apps/pc-replicaset</span><span style="color:#24292E;"> </span><span style="color:#032F62;">created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看 rs</span></span>
<span class="line"><span style="color:#6A737D;"># DESIRED:期望副本数量  </span></span>
<span class="line"><span style="color:#6A737D;"># CURRENT:当前副本数量  </span></span>
<span class="line"><span style="color:#6A737D;"># READY:已经准备好提供服务的副本数量</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get rs pc-replicaset -n dev -o wide</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">          </span><span style="color:#032F62;">DESIRED</span><span style="color:#24292E;">   </span><span style="color:#032F62;">CURRENT</span><span style="color:#24292E;"> </span><span style="color:#032F62;">READY</span><span style="color:#24292E;"> </span><span style="color:#032F62;">AGE</span><span style="color:#24292E;">   </span><span style="color:#032F62;">CONTAINERS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">IMAGES</span><span style="color:#24292E;">             </span><span style="color:#032F62;">SELECTOR</span></span>
<span class="line"><span style="color:#6F42C1;">pc-replicaset</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">3</span><span style="color:#24292E;">       </span><span style="color:#005CC5;">3</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">22</span><span style="color:#032F62;">s</span><span style="color:#24292E;">   </span><span style="color:#032F62;">nginx</span><span style="color:#24292E;">        </span><span style="color:#032F62;">nginx:1.17.1</span><span style="color:#24292E;">       </span><span style="color:#032F62;">app=nginx-pod</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看当前控制器创建出来的 pod</span></span>
<span class="line"><span style="color:#6A737D;"># 这里发现控制器创建出来的 pod 的名称是在控制器名称后面拼接了-xxxxx 随机码</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get pod -n dev</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                          </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">    </span><span style="color:#032F62;">RESTARTS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">pc-replicaset-6vmvt</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">54</span><span style="color:#032F62;">s</span></span>
<span class="line"><span style="color:#6F42C1;">pc-replicaset-fmb8f</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">54</span><span style="color:#032F62;">s</span></span>
<span class="line"><span style="color:#6F42C1;">pc-replicaset-snrk2</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">54</span><span style="color:#032F62;">s</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="扩缩容" tabindex="-1"><a class="header-anchor" href="#扩缩容" aria-hidden="true">#</a> <strong>扩缩容</strong></h4><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># 编辑 rs 的副本数量，修改 spec:replicas: 6 即可</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl edit rs pc-replicaset -n dev</span></span>
<span class="line"><span style="color:#6F42C1;">replicaset.apps/pc-replicaset</span><span style="color:#24292E;"> </span><span style="color:#032F62;">edited</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看 pod</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get pods -n dev</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                          </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">    </span><span style="color:#032F62;">RESTARTS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">pc-replicaset-6vmvt</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">114</span><span style="color:#032F62;">m</span></span>
<span class="line"><span style="color:#6F42C1;">pc-replicaset-cftnp</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">10</span><span style="color:#032F62;">s</span></span>
<span class="line"><span style="color:#6F42C1;">pc-replicaset-fjlm6</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">10</span><span style="color:#032F62;">s</span></span>
<span class="line"><span style="color:#6F42C1;">pc-replicaset-fmb8f</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">114</span><span style="color:#032F62;">m</span></span>
<span class="line"><span style="color:#6F42C1;">pc-replicaset-s2whj</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">10</span><span style="color:#032F62;">s</span></span>
<span class="line"><span style="color:#6F42C1;">pc-replicaset-snrk2</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">114</span><span style="color:#032F62;">m</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 当然也可以直接使用命令实现</span></span>
<span class="line"><span style="color:#6A737D;"># 使用 scale 命令实现扩缩容， 后面--replicas=n 直接指定目标数量即可</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl scale rs pc-replicaset --replicas=2 -n dev</span></span>
<span class="line"><span style="color:#6F42C1;">replicaset.apps/pc-replicaset</span><span style="color:#24292E;"> </span><span style="color:#032F62;">scaled</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 命令运行完毕，立即查看，发现已经有 4 个开始准备退出了</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get pods -n dev</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                       </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">        </span><span style="color:#032F62;">RESTARTS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">pc-replicaset-6vmvt</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Terminating</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">118</span><span style="color:#032F62;">m</span></span>
<span class="line"><span style="color:#6F42C1;">pc-replicaset-cftnp</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Terminating</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">4</span><span style="color:#032F62;">m17s</span></span>
<span class="line"><span style="color:#6F42C1;">pc-replicaset-fjlm6</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Terminating</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">4</span><span style="color:#032F62;">m17s</span></span>
<span class="line"><span style="color:#6F42C1;">pc-replicaset-fmb8f</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">       </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">118</span><span style="color:#032F62;">m</span></span>
<span class="line"><span style="color:#6F42C1;">pc-replicaset-s2whj</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Terminating</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">4</span><span style="color:#032F62;">m17s</span></span>
<span class="line"><span style="color:#6F42C1;">pc-replicaset-snrk2</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">       </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">118</span><span style="color:#032F62;">m</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#稍等片刻，就只剩下 2 个了</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get pods -n dev</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                       </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">    </span><span style="color:#032F62;">RESTARTS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">pc-replicaset-fmb8f</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">119</span><span style="color:#032F62;">m</span></span>
<span class="line"><span style="color:#6F42C1;">pc-replicaset-snrk2</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">119</span><span style="color:#032F62;">m</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="镜像升级" tabindex="-1"><a class="header-anchor" href="#镜像升级" aria-hidden="true">#</a> <strong>镜像升级</strong></h4><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># 编辑 rs 的容器镜像 - image: nginx:1.17.2</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl edit rs pc-replicaset -n dev</span></span>
<span class="line"><span style="color:#6F42C1;">replicaset.apps/pc-replicaset</span><span style="color:#24292E;"> </span><span style="color:#032F62;">edited</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 再次查看，发现镜像版本已经变更了</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get rs -n dev -o wide</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                </span><span style="color:#032F62;">DESIRED</span><span style="color:#24292E;">  </span><span style="color:#032F62;">CURRENT</span><span style="color:#24292E;">   </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span><span style="color:#24292E;">    </span><span style="color:#032F62;">CONTAINERS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">IMAGES</span><span style="color:#24292E;">        </span><span style="color:#032F62;">...</span></span>
<span class="line"><span style="color:#6F42C1;">pc-replicaset</span><span style="color:#24292E;">       </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">       </span><span style="color:#005CC5;">140</span><span style="color:#032F62;">m</span><span style="color:#24292E;">   </span><span style="color:#032F62;">nginx</span><span style="color:#24292E;">         </span><span style="color:#032F62;">nginx:1.17.2</span><span style="color:#24292E;">  </span><span style="color:#032F62;">...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 同样的道理，也可以使用命令完成这个工作</span></span>
<span class="line"><span style="color:#6A737D;"># kubectl set image rs rs 名称 容器=镜像版本 -n namespace</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl set image rs pc-replicaset nginx=nginx:1.17.1  -n dev</span></span>
<span class="line"><span style="color:#6F42C1;">replicaset.apps/pc-replicaset</span><span style="color:#24292E;"> </span><span style="color:#032F62;">image</span><span style="color:#24292E;"> </span><span style="color:#032F62;">updated</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 再次查看，发现镜像版本已经变更了</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get rs -n dev -o wide</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                 </span><span style="color:#032F62;">DESIRED</span><span style="color:#24292E;">  </span><span style="color:#032F62;">CURRENT</span><span style="color:#24292E;">   </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span><span style="color:#24292E;">    </span><span style="color:#032F62;">CONTAINERS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">IMAGES</span><span style="color:#24292E;">            </span><span style="color:#032F62;">...</span></span>
<span class="line"><span style="color:#6F42C1;">pc-replicaset</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">       </span><span style="color:#005CC5;">145</span><span style="color:#032F62;">m</span><span style="color:#24292E;">   </span><span style="color:#032F62;">nginx</span><span style="color:#24292E;">        </span><span style="color:#032F62;">nginx:1.17.1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">...</span><span style="color:#24292E;"> </span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="删除-replicaset" tabindex="-1"><a class="header-anchor" href="#删除-replicaset" aria-hidden="true">#</a> <strong>删除 ReplicaSet</strong></h4><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># 使用 kubectl delete 命令会删除此 RS 以及它管理的 Pod</span></span>
<span class="line"><span style="color:#6A737D;"># 在 kubernetes 删除 RS 前，会将 RS 的 replicasclear 调整为 0，等待所有的 Pod 被删除后，在执行 RS 对象的删除</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl delete rs pc-replicaset -n dev</span></span>
<span class="line"><span style="color:#6F42C1;">replicaset.apps</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;pc-replicaset&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">deleted</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get pod -n dev -o wide</span></span>
<span class="line"><span style="color:#6F42C1;">No</span><span style="color:#24292E;"> </span><span style="color:#032F62;">resources</span><span style="color:#24292E;"> </span><span style="color:#032F62;">found</span><span style="color:#24292E;"> </span><span style="color:#032F62;">in</span><span style="color:#24292E;"> </span><span style="color:#032F62;">dev</span><span style="color:#24292E;"> </span><span style="color:#032F62;">namespace.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 如果希望仅仅删除 RS 对象（保留 Pod），可以使用 kubectl delete 命令时添加--cascade=false 选项（不推荐）。</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl delete rs pc-replicaset -n dev --cascade=false</span></span>
<span class="line"><span style="color:#6F42C1;">replicaset.apps</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;pc-replicaset&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">deleted</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get pods -n dev</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                  </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">    </span><span style="color:#032F62;">RESTARTS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">pc-replicaset-cl82j</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">75</span><span style="color:#032F62;">s</span></span>
<span class="line"><span style="color:#6F42C1;">pc-replicaset-dslhb</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">75</span><span style="color:#032F62;">s</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 也可以使用 yaml 直接删除(推荐)</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl delete -f pc-replicaset.yaml</span></span>
<span class="line"><span style="color:#6F42C1;">replicaset.apps</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;pc-replicaset&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">deleted</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-3-deployment-deploy" tabindex="-1"><a class="header-anchor" href="#_6-3-deployment-deploy" aria-hidden="true">#</a> 6.3 Deployment(Deploy)</h3><p>为了更好的解决服务编排的问题，kubernetes 在 V1.2 版本开始，引入了 Deployment 控制器。值得一提的是，这种控制器并不直接管理 pod，而是通过管理 ReplicaSet 来简介管理 Pod，即：Deployment 管理 ReplicaSet，ReplicaSet 管理 Pod。所以 Deployment 比 ReplicaSet 功能更加强大。</p><figure><img src="`+i+`" alt="相关图片" tabindex="0" loading="lazy"><figcaption>相关图片</figcaption></figure><p>Deployment 主要功能有下面几个：</p><ul><li>支持 ReplicaSet 的所有功能</li><li>支持发布的停止、继续</li><li>支持滚动升级和回滚版本</li></ul><p>Deployment 的资源清单文件：</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">apps/v1</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 版本号</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Deployment</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 类型       </span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># 元数据</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># rs 名称 </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># 所属命名空间 </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">: </span><span style="color:#6A737D;">#标签</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">controller</span><span style="color:#24292E;">: </span><span style="color:#032F62;">deploy</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># 详情描述</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">replicas</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">3</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 副本数量</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">revisionHistoryLimit</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">3</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 保留历史版本</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">paused</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">false</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 暂停部署，默认是 false</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">progressDeadlineSeconds</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">600</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 部署超时时间（s），默认是 600</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">strategy</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># 策略</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">type</span><span style="color:#24292E;">: </span><span style="color:#032F62;">RollingUpdate</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 滚动更新策略</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">rollingUpdate</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># 滚动更新</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">违规词汇</span><span style="color:#24292E;">: </span><span style="color:#032F62;">30%</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 最大额外可以存在的副本数，可以为百分比，也可以为整数</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">maxUnavailable</span><span style="color:#24292E;">: </span><span style="color:#032F62;">30%</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 最大不可用状态的 Pod 的最大值，可以为百分比，也可以为整数</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># 选择器，通过它指定该控制器管理哪些 pod</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">matchLabels</span><span style="color:#24292E;">:      </span><span style="color:#6A737D;"># Labels 匹配规则</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx-pod</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">matchExpressions</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># Expressions 匹配规则</span></span>
<span class="line"><span style="color:#24292E;">      - {</span><span style="color:#22863A;">key</span><span style="color:#24292E;">: </span><span style="color:#032F62;">app</span><span style="color:#24292E;">, </span><span style="color:#22863A;">operator</span><span style="color:#24292E;">: </span><span style="color:#032F62;">In</span><span style="color:#24292E;">, </span><span style="color:#22863A;">values</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">nginx-pod</span><span style="color:#24292E;">]}</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">template</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># 模板，当副本数量不足时，会根据下面的模板创建 pod 副本</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx-pod</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx:1.17.1</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">containerPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_6-3-1-创建-deployment" tabindex="-1"><a class="header-anchor" href="#_6-3-1-创建-deployment" aria-hidden="true">#</a> 6.3.1 创建 deployment</h4><p>创建 pc-deployment.yaml，内容如下：</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">apps/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Deployment</span><span style="color:#24292E;">      </span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">pc-deployment</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">dev</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">: </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">replicas</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">3</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">matchLabels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx-pod</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">template</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx-pod</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx:1.17.1</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_6-3-2-扩缩容" tabindex="-1"><a class="header-anchor" href="#_6-3-2-扩缩容" aria-hidden="true">#</a> 6.3.2 扩缩容</h4><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># 变更副本数量为 5 个</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl scale deploy pc-deployment --replicas=5  -n dev</span></span>
<span class="line"><span style="color:#6F42C1;">deployment.apps/pc-deployment</span><span style="color:#24292E;"> </span><span style="color:#032F62;">scaled</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看 deployment</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get deploy pc-deployment -n dev</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">            </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">UP-TO-DATE</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AVAILABLE</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">pc-deployment</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">5</span><span style="color:#032F62;">/5</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">5</span><span style="color:#24292E;">            </span><span style="color:#005CC5;">5</span><span style="color:#24292E;">           </span><span style="color:#005CC5;">2</span><span style="color:#032F62;">m</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看 pod</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]#  kubectl get pods -n dev</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                             </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">    </span><span style="color:#032F62;">RESTARTS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">pc-deployment-6696798b78-d2c8n</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">4</span><span style="color:#032F62;">m19s</span></span>
<span class="line"><span style="color:#6F42C1;">pc-deployment-6696798b78-jxmdq</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">94</span><span style="color:#032F62;">s</span></span>
<span class="line"><span style="color:#6F42C1;">pc-deployment-6696798b78-mktqv</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">93</span><span style="color:#032F62;">s</span></span>
<span class="line"><span style="color:#6F42C1;">pc-deployment-6696798b78-smpvp</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">4</span><span style="color:#032F62;">m19s</span></span>
<span class="line"><span style="color:#6F42C1;">pc-deployment-6696798b78-wvjd8</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">4</span><span style="color:#032F62;">m19s</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 编辑 deployment 的副本数量，修改 spec:replicas: 4 即可</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl edit deploy pc-deployment -n dev</span></span>
<span class="line"><span style="color:#6F42C1;">deployment.apps/pc-deployment</span><span style="color:#24292E;"> </span><span style="color:#032F62;">edited</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看 pod</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get pods -n dev</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                             </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">    </span><span style="color:#032F62;">RESTARTS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">pc-deployment-6696798b78-d2c8n</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">5</span><span style="color:#032F62;">m23s</span></span>
<span class="line"><span style="color:#6F42C1;">pc-deployment-6696798b78-jxmdq</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">2</span><span style="color:#032F62;">m38s</span></span>
<span class="line"><span style="color:#6F42C1;">pc-deployment-6696798b78-smpvp</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">5</span><span style="color:#032F62;">m23s</span></span>
<span class="line"><span style="color:#6F42C1;">pc-deployment-6696798b78-wvjd8</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">5</span><span style="color:#032F62;">m23s</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>镜像更新</strong></p><p>deployment 支持两种更新策略:<code>重建更新</code>和<code>滚动更新</code>,可以通过<code>strategy</code>指定策略类型,支持两个属性:</p><div class="language-markdown line-numbers-mode" data-ext="md"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#24292E;">strategy：指定新的 Pod 替换旧的 Pod 的策略， 支持两个属性：</span></span>
<span class="line"><span style="color:#24292E;">  type：指定策略类型，支持两种策略</span></span>
<span class="line"><span style="color:#24292E;">    Recreate：在创建出新的 Pod 之前会先杀掉所有已存在的 Pod</span></span>
<span class="line"><span style="color:#24292E;">    RollingUpdate：滚动更新，就是杀死一部分，就启动一部分，在更新过程中，存在两个版本 Pod</span></span>
<span class="line"><span style="color:#24292E;">  rollingUpdate：当 type 为 RollingUpdate 时生效，用于为 RollingUpdate 设置参数，支持两个属性：</span></span>
<span class="line"><span style="color:#24292E;">    maxUnavailable：用来指定在升级过程中不可用 Pod 的最大数量，默认为 25%。</span></span>
<span class="line"><span style="color:#24292E;">    违规词汇： 用来指定在升级过程中可以超过期望的 Pod 的最大数量，默认为 25%。</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>重建更新 ( 在创建出新的 Pod 之前会先杀掉所有已存在的 Pod )</p><ol><li>编辑 pc-deployment.yaml,在 spec 节点下添加更新策略</li></ol><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">strategy</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># 策略</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">type</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Recreate</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 重建更新</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>创建 deploy 进行验证</li></ol><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># 变更镜像</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl set image deployment pc-deployment nginx=nginx:1.17.2 -n dev</span></span>
<span class="line"><span style="color:#6F42C1;">deployment.apps/pc-deployment</span><span style="color:#24292E;"> </span><span style="color:#032F62;">image</span><span style="color:#24292E;"> </span><span style="color:#032F62;">updated</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 观察升级过程</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]#  kubectl get pods -n dev -w</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>滚动更新</p><ol><li>编辑 pc-deployment.yaml,在 spec 节点下添加更新策略</li></ol><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">strategy</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># 策略</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">type</span><span style="color:#24292E;">: </span><span style="color:#032F62;">RollingUpdate</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 滚动更新策略</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">rollingUpdate</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">违规词汇</span><span style="color:#24292E;">: </span><span style="color:#032F62;">25%</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">maxUnavailable</span><span style="color:#24292E;">: </span><span style="color:#032F62;">25%</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>创建 deploy 进行验证</li></ol><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># 变更镜像</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl set image deployment pc-deployment nginx=nginx:1.17.3 -n dev </span></span>
<span class="line"><span style="color:#6F42C1;">deployment.apps/pc-deployment</span><span style="color:#24292E;"> </span><span style="color:#032F62;">image</span><span style="color:#24292E;"> </span><span style="color:#032F62;">updated</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 至此，新版本的 pod 创建完毕，就版本的 pod 销毁完毕</span></span>
<span class="line"><span style="color:#6A737D;"># 中间过程是滚动进行的，也就是边销毁边创建</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>滚动更新的过程：</p><figure><img src="`+y+`" alt="相关图片" tabindex="0" loading="lazy"><figcaption>相关图片</figcaption></figure><p><strong>镜像更新中 rs 的变化</strong></p><p>查看 rs,发现原来的 rs 的依旧存在，只是 pod 数量变为了 0，而后又新产生了一个 rs，pod 数量为 4。其实这就是 deployment 能够进行版本回退的奥妙所在，后面会详细解释。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get rs -n dev</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                       </span><span style="color:#032F62;">DESIRED</span><span style="color:#24292E;">   </span><span style="color:#032F62;">CURRENT</span><span style="color:#24292E;">   </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">pc-deployment-6696798b78</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">       </span><span style="color:#005CC5;">7</span><span style="color:#032F62;">m37s</span></span>
<span class="line"><span style="color:#6F42C1;">pc-deployment-6696798b11</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">       </span><span style="color:#005CC5;">5</span><span style="color:#032F62;">m37s</span></span>
<span class="line"><span style="color:#6F42C1;">pc-deployment-c848d76789</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">4</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">4</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">4</span><span style="color:#24292E;">       </span><span style="color:#005CC5;">72</span><span style="color:#032F62;">s</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_6-3-3-版本回退" tabindex="-1"><a class="header-anchor" href="#_6-3-3-版本回退" aria-hidden="true">#</a> 6.3.3 版本回退</h4><p>deployment 支持版本升级过程中的暂停、继续功能以及版本回退等诸多功能，下面具体来看.</p><p>kubectl rollout： 版本升级相关功能，支持下面的选项：</p><ul><li><code>status</code> 显示当前升级状态</li><li><code>history</code> 显示 升级历史记录</li><li><code>pause</code> 暂停版本升级过程</li><li><code>resume</code> 继续已经暂停的版本升级过程</li><li><code>restart</code> 重启版本升级过程</li><li><code>undo</code> 回滚到上一级版本（可以使用--to-revision 回滚到指定版本）</li></ul><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># 查看当前升级版本的状态</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rollout</span><span style="color:#24292E;"> </span><span style="color:#032F62;">status</span><span style="color:#24292E;"> </span><span style="color:#032F62;">deploy</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pc-deployment</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-n</span><span style="color:#24292E;"> </span><span style="color:#032F62;">dev</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看升级历史记录</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rollout</span><span style="color:#24292E;"> </span><span style="color:#032F62;">history</span><span style="color:#24292E;"> </span><span style="color:#032F62;">deploy</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pc-deployment</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-n</span><span style="color:#24292E;"> </span><span style="color:#032F62;">dev</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 可以发现有三次版本记录，说明完成过两次升级</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>版本回滚</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># 这里直接使用--to-revision=1 回滚到了 1 版本， 如果省略这个选项，就是回退到上个版本，就是 2 版本</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rollout</span><span style="color:#24292E;"> </span><span style="color:#032F62;">undo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">deployment</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pc-deployment</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--to-revision=1</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-n</span><span style="color:#24292E;"> </span><span style="color:#032F62;">dev</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>查看发现，通过 nginx 镜像版本可以发现到了第一版</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get deploy -n dev -o wide</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">            </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">UP-TO-DATE</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AVAILABLE</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span><span style="color:#24292E;">   </span><span style="color:#032F62;">CONTAINERS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">IMAGES</span><span style="color:#24292E;">         </span></span>
<span class="line"><span style="color:#6F42C1;">pc-deployment</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">4</span><span style="color:#032F62;">/4</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">4</span><span style="color:#24292E;">            </span><span style="color:#005CC5;">4</span><span style="color:#24292E;">           </span><span style="color:#005CC5;">74</span><span style="color:#032F62;">m</span><span style="color:#24292E;">   </span><span style="color:#032F62;">nginx</span><span style="color:#24292E;">        </span><span style="color:#032F62;">nginx:1.17.1</span><span style="color:#24292E;">   </span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看 rs，发现第一个 rs 中有 4 个 pod 运行，后面两个版本的 rs 中 pod 为运行</span></span>
<span class="line"><span style="color:#6A737D;"># 其实 deployment 之所以可是实现版本的回滚，就是通过记录下历史 rs 来实现的，</span></span>
<span class="line"><span style="color:#6A737D;"># 一旦想回滚到哪个版本，只需要将当前版本 pod 数量降为 0，然后将回滚版本的 pod 提升为目标数量就可以了</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get rs -n dev</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                       </span><span style="color:#032F62;">DESIRED</span><span style="color:#24292E;">   </span><span style="color:#032F62;">CURRENT</span><span style="color:#24292E;">   </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">pc-deployment-6696798b78</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">4</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">4</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">4</span><span style="color:#24292E;">       </span><span style="color:#005CC5;">78</span><span style="color:#032F62;">m</span></span>
<span class="line"><span style="color:#6F42C1;">pc-deployment-966bf7f44</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">       </span><span style="color:#005CC5;">37</span><span style="color:#032F62;">m</span></span>
<span class="line"><span style="color:#6F42C1;">pc-deployment-c848d767</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">       </span><span style="color:#005CC5;">71</span><span style="color:#032F62;">m</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_6-3-4-金丝雀发布" tabindex="-1"><a class="header-anchor" href="#_6-3-4-金丝雀发布" aria-hidden="true">#</a> 6.3.4 金丝雀发布</h4><p>Deployment 控制器支持控制更新过程中的控制，如“暂停(pause)”或“继续(resume)”更新操作。</p><p>比如有一批新的 Pod 资源创建完成后立即暂停更新过程，此时，仅存在一部分新版本的应用，主体部分还是旧的版本。然后，再筛选一小部分的用户请求路由到新版本的 Pod 应用，继续观察能否稳定地按期望的方式运行。确定没问题之后再继续完成余下的 Pod 资源滚动更新，否则立即回滚更新操作。这就是所谓的金丝雀发布。</p><p>更新 deployment 的版本，并配置暂停 deployment</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">set</span><span style="color:#24292E;"> </span><span style="color:#032F62;">image</span><span style="color:#24292E;"> </span><span style="color:#032F62;">deploy</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pc-deployment</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nginx=nginx:1.17.4</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-n</span><span style="color:#24292E;"> </span><span style="color:#032F62;">dev</span><span style="color:#24292E;"> &amp;&amp; </span><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rollout</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pause</span><span style="color:#24292E;"> </span><span style="color:#032F62;">deployment</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pc-deployment</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">-n</span><span style="color:#24292E;"> </span><span style="color:#032F62;">dev</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6A737D;">#观察更新状态</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl rollout status deploy pc-deployment -n dev　</span></span>
<span class="line"><span style="color:#6F42C1;">Waiting</span><span style="color:#24292E;"> </span><span style="color:#032F62;">for</span><span style="color:#24292E;"> </span><span style="color:#032F62;">deployment</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;pc-deployment&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rollout</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#032F62;">finish:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;"> </span><span style="color:#032F62;">out</span><span style="color:#24292E;"> </span><span style="color:#032F62;">of</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">4</span><span style="color:#24292E;"> </span><span style="color:#032F62;">new</span><span style="color:#24292E;"> </span><span style="color:#032F62;">replicas</span><span style="color:#24292E;"> </span><span style="color:#032F62;">have</span><span style="color:#24292E;"> </span><span style="color:#032F62;">been</span><span style="color:#24292E;"> </span><span style="color:#032F62;">updated...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 监控更新的过程，可以看到已经新增了一个资源，但是并未按照预期的状态去删除一个旧的资源，就是因为使用了 pause 暂停命令</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get rs -n dev -o wide</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                       </span><span style="color:#032F62;">DESIRED</span><span style="color:#24292E;">   </span><span style="color:#032F62;">CURRENT</span><span style="color:#24292E;">   </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span><span style="color:#24292E;">     </span><span style="color:#032F62;">CONTAINERS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">IMAGES</span><span style="color:#24292E;">         </span></span>
<span class="line"><span style="color:#6F42C1;">pc-deployment-5d89bdfbf9</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">3</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">3</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">3</span><span style="color:#24292E;">       </span><span style="color:#005CC5;">19</span><span style="color:#032F62;">m</span><span style="color:#24292E;">     </span><span style="color:#032F62;">nginx</span><span style="color:#24292E;">        </span><span style="color:#032F62;">nginx:1.17.1</span><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#6F42C1;">pc-deployment-675d469f8b</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">       </span><span style="color:#005CC5;">14</span><span style="color:#032F62;">m</span><span style="color:#24292E;">     </span><span style="color:#032F62;">nginx</span><span style="color:#24292E;">        </span><span style="color:#032F62;">nginx:1.17.2</span><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#6F42C1;">pc-deployment-6c9f56fcfb</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">       </span><span style="color:#005CC5;">3</span><span style="color:#032F62;">m16s</span><span style="color:#24292E;">   </span><span style="color:#032F62;">nginx</span><span style="color:#24292E;">        </span><span style="color:#032F62;">nginx:1.17.4</span><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get pods -n dev</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                             </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">    </span><span style="color:#032F62;">RESTARTS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">pc-deployment-5d89bdfbf9-rj8sq</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">7</span><span style="color:#032F62;">m33s</span></span>
<span class="line"><span style="color:#6F42C1;">pc-deployment-5d89bdfbf9-ttwgg</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">7</span><span style="color:#032F62;">m35s</span></span>
<span class="line"><span style="color:#6F42C1;">pc-deployment-5d89bdfbf9-v4wvc</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">7</span><span style="color:#032F62;">m34s</span></span>
<span class="line"><span style="color:#6F42C1;">pc-deployment-6c9f56fcfb-996rt</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">3</span><span style="color:#032F62;">m31s</span></span>
<span class="line"><span style="color:#6F42C1;">pc-deployment-6c9f56fcfb-j2gtj</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">3</span><span style="color:#032F62;">m31s</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>确保更新的 pod 没问题了，继续更新</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rollout</span><span style="color:#24292E;"> </span><span style="color:#032F62;">resume</span><span style="color:#24292E;"> </span><span style="color:#032F62;">deploy</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pc-deployment</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-n</span><span style="color:#24292E;"> </span><span style="color:#032F62;">dev</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>删除 Deployment</strong></p><p>删除 deployment，其下的 rs 和 pod 也将被删除</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">delete</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pc-deployment.yaml</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="_6-4-horizontal-pod-autoscaler-hpa" tabindex="-1"><a class="header-anchor" href="#_6-4-horizontal-pod-autoscaler-hpa" aria-hidden="true">#</a> 6.4 Horizontal Pod Autoscaler(HPA)</h3><p>在前面的课程中，我们已经可以实现通过手工执行<code>kubectl scale</code>命令实现 Pod 扩容或缩容，但是这显然不符合 Kubernetes 的定位目标--自动化、智能化。 Kubernetes 期望可以实现通过监测 Pod 的使用情况，实现 pod 数量的自动调整，于是就产生了 Horizontal Pod Autoscaler（HPA）这种控制器。</p><p>HPA 可以获取每个 Pod 利用率，然后和 HPA 中定义的指标进行对比，同时计算出需要伸缩的具体值，最后实现 Pod 的数量的调整。其实 HPA 与之前的 Deployment 一样，也属于一种 Kubernetes 资源对象，它通过追踪分析 RC 控制的所有目标 Pod 的负载变化情况，来确定是否需要针对性地调整目标 Pod 的副本数，这是 HPA 的实现原理。</p><figure><img src="`+d+`" alt="相关图片" height="300" tabindex="0" loading="lazy"><figcaption>相关图片</figcaption></figure><p>接下来，我们来做一个实验</p><h4 id="_6-4-1-安装-metrics-server" tabindex="-1"><a class="header-anchor" href="#_6-4-1-安装-metrics-server" aria-hidden="true">#</a> 6.4.1 安装 metrics-server</h4><p>metrics-server 可以用来收集集群中的资源使用情况</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6F42C1;">yum</span><span style="color:#24292E;"> </span><span style="color:#032F62;">install</span><span style="color:#24292E;"> </span><span style="color:#032F62;">git</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-y</span></span>
<span class="line"><span style="color:#6A737D;"># 获取 metrics-server, 注意使用的版本</span></span>
<span class="line"><span style="color:#6F42C1;">git</span><span style="color:#24292E;"> </span><span style="color:#032F62;">clone</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-b</span><span style="color:#24292E;"> </span><span style="color:#032F62;">v0.3.6</span><span style="color:#24292E;"> </span><span style="color:#032F62;">https://github.com/kubernetes-incubator/metrics-server</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>修改 deployment, 注意修改的是镜像和初始化参数</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# cd /root/metrics-server/deploy/1.8+/</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#005CC5;">1.8</span><span style="color:#24292E;">+]# vim metrics-server-deployment.yaml</span></span>
<span class="line"><span style="color:#6A737D;"># 按图中添加下面选项</span></span>
<span class="line"><span style="color:#6F42C1;">hostNetwork:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#6F42C1;">image:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">registry.cn-hangzhou.aliyuncs.com/google_containers/metrics-server-amd64:v0.3.6</span></span>
<span class="line"><span style="color:#6F42C1;">args:</span></span>
<span class="line"><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--kubelet-insecure-tls</span></span>
<span class="line"><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--kubelet-preferred-address-types=InternalIP,Hostname,InternalDNS,ExternalDNS,ExternalIP</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="`+v+`" alt="相关图片" tabindex="0" loading="lazy"><figcaption>相关图片</figcaption></figure><p>安装 metrics-server</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">apply</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#032F62;">./</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>查看资源使用情况</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># 查看 pod 运行情况</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#005CC5;">1.8</span><span style="color:#24292E;">+]# kubectl get pod -n kube-system</span></span>
<span class="line"><span style="color:#6F42C1;">metrics-server-6b976979db-2xwbj</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">90</span><span style="color:#032F62;">s</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 使用 kubectl top node 查看资源使用情况（稍微等一下）</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#005CC5;">1.8</span><span style="color:#24292E;">+]# kubectl top node</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">           </span><span style="color:#032F62;">CPU</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">cores</span><span style="color:#24292E;">)   </span><span style="color:#032F62;">CPU%</span><span style="color:#24292E;">   </span><span style="color:#032F62;">MEMORY</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">bytes</span><span style="color:#24292E;">)   </span><span style="color:#032F62;">MEMORY%</span></span>
<span class="line"><span style="color:#6F42C1;">k8s-master01</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">289</span><span style="color:#032F62;">m</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">14</span><span style="color:#032F62;">%</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">1582</span><span style="color:#032F62;">Mi</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">54</span><span style="color:#032F62;">%</span><span style="color:#24292E;">       </span></span>
<span class="line"><span style="color:#6F42C1;">k8s-node01</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">81</span><span style="color:#032F62;">m</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">4</span><span style="color:#032F62;">%</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">1195</span><span style="color:#032F62;">Mi</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">40</span><span style="color:#032F62;">%</span><span style="color:#24292E;">       </span></span>
<span class="line"><span style="color:#6F42C1;">k8s-node02</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">72</span><span style="color:#032F62;">m</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">3</span><span style="color:#032F62;">%</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">1211</span><span style="color:#032F62;">Mi</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">41</span><span style="color:#032F62;">%</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#005CC5;">1.8</span><span style="color:#24292E;">+]# kubectl top pod -n kube-system</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                              </span><span style="color:#032F62;">CPU</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">cores</span><span style="color:#24292E;">)   </span><span style="color:#032F62;">MEMORY</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">bytes</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#6F42C1;">coredns-6955765f44-7ptsb</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">3</span><span style="color:#032F62;">m</span><span style="color:#24292E;">           </span><span style="color:#005CC5;">9</span><span style="color:#032F62;">Mi</span></span>
<span class="line"><span style="color:#6F42C1;">coredns-6955765f44-vcwr5</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">3</span><span style="color:#032F62;">m</span><span style="color:#24292E;">           </span><span style="color:#005CC5;">8</span><span style="color:#032F62;">Mi</span></span>
<span class="line"><span style="color:#6F42C1;">etcd-master</span><span style="color:#24292E;">                       </span><span style="color:#005CC5;">14</span><span style="color:#032F62;">m</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">145</span><span style="color:#032F62;">Mi</span></span>
<span class="line"><span style="color:#005CC5;">...</span></span>
<span class="line"><span style="color:#6A737D;"># 至此,metrics-server 安装完成</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_6-4-2-准备-deployment-和-servie" tabindex="-1"><a class="header-anchor" href="#_6-4-2-准备-deployment-和-servie" aria-hidden="true">#</a> 6.4.2 准备 deployment 和 servie</h4><p>创建 pc-hpa-pod.yaml 文件，内容如下：</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">apps/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Deployment</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">dev</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">strategy</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># 策略</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">type</span><span style="color:#24292E;">: </span><span style="color:#032F62;">RollingUpdate</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 滚动更新策略</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">replicas</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">matchLabels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx-pod</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">template</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx-pod</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx:1.17.1</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">resources</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># 资源配额</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">limits</span><span style="color:#24292E;">:  </span><span style="color:#6A737D;"># 限制资源（上限）</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">cpu</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;1&quot;</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># CPU 限制，单位是 core 数</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">requests</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># 请求资源（下限）</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">cpu</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;100m&quot;</span><span style="color:#24292E;">  </span><span style="color:#6A737D;"># CPU 限制，单位是 core 数</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># 创建 deployment</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#005CC5;">1.8</span><span style="color:#24292E;">+]# kubectl run nginx --image=nginx:1.17.1 --requests=cpu=100m -n dev</span></span>
<span class="line"><span style="color:#6A737D;"># 创建 service</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#005CC5;">1.8</span><span style="color:#24292E;">+]# kubectl expose deployment nginx --type=NodePort --port=80 -n dev</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># 查看</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#005CC5;">1.8</span><span style="color:#24292E;">+]# kubectl get deployment,pod,svc -n dev</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                    </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">UP-TO-DATE</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AVAILABLE</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">deployment.apps/nginx</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">            </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">           </span><span style="color:#005CC5;">47</span><span style="color:#032F62;">s</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                         </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">    </span><span style="color:#032F62;">RESTARTS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">pod/nginx-7df9756ccc-bh8dr</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">47</span><span style="color:#032F62;">s</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">            </span><span style="color:#032F62;">TYPE</span><span style="color:#24292E;">       </span><span style="color:#032F62;">CLUSTER-IP</span><span style="color:#24292E;">      </span><span style="color:#032F62;">EXTERNAL-IP</span><span style="color:#24292E;">   </span><span style="color:#032F62;">PORT</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">S</span><span style="color:#24292E;">)        </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">service/nginx</span><span style="color:#24292E;">   </span><span style="color:#032F62;">NodePort</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">10.101</span><span style="color:#032F62;">.18.29</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">80</span><span style="color:#032F62;">:31830/TCP</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">35</span><span style="color:#032F62;">s</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_6-4-3-部署-hpa" tabindex="-1"><a class="header-anchor" href="#_6-4-3-部署-hpa" aria-hidden="true">#</a> 6.4.3 部署 HPA</h4><p>创建 pc-hpa.yaml 文件，内容如下：</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">autoscaling/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">HorizontalPodAutoscaler</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">pc-hpa</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">dev</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">minReplicas</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">  </span><span style="color:#6A737D;">#最小 pod 数量</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">maxReplicas</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">10</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">#最大 pod 数量</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">targetCPUUtilizationPercentage</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">3</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># CPU 使用率指标</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">scaleTargetRef</span><span style="color:#24292E;">:   </span><span style="color:#6A737D;"># 指定要控制的 nginx 信息</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">:  </span><span style="color:#032F62;">/v1</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Deployment</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># 创建 hpa</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#005CC5;">1.8</span><span style="color:#24292E;">+]# kubectl create -f pc-hpa.yaml</span></span>
<span class="line"><span style="color:#6F42C1;">horizontalpodautoscaler.autoscaling/pc-hpa</span><span style="color:#24292E;"> </span><span style="color:#032F62;">created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看 hpa</span></span>
<span class="line"><span style="color:#24292E;">    [root@k8s-master01 </span><span style="color:#005CC5;">1.8</span><span style="color:#24292E;">+]# kubectl get hpa -n dev</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">     </span><span style="color:#032F62;">REFERENCE</span><span style="color:#24292E;">          </span><span style="color:#032F62;">TARGETS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">MINPODS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">MAXPODS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">REPLICAS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">pc-hpa</span><span style="color:#24292E;">   </span><span style="color:#032F62;">Deployment/nginx</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">%/3%</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">10</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">62</span><span style="color:#032F62;">s</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_6-4-4-测试" tabindex="-1"><a class="header-anchor" href="#_6-4-4-测试" aria-hidden="true">#</a> 6.4.4 测试</h4><p>使用压测工具对 service 地址<code>192.168.5.4:31830</code>进行压测，然后通过控制台查看 hpa 和 pod 的变化</p><p>hpa 变化</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get hpa -n dev -w</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">   </span><span style="color:#032F62;">REFERENCE</span><span style="color:#24292E;">      </span><span style="color:#032F62;">TARGETS</span><span style="color:#24292E;">  </span><span style="color:#032F62;">MINPODS</span><span style="color:#24292E;">  </span><span style="color:#032F62;">MAXPODS</span><span style="color:#24292E;">  </span><span style="color:#032F62;">REPLICAS</span><span style="color:#24292E;">  </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">pc-hpa</span><span style="color:#24292E;">  </span><span style="color:#032F62;">Deployment/nginx</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">%/3%</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">10</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">4</span><span style="color:#032F62;">m11s</span></span>
<span class="line"><span style="color:#6F42C1;">pc-hpa</span><span style="color:#24292E;">  </span><span style="color:#032F62;">Deployment/nginx</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">%/3%</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">10</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">5</span><span style="color:#032F62;">m19s</span></span>
<span class="line"><span style="color:#6F42C1;">pc-hpa</span><span style="color:#24292E;">  </span><span style="color:#032F62;">Deployment/nginx</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">22</span><span style="color:#032F62;">%/3%</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">10</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">6</span><span style="color:#032F62;">m50s</span></span>
<span class="line"><span style="color:#6F42C1;">pc-hpa</span><span style="color:#24292E;">  </span><span style="color:#032F62;">Deployment/nginx</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">22</span><span style="color:#032F62;">%/3%</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">10</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">4</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">7</span><span style="color:#032F62;">m5s</span></span>
<span class="line"><span style="color:#6F42C1;">pc-hpa</span><span style="color:#24292E;">  </span><span style="color:#032F62;">Deployment/nginx</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">22</span><span style="color:#032F62;">%/3%</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">10</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">8</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">7</span><span style="color:#032F62;">m21s</span></span>
<span class="line"><span style="color:#6F42C1;">pc-hpa</span><span style="color:#24292E;">  </span><span style="color:#032F62;">Deployment/nginx</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">6</span><span style="color:#032F62;">%/3%</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">10</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">8</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">7</span><span style="color:#032F62;">m51s</span></span>
<span class="line"><span style="color:#6F42C1;">pc-hpa</span><span style="color:#24292E;">  </span><span style="color:#032F62;">Deployment/nginx</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">%/3%</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">10</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">8</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">9</span><span style="color:#032F62;">m6s</span></span>
<span class="line"><span style="color:#6F42C1;">pc-hpa</span><span style="color:#24292E;">  </span><span style="color:#032F62;">Deployment/nginx</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">%/3%</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">10</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">8</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">13</span><span style="color:#032F62;">m</span></span>
<span class="line"><span style="color:#6F42C1;">pc-hpa</span><span style="color:#24292E;">  </span><span style="color:#032F62;">Deployment/nginx</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">%/3%</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">10</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">14</span><span style="color:#032F62;">m</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>deployment 变化</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get deployment -n dev -w</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">    </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">UP-TO-DATE</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AVAILABLE</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">nginx</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">            </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">           </span><span style="color:#005CC5;">11</span><span style="color:#032F62;">m</span></span>
<span class="line"><span style="color:#6F42C1;">nginx</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/4</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">            </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">           </span><span style="color:#005CC5;">13</span><span style="color:#032F62;">m</span></span>
<span class="line"><span style="color:#6F42C1;">nginx</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/4</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">            </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">           </span><span style="color:#005CC5;">13</span><span style="color:#032F62;">m</span></span>
<span class="line"><span style="color:#6F42C1;">nginx</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/4</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">            </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">           </span><span style="color:#005CC5;">13</span><span style="color:#032F62;">m</span></span>
<span class="line"><span style="color:#6F42C1;">nginx</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/4</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">4</span><span style="color:#24292E;">            </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">           </span><span style="color:#005CC5;">13</span><span style="color:#032F62;">m</span></span>
<span class="line"><span style="color:#6F42C1;">nginx</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/8</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">4</span><span style="color:#24292E;">            </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">           </span><span style="color:#005CC5;">14</span><span style="color:#032F62;">m</span></span>
<span class="line"><span style="color:#6F42C1;">nginx</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/8</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">4</span><span style="color:#24292E;">            </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">           </span><span style="color:#005CC5;">14</span><span style="color:#032F62;">m</span></span>
<span class="line"><span style="color:#6F42C1;">nginx</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/8</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">4</span><span style="color:#24292E;">            </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">           </span><span style="color:#005CC5;">14</span><span style="color:#032F62;">m</span></span>
<span class="line"><span style="color:#6F42C1;">nginx</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/8</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">8</span><span style="color:#24292E;">            </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">           </span><span style="color:#005CC5;">14</span><span style="color:#032F62;">m</span></span>
<span class="line"><span style="color:#6F42C1;">nginx</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">2</span><span style="color:#032F62;">/8</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">8</span><span style="color:#24292E;">            </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">           </span><span style="color:#005CC5;">14</span><span style="color:#032F62;">m</span></span>
<span class="line"><span style="color:#6F42C1;">nginx</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">3</span><span style="color:#032F62;">/8</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">8</span><span style="color:#24292E;">            </span><span style="color:#005CC5;">3</span><span style="color:#24292E;">           </span><span style="color:#005CC5;">14</span><span style="color:#032F62;">m</span></span>
<span class="line"><span style="color:#6F42C1;">nginx</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">4</span><span style="color:#032F62;">/8</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">8</span><span style="color:#24292E;">            </span><span style="color:#005CC5;">4</span><span style="color:#24292E;">           </span><span style="color:#005CC5;">14</span><span style="color:#032F62;">m</span></span>
<span class="line"><span style="color:#6F42C1;">nginx</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">5</span><span style="color:#032F62;">/8</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">8</span><span style="color:#24292E;">            </span><span style="color:#005CC5;">5</span><span style="color:#24292E;">           </span><span style="color:#005CC5;">14</span><span style="color:#032F62;">m</span></span>
<span class="line"><span style="color:#6F42C1;">nginx</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">6</span><span style="color:#032F62;">/8</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">8</span><span style="color:#24292E;">            </span><span style="color:#005CC5;">6</span><span style="color:#24292E;">           </span><span style="color:#005CC5;">14</span><span style="color:#032F62;">m</span></span>
<span class="line"><span style="color:#6F42C1;">nginx</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">7</span><span style="color:#032F62;">/8</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">8</span><span style="color:#24292E;">            </span><span style="color:#005CC5;">7</span><span style="color:#24292E;">           </span><span style="color:#005CC5;">14</span><span style="color:#032F62;">m</span></span>
<span class="line"><span style="color:#6F42C1;">nginx</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">8</span><span style="color:#032F62;">/8</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">8</span><span style="color:#24292E;">            </span><span style="color:#005CC5;">8</span><span style="color:#24292E;">           </span><span style="color:#005CC5;">15</span><span style="color:#032F62;">m</span></span>
<span class="line"><span style="color:#6F42C1;">nginx</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">8</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">8</span><span style="color:#24292E;">            </span><span style="color:#005CC5;">8</span><span style="color:#24292E;">           </span><span style="color:#005CC5;">20</span><span style="color:#032F62;">m</span></span>
<span class="line"><span style="color:#6F42C1;">nginx</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">8</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">8</span><span style="color:#24292E;">            </span><span style="color:#005CC5;">8</span><span style="color:#24292E;">           </span><span style="color:#005CC5;">20</span><span style="color:#032F62;">m</span></span>
<span class="line"><span style="color:#6F42C1;">nginx</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">            </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">           </span><span style="color:#005CC5;">20</span><span style="color:#032F62;">m</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>pod 变化</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#24292e;">[root@k8s-master01 ~]# kubectl get pods -n dev -w</span></span>
<span class="line"><span style="color:#24292e;">NAME                     READY   STATUS    RESTARTS   AGE</span></span>
<span class="line"><span style="color:#24292e;">nginx-7df9756ccc-bh8dr   1/1     Running   0          11m</span></span>
<span class="line"><span style="color:#24292e;">nginx-7df9756ccc-cpgrv   0/1     Pending   0          0s</span></span>
<span class="line"><span style="color:#24292e;">nginx-7df9756ccc-8zhwk   0/1     Pending   0          0s</span></span>
<span class="line"><span style="color:#24292e;">nginx-7df9756ccc-rr9bn   0/1     Pending   0          0s</span></span>
<span class="line"><span style="color:#24292e;">nginx-7df9756ccc-cpgrv   0/1     ContainerCreating   0          0s</span></span>
<span class="line"><span style="color:#24292e;">nginx-7df9756ccc-8zhwk   0/1     ContainerCreating   0          0s</span></span>
<span class="line"><span style="color:#24292e;">nginx-7df9756ccc-rr9bn   0/1     ContainerCreating   0          0s</span></span>
<span class="line"><span style="color:#24292e;">nginx-7df9756ccc-m9gsj   0/1     Pending             0          0s</span></span>
<span class="line"><span style="color:#24292e;">nginx-7df9756ccc-g56qb   0/1     Pending             0          0s</span></span>
<span class="line"><span style="color:#24292e;">nginx-7df9756ccc-sl9c6   0/1     Pending             0          0s</span></span>
<span class="line"><span style="color:#24292e;">nginx-7df9756ccc-fgst7   0/1     Pending             0          0s</span></span>
<span class="line"><span style="color:#24292e;">nginx-7df9756ccc-g56qb   0/1     ContainerCreating   0          0s</span></span>
<span class="line"><span style="color:#24292e;">nginx-7df9756ccc-m9gsj   0/1     ContainerCreating   0          0s</span></span>
<span class="line"><span style="color:#24292e;">nginx-7df9756ccc-sl9c6   0/1     ContainerCreating   0          0s</span></span>
<span class="line"><span style="color:#24292e;">nginx-7df9756ccc-fgst7   0/1     ContainerCreating   0          0s</span></span>
<span class="line"><span style="color:#24292e;">nginx-7df9756ccc-8zhwk   1/1     Running             0          19s</span></span>
<span class="line"><span style="color:#24292e;">nginx-7df9756ccc-rr9bn   1/1     Running             0          30s</span></span>
<span class="line"><span style="color:#24292e;">nginx-7df9756ccc-m9gsj   1/1     Running             0          21s</span></span>
<span class="line"><span style="color:#24292e;">nginx-7df9756ccc-cpgrv   1/1     Running             0          47s</span></span>
<span class="line"><span style="color:#24292e;">nginx-7df9756ccc-sl9c6   1/1     Running             0          33s</span></span>
<span class="line"><span style="color:#24292e;">nginx-7df9756ccc-g56qb   1/1     Running             0          48s</span></span>
<span class="line"><span style="color:#24292e;">nginx-7df9756ccc-fgst7   1/1     Running             0          66s</span></span>
<span class="line"><span style="color:#24292e;">nginx-7df9756ccc-fgst7   1/1     Terminating         0          6m50s</span></span>
<span class="line"><span style="color:#24292e;">nginx-7df9756ccc-8zhwk   1/1     Terminating         0          7m5s</span></span>
<span class="line"><span style="color:#24292e;">nginx-7df9756ccc-cpgrv   1/1     Terminating         0          7m5s</span></span>
<span class="line"><span style="color:#24292e;">nginx-7df9756ccc-g56qb   1/1     Terminating         0          6m50s</span></span>
<span class="line"><span style="color:#24292e;">nginx-7df9756ccc-rr9bn   1/1     Terminating         0          7m5s</span></span>
<span class="line"><span style="color:#24292e;">nginx-7df9756ccc-m9gsj   1/1     Terminating         0          6m50s</span></span>
<span class="line"><span style="color:#24292e;">nginx-7df9756ccc-sl9c6   1/1     Terminating         0          6m50s</span></span>
<span class="line"><span style="color:#24292e;"></span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-5-daemonset-ds" tabindex="-1"><a class="header-anchor" href="#_6-5-daemonset-ds" aria-hidden="true">#</a> 6.5 DaemonSet(DS)</h3><p>DaemonSet 类型的控制器可以保证在集群中的每一台（或指定）节点上都运行一个副本。一般适用于日志收集、节点监控等场景。也就是说，如果一个 Pod 提供的功能是节点级别的（每个节点都需要且只需要一个），那么这类 Pod 就适合使用 DaemonSet 类型的控制器创建。</p><figure><img src="`+E+`" alt="相关图片" tabindex="0" loading="lazy"><figcaption>相关图片</figcaption></figure><p>DaemonSet 控制器的特点：</p><ul><li>每当向集群中添加一个节点时，指定的 Pod 副本也将添加到该节点上</li><li>当节点从集群中移除时，Pod 也就被垃圾回收了</li></ul><p>下面先来看下 DaemonSet 的资源清单文件</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">apps/v1</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 版本号</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">DaemonSet</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 类型       </span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># 元数据</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># rs 名称 </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># 所属命名空间 </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">: </span><span style="color:#6A737D;">#标签</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">controller</span><span style="color:#24292E;">: </span><span style="color:#032F62;">daemonset</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># 详情描述</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">revisionHistoryLimit</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">3</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 保留历史版本</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">updateStrategy</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># 更新策略</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">type</span><span style="color:#24292E;">: </span><span style="color:#032F62;">RollingUpdate</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 滚动更新策略</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">rollingUpdate</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># 滚动更新</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">maxUnavailable</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 最大不可用状态的 Pod 的最大值，可以为百分比，也可以为整数</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># 选择器，通过它指定该控制器管理哪些 pod</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">matchLabels</span><span style="color:#24292E;">:      </span><span style="color:#6A737D;"># Labels 匹配规则</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx-pod</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">matchExpressions</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># Expressions 匹配规则</span></span>
<span class="line"><span style="color:#24292E;">      - {</span><span style="color:#22863A;">key</span><span style="color:#24292E;">: </span><span style="color:#032F62;">app</span><span style="color:#24292E;">, </span><span style="color:#22863A;">operator</span><span style="color:#24292E;">: </span><span style="color:#032F62;">In</span><span style="color:#24292E;">, </span><span style="color:#22863A;">values</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">nginx-pod</span><span style="color:#24292E;">]}</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">template</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># 模板，当副本数量不足时，会根据下面的模板创建 pod 副本</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx-pod</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx:1.17.1</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">containerPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>创建 pc-daemonset.yaml，内容如下：</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">apps/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">DaemonSet</span><span style="color:#24292E;">      </span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">pc-daemonset</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">dev</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">: </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">matchLabels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx-pod</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">template</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx-pod</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx:1.17.1</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># 创建 daemonset</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl create -f  pc-daemonset.yaml</span></span>
<span class="line"><span style="color:#6F42C1;">daemonset.apps/pc-daemonset</span><span style="color:#24292E;"> </span><span style="color:#032F62;">created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看 daemonset</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]#  kubectl get ds -n dev -o wide</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">        </span><span style="color:#032F62;">DESIRED</span><span style="color:#24292E;">  </span><span style="color:#032F62;">CURRENT</span><span style="color:#24292E;">  </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">  </span><span style="color:#032F62;">UP-TO-DATE</span><span style="color:#24292E;">  </span><span style="color:#032F62;">AVAILABLE</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span><span style="color:#24292E;">   </span><span style="color:#032F62;">CONTAINERS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">IMAGES</span><span style="color:#24292E;">         </span></span>
<span class="line"><span style="color:#6F42C1;">pc-daemonset</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">           </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">24</span><span style="color:#032F62;">s</span><span style="color:#24292E;">   </span><span style="color:#032F62;">nginx</span><span style="color:#24292E;">        </span><span style="color:#032F62;">nginx:1.17.1</span><span style="color:#24292E;">   </span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看 pod,发现在每个 Node 上都运行一个 pod</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]#  kubectl get pods -n dev -o wide</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                 </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">    </span><span style="color:#032F62;">RESTARTS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span><span style="color:#24292E;">   </span><span style="color:#032F62;">IP</span><span style="color:#24292E;">            </span><span style="color:#032F62;">NODE</span><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#6F42C1;">pc-daemonset-9bck8</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">37</span><span style="color:#032F62;">s</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">10.244</span><span style="color:#032F62;">.1.43</span><span style="color:#24292E;">   </span><span style="color:#032F62;">node1</span><span style="color:#24292E;">     </span></span>
<span class="line"><span style="color:#6F42C1;">pc-daemonset-k224w</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">37</span><span style="color:#032F62;">s</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">10.244</span><span style="color:#032F62;">.2.74</span><span style="color:#24292E;">   </span><span style="color:#032F62;">node2</span><span style="color:#24292E;">      </span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 删除 daemonset</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl delete -f pc-daemonset.yaml</span></span>
<span class="line"><span style="color:#6F42C1;">daemonset.apps</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;pc-daemonset&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">deleted</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-6-job" tabindex="-1"><a class="header-anchor" href="#_6-6-job" aria-hidden="true">#</a> 6.6 Job</h3><p>Job，主要用于负责 <strong>批量处理(一次要处理指定数量任务)</strong> 短暂的 <strong>一次性(每个任务仅运行一次就结束)</strong> 任务。Job 特点如下：</p><ul><li>当 Job 创建的 pod 执行成功结束时，Job 将记录成功结束的 pod 数量</li><li>当成功结束的 pod 达到指定的数量时，Job 将完成执行</li></ul><figure><img src="`+u+`" alt="相关图片" tabindex="0" loading="lazy"><figcaption>相关图片</figcaption></figure><p>Job 的资源清单文件：</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">batch/v1</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 版本号</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Job</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 类型       </span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># 元数据</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># rs 名称 </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># 所属命名空间 </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">: </span><span style="color:#6A737D;">#标签</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">controller</span><span style="color:#24292E;">: </span><span style="color:#032F62;">job</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># 详情描述</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">completions</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 指定 job 需要成功运行 Pods 的次数。默认值: 1</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">parallelism</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 指定 job 在任一时刻应该并发运行 Pods 的数量。默认值: 1</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">activeDeadlineSeconds</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">30</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 指定 job 可运行的时间期限，超过时间还未结束，系统将会尝试进行终止。</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">backoffLimit</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">6</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 指定 job 失败后进行重试的次数。默认是 6</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">manualSelector</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">true</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 是否可以使用 selector 选择器选择 pod，默认是 false</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># 选择器，通过它指定该控制器管理哪些 pod</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">matchLabels</span><span style="color:#24292E;">:      </span><span style="color:#6A737D;"># Labels 匹配规则</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">counter-pod</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">matchExpressions</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># Expressions 匹配规则</span></span>
<span class="line"><span style="color:#24292E;">      - {</span><span style="color:#22863A;">key</span><span style="color:#24292E;">: </span><span style="color:#032F62;">app</span><span style="color:#24292E;">, </span><span style="color:#22863A;">operator</span><span style="color:#24292E;">: </span><span style="color:#032F62;">In</span><span style="color:#24292E;">, </span><span style="color:#22863A;">values</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">counter-pod</span><span style="color:#24292E;">]}</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">template</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># 模板，当副本数量不足时，会根据下面的模板创建 pod 副本</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">counter-pod</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">restartPolicy</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Never</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 重启策略只能设置为 Never 或者 OnFailure</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">counter</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">busybox:1.30</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">command</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;bin/sh&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;-c&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;for i in 9 8 7 6 5 4 3 2 1; do echo $i;sleep 2;done&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>关于重启策略设置的说明：</p><ul><li>如果指定为 OnFailure，则 job 会在 pod 出现故障时重启容器，而不是创建 pod，failed 次数不变</li><li>如果指定为 Never，则 job 会在 pod 出现故障时创建新的 pod，并且故障 pod 不会消失，也不会重启，failed 次数加 1</li><li>如果指定为 Always 的话，就意味着一直重启，意味着 job 任务会重复去执行了，当然不对，所以不能设置为 Always</li></ul><p>创建 pc-job.yaml，内容如下：</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">batch/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Job</span><span style="color:#24292E;">      </span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">pc-job</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">dev</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">manualSelector</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">matchLabels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">counter-pod</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">template</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">counter-pod</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">restartPolicy</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Never</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">counter</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">busybox:1.30</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">command</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;bin/sh&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;-c&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;for i in 9 8 7 6 5 4 3 2 1; do echo $i;sleep 3;done&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># 创建 job</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl create -f pc-job.yaml</span></span>
<span class="line"><span style="color:#6F42C1;">job.batch/pc-job</span><span style="color:#24292E;"> </span><span style="color:#032F62;">created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看 job</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get job -n dev -o wide  -w</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">     </span><span style="color:#032F62;">COMPLETIONS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">DURATION</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span><span style="color:#24292E;">   </span><span style="color:#032F62;">CONTAINERS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">IMAGES</span><span style="color:#24292E;">         </span><span style="color:#032F62;">SELECTOR</span></span>
<span class="line"><span style="color:#6F42C1;">pc-job</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">           </span><span style="color:#005CC5;">21</span><span style="color:#032F62;">s</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">21</span><span style="color:#032F62;">s</span><span style="color:#24292E;">   </span><span style="color:#032F62;">counter</span><span style="color:#24292E;">      </span><span style="color:#032F62;">busybox:1.30</span><span style="color:#24292E;">   </span><span style="color:#032F62;">app=counter-pod</span></span>
<span class="line"><span style="color:#6F42C1;">pc-job</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">           </span><span style="color:#005CC5;">31</span><span style="color:#032F62;">s</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">79</span><span style="color:#032F62;">s</span><span style="color:#24292E;">   </span><span style="color:#032F62;">counter</span><span style="color:#24292E;">      </span><span style="color:#032F62;">busybox:1.30</span><span style="color:#24292E;">   </span><span style="color:#032F62;">app=counter-pod</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 通过观察 pod 状态可以看到，pod 在运行完毕任务后，就会变成 Completed 状态</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get pods -n dev -w</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">           </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">     </span><span style="color:#032F62;">RESTARTS</span><span style="color:#24292E;">      </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">pc-job-rxg96</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">            </span><span style="color:#005CC5;">29</span><span style="color:#032F62;">s</span></span>
<span class="line"><span style="color:#6F42C1;">pc-job-rxg96</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Completed</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">            </span><span style="color:#005CC5;">33</span><span style="color:#032F62;">s</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 接下来，调整下 pod 运行的总数量和并行数量 即：在 spec 下设置下面两个选项</span></span>
<span class="line"><span style="color:#6A737D;">#  completions: 6 # 指定 job 需要成功运行 Pods 的次数为 6</span></span>
<span class="line"><span style="color:#6A737D;">#  parallelism: 3 # 指定 job 并发运行 Pods 的数量为 3</span></span>
<span class="line"><span style="color:#6A737D;">#  然后重新运行 job，观察效果，此时会发现，job 会每次运行 3 个 pod，总共执行了 6 个 pod</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get pods -n dev -w</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">           </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">    </span><span style="color:#032F62;">RESTARTS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">pc-job-684ft</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">5</span><span style="color:#032F62;">s</span></span>
<span class="line"><span style="color:#6F42C1;">pc-job-jhj49</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">5</span><span style="color:#032F62;">s</span></span>
<span class="line"><span style="color:#6F42C1;">pc-job-pfcvh</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">5</span><span style="color:#032F62;">s</span></span>
<span class="line"><span style="color:#6F42C1;">pc-job-684ft</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Completed</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">11</span><span style="color:#032F62;">s</span></span>
<span class="line"><span style="color:#6F42C1;">pc-job-v7rhr</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Pending</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">s</span></span>
<span class="line"><span style="color:#6F42C1;">pc-job-v7rhr</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Pending</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">s</span></span>
<span class="line"><span style="color:#6F42C1;">pc-job-v7rhr</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">ContainerCreating</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">s</span></span>
<span class="line"><span style="color:#6F42C1;">pc-job-jhj49</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Completed</span><span style="color:#24292E;">           </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">11</span><span style="color:#032F62;">s</span></span>
<span class="line"><span style="color:#6F42C1;">pc-job-fhwf7</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Pending</span><span style="color:#24292E;">             </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">s</span></span>
<span class="line"><span style="color:#6F42C1;">pc-job-fhwf7</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Pending</span><span style="color:#24292E;">             </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">s</span></span>
<span class="line"><span style="color:#6F42C1;">pc-job-pfcvh</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Completed</span><span style="color:#24292E;">           </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">11</span><span style="color:#032F62;">s</span></span>
<span class="line"><span style="color:#6F42C1;">pc-job-5vg2j</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Pending</span><span style="color:#24292E;">             </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">s</span></span>
<span class="line"><span style="color:#6F42C1;">pc-job-fhwf7</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">ContainerCreating</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">s</span></span>
<span class="line"><span style="color:#6F42C1;">pc-job-5vg2j</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Pending</span><span style="color:#24292E;">             </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">s</span></span>
<span class="line"><span style="color:#6F42C1;">pc-job-5vg2j</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">ContainerCreating</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">s</span></span>
<span class="line"><span style="color:#6F42C1;">pc-job-fhwf7</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">             </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">2</span><span style="color:#032F62;">s</span></span>
<span class="line"><span style="color:#6F42C1;">pc-job-v7rhr</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">             </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">2</span><span style="color:#032F62;">s</span></span>
<span class="line"><span style="color:#6F42C1;">pc-job-5vg2j</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">             </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">3</span><span style="color:#032F62;">s</span></span>
<span class="line"><span style="color:#6F42C1;">pc-job-fhwf7</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Completed</span><span style="color:#24292E;">           </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">12</span><span style="color:#032F62;">s</span></span>
<span class="line"><span style="color:#6F42C1;">pc-job-v7rhr</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Completed</span><span style="color:#24292E;">           </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">12</span><span style="color:#032F62;">s</span></span>
<span class="line"><span style="color:#6F42C1;">pc-job-5vg2j</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Completed</span><span style="color:#24292E;">           </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">12</span><span style="color:#032F62;">s</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 删除 job</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl delete -f pc-job.yaml</span></span>
<span class="line"><span style="color:#6F42C1;">job.batch</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;pc-job&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">deleted</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-7-cronjob-cj" tabindex="-1"><a class="header-anchor" href="#_6-7-cronjob-cj" aria-hidden="true">#</a> 6.7 CronJob(CJ)</h3><p>CronJob 控制器以 Job 控制器资源为其管控对象，并借助它管理 pod 资源对象，Job 控制器定义的作业任务在其控制器资源创建之后便会立即执行，但 CronJob 可以以类似于 Linux 操作系统的周期性任务作业计划的方式控制其运行 <strong>时间点</strong> 及 <strong>重复运行</strong> 的方式。也就是说， <strong>CronJob 可以在特定的时间点(反复的)去运行 job 任务</strong> 。</p><figure><img src="`+m+`" alt="相关图片" tabindex="0" loading="lazy"><figcaption>相关图片</figcaption></figure><p>CronJob 的资源清单文件：</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">batch/v1beta1</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 版本号</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">CronJob</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 类型       </span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># 元数据</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># rs 名称 </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># 所属命名空间 </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">: </span><span style="color:#6A737D;">#标签</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">controller</span><span style="color:#24292E;">: </span><span style="color:#032F62;">cronjob</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># 详情描述</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">schedule</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># cron 格式的作业调度运行时间点,用于控制任务在什么时间执行</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">concurrencyPolicy</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># 并发执行策略，用于定义前一次作业运行尚未完成时是否以及如何运行后一次的作业</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">failedJobHistoryLimit</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># 为失败的任务执行保留的历史记录数，默认为 1</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">successfulJobHistoryLimit</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># 为成功的任务执行保留的历史记录数，默认为 3</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">startingDeadlineSeconds</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># 启动作业错误的超时时长</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">jobTemplate</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># job 控制器模板，用于为 cronjob 控制器生成 job 对象;下面其实就是 job 的定义</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">completions</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">parallelism</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">activeDeadlineSeconds</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">30</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">backoffLimit</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">6</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">manualSelector</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">matchLabels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">counter-pod</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">matchExpressions</span><span style="color:#24292E;">: </span><span style="color:#032F62;">规则</span></span>
<span class="line"><span style="color:#24292E;">          - {</span><span style="color:#22863A;">key</span><span style="color:#24292E;">: </span><span style="color:#032F62;">app</span><span style="color:#24292E;">, </span><span style="color:#22863A;">operator</span><span style="color:#24292E;">: </span><span style="color:#032F62;">In</span><span style="color:#24292E;">, </span><span style="color:#22863A;">values</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">counter-pod</span><span style="color:#24292E;">]}</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">template</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">counter-pod</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">restartPolicy</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Never</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">counter</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">busybox:1.30</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">command</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;bin/sh&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;-c&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;for i in 9 8 7 6 5 4 3 2 1; do echo $i;sleep 20;done&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>需要重点解释的几个选项：</p><div class="language-markdown line-numbers-mode" data-ext="md"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#24292E;">schedule: cron 表达式，用于指定任务的执行时间</span></span>
<span class="line"><span style="color:#24292E;">    */1    *      *    *     *</span></span>
<span class="line"><span style="color:#24292E;">    &lt;分钟&gt; &lt;小时&gt; &lt;日&gt; &lt;月份&gt; &lt;星期&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    分钟 值从 0 到 59.</span></span>
<span class="line"><span style="color:#24292E;">    小时 值从 0 到 23.</span></span>
<span class="line"><span style="color:#24292E;">    日 值从 1 到 31.</span></span>
<span class="line"><span style="color:#24292E;">    月 值从 1 到 12.</span></span>
<span class="line"><span style="color:#24292E;">    星期 值从 0 到 6, 0 代表星期日</span></span>
<span class="line"><span style="color:#24292E;">    多个时间可以用逗号隔开； 范围可以用连字符给出；*可以作为通配符； /表示每...</span></span>
<span class="line"><span style="color:#24292E;">concurrencyPolicy:</span></span>
<span class="line"><span style="color:#24292E;">    Allow:   允许 Jobs 并发运行(默认)</span></span>
<span class="line"><span style="color:#24292E;">    Forbid:  禁止并发运行，如果上一次运行尚未完成，则跳过下一次运行</span></span>
<span class="line"><span style="color:#24292E;">    Replace: 替换，取消当前正在运行的作业并用新作业替换它</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>创建 pc-cronjob.yaml，内容如下：</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">batch/v1beta1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">CronJob</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">pc-cronjob</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">dev</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">controller</span><span style="color:#24292E;">: </span><span style="color:#032F62;">cronjob</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">schedule</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;*/1 * * * *&quot;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">jobTemplate</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">template</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">restartPolicy</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Never</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">counter</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">busybox:1.30</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">command</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;bin/sh&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;-c&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;for i in 9 8 7 6 5 4 3 2 1; do echo $i;sleep 3;done&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># 创建 cronjob</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl create -f pc-cronjob.yaml</span></span>
<span class="line"><span style="color:#6F42C1;">cronjob.batch/pc-cronjob</span><span style="color:#24292E;"> </span><span style="color:#032F62;">created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看 cronjob</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get cronjobs -n dev</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">         </span><span style="color:#032F62;">SCHEDULE</span><span style="color:#24292E;">      </span><span style="color:#032F62;">SUSPEND</span><span style="color:#24292E;">   </span><span style="color:#032F62;">ACTIVE</span><span style="color:#24292E;">   </span><span style="color:#032F62;">LAST</span><span style="color:#24292E;"> </span><span style="color:#032F62;">SCHEDULE</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">pc-cronjob</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">*</span><span style="color:#032F62;">/1</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">*</span><span style="color:#24292E;">   </span><span style="color:#032F62;">False</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">        </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">6</span><span style="color:#032F62;">s</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看 job</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get jobs -n dev</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                    </span><span style="color:#032F62;">COMPLETIONS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">DURATION</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">pc-cronjob-1592587800</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">           </span><span style="color:#005CC5;">28</span><span style="color:#032F62;">s</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">3</span><span style="color:#032F62;">m26s</span></span>
<span class="line"><span style="color:#6F42C1;">pc-cronjob-1592587860</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">           </span><span style="color:#005CC5;">28</span><span style="color:#032F62;">s</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">2</span><span style="color:#032F62;">m26s</span></span>
<span class="line"><span style="color:#6F42C1;">pc-cronjob-1592587920</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">           </span><span style="color:#005CC5;">28</span><span style="color:#032F62;">s</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">86</span><span style="color:#032F62;">s</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看 pod</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get pods -n dev</span></span>
<span class="line"><span style="color:#6F42C1;">pc-cronjob-1592587800-x4tsm</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Completed</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">2</span><span style="color:#032F62;">m24s</span></span>
<span class="line"><span style="color:#6F42C1;">pc-cronjob-1592587860-r5gv4</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Completed</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">84</span><span style="color:#032F62;">s</span></span>
<span class="line"><span style="color:#6F42C1;">pc-cronjob-1592587920-9dxxq</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">24</span><span style="color:#032F62;">s</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 删除 cronjob</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl  delete -f pc-cronjob.yaml</span></span>
<span class="line"><span style="color:#6F42C1;">cronjob.batch</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;pc-cronjob&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">deleted</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_7-service-详解" tabindex="-1"><a class="header-anchor" href="#_7-service-详解" aria-hidden="true">#</a> 7. Service 详解</h2><h3 id="_7-1-service-介绍" tabindex="-1"><a class="header-anchor" href="#_7-1-service-介绍" aria-hidden="true">#</a> 7.1 Service 介绍</h3><p>在 kubernetes 中，pod 是应用程序的载体，我们可以通过 pod 的 ip 来访问应用程序，但是 pod 的 ip 地址不是固定的，这也就意味着不方便直接采用 pod 的 ip 对服务进行访问。</p><p>为了解决这个问题，kubernetes 提供了 Service 资源，Service 会对提供同一个服务的多个 pod 进行聚合，并且提供一个统一的入口地址。通过访问 Service 的入口地址就能访问到后面的 pod 服务。</p><figure><img src="`+b+'" alt="相关图片" tabindex="0" loading="lazy"><figcaption>相关图片</figcaption></figure><p>Service 在很多情况下只是一个概念，真正起作用的其实是 kube-proxy 服务进程，每个 Node 节点上都运行着一个 kube-proxy 服务进程。当创建 Service 的时候会通过 api-server 向 etcd 写入创建的 service 的信息，而 kube-proxy 会基于监听的机制发现这种 Service 的变动，然后 <strong>它会将最新的 Service 信息转换成对应的访问规则</strong> 。</p><figure><img src="'+C+`" alt="相关图片" tabindex="0" loading="lazy"><figcaption>相关图片</figcaption></figure><div class="language-text line-numbers-mode" data-ext="text"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#24292e;"># 10.97.97.97:80 是 service 提供的访问入口</span></span>
<span class="line"><span style="color:#24292e;"># 当访问这个入口的时候，可以发现后面有三个 pod 的服务在等待调用，</span></span>
<span class="line"><span style="color:#24292e;"># kube-proxy 会基于 rr（轮询）的策略，将请求分发到其中一个 pod 上去</span></span>
<span class="line"><span style="color:#24292e;"># 这个规则会同时在集群内的所有节点上都生成，所以在任何一个节点，访问都可以。</span></span>
<span class="line"><span style="color:#24292e;">[root@node1 ~]# ipvsadm -Ln</span></span>
<span class="line"><span style="color:#24292e;">IP Virtual Server version 1.2.1 (size=4096)</span></span>
<span class="line"><span style="color:#24292e;">Prot LocalAddress:Port Scheduler Flags</span></span>
<span class="line"><span style="color:#24292e;">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span></span>
<span class="line"><span style="color:#24292e;">TCP  10.97.97.97:80 rr</span></span>
<span class="line"><span style="color:#24292e;">  -&gt; 10.244.1.39:80               Masq    1      0          0</span></span>
<span class="line"><span style="color:#24292e;">  -&gt; 10.244.1.40:80               Masq    1      0          0</span></span>
<span class="line"><span style="color:#24292e;">  -&gt; 10.244.2.33:80               Masq    1      0          0</span></span>
<span class="line"><span style="color:#24292e;"></span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>kube-proxy 目前支持三种工作模式:</p><p>kube-proxy 目前支持三种工作模式:</p><h4 id="_7-1-1-userspace-模式" tabindex="-1"><a class="header-anchor" href="#_7-1-1-userspace-模式" aria-hidden="true">#</a> 7.1.1 userspace 模式</h4><p>userspace 模式下，kube-proxy 会为每一个 Service 创建一个监听端口，发向 Cluster IP 的请求被 Iptables 规则重定向到 kube-proxy 监听的端口上，kube-proxy 根据 LB 算法选择一个提供服务的 Pod 并和其建立链接，以将请求转发到 Pod 上。 该模式下，kube-proxy 充当了一个四层负责均衡器的角色。由于 kube-proxy 运行在 userspace 中，在进行转发处理时会增加内核和用户空间之间的数据拷贝，虽然比较稳定，但是效率比较低。</p><figure><img src="`+F+'" alt="相关图片" height="300" tabindex="0" loading="lazy"><figcaption>相关图片</figcaption></figure><h4 id="_7-1-2-iptables-模式" tabindex="-1"><a class="header-anchor" href="#_7-1-2-iptables-模式" aria-hidden="true">#</a> 7.1.2 iptables 模式</h4><p>iptables 模式下，kube-proxy 为 service 后端的每个 Pod 创建对应的 iptables 规则，直接将发向 Cluster IP 的请求重定向到一个 Pod IP。 该模式下 kube-proxy 不承担四层负责均衡器的角色，只负责创建 iptables 规则。该模式的优点是较 userspace 模式效率更高，但不能提供灵活的 LB 策略，当后端 Pod 不可用时也无法进行重试。</p><figure><img src="'+g+'" alt="相关图片" height="300" tabindex="0" loading="lazy"><figcaption>相关图片</figcaption></figure><h4 id="_7-1-3-ipvs-模式" tabindex="-1"><a class="header-anchor" href="#_7-1-3-ipvs-模式" aria-hidden="true">#</a> 7.1.3 ipvs 模式</h4><p>ipvs 模式和 iptables 类似，kube-proxy 监控 Pod 的变化并创建相应的 ipvs 规则。ipvs 相对 iptables 转发效率更高。除此以外，ipvs 支持更多的 LB 算法。</p><figure><img src="'+A+`" alt="相关图片" height="300" tabindex="0" loading="lazy"><figcaption>相关图片</figcaption></figure><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># 此模式必须安装 ipvs 内核模块，否则会降级为 iptables</span></span>
<span class="line"><span style="color:#6A737D;"># 开启 ipvs</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl edit cm kube-proxy -n kube-system</span></span>
<span class="line"><span style="color:#6A737D;"># 修改 mode: &quot;ipvs&quot;</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl delete pod -l k8s-app=kube-proxy -n kube-system</span></span>
<span class="line"><span style="color:#24292E;">[root@node1 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# ipvsadm -Ln</span></span>
<span class="line"><span style="color:#6F42C1;">IP</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Virtual</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Server</span><span style="color:#24292E;"> </span><span style="color:#032F62;">version</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1.2</span><span style="color:#032F62;">.1</span><span style="color:#24292E;"> (size=4096)</span></span>
<span class="line"><span style="color:#6F42C1;">Prot</span><span style="color:#24292E;"> </span><span style="color:#032F62;">LocalAddress:Port</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Scheduler</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Flags</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">-&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">RemoteAddress:Port</span><span style="color:#24292E;">           </span><span style="color:#032F62;">Forward</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Weight</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ActiveConn</span><span style="color:#24292E;"> </span><span style="color:#032F62;">InActConn</span></span>
<span class="line"><span style="color:#6F42C1;">TCP</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">10.97</span><span style="color:#032F62;">.97.97:80</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rr</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">-&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10.244</span><span style="color:#032F62;">.1.39:80</span><span style="color:#24292E;">               </span><span style="color:#032F62;">Masq</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">-&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10.244</span><span style="color:#032F62;">.1.40:80</span><span style="color:#24292E;">               </span><span style="color:#032F62;">Masq</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">-&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10.244</span><span style="color:#032F62;">.2.33:80</span><span style="color:#24292E;">               </span><span style="color:#032F62;">Masq</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">0</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-2-service-类型" tabindex="-1"><a class="header-anchor" href="#_7-2-service-类型" aria-hidden="true">#</a> 7.2 Service 类型</h3><p>Service 的资源清单文件：</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Service</span><span style="color:#24292E;">  </span><span style="color:#6A737D;"># 资源类型</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span><span style="color:#24292E;">  </span><span style="color:#6A737D;"># 资源版本</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># 元数据</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">service</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 资源名称</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">dev</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 命名空间</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># 描述</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># 标签选择器，用于确定当前 service 代理哪些 pod</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">type</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># Service 类型，指定 service 的访问方式</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">clusterIP</span><span style="color:#24292E;">:  </span><span style="color:#6A737D;"># 虚拟服务的 ip 地址</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">sessionAffinity</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># session 亲和性，支持 ClientIP、None 两个选项</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># 端口信息</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">protocol</span><span style="color:#24292E;">: </span><span style="color:#032F62;">TCP</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">3017</span><span style="color:#24292E;">  </span><span style="color:#6A737D;"># service 端口</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">targetPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">5003</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># pod 端口</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">nodePort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">31122</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 主机端口</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>ClusterIP：默认值，它是 Kubernetes 系统自动分配的虚拟 IP，只能在集群内部访问</li><li>NodePort：将 Service 通过指定的 Node 上的端口暴露给外部，通过此方法，就可以在集群外部访问服务</li><li>LoadBalancer：使用外接负载均衡器完成到服务的负载分发，注意此模式需要外部云环境支持</li><li>ExternalName： 把集群外部的服务引入集群内部，直接使用</li></ul><h3 id="_7-3-service-使用" tabindex="-1"><a class="header-anchor" href="#_7-3-service-使用" aria-hidden="true">#</a> 7.3 Service 使用</h3><h4 id="_7-3-1-实验环境准备" tabindex="-1"><a class="header-anchor" href="#_7-3-1-实验环境准备" aria-hidden="true">#</a> 7.3.1 实验环境准备</h4><p>在使用 service 之前，首先利用 Deployment 创建出 3 个 pod，注意要为 pod 设置<code>app=nginx-pod</code>的标签</p><p>创建 deployment.yaml，内容如下：</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">apps/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Deployment</span><span style="color:#24292E;">      </span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">pc-deployment</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">dev</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">: </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">replicas</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">3</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">matchLabels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx-pod</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">template</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx-pod</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx:1.17.1</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">containerPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl create -f deployment.yaml</span></span>
<span class="line"><span style="color:#6F42C1;">deployment.apps/pc-deployment</span><span style="color:#24292E;"> </span><span style="color:#032F62;">created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看 pod 详情</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get pods -n dev -o wide --show-labels</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                             </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">     </span><span style="color:#032F62;">IP</span><span style="color:#24292E;">            </span><span style="color:#032F62;">NODE</span><span style="color:#24292E;">     </span><span style="color:#032F62;">LABELS</span></span>
<span class="line"><span style="color:#6F42C1;">pc-deployment-66cb59b984-8p84h</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">10.244</span><span style="color:#032F62;">.1.39</span><span style="color:#24292E;">   </span><span style="color:#032F62;">node1</span><span style="color:#24292E;">    </span><span style="color:#032F62;">app=nginx-pod</span></span>
<span class="line"><span style="color:#6F42C1;">pc-deployment-66cb59b984-vx8vx</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">10.244</span><span style="color:#032F62;">.2.33</span><span style="color:#24292E;">   </span><span style="color:#032F62;">node2</span><span style="color:#24292E;">    </span><span style="color:#032F62;">app=nginx-pod</span></span>
<span class="line"><span style="color:#6F42C1;">pc-deployment-66cb59b984-wnncx</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">10.244</span><span style="color:#032F62;">.1.40</span><span style="color:#24292E;">   </span><span style="color:#032F62;">node1</span><span style="color:#24292E;">    </span><span style="color:#032F62;">app=nginx-pod</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 为了方便后面的测试，修改下三台 nginx 的 index.html 页面（三台修改的 IP 地址不一致）</span></span>
<span class="line"><span style="color:#6A737D;"># kubectl exec -it pc-deployment-66cb59b984-8p84h -n dev /bin/sh</span></span>
<span class="line"><span style="color:#6A737D;"># echo &quot;10.244.1.39&quot; &gt; /usr/share/nginx/html/index.html</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#修改完毕之后，访问测试</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# curl 10.244.1.39</span></span>
<span class="line"><span style="color:#6F42C1;">10.244.1.39</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# curl 10.244.2.33</span></span>
<span class="line"><span style="color:#6F42C1;">10.244.2.33</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# curl 10.244.1.40</span></span>
<span class="line"><span style="color:#6F42C1;">10.244.1.40</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_7-3-2-clusterip-类型的-service" tabindex="-1"><a class="header-anchor" href="#_7-3-2-clusterip-类型的-service" aria-hidden="true">#</a> 7.3.2 ClusterIP 类型的 Service</h4><p>创建 service-clusterip.yaml 文件</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Service</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">service-clusterip</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">dev</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx-pod</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">clusterIP</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">10.97.97.97</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># service 的 ip 地址，如果不写，默认会生成一个</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">type</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ClusterIP</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span><span style="color:#24292E;">  </span><span style="color:#6A737D;"># Service 端口       </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">targetPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># pod 端口</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># 创建 service</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl create -f service-clusterip.yaml</span></span>
<span class="line"><span style="color:#6F42C1;">service/service-clusterip</span><span style="color:#24292E;"> </span><span style="color:#032F62;">created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看 service</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get svc -n dev -o wide</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                </span><span style="color:#032F62;">TYPE</span><span style="color:#24292E;">        </span><span style="color:#032F62;">CLUSTER-IP</span><span style="color:#24292E;">    </span><span style="color:#032F62;">EXTERNAL-IP</span><span style="color:#24292E;">   </span><span style="color:#032F62;">PORT</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">S</span><span style="color:#24292E;">)   </span><span style="color:#032F62;">AGE</span><span style="color:#24292E;">   </span><span style="color:#032F62;">SELECTOR</span></span>
<span class="line"><span style="color:#6F42C1;">service-clusterip</span><span style="color:#24292E;">   </span><span style="color:#032F62;">ClusterIP</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">10.97</span><span style="color:#032F62;">.97.97</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">80</span><span style="color:#032F62;">/TCP</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">13</span><span style="color:#032F62;">s</span><span style="color:#24292E;">   </span><span style="color:#032F62;">app=nginx-pod</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看 service 的详细信息</span></span>
<span class="line"><span style="color:#6A737D;"># 在这里有一个 Endpoints 列表，里面就是当前 service 可以负载到的服务入口</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl describe svc service-clusterip -n dev</span></span>
<span class="line"><span style="color:#6F42C1;">Name:</span><span style="color:#24292E;">              </span><span style="color:#032F62;">service-clusterip</span></span>
<span class="line"><span style="color:#6F42C1;">Namespace:</span><span style="color:#24292E;">         </span><span style="color:#032F62;">dev</span></span>
<span class="line"><span style="color:#6F42C1;">Labels:</span><span style="color:#24292E;">            </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#6F42C1;">Annotations:</span><span style="color:#24292E;">       </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#6F42C1;">Selector:</span><span style="color:#24292E;">          </span><span style="color:#032F62;">app=nginx-pod</span></span>
<span class="line"><span style="color:#6F42C1;">Type:</span><span style="color:#24292E;">              </span><span style="color:#032F62;">ClusterIP</span></span>
<span class="line"><span style="color:#6F42C1;">IP:</span><span style="color:#24292E;">                </span><span style="color:#005CC5;">10.97</span><span style="color:#032F62;">.97.97</span></span>
<span class="line"><span style="color:#6F42C1;">Port:</span><span style="color:#24292E;">              </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">unse</span><span style="color:#24292E;">t</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">80</span><span style="color:#032F62;">/TCP</span></span>
<span class="line"><span style="color:#6F42C1;">TargetPort:</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">80</span><span style="color:#032F62;">/TCP</span></span>
<span class="line"><span style="color:#6F42C1;">Endpoints:</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">10.244</span><span style="color:#032F62;">.1.39:80,10.244.1.40:80,10.244.2.33:80</span></span>
<span class="line"><span style="color:#6F42C1;">Session</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Affinity:</span><span style="color:#24292E;">  </span><span style="color:#032F62;">None</span></span>
<span class="line"><span style="color:#6F42C1;">Events:</span><span style="color:#24292E;">            </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看 ipvs 的映射规则</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# ipvsadm -Ln</span></span>
<span class="line"><span style="color:#6F42C1;">TCP</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">10.97</span><span style="color:#032F62;">.97.97:80</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rr</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">-&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10.244</span><span style="color:#032F62;">.1.39:80</span><span style="color:#24292E;">               </span><span style="color:#032F62;">Masq</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">-&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10.244</span><span style="color:#032F62;">.1.40:80</span><span style="color:#24292E;">               </span><span style="color:#032F62;">Masq</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">-&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10.244</span><span style="color:#032F62;">.2.33:80</span><span style="color:#24292E;">               </span><span style="color:#032F62;">Masq</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">0</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 访问 10.97.97.97:80 观察效果</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# curl 10.97.97.97:80</span></span>
<span class="line"><span style="color:#6F42C1;">10.244.2.33</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_7-3-3-endpoint" tabindex="-1"><a class="header-anchor" href="#_7-3-3-endpoint" aria-hidden="true">#</a> 7.3.3 Endpoint</h4><p>Endpoint 是 kubernetes 中的一个资源对象，存储在 etcd 中，用来记录一个 service 对应的所有 pod 的访问地址，它是根据 service 配置文件中 selector 描述产生的。</p><p>一个 Service 由一组 Pod 组成，这些 Pod 通过 Endpoints 暴露出来， <strong>Endpoints 是实现实际服务的端点集合</strong> 。换句话说，service 和 pod 之间的联系是通过 endpoints 实现的。</p><figure><img src="`+h+`" alt="相关图片" tabindex="0" loading="lazy"><figcaption>相关图片</figcaption></figure><p><strong>负载分发策略</strong></p><p>对 Service 的访问被分发到了后端的 Pod 上去，目前 kubernetes 提供了两种负载分发策略：</p><ul><li><p>如果不定义，默认使用 kube-proxy 的策略，比如随机、轮询</p></li><li><p>基于客户端地址的会话保持模式，即来自同一个客户端发起的所有请求都会转发到固定的一个 Pod 上</p><p>此模式可以使在 spec 中添加<code>sessionAffinity:ClientIP</code>选项</p></li></ul><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># 查看 ipvs 的映射规则【rr 轮询】</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# ipvsadm -Ln</span></span>
<span class="line"><span style="color:#6F42C1;">TCP</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">10.97</span><span style="color:#032F62;">.97.97:80</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rr</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">-&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10.244</span><span style="color:#032F62;">.1.39:80</span><span style="color:#24292E;">               </span><span style="color:#032F62;">Masq</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">-&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10.244</span><span style="color:#032F62;">.1.40:80</span><span style="color:#24292E;">               </span><span style="color:#032F62;">Masq</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">-&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10.244</span><span style="color:#032F62;">.2.33:80</span><span style="color:#24292E;">               </span><span style="color:#032F62;">Masq</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">0</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 循环访问测试</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# </span><span style="color:#D73A49;">while</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">;</span><span style="color:#D73A49;">do</span><span style="color:#24292E;"> curl 10.97.97.97:80; </span><span style="color:#6F42C1;">sleep</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">5</span><span style="color:#24292E;">; </span><span style="color:#D73A49;">done</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#6F42C1;">10.244.1.40</span></span>
<span class="line"><span style="color:#6F42C1;">10.244.1.39</span></span>
<span class="line"><span style="color:#6F42C1;">10.244.2.33</span></span>
<span class="line"><span style="color:#6F42C1;">10.244.1.40</span></span>
<span class="line"><span style="color:#6F42C1;">10.244.1.39</span></span>
<span class="line"><span style="color:#6F42C1;">10.244.2.33</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 修改分发策略----sessionAffinity:ClientIP</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看 ipvs 规则【persistent 代表持久】</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# ipvsadm -Ln</span></span>
<span class="line"><span style="color:#6F42C1;">TCP</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">10.97</span><span style="color:#032F62;">.97.97:80</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rr</span><span style="color:#24292E;"> </span><span style="color:#032F62;">persistent</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10800</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">-&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10.244</span><span style="color:#032F62;">.1.39:80</span><span style="color:#24292E;">               </span><span style="color:#032F62;">Masq</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">-&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10.244</span><span style="color:#032F62;">.1.40:80</span><span style="color:#24292E;">               </span><span style="color:#032F62;">Masq</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">-&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10.244</span><span style="color:#032F62;">.2.33:80</span><span style="color:#24292E;">               </span><span style="color:#032F62;">Masq</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">0</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 循环访问测试</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# </span><span style="color:#D73A49;">while</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">;</span><span style="color:#D73A49;">do</span><span style="color:#24292E;"> curl 10.97.97.97; </span><span style="color:#6F42C1;">sleep</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">5</span><span style="color:#24292E;">; </span><span style="color:#D73A49;">done</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#6F42C1;">10.244.2.33</span></span>
<span class="line"><span style="color:#6F42C1;">10.244.2.33</span></span>
<span class="line"><span style="color:#6F42C1;">10.244.2.33</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#6A737D;"># 删除 service</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl delete -f service-clusterip.yaml</span></span>
<span class="line"><span style="color:#6F42C1;">service</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;service-clusterip&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">deleted</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_7-3-4-headliness-类型的-service" tabindex="-1"><a class="header-anchor" href="#_7-3-4-headliness-类型的-service" aria-hidden="true">#</a> 7.3.4 HeadLiness 类型的 Service</h4><p>在某些场景中，开发人员可能不想使用 Service 提供的负载均衡功能，而希望自己来控制负载均衡策略，针对这种情况，kubernetes 提供了 HeadLiness Service，这类 Service 不会分配 Cluster IP，如果想要访问 service，只能通过 service 的域名进行查询。</p><p>创建 service-headliness.yaml</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Service</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">service-headliness</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">dev</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx-pod</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">clusterIP</span><span style="color:#24292E;">: </span><span style="color:#032F62;">None</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 将 clusterIP 设置为 None，即可创建 headliness Service</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">type</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ClusterIP</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">targetPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># 创建 service</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl create -f service-headliness.yaml</span></span>
<span class="line"><span style="color:#6F42C1;">service/service-headliness</span><span style="color:#24292E;"> </span><span style="color:#032F62;">created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 获取 service， 发现 CLUSTER-IP 未分配</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get svc service-headliness -n dev -o wide</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                 </span><span style="color:#032F62;">TYPE</span><span style="color:#24292E;">        </span><span style="color:#032F62;">CLUSTER-IP</span><span style="color:#24292E;">   </span><span style="color:#032F62;">EXTERNAL-IP</span><span style="color:#24292E;">   </span><span style="color:#032F62;">PORT</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">S</span><span style="color:#24292E;">)   </span><span style="color:#032F62;">AGE</span><span style="color:#24292E;">   </span><span style="color:#032F62;">SELECTOR</span></span>
<span class="line"><span style="color:#6F42C1;">service-headliness</span><span style="color:#24292E;">   </span><span style="color:#032F62;">ClusterIP</span><span style="color:#24292E;">   </span><span style="color:#032F62;">None</span><span style="color:#24292E;">         </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">80</span><span style="color:#032F62;">/TCP</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">11</span><span style="color:#032F62;">s</span><span style="color:#24292E;">   </span><span style="color:#032F62;">app=nginx-pod</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看 service 详情</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl describe svc service-headliness  -n dev</span></span>
<span class="line"><span style="color:#6F42C1;">Name:</span><span style="color:#24292E;">              </span><span style="color:#032F62;">service-headliness</span></span>
<span class="line"><span style="color:#6F42C1;">Namespace:</span><span style="color:#24292E;">         </span><span style="color:#032F62;">dev</span></span>
<span class="line"><span style="color:#6F42C1;">Labels:</span><span style="color:#24292E;">            </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#6F42C1;">Annotations:</span><span style="color:#24292E;">       </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#6F42C1;">Selector:</span><span style="color:#24292E;">          </span><span style="color:#032F62;">app=nginx-pod</span></span>
<span class="line"><span style="color:#6F42C1;">Type:</span><span style="color:#24292E;">              </span><span style="color:#032F62;">ClusterIP</span></span>
<span class="line"><span style="color:#6F42C1;">IP:</span><span style="color:#24292E;">                </span><span style="color:#032F62;">None</span></span>
<span class="line"><span style="color:#6F42C1;">Port:</span><span style="color:#24292E;">              </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">unse</span><span style="color:#24292E;">t</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">80</span><span style="color:#032F62;">/TCP</span></span>
<span class="line"><span style="color:#6F42C1;">TargetPort:</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">80</span><span style="color:#032F62;">/TCP</span></span>
<span class="line"><span style="color:#6F42C1;">Endpoints:</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">10.244</span><span style="color:#032F62;">.1.39:80,10.244.1.40:80,10.244.2.33:80</span></span>
<span class="line"><span style="color:#6F42C1;">Session</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Affinity:</span><span style="color:#24292E;">  </span><span style="color:#032F62;">None</span></span>
<span class="line"><span style="color:#6F42C1;">Events:</span><span style="color:#24292E;">            </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看域名的解析情况</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl exec -it pc-deployment-66cb59b984-8p84h -n dev /bin/sh</span></span>
<span class="line"><span style="color:#6F42C1;">/</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># cat /etc/resolv.conf</span></span>
<span class="line"><span style="color:#6F42C1;">nameserver</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10.96</span><span style="color:#032F62;">.0.10</span></span>
<span class="line"><span style="color:#6F42C1;">search</span><span style="color:#24292E;"> </span><span style="color:#032F62;">dev.svc.cluster.local</span><span style="color:#24292E;"> </span><span style="color:#032F62;">svc.cluster.local</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cluster.local</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# dig @10.96.0.10 service-headliness.dev.svc.cluster.local</span></span>
<span class="line"><span style="color:#6F42C1;">service-headliness.dev.svc.cluster.local.</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">30</span><span style="color:#24292E;"> </span><span style="color:#032F62;">IN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">A</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10.244</span><span style="color:#032F62;">.1.40</span></span>
<span class="line"><span style="color:#6F42C1;">service-headliness.dev.svc.cluster.local.</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">30</span><span style="color:#24292E;"> </span><span style="color:#032F62;">IN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">A</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10.244</span><span style="color:#032F62;">.1.39</span></span>
<span class="line"><span style="color:#6F42C1;">service-headliness.dev.svc.cluster.local.</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">30</span><span style="color:#24292E;"> </span><span style="color:#032F62;">IN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">A</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10.244</span><span style="color:#032F62;">.2.33</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_7-3-5-nodeport-类型的-service" tabindex="-1"><a class="header-anchor" href="#_7-3-5-nodeport-类型的-service" aria-hidden="true">#</a> 7.3.5 NodePort 类型的 Service</h4><p>在之前的样例中，创建的 Service 的 ip 地址只有集群内部才可以访问，如果希望将 Service 暴露给集群外部使用，那么就要使用到另外一种类型的 Service，称为 NodePort 类型。NodePort 的工作原理其实就是 <strong>将 service 的端口映射到 Node 的一个端口上</strong> ，然后就可以通过<code>NodeIp:NodePort</code>来访问 service 了。</p><figure><img src="`+k+`" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>创建 service-nodeport.yaml</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Service</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">service-nodeport</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">dev</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx-pod</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">type</span><span style="color:#24292E;">: </span><span style="color:#032F62;">NodePort</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># service 类型</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nodePort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">30002</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 指定绑定的 node 的端口(默认的取值范围是：30000-32767), 如果不指定，会默认分配</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">targetPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># 创建 service</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl create -f service-nodeport.yaml</span></span>
<span class="line"><span style="color:#6F42C1;">service/service-nodeport</span><span style="color:#24292E;"> </span><span style="color:#032F62;">created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看 service</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get svc -n dev -o wide</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">               </span><span style="color:#032F62;">TYPE</span><span style="color:#24292E;">       </span><span style="color:#032F62;">CLUSTER-IP</span><span style="color:#24292E;">      </span><span style="color:#032F62;">EXTERNAL-IP</span><span style="color:#24292E;">   </span><span style="color:#032F62;">PORT</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">S</span><span style="color:#24292E;">)       </span><span style="color:#032F62;">SELECTOR</span></span>
<span class="line"><span style="color:#6F42C1;">service-nodeport</span><span style="color:#24292E;">   </span><span style="color:#032F62;">NodePort</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">10.105</span><span style="color:#032F62;">.64.191</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">80</span><span style="color:#032F62;">:30002/TCP</span><span style="color:#24292E;">  </span><span style="color:#032F62;">app=nginx-pod</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 接下来可以通过电脑主机的浏览器去访问集群中任意一个 nodeip 的 30002 端口，即可访问到 pod</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_7-3-6-loadbalancer-类型的-service" tabindex="-1"><a class="header-anchor" href="#_7-3-6-loadbalancer-类型的-service" aria-hidden="true">#</a> 7.3.6 LoadBalancer 类型的 Service</h4><p>LoadBalancer 和 NodePort 很相似，目的都是向外部暴露一个端口，区别在于 LoadBalancer 会在集群的外部再来做一个负载均衡设备，而这个设备需要外部环境支持的，外部服务发送到这个设备上的请求，会被设备负载之后转发到集群中。</p><figure><img src="`+f+'" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><h4 id="_7-3-7-externalname-类型的-service" tabindex="-1"><a class="header-anchor" href="#_7-3-7-externalname-类型的-service" aria-hidden="true">#</a> 7.3.7 ExternalName 类型的 Service</h4><p>ExternalName 类型的 Service 用于引入集群外部的服务，它通过<code>externalName</code>属性指定外部一个服务的地址，然后在集群内部访问此 service 就可以访问到外部的服务了。</p><figure><img src="'+D+`" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6F42C1;">apiVersion:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#6F42C1;">kind:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Service</span></span>
<span class="line"><span style="color:#6F42C1;">metadata:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">name:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">service-externalname</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">namespace:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">dev</span></span>
<span class="line"><span style="color:#6F42C1;">spec:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">type</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ExternalName</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># service 类型</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">externalName:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">www.baidu.com</span><span style="color:#24292E;">  </span><span style="color:#6A737D;">#改成 ip 地址也可以</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># 创建 service</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl  create -f service-externalname.yaml</span></span>
<span class="line"><span style="color:#6F42C1;">service/service-externalname</span><span style="color:#24292E;"> </span><span style="color:#032F62;">created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 域名解析</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# dig @10.96.0.10 service-externalname.dev.svc.cluster.local</span></span>
<span class="line"><span style="color:#6F42C1;">service-externalname.dev.svc.cluster.local.</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">30</span><span style="color:#24292E;"> </span><span style="color:#032F62;">IN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">CNAME</span><span style="color:#24292E;"> </span><span style="color:#032F62;">www.baidu.com.</span></span>
<span class="line"><span style="color:#6F42C1;">www.baidu.com.</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">30</span><span style="color:#24292E;">      </span><span style="color:#032F62;">IN</span><span style="color:#24292E;">      </span><span style="color:#032F62;">CNAME</span><span style="color:#24292E;">   </span><span style="color:#032F62;">www.a.shifen.com.</span></span>
<span class="line"><span style="color:#6F42C1;">www.a.shifen.com.</span><span style="color:#24292E;">       </span><span style="color:#005CC5;">30</span><span style="color:#24292E;">      </span><span style="color:#032F62;">IN</span><span style="color:#24292E;">      </span><span style="color:#032F62;">A</span><span style="color:#24292E;">       </span><span style="color:#005CC5;">39.156</span><span style="color:#032F62;">.66.18</span></span>
<span class="line"><span style="color:#6F42C1;">www.a.shifen.com.</span><span style="color:#24292E;">       </span><span style="color:#005CC5;">30</span><span style="color:#24292E;">      </span><span style="color:#032F62;">IN</span><span style="color:#24292E;">      </span><span style="color:#032F62;">A</span><span style="color:#24292E;">       </span><span style="color:#005CC5;">39.156</span><span style="color:#032F62;">.66.14</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-4-ingress-介绍" tabindex="-1"><a class="header-anchor" href="#_7-4-ingress-介绍" aria-hidden="true">#</a> 7.4 Ingress 介绍</h3><p>在前面课程中已经提到，Service 对集群之外暴露服务的主要方式有两种：NotePort 和 LoadBalancer，但是这两种方式，都有一定的缺点：</p><ul><li>NodePort 方式的缺点是会占用很多集群机器的端口，那么当集群服务变多的时候，这个缺点就愈发明显</li><li>LB 方式的缺点是每个 service 需要一个 LB，浪费、麻烦，并且需要 kubernetes 之外设备的支持</li></ul><p>基于这种现状，kubernetes 提供了 Ingress 资源对象，Ingress 只需要一个 NodePort 或者一个 LB 就可以满足暴露多个 Service 的需求。工作机制大致如下图表示：</p><figure><img src="`+x+'" alt="相关图片" tabindex="0" loading="lazy"><figcaption>相关图片</figcaption></figure><p>实际上，Ingress 相当于一个 7 层的负载均衡器，是 kubernetes 对反向代理的一个抽象，它的工作原理类似于 Nginx，可以理解成在 <strong>Ingress 里建立诸多映射规则，Ingress Controller 通过监听这些配置规则并转化成 Nginx 的反向代理配置 , 然后对外部提供服务</strong> 。在这里有两个核心概念：</p><ul><li>ingress：kubernetes 中的一个对象，作用是定义请求如何转发到 service 的规则</li><li>ingress controller：具体实现反向代理及负载均衡的程序，对 ingress 定义的规则进行解析，根据配置的规则来实现请求转发，实现方式有很多，比如 Nginx, Contour, Haproxy 等等</li></ul><p><strong>Ingress（以 Nginx 为例）的工作原理如下：</strong> 原本需要自动配置 nginx，现在通过 ingress 自动更新 nginx。</p><ol><li>用户编写 Ingress 规则，说明哪个域名对应 kubernetes 集群中的哪个 Service</li><li>Ingress 控制器动态感知 Ingress 服务规则的变化，然后生成一段对应的 Nginx 反向代理配置</li><li>Ingress 控制器会将生成的 Nginx 配置写入到一个运行着的 Nginx 服务中，并动态更新</li><li>到此为止，其实真正在工作的就是一个 Nginx 了，内部配置了用户定义的请求转发规则</li></ol><figure><img src="'+P+`" alt="相关图片" tabindex="0" loading="lazy"><figcaption>相关图片</figcaption></figure><h3 id="_7-5-ingress-使用" tabindex="-1"><a class="header-anchor" href="#_7-5-ingress-使用" aria-hidden="true">#</a> 7.5 Ingress 使用</h3><h4 id="_7-5-1-环境准备-搭建-ingress-环境" tabindex="-1"><a class="header-anchor" href="#_7-5-1-环境准备-搭建-ingress-环境" aria-hidden="true">#</a> 7.5.1 环境准备 搭建 ingress 环境</h4><div class="language-makefile line-numbers-mode" data-ext="makefile"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># 创建文件夹</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 ~]</span><span style="color:#6A737D;"># mkdir ingress-controller</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 ~]</span><span style="color:#6A737D;"># cd ingress-controller/</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 获取 ingress-nginx，本次案例使用的是 0.30 版本</span></span>
<span class="line"><span style="color:#6F42C1;">[root@k8s-master01</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ingress-controller]#</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">wget</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">https</span><span style="color:#24292E;">://raw.githubusercontent.com/kubernetes/ingress-nginx/nginx-0.30.0/deploy/static/mandatory.yaml</span></span>
<span class="line"><span style="color:#6F42C1;">[root@k8s-master01</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ingress-controller]#</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">wget</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">https</span><span style="color:#24292E;">://raw.githubusercontent.com/kubernetes/ingress-nginx/nginx-0.30.0/deploy/static/provider/baremetal/service-nodeport.yaml</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 修改 mandatory.yaml 文件中的仓库</span></span>
<span class="line"><span style="color:#6A737D;"># 修改 quay.io/kubernetes-ingress-controller/nginx-ingress-controller:0.30.0</span></span>
<span class="line"><span style="color:#6A737D;"># 为 quay-mirror.qiniu.com/kubernetes-ingress-controller/nginx-ingress-controller:0.30.0</span></span>
<span class="line"><span style="color:#6A737D;"># 创建 ingress-nginx</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 ingress-controller]</span><span style="color:#6A737D;"># kubectl apply -f ./</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看 ingress-nginx</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 ingress-controller]</span><span style="color:#6A737D;"># kubectl get pod -n ingress-nginx</span></span>
<span class="line"><span style="color:#24292E;">NAME                                           READY   STATUS    RESTARTS   AGE</span></span>
<span class="line"><span style="color:#24292E;">pod/nginx-ingress-controller-fbf967dd5-4qpbp   1/1     Running   0          12h</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看 service</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 ingress-controller]</span><span style="color:#6A737D;"># kubectl get svc -n ingress-nginx</span></span>
<span class="line"><span style="color:#24292E;">NAME            TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)                      AGE</span></span>
<span class="line"><span style="color:#6F42C1;">ingress-nginx</span><span style="color:#24292E;">   </span><span style="color:#6F42C1;">NodePort</span><span style="color:#24292E;">   </span><span style="color:#6F42C1;">10.98.75.163</span><span style="color:#24292E;">   </span><span style="color:#6F42C1;">&lt;none&gt;</span><span style="color:#24292E;">        </span><span style="color:#6F42C1;">80</span><span style="color:#24292E;">:32240/TCP,443:31335/TCP   11h</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_7-5-2-准备-service-和-pod" tabindex="-1"><a class="header-anchor" href="#_7-5-2-准备-service-和-pod" aria-hidden="true">#</a> 7.5.2 准备 service 和 pod</h4><p>为了后面的实验比较方便，创建如下图所示的模型</p><figure><img src="`+R+`" alt="相关图片" tabindex="0" loading="lazy"><figcaption>相关图片</figcaption></figure><p>创建 tomcat-nginx.yaml</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">apps/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Deployment</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx-deployment</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">dev</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">replicas</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">3</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">matchLabels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx-pod</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">template</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx-pod</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx:1.17.1</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">containerPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">apps/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Deployment</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">tomcat-deployment</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">dev</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">replicas</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">3</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">matchLabels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">tomcat-pod</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">template</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">tomcat-pod</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">tomcat</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">tomcat:8.5-jre10-slim</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">containerPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">8080</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Service</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx-service</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">dev</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx-pod</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">clusterIP</span><span style="color:#24292E;">: </span><span style="color:#032F62;">None</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">type</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ClusterIP</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">targetPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Service</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">tomcat-service</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">dev</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">tomcat-pod</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">clusterIP</span><span style="color:#24292E;">: </span><span style="color:#032F62;">None</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">type</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ClusterIP</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">8080</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">targetPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">8080</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># 创建</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl create -f tomcat-nginx.yaml</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get svc -n dev</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">             </span><span style="color:#032F62;">TYPE</span><span style="color:#24292E;">        </span><span style="color:#032F62;">CLUSTER-IP</span><span style="color:#24292E;">   </span><span style="color:#032F62;">EXTERNAL-IP</span><span style="color:#24292E;">   </span><span style="color:#032F62;">PORT</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">S</span><span style="color:#24292E;">)    </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">nginx-service</span><span style="color:#24292E;">    </span><span style="color:#032F62;">ClusterIP</span><span style="color:#24292E;">   </span><span style="color:#032F62;">None</span><span style="color:#24292E;">         </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">80</span><span style="color:#032F62;">/TCP</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">48</span><span style="color:#032F62;">s</span></span>
<span class="line"><span style="color:#6F42C1;">tomcat-service</span><span style="color:#24292E;">   </span><span style="color:#032F62;">ClusterIP</span><span style="color:#24292E;">   </span><span style="color:#032F62;">None</span><span style="color:#24292E;">         </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">8080</span><span style="color:#032F62;">/TCP</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">48</span><span style="color:#032F62;">s</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_7-5-3-http-代理" tabindex="-1"><a class="header-anchor" href="#_7-5-3-http-代理" aria-hidden="true">#</a> 7.5.3 Http 代理</h4><p>创建 ingress-http.yaml</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">extensions/v1beta1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Ingress</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ingress-http</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">dev</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">rules</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">host</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx.itheima.com</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">http</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">paths</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">backend</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">serviceName</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx-service</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">servicePort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">host</span><span style="color:#24292E;">: </span><span style="color:#032F62;">tomcat.itheima.com</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">http</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">paths</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">backend</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">serviceName</span><span style="color:#24292E;">: </span><span style="color:#032F62;">tomcat-service</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">servicePort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">8080</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># 创建</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl create -f ingress-http.yaml</span></span>
<span class="line"><span style="color:#6F42C1;">ingress.extensions/ingress-http</span><span style="color:#24292E;"> </span><span style="color:#032F62;">created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get ing ingress-http -n dev</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">           </span><span style="color:#032F62;">HOSTS</span><span style="color:#24292E;">                                  </span><span style="color:#032F62;">ADDRESS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">PORTS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">ingress-http</span><span style="color:#24292E;">   </span><span style="color:#032F62;">nginx.itheima.com,tomcat.itheima.com</span><span style="color:#24292E;">             </span><span style="color:#005CC5;">80</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">22</span><span style="color:#032F62;">s</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看详情</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl describe ing ingress-http  -n dev</span></span>
<span class="line"><span style="color:#005CC5;">...</span></span>
<span class="line"><span style="color:#6F42C1;">Rules:</span></span>
<span class="line"><span style="color:#6F42C1;">Host</span><span style="color:#24292E;">                </span><span style="color:#032F62;">Path</span><span style="color:#24292E;">  </span><span style="color:#032F62;">Backends</span></span>
<span class="line"><span style="color:#6F42C1;">----</span><span style="color:#24292E;">                </span><span style="color:#005CC5;">----</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">--------</span></span>
<span class="line"><span style="color:#6F42C1;">nginx.itheima.com</span><span style="color:#24292E;">   </span><span style="color:#032F62;">/</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nginx-service:80</span><span style="color:#24292E;"> (10.244.1.96:80,10.244.1.97:80,10.244.2.112:80)</span></span>
<span class="line"><span style="color:#6F42C1;">tomcat.itheima.com</span><span style="color:#24292E;">  </span><span style="color:#032F62;">/</span><span style="color:#24292E;"> </span><span style="color:#032F62;">tomcat-service:8080</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">10.244.1.94:8080,10.244.1.95:8080,10.244.2.111:8080</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#005CC5;">...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 接下来,在本地电脑上配置 host 文件,解析上面的两个域名到 192.168.109.100(master)上</span></span>
<span class="line"><span style="color:#6A737D;"># 然后,就可以分别访问 tomcat.itheima.com:32240  和  nginx.itheima.com:32240 查看效果了</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_7-5-4-https-代理" tabindex="-1"><a class="header-anchor" href="#_7-5-4-https-代理" aria-hidden="true">#</a> 7.5.4 Https 代理</h4><p>创建证书</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># 生成证书</span></span>
<span class="line"><span style="color:#6F42C1;">openssl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">req</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-x509</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-sha256</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-nodes</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-days</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">365</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-newkey</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rsa:2048</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-keyout</span><span style="color:#24292E;"> </span><span style="color:#032F62;">tls.key</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-out</span><span style="color:#24292E;"> </span><span style="color:#032F62;">tls.crt</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-subj</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;/C=CN/ST=BJ/L=BJ/O=nginx/CN=itheima.com&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 创建密钥</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">create</span><span style="color:#24292E;"> </span><span style="color:#032F62;">secret</span><span style="color:#24292E;"> </span><span style="color:#032F62;">tls</span><span style="color:#24292E;"> </span><span style="color:#032F62;">tls-secret</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--key</span><span style="color:#24292E;"> </span><span style="color:#032F62;">tls.key</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--cert</span><span style="color:#24292E;"> </span><span style="color:#032F62;">tls.crt</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>创建 ingress-https.yaml</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">extensions/v1beta1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Ingress</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ingress-https</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">dev</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">tls</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">hosts</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#032F62;">nginx.itheima.com</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#032F62;">tomcat.itheima.com</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">secretName</span><span style="color:#24292E;">: </span><span style="color:#032F62;">tls-secret</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 指定秘钥</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">rules</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">host</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx.itheima.com</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">http</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">paths</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">backend</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">serviceName</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx-service</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">servicePort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">host</span><span style="color:#24292E;">: </span><span style="color:#032F62;">tomcat.itheima.com</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">http</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">paths</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">backend</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">serviceName</span><span style="color:#24292E;">: </span><span style="color:#032F62;">tomcat-service</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">servicePort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">8080</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># 创建</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl create -f ingress-https.yaml</span></span>
<span class="line"><span style="color:#6F42C1;">ingress.extensions/ingress-https</span><span style="color:#24292E;"> </span><span style="color:#032F62;">created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get ing ingress-https -n dev</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">            </span><span style="color:#032F62;">HOSTS</span><span style="color:#24292E;">                                  </span><span style="color:#032F62;">ADDRESS</span><span style="color:#24292E;">         </span><span style="color:#032F62;">PORTS</span><span style="color:#24292E;">     </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">ingress-https</span><span style="color:#24292E;">   </span><span style="color:#032F62;">nginx.itheima.com,tomcat.itheima.com</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">10.104</span><span style="color:#032F62;">.184.38</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">80</span><span style="color:#032F62;">,</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">443</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">2</span><span style="color:#032F62;">m42s</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看详情</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl describe ing ingress-https -n dev</span></span>
<span class="line"><span style="color:#005CC5;">...</span></span>
<span class="line"><span style="color:#6F42C1;">TLS:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">tls-secret</span><span style="color:#24292E;"> </span><span style="color:#032F62;">terminates</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nginx.itheima.com,tomcat.itheima.com</span></span>
<span class="line"><span style="color:#6F42C1;">Rules:</span></span>
<span class="line"><span style="color:#6F42C1;">Host</span><span style="color:#24292E;">              </span><span style="color:#032F62;">Path</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Backends</span></span>
<span class="line"><span style="color:#6F42C1;">----</span><span style="color:#24292E;">              </span><span style="color:#005CC5;">----</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--------</span></span>
<span class="line"><span style="color:#6F42C1;">nginx.itheima.com</span><span style="color:#24292E;">  </span><span style="color:#032F62;">/</span><span style="color:#24292E;">  </span><span style="color:#032F62;">nginx-service:80</span><span style="color:#24292E;"> (10.244.1.97:80,10.244.1.98:80,10.244.2.119:80)</span></span>
<span class="line"><span style="color:#6F42C1;">tomcat.itheima.com</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/</span><span style="color:#24292E;">  </span><span style="color:#032F62;">tomcat-service:8080</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">10.244.1.99:8080,10.244.2.117:8080,10.244.2.120:8080</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#005CC5;">...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 下面可以通过浏览器访问 https://nginx.itheima.com:31335 和 https://tomcat.itheima.com:31335 来查看了</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_8-数据存储" tabindex="-1"><a class="header-anchor" href="#_8-数据存储" aria-hidden="true">#</a> 8. 数据存储</h2><p>在前面已经提到，容器的生命周期可能很短，会被频繁地创建和销毁。那么容器在销毁时，保存在容器中的数据也会被清除。这种结果对用户来说，在某些情况下是不乐意看到的。为了持久化保存容器的数据，kubernetes 引入了 Volume 的概念。</p><p>Volume 是 Pod 中能够被多个容器访问的共享目录，它被定义在 Pod 上，然后被一个 Pod 里的多个容器挂载到具体的文件目录下，kubernetes 通过 Volume 实现同一个 Pod 中不同容器之间的数据共享以及数据的持久化存储。Volume 的生命容器不与 Pod 中单个容器的生命周期相关，当容器终止或者重启时，Volume 中的数据也不会丢失。</p><p>kubernetes 的 Volume 支持多种类型，比较常见的有下面几个：</p><ul><li>简单存储：EmptyDir、HostPath、NFS</li><li>高级存储：PV、PVC</li><li>配置存储：ConfigMap、Secret</li></ul><h3 id="_8-1-基本存储" tabindex="-1"><a class="header-anchor" href="#_8-1-基本存储" aria-hidden="true">#</a> 8.1 基本存储</h3><h4 id="_8-1-1-emptydir" tabindex="-1"><a class="header-anchor" href="#_8-1-1-emptydir" aria-hidden="true">#</a> 8.1.1 EmptyDir</h4><p>EmptyDir 是最基础的 Volume 类型，一个 EmptyDir 就是 Host 上的一个空目录。</p><p>EmptyDir 是在 Pod 被分配到 Node 时创建的，它的初始内容为空，并且无须指定宿主机上对应的目录文件，因为 kubernetes 会自动分配一个目录，当 Pod 销毁时， EmptyDir 中的数据也会被永久删除。 EmptyDir 用途如下：</p><ul><li>临时空间，例如用于某些 应用程序运行时所需的临时目录，且无须永久保留</li><li>一个容器需要从另一个容器中获取数据的目录（多容器共享目录）</li></ul><p>接下来，通过一个容器之间文件共享的案例来使用一下 EmptyDir。</p><p>在一个 Pod 中准备两个容器 nginx 和 busybox，然后声明一个 Volume 分别挂在到两个容器的目录中，然后 nginx 容器负责向 Volume 中写日志，busybox 中通过命令将日志内容读到控制台。</p><figure><img src="`+S+`" alt="相关图片" tabindex="0" loading="lazy"><figcaption>相关图片</figcaption></figure><p>创建一个 volume-emptydir.yaml</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Pod</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">volume-emptydir</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">dev</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx:1.17.1</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">containerPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">volumeMounts</span><span style="color:#24292E;">:  </span><span style="color:#6A737D;"># 将 logs-volume 挂在到 nginx 容器中，对应的目录为 /var/log/nginx</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">logs-volume</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">mountPath</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/var/log/nginx</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">busybox</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">busybox:1.30</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">command</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;/bin/sh&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;-c&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;tail -f /logs/access.log&quot;</span><span style="color:#24292E;">] </span><span style="color:#6A737D;"># 初始命令，动态读取指定文件中内容</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">volumeMounts</span><span style="color:#24292E;">:  </span><span style="color:#6A737D;"># 将 logs-volume 挂在到 busybox 容器中，对应的目录为 /logs</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">logs-volume</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">mountPath</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/logs</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">volumes</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># 声明 volume， name 为 logs-volume，类型为 emptyDir</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">logs-volume</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">emptyDir</span><span style="color:#24292E;">: {}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># 创建 Pod</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl create -f volume-emptydir.yaml</span></span>
<span class="line"><span style="color:#6F42C1;">pod/volume-emptydir</span><span style="color:#24292E;"> </span><span style="color:#032F62;">created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看 pod</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get pods volume-emptydir -n dev -o wide</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                  </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">    </span><span style="color:#032F62;">RESTARTS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span><span style="color:#24292E;">      </span><span style="color:#032F62;">IP</span><span style="color:#24292E;">       </span><span style="color:#032F62;">NODE</span><span style="color:#24292E;">   </span><span style="color:#032F62;">......</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#6F42C1;">volume-emptydir</span><span style="color:#24292E;">       </span><span style="color:#005CC5;">2</span><span style="color:#032F62;">/2</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">97</span><span style="color:#032F62;">s</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">10.42</span><span style="color:#032F62;">.2.9</span><span style="color:#24292E;">   </span><span style="color:#032F62;">node1</span><span style="color:#24292E;">  </span><span style="color:#032F62;">......</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 通过 podIp 访问 nginx</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# curl 10.42.2.9</span></span>
<span class="line"><span style="color:#005CC5;">......</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 通过 kubectl logs 命令查看指定容器的标准输出</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl logs -f volume-emptydir -n dev -c busybox</span></span>
<span class="line"><span style="color:#6F42C1;">10.42.1.0</span><span style="color:#24292E;"> </span><span style="color:#032F62;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">-</span><span style="color:#24292E;"> [27/Jun/2021:15:08:54 </span><span style="color:#032F62;">+0000]</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;GET / HTTP/1.1&quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">200</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">612</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;-&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;curl/7.29.0&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;-&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-1-2-hostpath" tabindex="-1"><a class="header-anchor" href="#_8-1-2-hostpath" aria-hidden="true">#</a> 8.1.2 HostPath</h4><p>上节课提到，EmptyDir 中数据不会被持久化，它会随着 Pod 的结束而销毁，如果想简单的将数据持久化到主机中，可以选择 HostPath。</p><p>HostPath 就是将 Node 主机中一个实际目录挂在到 Pod 中，以供容器使用，这样的设计就可以保证 Pod 销毁了，但是数据依据可以存在于 Node 主机上。</p><figure><img src="`+q+`" alt="相关图片" tabindex="0" loading="lazy"><figcaption>相关图片</figcaption></figure><p>创建一个 volume-hostpath.yaml：</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Pod</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">volume-hostpath</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">dev</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx:1.17.1</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">containerPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">volumeMounts</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">logs-volume</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">mountPath</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/var/log/nginx</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">busybox</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">busybox:1.30</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">command</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;/bin/sh&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;-c&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;tail -f /logs/access.log&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">volumeMounts</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">logs-volume</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">mountPath</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/logs</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">volumes</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">logs-volume</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">hostPath</span><span style="color:#24292E;">: </span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/root/logs</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">type</span><span style="color:#24292E;">: </span><span style="color:#032F62;">DirectoryOrCreate</span><span style="color:#24292E;">  </span><span style="color:#6A737D;"># 目录存在就使用，不存在就先创建后使用</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>文件将保存在节点上，需要查看 volume 具体部署到了那个节点上。</strong></p><p>关于 type 的值的一点说明：</p><ul><li>DirectoryOrCreate 目录存在就使用，不存在就先创建后使用</li><li>Directory 目录必须存在</li><li>FileOrCreate 文件存在就使用，不存在就先创建后使用</li><li>File 文件必须存在</li><li>Socket unix 套接字必须存在</li><li>CharDevice 字符设备必须存在</li><li>BlockDevice 块设备必须存在</li></ul><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># 创建 Pod</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl create -f volume-hostpath.yaml</span></span>
<span class="line"><span style="color:#6F42C1;">pod/volume-hostpath</span><span style="color:#24292E;"> </span><span style="color:#032F62;">created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看 Pod</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get pods volume-hostpath -n dev -o wide</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                  </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">    </span><span style="color:#032F62;">RESTARTS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span><span style="color:#24292E;">   </span><span style="color:#032F62;">IP</span><span style="color:#24292E;">             </span><span style="color:#032F62;">NODE</span><span style="color:#24292E;">   </span><span style="color:#032F62;">......</span></span>
<span class="line"><span style="color:#6F42C1;">pod-volume-hostpath</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">2</span><span style="color:#032F62;">/2</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">s</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">10.42</span><span style="color:#032F62;">.2.10</span><span style="color:#24292E;">     </span><span style="color:#032F62;">node1</span><span style="color:#24292E;">  </span><span style="color:#032F62;">......</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#访问 nginx</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# curl 10.42.2.10</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl logs -f volume-emptydir -n dev -c busybox</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 接下来就可以去 host 的/root/logs 目录下查看存储的文件了</span></span>
<span class="line"><span style="color:#6A737D;">##  注意: 下面的操作需要到 Pod 所在的节点运行（案例中是 node1）</span></span>
<span class="line"><span style="color:#24292E;">[root@node1 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# ls /root/logs/</span></span>
<span class="line"><span style="color:#6F42C1;">access.log</span><span style="color:#24292E;">  </span><span style="color:#032F62;">error.log</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 同样的道理，如果在此目录下创建一个文件，到容器中也是可以看到的</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-1-3-nfs" tabindex="-1"><a class="header-anchor" href="#_8-1-3-nfs" aria-hidden="true">#</a> 8.1.3 NFS</h4><p>HostPath 可以解决数据持久化的问题，但是一旦 Node 节点故障了，Pod 如果转移到了别的节点，又会出现问题了，此时需要准备单独的网络存储系统，比较常用的用 NFS、CIFS。</p><p>NFS 是一个网络文件存储系统，可以搭建一台 NFS 服务器，然后将 Pod 中的存储直接连接到 NFS 系统上，这样的话，无论 Pod 在节点上怎么转移，只要 Node 跟 NFS 的对接没问题，数据就可以成功访问。</p><figure><img src="`+T+`" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>1）首先要准备 nfs 的服务器，这里为了简单，直接是 master 节点做 nfs 服务器</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># 在 nfs 上安装 nfs 服务</span></span>
<span class="line"><span style="color:#24292E;">[root@nfs </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# yum install nfs-utils -y</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 准备一个共享目录</span></span>
<span class="line"><span style="color:#24292E;">[root@nfs </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# mkdir /root/data/nfs -pv</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 将共享目录以读写权限暴露给 192.168.5.0/24 网段中的所有主机</span></span>
<span class="line"><span style="color:#24292E;">[root@nfs </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# vim /etc/exports</span></span>
<span class="line"><span style="color:#24292E;">[root@nfs </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# more /etc/exports</span></span>
<span class="line"><span style="color:#6F42C1;">/root/data/nfs</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">192.168</span><span style="color:#032F62;">.5.0/24</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">rw,no_root_squash</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 启动 nfs 服务</span></span>
<span class="line"><span style="color:#24292E;">[root@nfs </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# systemctl restart nfs</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2）接下来，要在的每个 node 节点上都安装下 nfs，这样的目的是为了 node 节点可以驱动 nfs 设备</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># 在 node 上安装 nfs 服务，注意不需要启动</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# yum install nfs-utils -y</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>3）接下来，就可以编写 pod 的配置文件了，创建 volume-nfs.yaml</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Pod</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">volume-nfs</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">dev</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx:1.17.1</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">containerPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">volumeMounts</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">logs-volume</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">mountPath</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/var/log/nginx</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">busybox</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">busybox:1.30</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">command</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;/bin/sh&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;-c&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;tail -f /logs/access.log&quot;</span><span style="color:#24292E;">] </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">volumeMounts</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">logs-volume</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">mountPath</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/logs</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">volumes</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">logs-volume</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nfs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">server</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">192.168.5.6</span><span style="color:#24292E;">  </span><span style="color:#6A737D;">#nfs 服务器地址</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/root/data/nfs</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">#共享文件路径</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>4）最后，运行下 pod，观察结果</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># 创建 pod</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl create -f volume-nfs.yaml</span></span>
<span class="line"><span style="color:#6F42C1;">pod/volume-nfs</span><span style="color:#24292E;"> </span><span style="color:#032F62;">created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看 pod</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get pods volume-nfs -n dev</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                  </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">    </span><span style="color:#032F62;">RESTARTS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">volume-nfs</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">2</span><span style="color:#032F62;">/2</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">2</span><span style="color:#032F62;">m9s</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看 nfs 服务器上的共享目录，发现已经有文件了</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# ls /root/data/</span></span>
<span class="line"><span style="color:#6F42C1;">access.log</span><span style="color:#24292E;">  </span><span style="color:#032F62;">error.log</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-2-高级存储" tabindex="-1"><a class="header-anchor" href="#_8-2-高级存储" aria-hidden="true">#</a> 8.2 高级存储</h3><p>前面已经学习了使用 NFS 提供存储，此时就要求用户会搭建 NFS 系统，并且会在 yaml 配置 nfs。由于 kubernetes 支持的存储系统有很多，要求客户全都掌握，显然不现实。为了能够 <strong>屏蔽底层存储实现的细节，方便用户使用</strong> ， kubernetes 引入 PV 和 PVC 两种资源对象。</p><ul><li><p>PV（Persistent Volume）是持久化卷的意思，是对底层的共享存储的一种抽象。一般情况下 PV 由 kubernetes 管理员进行创建和配置，它与底层具体的共享存储技术有关，并通过插件完成与共享存储的对接。</p></li><li><p>PVC（Persistent Volume Claim）是持久卷声明的意思，是用户对于存储需求的一种声明。换句话说，PVC 其实就是用户向 kubernetes 系统发出的一种资源需求申请。</p></li></ul><figure><img src="`+_+`" alt="相关图片" height="300" tabindex="0" loading="lazy"><figcaption>相关图片</figcaption></figure><p>使用了 PV 和 PVC 之后，工作可以得到进一步的细分：</p><ul><li>存储：存储工程师维护</li><li>PV： kubernetes 管理员维护</li><li>PVC：kubernetes 用户维护</li></ul><h4 id="_8-2-1-pv" tabindex="-1"><a class="header-anchor" href="#_8-2-1-pv" aria-hidden="true">#</a> 8.2.1 PV</h4><p>PV 是存储资源的抽象，下面是资源清单文件:</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">PersistentVolume</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">pv2</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">nfs</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># 存储类型，与底层真正存储对应</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">capacity</span><span style="color:#24292E;">:  </span><span style="color:#6A737D;"># 存储能力，目前只支持存储空间的设置</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">storage</span><span style="color:#24292E;">: </span><span style="color:#032F62;">2Gi</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">accessModes</span><span style="color:#24292E;">:  </span><span style="color:#6A737D;"># 访问模式</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">storageClassName</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># 存储类别</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">persistentVolumeReclaimPolicy</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># 回收策略</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>PV 的关键配置参数说明：</p><ul><li><strong>存储类型</strong></li></ul><p>底层实际存储的类型，kubernetes 支持多种存储类型，每种存储类型的配置都有所差异</p><ul><li><strong>存储能力（capacity）</strong></li></ul><p>目前只支持存储空间的设置( storage=1Gi )，不过未来可能会加入 IOPS、吞吐量等指标的配置</p><ul><li><strong>访问模式（accessModes）</strong></li></ul><p>用于描述用户应用对存储资源的访问权限，访问权限包括下面几种方式：</p><ul><li>ReadWriteOnce（RWO）：读写权限，但是只能被单个节点挂载</li><li>ReadOnlyMany（ROX）： 只读权限，可以被多个节点挂载</li><li>ReadWriteMany（RWX）：读写权限，可以被多个节点挂载</li></ul><p><code>需要注意的是，底层不同的存储类型可能支持的访问模式不同</code></p><ul><li><strong>回收策略（persistentVolumeReclaimPolicy）</strong></li></ul><p>当 PV 不再被使用了之后，对其的处理方式。目前支持三种策略：</p><ul><li>Retain （保留） 保留数据，需要管理员手工清理数据</li><li>Recycle（回收） 清除 PV 中的数据，效果相当于执行 rm -rf /thevolume/*</li><li>Delete （删除） 与 PV 相连的后端存储完成 volume 的删除操作，当然这常见于云服务商的存储服务</li></ul><p><code>需要注意的是，底层不同的存储类型可能支持的回收策略不同</code></p><ul><li><strong>存储类别</strong></li></ul><p>PV 可以通过 storageClassName 参数指定一个存储类别</p><ul><li><p>具有特定类别的 PV 只能与请求了该类别的 PVC 进行绑定</p></li><li><p>未设定类别的 PV 则只能与不请求任何类别的 PVC 进行绑定</p></li><li><p><strong>状态（status）</strong></p></li></ul><p>一个 PV 的生命周期中，可能会处于 4 中不同的阶段：</p><ul><li>Available（可用）： 表示可用状态，还未被任何 PVC 绑定</li><li>Bound（已绑定）： 表示 PV 已经被 PVC 绑定</li><li>Released（已释放）： 表示 PVC 被删除，但是资源还未被集群重新声明</li><li>Failed（失败）： 表示该 PV 的自动回收失败</li></ul><p><strong>实验</strong></p><p>使用 NFS 作为存储，来演示 PV 的使用，创建 3 个 PV，对应 NFS 中的 3 个暴露的路径。</p><ol><li>准备 NFS 环境</li></ol><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># 创建目录</span></span>
<span class="line"><span style="color:#24292E;">[root@nfs </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# mkdir /root/data/{</span><span style="color:#6F42C1;">pv1,pv2,pv3}</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-pv</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 暴露服务</span></span>
<span class="line"><span style="color:#24292E;">[root@nfs </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# more /etc/exports</span></span>
<span class="line"><span style="color:#6F42C1;">/root/data/pv1</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">192.168</span><span style="color:#032F62;">.5.0/24</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">rw,no_root_squash</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#6F42C1;">/root/data/pv2</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">192.168</span><span style="color:#032F62;">.5.0/24</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">rw,no_root_squash</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#6F42C1;">/root/data/pv3</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">192.168</span><span style="color:#032F62;">.5.0/24</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">rw,no_root_squash</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 重启服务</span></span>
<span class="line"><span style="color:#24292E;">[root@nfs </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]#  systemctl restart nfs</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>创建 pv.yaml</li></ol><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">PersistentVolume</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">:  </span><span style="color:#032F62;">pv1</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">capacity</span><span style="color:#24292E;">: </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">storage</span><span style="color:#24292E;">: </span><span style="color:#032F62;">1Gi</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">accessModes</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">ReadWriteMany</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">persistentVolumeReclaimPolicy</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Retain</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">nfs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/root/data/pv1</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">server</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">192.168.5.6</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">PersistentVolume</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">:  </span><span style="color:#032F62;">pv2</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">capacity</span><span style="color:#24292E;">: </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">storage</span><span style="color:#24292E;">: </span><span style="color:#032F62;">2Gi</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">accessModes</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">ReadWriteMany</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">persistentVolumeReclaimPolicy</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Retain</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">nfs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/root/data/pv2</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">server</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">192.168.5.6</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">PersistentVolume</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">:  </span><span style="color:#032F62;">pv3</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">capacity</span><span style="color:#24292E;">: </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">storage</span><span style="color:#24292E;">: </span><span style="color:#032F62;">3Gi</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">accessModes</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">ReadWriteMany</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">persistentVolumeReclaimPolicy</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Retain</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">nfs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/root/data/pv3</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">server</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">192.168.5.6</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># 创建 pv</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl create -f pv.yaml</span></span>
<span class="line"><span style="color:#6F42C1;">persistentvolume/pv1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">created</span></span>
<span class="line"><span style="color:#6F42C1;">persistentvolume/pv2</span><span style="color:#24292E;"> </span><span style="color:#032F62;">created</span></span>
<span class="line"><span style="color:#6F42C1;">persistentvolume/pv3</span><span style="color:#24292E;"> </span><span style="color:#032F62;">created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看 pv</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get pv -o wide</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">   </span><span style="color:#032F62;">CAPACITY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">ACCESS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">MODES</span><span style="color:#24292E;">  </span><span style="color:#032F62;">RECLAIM</span><span style="color:#24292E;"> </span><span style="color:#032F62;">POLICY</span><span style="color:#24292E;">  </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">      </span><span style="color:#032F62;">AGE</span><span style="color:#24292E;">   </span><span style="color:#032F62;">VOLUMEMODE</span></span>
<span class="line"><span style="color:#6F42C1;">pv1</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">Gi</span><span style="color:#24292E;">        </span><span style="color:#032F62;">RWX</span><span style="color:#24292E;">            </span><span style="color:#032F62;">Retain</span><span style="color:#24292E;">        </span><span style="color:#032F62;">Available</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">10</span><span style="color:#032F62;">s</span><span style="color:#24292E;">   </span><span style="color:#032F62;">Filesystem</span></span>
<span class="line"><span style="color:#6F42C1;">pv2</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">2</span><span style="color:#032F62;">Gi</span><span style="color:#24292E;">        </span><span style="color:#032F62;">RWX</span><span style="color:#24292E;">            </span><span style="color:#032F62;">Retain</span><span style="color:#24292E;">        </span><span style="color:#032F62;">Available</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">10</span><span style="color:#032F62;">s</span><span style="color:#24292E;">   </span><span style="color:#032F62;">Filesystem</span></span>
<span class="line"><span style="color:#6F42C1;">pv3</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">3</span><span style="color:#032F62;">Gi</span><span style="color:#24292E;">        </span><span style="color:#032F62;">RWX</span><span style="color:#24292E;">            </span><span style="color:#032F62;">Retain</span><span style="color:#24292E;">        </span><span style="color:#032F62;">Available</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">9</span><span style="color:#032F62;">s</span><span style="color:#24292E;">    </span><span style="color:#032F62;">Filesystem</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-2-2-pvc" tabindex="-1"><a class="header-anchor" href="#_8-2-2-pvc" aria-hidden="true">#</a> 8.2.2 PVC</h4><p>PVC 是资源的申请，用来声明对存储空间、访问模式、存储类别需求信息。下面是资源清单文件:</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">PersistentVolumeClaim</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">pvc</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">dev</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">accessModes</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># 访问模式</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># 采用标签对 PV 选择</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">storageClassName</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># 存储类别</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">resources</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># 请求空间</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">requests</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">storage</span><span style="color:#24292E;">: </span><span style="color:#032F62;">5Gi</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>PVC 的关键配置参数说明：</p><ul><li><strong>访问模式（accessModes）</strong></li></ul><p>用于描述用户应用对存储资源的访问权限</p><ul><li><strong>选择条件（selector）</strong></li></ul><p>通过 Label Selector 的设置，可使 PVC 对于系统中己存在的 PV 进行筛选</p><ul><li><strong>存储类别（storageClassName）</strong></li></ul><p>PVC 在定义时可以设定需要的后端存储的类别，只有设置了该 class 的 pv 才能被系统选出</p><ul><li><strong>资源请求（Resources ）</strong></li></ul><p>描述对存储资源的请求</p><p><strong>实验</strong></p><ol><li>创建 pvc.yaml，申请 pv</li></ol><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">PersistentVolumeClaim</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">pvc1</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">dev</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">accessModes</span><span style="color:#24292E;">: </span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">ReadWriteMany</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">resources</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">requests</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">storage</span><span style="color:#24292E;">: </span><span style="color:#032F62;">1Gi</span></span>
<span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">PersistentVolumeClaim</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">pvc2</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">dev</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">accessModes</span><span style="color:#24292E;">: </span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">ReadWriteMany</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">resources</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">requests</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">storage</span><span style="color:#24292E;">: </span><span style="color:#032F62;">1Gi</span></span>
<span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">PersistentVolumeClaim</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">pvc3</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">dev</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">accessModes</span><span style="color:#24292E;">: </span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">ReadWriteMany</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">resources</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">requests</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">storage</span><span style="color:#24292E;">: </span><span style="color:#032F62;">1Gi</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># 创建 pvc</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl create -f pvc.yaml</span></span>
<span class="line"><span style="color:#6F42C1;">persistentvolumeclaim/pvc1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">created</span></span>
<span class="line"><span style="color:#6F42C1;">persistentvolumeclaim/pvc2</span><span style="color:#24292E;"> </span><span style="color:#032F62;">created</span></span>
<span class="line"><span style="color:#6F42C1;">persistentvolumeclaim/pvc3</span><span style="color:#24292E;"> </span><span style="color:#032F62;">created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看 pvc</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get pvc  -n dev -o wide</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">   </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">VOLUME</span><span style="color:#24292E;">   </span><span style="color:#032F62;">CAPACITY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">ACCESS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">MODES</span><span style="color:#24292E;">   </span><span style="color:#032F62;">STORAGECLASS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span><span style="color:#24292E;">   </span><span style="color:#032F62;">VOLUMEMODE</span></span>
<span class="line"><span style="color:#6F42C1;">pvc1</span><span style="color:#24292E;">   </span><span style="color:#032F62;">Bound</span><span style="color:#24292E;">    </span><span style="color:#032F62;">pv1</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">Gi</span><span style="color:#24292E;">        </span><span style="color:#032F62;">RWX</span><span style="color:#24292E;">                           </span><span style="color:#005CC5;">15</span><span style="color:#032F62;">s</span><span style="color:#24292E;">   </span><span style="color:#032F62;">Filesystem</span></span>
<span class="line"><span style="color:#6F42C1;">pvc2</span><span style="color:#24292E;">   </span><span style="color:#032F62;">Bound</span><span style="color:#24292E;">    </span><span style="color:#032F62;">pv2</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">2</span><span style="color:#032F62;">Gi</span><span style="color:#24292E;">        </span><span style="color:#032F62;">RWX</span><span style="color:#24292E;">                           </span><span style="color:#005CC5;">15</span><span style="color:#032F62;">s</span><span style="color:#24292E;">   </span><span style="color:#032F62;">Filesystem</span></span>
<span class="line"><span style="color:#6F42C1;">pvc3</span><span style="color:#24292E;">   </span><span style="color:#032F62;">Bound</span><span style="color:#24292E;">    </span><span style="color:#032F62;">pv3</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">3</span><span style="color:#032F62;">Gi</span><span style="color:#24292E;">        </span><span style="color:#032F62;">RWX</span><span style="color:#24292E;">                           </span><span style="color:#005CC5;">15</span><span style="color:#032F62;">s</span><span style="color:#24292E;">   </span><span style="color:#032F62;">Filesystem</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看 pv</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get pv -o wide</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">  </span><span style="color:#032F62;">CAPACITY</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ACCESS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">MODES</span><span style="color:#24292E;">  </span><span style="color:#032F62;">RECLAIM</span><span style="color:#24292E;"> </span><span style="color:#032F62;">POLICY</span><span style="color:#24292E;">  </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">    </span><span style="color:#032F62;">CLAIM</span><span style="color:#24292E;">       </span><span style="color:#032F62;">AGE</span><span style="color:#24292E;">     </span><span style="color:#032F62;">VOLUMEMODE</span></span>
<span class="line"><span style="color:#6F42C1;">pv1</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">Gi</span><span style="color:#24292E;">        </span><span style="color:#032F62;">RWx</span><span style="color:#24292E;">        </span><span style="color:#032F62;">Retain</span><span style="color:#24292E;">          </span><span style="color:#032F62;">Bound</span><span style="color:#24292E;">    </span><span style="color:#032F62;">dev/pvc1</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">3</span><span style="color:#032F62;">h37m</span><span style="color:#24292E;">    </span><span style="color:#032F62;">Filesystem</span></span>
<span class="line"><span style="color:#6F42C1;">pv2</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">2</span><span style="color:#032F62;">Gi</span><span style="color:#24292E;">        </span><span style="color:#032F62;">RWX</span><span style="color:#24292E;">        </span><span style="color:#032F62;">Retain</span><span style="color:#24292E;">          </span><span style="color:#032F62;">Bound</span><span style="color:#24292E;">    </span><span style="color:#032F62;">dev/pvc2</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">3</span><span style="color:#032F62;">h37m</span><span style="color:#24292E;">    </span><span style="color:#032F62;">Filesystem</span></span>
<span class="line"><span style="color:#6F42C1;">pv3</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">3</span><span style="color:#032F62;">Gi</span><span style="color:#24292E;">        </span><span style="color:#032F62;">RWX</span><span style="color:#24292E;">        </span><span style="color:#032F62;">Retain</span><span style="color:#24292E;">          </span><span style="color:#032F62;">Bound</span><span style="color:#24292E;">    </span><span style="color:#032F62;">dev/pvc3</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">3</span><span style="color:#032F62;">h37m</span><span style="color:#24292E;">    </span><span style="color:#032F62;">Filesystem</span><span style="color:#24292E;">   </span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>创建 pods.yaml, 使用 pv</li></ol><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Pod</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">pod1</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">dev</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">busybox</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">busybox:1.30</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">command</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;/bin/sh&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;-c&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;while true;do echo pod1 &gt;&gt; /root/out.txt; sleep 10; done;&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">volumeMounts</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">volume</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">mountPath</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/root/</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">volumes</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">volume</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">persistentVolumeClaim</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">claimName</span><span style="color:#24292E;">: </span><span style="color:#032F62;">pvc1</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">readOnly</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">false</span></span>
<span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Pod</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">pod2</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">dev</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">busybox</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">busybox:1.30</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">command</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;/bin/sh&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;-c&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;while true;do echo pod2 &gt;&gt; /root/out.txt; sleep 10; done;&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">volumeMounts</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">volume</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">mountPath</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/root/</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">volumes</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">volume</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">persistentVolumeClaim</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">claimName</span><span style="color:#24292E;">: </span><span style="color:#032F62;">pvc2</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">readOnly</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">false</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># 创建 pod</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl create -f pods.yaml</span></span>
<span class="line"><span style="color:#6F42C1;">pod/pod1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">created</span></span>
<span class="line"><span style="color:#6F42C1;">pod/pod2</span><span style="color:#24292E;"> </span><span style="color:#032F62;">created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看 pod</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get pods -n dev -o wide</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">   </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">    </span><span style="color:#032F62;">RESTARTS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span><span style="color:#24292E;">   </span><span style="color:#032F62;">IP</span><span style="color:#24292E;">            </span><span style="color:#032F62;">NODE</span><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#6F42C1;">pod1</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">14</span><span style="color:#032F62;">s</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">10.244</span><span style="color:#032F62;">.1.69</span><span style="color:#24292E;">   </span><span style="color:#032F62;">node1</span><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#6F42C1;">pod2</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">14</span><span style="color:#032F62;">s</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">10.244</span><span style="color:#032F62;">.1.70</span><span style="color:#24292E;">   </span><span style="color:#032F62;">node1</span><span style="color:#24292E;">  </span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看 pvc</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get pvc -n dev -o wide</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">   </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">VOLUME</span><span style="color:#24292E;">   </span><span style="color:#032F62;">CAPACITY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">ACCESS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">MODES</span><span style="color:#24292E;">      </span><span style="color:#032F62;">AGE</span><span style="color:#24292E;">   </span><span style="color:#032F62;">VOLUMEMODE</span></span>
<span class="line"><span style="color:#6F42C1;">pvc1</span><span style="color:#24292E;">   </span><span style="color:#032F62;">Bound</span><span style="color:#24292E;">    </span><span style="color:#032F62;">pv1</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">Gi</span><span style="color:#24292E;">        </span><span style="color:#032F62;">RWX</span><span style="color:#24292E;">               </span><span style="color:#005CC5;">94</span><span style="color:#032F62;">m</span><span style="color:#24292E;">   </span><span style="color:#032F62;">Filesystem</span></span>
<span class="line"><span style="color:#6F42C1;">pvc2</span><span style="color:#24292E;">   </span><span style="color:#032F62;">Bound</span><span style="color:#24292E;">    </span><span style="color:#032F62;">pv2</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">2</span><span style="color:#032F62;">Gi</span><span style="color:#24292E;">        </span><span style="color:#032F62;">RWX</span><span style="color:#24292E;">               </span><span style="color:#005CC5;">94</span><span style="color:#032F62;">m</span><span style="color:#24292E;">   </span><span style="color:#032F62;">Filesystem</span></span>
<span class="line"><span style="color:#6F42C1;">pvc3</span><span style="color:#24292E;">   </span><span style="color:#032F62;">Bound</span><span style="color:#24292E;">    </span><span style="color:#032F62;">pv3</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">3</span><span style="color:#032F62;">Gi</span><span style="color:#24292E;">        </span><span style="color:#032F62;">RWX</span><span style="color:#24292E;">               </span><span style="color:#005CC5;">94</span><span style="color:#032F62;">m</span><span style="color:#24292E;">   </span><span style="color:#032F62;">Filesystem</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看 pv</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get pv -n dev -o wide</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">   </span><span style="color:#032F62;">CAPACITY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">ACCESS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">MODES</span><span style="color:#24292E;">   </span><span style="color:#032F62;">RECLAIM</span><span style="color:#24292E;"> </span><span style="color:#032F62;">POLICY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">CLAIM</span><span style="color:#24292E;">       </span><span style="color:#032F62;">AGE</span><span style="color:#24292E;">     </span><span style="color:#032F62;">VOLUMEMODE</span></span>
<span class="line"><span style="color:#6F42C1;">pv1</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">Gi</span><span style="color:#24292E;">        </span><span style="color:#032F62;">RWX</span><span style="color:#24292E;">            </span><span style="color:#032F62;">Retain</span><span style="color:#24292E;">           </span><span style="color:#032F62;">Bound</span><span style="color:#24292E;">    </span><span style="color:#032F62;">dev/pvc1</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">5</span><span style="color:#032F62;">h11m</span><span style="color:#24292E;">   </span><span style="color:#032F62;">Filesystem</span></span>
<span class="line"><span style="color:#6F42C1;">pv2</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">2</span><span style="color:#032F62;">Gi</span><span style="color:#24292E;">        </span><span style="color:#032F62;">RWX</span><span style="color:#24292E;">            </span><span style="color:#032F62;">Retain</span><span style="color:#24292E;">           </span><span style="color:#032F62;">Bound</span><span style="color:#24292E;">    </span><span style="color:#032F62;">dev/pvc2</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">5</span><span style="color:#032F62;">h11m</span><span style="color:#24292E;">   </span><span style="color:#032F62;">Filesystem</span></span>
<span class="line"><span style="color:#6F42C1;">pv3</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">3</span><span style="color:#032F62;">Gi</span><span style="color:#24292E;">        </span><span style="color:#032F62;">RWX</span><span style="color:#24292E;">            </span><span style="color:#032F62;">Retain</span><span style="color:#24292E;">           </span><span style="color:#032F62;">Bound</span><span style="color:#24292E;">    </span><span style="color:#032F62;">dev/pvc3</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">5</span><span style="color:#032F62;">h11m</span><span style="color:#24292E;">   </span><span style="color:#032F62;">Filesystem</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看 nfs 中的文件存储</span></span>
<span class="line"><span style="color:#24292E;">[root@nfs </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# more /root/data/pv1/out.txt</span></span>
<span class="line"><span style="color:#6F42C1;">node1</span></span>
<span class="line"><span style="color:#6F42C1;">node1</span></span>
<span class="line"><span style="color:#24292E;">[root@nfs </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# more /root/data/pv2/out.txt</span></span>
<span class="line"><span style="color:#6F42C1;">node2</span></span>
<span class="line"><span style="color:#6F42C1;">node2</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-2-3-生命周期" tabindex="-1"><a class="header-anchor" href="#_8-2-3-生命周期" aria-hidden="true">#</a> 8.2.3 生命周期</h4><p>PVC 和 PV 是一一对应的，PV 和 PVC 之间的相互作用遵循以下生命周期：</p><ul><li><p><strong>资源供应</strong> ：管理员手动创建底层存储和 PV</p></li><li><p><strong>资源绑定</strong> ：用户创建 PVC，kubernetes 负责根据 PVC 的声明去寻找 PV，并绑定</p></li></ul><p>在用户定义好 PVC 之后，系统将根据 PVC 对存储资源的请求在已存在的 PV 中选择一个满足条件的</p><ul><li>一旦找到，就将该 PV 与用户定义的 PVC 进行绑定，用户的应用就可以使用这个 PVC 了</li><li>如果找不到，PVC 则会无限期处于 Pending 状态，直到等到系统管理员创建了一个符合其要求的 PV</li></ul><p>PV 一旦绑定到某个 PVC 上，就会被这个 PVC 独占，不能再与其他 PVC 进行绑定了</p><ul><li><strong>资源使用</strong> ：用户可在 pod 中像 volume 一样使用 pvc</li></ul><p>Pod 使用 Volume 的定义，将 PVC 挂载到容器内的某个路径进行使用。</p><ul><li><strong>资源释放</strong> ：用户删除 pvc 来释放 pv</li></ul><p>当存储资源使用完毕后，用户可以删除 PVC，与该 PVC 绑定的 PV 将会被标记为“已释放”，但还不能立刻与其他 PVC 进行绑定。通过之前 PVC 写入的数据可能还被留在存储设备上，只有在清除之后该 PV 才能再次使用。</p><ul><li><strong>资源回收</strong> ：kubernetes 根据 pv 设置的回收策略进行资源的回收</li></ul><p>对于 PV，管理员可以设定回收策略，用于设置与之绑定的 PVC 释放资源之后如何处理遗留数据的问题。只有 PV 的存储空间完成回收，才能供新的 PVC 绑定和使用</p><figure><img src="`+N+`" alt="相关图片" tabindex="0" loading="lazy"><figcaption>相关图片</figcaption></figure><h3 id="_8-3-配置存储" tabindex="-1"><a class="header-anchor" href="#_8-3-配置存储" aria-hidden="true">#</a> 8.3 配置存储</h3><h4 id="_8-3-1-configmap" tabindex="-1"><a class="header-anchor" href="#_8-3-1-configmap" aria-hidden="true">#</a> 8.3.1 ConfigMap</h4><p>ConfigMap 是一种比较特殊的存储卷，它的主要作用是用来存储配置信息的。</p><p>创建 configmap.yaml，内容如下：</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ConfigMap</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">configmap</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">dev</span></span>
<span class="line"><span style="color:#22863A;">data</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">info</span><span style="color:#24292E;">: </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#032F62;">    username:admin</span></span>
<span class="line"><span style="color:#032F62;">    password:123456</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接下来，使用此配置文件创建 configmap</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># 创建 configmap</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl create -f configmap.yaml</span></span>
<span class="line"><span style="color:#6F42C1;">configmap/configmap</span><span style="color:#24292E;"> </span><span style="color:#032F62;">created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看 configmap 详情</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl describe cm configmap -n dev</span></span>
<span class="line"><span style="color:#6F42C1;">Name:</span><span style="color:#24292E;">         </span><span style="color:#032F62;">configmap</span></span>
<span class="line"><span style="color:#6F42C1;">Namespace:</span><span style="color:#24292E;">    </span><span style="color:#032F62;">dev</span></span>
<span class="line"><span style="color:#6F42C1;">Labels:</span><span style="color:#24292E;">       </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#6F42C1;">Annotations:</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">Data</span></span>
<span class="line"><span style="color:#24292E;">====</span></span>
<span class="line"><span style="color:#6F42C1;">info:</span></span>
<span class="line"><span style="color:#6F42C1;">----</span></span>
<span class="line"><span style="color:#6F42C1;">username:admin</span></span>
<span class="line"><span style="color:#6F42C1;">password:123456</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">Events:</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接下来创建一个 pod-configmap.yaml，将上面创建的 configmap 挂载进去</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Pod</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">pod-configmap</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">dev</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx:1.17.1</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">volumeMounts</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># 将 configmap 挂载到目录</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">config</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">mountPath</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/configmap/config</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">volumes</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># 引用 configmap</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">config</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">configMap</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">configmap</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># 创建 pod</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl create -f pod-configmap.yaml</span></span>
<span class="line"><span style="color:#6F42C1;">pod/pod-configmap</span><span style="color:#24292E;"> </span><span style="color:#032F62;">created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看 pod</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get pod pod-configmap -n dev</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">            </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">    </span><span style="color:#032F62;">RESTARTS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">pod-configmap</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">6</span><span style="color:#032F62;">s</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#进入容器</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl exec -it pod-configmap -n dev /bin/sh</span></span>
<span class="line"><span style="color:#6A737D;"># cd /configmap/config/</span></span>
<span class="line"><span style="color:#6A737D;"># ls</span></span>
<span class="line"><span style="color:#6F42C1;">info</span></span>
<span class="line"><span style="color:#6A737D;"># more info</span></span>
<span class="line"><span style="color:#6F42C1;">username:admin</span></span>
<span class="line"><span style="color:#6F42C1;">password:123456</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 可以看到映射已经成功，每个 configmap 都映射成了一个目录</span></span>
<span class="line"><span style="color:#6A737D;"># key---&gt;文件     value----&gt;文件中的内容</span></span>
<span class="line"><span style="color:#6A737D;"># 此时如果更新 configmap 的内容, 容器中的值也会动态更新</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-3-2-secret" tabindex="-1"><a class="header-anchor" href="#_8-3-2-secret" aria-hidden="true">#</a> 8.3.2 Secret</h4><blockquote><p>在 kubernetes 中，还存在一种和 ConfigMap 非常类似的对象，称为 Secret 对象。它主要用于存储敏感信息，例如密码、秘钥、证书等等。</p></blockquote><ol><li>首先使用 base64 对数据进行编码</li></ol><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# echo -n </span><span style="color:#032F62;">&#39;admin&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">base64</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">#准备 username</span></span>
<span class="line"><span style="color:#24292E;">YWRtaW4</span><span style="color:#D73A49;">=</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# echo -n </span><span style="color:#032F62;">&#39;123456&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">base64</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">#准备 password</span></span>
<span class="line"><span style="color:#6F42C1;">MTIzNDU2</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>接下来编写 secret.yaml，并创建 Secret</li></ol><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Secret</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">secret</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">dev</span></span>
<span class="line"><span style="color:#22863A;">type</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Opaque</span></span>
<span class="line"><span style="color:#22863A;">data</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">username</span><span style="color:#24292E;">: </span><span style="color:#032F62;">YWRtaW4=</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">password</span><span style="color:#24292E;">: </span><span style="color:#032F62;">MTIzNDU2</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># 创建 secret</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl create -f secret.yaml</span></span>
<span class="line"><span style="color:#6F42C1;">secret/secret</span><span style="color:#24292E;"> </span><span style="color:#032F62;">created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看 secret 详情</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl describe secret secret -n dev</span></span>
<span class="line"><span style="color:#6F42C1;">Name:</span><span style="color:#24292E;">         </span><span style="color:#032F62;">secret</span></span>
<span class="line"><span style="color:#6F42C1;">Namespace:</span><span style="color:#24292E;">    </span><span style="color:#032F62;">dev</span></span>
<span class="line"><span style="color:#6F42C1;">Labels:</span><span style="color:#24292E;">       </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#6F42C1;">Annotations:</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#6F42C1;">Type:</span><span style="color:#24292E;">  </span><span style="color:#032F62;">Opaque</span></span>
<span class="line"><span style="color:#6F42C1;">Data</span></span>
<span class="line"><span style="color:#24292E;">====</span></span>
<span class="line"><span style="color:#6F42C1;">password:</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">6</span><span style="color:#24292E;"> </span><span style="color:#032F62;">bytes</span></span>
<span class="line"><span style="color:#6F42C1;">username:</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">5</span><span style="color:#24292E;"> </span><span style="color:#032F62;">bytes</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li>创建 pod-secret.yaml，将上面创建的 secret 挂载进去：</li></ol><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Pod</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">pod-secret</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">dev</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx:1.17.1</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">volumeMounts</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># 将 secret 挂载到目录</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">config</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">mountPath</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/secret/config</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">volumes</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">config</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">secret</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">secretName</span><span style="color:#24292E;">: </span><span style="color:#032F62;">secret</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># 创建 pod</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl create -f pod-secret.yaml</span></span>
<span class="line"><span style="color:#6F42C1;">pod/pod-secret</span><span style="color:#24292E;"> </span><span style="color:#032F62;">created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看 pod</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get pod pod-secret -n dev</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">            </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">    </span><span style="color:#032F62;">RESTARTS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">pod-secret</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">2</span><span style="color:#032F62;">m28s</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 进入容器，查看 secret 信息，发现已经自动解码了</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl exec -it pod-secret /bin/sh -n dev</span></span>
<span class="line"><span style="color:#6F42C1;">/</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># ls /secret/config/</span></span>
<span class="line"><span style="color:#6F42C1;">password</span><span style="color:#24292E;">  </span><span style="color:#032F62;">username</span></span>
<span class="line"><span style="color:#6F42C1;">/</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># more /secret/config/username</span></span>
<span class="line"><span style="color:#6F42C1;">admin</span></span>
<span class="line"><span style="color:#6F42C1;">/</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># more /secret/config/password</span></span>
<span class="line"><span style="color:#6F42C1;">123456</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>至此，已经实现了利用 secret 实现了信息的编码。</p><h2 id="_9-安全认证" tabindex="-1"><a class="header-anchor" href="#_9-安全认证" aria-hidden="true">#</a> 9. 安全认证</h2><h3 id="_9-1-访问控制概述" tabindex="-1"><a class="header-anchor" href="#_9-1-访问控制概述" aria-hidden="true">#</a> 9.1 访问控制概述</h3><p>Kubernetes 作为一个分布式集群的管理工具，保证集群的安全性是其一个重要的任务。所谓的安全性其实就是保证对 Kubernetes 的各种 <strong>客户端</strong> 进行 <strong>认证和鉴权</strong> 操作。</p><p><strong>客户端</strong></p><p>在 Kubernetes 集群中，客户端通常有两类：</p><ul><li><strong>User Account</strong> ：一般是独立于 kubernetes 之外的其他服务管理的用户账号。</li><li><strong>Service Account</strong> ：kubernetes 管理的账号，用于为 Pod 中的服务进程在访问 Kubernetes 时提供身份标识。</li></ul><figure><img src="`+V+'" alt="相关图片" tabindex="0" loading="lazy"><figcaption>相关图片</figcaption></figure><p><strong>认证、授权与准入控制</strong></p><p>ApiServer 是访问及管理资源对象的唯一入口。任何一个请求访问 ApiServer，都要经过下面三个流程：</p><ul><li><strong>Authentication（认证）：</strong> 身份鉴别，只有正确的账号才能够通过认证</li><li><strong>Authorization（授权）：</strong> 判断用户是否有权限对访问的资源执行特定的动作</li><li><strong>Admission Control（准入控制）：</strong> 用于补充授权机制以实现更加精细的访问控制功能。</li></ul><figure><img src="'+I+'" alt="相关图片" tabindex="0" loading="lazy"><figcaption>相关图片</figcaption></figure><h3 id="_9-2-认证管理" tabindex="-1"><a class="header-anchor" href="#_9-2-认证管理" aria-hidden="true">#</a> 9.2 认证管理</h3><p>Kubernetes 集群安全的最关键点在于如何识别并认证客户端身份，它提供了 3 种客户端身份认证方式：</p><ul><li><strong>HTTP Base 认证：</strong> 通过用户名+密码的方式认证</li></ul><p>这种认证方式是把“用户名:密码”用 BASE64 算法进行编码后的字符串放在 HTTP 请求中的 Header Authorization 域里发送给服务端。服务端收到后进行解码，获取用户名及密码，然后进行用户身份认证的过程。</p><ul><li><strong>HTTP Token 认证：</strong> 通过一个 Token 来识别合法用户</li></ul><p>这种认证方式是用一个很长的难以被模仿的字符串--Token 来表明客户身份的一种方式。每个 Token 对应一个用户名，当客户端发起 API 调用请求时，需要在 HTTP Header 里放入 Token，API Server 接到 Token 后会跟服务器中保存的 token 进行比对，然后进行用户身份认证的过程。</p><ul><li><strong>HTTPS 证书认证：</strong> 基于 CA 根证书签名的双向数字证书认证方式</li></ul><p>这种认证方式是安全性最高的一种方式，但是同时也是操作起来最麻烦的一种方式。</p><figure><img src="'+M+'" alt="相关图片" tabindex="0" loading="lazy"><figcaption>相关图片</figcaption></figure><p><strong>HTTPS 认证大体分为 3 个过程：</strong></p><ol><li><p>证书申请和下发</p><ul><li>HTTPS 通信双方的服务器向 CA 机构申请证书，CA 机构下发根证书、服务端证书及私钥给申请者</li></ul></li><li><p>客户端和服务端的双向认证</p><ul><li>客户端向服务器端发起请求，服务端下发自己的证书给客户端， 客户端接收到证书后，通过私钥解密证书，在证书中获得服务端的公钥， 客户端利用服务器端的公钥认证证书中的信息，如果一致，则认可这个服务器</li><li>客户端发送自己的证书给服务器端，服务端接收到证书后，通过私钥解密证书， 在证书中获得客户端的公钥，并用该公钥认证证书信息，确认客户端是否合法</li></ul></li><li><p>服务器端和客户端进行通信</p><ul><li><p>服务器端和客户端协商好加密方案后，客户端会产生一个随机的秘钥并加密，然后发送到服务器端。</p></li><li><p>服务器端接收这个秘钥后，双方接下来通信的所有内容都通过该随机秘钥加密</p></li></ul></li></ol><blockquote><p>注意: Kubernetes 允许同时配置多种认证方式，只要其中任意一个方式认证通过即可</p></blockquote><h3 id="_9-3-授权管理" tabindex="-1"><a class="header-anchor" href="#_9-3-授权管理" aria-hidden="true">#</a> 9.3 授权管理</h3><p>授权发生在认证成功之后，通过认证就可以知道请求用户是谁， 然后 Kubernetes 会根据事先定义的授权策略来决定用户是否有权限访问，这个过程就称为授权。</p><p>每个发送到 ApiServer 的请求都带上了用户和资源的信息：比如发送请求的用户、请求的路径、请求的动作等，授权就是根据这些信息和授权策略进行比较，如果符合策略，则认为授权通过，否则会返回错误。</p><p>API Server 目前支持以下几种授权策略：</p><ul><li>AlwaysDeny：表示拒绝所有请求，一般用于测试</li><li>AlwaysAllow：允许接收所有请求，相当于集群不需要授权流程（Kubernetes 默认的策略）</li><li>ABAC：基于属性的访问控制，表示使用用户配置的授权规则对用户请求进行匹配和控制</li><li>Webhook：通过调用外部 REST 服务对用户进行授权</li><li>Node：是一种专用模式，用于对 kubelet 发出的请求进行访问控制</li><li>RBAC：基于角色的访问控制（kubeadm 安装方式下的默认选项）</li></ul><p>RBAC(Role-Based Access Control) 基于角色的访问控制，主要是在描述一件事情： <strong>给哪些对象授予了哪些权限</strong></p><p>其中涉及到了下面几个概念：</p><ul><li>对象：User、Groups、ServiceAccount</li><li>角色：代表着一组定义在资源上的可操作动作(权限)的集合</li><li>绑定：将定义好的角色跟用户绑定在一起</li></ul><figure><img src="'+j+`" alt="相关图片" height="300" tabindex="0" loading="lazy"><figcaption>相关图片</figcaption></figure><p>RBAC 引入了 4 个顶级资源对象：</p><ul><li>Role、ClusterRole：角色，用于指定一组权限</li><li>RoleBinding、ClusterRoleBinding：角色绑定，用于将角色（权限）赋予给对象</li></ul><p><strong>Role、ClusterRole</strong></p><p>一个角色就是一组权限的集合，这里的权限都是许可形式的（白名单）。</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># Role 只能对命名空间内的资源进行授权，需要指定 nameapce</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Role</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">rbac.authorization.k8s.io/v1beta1</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">dev</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">authorization-role</span></span>
<span class="line"><span style="color:#22863A;">rules</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">apiGroups</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;">]  </span><span style="color:#6A737D;"># 支持的 API 组列表,&quot;&quot; 空字符串，表示核心 API 群</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">resources</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;pods&quot;</span><span style="color:#24292E;">] </span><span style="color:#6A737D;"># 支持的资源对象列表</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">verbs</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;get&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;watch&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;list&quot;</span><span style="color:#24292E;">] </span><span style="color:#6A737D;"># 允许的对资源对象的操作方法列表</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># ClusterRole 可以对集群范围内资源、跨 namespaces 的范围资源、非资源类型进行授权</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ClusterRole</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">rbac.authorization.k8s.io/v1beta1</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">authorization-clusterrole</span></span>
<span class="line"><span style="color:#22863A;">rules</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">apiGroups</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">resources</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;pods&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">verbs</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;get&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;watch&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;list&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>需要详细说明的是，rules 中的参数：</p><ul><li><p>apiGroups: 支持的 API 组列表</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6F42C1;">&quot;&quot;</span><span style="color:#6F42C1;">,</span><span style="color:#6F42C1;">&quot;apps&quot;</span><span style="color:#6F42C1;">,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;autoscaling&quot;,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;batch&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>resources：支持的资源对象列表</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6F42C1;">&quot;services&quot;</span><span style="color:#6F42C1;">,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;endpoints&quot;,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;pods&quot;,&quot;secrets&quot;,&quot;configmaps&quot;,&quot;crontabs&quot;,&quot;deployments&quot;,&quot;jobs&quot;,</span></span>
<span class="line"><span style="color:#6F42C1;">&quot;nodes&quot;</span><span style="color:#6F42C1;">,</span><span style="color:#6F42C1;">&quot;rolebindings&quot;</span><span style="color:#6F42C1;">,</span><span style="color:#6F42C1;">&quot;clusterroles&quot;</span><span style="color:#6F42C1;">,</span><span style="color:#6F42C1;">&quot;daemonsets&quot;</span><span style="color:#6F42C1;">,</span><span style="color:#6F42C1;">&quot;replicasets&quot;</span><span style="color:#6F42C1;">,</span><span style="color:#6F42C1;">&quot;statefulsets&quot;</span><span style="color:#6F42C1;">,</span></span>
<span class="line"><span style="color:#6F42C1;">&quot;horizontalpodautoscalers&quot;</span><span style="color:#6F42C1;">,</span><span style="color:#6F42C1;">&quot;replicationcontrollers&quot;</span><span style="color:#6F42C1;">,</span><span style="color:#6F42C1;">&quot;cronjobs&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>verbs：对资源对象的操作方法列表</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6F42C1;">&quot;get&quot;</span><span style="color:#6F42C1;">,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;list&quot;,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;watch&quot;,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;create&quot;,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;update&quot;,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;patch&quot;,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;delete&quot;,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;exec&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li></ul><p><strong>RoleBinding、ClusterRoleBinding</strong></p><p>角色绑定用来把一个角色绑定到一个目标对象上，绑定目标可以是 User、Group 或者 ServiceAccount。</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># RoleBinding 可以将同一 namespace 中的 subject 绑定到某个 Role 下，则此 subject 即具有该 Role 定义的权限</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">RoleBinding</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">rbac.authorization.k8s.io/v1beta1</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">authorization-role-binding</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">dev</span></span>
<span class="line"><span style="color:#22863A;">subjects</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">User</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">heima</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">apiGroup</span><span style="color:#24292E;">: </span><span style="color:#032F62;">rbac.authorization.k8s.io</span></span>
<span class="line"><span style="color:#22863A;">roleRef</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Role</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">authorization-role</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">apiGroup</span><span style="color:#24292E;">: </span><span style="color:#032F62;">rbac.authorization.k8s.io</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># ClusterRoleBinding 在整个集群级别和所有 namespaces 将特定的 subject 与 ClusterRole 绑定，授予权限</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ClusterRoleBinding</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">rbac.authorization.k8s.io/v1beta1</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">authorization-clusterrole-binding</span></span>
<span class="line"><span style="color:#22863A;">subjects</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">User</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">heima</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">apiGroup</span><span style="color:#24292E;">: </span><span style="color:#032F62;">rbac.authorization.k8s.io</span></span>
<span class="line"><span style="color:#22863A;">roleRef</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ClusterRole</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">authorization-clusterrole</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">apiGroup</span><span style="color:#24292E;">: </span><span style="color:#032F62;">rbac.authorization.k8s.io</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>RoleBinding 引用 ClusterRole 进行授权</strong></p><p>RoleBinding 可以引用 ClusterRole，对属于同一命名空间内 ClusterRole 定义的资源主体进行授权。</p><p>一种很常用的做法就是，集群管理员为集群范围预定义好一组角色（ClusterRole），然后在多个命名空间中重复使用这些 ClusterRole。这样可以大幅提高授权管理工作效率，也使得各个命名空间下的基础性授权规则与使用体验保持一致。</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># 虽然 authorization-clusterrole 是一个集群角色，但是因为使用了 RoleBinding</span></span>
<span class="line"><span style="color:#6A737D;"># 所以 heima 只能读取 dev 命名空间中的资源</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">RoleBinding</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">rbac.authorization.k8s.io/v1beta1</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">authorization-role-binding-ns</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">dev</span></span>
<span class="line"><span style="color:#22863A;">subjects</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">User</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">heima</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">apiGroup</span><span style="color:#24292E;">: </span><span style="color:#032F62;">rbac.authorization.k8s.io</span></span>
<span class="line"><span style="color:#22863A;">roleRef</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ClusterRole</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">authorization-clusterrole</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">apiGroup</span><span style="color:#24292E;">: </span><span style="color:#032F62;">rbac.authorization.k8s.io</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>实战：创建一个只能管理 dev 空间下 Pods 资源的账号</strong></p><ol><li>创建账号</li></ol><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># 1) 创建证书</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 pki]# cd /etc/kubernetes/pki/</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 pki]# (</span><span style="color:#005CC5;">umask</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">077</span><span style="color:#24292E;">;</span><span style="color:#6F42C1;">openssl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">genrsa</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-out</span><span style="color:#24292E;"> </span><span style="color:#032F62;">devman.key</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2048</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 2) 用 apiserver 的证书去签署</span></span>
<span class="line"><span style="color:#6A737D;"># 2-1) 签名申请，申请的用户是 devman,组是 devgroup</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 pki]# openssl req -new -key devman.key -out devman.csr -subj </span><span style="color:#032F62;">&quot;/CN=devman/O=devgroup&quot;</span><span style="color:#24292E;">     </span></span>
<span class="line"><span style="color:#6A737D;"># 2-2) 签署证书</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 pki]# openssl x509 -req -in devman.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out devman.crt -days 3650</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 3) 设置集群、用户、上下文信息</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 pki]# kubectl config set-cluster kubernetes --embed-certs=true --certificate-authority=/etc/kubernetes/pki/ca.crt --server=https://192.168.109.100:6443</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 pki]# kubectl config set-credentials devman --embed-certs=true --client-certificate=/etc/kubernetes/pki/devman.crt --client-key=/etc/kubernetes/pki/devman.key</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 pki]# kubectl config set-context devman@kubernetes --cluster=kubernetes --user=devman</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 切换账户到 devman</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 pki]# kubectl config use-context devman@kubernetes</span></span>
<span class="line"><span style="color:#6F42C1;">Switched</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#032F62;">context</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;devman@kubernetes&quot;.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看 dev 下 pod，发现没有权限</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 pki]# kubectl get pods -n dev</span></span>
<span class="line"><span style="color:#6F42C1;">Error</span><span style="color:#24292E;"> </span><span style="color:#032F62;">from</span><span style="color:#24292E;"> </span><span style="color:#032F62;">server</span><span style="color:#24292E;"> (Forbidden): pods is forbidden: User </span><span style="color:#032F62;">&quot;devman&quot;</span><span style="color:#24292E;"> cannot list resource </span><span style="color:#032F62;">&quot;pods&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> API group </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> the namespace </span><span style="color:#032F62;">&quot;dev&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 切换到 admin 账户</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 pki]# kubectl config use-context kubernetes-admin@kubernetes</span></span>
<span class="line"><span style="color:#6F42C1;">Switched</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#032F62;">context</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;kubernetes-admin@kubernetes&quot;.</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2） 创建 Role 和 RoleBinding，为 devman 用户授权</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Role</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">rbac.authorization.k8s.io/v1beta1</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">dev</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">dev-role</span></span>
<span class="line"><span style="color:#22863A;">rules</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">apiGroups</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">resources</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;pods&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">verbs</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;get&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;watch&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;list&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">RoleBinding</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">rbac.authorization.k8s.io/v1beta1</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">authorization-role-binding</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">dev</span></span>
<span class="line"><span style="color:#22863A;">subjects</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">User</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">devman</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">apiGroup</span><span style="color:#24292E;">: </span><span style="color:#032F62;">rbac.authorization.k8s.io</span></span>
<span class="line"><span style="color:#22863A;">roleRef</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Role</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">dev-role</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">apiGroup</span><span style="color:#24292E;">: </span><span style="color:#032F62;">rbac.authorization.k8s.io</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#24292E;">[root@k8s-master01 pki]# kubectl create -f dev-role.yaml</span></span>
<span class="line"><span style="color:#6F42C1;">role.rbac.authorization.k8s.io/dev-role</span><span style="color:#24292E;"> </span><span style="color:#032F62;">created</span></span>
<span class="line"><span style="color:#6F42C1;">rolebinding.rbac.authorization.k8s.io/authorization-role-binding</span><span style="color:#24292E;"> </span><span style="color:#032F62;">created</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li>切换账户，再次验证</li></ol><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># 切换账户到 devman</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 pki]# kubectl config use-context devman@kubernetes</span></span>
<span class="line"><span style="color:#6F42C1;">Switched</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#032F62;">context</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;devman@kubernetes&quot;.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 再次查看</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 pki]# kubectl get pods -n dev</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                                 </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">             </span><span style="color:#032F62;">RESTARTS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">nginx-deployment-66cb59b984-8wp2k</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">            </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">4</span><span style="color:#032F62;">d1h</span></span>
<span class="line"><span style="color:#6F42C1;">nginx-deployment-66cb59b984-dc46j</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">            </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">4</span><span style="color:#032F62;">d1h</span></span>
<span class="line"><span style="color:#6F42C1;">nginx-deployment-66cb59b984-thfck</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">            </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">4</span><span style="color:#032F62;">d1h</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 为了不影响后面的学习,切回 admin 账户</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 pki]# kubectl config use-context kubernetes-admin@kubernetes</span></span>
<span class="line"><span style="color:#6F42C1;">Switched</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#032F62;">context</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;kubernetes-admin@kubernetes&quot;.</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_9-4-准入控制" tabindex="-1"><a class="header-anchor" href="#_9-4-准入控制" aria-hidden="true">#</a> 9.4 准入控制</h3><p>通过了前面的认证和授权之后，还需要经过准入控制处理通过之后，apiserver 才会处理这个请求。</p><p>准入控制是一个可配置的控制器列表，可以通过在 Api-Server 上通过命令行设置选择执行哪些准入控制器：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#24292E;">--admission-control</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">NamespaceLifecycle,LimitRanger,ServiceAccount,PersistentVolumeLabel,</span></span>
<span class="line"><span style="color:#24292E;">                      </span><span style="color:#6F42C1;">DefaultStorageClass,ResourceQuota,DefaultTolerationSeconds</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>只有当所有的准入控制器都检查通过之后，apiserver 才执行该请求，否则返回拒绝。</p><p>当前可配置的 Admission Control 准入控制如下：</p><ul><li>AlwaysAdmit：允许所有请求</li><li>AlwaysDeny：禁止所有请求，一般用于测试</li><li>AlwaysPullImages：在启动容器之前总去下载镜像</li><li>DenyExecOnPrivileged：它会拦截所有想在 Privileged Container 上执行命令的请求</li><li>ImagePolicyWebhook：这个插件将允许后端的一个 Webhook 程序来完成 admission controller 的功能。</li><li>Service Account：实现 ServiceAccount 实现了自动化</li><li>SecurityContextDeny：这个插件将使用 SecurityContext 的 Pod 中的定义全部失效</li><li>ResourceQuota：用于资源配额管理目的，观察所有请求，确保在 namespace 上的配额不会超标</li><li>LimitRanger：用于资源限制管理，作用于 namespace 上，确保对 Pod 进行资源限制</li><li>InitialResources：为未设置资源请求与限制的 Pod，根据其镜像的历史资源的使用情况进行设置</li><li>NamespaceLifecycle：如果尝试在一个不存在的 namespace 中创建资源对象，则该创建请求将被拒绝。当删除一个 namespace 时，系统将会删除该 namespace 中所有对象。</li><li>DefaultStorageClass：为了实现共享存储的动态供应，为未指定 StorageClass 或 PV 的 PVC 尝试匹配默认的 StorageClass，尽可能减少用户在申请 PVC 时所需了解的后端存储细节</li><li>DefaultTolerationSeconds：这个插件为那些没有设置 forgiveness tolerations 并具有 notready:NoExecute 和 unreachable:NoExecute 两种 taints 的 Pod 设置默认的“容忍”时间，为 5min</li><li>PodSecurityPolicy：这个插件用于在创建或修改 Pod 时决定是否根据 Pod 的 security context 和可用的 PodSecurityPolicy 对 Pod 的安全策略进行控制</li></ul><h2 id="_10-dashboard" tabindex="-1"><a class="header-anchor" href="#_10-dashboard" aria-hidden="true">#</a> 10. DashBoard</h2><p>之前在 kubernetes 中完成的所有操作都是通过命令行工具 kubectl 完成的。其实，为了提供更丰富的用户体验，kubernetes 还开发了一个基于 web 的用户界面（Dashboard）。用户可以使用 Dashboard 部署容器化的应用，还可以监控应用的状态，执行故障排查以及管理 kubernetes 中各种资源。</p><h3 id="_10-1-部署-dashboard" tabindex="-1"><a class="header-anchor" href="#_10-1-部署-dashboard" aria-hidden="true">#</a> 10.1 部署 Dashboard</h3><ol><li>下载 yaml，并运行 Dashboard</li></ol><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># 下载 yaml</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# wget  https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0/aio/deploy/recommended.yaml</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 修改 kubernetes-dashboard 的 Service 类型</span></span>
<span class="line"><span style="color:#6F42C1;">kind:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Service</span></span>
<span class="line"><span style="color:#6F42C1;">apiVersion:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#6F42C1;">metadata:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">labels:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">k8s-app:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubernetes-dashboard</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">name:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubernetes-dashboard</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">namespace:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubernetes-dashboard</span></span>
<span class="line"><span style="color:#6F42C1;">spec:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">type</span><span style="color:#24292E;">: </span><span style="color:#032F62;">NodePort</span><span style="color:#24292E;">  </span><span style="color:#6A737D;"># 新增</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">ports:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">port:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">443</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6F42C1;">targetPort:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">8443</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6F42C1;">nodePort:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">30009</span><span style="color:#24292E;">  </span><span style="color:#6A737D;"># 新增</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">selector:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">k8s-app:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubernetes-dashboard</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 部署</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl create -f recommended.yaml</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看 namespace 下的 kubernetes-dashboard 下的资源</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get pod,svc -n kubernetes-dashboard</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                                            </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">    </span><span style="color:#032F62;">RESTARTS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">pod/dashboard-metrics-scraper-c79c65bb7-zwfvw</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">111</span><span style="color:#032F62;">s</span></span>
<span class="line"><span style="color:#6F42C1;">pod/kubernetes-dashboard-56484d4c5-z95z5</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">111</span><span style="color:#032F62;">s</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                               </span><span style="color:#032F62;">TYPE</span><span style="color:#24292E;">       </span><span style="color:#032F62;">CLUSTER-IP</span><span style="color:#24292E;">      </span><span style="color:#032F62;">EXTERNAL-IP</span><span style="color:#24292E;">  </span><span style="color:#032F62;">PORT</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">S</span><span style="color:#24292E;">)         </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">service/dashboard-metrics-scraper</span><span style="color:#24292E;">  </span><span style="color:#032F62;">ClusterIP</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">10.96</span><span style="color:#032F62;">.89.218</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">       </span><span style="color:#005CC5;">8000</span><span style="color:#032F62;">/TCP</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">111</span><span style="color:#032F62;">s</span></span>
<span class="line"><span style="color:#6F42C1;">service/kubernetes-dashboard</span><span style="color:#24292E;">       </span><span style="color:#032F62;">NodePort</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">10.104</span><span style="color:#032F62;">.178.171</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">       </span><span style="color:#005CC5;">443</span><span style="color:#032F62;">:30009/TCP</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">111</span><span style="color:#032F62;">s</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2）创建访问账户，获取 token</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># 创建账号</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01-1 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl create serviceaccount dashboard-admin -n kubernetes-dashboard</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 授权</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01-1 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl create clusterrolebinding dashboard-admin-rb --clusterrole=cluster-admin --serviceaccount=kubernetes-dashboard:dashboard-admin</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 获取账号 token</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]#  kubectl get secrets -n kubernetes-dashboard </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">grep</span><span style="color:#24292E;"> </span><span style="color:#032F62;">dashboard-admin</span></span>
<span class="line"><span style="color:#6F42C1;">dashboard-admin-token-xbqhh</span><span style="color:#24292E;">        </span><span style="color:#032F62;">kubernetes.io/service-account-token</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">3</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">2</span><span style="color:#032F62;">m35s</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl describe secrets dashboard-admin-token-xbqhh -n kubernetes-dashboard</span></span>
<span class="line"><span style="color:#6F42C1;">Name:</span><span style="color:#24292E;">         </span><span style="color:#032F62;">dashboard-admin-token-xbqhh</span></span>
<span class="line"><span style="color:#6F42C1;">Namespace:</span><span style="color:#24292E;">    </span><span style="color:#032F62;">kubernetes-dashboard</span></span>
<span class="line"><span style="color:#6F42C1;">Labels:</span><span style="color:#24292E;">       </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#6F42C1;">Annotations:</span><span style="color:#24292E;">  </span><span style="color:#032F62;">kubernetes.io/service-account.name:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">dashboard-admin</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#6F42C1;">kubernetes.io/service-account.uid:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">95</span><span style="color:#032F62;">d84d80-be7a-4d10-a2e0-68f90222d039</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">Type:</span><span style="color:#24292E;">  </span><span style="color:#032F62;">kubernetes.io/service-account-token</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">Data</span></span>
<span class="line"><span style="color:#24292E;">====</span></span>
<span class="line"><span style="color:#6F42C1;">namespace:</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">20</span><span style="color:#24292E;"> </span><span style="color:#032F62;">bytes</span></span>
<span class="line"><span style="color:#6F42C1;">token:</span><span style="color:#24292E;">      </span><span style="color:#032F62;">eyJhbGciOiJSUzI1NiIsImtpZCI6ImJrYkF4bW5XcDhWcmNGUGJtek5NODFuSXl1aWptMmU2M3o4LTY5a2FKS2cifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJkYXNoYm9hcmQtYWRtaW4tdG9rZW4teGJxaGgiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiZGFzaGJvYXJkLWFkbWluIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQudWlkIjoiOTVkODRkODAtYmU3YS00ZDEwLWEyZTAtNjhmOTAyMjJkMDM5Iiwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50Omt1YmVybmV0ZXMtZGFzaGJvYXJkOmRhc2hib2FyZC1hZG1pbiJ9.NAl7e8ZfWWdDoPxkqzJzTB46sK9E8iuJYnUI9vnBaY3Jts7T1g1msjsBnbxzQSYgAG--cV0WYxjndzJY_UWCwaGPrQrt_GunxmOK9AUnzURqm55GR2RXIZtjsWVP2EBatsDgHRmuUbQvTFOvdJB4x3nXcYLN2opAaMqg3rnU2rr-A8zCrIuX_eca12wIp_QiuP3SF-tzpdLpsyRfegTJZl6YnSGyaVkC9id-cxZRb307qdCfXPfCHR_2rt5FVfxARgg_C0e3eFHaaYQO7CitxsnIoIXpOFNAR8aUrmopJyODQIPqBWUehb7FhlU1DCduHnIIXVC_UICZ-MKYewBDLw</span></span>
<span class="line"><span style="color:#6F42C1;">ca.crt:</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">1025</span><span style="color:#24292E;"> </span><span style="color:#032F62;">bytes</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3）通过浏览器访问 Dashboard 的 UI</p><p>在登录页面上输入上面的 token</p><figure><img src="`+L+'" alt="相关图片" height="300" tabindex="0" loading="lazy"><figcaption>相关图片</figcaption></figure><p>出现下面的页面代表成功</p><figure><img src="'+w+'" alt="相关图片" tabindex="0" loading="lazy"><figcaption>相关图片</figcaption></figure><h3 id="_10-2-使用-dashboard" tabindex="-1"><a class="header-anchor" href="#_10-2-使用-dashboard" aria-hidden="true">#</a> 10.2 使用 DashBoard</h3><p>本章节以 Deployment 为例演示 DashBoard 的使用</p><p><strong>查看</strong></p><p>选择指定的命名空间<code>dev</code>，然后点击<code>Deployments</code>，查看 dev 空间下的所有 deployment</p><figure><img src="'+G+'" alt="相关图片" tabindex="0" loading="lazy"><figcaption>相关图片</figcaption></figure><p><strong>扩缩容</strong></p><p>在<code>Deployment</code>上点击<code>规模</code>，然后指定<code>目标副本数量</code>，点击确定</p><figure><img src="'+U+'" alt="相关图片" tabindex="0" loading="lazy"><figcaption>相关图片</figcaption></figure><p><strong>编辑</strong></p><p>在<code>Deployment</code>上点击<code>编辑</code>，然后修改<code>yaml 文件</code>，点击确定</p><figure><img src="'+O+'" alt="相关图片" tabindex="0" loading="lazy"><figcaption>相关图片</figcaption></figure><p><strong>查看 Pod</strong></p><p>点击<code>Pods</code>, 查看 pods 列表</p><figure><img src="'+z+'" alt="相关图片" tabindex="0" loading="lazy"><figcaption>相关图片</figcaption></figure><p><strong>操作 Pod</strong></p><p>选中某个 Pod，可以对其执行日志（logs）、进入执行（exec）、编辑、删除操作</p><figure><img src="'+Y+'" alt="相关图片" tabindex="0" loading="lazy"><figcaption>相关图片</figcaption></figure><blockquote><p>Dashboard 提供了 kubectl 的绝大部分功能，这里不再一一演示</p></blockquote><h3 id="_10-3-其他-ui-kuboard" tabindex="-1"><a class="header-anchor" href="#_10-3-其他-ui-kuboard" aria-hidden="true">#</a> 10.3 其他 UI：kuboard</h3>',446),$={href:"https://kuboard.cn/install/v3/install-built-in.html#%E9%83%A8%E7%BD%B2%E8%AE%A1%E5%88%92",target:"_blank",rel:"noopener noreferrer"},ss=p(`<div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki github-light" style="background-color:#fff;" tabindex="0"><code><span class="line"><span style="color:#6F42C1;">sudo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">docker</span><span style="color:#24292E;"> </span><span style="color:#032F62;">run</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-d</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">--restart=unless-stopped</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">--name=kuboard</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">-p</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">80</span><span style="color:#032F62;">:80/tcp</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">-p</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10081</span><span style="color:#032F62;">:10081/tcp</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">-e</span><span style="color:#24292E;"> </span><span style="color:#032F62;">KUBOARD_ENDPOINT=&quot;http://192.168.88.100:80&quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">-e</span><span style="color:#24292E;"> </span><span style="color:#032F62;">KUBOARD_AGENT_SERVER_TCP_PORT=&quot;10081&quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">-e</span><span style="color:#24292E;"> </span><span style="color:#032F62;">KUBOARD_ADMIN_DERAULT_PASSWORD=&quot;passwd&quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">-v</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/root/kuboard-data:/data</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#032F62;">eipwork/kuboard:v3</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,1);function ns(as,ls){const a=o("ExternalLinkIcon");return c(),r("div",null,[s("p",null,[n("以下笔记来自于笔记 "),s("a",W,[n("Kubernetes(K8S) 入门进阶实战完整教程，黑马程序员 K8S 全套教程"),l(a)])]),s("p",null,[n("除了 黑马的笔记，可以参考 kuboard 的可视化界面 + kubectl 进行 k8s 功能复习。"),s("a",J,[n("kuboard link"),l(a)])]),s("ol",null,[H,s("li",null,[s("p",null,[n("Service：实现服务端口到外部访问端口的代理/映射 "),s("a",X,[n("K8s 网关选型初判：Nginx 还是 Envoy？"),l(a)])]),Z]),K]),Q,s("p",null,[n("官网有相关教程 "),s("a",$,[n("link"),l(a)])]),ss])}const os=e(B,[["render",ns],["__file","笔记k8s2.html.vue"]]);export{os as default};
